!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).mapray=t()}(this,(function(){"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e,t){return e(t={exports:{}},t.exports),t.exports}var r=function(e){return e&&e.Math==Math&&e},n=r("object"==typeof globalThis&&globalThis)||r("object"==typeof window&&window)||r("object"==typeof self&&self)||r("object"==typeof e&&e)||Function("return this")(),i=function(e){try{return!!e()}catch(e){return!0}},a=!i((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),o=function(e){return"object"==typeof e?null!==e:"function"==typeof e},s=n.document,u=o(s)&&o(s.createElement),l=function(e){return u?s.createElement(e):{}},_=!a&&!i((function(){return 7!=Object.defineProperty(l("div"),"a",{get:function(){return 7}}).a})),c=function(e){if(!o(e))throw TypeError(String(e)+" is not an object");return e},h=function(e,t){if(!o(e))return e;var r,n;if(t&&"function"==typeof(r=e.toString)&&!o(n=r.call(e)))return n;if("function"==typeof(r=e.valueOf)&&!o(n=r.call(e)))return n;if(!t&&"function"==typeof(r=e.toString)&&!o(n=r.call(e)))return n;throw TypeError("Can't convert object to primitive value")},f=Object.defineProperty,v={f:a?f:function(e,t,r){if(c(e),t=h(t,!0),c(r),_)try{return f(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported");return"value"in r&&(e[t]=r.value),e}},d=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},y=a?function(e,t,r){return v.f(e,t,d(1,r))}:function(e,t,r){return e[t]=r,e},p={}.hasOwnProperty,m=function(e,t){return p.call(e,t)},g=function(e,t){try{y(n,e,t)}catch(r){n[e]=t}return t},k=n["__core-js_shared__"]||g("__core-js_shared__",{}),E=Function.toString;"function"!=typeof k.inspectSource&&(k.inspectSource=function(e){return E.call(e)});var w,b,x,A=k.inspectSource,T=n.WeakMap,I="function"==typeof T&&/native code/.test(A(T)),M=t((function(e){(e.exports=function(e,t){return k[e]||(k[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.6.4",mode:"global",copyright:"© 2020 Denis Pushkarev (zloirock.ru)"})})),S=0,L=Math.random(),P=function(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++S+L).toString(36)},R=M("keys"),C=function(e){return R[e]||(R[e]=P(e))},O={},F=n.WeakMap;if(I){var N=new F,D=N.get,V=N.has,U=N.set;w=function(e,t){return U.call(N,e,t),t},b=function(e){return D.call(N,e)||{}},x=function(e){return V.call(N,e)}}else{var B=C("state");O[B]=!0,w=function(e,t){return y(e,B,t),t},b=function(e){return m(e,B)?e[B]:{}},x=function(e){return m(e,B)}}var G={set:w,get:b,has:x,enforce:function(e){return x(e)?b(e):w(e,{})},getterFor:function(e){return function(t){var r;if(!o(t)||(r=b(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return r}}},z=t((function(e){var t=G.get,r=G.enforce,i=String(String).split("String");(e.exports=function(e,t,a,o){var s=!!o&&!!o.unsafe,u=!!o&&!!o.enumerable,l=!!o&&!!o.noTargetGet;"function"==typeof a&&("string"!=typeof t||m(a,"name")||y(a,"name",t),r(a).source=i.join("string"==typeof t?t:"")),e!==n?(s?!l&&e[t]&&(u=!0):delete e[t],u?e[t]=a:y(e,t,a)):u?e[t]=a:g(t,a)})(Function.prototype,"toString",(function(){return"function"==typeof this&&t(this).source||A(this)}))})),j=Date.prototype,q=j.toString,Y=j.getTime;new Date(NaN)+""!="Invalid Date"&&z(j,"toString",(function(){var e=Y.call(this);return e==e?q.call(this):"Invalid Date"}));var X={}.propertyIsEnumerable,H=Object.getOwnPropertyDescriptor,W={f:H&&!X.call({1:2},1)?function(e){var t=H(this,e);return!!t&&t.enumerable}:X},Z={}.toString,Q=function(e){return Z.call(e).slice(8,-1)},K="".split,$=i((function(){return!Object("z").propertyIsEnumerable(0)}))?function(e){return"String"==Q(e)?K.call(e,""):Object(e)}:Object,J=function(e){if(null==e)throw TypeError("Can't call method on "+e);return e},ee=function(e){return $(J(e))},te=Object.getOwnPropertyDescriptor,re={f:a?te:function(e,t){if(e=ee(e),t=h(t,!0),_)try{return te(e,t)}catch(e){}if(m(e,t))return d(!W.f.call(e,t),e[t])}},ne=n,ie=function(e){return"function"==typeof e?e:void 0},ae=function(e,t){return arguments.length<2?ie(ne[e])||ie(n[e]):ne[e]&&ne[e][t]||n[e]&&n[e][t]},oe=Math.ceil,se=Math.floor,ue=function(e){return isNaN(e=+e)?0:(e>0?se:oe)(e)},le=Math.min,_e=function(e){return e>0?le(ue(e),9007199254740991):0},ce=Math.max,he=Math.min,fe=function(e,t){var r=ue(e);return r<0?ce(r+t,0):he(r,t)},ve=function(e){return function(t,r,n){var i,a=ee(t),o=_e(a.length),s=fe(n,o);if(e&&r!=r){for(;o>s;)if((i=a[s++])!=i)return!0}else for(;o>s;s++)if((e||s in a)&&a[s]===r)return e||s||0;return!e&&-1}},de={includes:ve(!0),indexOf:ve(!1)},ye=de.indexOf,pe=function(e,t){var r,n=ee(e),i=0,a=[];for(r in n)!m(O,r)&&m(n,r)&&a.push(r);for(;t.length>i;)m(n,r=t[i++])&&(~ye(a,r)||a.push(r));return a},me=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],ge=me.concat("length","prototype"),ke={f:Object.getOwnPropertyNames||function(e){return pe(e,ge)}},Ee={f:Object.getOwnPropertySymbols},we=ae("Reflect","ownKeys")||function(e){var t=ke.f(c(e)),r=Ee.f;return r?t.concat(r(e)):t},be=function(e,t){for(var r=we(t),n=v.f,i=re.f,a=0;a<r.length;a++){var o=r[a];m(e,o)||n(e,o,i(t,o))}},xe=/#|\.prototype\./,Ae=function(e,t){var r=Ie[Te(e)];return r==Se||r!=Me&&("function"==typeof t?i(t):!!t)},Te=Ae.normalize=function(e){return String(e).replace(xe,".").toLowerCase()},Ie=Ae.data={},Me=Ae.NATIVE="N",Se=Ae.POLYFILL="P",Le=Ae,Pe=re.f,Re=function(e,t){var r,i,a,o,s,u=e.target,l=e.global,_=e.stat;if(r=l?n:_?n[u]||g(u,{}):(n[u]||{}).prototype)for(i in t){if(o=t[i],a=e.noTargetGet?(s=Pe(r,i))&&s.value:r[i],!Le(l?i:u+(_?".":"#")+i,e.forced)&&void 0!==a){if(typeof o==typeof a)continue;be(o,a)}(e.sham||a&&a.sham)&&y(o,"sham",!0),z(r,i,o,e)}},Ce=Math.log,Oe=Math.LN2;Re({target:"Math",stat:!0},{log2:function(e){return Ce(e)/Oe}});var Fe=v.f,Ne=Function.prototype,De=Ne.toString,Ve=/^\s*function ([^ (]*)/;function Ue(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Be(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function Ge(e,t,r){return t&&Be(e.prototype,t),r&&Be(e,r),e}function ze(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&qe(e,t)}function je(e){return(je=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function qe(e,t){return(qe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ye(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function Xe(e,t,r){return(Xe=Ye()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&qe(i,r.prototype),i}).apply(null,arguments)}function He(e){var t="function"==typeof Map?new Map:void 0;return(He=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return Xe(e,arguments,je(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),qe(n,e)})(e)}function We(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ze(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?We(e):t}function Qe(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var r=[],n=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function Ke(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}!a||"name"in Ne||Fe(Ne,"name",{configurable:!0,get:function(){try{return De.call(this).match(Ve)[1]}catch(e){return""}}});var $e,Je=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e))).name="mapray.animation.AnimationError",r}return ze(t,e),t}(He(Error)),et=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,r={};try{(e=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(r,[]),t=r instanceof Array}catch(e){}return function(r,n){return c(r),function(e){if(!o(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype")}(n),t?e.call(r,n):r.__proto__=n,r}}():void 0),tt=function(e,t,r){var n,i;return et&&"function"==typeof(n=t.constructor)&&n!==r&&o(i=n.prototype)&&i!==r.prototype&&et(e,i),e},rt=Object.keys||function(e){return pe(e,me)},nt=a?Object.defineProperties:function(e,t){c(e);for(var r,n=rt(t),i=n.length,a=0;i>a;)v.f(e,r=n[a++],t[r]);return e},it=ae("document","documentElement"),at=C("IE_PROTO"),ot=function(){},st=function(e){return"<script>"+e+"<\/script>"},ut=function(){try{$e=document.domain&&new ActiveXObject("htmlfile")}catch(e){}var e,t;ut=$e?function(e){e.write(st("")),e.close();var t=e.parentWindow.Object;return e=null,t}($e):((t=l("iframe")).style.display="none",it.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write(st("document.F=Object")),e.close(),e.F);for(var r=me.length;r--;)delete ut.prototype[me[r]];return ut()};O[at]=!0;var lt=Object.create||function(e,t){var r;return null!==e?(ot.prototype=c(e),r=new ot,ot.prototype=null,r[at]=e):r=ut(),void 0===t?r:nt(r,t)},_t="\t\n\v\f\r                　\u2028\u2029\ufeff",ct="["+_t+"]",ht=RegExp("^"+ct+ct+"*"),ft=RegExp(ct+ct+"*$"),vt=function(e){return function(t){var r=String(J(t));return 1&e&&(r=r.replace(ht,"")),2&e&&(r=r.replace(ft,"")),r}},dt={start:vt(1),end:vt(2),trim:vt(3)},yt=ke.f,pt=re.f,mt=v.f,gt=dt.trim,kt=n.Number,Et=kt.prototype,wt="Number"==Q(lt(Et)),bt=function(e){var t,r,n,i,a,o,s,u,l=h(e,!1);if("string"==typeof l&&l.length>2)if(43===(t=(l=gt(l)).charCodeAt(0))||45===t){if(88===(r=l.charCodeAt(2))||120===r)return NaN}else if(48===t){switch(l.charCodeAt(1)){case 66:case 98:n=2,i=49;break;case 79:case 111:n=8,i=55;break;default:return+l}for(o=(a=l.slice(2)).length,s=0;s<o;s++)if((u=a.charCodeAt(s))<48||u>i)return NaN;return parseInt(a,n)}return+l};if(Le("Number",!kt(" 0o1")||!kt("0b1")||kt("+0x1"))){for(var xt,At=function(e){var t=arguments.length<1?0:e,r=this;return r instanceof At&&(wt?i((function(){Et.valueOf.call(r)})):"Number"!=Q(r))?tt(new kt(bt(t)),r,At):bt(t)},Tt=a?yt(kt):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),It=0;Tt.length>It;It++)m(kt,xt=Tt[It])&&!m(At,xt)&&mt(At,xt,pt(kt,xt));At.prototype=Et,Et.constructor=At,z(n,"Number",At)}var Mt=function(){function e(t){Ue(this,e),this._ntime=t}return Ge(e,[{key:"toNumber",value:function(){return this._ntime}},{key:"equals",value:function(e){return this._ntime==e._ntime}},{key:"lessThan",value:function(e){return this._ntime<e._ntime}},{key:"lessEqual",value:function(e){return this._ntime<=e._ntime}}],[{key:"fromNumber",value:function(t){return new e(t)}},{key:"MIN_TIME",get:function(){return Pt}},{key:"MAX_TIME",get:function(){return Rt}},{key:"MIN_NTIME",get:function(){return St}},{key:"MAX_NTIME",get:function(){return Lt}}]),e}(),St=-Number.MAX_VALUE,Lt=+Number.MAX_VALUE,Pt=Mt.fromNumber(St),Rt=Mt.fromNumber(Lt),Ct=function(){function e(t,r,n,i){Ue(this,e),this._lower=t,this._upper=r,this._l_open=void 0!==n&&n,this._u_open=void 0!==i&&i}return Ge(e,[{key:"isEmpty",value:function(){var e=this._lower,t=this._upper;return t.lessThan(e)||t.equals(e)&&(this._l_open||this._u_open)}},{key:"isSingle",value:function(){return this._lower.equals(this._upper)&&!(this._l_open||this._u_open)}},{key:"isProper",value:function(){return this._lower.lessThan(this._upper)}},{key:"precedes",value:function(e){if(this.isEmpty()||e.isEmpty())return!0;var t=this._upper,r=this._u_open,n=e._lower,i=e._l_open;return t.lessThan(n)||t.equals(n)&&(r||i)}},{key:"includes",value:function(e){if(e.isEmpty())return!0;var t=this._lower,r=e._lower,n=this._l_open,i=e._l_open,a=t.lessThan(r)||t.equals(r)&&(!n||i),o=this._upper,s=e._upper,u=this._u_open,l=e._u_open,_=s.lessThan(o)||s.equals(o)&&(l||!u);return a&&_}},{key:"includesTime",value:function(e){var t=this._lower,r=t.lessThan(e)||t.equals(e)&&!this._l_open,n=this._upper,i=e.lessThan(n)||e.equals(n)&&!this._u_open;return r&&i}},{key:"hasIntersection",value:function(e){return!this.getIntersection(e).isEmpty()}},{key:"getPrecedings",value:function(){return this.isEmpty()?Ot:new e(Mt.MIN_TIME,this._lower,!1,!this._l_open)}},{key:"getFollowings",value:function(){return this.isEmpty()?Ot:new e(this._upper,Mt.MAX_TIME,!this._u_open,!1)}},{key:"getIntersection",value:function(e){return this._getIntersectionByLower(e._lower,e._l_open)._getIntersectionByUpper(e._upper,e._u_open)}},{key:"getUnion",value:function(t){if(this.isEmpty())return t.isEmpty()?[]:[t];if(t.isEmpty())return[this];var r=this._lower,n=this._upper,i=this._l_open,a=this._u_open,o=t._lower,s=t._upper,u=t._l_open,l=t._u_open;if(n.lessThan(o)||n.equals(o)&&a&&u)return[this,t];if(s.lessThan(r)||r.equals(s)&&i&&l)return[t,this];var _=Qe(r.lessThan(o)||r.equals(o)&&u?[r,i]:[o,u],2),c=_[0],h=_[1],f=Qe(s.lessThan(n)||s.equals(n)&&l?[n,a]:[s,l],2);return[new e(c,f[0],h,f[1])]}},{key:"getDifference",value:function(e){var t=this._getIntersectionByUpper(e._lower,!e._l_open),r=this._getIntersectionByLower(e._upper,!e._u_open);return t.getUnion(r)}},{key:"getComplement",value:function(){return Ot.getDifference(this)}},{key:"_getIntersectionByLower",value:function(t,r){return t.lessThan(this._lower)||t.equals(this._lower)&&this._l_open?this:new e(t,this._upper,r,this._u_open)}},{key:"_getIntersectionByUpper",value:function(t,r){return this._upper.lessThan(t)||this._upper.equals(t)&&this._u_open?this:new e(this._lower,t,this._l_open,r)}},{key:"lower",get:function(){return this._lower}},{key:"upper",get:function(){return this._upper}},{key:"l_open",get:function(){return this._l_open}},{key:"u_open",get:function(){return this._u_open}}],[{key:"UNIVERSAL",get:function(){return Ot}}]),e}(),Ot=new Ct(Mt.MIN_TIME,Mt.MAX_TIME),Ft=!!Object.getOwnPropertySymbols&&!i((function(){return!String(Symbol())})),Nt=Ft&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,Dt=Array.isArray||function(e){return"Array"==Q(e)},Vt=function(e){return Object(J(e))},Ut=ke.f,Bt={}.toString,Gt="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],zt={f:function(e){return Gt&&"[object Window]"==Bt.call(e)?function(e){try{return Ut(e)}catch(e){return Gt.slice()}}(e):Ut(ee(e))}},jt=M("wks"),qt=n.Symbol,Yt=Nt?qt:qt&&qt.withoutSetter||P,Xt=function(e){return m(jt,e)||(Ft&&m(qt,e)?jt[e]=qt[e]:jt[e]=Yt("Symbol."+e)),jt[e]},Ht={f:Xt},Wt=v.f,Zt=function(e){var t=ne.Symbol||(ne.Symbol={});m(t,e)||Wt(t,e,{value:Ht.f(e)})},Qt=v.f,Kt=Xt("toStringTag"),$t=function(e,t,r){e&&!m(e=r?e:e.prototype,Kt)&&Qt(e,Kt,{configurable:!0,value:t})},Jt=function(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e},er=function(e,t,r){if(Jt(e),void 0===t)return e;switch(r){case 0:return function(){return e.call(t)};case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,i){return e.call(t,r,n,i)}}return function(){return e.apply(t,arguments)}},tr=Xt("species"),rr=function(e,t){var r;return Dt(e)&&("function"!=typeof(r=e.constructor)||r!==Array&&!Dt(r.prototype)?o(r)&&null===(r=r[tr])&&(r=void 0):r=void 0),new(void 0===r?Array:r)(0===t?0:t)},nr=[].push,ir=function(e){var t=1==e,r=2==e,n=3==e,i=4==e,a=6==e,o=5==e||a;return function(s,u,l,_){for(var c,h,f=Vt(s),v=$(f),d=er(u,l,3),y=_e(v.length),p=0,m=_||rr,g=t?m(s,y):r?m(s,0):void 0;y>p;p++)if((o||p in v)&&(h=d(c=v[p],p,f),e))if(t)g[p]=h;else if(h)switch(e){case 3:return!0;case 5:return c;case 6:return p;case 2:nr.call(g,c)}else if(i)return!1;return a?-1:n||i?i:g}},ar={forEach:ir(0),map:ir(1),filter:ir(2),some:ir(3),every:ir(4),find:ir(5),findIndex:ir(6)},or=ar.forEach,sr=C("hidden"),ur=Xt("toPrimitive"),lr=G.set,_r=G.getterFor("Symbol"),cr=Object.prototype,hr=n.Symbol,fr=ae("JSON","stringify"),vr=re.f,dr=v.f,yr=zt.f,pr=W.f,mr=M("symbols"),gr=M("op-symbols"),kr=M("string-to-symbol-registry"),Er=M("symbol-to-string-registry"),wr=M("wks"),br=n.QObject,xr=!br||!br.prototype||!br.prototype.findChild,Ar=a&&i((function(){return 7!=lt(dr({},"a",{get:function(){return dr(this,"a",{value:7}).a}})).a}))?function(e,t,r){var n=vr(cr,t);n&&delete cr[t],dr(e,t,r),n&&e!==cr&&dr(cr,t,n)}:dr,Tr=function(e,t){var r=mr[e]=lt(hr.prototype);return lr(r,{type:"Symbol",tag:e,description:t}),a||(r.description=t),r},Ir=Nt?function(e){return"symbol"==typeof e}:function(e){return Object(e)instanceof hr},Mr=function(e,t,r){e===cr&&Mr(gr,t,r),c(e);var n=h(t,!0);return c(r),m(mr,n)?(r.enumerable?(m(e,sr)&&e[sr][n]&&(e[sr][n]=!1),r=lt(r,{enumerable:d(0,!1)})):(m(e,sr)||dr(e,sr,d(1,{})),e[sr][n]=!0),Ar(e,n,r)):dr(e,n,r)},Sr=function(e,t){c(e);var r=ee(t),n=rt(r).concat(Cr(r));return or(n,(function(t){a&&!Lr.call(r,t)||Mr(e,t,r[t])})),e},Lr=function(e){var t=h(e,!0),r=pr.call(this,t);return!(this===cr&&m(mr,t)&&!m(gr,t))&&(!(r||!m(this,t)||!m(mr,t)||m(this,sr)&&this[sr][t])||r)},Pr=function(e,t){var r=ee(e),n=h(t,!0);if(r!==cr||!m(mr,n)||m(gr,n)){var i=vr(r,n);return!i||!m(mr,n)||m(r,sr)&&r[sr][n]||(i.enumerable=!0),i}},Rr=function(e){var t=yr(ee(e)),r=[];return or(t,(function(e){m(mr,e)||m(O,e)||r.push(e)})),r},Cr=function(e){var t=e===cr,r=yr(t?gr:ee(e)),n=[];return or(r,(function(e){!m(mr,e)||t&&!m(cr,e)||n.push(mr[e])})),n};if(Ft||(z((hr=function(){if(this instanceof hr)throw TypeError("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?String(arguments[0]):void 0,t=P(e),r=function(e){this===cr&&r.call(gr,e),m(this,sr)&&m(this[sr],t)&&(this[sr][t]=!1),Ar(this,t,d(1,e))};return a&&xr&&Ar(cr,t,{configurable:!0,set:r}),Tr(t,e)}).prototype,"toString",(function(){return _r(this).tag})),z(hr,"withoutSetter",(function(e){return Tr(P(e),e)})),W.f=Lr,v.f=Mr,re.f=Pr,ke.f=zt.f=Rr,Ee.f=Cr,Ht.f=function(e){return Tr(Xt(e),e)},a&&(dr(hr.prototype,"description",{configurable:!0,get:function(){return _r(this).description}}),z(cr,"propertyIsEnumerable",Lr,{unsafe:!0}))),Re({global:!0,wrap:!0,forced:!Ft,sham:!Ft},{Symbol:hr}),or(rt(wr),(function(e){Zt(e)})),Re({target:"Symbol",stat:!0,forced:!Ft},{for:function(e){var t=String(e);if(m(kr,t))return kr[t];var r=hr(t);return kr[t]=r,Er[r]=t,r},keyFor:function(e){if(!Ir(e))throw TypeError(e+" is not a symbol");if(m(Er,e))return Er[e]},useSetter:function(){xr=!0},useSimple:function(){xr=!1}}),Re({target:"Object",stat:!0,forced:!Ft,sham:!a},{create:function(e,t){return void 0===t?lt(e):Sr(lt(e),t)},defineProperty:Mr,defineProperties:Sr,getOwnPropertyDescriptor:Pr}),Re({target:"Object",stat:!0,forced:!Ft},{getOwnPropertyNames:Rr,getOwnPropertySymbols:Cr}),Re({target:"Object",stat:!0,forced:i((function(){Ee.f(1)}))},{getOwnPropertySymbols:function(e){return Ee.f(Vt(e))}}),fr){var Or=!Ft||i((function(){var e=hr();return"[null]"!=fr([e])||"{}"!=fr({a:e})||"{}"!=fr(Object(e))}));Re({target:"JSON",stat:!0,forced:Or},{stringify:function(e,t,r){for(var n,i=[e],a=1;arguments.length>a;)i.push(arguments[a++]);if(n=t,(o(t)||void 0!==e)&&!Ir(e))return Dt(t)||(t=function(e,t){if("function"==typeof n&&(t=n.call(this,e,t)),!Ir(t))return t}),i[1]=t,fr.apply(null,i)}})}hr.prototype[ur]||y(hr.prototype,ur,hr.prototype.valueOf),$t(hr,"Symbol"),O[sr]=!0;var Fr=v.f,Nr=n.Symbol;if(a&&"function"==typeof Nr&&(!("description"in Nr.prototype)||void 0!==Nr().description)){var Dr={},Vr=function(){var e=arguments.length<1||void 0===arguments[0]?void 0:String(arguments[0]),t=this instanceof Vr?new Nr(e):void 0===e?Nr():Nr(e);return""===e&&(Dr[t]=!0),t};be(Vr,Nr);var Ur=Vr.prototype=Nr.prototype;Ur.constructor=Vr;var Br=Ur.toString,Gr="Symbol(test)"==String(Nr("test")),zr=/^Symbol\((.*)\)[^)]+$/;Fr(Ur,"description",{configurable:!0,get:function(){var e=o(this)?this.valueOf():this,t=Br.call(e);if(m(Dr,e))return"";var r=Gr?t.slice(7,-1):t.replace(zr,"$1");return""===r?void 0:r}}),Re({global:!0,forced:!0},{Symbol:Vr})}Zt("iterator");var jr=Xt("unscopables"),qr=Array.prototype;null==qr[jr]&&v.f(qr,jr,{configurable:!0,value:lt(null)});var Yr=function(e){qr[jr][e]=!0},Xr=Object.defineProperty,Hr={},Wr=function(e){throw e},Zr=function(e,t){if(m(Hr,e))return Hr[e];t||(t={});var r=[][e],n=!!m(t,"ACCESSORS")&&t.ACCESSORS,o=m(t,0)?t[0]:Wr,s=m(t,1)?t[1]:void 0;return Hr[e]=!!r&&!i((function(){if(n&&!a)return!0;var e={length:-1};n?Xr(e,1,{enumerable:!0,get:Wr}):e[1]=1,r.call(e,o,s)}))},Qr=de.includes,Kr=Zr("indexOf",{ACCESSORS:!0,1:0});Re({target:"Array",proto:!0,forced:!Kr},{includes:function(e){return Qr(this,e,arguments.length>1?arguments[1]:void 0)}}),Yr("includes");var $r,Jr,en,tn={},rn=!i((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),nn=C("IE_PROTO"),an=Object.prototype,on=rn?Object.getPrototypeOf:function(e){return e=Vt(e),m(e,nn)?e[nn]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?an:null},sn=Xt("iterator"),un=!1;[].keys&&("next"in(en=[].keys())?(Jr=on(on(en)))!==Object.prototype&&($r=Jr):un=!0),null==$r&&($r={}),m($r,sn)||y($r,sn,(function(){return this}));var ln={IteratorPrototype:$r,BUGGY_SAFARI_ITERATORS:un},_n=ln.IteratorPrototype,cn=function(){return this},hn=function(e,t,r){var n=t+" Iterator";return e.prototype=lt(_n,{next:d(1,r)}),$t(e,n,!1),tn[n]=cn,e},fn=ln.IteratorPrototype,vn=ln.BUGGY_SAFARI_ITERATORS,dn=Xt("iterator"),yn=function(){return this},pn=function(e,t,r,n,i,a,o){hn(r,t,n);var s,u,l,_=function(e){if(e===i&&d)return d;if(!vn&&e in f)return f[e];switch(e){case"keys":case"values":case"entries":return function(){return new r(this,e)}}return function(){return new r(this)}},c=t+" Iterator",h=!1,f=e.prototype,v=f[dn]||f["@@iterator"]||i&&f[i],d=!vn&&v||_(i),p="Array"==t&&f.entries||v;if(p&&(s=on(p.call(new e)),fn!==Object.prototype&&s.next&&(on(s)!==fn&&(et?et(s,fn):"function"!=typeof s[dn]&&y(s,dn,yn)),$t(s,c,!0))),"values"==i&&v&&"values"!==v.name&&(h=!0,d=function(){return v.call(this)}),f[dn]!==d&&y(f,dn,d),tn[t]=d,i)if(u={values:_("values"),keys:a?d:_("keys"),entries:_("entries")},o)for(l in u)!vn&&!h&&l in f||z(f,l,u[l]);else Re({target:t,proto:!0,forced:vn||h},u);return u},mn=G.set,gn=G.getterFor("Array Iterator"),kn=pn(Array,"Array",(function(e,t){mn(this,{type:"Array Iterator",target:ee(e),index:0,kind:t})}),(function(){var e=gn(this),t=e.target,r=e.kind,n=e.index++;return!t||n>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==r?{value:n,done:!1}:"values"==r?{value:t[n],done:!1}:{value:[n,t[n]],done:!1}}),"values");tn.Arguments=tn.Array,Yr("keys"),Yr("values"),Yr("entries");var En={};En[Xt("toStringTag")]="z";var wn="[object z]"===String(En),bn=Xt("toStringTag"),xn="Arguments"==Q(function(){return arguments}()),An=wn?Q:function(e){var t,r,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),bn))?r:xn?Q(t):"Object"==(n=Q(t))&&"function"==typeof t.callee?"Arguments":n},Tn=wn?{}.toString:function(){return"[object "+An(this)+"]"};wn||z(Object.prototype,"toString",Tn,{unsafe:!0});var In=Xt("match"),Mn=function(e){var t;return o(e)&&(void 0!==(t=e[In])?!!t:"RegExp"==Q(e))},Sn=function(e){if(Mn(e))throw TypeError("The method doesn't accept regular expressions");return e},Ln=Xt("match"),Pn=function(e){var t=/./;try{"/./"[e](t)}catch(r){try{return t[Ln]=!1,"/./"[e](t)}catch(e){}}return!1};Re({target:"String",proto:!0,forced:!Pn("includes")},{includes:function(e){return!!~String(J(this)).indexOf(Sn(e),arguments.length>1?arguments[1]:void 0)}});var Rn=function(e){return function(t,r){var n,i,a=String(J(t)),o=ue(r),s=a.length;return o<0||o>=s?e?"":void 0:(n=a.charCodeAt(o))<55296||n>56319||o+1===s||(i=a.charCodeAt(o+1))<56320||i>57343?e?a.charAt(o):n:e?a.slice(o,o+2):i-56320+(n-55296<<10)+65536}},Cn={codeAt:Rn(!1),charAt:Rn(!0)},On=Cn.charAt,Fn=G.set,Nn=G.getterFor("String Iterator");pn(String,"String",(function(e){Fn(this,{type:"String Iterator",string:String(e),index:0})}),(function(){var e,t=Nn(this),r=t.string,n=t.index;return n>=r.length?{value:void 0,done:!0}:(e=On(r,n),t.index+=e.length,{value:e,done:!1})}));var Dn,Vn={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Un=Xt("iterator"),Bn=Xt("toStringTag"),Gn=kn.values;for(var zn in Vn){var jn=n[zn],qn=jn&&jn.prototype;if(qn){if(qn[Un]!==Gn)try{y(qn,Un,Gn)}catch(e){qn[Un]=Gn}if(qn[Bn]||y(qn,Bn,zn),Vn[zn])for(var Yn in kn)if(qn[Yn]!==kn[Yn])try{y(qn,Yn,kn[Yn])}catch(e){qn[Yn]=kn[Yn]}}}var Xn=function(){function e(t){Ue(this,e),this._compare=t,this._root=Dn,this._size=0}return Ge(e,[{key:"clone",value:function(){var t=new e(this._compare);return this._root!==Dn&&(t._root=this._root._clone(Dn)),t._size=this._size,t}},{key:"isEmpty",value:function(){return this._root===Dn}},{key:"findFirst",value:function(){return this._root!==Dn?this._root._findMinimum():null}},{key:"findLast",value:function(){return this._root!==Dn?this._root._findMaximum():null}},{key:"findLower",value:function(e){return this._root._findLowerBound(e,this._compare)}},{key:"findUpper",value:function(e){return this._root._findUpperBound(e,this._compare)}},{key:"findEqual",value:function(e){return this._root._findEqual(e,this._compare)}},{key:"clear",value:function(){this._root=Dn,this._size=0}},{key:"insert",value:function(e,t){for(var r=this._root,n=Dn,i=this._compare;r!==Dn;)if(n=r,i(e,r.key))r=r._child_L;else{if(!i(r.key,e))return r._value=t,r;r=r._child_R}var a=new Hn(n,e,t);return a._is_red=!0,n===Dn?this._root=a:i(e,n.key)?n._child_L=a:n._child_R=a,++this._size,this._insert_fixup(a),a}},{key:"_insert_fixup",value:function(e){for(var t=e;t._parent._is_red;)if(t._parent===t._parent._parent._child_L){var r=t._parent._parent._child_R;r._is_red?(t._parent._is_red=!1,r._is_red=!1,t._parent._parent._is_red=!0,t=t._parent._parent):(t===t._parent._child_R&&(t=t._parent,this._rotate_L(t)),t._parent._is_red=!1,t._parent._parent._is_red=!0,this._rotate_R(t._parent._parent))}else{var n=t._parent._parent._child_L;n._is_red?(t._parent._is_red=!1,n._is_red=!1,t._parent._parent._is_red=!0,t=t._parent._parent):(t===t._parent._child_L&&(t=t._parent,this._rotate_R(t)),t._parent._is_red=!1,t._parent._parent._is_red=!0,this._rotate_L(t._parent._parent))}this._root._is_red=!1}},{key:"remove",value:function(e,t){if(void 0===t)return this._remove(e);for(var r=e;r!=t;)r=this._remove(r);return t}},{key:"_remove",value:function(e){var t,r,n=e.findSuccessor();return e._child_L===Dn?(t=e._is_red,r=e._child_R,this._replace(e._child_R,e)):e._child_R===Dn?(t=e._is_red,r=e._child_L,this._replace(e._child_L,e)):(t=n._is_red,r=n._child_R,n._parent===e?r._parent=n:(this._replace(n._child_R,n),n._child_R=e._child_R,n._child_R._parent=n),this._replace(n,e),n._child_L=e._child_L,n._child_L._parent=n,n._is_red=e._is_red),--this._size,t||this._remove_fixup(r),n}},{key:"_remove_fixup",value:function(e){for(var t=e;t!==this._root&&!t._is_red;)if(t===t._parent._child_L){var r=t._parent._child_R;r._is_red&&(r._is_red=!1,t._parent._is_red=!0,this._rotate_L(t._parent),r=t._parent._child_R),r._child_L._is_red||r._child_R._is_red?(r._child_R._is_red||(r._child_L._is_red=!1,r._is_red=!0,this._rotate_R(r),r=t._parent._child_R),r._is_red=t._parent._is_red,t._parent._is_red=!1,r._child_R._is_red=!1,this._rotate_L(t._parent),t=this._root):(r._is_red=!0,t=t._parent)}else{var n=t._parent._child_L;n._is_red&&(n._is_red=!1,t._parent._is_red=!0,this._rotate_R(t._parent),n=t._parent._child_L),n._child_R._is_red||n._child_L._is_red?(n._child_L._is_red||(n._child_R._is_red=!1,n._is_red=!0,this._rotate_L(n),n=t._parent._child_L),n._is_red=t._parent._is_red,t._parent._is_red=!1,n._child_L._is_red=!1,this._rotate_R(t._parent),t=this._root):(n._is_red=!0,t=t._parent)}t._is_red=!1}},{key:"_replace",value:function(e,t){var r=t._parent;r!==Dn?r._child_L===t?r._child_L=e:r._child_R=e:this._root=e,e._parent=r}},{key:"_rotate_L",value:function(e){var t=e._child_R;e._child_R=t._child_L,t._child_L!==Dn&&(t._child_L._parent=e),t._parent=e._parent,e._parent===Dn?this._root=t:e===e._parent._child_L?e._parent._child_L=t:e._parent._child_R=t,t._child_L=e,e._parent=t}},{key:"_rotate_R",value:function(e){var t=e._child_L;e._child_L=t._child_R,t._child_R!==Dn&&(t._child_R._parent=e),t._parent=e._parent,e._parent===Dn?this._root=t:e===e._parent._child_R?e._parent._child_R=t:e._parent._child_L=t,t._child_R=e,e._parent=t}},{key:"size",get:function(){return this._size}}]),e}(),Hn=function(){function e(t,r,n){Ue(this,e),this._parent=t,this._child_L=Dn,this._child_R=Dn,this._is_red=!1,this._key=r,this._value=n}return Ge(e,[{key:"_clone",value:function(t){var r=new e(t,this._key,this._value);return this._child_L!==Dn&&(r._child_L=this._child_L._clone(r)),this._child_R!==Dn&&(r._child_R=this._child_R._clone(r)),r._is_red=this._is_red,r}},{key:"_findMinimum",value:function(){for(var e=this;e._child_L!==Dn;)e=e._child_L;return e}},{key:"_findMaximum",value:function(){for(var e=this;e._child_R!==Dn;)e=e._child_R;return e}},{key:"findPredecessor",value:function(){if(this._child_L!==Dn)return this._child_L._findMaximum();for(var e=this,t=e._parent;t!==Dn&&e===t._child_L;)t=(e=t)._parent;return t!==Dn?t:null}},{key:"findSuccessor",value:function(){if(this._child_R!==Dn)return this._child_R._findMinimum();for(var e=this,t=e._parent;t!==Dn&&e===t._child_R;)t=(e=t)._parent;return t!==Dn?t:null}},{key:"_findLowerBound",value:function(e,t){for(var r=this;r!==Dn;){if(t(e,r._key)){if(r._child_L!==Dn){var n=r._child_L._findLowerBound(e,t);if(null!==n)return n}return r}if(!t(r._key,e))return r;r=r._child_R}return null}},{key:"_findUpperBound",value:function(e,t){for(var r=this;r!==Dn;){if(t(e,r._key)){if(r._child_L!==Dn){var n=r._child_L._findUpperBound(e,t);if(null!==n)return n}return r}r=r._child_R}return null}},{key:"_findEqual",value:function(e,t){for(var r=this;r!==Dn;)if(t(e,r._key))r=r._child_L;else{if(!t(r._key,e))return r;r=r._child_R}return null}},{key:"_findLowerBoundR",value:function(e,t){var r=this;if(r._parent!==Dn)return r._findLowerBound(e,t);var n=r._findMinimum(),i=r._findMaximum();do{if(!t(e,n._key)&&!t(i._key,e))break;r._parent._child_L===r?i=r._findMaximum():n=r._findMinimum(),r=r._parent}while(r._parent!==Dn);return r._findLowerBound(e,t)}},{key:"key",get:function(){return this._key}},{key:"value",get:function(){return this._value}}]),e}();Dn=new Hn;var Wn=function(){function e(){Ue(this,e),this._imap=Qn()}return Ge(e,[{key:"clone",value:function(){var t=new e;return t._imap=this._imap.clone(),t}},{key:"write",value:function(e){return this.remove(e),this._insert(e),this}},{key:"remove",value:function(e){if(e.isEmpty())return this;var t=e.l_open?this._imap.findUpper(e.lower):this._imap.findLower(e.lower),r=null!==t?t.findPredecessor():this._imap.findLast();if(this._chopItem(r,e),null!==t&&e.includes(t.value)){var n=e.u_open?this._imap.findLower(e.upper):this._imap.findUpper(e.upper),i=null!==n?n.findPredecessor():this._imap.findLast(),a=e.includes(i.value)?n:i;this._imap.remove(t,a),this._chopItem(a,e)}else this._chopItem(t,e);return this}},{key:"getNarrowed",value:function(t){var r=new e;if(t.isEmpty())return r;for(var n=this._imap.findUpper(t.lower),i=null!==n?n.findPredecessor():this._imap.findLast(),a=null!==i&&i.value.hasIntersection(t)?i:n,o=t.u_open?this._imap.findLower(t.upper):this._imap.findUpper(t.upper),s=a;s!==o;s=s.findSuccessor())r._imap.insert(s.key,s.value);return r}},{key:"_$getArray",value:function(){for(var e=[],t=this._imap.findFirst();null!==t;t=t.findSuccessor())e.push(t.value);return e}},{key:"_$modify",value:function(e){var t=e._imap.findFirst();if(null!==t){var r=e._imap.findLast(),n=t.value,i=r.value;this.remove(new Ct(n.lower,i.upper,n.l_open,i.u_open));for(var a=t;null!==a;a=a.findSuccessor())this._insert(a.value)}}},{key:"_$expandIntervalByAlignment",value:function(e){var t,r,n=this._imap,i=n.findLower(e.lower);if(null===i||!i.value.lower.equals(e.lower)||!e.l_open&&i.value.l_open){var a=null!==i?i.findPredecessor():n.findLast();t=null!==a?a.value.hasIntersection(e)?e:a.value.getFollowings():Ct.UNIVERSAL}else t=e;var o=n.findLower(e.upper);if(null===o||!e.upper.equals(o.value.lower)||e.u_open&&o.value.l_open){var s=null!==o?o.findPredecessor():n.findLast();r=null!==s&&s.value.hasIntersection(e)&&(e.upper.lessThan(s.value.upper)||e.upper.equals(s.value.upper)&&(e.u_open||!s.value.u_open))?e:null!==o?o.value.getPrecedings():Ct.UNIVERSAL}else r=e;return new Ct(t.lower,r.upper,t.l_open,r.u_open)}},{key:"_chopItem",value:function(e,t){if(null!==e){var r=e.value.getDifference(t);this._imap.remove(e);var n=!0,i=!1,a=void 0;try{for(var o,s=r[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;u.isProper()&&this._imap.insert(u.lower,u)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}}}},{key:"_insert",value:function(e){e.isProper()&&this._imap.insert(e.lower,e)}},{key:"_merge_from_invariance",value:function(e){for(var t=Qn(),r=this._imap.findFirst();null!==r;r=r.findSuccessor())Zn(r.value,e,t);this._imap=t}}],[{key:"merge",value:function(t){var r=new e;r.write(Ct.UNIVERSAL);var n=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;r._merge_from_invariance(u)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}return r}}]),e}();function Zn(e,t,r){var n=t._imap,i=n.findLower(e.lower),a=null!==i?i.findPredecessor():null;null===a&&(a=n.findFirst());for(var o=n.findUpper(e.upper),s=a;s!==o;s=s.findSuccessor()){var u=s.value,l=e.getIntersection(u);l.isProper()&&r.insert(l.lower,l)}}function Qn(){return new Xn((function(e,t){return e.lessThan(t)}))}var Kn=!i((function(){return Object.isExtensible(Object.preventExtensions({}))})),$n=t((function(e){var t=v.f,r=P("meta"),n=0,i=Object.isExtensible||function(){return!0},a=function(e){t(e,r,{value:{objectID:"O"+ ++n,weakData:{}}})},s=e.exports={REQUIRED:!1,fastKey:function(e,t){if(!o(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!m(e,r)){if(!i(e))return"F";if(!t)return"E";a(e)}return e[r].objectID},getWeakData:function(e,t){if(!m(e,r)){if(!i(e))return!0;if(!t)return!1;a(e)}return e[r].weakData},onFreeze:function(e){return Kn&&s.REQUIRED&&i(e)&&!m(e,r)&&a(e),e}};O[r]=!0})),Jn=($n.REQUIRED,$n.fastKey,$n.getWeakData,$n.onFreeze,Xt("iterator")),ei=Array.prototype,ti=function(e){return void 0!==e&&(tn.Array===e||ei[Jn]===e)},ri=Xt("iterator"),ni=function(e){if(null!=e)return e[ri]||e["@@iterator"]||tn[An(e)]},ii=function(e,t,r,n){try{return n?t(c(r)[0],r[1]):t(r)}catch(t){var i=e.return;throw void 0!==i&&c(i.call(e)),t}},ai=t((function(e){var t=function(e,t){this.stopped=e,this.result=t};(e.exports=function(e,r,n,i,a){var o,s,u,l,_,h,f,v=er(r,n,i?2:1);if(a)o=e;else{if("function"!=typeof(s=ni(e)))throw TypeError("Target is not iterable");if(ti(s)){for(u=0,l=_e(e.length);l>u;u++)if((_=i?v(c(f=e[u])[0],f[1]):v(e[u]))&&_ instanceof t)return _;return new t(!1)}o=s.call(e)}for(h=o.next;!(f=h.call(o)).done;)if("object"==typeof(_=ii(o,v,f.value,i))&&_&&_ instanceof t)return _;return new t(!1)}).stop=function(e){return new t(!0,e)}})),oi=function(e,t,r){if(!(e instanceof t))throw TypeError("Incorrect "+(r?r+" ":"")+"invocation");return e},si=Xt("iterator"),ui=!1;try{var li=0,_i={next:function(){return{done:!!li++}},return:function(){ui=!0}};_i[si]=function(){return this},Array.from(_i,(function(){throw 2}))}catch(e){}var ci=function(e,t){if(!t&&!ui)return!1;var r=!1;try{var n={};n[si]=function(){return{next:function(){return{done:r=!0}}}},e(n)}catch(e){}return r},hi=function(e,t,r){var a=-1!==e.indexOf("Map"),s=-1!==e.indexOf("Weak"),u=a?"set":"add",l=n[e],_=l&&l.prototype,c=l,h={},f=function(e){var t=_[e];z(_,e,"add"==e?function(e){return t.call(this,0===e?0:e),this}:"delete"==e?function(e){return!(s&&!o(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return s&&!o(e)?void 0:t.call(this,0===e?0:e)}:"has"==e?function(e){return!(s&&!o(e))&&t.call(this,0===e?0:e)}:function(e,r){return t.call(this,0===e?0:e,r),this})};if(Le(e,"function"!=typeof l||!(s||_.forEach&&!i((function(){(new l).entries().next()})))))c=r.getConstructor(t,e,a,u),$n.REQUIRED=!0;else if(Le(e,!0)){var v=new c,d=v[u](s?{}:-0,1)!=v,y=i((function(){v.has(1)})),p=ci((function(e){new l(e)})),m=!s&&i((function(){for(var e=new l,t=5;t--;)e[u](t,t);return!e.has(-0)}));p||((c=t((function(t,r){oi(t,c,e);var n=tt(new l,t,c);return null!=r&&ai(r,n[u],n,a),n}))).prototype=_,_.constructor=c),(y||m)&&(f("delete"),f("has"),a&&f("get")),(m||d)&&f(u),s&&_.clear&&delete _.clear}return h[e]=c,Re({global:!0,forced:c!=l},h),$t(c,e),s||r.setStrong(c,e,a),c},fi=function(e,t,r){for(var n in t)z(e,n,t[n],r);return e},vi=Xt("species"),di=function(e){var t=ae(e),r=v.f;a&&t&&!t[vi]&&r(t,vi,{configurable:!0,get:function(){return this}})},yi=v.f,pi=$n.fastKey,mi=G.set,gi=G.getterFor,ki={getConstructor:function(e,t,r,n){var i=e((function(e,o){oi(e,i,t),mi(e,{type:t,index:lt(null),first:void 0,last:void 0,size:0}),a||(e.size=0),null!=o&&ai(o,e[n],e,r)})),o=gi(t),s=function(e,t,r){var n,i,s=o(e),l=u(e,t);return l?l.value=r:(s.last=l={index:i=pi(t,!0),key:t,value:r,previous:n=s.last,next:void 0,removed:!1},s.first||(s.first=l),n&&(n.next=l),a?s.size++:e.size++,"F"!==i&&(s.index[i]=l)),e},u=function(e,t){var r,n=o(e),i=pi(t);if("F"!==i)return n.index[i];for(r=n.first;r;r=r.next)if(r.key==t)return r};return fi(i.prototype,{clear:function(){for(var e=o(this),t=e.index,r=e.first;r;)r.removed=!0,r.previous&&(r.previous=r.previous.next=void 0),delete t[r.index],r=r.next;e.first=e.last=void 0,a?e.size=0:this.size=0},delete:function(e){var t=o(this),r=u(this,e);if(r){var n=r.next,i=r.previous;delete t.index[r.index],r.removed=!0,i&&(i.next=n),n&&(n.previous=i),t.first==r&&(t.first=n),t.last==r&&(t.last=i),a?t.size--:this.size--}return!!r},forEach:function(e){for(var t,r=o(this),n=er(e,arguments.length>1?arguments[1]:void 0,3);t=t?t.next:r.first;)for(n(t.value,t.key,this);t&&t.removed;)t=t.previous},has:function(e){return!!u(this,e)}}),fi(i.prototype,r?{get:function(e){var t=u(this,e);return t&&t.value},set:function(e,t){return s(this,0===e?0:e,t)}}:{add:function(e){return s(this,e=0===e?0:e,e)}}),a&&yi(i.prototype,"size",{get:function(){return o(this).size}}),i},setStrong:function(e,t,r){var n=t+" Iterator",i=gi(t),a=gi(n);pn(e,t,(function(e,t){mi(this,{type:n,target:e,state:i(e),kind:t,last:void 0})}),(function(){for(var e=a(this),t=e.kind,r=e.last;r&&r.removed;)r=r.previous;return e.target&&(e.last=r=r?r.next:e.state.first)?"keys"==t?{value:r.key,done:!1}:"values"==t?{value:r.value,done:!1}:{value:[r.key,r.value],done:!1}:(e.target=void 0,{value:void 0,done:!0})}),r?"entries":"values",!r,!0),di(t)}},Ei=(hi("Map",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),ki),function(){function e(t){Ue(this,e),this._name=t}return Ge(e,[{key:"isConvertible",value:function(e){this._override_error("isConvertible")}},{key:"convertValue",value:function(e,t){this._override_error("convertValue")}},{key:"getDefaultValue",value:function(){this._override_error("getDefaultValue")}},{key:"getCloneValue",value:function(e){this._override_error("getCloneValue")}},{key:"_override_error",value:function(e){throw new Error("Type#"+e+"() method has not been overridden in "+this.constructor.name)}},{key:"name",get:function(){return this._name}}],[{key:"register",value:function(e,t){if(xi.has(e))throw new wi("specified name ("+e+") has already been registered");return xi.set(e,t),t}},{key:"find",value:function(e){var t=xi.get(e);if(void 0===t)throw new bi("type with the specified name ("+e+") is not registered");return t}}]),e}()),wi=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e))).name="mapray.animation.Type.AlreadyRegisteredError",r}return ze(t,e),t}(Je);Ei.AlreadyRegisteredError=wi;var bi=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e))).name="mapray.animation.Type.NotRegisteredError",r}return ze(t,e),t}(Je);Ei.NotRegisteredError=bi;var xi=new Map,Ai=ar.find,Ti=!0,Ii=Zr("find");"find"in[]&&Array(1).find((function(){Ti=!1})),Re({target:"Array",proto:!0,forced:Ti||!Ii},{find:function(e){return Ai(this,e,arguments.length>1?arguments[1]:void 0)}}),Yr("find");hi("Set",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),ki);var Mi="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,Si=function(e){if(void 0===e)return 0;var t=ue(e),r=_e(t);if(t!==r)throw RangeError("Wrong length or index");return r},Li=Math.abs,Pi=Math.pow,Ri=Math.floor,Ci=Math.log,Oi=Math.LN2,Fi=function(e,t,r){var n,i,a,o=new Array(r),s=8*r-t-1,u=(1<<s)-1,l=u>>1,_=23===t?Pi(2,-24)-Pi(2,-77):0,c=e<0||0===e&&1/e<0?1:0,h=0;for((e=Li(e))!=e||e===1/0?(i=e!=e?1:0,n=u):(n=Ri(Ci(e)/Oi),e*(a=Pi(2,-n))<1&&(n--,a*=2),(e+=n+l>=1?_/a:_*Pi(2,1-l))*a>=2&&(n++,a/=2),n+l>=u?(i=0,n=u):n+l>=1?(i=(e*a-1)*Pi(2,t),n+=l):(i=e*Pi(2,l-1)*Pi(2,t),n=0));t>=8;o[h++]=255&i,i/=256,t-=8);for(n=n<<t|i,s+=t;s>0;o[h++]=255&n,n/=256,s-=8);return o[--h]|=128*c,o},Ni=function(e,t){var r,n=e.length,i=8*n-t-1,a=(1<<i)-1,o=a>>1,s=i-7,u=n-1,l=e[u--],_=127&l;for(l>>=7;s>0;_=256*_+e[u],u--,s-=8);for(r=_&(1<<-s)-1,_>>=-s,s+=t;s>0;r=256*r+e[u],u--,s-=8);if(0===_)_=1-o;else{if(_===a)return r?NaN:l?-1/0:1/0;r+=Pi(2,t),_-=o}return(l?-1:1)*r*Pi(2,_-t)},Di=function(e){for(var t=Vt(this),r=_e(t.length),n=arguments.length,i=fe(n>1?arguments[1]:void 0,r),a=n>2?arguments[2]:void 0,o=void 0===a?r:fe(a,r);o>i;)t[i++]=e;return t},Vi=ke.f,Ui=v.f,Bi=G.get,Gi=G.set,zi=n.ArrayBuffer,ji=zi,qi=n.DataView,Yi=qi&&qi.prototype,Xi=Object.prototype,Hi=n.RangeError,Wi=Fi,Zi=Ni,Qi=function(e){return[255&e]},Ki=function(e){return[255&e,e>>8&255]},$i=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},Ji=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},ea=function(e){return Wi(e,23,4)},ta=function(e){return Wi(e,52,8)},ra=function(e,t){Ui(e.prototype,t,{get:function(){return Bi(this)[t]}})},na=function(e,t,r,n){var i=Si(r),a=Bi(e);if(i+t>a.byteLength)throw Hi("Wrong index");var o=Bi(a.buffer).bytes,s=i+a.byteOffset,u=o.slice(s,s+t);return n?u:u.reverse()},ia=function(e,t,r,n,i,a){var o=Si(r),s=Bi(e);if(o+t>s.byteLength)throw Hi("Wrong index");for(var u=Bi(s.buffer).bytes,l=o+s.byteOffset,_=n(+i),c=0;c<t;c++)u[l+c]=_[a?c:t-c-1]};if(Mi){if(!i((function(){zi(1)}))||!i((function(){new zi(-1)}))||i((function(){return new zi,new zi(1.5),new zi(NaN),"ArrayBuffer"!=zi.name}))){for(var aa,oa=(ji=function(e){return oi(this,ji),new zi(Si(e))}).prototype=zi.prototype,sa=Vi(zi),ua=0;sa.length>ua;)(aa=sa[ua++])in ji||y(ji,aa,zi[aa]);oa.constructor=ji}et&&on(Yi)!==Xi&&et(Yi,Xi);var la=new qi(new ji(2)),_a=Yi.setInt8;la.setInt8(0,2147483648),la.setInt8(1,2147483649),!la.getInt8(0)&&la.getInt8(1)||fi(Yi,{setInt8:function(e,t){_a.call(this,e,t<<24>>24)},setUint8:function(e,t){_a.call(this,e,t<<24>>24)}},{unsafe:!0})}else ji=function(e){oi(this,ji,"ArrayBuffer");var t=Si(e);Gi(this,{bytes:Di.call(new Array(t),0),byteLength:t}),a||(this.byteLength=t)},qi=function(e,t,r){oi(this,qi,"DataView"),oi(e,ji,"DataView");var n=Bi(e).byteLength,i=ue(t);if(i<0||i>n)throw Hi("Wrong offset");if(i+(r=void 0===r?n-i:_e(r))>n)throw Hi("Wrong length");Gi(this,{buffer:e,byteLength:r,byteOffset:i}),a||(this.buffer=e,this.byteLength=r,this.byteOffset=i)},a&&(ra(ji,"byteLength"),ra(qi,"buffer"),ra(qi,"byteLength"),ra(qi,"byteOffset")),fi(qi.prototype,{getInt8:function(e){return na(this,1,e)[0]<<24>>24},getUint8:function(e){return na(this,1,e)[0]},getInt16:function(e){var t=na(this,2,e,arguments.length>1?arguments[1]:void 0);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=na(this,2,e,arguments.length>1?arguments[1]:void 0);return t[1]<<8|t[0]},getInt32:function(e){return Ji(na(this,4,e,arguments.length>1?arguments[1]:void 0))},getUint32:function(e){return Ji(na(this,4,e,arguments.length>1?arguments[1]:void 0))>>>0},getFloat32:function(e){return Zi(na(this,4,e,arguments.length>1?arguments[1]:void 0),23)},getFloat64:function(e){return Zi(na(this,8,e,arguments.length>1?arguments[1]:void 0),52)},setInt8:function(e,t){ia(this,1,e,Qi,t)},setUint8:function(e,t){ia(this,1,e,Qi,t)},setInt16:function(e,t){ia(this,2,e,Ki,t,arguments.length>2?arguments[2]:void 0)},setUint16:function(e,t){ia(this,2,e,Ki,t,arguments.length>2?arguments[2]:void 0)},setInt32:function(e,t){ia(this,4,e,$i,t,arguments.length>2?arguments[2]:void 0)},setUint32:function(e,t){ia(this,4,e,$i,t,arguments.length>2?arguments[2]:void 0)},setFloat32:function(e,t){ia(this,4,e,ea,t,arguments.length>2?arguments[2]:void 0)},setFloat64:function(e,t){ia(this,8,e,ta,t,arguments.length>2?arguments[2]:void 0)}});$t(ji,"ArrayBuffer"),$t(qi,"DataView");var ca={ArrayBuffer:ji,DataView:qi},ha=Xt("species"),fa=function(e,t){var r,n=c(e).constructor;return void 0===n||null==(r=c(n)[ha])?t:Jt(r)},va=ca.ArrayBuffer,da=ca.DataView,ya=va.prototype.slice,pa=i((function(){return!new va(2).slice(1,void 0).byteLength}));Re({target:"ArrayBuffer",proto:!0,unsafe:!0,forced:pa},{slice:function(e,t){if(void 0!==ya&&void 0===t)return ya.call(c(this),e);for(var r=c(this).byteLength,n=fe(e,r),i=fe(void 0===t?r:t,r),a=new(fa(this,va))(_e(i-n)),o=new da(this),s=new da(a),u=0;n<i;)s.setUint8(u++,o.getUint8(n++));return a}});var ma,ga=v.f,ka=n.Int8Array,Ea=ka&&ka.prototype,wa=n.Uint8ClampedArray,ba=wa&&wa.prototype,xa=ka&&on(ka),Aa=Ea&&on(Ea),Ta=Object.prototype,Ia=Ta.isPrototypeOf,Ma=Xt("toStringTag"),Sa=P("TYPED_ARRAY_TAG"),La=Mi&&!!et&&"Opera"!==An(n.opera),Pa=!1,Ra={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},Ca=function(e){return o(e)&&m(Ra,An(e))};for(ma in Ra)n[ma]||(La=!1);if((!La||"function"!=typeof xa||xa===Function.prototype)&&(xa=function(){throw TypeError("Incorrect invocation")},La))for(ma in Ra)n[ma]&&et(n[ma],xa);if((!La||!Aa||Aa===Ta)&&(Aa=xa.prototype,La))for(ma in Ra)n[ma]&&et(n[ma].prototype,Aa);if(La&&on(ba)!==Aa&&et(ba,Aa),a&&!m(Aa,Ma))for(ma in Pa=!0,ga(Aa,Ma,{get:function(){return o(this)?this[Sa]:void 0}}),Ra)n[ma]&&y(n[ma],Sa,ma);var Oa={NATIVE_ARRAY_BUFFER_VIEWS:La,TYPED_ARRAY_TAG:Pa&&Sa,aTypedArray:function(e){if(Ca(e))return e;throw TypeError("Target is not a typed array")},aTypedArrayConstructor:function(e){if(et){if(Ia.call(xa,e))return e}else for(var t in Ra)if(m(Ra,ma)){var r=n[t];if(r&&(e===r||Ia.call(r,e)))return e}throw TypeError("Target is not a typed array constructor")},exportTypedArrayMethod:function(e,t,r){if(a){if(r)for(var i in Ra){var o=n[i];o&&m(o.prototype,e)&&delete o.prototype[e]}Aa[e]&&!r||z(Aa,e,r?t:La&&Ea[e]||t)}},exportTypedArrayStaticMethod:function(e,t,r){var i,o;if(a){if(et){if(r)for(i in Ra)(o=n[i])&&m(o,e)&&delete o[e];if(xa[e]&&!r)return;try{return z(xa,e,r?t:La&&ka[e]||t)}catch(e){}}for(i in Ra)!(o=n[i])||o[e]&&!r||z(o,e,t)}},isView:function(e){var t=An(e);return"DataView"===t||m(Ra,t)},isTypedArray:Ca,TypedArray:xa,TypedArrayPrototype:Aa},Fa=Oa.NATIVE_ARRAY_BUFFER_VIEWS,Na=n.ArrayBuffer,Da=n.Int8Array,Va=!Fa||!i((function(){Da(1)}))||!i((function(){new Da(-1)}))||!ci((function(e){new Da,new Da(null),new Da(1.5),new Da(e)}),!0)||i((function(){return 1!==new Da(new Na(2),1,void 0).length})),Ua=function(e,t){var r=function(e){var t=ue(e);if(t<0)throw RangeError("The argument can't be less than 0");return t}(e);if(r%t)throw RangeError("Wrong offset");return r},Ba=Oa.aTypedArrayConstructor,Ga=function(e){var t,r,n,i,a,o,s=Vt(e),u=arguments.length,l=u>1?arguments[1]:void 0,_=void 0!==l,c=ni(s);if(null!=c&&!ti(c))for(o=(a=c.call(s)).next,s=[];!(i=o.call(a)).done;)s.push(i.value);for(_&&u>2&&(l=er(l,arguments[2],2)),r=_e(s.length),n=new(Ba(this))(r),t=0;r>t;t++)n[t]=_?l(s[t],t):s[t];return n},za=t((function(e){var t=ke.f,r=ar.forEach,i=G.get,s=G.set,u=v.f,l=re.f,_=Math.round,c=n.RangeError,f=ca.ArrayBuffer,p=ca.DataView,g=Oa.NATIVE_ARRAY_BUFFER_VIEWS,k=Oa.TYPED_ARRAY_TAG,E=Oa.TypedArray,w=Oa.TypedArrayPrototype,b=Oa.aTypedArrayConstructor,x=Oa.isTypedArray,A=function(e,t){for(var r=0,n=t.length,i=new(b(e))(n);n>r;)i[r]=t[r++];return i},T=function(e,t){u(e,t,{get:function(){return i(this)[t]}})},I=function(e){var t;return e instanceof f||"ArrayBuffer"==(t=An(e))||"SharedArrayBuffer"==t},M=function(e,t){return x(e)&&"symbol"!=typeof t&&t in e&&String(+t)==String(t)},S=function(e,t){return M(e,t=h(t,!0))?d(2,e[t]):l(e,t)},L=function(e,t,r){return!(M(e,t=h(t,!0))&&o(r)&&m(r,"value"))||m(r,"get")||m(r,"set")||r.configurable||m(r,"writable")&&!r.writable||m(r,"enumerable")&&!r.enumerable?u(e,t,r):(e[t]=r.value,e)};a?(g||(re.f=S,v.f=L,T(w,"buffer"),T(w,"byteOffset"),T(w,"byteLength"),T(w,"length")),Re({target:"Object",stat:!0,forced:!g},{getOwnPropertyDescriptor:S,defineProperty:L}),e.exports=function(e,a,l){var h=e.match(/\d+$/)[0]/8,v=e+(l?"Clamped":"")+"Array",d="get"+e,m="set"+e,b=n[v],T=b,M=T&&T.prototype,S={},L=function(e,t){u(e,t,{get:function(){return function(e,t){var r=i(e);return r.view[d](t*h+r.byteOffset,!0)}(this,t)},set:function(e){return function(e,t,r){var n=i(e);l&&(r=(r=_(r))<0?0:r>255?255:255&r),n.view[m](t*h+n.byteOffset,r,!0)}(this,t,e)},enumerable:!0})};g?Va&&(T=a((function(e,t,r,n){return oi(e,T,v),tt(o(t)?I(t)?void 0!==n?new b(t,Ua(r,h),n):void 0!==r?new b(t,Ua(r,h)):new b(t):x(t)?A(T,t):Ga.call(T,t):new b(Si(t)),e,T)})),et&&et(T,E),r(t(b),(function(e){e in T||y(T,e,b[e])})),T.prototype=M):(T=a((function(e,t,r,n){oi(e,T,v);var i,a,u,l=0,_=0;if(o(t)){if(!I(t))return x(t)?A(T,t):Ga.call(T,t);i=t,_=Ua(r,h);var d=t.byteLength;if(void 0===n){if(d%h)throw c("Wrong length");if((a=d-_)<0)throw c("Wrong length")}else if((a=_e(n)*h)+_>d)throw c("Wrong length");u=a/h}else u=Si(t),i=new f(a=u*h);for(s(e,{buffer:i,byteOffset:_,byteLength:a,length:u,view:new p(i)});l<u;)L(e,l++)})),et&&et(T,E),M=T.prototype=lt(w)),M.constructor!==T&&y(M,"constructor",T),k&&y(M,k,v),S[v]=T,Re({global:!0,forced:T!=b,sham:!g},S),"BYTES_PER_ELEMENT"in T||y(T,"BYTES_PER_ELEMENT",h),"BYTES_PER_ELEMENT"in M||y(M,"BYTES_PER_ELEMENT",h),di(v)}):e.exports=function(){}}));za("Float32",(function(e){return function(t,r,n){return e(this,t,r,n)}})),za("Float64",(function(e){return function(t,r,n){return e(this,t,r,n)}}));var ja=Math.min,qa=[].copyWithin||function(e,t){var r=Vt(this),n=_e(r.length),i=fe(e,n),a=fe(t,n),o=arguments.length>2?arguments[2]:void 0,s=ja((void 0===o?n:fe(o,n))-a,n-i),u=1;for(a<i&&i<a+s&&(u=-1,a+=s-1,i+=s-1);s-- >0;)a in r?r[i]=r[a]:delete r[i],i+=u,a+=u;return r},Ya=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("copyWithin",(function(e,t){return qa.call(Ya(this),e,t,arguments.length>2?arguments[2]:void 0)}));var Xa=ar.every,Ha=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("every",(function(e){return Xa(Ha(this),e,arguments.length>1?arguments[1]:void 0)}));var Wa=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("fill",(function(e){return Di.apply(Wa(this),arguments)}));var Za=ar.filter,Qa=Oa.aTypedArray,Ka=Oa.aTypedArrayConstructor;(0,Oa.exportTypedArrayMethod)("filter",(function(e){for(var t=Za(Qa(this),e,arguments.length>1?arguments[1]:void 0),r=fa(this,this.constructor),n=0,i=t.length,a=new(Ka(r))(i);i>n;)a[n]=t[n++];return a}));var $a=ar.find,Ja=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("find",(function(e){return $a(Ja(this),e,arguments.length>1?arguments[1]:void 0)}));var eo=ar.findIndex,to=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("findIndex",(function(e){return eo(to(this),e,arguments.length>1?arguments[1]:void 0)}));var ro=ar.forEach,no=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("forEach",(function(e){ro(no(this),e,arguments.length>1?arguments[1]:void 0)}));var io=de.includes,ao=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("includes",(function(e){return io(ao(this),e,arguments.length>1?arguments[1]:void 0)}));var oo=de.indexOf,so=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("indexOf",(function(e){return oo(so(this),e,arguments.length>1?arguments[1]:void 0)}));var uo=Xt("iterator"),lo=n.Uint8Array,_o=kn.values,co=kn.keys,ho=kn.entries,fo=Oa.aTypedArray,vo=Oa.exportTypedArrayMethod,yo=lo&&lo.prototype[uo],po=!!yo&&("values"==yo.name||null==yo.name),mo=function(){return _o.call(fo(this))};vo("entries",(function(){return ho.call(fo(this))})),vo("keys",(function(){return co.call(fo(this))})),vo("values",mo,!po),vo(uo,mo,!po);var go=Oa.aTypedArray,ko=[].join;(0,Oa.exportTypedArrayMethod)("join",(function(e){return ko.apply(go(this),arguments)}));var Eo=function(e,t){var r=[][e];return!!r&&i((function(){r.call(null,t||function(){throw 1},1)}))},wo=Math.min,bo=[].lastIndexOf,xo=!!bo&&1/[1].lastIndexOf(1,-0)<0,Ao=Eo("lastIndexOf"),To=Zr("indexOf",{ACCESSORS:!0,1:0}),Io=xo||!Ao||!To?function(e){if(xo)return bo.apply(this,arguments)||0;var t=ee(this),r=_e(t.length),n=r-1;for(arguments.length>1&&(n=wo(n,ue(arguments[1]))),n<0&&(n=r+n);n>=0;n--)if(n in t&&t[n]===e)return n||0;return-1}:bo,Mo=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("lastIndexOf",(function(e){return Io.apply(Mo(this),arguments)}));var So=ar.map,Lo=Oa.aTypedArray,Po=Oa.aTypedArrayConstructor;(0,Oa.exportTypedArrayMethod)("map",(function(e){return So(Lo(this),e,arguments.length>1?arguments[1]:void 0,(function(e,t){return new(Po(fa(e,e.constructor)))(t)}))}));var Ro=function(e){return function(t,r,n,i){Jt(r);var a=Vt(t),o=$(a),s=_e(a.length),u=e?s-1:0,l=e?-1:1;if(n<2)for(;;){if(u in o){i=o[u],u+=l;break}if(u+=l,e?u<0:s<=u)throw TypeError("Reduce of empty array with no initial value")}for(;e?u>=0:s>u;u+=l)u in o&&(i=r(i,o[u],u,a));return i}},Co={left:Ro(!1),right:Ro(!0)},Oo=Co.left,Fo=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("reduce",(function(e){return Oo(Fo(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var No=Co.right,Do=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("reduceRight",(function(e){return No(Do(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var Vo=Oa.aTypedArray,Uo=Oa.exportTypedArrayMethod,Bo=Math.floor;Uo("reverse",(function(){for(var e,t=Vo(this).length,r=Bo(t/2),n=0;n<r;)e=this[n],this[n++]=this[--t],this[t]=e;return this}));var Go=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("set",(function(e){Go(this);var t=Ua(arguments.length>1?arguments[1]:void 0,1),r=this.length,n=Vt(e),i=_e(n.length),a=0;if(i+t>r)throw RangeError("Wrong length");for(;a<i;)this[t+a]=n[a++]}),i((function(){new Int8Array(1).set({})})));var zo=Oa.aTypedArray,jo=Oa.aTypedArrayConstructor,qo=[].slice;(0,Oa.exportTypedArrayMethod)("slice",(function(e,t){for(var r=qo.call(zo(this),e,t),n=fa(this,this.constructor),i=0,a=r.length,o=new(jo(n))(a);a>i;)o[i]=r[i++];return o}),i((function(){new Int8Array(1).slice()})));var Yo=ar.some,Xo=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("some",(function(e){return Yo(Xo(this),e,arguments.length>1?arguments[1]:void 0)}));var Ho=Oa.aTypedArray,Wo=[].sort;(0,Oa.exportTypedArrayMethod)("sort",(function(e){return Wo.call(Ho(this),e)}));var Zo=Oa.aTypedArray;(0,Oa.exportTypedArrayMethod)("subarray",(function(e,t){var r=Zo(this),n=r.length,i=fe(e,n);return new(fa(r,r.constructor))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,_e((void 0===t?n:fe(t,n))-i))}));var Qo=n.Int8Array,Ko=Oa.aTypedArray,$o=Oa.exportTypedArrayMethod,Jo=[].toLocaleString,es=[].slice,ts=!!Qo&&i((function(){Jo.call(new Qo(1))}));$o("toLocaleString",(function(){return Jo.apply(ts?es.call(Ko(this)):Ko(this),arguments)}),i((function(){return[1,2].toLocaleString()!=new Qo([1,2]).toLocaleString()}))||!i((function(){Qo.prototype.toLocaleString.call([1,2])})));var rs=Oa.exportTypedArrayMethod,ns=n.Uint8Array,is=ns&&ns.prototype||{},as=[].toString,os=[].join;i((function(){as.call({})}))&&(as=function(){return os.call(this)});var ss=is.toString!=as;rs("toString",as,ss);var us=function(){function e(){Ue(this,e)}return Ge(e,null,[{key:"createMatrix",value:function(e){return new Float64Array(e||16)}},{key:"createMatrixf",value:function(e){return new Float32Array(e||16)}},{key:"createVector4",value:function(e){return new Float64Array(e||4)}},{key:"createVector4f",value:function(e){return new Float32Array(e||4)}},{key:"createVector3",value:function(e){return new Float64Array(e||3)}},{key:"createVector3f",value:function(e){return new Float32Array(e||3)}},{key:"createVector2",value:function(e){return new Float64Array(e||2)}},{key:"createVector2f",value:function(e){return new Float32Array(e||2)}},{key:"copyMatrix",value:function(e,t){for(var r=0;r<16;++r)t[r]=e[r];return t}},{key:"copyVector4",value:function(e,t){for(var r=0;r<4;++r)t[r]=e[r];return t}},{key:"copyVector3",value:function(e,t){for(var r=0;r<3;++r)t[r]=e[r];return t}},{key:"copyVector2",value:function(e,t){return t[0]=e[0],t[1]=e[1],t}},{key:"setIdentity",value:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}},{key:"dot3",value:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}},{key:"cross3",value:function(e,t,r){var n=e[1]*t[2]-e[2]*t[1],i=e[2]*t[0]-e[0]*t[2],a=e[0]*t[1]-e[1]*t[0];return r[0]=n,r[1]=i,r[2]=a,r}},{key:"normalize3",value:function(e,t){var r=e[0],n=e[1],i=e[2],a=1/Math.sqrt(r*r+n*n+i*i);return t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,t}},{key:"scale3",value:function(e,t,r){return r[0]=e*t[0],r[1]=e*t[1],r[2]=e*t[2],r}},{key:"mul_AA",value:function(e,t,r){var n=e[0],i=e[4],a=e[8],o=e[12],s=e[1],u=e[5],l=e[9],_=e[13],c=e[2],h=e[6],f=e[10],v=e[14],d=t[0],y=t[4],p=t[8],m=t[12],g=t[1],k=t[5],E=t[9],w=t[13],b=t[2],x=t[6],A=t[10],T=t[14];return r[0]=n*d+i*g+a*b,r[1]=s*d+u*g+l*b,r[2]=c*d+h*g+f*b,r[3]=0,r[4]=n*y+i*k+a*x,r[5]=s*y+u*k+l*x,r[6]=c*y+h*k+f*x,r[7]=0,r[8]=n*p+i*E+a*A,r[9]=s*p+u*E+l*A,r[10]=c*p+h*E+f*A,r[11]=0,r[12]=n*m+i*w+a*T+o,r[13]=s*m+u*w+l*T+_,r[14]=c*m+h*w+f*T+v,r[15]=1,r}},{key:"mul_GA",value:function(e,t,r){var n=e[0],i=e[4],a=e[8],o=e[12],s=e[1],u=e[5],l=e[9],_=e[13],c=e[2],h=e[6],f=e[10],v=e[14],d=e[3],y=e[7],p=e[11],m=e[15],g=t[0],k=t[4],E=t[8],w=t[12],b=t[1],x=t[5],A=t[9],T=t[13],I=t[2],M=t[6],S=t[10],L=t[14];return r[0]=n*g+i*b+a*I,r[1]=s*g+u*b+l*I,r[2]=c*g+h*b+f*I,r[3]=d*g+y*b+p*I,r[4]=n*k+i*x+a*M,r[5]=s*k+u*x+l*M,r[6]=c*k+h*x+f*M,r[7]=d*k+y*x+p*M,r[8]=n*E+i*A+a*S,r[9]=s*E+u*A+l*S,r[10]=c*E+h*A+f*S,r[11]=d*E+y*A+p*S,r[12]=n*w+i*T+a*L+o,r[13]=s*w+u*T+l*L+_,r[14]=c*w+h*T+f*L+v,r[15]=d*w+y*T+p*L+m,r}},{key:"mul_PzA",value:function(e,t,r){var n=e[0],i=e[8],a=e[12],o=e[5],s=e[9],u=e[13],l=e[10],_=e[14],c=e[11],h=e[15],f=t[0],v=t[4],d=t[8],y=t[12],p=t[1],m=t[5],g=t[9],k=t[13],E=t[2],w=t[6],b=t[10],x=t[14];return r[0]=n*f+i*E,r[1]=o*p+s*E,r[2]=l*E,r[3]=c*E,r[4]=n*v+i*w,r[5]=o*m+s*w,r[6]=l*w,r[7]=c*w,r[8]=n*d+i*b,r[9]=o*g+s*b,r[10]=l*b,r[11]=c*b,r[12]=n*y+i*x+a,r[13]=o*k+s*x+u,r[14]=l*x+_,r[15]=c*x+h,r}},{key:"inverse_A",value:function(e,t){var r=e[0],n=e[4],i=e[8],a=e[12],o=e[1],s=e[5],u=e[9],l=e[13],_=e[2],c=e[6],h=e[10],f=e[14],v=s*h-c*u,d=_*u-o*h,y=o*c-_*s,p=c*i-n*h,m=r*h-_*i,g=_*n-r*c,k=n*u-s*i,E=o*i-r*u,w=r*s-o*n,b=-(a*v+l*p+f*k),x=-(a*d+l*m+f*E),A=-(a*y+l*g+f*w),T=1/(r*v+n*d+i*y);return t[0]=v*T,t[1]=d*T,t[2]=y*T,t[3]=0,t[4]=p*T,t[5]=m*T,t[6]=g*T,t[7]=0,t[8]=k*T,t[9]=E*T,t[10]=w*T,t[11]=0,t[12]=b*T,t[13]=x*T,t[14]=A*T,t[15]=1,t}},{key:"transformPlane_A",value:function(e,t,r){var n=e,i=t[0],a=t[1],o=t[2],s=t[3];return r[0]=i*n[0]+a*n[1]+o*n[2],r[1]=i*n[4]+a*n[5]+o*n[6],r[2]=i*n[8]+a*n[9]+o*n[10],r[3]=i*n[12]+a*n[13]+o*n[14]+s,r}},{key:"iscs_to_gocs_matrix",value:function(t,r){var n=t.longitude*e.DEGREE,i=t.latitude*e.DEGREE,a=Math.sin(n),o=Math.cos(n),s=Math.sin(i),u=Math.cos(i),l=e.EARTH_RADIUS+t.height;return r[0]=-a,r[1]=o,r[2]=0,r[3]=0,r[4]=-o*s,r[5]=-a*s,r[6]=u,r[7]=0,r[8]=u*o,r[9]=u*a,r[10]=s,r[11]=0,r[12]=l*u*o,r[13]=l*u*a,r[14]=l*s,r[15]=1,r}},{key:"gocs_to_iscs",value:function(t,r){var n=t[0],i=t[1],a=t[2],o=n*n,s=i*i,u=a*a;return 0!=n||0!=i?(r.latitude=Math.atan(a/Math.sqrt(o+s))/e.DEGREE,r.longitude=Math.atan2(i,n)/e.DEGREE):(r.latitude=a>0?90:a<0?-90:0,r.longitude=0),r.height=Math.sqrt(o+s+u)-e.EARTH_RADIUS,r}},{key:"frustum_matrix",value:function(e,t,r,n,i,a,o){return o[0]=2*i/(t-e),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*i/(n-r),o[6]=0,o[7]=0,o[8]=(t+e)/(t-e),o[9]=(n+r)/(n-r),o[10]=(a+i)/(i-a),o[11]=-1,o[12]=0,o[13]=0,o[14]=2*a*i/(i-a),o[15]=0,o}},{key:"lookat_matrix",value:function(t,r,n,i){var a=e._xaxis,o=e._yaxis,s=e._zaxis;return s[0]=t[0]-r[0],s[1]=t[1]-r[1],s[2]=t[2]-r[2],e.normalize3(s,s),e.cross3(n,s,a),e.normalize3(a,a),e.cross3(s,a,o),i[0]=a[0],i[1]=a[1],i[2]=a[2],i[3]=0,i[4]=o[0],i[5]=o[1],i[6]=o[2],i[7]=0,i[8]=s[0],i[9]=s[1],i[10]=s[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}},{key:"rotation_matrix",value:function(t,r,n){var i=r*e.DEGREE,a=Math.sin(i),o=Math.cos(i),s=t[0],u=t[1],l=t[2];return n[0]=s*s*(1-o)+o,n[1]=s*u*(1-o)+l*a,n[2]=s*l*(1-o)-u*a,n[3]=0,n[4]=s*u*(1-o)-l*a,n[5]=u*u*(1-o)+o,n[6]=u*l*(1-o)+s*a,n[7]=0,n[8]=s*l*(1-o)+u*a,n[9]=u*l*(1-o)-s*a,n[10]=l*l*(1-o)+o,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}},{key:"kml_model_matrix",value:function(t,r,n,i,a){var o=t*e.DEGREE,s=r*e.DEGREE,u=n*e.DEGREE,l=Math.sin(o),_=Math.cos(o),c=Math.sin(s),h=Math.cos(s),f=Math.sin(u),v=Math.cos(u),d=i[0],y=i[1],p=i[2];return a[0]=d*(l*f*c+_*v),a[1]=d*(_*f*c-l*v),a[2]=d*f*h,a[3]=0,a[4]=y*l*h,a[5]=y*_*h,a[6]=-y*c,a[7]=0,a[8]=p*(l*v*c-_*f),a[9]=p*(_*v*c+l*f),a[10]=p*v*h,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}},{key:"gudermannian",value:function(e){return 2*Math.atan(Math.exp(e))-Math.PI/2}},{key:"invGudermannian",value:function(e){return Math.log(Math.tan(e/2+Math.PI/4))}},{key:"clamp",value:function(e,t,r){return Math.min(Math.max(e,t),r)}}]),e}();us.EARTH_RADIUS=6378137,us.DEGREE=.017453292519943295,us.LOG2PI=1.6514961294723187,us._xaxis=us.createVector3(),us._yaxis=us.createVector3(),us._zaxis=us.createVector3();var ls=function(){function e(t,r,n){Ue(this,e),this.longitude=void 0!==t?t:0,this.latitude=void 0!==r?r:0,this.altitude=void 0!==n?n:0}return Ge(e,[{key:"clone",value:function(){return new e(this.longitude,this.latitude,this.altitude)}},{key:"assign",value:function(e){return this.longitude=e.longitude,this.latitude=e.latitude,this.altitude=e.altitude,this}},{key:"setFromArray",value:function(e){return this.longitude=e[0],this.latitude=e[1],this.altitude=e.length>2?e[2]:0,this}},{key:"setFromGocs",value:function(e){var t=e[0],r=e[1],n=e[2],i=t*t,a=r*r,o=n*n;return 0!=t||0!=r?(this.latitude=Math.atan(n/Math.sqrt(i+a))/us.DEGREE,this.longitude=Math.atan2(r,t)/us.DEGREE):(this.latitude=n>0?90:n<0?-90:0,this.longitude=0),this.altitude=Math.sqrt(i+a+o)-us.EARTH_RADIUS,this}},{key:"getAsGocs",value:function(e){var t=this.longitude*us.DEGREE,r=this.latitude*us.DEGREE,n=us.EARTH_RADIUS+this.altitude,i=Math.cos(r);return e[0]=n*i*Math.cos(t),e[1]=n*i*Math.sin(t),e[2]=n*Math.sin(r),e}},{key:"getMlocsToGocsMatrix",value:function(e){var t=this.longitude*us.DEGREE,r=this.latitude*us.DEGREE,n=Math.sin(t),i=Math.cos(t),a=Math.sin(r),o=Math.cos(r),s=us.EARTH_RADIUS+this.altitude;return e[0]=-n,e[1]=i,e[2]=0,e[3]=0,e[4]=-i*a,e[5]=-n*a,e[6]=o,e[7]=0,e[8]=o*i,e[9]=o*n,e[10]=a,e[11]=0,e[12]=s*o*i,e[13]=s*o*n,e[14]=s*a,e[15]=1,e}}],[{key:"toGocsArray",value:function(e,t,r){for(var n=us.DEGREE,i=us.EARTH_RADIUS,a=0;a<t;++a){var o=3*a,s=e[o]*n,u=e[o+1]*n,l=i+e[o+2],_=Math.cos(u);r[o]=l*_*Math.cos(s),r[o+1]=l*_*Math.sin(s),r[o+2]=l*Math.sin(u)}return r}}]),e}(),_s=function(){function e(t,r,n){Ue(this,e),this.heading=void 0!==t?t:0,this.tilt=void 0!==r?r:0,this.roll=void 0!==n?n:0}return Ge(e,[{key:"clone",value:function(){return new e(this.heading,this.tilt,this.roll)}},{key:"assign",value:function(e){return this.heading=e.heading,this.tilt=e.tilt,this.roll=e.roll,this}},{key:"getTransformMatrix",value:function(e,t){var r=this.heading*us.DEGREE,n=this.tilt*us.DEGREE,i=this.roll*us.DEGREE,a=Math.sin(r),o=Math.cos(r),s=Math.sin(n),u=Math.cos(n),l=Math.sin(i),_=Math.cos(i),c=e[0],h=e[1],f=e[2];return t[0]=c*(a*l*s+o*_),t[1]=c*(o*l*s-a*_),t[2]=c*l*u,t[3]=0,t[4]=h*a*u,t[5]=h*o*u,t[6]=-h*s,t[7]=0,t[8]=f*(a*_*s-o*l),t[9]=f*(o*_*s+a*l),t[10]=f*_*u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}}]),e}(),cs=function(e){function t(){var e;return Ue(this,t),(e=Ze(this,je(t).call(this,"boolean")))._number_type=null,e._convertibles=new Set([We(e)]),e}return ze(t,e),Ge(t,[{key:"_postinit",value:function(){this._number_type=Ei.find("number"),this._convertibles.add(this._number_type)}},{key:"isConvertible",value:function(e){return this._convertibles.has(e)}},{key:"convertValue",value:function(e,t){return e===this?t:t>=.5}},{key:"getDefaultValue",value:function(){return!1}},{key:"getCloneValue",value:function(e){return e}}]),t}(Ei),hs=function(e){function t(){var e;return Ue(this,t),(e=Ze(this,je(t).call(this,"number")))._boolean_type=null,e._convertibles=new Set([We(e)]),e}return ze(t,e),Ge(t,[{key:"_postinit",value:function(){this._boolean_type=Ei.find("boolean"),this._convertibles.add(this._boolean_type)}},{key:"isConvertible",value:function(e){return this._convertibles.has(e)}},{key:"convertValue",value:function(e,t){return e===this?t:t?1:0}},{key:"getDefaultValue",value:function(){return 0}},{key:"getCloneValue",value:function(e){return e}}]),t}(Ei),fs=function(e){function t(){return Ue(this,t),Ze(this,je(t).call(this,"string"))}return ze(t,e),Ge(t,[{key:"_postinit",value:function(){}},{key:"isConvertible",value:function(e){return e===this}},{key:"convertValue",value:function(e,t){return t}},{key:"getDefaultValue",value:function(){return""}},{key:"getCloneValue",value:function(e){return e}}]),t}(Ei),vs=function(e){function t(){return Ue(this,t),Ze(this,je(t).call(this,"vector2"))}return ze(t,e),Ge(t,[{key:"_postinit",value:function(){}},{key:"isConvertible",value:function(e){return e===this}},{key:"convertValue",value:function(e,t){return t}},{key:"getDefaultValue",value:function(){return us.createVector2()}},{key:"getCloneValue",value:function(e){return us.createVector2(e)}}]),t}(Ei),ds=function(e){function t(){return Ue(this,t),Ze(this,je(t).call(this,"vector3"))}return ze(t,e),Ge(t,[{key:"_postinit",value:function(){}},{key:"isConvertible",value:function(e){return e===this}},{key:"convertValue",value:function(e,t){return t}},{key:"getDefaultValue",value:function(){return us.createVector3()}},{key:"getCloneValue",value:function(e){return us.createVector3(e)}}]),t}(Ei),ys=function(e){function t(){return Ue(this,t),Ze(this,je(t).call(this,"vector4"))}return ze(t,e),Ge(t,[{key:"_postinit",value:function(){}},{key:"isConvertible",value:function(e){return e===this}},{key:"convertValue",value:function(e,t){return t}},{key:"getDefaultValue",value:function(){return us.createVector4()}},{key:"getCloneValue",value:function(e){return us.createVector4(e)}}]),t}(Ei),ps=function(e){function t(){return Ue(this,t),Ze(this,je(t).call(this,"matrix"))}return ze(t,e),Ge(t,[{key:"_postinit",value:function(){}},{key:"isConvertible",value:function(e){return e===this}},{key:"convertValue",value:function(e,t){return t}},{key:"getDefaultValue",value:function(){return us.setIdentity(us.createMatrix())}},{key:"getCloneValue",value:function(e){return us.createMatrix(e)}}]),t}(Ei);!function(){for(var e=[],t=0,r=[cs,hs,fs,ds,vs,ys,ps];t<r.length;t++){var n=new(0,r[t]);Ei.register(n.name,n),e.push(n)}for(var i=0,a=e;i<a.length;i++){a[i]._postinit()}}();var ms=function(){function e(){Ue(this,e),this._value_change_listeners=new Set}return Ge(e,[{key:"isTypeSupported",value:function(e){this._override_error("isTypeSupported")}},{key:"getValue",value:function(e,t){this._override_error("getValue")}},{key:"getInvariance",value:function(e){this._override_error("getInvariance")}},{key:"notifyValueChange",value:function(e){if(!e.isEmpty()){var t=!0,r=!1,n=void 0;try{for(var i,a=this._value_change_listeners[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){(0,i.value)(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}}},{key:"addValueChangeListener",value:function(e){this._value_change_listeners.add(e)}},{key:"removeValueChangeListener",value:function(e){this._value_change_listeners.delete(e)}},{key:"_override_error",value:function(e){throw new Error("Curve#"+e+"() method has not been overridden in "+this.constructor.name)}}]),e}(),gs=function(e,t,r){var n=h(t);n in e?v.f(e,n,d(0,r)):e[n]=r},ks=function(e){var t,r,n,i,a,o,s=Vt(e),u="function"==typeof this?this:Array,l=arguments.length,_=l>1?arguments[1]:void 0,c=void 0!==_,h=ni(s),f=0;if(c&&(_=er(_,l>2?arguments[2]:void 0,2)),null==h||u==Array&&ti(h))for(r=new u(t=_e(s.length));t>f;f++)o=c?_(s[f],f):s[f],gs(r,f,o);else for(a=(i=h.call(s)).next,r=new u;!(n=a.call(i)).done;f++)o=c?ii(i,_,[n.value,f],!0):n.value,gs(r,f,o);return r.length=f,r},Es=!ci((function(e){Array.from(e)}));Re({target:"Array",stat:!0,forced:Es},{from:ks});var ws=function(){function e(){Ue(this,e),this._prev_time=null,this._track_binders=new Map,this._dirty_binders=new Set,this._vary_curves=new xs}return Ge(e,[{key:"update",value:function(e){if(this._update_dirty_binders(e),null!==this._prev_time){var t=this._vary_curves.getVaryCurves(this._prev_time,e),r=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;this._track_binders.get(s).updateBinders(e)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}}this._flush_dirty_binders(),this._prev_time=e}},{key:"_$register",value:function(e){this._dirty_binders.add(e)}},{key:"_$unregister",value:function(e){this._dirty_binders.delete(e)||this._track_binders.get(e._$curve).unregister(e)}},{key:"_update_dirty_binders",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=this._dirty_binders[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){i.value._$update(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"_flush_dirty_binders",value:function(){for(var e=0,t=Array.from(this._dirty_binders);e<t.length;e++){var r=t[e];this._dirty_binders.delete(r);var n=r._$curve,i=this._track_binders.get(n);void 0===i?(i=new bs(this,n,r),this._track_binders.set(n,i)):i.register(r)}}}]),e}(),bs=function(){function e(t,r,n){var i=this;Ue(this,e),this._updater=t,this._curve=r,this._binders=new Set([n]),this._invariance=r.getInvariance(Ct.UNIVERSAL),this._listener=function(e){i._onValueChange(e)},r.addValueChangeListener(this._listener),t._vary_curves.addCurve(r,this._invariance)}return Ge(e,[{key:"register",value:function(e){this._binders.add(e)}},{key:"unregister",value:function(e){this._binders.delete(e),this._binders.size>0||(this._updater._vary_curves.removeCurve(this._curve,this._invariance),this._curve.removeValueChangeListener(this._listener),this._updater._track_binders.delete(this._curve))}},{key:"updateBinders",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=this._binders[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){i.value._$update(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"_onValueChange",value:function(e){if(e.includesTime(this._updater._prev_time))this._move_to_dirty_binders();else{var t=this._curve.getInvariance(e);this._updater._vary_curves.modifyCurve(this._curve,e,t,this._invariance),this._invariance._$modify(t)}}},{key:"_move_to_dirty_binders",value:function(){for(var e=0,t=Array.from(this._binders);e<t.length;e++){var r=t[e];this.unregister(r),this._updater._dirty_binders.add(r)}}}]),e}(),xs=function(){function e(){Ue(this,e),this._continuous=Ts(),this._oneshot=Ts(),this._oneshot_L=Ts(),this._oneshot_R=Ts()}return Ge(e,[{key:"addCurve",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ct.UNIVERSAL,n=t.getNarrowed(r)._$getArray();if(0==n.length)this._addToGeneric(e,r);else{var i=n.length-1,a=n[0],o=r.getIntersection(a.getPrecedings());o.isEmpty()?Is(r,a)&&!this._hasContiguous_L(a,e)&&(a.l_open?this._addToOneshotGroup(e,a,"_oneshot_R"):a.getPrecedings().isEmpty()||this._addToOneshotGroup(e,a,"_oneshot_L")):this._addToGeneric(e,o);for(var s=0;s<i;++s){var u=n[s].getFollowings(),l=n[s+1].getPrecedings(),_=u.getIntersection(l);_.isEmpty()?this._addToOneshotGroup(e,u,u.l_open?"_oneshot_R":"_oneshot_L"):this._addToGeneric(e,_)}var c=n[i],h=r.getIntersection(c.getFollowings());h.isEmpty()?Ms(r,c)&&!this._hasContiguous_R(c,e)&&(c.u_open?this._addToOneshotGroup(e,c,"_oneshot_L"):c.getFollowings().isEmpty()||this._addToOneshotGroup(e,c,"_oneshot_R")):this._addToGeneric(e,h)}}},{key:"_hasContiguous_L",value:function(e,t){var r=this._continuous,n=r.findLower(e.lower),i=null!==n?n.findPredecessor():r.findLast();if(null!==i){var a=i.value,o=a.interval;if(o.upper.equals(e.lower)&&(e.l_open&&!o.u_open||!e.l_open&&o.u_open)&&a.curves.has(t))return!0}return!1}},{key:"_hasContiguous_R",value:function(e,t){var r=this._continuous.findLower(e.upper);if(null===r)return!1;var n=r.value,i=n.interval;return!!i.lower.equals(e.upper)&&(!(i.l_open&&e.u_open||!i.l_open&&!e.u_open)&&n.curves.has(t))}},{key:"removeCurve",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ct.UNIVERSAL,n=t.getNarrowed(r)._$getArray();if(0==n.length)this._removeForGeneric(e,r);else{var i=n.length-1,a=n[0],o=r.getIntersection(a.getPrecedings());o.isEmpty()?Is(r,a)&&this._removeForOneshotGroup(e,r):this._removeForGeneric(e,o);for(var s=0;s<i;++s){var u=n[s].getFollowings(),l=n[s+1].getPrecedings(),_=u.getIntersection(l);_.isEmpty()?this._removeForOneshotGroup(e,u):this._removeForGeneric(e,_)}var c=n[i],h=r.getIntersection(c.getFollowings());if(h.isEmpty()){if(Ms(r,c)){var f=r.upper;this._removeForOneshotGroup(e,new Ct(f,f))}}else this._removeForGeneric(e,h)}}},{key:"modifyCurve",value:function(e,t,r,n){var i=n._$expandIntervalByAlignment(t);this.removeCurve(e,n,i),this.addCurve(e,r,i)}},{key:"getVaryCurves",value:function(e,t){return e.lessThan(t)?this._collectCurves(e,t):t.lessThan(e)?this._collectCurves(t,e):[]}},{key:"_addToGeneric",value:function(e,t){t.isProper()?this._addToContinuous(e,t):t.isSingle()&&this._addToOneshotGroup(e,t,"_oneshot")}},{key:"_addToOneshotGroup",value:function(e,t,r){var n=this[r],i=t.lower,a=n.findEqual(i);null===a&&(a=n.insert(i,new Set)),a.value.add(e)}},{key:"_addToContinuous",value:function(e,t){for(var r=t,n=e;;){var i=this._removeFirstCrossInContinuous(r);if(null!==i){var a=i.cc.interval,o=i.cc.curves,s=i.cross,u=r.getPrecedings().getIntersection(a);if(u.isEmpty()){var l=r.getIntersection(a.getPrecedings());l.isEmpty()||this._addForContinuous(l,n)}else this._addForContinuous(u,new Set(o));var _=r.getFollowings().getIntersection(a);if(_.isEmpty()){this._addForContinuous(s,o.add(n));var c=r.getIntersection(a.getFollowings());if(!c.isEmpty()){r=c;continue}}else this._addForContinuous(_,new Set(o)),this._addForContinuous(s,o.add(n))}else this._addForContinuous(r,n);break}}},{key:"_removeFirstCrossInContinuous",value:function(e){var t=this._continuous,r=t.findUpper(e.lower),n=null!==r?r.findPredecessor():t.findLast();if(null!==n){var i=e.getIntersection(n.value.interval);if(!i.isEmpty()){var a=n.value;return t.remove(n),{cc:a,cross:i}}}if(null!==r){var o=e.getIntersection(r.value.interval);if(!o.isEmpty()){var s=r.value;return t.remove(r),{cc:s,cross:o}}}return null}},{key:"_addForContinuous",value:function(e,t){var r=e.lower;if(e.isSingle()){var n=this._oneshot.findEqual(r);null===n&&(n=this._oneshot.insert(r,new Set));var i=n.value;if(t instanceof Set){var a=!0,o=!1,s=void 0;try{for(var u,l=t[Symbol.iterator]();!(a=(u=l.next()).done);a=!0){var _=u.value;i.add(_)}}catch(e){o=!0,s=e}finally{try{a||null==l.return||l.return()}finally{if(o)throw s}}}else i.add(t)}else this._continuous.insert(r,new As(e,t))}},{key:"_removeForGeneric",value:function(e,t){t.isProper()?this._removeForContinuous(e,t):t.isSingle()&&this._removeForOneshotGroup(e,t)}},{key:"_removeForOneshotGroup",value:function(e,t){for(var r=t.lower,n=0,i=["_oneshot","_oneshot_L","_oneshot_R"];n<i.length;n++){var a=this[i[n]],o=a.findEqual(r);if(null!==o){var s=o.value;s.has(e)&&(s.delete(e),0==s.size&&a.remove(o));break}}}},{key:"_removeForContinuous",value:function(e,t){for(var r=this._continuous,n=r.findUpper(t.lower),i=null!==n?n.findPredecessor():r.findLast(),a=r.findUpper(t.upper),o=i||n;o!==a;){var s=o.value.curves;s.delete(e),o=0==s.size?r.remove(o):o.findSuccessor()}for(var u=this._oneshot,l=u.findLower(t.lower),_=u.findUpper(t.upper),c=l;c!==_;){var h=c.value;h.delete(e),c=0==h.size?u.remove(c):c.findSuccessor()}}},{key:"_collectCurves",value:function(e,t){var r=new Set;return this._collectContinuousCurves(e,t,r),this._collectOneshotCurves(e,t,"_oneshot",!0,!0,r),this._collectOneshotCurves(e,t,"_oneshot_L",!1,!0,r),this._collectOneshotCurves(e,t,"_oneshot_R",!0,!1,r),r}},{key:"_collectContinuousCurves",value:function(e,t,r){var n=this._continuous.findLower(e);if(null!==n){var i=n.findPredecessor();null!==i&&i.value.interval.includeTime(e)&&(n=i)}var a=this._continuous.findLower(t);if(null!==a){var o=a.value.interval;o.lower.equals(t)&&!o.l_open&&(a=a.findSuccessor())}for(var s=n;s!==a;s=s.findSuccessor()){var u=!0,l=!1,_=void 0;try{for(var c,h=s.value.curves[Symbol.iterator]();!(u=(c=h.next()).done);u=!0){var f=c.value;r.add(f)}}catch(e){l=!0,_=e}finally{try{u||null==h.return||h.return()}finally{if(l)throw _}}}}},{key:"_collectOneshotCurves",value:function(e,t,r,n,i,a){for(var o=this[r],s=n?o.findLower(e):o.findUpper(e),u=n?o.findUpper(t):o.findLower(t),l=s;l!==u;l=l.findSuccessor()){var _=!0,c=!1,h=void 0;try{for(var f,v=l.value[Symbol.iterator]();!(_=(f=v.next()).done);_=!0){var d=f.value;a.add(d)}}catch(e){c=!0,h=e}finally{try{_||null==v.return||v.return()}finally{if(c)throw h}}}}}]),e}(),As=function e(t,r){Ue(this,e),this.interval=t,this.curves=new Set(r instanceof Set?r:[r])};function Ts(){return new Xn((function(e,t){return e.lessThan(t)}))}function Is(e,t){return e.lower.equals(t.lower)&&(e.l_open&&t.l_open||!e.l_open&&!t.l_open)}function Ms(e,t){return e.upper.equals(t.upper)&&(e.u_open&&t.u_open||!e.u_open&&!t.u_open)}var Ss,Ls,Ps=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e))).name="mapray.animation.TypeMismatchError",r}return ze(t,e),t}(Je),Rs=function(){function e(t,r,n,i){if(Ue(this,e),!r.isTypeSupported(n))throw new Ps("type mismatch error");this._updater=t,this._curve=r,this._type=n,this._setter=i,t._$register(this)}return Ge(e,[{key:"unbind",value:function(){this._updater._$unregister(this)}},{key:"_$update",value:function(e){var t=this._curve.getValue(e,this._type);(0,this._setter)(t)}},{key:"updater",get:function(){return this._updater}},{key:"curve",get:function(){return this._curve}},{key:"type",get:function(){return this._type}},{key:"setter",get:function(){return this._setter}},{key:"_$curve",get:function(){return this._curve}}]),e}(),Cs=ae("navigator","userAgent")||"",Os=n.process,Fs=Os&&Os.versions,Ns=Fs&&Fs.v8;Ns?Ls=(Ss=Ns.split("."))[0]+Ss[1]:Cs&&(!(Ss=Cs.match(/Edge\/(\d+)/))||Ss[1]>=74)&&(Ss=Cs.match(/Chrome\/(\d+)/))&&(Ls=Ss[1]);var Ds=Ls&&+Ls,Vs=Xt("species"),Us=function(e){return Ds>=51||!i((function(){var t=[];return(t.constructor={})[Vs]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},Bs=Xt("isConcatSpreadable"),Gs=Ds>=51||!i((function(){var e=[];return e[Bs]=!1,e.concat()[0]!==e})),zs=Us("concat"),js=function(e){if(!o(e))return!1;var t=e[Bs];return void 0!==t?!!t:Dt(e)};Re({target:"Array",proto:!0,forced:!Gs||!zs},{concat:function(e){var t,r,n,i,a,o=Vt(this),s=rr(o,0),u=0;for(t=-1,n=arguments.length;t<n;t++)if(a=-1===t?o:arguments[t],js(a)){if(u+(i=_e(a.length))>9007199254740991)throw TypeError("Maximum allowed index exceeded");for(r=0;r<i;r++,u++)r in a&&gs(s,u,a[r])}else{if(u>=9007199254740991)throw TypeError("Maximum allowed index exceeded");gs(s,u++,a)}return s.length=u,s}});var qs=function(){function e(){Ue(this,e)}return Ge(e,[{key:"enumSupportedParameters",value:function(){this._override_error("enumSupportedParameters")}},{key:"isBound",value:function(e){this._override_error("isBound")}},{key:"getBoundUpdater",value:function(e){this._override_error("getBoundUpdater")}},{key:"getBoundCurve",value:function(e){this._override_error("getBoundCurve")}},{key:"bind",value:function(e,t,r){this._override_error("bind")}},{key:"unbind",value:function(e){this._override_error("unbind")}},{key:"unbindAll",value:function(){this._override_error("unbindAll")}},{key:"unbindAllRecursively",value:function(){this._override_error("unbindAllRecursively")}},{key:"_override_error",value:function(e){throw new Error("BindingBlock#"+e+"() method has not been overridden in "+this.constructor.name)}}]),e}(),Ys=function(){function e(t,r){Ue(this,e),this._id=t,this._types=r.concat()}return Ge(e,[{key:"id",get:function(){return this._id}},{key:"types",get:function(){return this._types}}]),e}();qs.Parameter=Ys;var Xs=function(e){function t(){var e;return Ue(this,t),(e=Ze(this,je(t).call(this)))._entries=new Map,e._bounds=new Map,e._descendant_unbinders=[],e}return ze(t,e),Ge(t,[{key:"addEntry",value:function(e,t,r,n){this._entries.set(e,new Hs(t,r,n));var i=this._bounds.get(e);void 0!==i&&(i.unbind(),this._bounds.delete(e))}},{key:"addDescendantUnbinder",value:function(e){this._descendant_unbinders.push(e)}},{key:"enumSupportedParameters",value:function(){var e=[],t=!0,r=!1,n=void 0;try{for(var i,a=this._entries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=Qe(i.value,2),s=o[0],u=o[1];e.push(new qs.Parameter(s,u.types))}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return e}},{key:"isBound",value:function(e){return this._bounds.has(e)}},{key:"getBoundUpdater",value:function(e){var t=this._bounds.get(e);return void 0!==t?t.updater:null}},{key:"getBoundCurve",value:function(e){var t=this._bounds.get(e);return void 0!==t?t.curve:null}},{key:"bind",value:function(e,t,r){var n=this._entries.get(e);if(void 0===n)throw new Je("unsupported parameter");this.unbind(e);var i=n.types,a=1==i.length?i[0]:n.type_solver(r);if(null==a||!r.isTypeSupported(a))throw new Ps("type mismatch error");this._bounds.set(e,new Rs(t,r,a,n.setter))}},{key:"unbind",value:function(e){var t=this._bounds.get(e);void 0!==t&&t.unbind()}},{key:"unbindAll",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._bounds[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){Qe(n.value,2)[1].unbind()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"unbindAllRecursively",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._descendant_unbinders[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){(0,n.value)()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}this.unbindAll()}}]),t}(qs),Hs=function e(t,r,n){if(Ue(this,e),t.length<1||t.length>=2&&!r)throw new Je("bad parameter entry");this.types=t.concat(),this.type_solver=r,this.setter=n},Ws=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this)))._constant_type=e,n._constant_value=e.getDefaultValue(),void 0!==r&&n.setConstantValue(r),n}return ze(t,e),Ge(t,[{key:"setConstantValue",value:function(e){e!=this._constant_value&&(this._constant_value=this._constant_type.getCloneValue(e),this.notifyValueChange(Ct.UNIVERSAL))}},{key:"isTypeSupported",value:function(e){var t=this._constant_type;return e.isConvertible(t)}},{key:"getValue",value:function(e,t){var r=this._constant_type,n=r.getCloneValue(this._constant_value);return t.convertValue(r,n)}},{key:"getInvariance",value:function(e){return(new Wn).write(Ct.UNIVERSAL)}}]),t}(ms),Zs=function(){function e(){Ue(this,e)}return Ge(e,null,[{key:"getDimension",value:function(e){return Ei.find("number")===e?1:Ei.find("vector2")===e?2:Ei.find("vector3")===e?3:Ei.find("vector4")===e?4:0}},{key:"findKeyFrameIndex",value:function(e,t,r,n){for(var i=r,a=n;;){if(!(a-i>=2)){var o=t[i];return e.lessThan(o)?i:a}var s=Math.floor((i+a)/2),u=t[s];if(u.lessThan(e))i=s;else{if(!e.lessThan(u))return s+1;a=s}}return 0}},{key:"findFirstTypeSupported",value:function(e,t){var r=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;if(e.isTypeSupported(s))return s}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return null}}]),e}(),Qs=function(e){function t(e,r){var n;Ue(this,t),n=Ze(this,je(t).call(this));var i=Zs.getDimension(e);if(0==i)throw Je("unsupported type");if(n._value_type=e,n._dimension=i,n._num_keyframes=void 0,n._key_times=void 0,n._key_values=void 0,void 0!==r)n.setKeyFrames(r);else{var a=Mt.fromNumber(0),o=Mt.fromNumber(1),s=e.getDefaultValue();n.setKeyFrames([a,s,o,s])}return n}return ze(t,e),Ge(t,[{key:"setKeyFrames",value:function(e){var t=this._dimension;this._num_keyframes=e.length/2,this._key_times=new Array(this._num_keyframes),this._key_values=new Float64Array(this._num_keyframes*t);for(var r=0,n=0;r<this._num_keyframes;++r,n+=t){var i=e[2*r],a=e[2*r+1];if(this._key_times[r]=i,1==t)this._key_values[n]=a;else for(var o=0;o<t;++o)this._key_values[n+o]=a[o]}this.notifyValueChange(Ct.UNIVERSAL)}},{key:"isTypeSupported",value:function(e){var t=this._value_type;return e.isConvertible(t)}},{key:"getValue",value:function(e,t){var r=this._value_type,n=this._getInterpolatedValue(e);return t.convertValue(r,n)}},{key:"getInvariance",value:function(e){var t=this._key_times[0],r=this._key_times[this._num_keyframes-1],n=new Ct(t,r,!0,!0),i=new Wn;return i.write(n.getPrecedings()),i.write(n.getFollowings()),i.getNarrowed(e)}},{key:"_getInterpolatedValue",value:function(e){var t=Zs.findKeyFrameIndex(e,this._key_times,0,this._num_keyframes);return 0==t?this._createKeyFrameValue(0):t==this._num_keyframes?this._createKeyFrameValue(t-1):this._createValueBy2Keys(t-1,t,e)}},{key:"_createKeyFrameValue",value:function(e){var t=this._dimension,r=this._key_values;if(1==t)return r[e];for(var n=t*e,i=new Float64Array(t),a=0;a<t;++a)i[a]=r[n+a];return i}},{key:"_createValueBy2Keys",value:function(e,t,r){var n=this._key_times[e].toNumber(),i=this._key_times[t].toNumber(),a=(r.toNumber()-n)/(i-n),o=1-a,s=this._dimension,u=this._key_values;if(1==s)return o*u[e]+a*u[t];for(var l=s*e,_=s*t,c=new Float64Array(s),h=0;h<s;++h)c[h]=o*u[l+h]+a*u[_+h];return c}}]),t}(ms),Ks=function(e){function t(e,r){var n;if(Ue(this,t),(n=Ze(this,je(t).call(this)))._value_type=e,n._num_keyframes=void 0,n._key_times=void 0,n._key_values=void 0,void 0!==r)n.setKeyFrames(r);else{var i=Mt.fromNumber(0),a=e.getDefaultValue();n.setKeyFrames([i,a])}return n}return ze(t,e),Ge(t,[{key:"setKeyFrames",value:function(e){this._num_keyframes=e.length/2,this._key_times=new Array(this._num_keyframes),this._key_values=new Array(this._num_keyframes);for(var t=0;t<this._num_keyframes;++t){var r=e[2*t],n=e[2*t+1];this._key_times[t]=r,this._key_values[t]=this._value_type.getCloneValue(n)}this.notifyValueChange(Ct.UNIVERSAL)}},{key:"isTypeSupported",value:function(e){var t=this._value_type;return e.isConvertible(t)}},{key:"getValue",value:function(e,t){var r=this._value_type,n=this._getInterpolatedValue(e);return t.convertValue(r,n)}},{key:"getInvariance",value:function(e){if(1==this._num_keyframes)return(new Wn).write(Ct.UNIVERSAL);var t=new Wn,r=this._key_times[1];t.write(new Ct(r,r).getPrecedings());var n=this._key_times[this._num_keyframes-2],i=this._key_times[this._num_keyframes-1];return t.write(new Ct(n,i,!1,!0).getFollowings()),t.getNarrowed(e)}},{key:"_getInterpolatedValue",value:function(e){var t=Zs.findKeyFrameIndex(e,this._key_times,0,this._num_keyframes),r=t>0?t-1:0;return this._value_type.getCloneValue(this._key_values[r])}}]),t}(ms),$s=ar.map,Js=Us("map"),eu=Zr("map");Re({target:"Array",proto:!0,forced:!Js||!eu},{map:function(e){return $s(this,e,arguments.length>1?arguments[1]:void 0)}});var tu=function(e){function t(e,r){var n;Ue(this,t),n=Ze(this,je(t).call(this));var i=Zs.getDimension(e);if(i<2&&i>4)throw new Ps("unexpected type");return n._vector_type=e,n._dimension=i,n._children=new Array(i),n._listeners=new Array(i),n._setupInitialChildren(),void 0!==r&&n.setChildren(r),n}return ze(t,e),Ge(t,[{key:"setChild",value:function(e,t){this._setChildCommon(e,t),this.notifyValueChange(Ct.UNIVERSAL)}},{key:"setChildren",value:function(e){for(var t=0;t<this._dimension;++t)this._setChildCommon(t,e[t]);this.notifyValueChange(Ct.UNIVERSAL)}},{key:"isTypeSupported",value:function(e){var t=this._vector_type;return e.isConvertible(t)}},{key:"getValue",value:function(e,t){var r=this._vector_type,n=this._getCompoundValue(e);return t.convertValue(r,n)}},{key:"getInvariance",value:function(e){var t=this._children.map((function(t){return t.getInvariance(e)}));return Wn.merge(t)}},{key:"_setupInitialChildren",value:function(){for(var e=this,t=new Ws(ru),r=0;r<this._dimension;++r){var n=function(t){e.notifyValueChange(t)};t.addValueChangeListener(n),this._children[r]=t,this._listeners[r]=n}}},{key:"_setChildCommon",value:function(e,t){var r=this;if(!t.isTypeSupported(ru))throw new Ps("type mismatch error");var n=this._children[e],i=this._listeners[e];n.removeValueChangeListener(i);var a=function(e){r.notifyValueChange(e)};t.addValueChangeListener(a),this._children[e]=t,this._listeners[e]=a}},{key:"_getCompoundValue",value:function(e){for(var t=this._dimension,r=new Float64Array(t),n=0;n<t;++n)r[n]=this._children[n].getValue(e,ru);return r}}]),t}(ms),ru=Ei.find("number"),nu={AnimationError:Je,Time:Mt,Interval:Ct,Invariance:Wn,Type:Ei,Curve:ms,Updater:ws,Binder:Rs,TypeMismatchError:Ps,BindingBlock:qs,EasyBindingBlock:Xs,ConstantCurve:Ws,KFLinearCurve:Qs,KFStepCurve:Ks,ComboVectorCurve:tu},iu=function e(t,r){Ue(this,e),this.position=t||us.createVector3(),this.direction=r||us.createVector3([0,0,-1])},au=function(){function e(t){Ue(this,e),this._canvas=t,this.fov=46,this.near=1,this.far=1e3,this.view_to_gocs=us.createMatrix(),us.setIdentity(this.view_to_gocs)}return Ge(e,[{key:"getCanvasToView",value:function(e){var t=e||us.createMatrix(),r=this._canvas.width,n=this._canvas.height,i=this.near,a=this.far,o=this.fov*us.DEGREE/2,s=n/r,u=i*Math.tan(o)/Math.sqrt(1+s*s),l=u*s;return t[0]=2*u/(i*r),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l/(i*n),t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=0,t[11]=(i-a)/(i*a),t[12]=-u/i,t[13]=l/i,t[14]=-1,t[15]=1/i,t}},{key:"getCanvasToGocs",value:function(e){var t=this.getCanvasToView(e),r=t[0],n=t[5],i=t[11],a=t[12],o=t[13],s=t[15],u=this.view_to_gocs,l=u[0],_=u[1],c=u[2],h=u[4],f=u[5],v=u[6],d=u[8],y=u[9],p=u[10],m=u[12],g=u[13],k=u[14],E=t;return E[0]=l*r,E[1]=_*r,E[2]=c*r,E[4]=h*n,E[5]=f*n,E[6]=v*n,E[8]=m*i,E[9]=g*i,E[10]=k*i,E[12]=l*a+h*o-d+m*s,E[13]=_*a+f*o-y+g*s,E[14]=c*a+v*o-p+k*s,E}},{key:"getViewToCanvas",value:function(e){var t=e||us.createMatrix(),r=this._canvas.width,n=this._canvas.height,i=this.near,a=this.far,o=this.fov*us.DEGREE/2,s=n/r,u=i*Math.tan(o)/Math.sqrt(1+s*s),l=u*s;return t[0]=i*r/(2*u),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-i*n/(2*l),t[6]=0,t[7]=0,t[8]=-r/2,t[9]=-n/2,t[10]=a/(i-a),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*a/(i-a),t[15]=0,t}},{key:"getCanvasRay",value:function(t,r){var n=t[0],i=t[1],a=r||new iu,o=this.getCanvasToGocs(e._temp_mat),s=n*o[0]+i*o[4]+o[12],u=n*o[1]+i*o[5]+o[13],l=n*o[2]+i*o[6]+o[14],_=n*o[3]+i*o[7]+o[15],c=a.position;c[0]=s/_,c[1]=u/_,c[2]=l/_;var h=this.view_to_gocs,f=a.direction;return f[0]=c[0]-h[12],f[1]=c[1]-h[13],f[2]=c[2]-h[14],us.normalize3(f,f),a}},{key:"createRenderInfo",value:function(){var e=this._canvas;return new ou(this,e.width,e.height)}}]),e}();au._temp_mat=us.createMatrix();var ou=function(){function e(t,r,n){Ue(this,e),this._view_to_clip=us.createMatrix(),this._volume_planes=[];for(var i=0;i<6;++i)this._volume_planes.push(us.createVector4());this._pixel_step=0,this._setup_view_to_clip(t,r,n),this._setup_volume_planes(),this._setup_pixel_step(r,n)}return Ge(e,[{key:"_setup_view_to_clip",value:function(e,t,r){var n=e.fov*us.DEGREE/2,i=r/t,a=e.near*Math.tan(n)/Math.sqrt(1+i*i),o=-a,s=a,u=-a*i,l=a*i;us.frustum_matrix(o,s,u,l,e.near,e.far,this._view_to_clip)}},{key:"_setup_volume_planes",value:function(){var e=this._view_to_clip,t=this._volume_planes;this._add_matrix_rows(e,3,2,t[0]),this._sub_matrix_rows(e,3,2,t[1]),this._add_matrix_rows(e,3,0,t[2]),this._sub_matrix_rows(e,3,0,t[3]),this._add_matrix_rows(e,3,1,t[4]),this._sub_matrix_rows(e,3,1,t[5]);for(var r=0;r<6;++r){var n=t[r],i=n[0],a=n[1],o=n[2],s=1/Math.sqrt(i*i+a*a+o*o);n[0]*=s,n[1]*=s,n[2]*=s,n[3]*=s}}},{key:"_setup_pixel_step",value:function(e,t){var r=this._view_to_clip,n=r[0],i=r[5],a=r[11],o=2*(r[15]-a),s=o/(n*e),u=o/(i*t);this._pixel_step=Math.sqrt(s*s+u*u)*Math.SQRT1_2}},{key:"_add_matrix_rows",value:function(e,t,r,n){return n[0]=e[t]+e[r],n[1]=e[t+4]+e[r+4],n[2]=e[t+8]+e[r+8],n[3]=e[t+12]+e[r+12],n}},{key:"_sub_matrix_rows",value:function(e,t,r,n){return n[0]=e[t]-e[r],n[1]=e[t+4]-e[r+4],n[2]=e[t+8]-e[r+8],n[3]=e[t+12]-e[r+12],n}},{key:"view_to_clip",get:function(){return this._view_to_clip}},{key:"volume_planes",get:function(){return this._volume_planes}},{key:"pixel_step",get:function(){return this._pixel_step}}]),e}(),su=function(){function e(t){Ue(this,e);var r=this._getContextWebGL(t,{depth:!0,antialias:!0});if(!r)throw new Error("It doesn't appear your computer can support WebGL.");this._canvas=t,this._context=r,this._setupExtensions(r)}return Ge(e,[{key:"_getContextWebGL",value:function(e,t){for(var r=["webgl","experimental-webgl"],n=0;n<r.length;++n){var i=e.getContext(r[n],t);if(i)return i}return null}},{key:"_setupExtensions",value:function(e){this.OES_element_index_uint=e.getExtension("OES_element_index_uint"),this.EXT_texture_filter_anisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")}},{key:"canvas",get:function(){return this._canvas}},{key:"context",get:function(){return this._context}}]),e}(),uu=ar.forEach,lu=Eo("forEach"),_u=Zr("forEach"),cu=lu&&_u?[].forEach:function(e){return uu(this,e,arguments.length>1?arguments[1]:void 0)};Re({target:"Array",proto:!0,forced:[].forEach!=cu},{forEach:cu});var hu=Us("slice"),fu=Zr("slice",{ACCESSORS:!0,0:0,1:2}),vu=Xt("species"),du=[].slice,yu=Math.max;Re({target:"Array",proto:!0,forced:!hu||!fu},{slice:function(e,t){var r,n,i,a=ee(this),s=_e(a.length),u=fe(e,s),l=fe(void 0===t?s:t,s);if(Dt(a)&&("function"!=typeof(r=a.constructor)||r!==Array&&!Dt(r.prototype)?o(r)&&null===(r=r[vu])&&(r=void 0):r=void 0,r===Array||void 0===r))return du.call(a,u,l);for(n=new(void 0===r?Array:r)(yu(l-u,0)),i=0;u<l;u++,i++)u in a&&gs(n,i,a[u]);return n.length=i,n}});var pu=[],mu=pu.sort,gu=i((function(){pu.sort(void 0)})),ku=i((function(){pu.sort(null)})),Eu=Eo("sort");Re({target:"Array",proto:!0,forced:gu||!ku||!Eu},{sort:function(e){return void 0===e?mu.call(Vt(this)):mu.call(Vt(this),Jt(e))}});var wu=Us("splice"),bu=Zr("splice",{ACCESSORS:!0,0:0,1:2}),xu=Math.max,Au=Math.min;Re({target:"Array",proto:!0,forced:!wu||!bu},{splice:function(e,t){var r,n,i,a,o,s,u=Vt(this),l=_e(u.length),_=fe(e,l),c=arguments.length;if(0===c?r=n=0:1===c?(r=0,n=l-_):(r=c-2,n=Au(xu(ue(t),0),l-_)),l+r-n>9007199254740991)throw TypeError("Maximum allowed length exceeded");for(i=rr(u,n),a=0;a<n;a++)(o=_+a)in u&&gs(i,a,u[o]);if(i.length=n,r<n){for(a=_;a<l-n;a++)s=a+r,(o=a+n)in u?u[s]=u[o]:delete u[s];for(a=l;a>l-n+r;a--)delete u[a-1]}else if(r>n)for(a=l-n;a>_;a--)s=a+r-1,(o=a+n-1)in u?u[s]=u[o]:delete u[s];for(a=0;a<r;a++)u[a+_]=arguments[a+2];return u.length=l-n+r,i}});var Tu=Math.expm1,Iu=Math.exp,Mu=!Tu||Tu(10)>22025.465794806718||Tu(10)<22025.465794806718||-2e-17!=Tu(-2e-17)?function(e){return 0==(e=+e)?e:e>-1e-6&&e<1e-6?e+e*e/2:Iu(e)-1}:Tu,Su=Math.cosh,Lu=Math.abs,Pu=Math.E;Re({target:"Math",stat:!0,forced:!Su||Su(710)===1/0},{cosh:function(e){var t=Mu(Lu(e)-1)+1;return(t+1/(t*Pu*Pu))*(Pu/2)}});var Ru=function(){var e=c(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t};function Cu(e,t){return RegExp(e,t)}var Ou={UNSUPPORTED_Y:i((function(){var e=Cu("a","y");return e.lastIndex=2,null!=e.exec("abcd")})),BROKEN_CARET:i((function(){var e=Cu("^r","gy");return e.lastIndex=2,null!=e.exec("str")}))},Fu=RegExp.prototype.exec,Nu=String.prototype.replace,Du=Fu,Vu=function(){var e=/a/,t=/b*/g;return Fu.call(e,"a"),Fu.call(t,"a"),0!==e.lastIndex||0!==t.lastIndex}(),Uu=Ou.UNSUPPORTED_Y||Ou.BROKEN_CARET,Bu=void 0!==/()??/.exec("")[1];(Vu||Bu||Uu)&&(Du=function(e){var t,r,n,i,a=this,o=Uu&&a.sticky,s=Ru.call(a),u=a.source,l=0,_=e;return o&&(-1===(s=s.replace("y","")).indexOf("g")&&(s+="g"),_=String(e).slice(a.lastIndex),a.lastIndex>0&&(!a.multiline||a.multiline&&"\n"!==e[a.lastIndex-1])&&(u="(?: "+u+")",_=" "+_,l++),r=new RegExp("^(?:"+u+")",s)),Bu&&(r=new RegExp("^"+u+"$(?!\\s)",s)),Vu&&(t=a.lastIndex),n=Fu.call(o?r:a,_),o?n?(n.input=n.input.slice(l),n[0]=n[0].slice(l),n.index=a.lastIndex,a.lastIndex+=n[0].length):a.lastIndex=0:Vu&&n&&(a.lastIndex=a.global?n.index+n[0].length:t),Bu&&n&&n.length>1&&Nu.call(n[0],r,(function(){for(i=1;i<arguments.length-2;i++)void 0===arguments[i]&&(n[i]=void 0)})),n});var Gu=Du;Re({target:"RegExp",proto:!0,forced:/./.exec!==Gu},{exec:Gu});var zu=Xt("species"),ju=!i((function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")})),qu="$0"==="a".replace(/./,"$0"),Yu=Xt("replace"),Xu=!!/./[Yu]&&""===/./[Yu]("a","$0"),Hu=!i((function(){var e=/(?:)/,t=e.exec;e.exec=function(){return t.apply(this,arguments)};var r="ab".split(e);return 2!==r.length||"a"!==r[0]||"b"!==r[1]})),Wu=Cn.charAt,Zu=function(e,t,r){return t+(r?Wu(e,t).length:1)},Qu=function(e,t){var r=e.exec;if("function"==typeof r){var n=r.call(e,t);if("object"!=typeof n)throw TypeError("RegExp exec method returned something other than an Object or null");return n}if("RegExp"!==Q(e))throw TypeError("RegExp#exec called on incompatible receiver");return Gu.call(e,t)};for(var Ku in function(e,t,r,n){var a=Xt(e),o=!i((function(){var t={};return t[a]=function(){return 7},7!=""[e](t)})),s=o&&!i((function(){var t=!1,r=/a/;return"split"===e&&((r={}).constructor={},r.constructor[zu]=function(){return r},r.flags="",r[a]=/./[a]),r.exec=function(){return t=!0,null},r[a](""),!t}));if(!o||!s||"replace"===e&&(!ju||!qu||Xu)||"split"===e&&!Hu){var u=/./[a],l=r(a,""[e],(function(e,t,r,n,i){return t.exec===Gu?o&&!i?{done:!0,value:u.call(t,r,n)}:{done:!0,value:e.call(r,t,n)}:{done:!1}}),{REPLACE_KEEPS_$0:qu,REGEXP_REPLACE_SUBSTITUTES_UNDEFINED_CAPTURE:Xu}),_=l[0],c=l[1];z(String.prototype,e,_),z(RegExp.prototype,a,2==t?function(e,t){return c.call(e,this,t)}:function(e){return c.call(e,this)})}n&&y(RegExp.prototype[a],"sham",!0)}("match",1,(function(e,t,r){return[function(t){var r=J(this),n=null==t?void 0:t[e];return void 0!==n?n.call(t,r):new RegExp(t)[e](String(r))},function(e){var n=r(t,e,this);if(n.done)return n.value;var i=c(e),a=String(this);if(!i.global)return Qu(i,a);var o=i.unicode;i.lastIndex=0;for(var s,u=[],l=0;null!==(s=Qu(i,a));){var _=String(s[0]);u[l]=_,""===_&&(i.lastIndex=Zu(a,_e(i.lastIndex),o)),l++}return 0===l?null:u}]})),Vn){var $u=n[Ku],Ju=$u&&$u.prototype;if(Ju&&Ju.forEach!==cu)try{y(Ju,"forEach",cu)}catch(e){Ju.forEach=cu}}Re({global:!0,forced:!Mi},{DataView:ca.DataView});var el=function(){function e(t,r,n){Ue(this,e);var i=Math.pow(2,t.z-1),a=1<<r;this._sx=i/Math.PI*a,this._sy=-this._sx,this._ox=(i-t.x)*a,this._oy=(i-t.y)*a,this._body=n,this._pitch=4*(a+1),this._max=a}return Ge(e,[{key:"sample",value:function(e,t){return 0}}]),e}(),tl=function(e){function t(e,r,n){return Ue(this,t),Ze(this,je(t).call(this,e,r,n))}return ze(t,e),Ge(t,[{key:"sample",value:function(e,t){var r=this._sx*e+this._ox,n=Math.floor(r),i=n+1,a=this._sy*t+this._oy,o=Math.floor(a),s=o+1,u=r-n,l=a-o;return(this._sampleInt(n,o)*(1-u)+this._sampleInt(i,o)*u)*(1-l)+(this._sampleInt(n,s)*(1-u)+this._sampleInt(i,s)*u)*l}},{key:"_sampleInt",value:function(e,t){var r=us.clamp(e,0,this._max),n=us.clamp(t,0,this._max),i=this._pitch*n+4*r;return this._body.getFloat32(i,!0)}}]),t}(el),rl=function(e){function t(e,r,n){return Ue(this,t),Ze(this,je(t).call(this,e,r,n))}return ze(t,e),Ge(t,[{key:"sample",value:function(e,t){var r=Math.round(this._sx*e+this._ox),n=Math.round(this._sy*t+this._oy),i=this._pitch*n+4*r;return this._body.getFloat32(i,!0)}}]),t}(el),nl=function(){function e(t,r){if(Ue(this,e),this._ρ=t,this._maps=[],t>=1){var n=this._create_first_map(r);this._maps.push(n);for(var i=n,a=-2;a>=-t;--a){var o=this._create_next_map(a,i);this._maps.push(o),i=o}}}return Ge(e,[{key:"_create_first_map",value:function(e){for(var t=1<<this._ρ-1,r=new Float32Array(t*t),n=4*(2*t+1),i=t,a=0;a<t;++a)for(var o=2*a*n,s=a*i,u=0;u<t;++u){var l=e.getFloat32(o,!0),_=e.getFloat32(o+4,!0),c=e.getFloat32(o+8,!0),h=e.getFloat32(o+n,!0),f=e.getFloat32(o+n+4,!0),v=e.getFloat32(o+n+8,!0),d=e.getFloat32(o+2*n,!0),y=e.getFloat32(o+2*n+4,!0),p=e.getFloat32(o+2*(n+4),!0);r[s]=(l+2*_+c+2*h+4*f+2*v+d+2*y+p)/16,o+=8,s+=1}return r}},{key:"_create_next_map",value:function(e,t){for(var r=1<<this._ρ+e,n=new Float32Array(r*r),i=2*r,a=r,o=0;o<r;++o)for(var s=2*o*i,u=o*a,l=0;l<r;++l){var _=t[s],c=t[s+1],h=t[s+i],f=t[s+i+1];n[u]=(_+c+h+f)/4,s+=2,u+=1}return n}},{key:"sample",value:function(e,t,r){return this._maps[this._ρ-e-1][r*(1<<e)+t]}}]),e}(),il=function(){function e(t,r,n,i,a){Ue(this,e),this._z=t,this._x=r,this._y=n,this._ρ=i;var o=new DataView(a);this._qlevels=[o.getUint8(e.OFFSET_QLEVEL_00),o.getUint8(e.OFFSET_QLEVEL_10),o.getUint8(e.OFFSET_QLEVEL_01),o.getUint8(e.OFFSET_QLEVEL_11)],this._hmin=o.getFloat32(e.OFFSET_HMIN,!0),this._hmax=o.getFloat32(e.OFFSET_HMAX,!0),this._ω=this._createωArray(o),this._body=new DataView(a,e.HEADER_BYTES),this._size=1+(1<<i)}return Ge(e,[{key:"isLeaf",value:function(e,t,r){if(e>this._z)return 0==this.getQuadLevel(e,t,r);var n=this._qlevels;return 0==n[0]||0==n[1]||0==n[2]||0==n[3]}},{key:"getQuadLevel",value:function(e,t,r){var n=Math.pow(2,this._z-e),i=Math.floor(2*((t+.5)*n-this._x)),a=Math.floor(2*((r+.5)*n-this._y));return this._qlevels[2*a+i]}},{key:"getQuadLevelDirect",value:function(e,t){var r=Math.round(Math.pow(2,this._z+1)),n=us.clamp(Math.floor(e*r),0,r-1)%2,i=us.clamp(Math.floor(t*r),0,r-1)%2;return this._qlevels[2*i+n]}},{key:"getHeights",value:function(t,r){var n=4*(r*this._size+t),i=4*this._size,a=e._getHeights_result;return a[0]=this._body.getFloat32(n,!0),a[1]=this._body.getFloat32(n+4,!0),a[2]=this._body.getFloat32(n+i,!0),a[3]=this._body.getFloat32(n+i+4,!0),a}},{key:"getDivisionPowers",value:function(t,r,n,i){var a=t.z,o=this._z,s=us.LOG2PI-this._ρ+1,u=this._getComplexity(a,t.x,t.y),l=Math.min(o+this._ρ,Math.round(r+s+u))-a,_=e._getDivisionPowers_result;return _[0]=Math.max(n,l),_[1]=Math.max(i,l),_}},{key:"newSampler",value:function(e){return new(e.z-this._z>this._ρ?tl:rl)(this,this._ρ,this._body)}},{key:"newLinearSampler",value:function(){return new tl(this,this._ρ,this._body)}},{key:"newAvgHeightMaps",value:function(){return new nl(this._ρ,this._body)}},{key:"_createωArray",value:function(t){for(var r=[],n=0,i=0;i<3;++i){for(var a=1<<2*i,o=new Float32Array(a),s=0;s<a;++s)o[s]=t.getFloat32(e.OFFSET_ω+n,!0),n+=4;r.push(o)}return r}},{key:"_getComplexity",value:function(t,r,n){var i,a,o=t-this._z,s=Math.round(Math.pow(2,o));o<=2?(i=r-s*this._x,a=n-s*this._y):(i=Math.floor(4*((r+.5)/s-this._x)),a=Math.floor(4*((n+.5)/s-this._y)));var u=Math.min(o,2),l=this._ω[u];return Math.min(l[a*(1<<u)+i],e.ω_limit)}},{key:"z",get:function(){return this._z}},{key:"x",get:function(){return this._x}},{key:"y",get:function(){return this._y}},{key:"height_min",get:function(){return this._hmin}},{key:"height_max",get:function(){return this._hmax}}]),e}();il.OFFSET_QLEVEL_00=0,il.OFFSET_QLEVEL_10=1,il.OFFSET_QLEVEL_01=2,il.OFFSET_QLEVEL_11=3,il.OFFSET_HMIN=4,il.OFFSET_HMAX=8,il.OFFSET_ω=12,il.HEADER_BYTES=96,il.ω_limit=6,il._getHeights_result=new Array(4),il._getDivisionPowers_result=new Array(2),za("Int16",(function(e){return function(t,r,n){return e(this,t,r,n)}})),za("Int32",(function(e){return function(t,r,n){return e(this,t,r,n)}}));var al=function(){function e(){Ue(this,e)}return Ge(e,null,[{key:"getCenter",value:function(e,t){switch(e.z){case 0:return function(e){return e[0]=0,e[1]=0,e[2]=0,e}(t);case 1:return function(e,t,r){var n=us.EARTH_RADIUS;return r[0]=0,r[1]=n*(e-.5),r[2]=n*(.5-t),r}(e.x,e.y,t);default:return function(e,t,r,n){var i=Math.PI,a=Math.pow(2,1-e)*i,o=i-(r+1)*a,s=i-r*a,u=t*a-i,l=(t+1)*a-i,_=Math.exp(o),c=Math.exp(s),h=_*_,f=c*c,v=us.EARTH_RADIUS/2,d=2*_/(h+1),y=2*c/(f+1);o+s<0?u+l<-i?(n[0]=v*(y*Math.cos(u)+d*Math.cos(l)),n[1]=v*(y*Math.sin(l)+d*Math.sin(u))):u+l<0?(n[0]=v*(d*Math.cos(u)+y*Math.cos(l)),n[1]=v*(y*Math.sin(u)+d*Math.sin(l))):u+l<i?(n[0]=v*(d*Math.cos(l)+y*Math.cos(u)),n[1]=v*(d*Math.sin(u)+y*Math.sin(l))):(n[0]=v*(y*Math.cos(l)+d*Math.cos(u)),n[1]=v*(d*Math.sin(l)+y*Math.sin(u))):u+l<-i?(n[0]=v*(d*Math.cos(u)+y*Math.cos(l)),n[1]=v*(d*Math.sin(l)+y*Math.sin(u))):u+l<0?(n[0]=v*(y*Math.cos(u)+d*Math.cos(l)),n[1]=v*(d*Math.sin(u)+y*Math.sin(l))):u+l<i?(n[0]=v*(y*Math.cos(l)+d*Math.cos(u)),n[1]=v*(y*Math.sin(u)+d*Math.sin(l))):(n[0]=v*(d*Math.cos(l)+y*Math.cos(u)),n[1]=v*(y*Math.sin(l)+d*Math.sin(u)));return n[2]=2*v*(f/(f+1)-1/(h+1)),n}(e.z,e.x,e.y,t)}}}]),e}();var ol=function(){function e(t,r,n,i){Ue(this,e);var a=t.context;this._center=this._createCenter(r),this._vertices=null,this._num_vertices=0,this._vertex_attribs={},this._num_quads_x=0,this._num_quads_y=0,this._createVertices(a,r,n,i),this._setupVertexAttribs(a),this._index_type=this._num_vertices<65536?a.UNSIGNED_SHORT:a.UNSIGNED_INT,this._indices=null,this._num_indices=0,this._wire_indices=null,this._num_wire_indices=0,this._gl=a}return Ge(e,[{key:"_createCenter",value:function(e){return al.getCenter(e,us.createVector3())}},{key:"_createVertices",value:function(e,t,r,n){var i=e.ARRAY_BUFFER,a=e.createBuffer(),o=this._createVerticesData(t,r,n);e.bindBuffer(i,a),e.bufferData(i,o.array,e.STATIC_DRAW),e.bindBuffer(i,null),this._vertices=a,this._num_vertices=o.num_vertices,this._num_quads_x=o.num_quads_x,this._num_quads_y=o.num_quads_y}},{key:"_createVerticesData",value:function(t,r,n){for(var i=Math.pow(2,1-t.z)*Math.PI,a=t.x*i-Math.PI,o=Math.PI-(t.y+1)*i,s=1<<r[0],u=1<<r[1],l=1/s,_=1/u,c=i/s,h=i/u,f=this._center,v=n.newSampler(t),d=(s+1)*(u+1),y=new Float32Array(e.VERTEX_SIZE*d),p=0,m=0,g=o;m<u+1;++m,g+=h)for(var k=Math.exp(g),E=k*k,w=(E-1)/(E+1),b=2*k/(E+1),x=0,A=a;x<s+1;++x,A+=c){var T=Math.sin(A),I=Math.cos(A),M=v.sample(A,g),S=us.EARTH_RADIUS+M,L=b*I,P=b*T,R=w,C=S*L,O=S*P,F=S*R;y[p++]=C-f[0],y[p++]=O-f[1],y[p++]=F-f[2],y[p++]=L,y[p++]=P,y[p++]=R,y[p++]=x*l,y[p++]=m*_}return{array:y,num_vertices:d,num_quads_x:s,num_quads_y:u}}},{key:"_setupVertexAttribs",value:function(t){var r=t.FLOAT,n=e.VERTEX_BYTES;this._vertex_attribs={a_position:{buffer:this._vertices,num_components:3,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_P},a_normal:{buffer:this._vertices,num_components:3,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_N},a_uv:{buffer:this._vertices,num_components:2,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_UV}}}},{key:"_createIndices",value:function(){for(var e=this._gl,t=6*(this._num_quads_x*this._num_quads_y),r=new(this._index_type===e.UNSIGNED_INT?Int32Array:Int16Array)(t),n=0,i=0;i<this._num_quads_y;++i)for(var a=0;a<this._num_quads_x;++a){var o=(this._num_quads_x+1)*i+a,s=o+1,u=o+this._num_quads_x+1,l=u+1;r[n++]=o,r[n++]=s,r[n++]=u,r[n++]=u,r[n++]=s,r[n++]=l}var _=e.ELEMENT_ARRAY_BUFFER,c=e.createBuffer();e.bindBuffer(_,c),e.bufferData(_,r,e.STATIC_DRAW),e.bindBuffer(_,null),this._indices=c,this._num_indices=t}},{key:"_createWireIndices",value:function(){for(var e=this._gl,t=this._index_type===e.UNSIGNED_INT?Int32Array:Int16Array,r=2*(2*this._num_quads_x*this._num_quads_y+this._num_quads_x+this._num_quads_y),n=new t(r),i=0,a=0;a<this._num_quads_y+1;++a)for(var o=0;o<this._num_quads_x;++o){var s=(this._num_quads_x+1)*a+o,u=s+1;n[i++]=s,n[i++]=u}for(o=0;o<this._num_quads_x+1;++o)for(a=0;a<this._num_quads_y;++a){var l=(this._num_quads_x+1)*a+o,_=l+this._num_quads_x+1;n[i++]=l,n[i++]=_}var c=e.ELEMENT_ARRAY_BUFFER,h=e.createBuffer();e.bindBuffer(c,h),e.bufferData(c,n,e.STATIC_DRAW),e.bindBuffer(c,null),this._wire_indices=h,this._num_wire_indices=r}},{key:"dispose",value:function(){var e=this._gl;this._vertex_attribs={},e.deleteBuffer(this._vertices),this._vertices=null,this._indices&&(e.deleteBuffer(this._indices),this._indices=null),this._wire_indices&&(e.deleteBuffer(this._wire_indices),this._wire_indices=null)}},{key:"mul_flake_to_gocs",value:function(e,t){var r=e[0],n=e[4],i=e[8],a=e[12],o=e[1],s=e[5],u=e[9],l=e[13],_=e[2],c=e[6],h=e[10],f=e[14],v=e[3],d=e[7],y=e[11],p=e[15],m=this._center[0],g=this._center[1],k=this._center[2];return t[0]=r,t[1]=o,t[2]=_,t[3]=v,t[4]=n,t[5]=s,t[6]=c,t[7]=d,t[8]=i,t[9]=u,t[10]=h,t[11]=y,t[12]=r*m+n*g+i*k+a,t[13]=o*m+s*g+u*k+l,t[14]=_*m+c*g+h*k+f,t[15]=v*m+d*g+y*k+p,t}},{key:"draw",value:function(e){var t=this._gl,r=e.isWireframe();e.bindVertexAttribs(this._vertex_attribs);var n=r?this.wire_indices:this.indices;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n);var i=r?t.LINES:t.TRIANGLES,a=r?this.num_wire_indices:this.num_indices;t.drawElements(i,a,this._index_type,0)}},{key:"num_vertices",get:function(){return this._num_vertices}},{key:"indices",get:function(){return null===this._indices&&this._createIndices(),this._indices}},{key:"num_indices",get:function(){return null===this._indices&&this._createIndices(),this._num_indices}},{key:"wire_indices",get:function(){return null===this._wire_indices&&this._createWireIndices(),this._wire_indices}},{key:"num_wire_indices",get:function(){return null===this._wire_indices&&this._createWireIndices(),this._num_wire_indices}}]),e}();ol.VERTEX_SIZE=8,ol.VERTEX_BYTES=4*ol.VERTEX_SIZE,ol.OFFSET_P=0,ol.OFFSET_N=12,ol.OFFSET_UV=24;var sl=function(){function e(t,r,n,i){Ue(this,e),this._glenv=t,this.mesh=r,this.material=n,this.transform=i,this.pivot=null,this.bbox=null,this.properties=null,this.sort_z=void 0}return Ge(e,[{key:"fastClone",value:function(){var t=new e(this._glenv,this.mesh,this.material,us.createMatrix(this.transform));return this.pivot&&(t.pivot=us.createVector3(this.pivot)),this.bbox&&(t.bbox=this.bbox.map((function(e){return us.createVector3(e)}))),t.properties=this.properties,t}},{key:"isVisible",value:function(t){var r=e._obj_to_view;us.mul_AA(t._gocs_to_view,this.transform,r);var n=this.bbox;if(n){e._transformBBox(n,r);for(var i=t._volume_planes,a=0;a<i.length;++a)if(e._isBBoxBackSide(i[a]))return!1}var o=this.pivot;return this.sort_z=o?r[2]*o[0]+r[6]*o[1]+r[10]*o[2]+r[14]:r[14],!0}},{key:"isTranslucent",value:function(e){return this.material.isTranslucent(e,this)}},{key:"draw",value:function(e){var t=this.material;t.bindProgram(),t.setParameters(e,this),this.mesh.draw(t)}}],[{key:"_transformBBox",value:function(t,r){for(var n=0;n<2;++n)for(var i=t[n][2],a=0;a<2;++a)for(var o=t[a][1],s=0;s<2;++s){var u=t[s][0],l=e._bbox_points[s+2*a+4*n];l[0]=r[0]*u+r[4]*o+r[8]*i+r[12],l[1]=r[1]*u+r[5]*o+r[9]*i+r[13],l[2]=r[2]*u+r[6]*o+r[10]*i+r[14]}}},{key:"_isBBoxBackSide",value:function(t){for(var r=e._bbox_points,n=0;n<r.length;++n){var i=r[n];if(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+t[3]>=0)return!1}return!0}}]),e}();sl._obj_to_view=us.createMatrix(),sl._bbox_points=[];for(var ul=0;ul<8;++ul)sl._bbox_points.push(us.createVector3());var ll=function(){function e(t,r,n){Ue(this,e),this.z=t.z,this.x=t.x,this.y=t.y,this._glenv=r,this._base_mesh=n,this._edata_list=[],this._transform=null}return Ge(e,[{key:"addEntityData",value:function(e,t){var r={mesh:e,producer:t};this._edata_list.push(r)}},{key:"getBaseMesh",value:function(){return this._base_mesh}},{key:"getEntityPrimitive",value:function(e,t){var r=this._edata_list[e],n=r.producer.getMaterialAndProperties(t),i=n.material,a=n.properties;if(null===this._transform){this._transform=us.setIdentity(us.createMatrix());var o=al.getCenter(this,us.createVector3());this._transform[12]=o[0],this._transform[13]=o[1],this._transform[14]=o[2]}var s=new sl(this._glenv,r.mesh,i,this._transform);return s.properties=a,s}},{key:"num_entities",get:function(){return this._edata_list.length}}]),e}();Re({target:"Array",proto:!0},{fill:Di}),Yr("fill"),za("Uint8",(function(e){return function(t,r,n){return e(this,t,r,n)}}));var _l=function(){function e(){Ue(this,e),this._area_list=[],this._flat_area_list=null}return Ge(e,[{key:"isEmpty",value:function(){return 0==this._area_list.length}},{key:"clear",value:function(){this._area_list.length=0,this._flat_area_list=null}},{key:"addTileArea",value:function(e){this._area_list.push({z:e.z,x:e.x,y:e.y}),this._flat_area_list=null}},{key:"getFlatAreaList",value:function(){return null===this._flat_area_list&&(this._flat_area_list=this._createFlatAreaList()),this._flat_area_list}},{key:"_createFlatAreaList",value:function(){for(var e=new cl,t=0;t<this._area_list.length;++t){var r=this._area_list[t];e.addDescendant(r.z,r.x,r.y)}return e.reduceTree(),e.collectFlatAreas(0,new Uint8Array(64),[])}}]),e}(),cl=function(){function e(){Ue(this,e),this.present=!1,this.children=new Array(4).fill(null)}return Ge(e,[{key:"addDescendant",value:function(t,r,n){if(!0!==this.present)if(0==t)this.present=!0,this.children.fill(null);else{var i=Math.round(Math.pow(2,t-1)),a=Math.floor(r/i)+2*Math.floor(n/i);null===this.children[a]&&(this.children[a]=new e),this.children[a].addDescendant(t-1,r%i,n%i)}}},{key:"reduceTree",value:function(){if(!0===this.present)return 1;for(var e=0,t=0;t<4;++t){var r=this.children[t];null!==r&&(e+=r.reduceTree())}return 4==e?(this.present=!0,this.children.fill(null),1):0}},{key:"collectFlatAreas",value:function(e,t,r){if(!0===this.present)r.push(new Uint8Array(t.slice(0,e)));else for(var n=0;n<4;++n){var i=this.children[n];null!==i&&(t[e]=n,i.collectFlatAreas(e+1,t,r))}return r}}]),e}();Re({target:"Array",stat:!0},{isArray:Dt});var hl=ca.ArrayBuffer,fl=n.ArrayBuffer;Re({global:!0,forced:fl!==hl},{ArrayBuffer:hl}),di("ArrayBuffer"),za("Uint16",(function(e){return function(t,r,n){return e(this,t,r,n)}})),za("Uint32",(function(e){return function(t,r,n){return e(this,t,r,n)}}));var vl=function(){function e(t,r,n){Ue(this,e),this._glenv=t;var i=n||{},a=t.context,o=e._getBindingPoint(a,i.target),s=a.createBuffer();a.bindBuffer(o,s),a.bufferData(o,r,a.STATIC_DRAW),a.bindBuffer(o,null),this._handle=s}return Ge(e,[{key:"dispose",value:function(){this._glenv.context.deleteBuffer(this._handle),this._handle=null}},{key:"handle",get:function(){return this._handle}}],[{key:"_getBindingPoint",value:function(e,t){switch(t){default:case dl.ATTRIBUTE:return e.ARRAY_BUFFER;case dl.INDEX:return e.ELEMENT_ARRAY_BUFFER}}}]),e}(),dl={ATTRIBUTE:{id:"ATTRIBUTE"},INDEX:{id:"INDEX"}};vl.Target=dl;var yl=function(){function e(t,r){Ue(this,e),this._glenv=t,this._draw_mode=void 0,this._num_vertices=0,this._attrib_data={},this._index_data=null,r instanceof pl?this._initByInitializer(r):r instanceof ArrayBuffer?this._initByInitializer(new El(t,r).initializer):this._initByInitializer(new kl(t,r).initializer)}return Ge(e,[{key:"_initByInitializer",value:function(e){this._draw_mode=this._convertDrawMode(e.draw_mode),this._num_vertices=e.num_vertices;for(var t=e.attribute_data,r=0;r<t.length;++r){var n=t[r];this._attrib_data[n.id]={mesh_buffer:n.buffer,buffer:n.buffer.handle,num_components:n.num_components,component_type:this._convertComponentType(n.component_type),normalized:n.normalized,byte_stride:n.byte_stride,byte_offset:n.byte_offset}}if(e.index_data){var i=e.index_data;this._index_data={mesh_buffer:i.buffer,buffer:i.buffer.handle,num_indices:i.num_indices,type:this._convertComponentType(i.type),byte_offset:i.byte_offset}}}},{key:"_convertDrawMode",value:function(e){var t=this._glenv.context;switch(e){case ml.POINTS:return t.POINTS;case ml.LINES:return t.LINES;case ml.TRIANGLES:return t.TRIANGLES;case ml.LINE_LOOP:return t.LINE_LOOP;case ml.LINE_STRIP:return t.LINE_STRIP;case ml.TRIANGLE_STRIP:return t.TRIANGLE_STRIP;case ml.TRIANGLE_FAN:return t.TRIANGLE_FAN;default:throw new Error("mapray: invalid Mesh.DrawMode: "+e)}}},{key:"_convertComponentType",value:function(e){var t=this._glenv.context;switch(e){case gl.BYTE:return t.BYTE;case gl.UNSIGNED_BYTE:return t.UNSIGNED_BYTE;case gl.SHORT:return t.SHORT;case gl.UNSIGNED_SHORT:return t.UNSIGNED_SHORT;case gl.UNSIGNED_INT:return t.UNSIGNED_INT;case gl.FLOAT:return t.FLOAT;default:throw new Error("mapray: invalid Mesh.ComponentType: "+e)}}},{key:"dispose",value:function(){this._attrib_data={},this._index_data=null}},{key:"draw",value:function(e){var t=this._glenv.context;e.bindVertexAttribs(this._attrib_data);var r=this._index_data;null!==r?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r.buffer),t.drawElements(this._draw_mode,r.num_indices,r.type,r.byte_offset)):t.drawArrays(this._draw_mode,0,this._num_vertices)}}]),e}(),pl=function(){function e(t,r){Ue(this,e),this.draw_mode=t,this.num_vertices=r,this.index_data=null,this.attribute_data=[]}return Ge(e,[{key:"addIndex",value:function(e,t,r,n){var i=n||{};this.index_data={buffer:e,num_indices:t,type:r,byte_offset:void 0!==i.byte_offset?i.byte_offset:0}}},{key:"addAttribute",value:function(e,t,r,n,i){var a=i||{},o={id:e,buffer:t,num_components:r,component_type:n,normalized:void 0!==a.normalized&&a.normalized,byte_stride:void 0!==a.byte_stride?a.byte_stride:0,byte_offset:void 0!==a.byte_offset?a.byte_offset:0};this.attribute_data.push(o)}}]),e}(),ml={POINTS:{id:"POINTS"},LINES:{id:"LINES"},TRIANGLES:{id:"TRIANGLES"},LINE_LOOP:{id:"LINE_LOOP"},LINE_STRIP:{id:"LINE_STRIP"},TRIANGLE_STRIP:{id:"TRIANGLE_STRIP"},TRIANGLE_FAN:{id:"TRIANGLE_FAN"}},gl={BYTE:{id:"BYTE"},UNSIGNED_BYTE:{id:"UNSIGNED_BYTE"},SHORT:{id:"SHORT"},UNSIGNED_SHORT:{id:"UNSIGNED_SHORT"},UNSIGNED_INT:{id:"UNSIGNED_INT"},FLOAT:{id:"FLOAT"}},kl=function(){function e(t,r){Ue(this,e);var n=wl.createVertexInfo(r.vtype),i=wl.numVertexComponents(n),a=r.vertices.length/i;this._initializer=new pl(e._toDrawMode(r),a),this._addIndex(t,r.indices,a);for(var o=new vl(t,wl.toTypedArray(r.vertices,gl.FLOAT)),s=4*i,u=0,l=0;l<n.length;++l){var _=n[l].size;this._initializer.addAttribute(n[l].name,o,_,gl.FLOAT,{byte_stride:s,byte_offset:u}),u+=4*_}}return Ge(e,[{key:"_addIndex",value:function(e,t,r){var n=r<65536?gl.UNSIGNED_SHORT:gl.UNSIGNED_INT,i=new vl(e,wl.toTypedArray(t,n),{target:vl.Target.INDEX});this._initializer.addIndex(i,t.length,n)}},{key:"initializer",get:function(){return this._initializer}}],[{key:"_toDrawMode",value:function(e){switch(e.ptype){case"triangles":return ml.TRIANGLES;case"lines":return ml.LINES;default:return ml.TRIANGLES}}}]),e}(),El=function(){function e(t,r){Ue(this,e);var n=new DataView(r,0),i=n.getUint8(e.OFFSET_VTYPE),a=n.getUint8(e.OFFSET_ITYPE),o=n.getUint8(e.OFFSET_PTYPE),s=n.getUint32(e.OFFSET_NUM_VERTICES,!0),u=n.getUint32(e.OFFSET_NUM_INDICES,!0);this._initializer=new pl(e._toDrawMode(o),s);var l=wl.createVertexInfo(i),_=this._createIndexArray(t,r,a,u,l,s);this._addIndex(t,a,_);for(var c=new vl(t,this._createVertexArray(r,l,s)),h=4*wl.numVertexComponents(l),f=0,v=0;v<l.length;++v){var d=l[v].size;this._initializer.addAttribute(l[v].name,c,d,gl.FLOAT,{byte_stride:h,byte_offset:f}),f+=4*d}}return Ge(e,[{key:"_createIndexArray",value:function(t,r,n,i,a,o){var s,u,l,_=wl.numVertexComponents(a)*o*4,c=new DataView(r,e.OFFSET_BODY+_);switch(n){case e.ENUM_ITYPE_UINT16:for(u=new Uint16Array(i),l=2,s=0;s<i;++s)u[s]=c.getUint16(l*s,!0);break;case e.ENUM_ITYPE_UINT32:for(u=new Uint32Array(i),l=4,s=0;s<i;++s)u[s]=c.getUint32(l*s,!0);break;default:throw new Error("mapray: unknown itype: "+n)}return u}},{key:"_createVertexArray",value:function(t,r,n){for(var i=wl.numVertexComponents(r)*n,a=new DataView(t,e.OFFSET_BODY),o=new Float32Array(i),s=0;s<i;++s)o[s]=a.getFloat32(4*s,!0);return o}},{key:"_addIndex",value:function(t,r,n){var i=new vl(t,n,{target:vl.Target.INDEX}),a=e._indexTypeToComponentType(r);this._initializer.addIndex(i,n.length,a)}},{key:"initializer",get:function(){return this._initializer}}],[{key:"_toDrawMode",value:function(t){switch(t){case e.ENUM_PTYPE_TRIANGLES:return ml.TRIANGLES;case e.ENUM_PTYPE_LINES:return ml.LINES;default:throw new Error("mapray: invalid ptype: "+t)}}},{key:"_indexTypeToComponentType",value:function(t){switch(t){case e.ENUM_ITYPE_UINT16:return gl.UNSIGNED_SHORT;case e.ENUM_ITYPE_UINT32:default:return gl.UNSIGNED_INT}}}]),e}();El.OFFSET_VTYPE=0,El.OFFSET_ITYPE=1,El.OFFSET_PTYPE=2,El.OFFSET_NUM_VERTICES=4,El.OFFSET_NUM_INDICES=8,El.OFFSET_BODY=12,El.ENUM_ITYPE_UINT16=0,El.ENUM_ITYPE_UINT32=1,El.ENUM_PTYPE_TRIANGLES=0,El.ENUM_PTYPE_LINES=1;var wl=function(){function e(){Ue(this,e)}return Ge(e,null,[{key:"createVertexInfo",value:function(t){if(Array.isArray(t))return t;var r=null;switch(t){case"P":case e.ENUM_VTYPE_P:r=[{name:e.ANAME_P,size:e.FSIZE_P}];break;case"PN":case e.ENUM_VTYPE_PN:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_N,size:e.FSIZE_N}];break;case"PT":case e.ENUM_VTYPE_PT:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_T,size:e.FSIZE_T}];break;case"PNT":case e.ENUM_VTYPE_PNT:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_N,size:e.FSIZE_N},{name:e.ANAME_T,size:e.FSIZE_T}];break;default:throw new Error("mapray: unknown vtype: "+t)}return r}},{key:"numVertexComponents",value:function(e){for(var t=e.length,r=0,n=0;n<t;++n)r+=e[n].size;return r}},{key:"toTypedArray",value:function(e,t){switch(t){case gl.UNSIGNED_SHORT:return e instanceof Uint16Array?e:new Uint16Array(e);case gl.UNSIGNED_INT:return e instanceof Uint32Array?e:new Uint32Array(e);case gl.FLOAT:return e instanceof Float32Array?e:new Float32Array(e);default:throw new Error("mapray: invalid component type: "+t)}}}]),e}();wl.ENUM_VTYPE_P=0,wl.ENUM_VTYPE_PN=1,wl.ENUM_VTYPE_PT=2,wl.ENUM_VTYPE_PNT=3,wl.ANAME_P="a_position",wl.ANAME_N="a_normal",wl.ANAME_T="a_texcoord",wl.FSIZE_P=3,wl.FSIZE_N=3,wl.FSIZE_T=2,yl.Initializer=pl,yl.DrawMode=ml,yl.ComponentType=gl;var bl={ABSOLUTE:{id:"ABSOLUTE"},RELATIVE:{id:"RELATIVE"},CLAMP:{id:"CLAMP"}},xl=function(){function e(t,r){Ue(this,e),this.scene=t,this._altitude_mode=bl.ABSOLUTE,this._need_to_create_regions=!1,this._animation=new Xs,r&&r.json&&this._setupEntityByJson(r.json)}return Ge(e,[{key:"onChangeAltitudeMode",value:function(e){}},{key:"getPrimitiveProducer",value:function(){return null}},{key:"getFlakePrimitiveProducer",value:function(){return null}},{key:"_setupEntityByJson",value:function(e){if(e.altitude_mode)switch(e.altitude_mode){case"absolute":this._altitude_mode=bl.ABSOLUTE;break;case"relative":this._altitude_mode=bl.RELATIVE;break;case"clamp":this._altitude_mode=bl.CLAMP;break;default:console.error("unrecognized altitude_mode: "+e.altitude_mode)}}},{key:"animation",get:function(){return this._animation}},{key:"altitude_mode",set:function(e){if(this._altitude_mode!==e){var t=this._altitude_mode;this._altitude_mode=e,this.onChangeAltitudeMode(t)}},get:function(){return this._altitude_mode}}]),e}(),Al=function(){function e(t){Ue(this,e),this._entity=t,this._need_to_create_regions=!1}return Ge(e,[{key:"needToCreateRegions",value:function(){this._need_to_create_regions=!0}},{key:"checkToCreateRegions",value:function(){var e=this._need_to_create_regions;return this._need_to_create_regions=!1,e}},{key:"needsElevation",value:function(){return this._entity._altitude_mode!==bl.ABSOLUTE}},{key:"createRegions",value:function(){return[]}},{key:"onChangeElevation",value:function(e){}},{key:"getPrimitives",value:function(e){throw new Error("mapray.Entity.PrimitiveProducer#getPrimitives() method has not been overridden.")}},{key:"entity",get:function(){return this._entity}}]),e}(),Tl=function(){function e(t){Ue(this,e),this._entity=t,this._updated=!1}return Ge(e,[{key:"notifyForUpdate",value:function(){this._updated=!0}},{key:"getAreaStatus",value:function(e){return Il.EMPTY}},{key:"createMesh",value:function(e,t,r){return null}},{key:"getMaterialAndProperties",value:function(e){throw new Error("mapray.Entity.FlakePrimitiveProducer#getMaterialAndProperties() method has not been overridden.")}},{key:"checkForUpdate",value:function(){var e=this._updated;return this._updated=!1,e}},{key:"entity",get:function(){return this._entity}}]),e}(),Il={EMPTY:{id:"EMPTY"},FULL:{id:"FULL"},PARTIAL:{id:"PARTIAL"}};xl.PrimitiveProducer=Al,xl.FlakePrimitiveProducer=Tl,xl.AreaStatus=Il;var Ml=function(){function e(t,r){Ue(this,e),this._glenv=t,this._dem_provider=r,this._status=Sl.NOT_READY,this._dem_area_updated=new _l,this._prev_producers=new Set,this._ρ=r.getResolutionPower(),this._dem_zbias=us.LOG2PI-this._ρ+1,this._hist_stats=new Pl,this._flake_reduce_thresh=1.5,this._flake_reduce_factor=1.2,this._num_cache_flakes=0,this._num_touch_flakes=0,this._mesh_reduce_lower=300,this._mesh_reduce_thresh=1.5,this._mesh_reduce_factor=1.2,this._num_cache_meshes=0,this._num_touch_meshes=0,this._max_dem_requesteds=10,this._num_dem_requesteds=0,this._frame_counter=0,this._root_flake=null,this._avg_height=null,this._root_cancel_id=null,this._requestRoot()}return Ge(e,[{key:"cancel",value:function(){if(this._status===Sl.READY)for(var e=this._root_flake._children,t=0;t<4;++t)e[t].dispose();else this._status===Sl.NOT_READY&&(this._dem_provider.cancelRequest(this._root_cancel_id),this._root_cancel_id=null)}},{key:"putNextEntityProducers",value:function(e){var t=new Set,r=[],n=[],i=!0,a=!1,o=void 0;try{for(var s,u=e[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value,_=l.checkForUpdate();this._prev_producers.has(l)?(_&&n.push(l),this._prev_producers.delete(l)):r.push(l),t.add(l)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}var c=this._prev_producers,h=!0,f=!1,v=void 0;try{for(var d,y=c[Symbol.iterator]();!(h=(d=y.next()).done);h=!0){var p=d.value;this._root_flake.removeEntityProducer(p)}}catch(e){f=!0,v=e}finally{try{h||null==y.return||y.return()}finally{if(f)throw v}}for(var m=0,g=r;m<g.length;m++){var k=g[m];this._root_flake.addEntityProducer(k)}for(var E=0,w=n;E<w.length;E++){var b=w[E];this._root_flake.updateEntityProducer(b)}this._prev_producers=t}},{key:"getNumDemWaitingRequests",value:function(){return this._num_dem_requesteds}},{key:"findHighestAccuracy",value:function(e,t){var r=this._root_flake;if(null===r)return null;for(var n=2,i=n*e,a=n*t,o=r;;){var s=us.clamp(Math.floor(i),0,n-1)%2,u=us.clamp(Math.floor(a),0,n-1)%2,l=r._children[s+2*u];if(r.touch(),null===l)break;r._dem_state===Cl.LOADED&&(o=r),r=l,n*=2,i*=2,a*=2}return o._requestHighestAccuracy(e,t),o._dem_data}},{key:"getExistingElevations",value:function(e,t,r,n,i,a,o){for(var s=2*Math.PI,u=1<<this._ρ,l=r,_=a,c=0;c<e;++c){var h=t[l],f=t[l+1],v=h+180*Math.floor((90-f)/360+Math.floor((90+f)/360)),d=v-360-360*Math.floor((v-180)/360),y=90-Math.abs(90-f+360*Math.floor((90+f)/360)),p=d*us.DEGREE/s+.5,m=.5-us.invGudermannian(y*us.DEGREE)/s;if(m>=0&&m<=1){var g=this._findHighestAccuracy2(p,m);if(null!==g){var k=Math.pow(2,g.z),E=u*(k*p-g.x),w=u*(k*m-g.y),b=us.clamp(Math.floor(E),0,u-1),x=us.clamp(Math.floor(w),0,u-1),A=g.getHeights(b,x),T=A[0],I=A[1],M=A[2],S=A[3],L=E-b,P=w-x;i[_]=(T*(1-L)+I*L)*(1-P)+(M*(1-L)+S*L)*P}else i[_]=0}else i[_]=0;l+=n,_+=o}return i}},{key:"_findHighestAccuracy2",value:function(e,t){var r=this._root_flake;if(null===r)return null;for(var n=2,i=n*e,a=n*t,o=r;;){var s=us.clamp(Math.floor(i),0,n-1)%2,u=us.clamp(Math.floor(a),0,n-1)%2,l=r._children[s+2*u];if(null===l)break;r._dem_state===Cl.LOADED&&(o=r),r=l,n*=2,i*=2,a*=2}return o._dem_data}},{key:"endFrame",value:function(){var e=this._hist_stats.getMaxValue(this._num_touch_flakes);this._num_cache_flakes>this._flake_reduce_thresh*e&&this._reduceFlakes(e),this._num_cache_meshes>this._mesh_reduce_lower&&this._num_cache_meshes>this._mesh_reduce_thresh*this._num_touch_meshes&&this._reduceMeshes(),this._dem_area_updated.clear(),this._num_touch_flakes=0,this._num_touch_meshes=0,++this._frame_counter}},{key:"_requestRoot",value:function(){var e=this;this._root_cancel_id=this._dem_provider.requestTile(0,0,0,(function(t){if(t){var r=new il(0,0,0,e._ρ,t);e._avg_height=r.newAvgHeightMaps(),e._root_flake=new Ll(null,0,0,0),e._root_flake.setupRoot(e,r),e._status=Sl.READY,e._dem_area_updated.addTileArea(r)}else e._status=Sl.FAILED;e._root_cancel_id=null,--e._num_dem_requesteds})),++this._num_dem_requesteds}},{key:"_reduceFlakes",value:function(e){var t=this._root_flake.flattenFlakes();t.sort((function(e,t){return e.compareForReduce(t)}));var r=Math.floor(this._flake_reduce_factor*e);t.slice(r).forEach((function(e){return e.dispose()}))}},{key:"_reduceMeshes",value:function(){var e=this._root_flake.flattenMeshes();e.sort((function(e,t){return e.compareForReduce(t)}));var t=Math.floor(this._mesh_reduce_factor*this._num_touch_meshes);e.slice(t).forEach((function(e){return e.dispose()}))}},{key:"glenv",get:function(){return this._glenv}},{key:"dem_provider",get:function(){return this._dem_provider}},{key:"status",get:function(){return this._status}},{key:"dem_area_updated",get:function(){return this._dem_area_updated}},{key:"root_flake",get:function(){var e=this._root_flake;return e.touch(),e}}]),e}(),Sl={NOT_READY:{id:"NOT_READY"},READY:{id:"READY"},FAILED:{id:"FAILED"}};Ml.Status=Sl;var Ll=function(){function e(t,r,n,i){Ue(this,e),this.z=r,this.x=n,this.y=i,this._parent=t,this._children=[null,null,null,null],this._globe=null!==t?t._globe:null,this._dem_data=null,this._dem_state=Cl.NONE,this._entity_map=null,this._meshes=[],this._prev_Za_dem=null,this._prev_Zr_dem=null,this._base_height=0,this._height_min=0,this._height_max=0,this._dem_zlimit=0,this._gocs_x_min=0,this._gocs_x_max=0,this._gocs_y_min=0,this._gocs_y_max=0,this._gocs_z_min=0,this._gocs_z_max=0,this._aframe=-1,null!==this._globe&&(this._globe._num_cache_flakes+=1)}return Ge(e,[{key:"setupRoot",value:function(e,t){this._globe=e,this._dem_data=t,this._dem_state=Cl.LOADED,this._entity_map=new Map,this._estimate(),e._num_cache_flakes+=1}},{key:"newChild",value:function(t,r){var n=t+2*r,i=this._children[n];return null===i&&(i=new e(this,this.z+1,2*this.x+t,2*this.y+r),this._children[n]=i),i._estimate(),i.touch(),i}},{key:"isInvisible",value:function(e){switch(this.z){case 0:return this._isInvisible_0(e);default:return this._isInvisible_N(e)}}},{key:"getRenderObject",value:function(t){var r,n=Math.pow(2,-t)*e.ε;r=n<=2?Math.max(Math.ceil(us.LOG2PI-this.z-Math.maprayLog2(Math.acos(1-n))),0):0;var i,a=this._getCosφ();i=n*a<=2?Math.max(Math.ceil(us.LOG2PI-this.z+Math.maprayLog2(a/Math.acos(1-n*a))),0):0;var o=this._getMeshNode(t,r,i);return o.touch(),o.getRenderObject()}},{key:"getEntityProducers",value:function(){return this._getEntityMap().keys()}},{key:"addEntityProducer",value:function(e){switch(e.getAreaStatus(this)){case xl.AreaStatus.PARTIAL:this._entity_map.set(e,!1);var t=!0,r=!1,n=void 0;try{for(var i,a=this._children[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;null!==o&&null!==o._entity_map&&o.addEntityProducer(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}break;case xl.AreaStatus.FULL:this._addEntityFullProducer(e)}}},{key:"_addEntityFullProducer",value:function(e){this._entity_map.set(e,!0);var t=!0,r=!1,n=void 0;try{for(var i,a=this._children[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;null!==o&&null!==o._entity_map&&o._addEntityFullProducer(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"removeEntityProducer",value:function(e){if(this._entity_map.has(e)){this._entity_map.delete(e),this._removeEntityMeshes(e);var t=!0,r=!1,n=void 0;try{for(var i,a=this._children[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;null!==o&&null!==o._entity_map&&o.removeEntityProducer(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}}},{key:"updateEntityProducer",value:function(e){this.removeEntityProducer(e),this.addEntityProducer(e)}},{key:"findRayDistance",value:function(e,t){var r;for(r=this;r._dem_state!==Cl.LOADED;r=r._parent);if(this.z-r.z===this._globe._ρ)return this._findQuadRayDistance(e,t,r);if(this._cullForRayDistance(e,t))return t;for(var n=t,i=0;i<2;++i)for(var a=0;a<2;++a)n=this.newChild(a,i).findRayDistance(e,n);return n}},{key:"dispose",value:function(){var e,t=this._parent;if(null!==t){for(var r=this._globe,n=this._meshes;n.length>0;)n[0].dispose();var i=this._children;for(e=0;e<4;++e){var a=i[e];null!==a&&a.dispose()}var o=t._children;for(e=0;e<4;++e)if(o[e]===this){o[e]=null;break}this._parent=null,this._dem_state===Cl.REQUESTED&&(r._dem_provider.cancelRequest(this._dem_data),--r._num_dem_requesteds),r._num_cache_flakes-=1}}},{key:"flattenFlakes",value:function(){var e=[];return this._flattenFlakes(e),e}},{key:"flattenMeshes",value:function(){var e=[];return this._flattenMeshes(e),e}},{key:"compareForReduce",value:function(e){var t=e,r=t._aframe-this._aframe;return 0!==r?r:this.z-t.z}},{key:"_flattenFlakes",value:function(e){e.push(this);for(var t=this._children,r=0;r<4;++r){var n=t[r];null!==n&&n._flattenFlakes(e)}}},{key:"_flattenMeshes",value:function(e){Array.prototype.push.apply(e,this._meshes);for(var t=this._children,r=0;r<4;++r){var n=t[r];null!==n&&n._flattenMeshes(e)}}},{key:"touch",value:function(){var e=this._globe;this._aframe!==e._frame_counter&&(this._aframe=e._frame_counter,e._num_touch_flakes+=1)}},{key:"_getMeshNode",value:function(e,t,r){for(var n=this._getMeshDemBinary(e),i=n.getDivisionPowers(this,e,t,r),a=this._meshes,o=a.length,s=0;s<o;++s){var u=a[s];if(u.match(n,i))return u}var l=new Rl(this,n,i);return a.unshift(l),l}},{key:"_getMeshDemBinary",value:function(e){var t=us.clamp(Math.round(e+this._globe._dem_zbias),0,this._dem_zlimit),r=this._findNearestDemTile(t);if(r.z<t){var n=r.getQuadLevel(this.z,this.x,this.y);n>0&&this._requestAncestorDemTile(Math.min(r.z+n,t))}return r}},{key:"_findNearestDemTile",value:function(e){for(var t=this,r=this.z-e,n=0;n<r;++n)t=t._parent;for(;t._dem_state!==Cl.LOADED;)t=t._parent;return t._dem_data}},{key:"_requestAncestorDemTile",value:function(e){var t=this._globe;if(!(t._num_dem_requesteds>=t._max_dem_requesteds)){for(var r=this,n=this.z-e,i=0;i<n;++i)r=r._parent;for(;;){var a=r._dem_state;if(a===Cl.LOADED||a===Cl.REQUESTED)break;if(a!==Cl.FAILED){var o=t._dem_provider;r._dem_data=o.requestTile(r.z,r.x,r.y,(function(e){null!==r._parent&&(e?(r._dem_data=new il(r.z,r.x,r.y,t._ρ,e),r._dem_state=Cl.LOADED,t._dem_area_updated.addTileArea(r)):(r._dem_data=null,r._dem_state=Cl.FAILED),--t._num_dem_requesteds)})),r._dem_state=Cl.REQUESTED,++t._num_dem_requesteds;break}r=r._parent}}}},{key:"_isInvisible_0",value:function(e){for(var t=us.EARTH_RADIUS+this._height_max,r=0;r<e.length;++r){if(e[r][3]<-t)return!0}return!1}},{key:"_isInvisible_N",value:function(e){for(var t=this._gocs_x_min,r=this._gocs_x_max,n=this._gocs_y_min,i=this._gocs_y_max,a=this._gocs_z_min,o=this._gocs_z_max,s=0;s<e.length;++s){var u=e[s],l=u[0],_=u[1],c=u[2],h=u[3],f=l*t+_*n,v=l*r+_*n,d=l*t+_*i,y=l*r+_*i,p=-c*a-h,m=-c*o-h;if(f<p&&v<p&&d<p&&y<p&&f<m&&v<m&&d<m&&y<m)return!0}return!1}},{key:"_getCosφ",value:function(){var e=this.z;if(e>0){var t=this.y,r=Math.pow(2,1-e),n=Math.abs(1-r*t),i=Math.abs(1-r*(t+1)),a=Math.exp(Math.PI*Math.min(n,i));return 2*a/(a*a+1)}return 1}},{key:"_estimate",value:function(){if(this._prev_Za_dem!==this){var e,t=this.z,r=this._globe._ρ;if(t<r){if((e=this._findNearestDemTile(t))===this._prev_Zr_dem)return;this._prev_Zr_dem=e,this._estimate_low(e),this._dem_zlimit=t}else{var n=this._findNearestDemTile(t-r);if(n.isLeaf(t,this.x,this.y))this._estimate_leaf(n);else{if(e=this._findNearestDemTile(n.z+r),n===this._prev_Za_dem&&e===this._prev_Zr_dem)return;this._prev_Za_dem=n,this._prev_Zr_dem=e,this._estimate_high(n,e)}this._dem_zlimit=n.z+r}switch(t){case 0:this._updataBoundingBox_0();break;case 1:this._updataBoundingBox_1();break;default:this._updataBoundingBox_N()}}}},{key:"_estimate_low",value:function(t){var r=this.z,n=this.x,i=this.y,a=this._calcAlpha();this._base_height=this._globe._avg_height.sample(r,n,i),this._height_min=Math.max(this._base_height+a*e.Fm,t.height_min),this._height_max=Math.min(this._base_height+a*e.Fp,t.height_max),(t.z==r||t.isLeaf(r,n,i))&&(this._prev_Za_dem=this)}},{key:"_estimate_high",value:function(t,r){var n=this._globe,i=this.z,a=this.x,o=this.y,s=t.z,u=t.x,l=t.y,_=n._ρ,c=Math.pow(2,s-i),h=1<<_,f=Math.floor(h*((a+.5)*c-u)),v=Math.floor(h*((o+.5)*c-l)),d=h*(a*c-u)-f,y=h*((a+1)*c-u)-f,p=h*(o*c-l)-v,m=h*((o+1)*c-l)-v,g=t.getHeights(f,v),k=g[0],E=g[1],w=g[2],b=g[3],x=(k*(1-d)+E*d)*(1-p)+(w*(1-d)+b*d)*p,A=(k*(1-y)+E*y)*(1-p)+(w*(1-y)+b*y)*p,T=(k*(1-d)+E*d)*(1-m)+(w*(1-d)+b*d)*m,I=(k*(1-y)+E*y)*(1-m)+(w*(1-y)+b*y)*m,M=this._calcAlpha();if(this._base_height=.25*(x+A+T+I),this._height_min=Math.max(this._base_height+M*e.Fm,r.height_min),this._height_max=Math.min(this._base_height+M*e.Fp,r.height_max),s<i-_){var S=t.getQuadLevel(i,a,o);this._requestAncestorDemTile(Math.min(s+S,i-_))}else(r.z==i||r.isLeaf(i,a,o))&&(this._prev_Za_dem=this)}},{key:"_estimate_leaf",value:function(e){var t=this.z,r=this.x,n=this.y,i=e.z,a=e.x,o=e.y,s=Math.pow(2,i-t),u=1<<this._globe._ρ,l=Math.floor(u*((r+.5)*s-a)),_=Math.floor(u*((n+.5)*s-o)),c=u*(r*s-a)-l,h=u*((r+1)*s-a)-l,f=u*(n*s-o)-_,v=u*((n+1)*s-o)-_,d=e.getHeights(l,_),y=d[0],p=d[1],m=d[2],g=d[3],k=(y*(1-c)+p*c)*(1-f)+(m*(1-c)+g*c)*f,E=(y*(1-h)+p*h)*(1-f)+(m*(1-h)+g*h)*f,w=(y*(1-c)+p*c)*(1-v)+(m*(1-c)+g*c)*v,b=(y*(1-h)+p*h)*(1-v)+(m*(1-h)+g*h)*v;this._base_height=.25*(k+E+w+b),this._height_min=Math.min(k,E,w,b),this._height_max=Math.max(k,E,w,b),this._prev_Za_dem=this}},{key:"_calcAlpha",value:function(){var t=Math.pow(2,1-this.z);return t*e.πr/Math.cosh((1-t*(this.y+.5))*Math.PI)}},{key:"_updataBoundingBox_0",value:function(){var e=us.EARTH_RADIUS+this._height_max;this._gocs_x_min=-e,this._gocs_x_max=e,this._gocs_y_min=-e,this._gocs_y_max=e,this._gocs_z_min=-e,this._gocs_z_max=e}},{key:"_updataBoundingBox_1",value:function(){var e=us.EARTH_RADIUS+this._height_max,t=this.x,r=this.y;this._gocs_x_min=-e,this._gocs_x_max=e,this._gocs_y_min=e*(t-1),this._gocs_y_max=e*t,this._gocs_z_min=-e*r,this._gocs_z_max=e*(1-r)}},{key:"_updataBoundingBox_N",value:function(){var e=Math.PI,t=this.z,r=this.x,n=this.y,i=Math.pow(2,1-t)*e,a=e-(n+1)*i,o=e-n*i,s=r*i-e,u=(r+1)*i-e,l=Math.exp(a),_=Math.exp(o),c=l*l,h=_*_,f=us.EARTH_RADIUS+this._height_min,v=us.EARTH_RADIUS+this._height_max,d=2*l/(c+1),y=2*_/(h+1);a+o<0?(s+u<-e?(this._gocs_x_min=v*y*Math.cos(s),this._gocs_x_max=f*d*Math.cos(u),this._gocs_y_min=v*y*Math.sin(u),this._gocs_y_max=f*d*Math.sin(s)):s+u<0?(this._gocs_x_min=f*d*Math.cos(s),this._gocs_x_max=v*y*Math.cos(u),this._gocs_y_min=v*y*Math.sin(s),this._gocs_y_max=f*d*Math.sin(u)):s+u<e?(this._gocs_x_min=f*d*Math.cos(u),this._gocs_x_max=v*y*Math.cos(s),this._gocs_y_min=f*d*Math.sin(s),this._gocs_y_max=v*y*Math.sin(u)):(this._gocs_x_min=v*y*Math.cos(u),this._gocs_x_max=f*d*Math.cos(s),this._gocs_y_min=f*d*Math.sin(u),this._gocs_y_max=v*y*Math.sin(s)),this._gocs_z_min=v*(c-1)/(c+1),this._gocs_z_max=f*(h-1)/(h+1)):(s+u<-e?(this._gocs_x_min=v*d*Math.cos(s),this._gocs_x_max=f*y*Math.cos(u),this._gocs_y_min=v*d*Math.sin(u),this._gocs_y_max=f*y*Math.sin(s)):s+u<0?(this._gocs_x_min=f*y*Math.cos(s),this._gocs_x_max=v*d*Math.cos(u),this._gocs_y_min=v*d*Math.sin(s),this._gocs_y_max=f*y*Math.sin(u)):s+u<e?(this._gocs_x_min=f*y*Math.cos(u),this._gocs_x_max=v*d*Math.cos(s),this._gocs_y_min=f*y*Math.sin(s),this._gocs_y_max=v*d*Math.sin(u)):(this._gocs_x_min=v*d*Math.cos(u),this._gocs_x_max=f*y*Math.cos(s),this._gocs_y_min=f*y*Math.sin(u),this._gocs_y_max=v*d*Math.sin(s)),this._gocs_z_min=f*(c-1)/(c+1),this._gocs_z_max=v*(h-1)/(h+1))}},{key:"_requestHighestAccuracy",value:function(e,t){var r=this._dem_data.getQuadLevelDirect(e,t);if(0!=r){for(var n=this,i=Math.round(Math.pow(2,this.z+1)),a=i*e,o=i*t,s=0;s<r;++s){var u=us.clamp(Math.floor(a),0,i-1)%2,l=us.clamp(Math.floor(o),0,i-1)%2;n=n.newChild(u,l),i*=2,a*=2,o*=2}n._requestAncestorDemTile(n.z)}}},{key:"_findQuadRayDistance",value:function(t,r,n){var i=this._getQuadPositions(n,e._temp_positions),a=e._findTriRayDistance(t,r,i[0],i[2],i[1]);return a===r?e._findTriRayDistance(t,r,i[1],i[2],i[3]):a}},{key:"_getQuadPositions",value:function(e,t){for(var r=this.x,n=this.y,i=e.x,a=e.y,o=1<<this._globe._ρ,s=e._dem_data.getHeights(r-o*i,n-o*a),u=Math.pow(2,1-this.z)*Math.PI,l=r*u-Math.PI,_=0,c=Math.PI-n*u;_<2;++_,c-=u)for(var h=Math.exp(c),f=h*h,v=(f-1)/(f+1),d=2*h/(f+1),y=0,p=l;y<2;++y,p+=u){var m=y+2*_,g=us.EARTH_RADIUS+s[m],k=Math.sin(p),E=Math.cos(p),w=t[m];w[0]=g*d*E,w[1]=g*d*k,w[2]=g*v}return t}},{key:"_cullForRayDistance",value:function(e,t){var r=e.position,n=r[0],i=r[1],a=r[2],o=this._gocs_x_min,s=this._gocs_x_max,u=this._gocs_y_min,l=this._gocs_y_max,_=this._gocs_z_min,c=this._gocs_z_max;if(o<=n&&n<=s&&u<=i&&i<=l&&_<=a&&a<=c)return!1;var h,f,v,d,y=e.direction,p=y[0],m=y[1],g=y[2];if(n<o&&p>0){if((h=(o-n)/p)<t&&(d=a+h*g,u<=(v=i+h*m)&&v<=l&&_<=d&&d<=c))return!1}else if(n>s&&p<0&&(h=(s-n)/p)<t&&(d=a+h*g,u<=(v=i+h*m)&&v<=l&&_<=d&&d<=c))return!1;if(i<u&&m>0){if((h=(u-i)/m)<t&&(d=a+h*g,o<=(f=n+h*p)&&f<=s&&_<=d&&d<=c))return!1}else if(i>l&&m<0&&(h=(l-i)/m)<t&&(d=a+h*g,o<=(f=n+h*p)&&f<=s&&_<=d&&d<=c))return!1;if(a<_&&g>0){if((h=(_-a)/g)<t&&(v=i+h*m,o<=(f=n+h*p)&&f<=s&&u<=v&&v<=l))return!1}else if(a>c&&g<0&&(h=(c-a)/g)<t&&(v=i+h*m,o<=(f=n+h*p)&&f<=s&&u<=v&&v<=l))return!1;return!0}},{key:"_removeEntityMeshes",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=this._meshes[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){i.value.removeEntityMesh(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"_getEntityMap",value:function(){if(null===this._entity_map){var e=this._parent._getEntityMap(),t=new Map,r=!0,n=!1,i=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=Qe(a.value,2),u=s[0];if(s[1])t.set(u,!0);else switch(u.getAreaStatus(this)){case xl.AreaStatus.PARTIAL:t.set(u,!1);break;case xl.AreaStatus.FULL:t.set(u,!0)}}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}this._entity_map=t}return this._entity_map}},{key:"base_height",get:function(){return this._base_height}},{key:"height_min",get:function(){return this._height_min}},{key:"height_max",get:function(){return this._height_max}}],[{key:"_findTriRayDistance",value:function(t,r,n,i,a){var o=t.direction,s=e._temp_ray_1;s[0]=i[0]-n[0],s[1]=i[1]-n[1],s[2]=i[2]-n[2];var u=e._temp_ray_2;u[0]=a[0]-n[0],u[1]=a[1]-n[1],u[2]=a[2]-n[2];var l=us.cross3(s,u,e._temp_ray_3),_=us.dot3(l,o);if(_<0){var c=t.position,h=e._temp_ray_4;h[0]=n[0]-c[0],h[1]=n[1]-c[1],h[2]=n[2]-c[2];var f=us.dot3(l,h)/_;if(f>=0&&f<r){var v=e._temp_ray_5;v[0]=c[0]+f*o[0],v[1]=c[1]+f*o[1],v[2]=c[2]+f*o[2];var d=e._temp_ray_6;d[0]=n[0]-v[0],d[1]=n[1]-v[1],d[2]=n[2]-v[2];var y=e._temp_ray_7;y[0]=i[0]-v[0],y[1]=i[1]-v[1],y[2]=i[2]-v[2];var p=e._temp_ray_8;if(p[0]=a[0]-v[0],p[1]=a[1]-v[1],p[2]=a[2]-v[2],us.dot3(us.cross3(d,y,e._temp_ray_9),l)>=0&&us.dot3(us.cross3(y,p,e._temp_ray_10),l)>=0&&us.dot3(us.cross3(p,d,e._temp_ray_11),l)>=0)return f}}return r}}]),e}();Ll.ε=.0625,Ll.Fm=-2,Ll.Fp=2,Ll.πr=Math.PI*us.EARTH_RADIUS,Ll._temp_positions=function(){for(var e=[],t=0;t<4;++t)e.push(us.createVector3());return e}(),Ll._temp_ray_1=us.createVector3(),Ll._temp_ray_2=us.createVector3(),Ll._temp_ray_3=us.createVector3(),Ll._temp_ray_4=us.createVector3(),Ll._temp_ray_5=us.createVector3(),Ll._temp_ray_6=us.createVector3(),Ll._temp_ray_7=us.createVector3(),Ll._temp_ray_8=us.createVector3(),Ll._temp_ray_9=us.createVector3(),Ll._temp_ray_10=us.createVector3(),Ll._temp_ray_11=us.createVector3();var Pl=function(){function e(){Ue(this,e),this._history=[],this._max_value=0,this._hsize=200}return Ge(e,[{key:"getMaxValue",value:function(t){var r=this._history,n=this._max_value;return r.length<this._hsize?t>n&&(this._max_value=t):t>=n?(this._max_value=t,r.shift()):r[0]<n?r.shift():(r.shift(),this._max_value=e._find_max(r)),r.push(t),this._max_value}}],[{key:"_find_max",value:function(e){for(var t=e[0],r=e.length,n=1;n<r;++n){var i=e[n];i>t&&(t=i)}return t}}]),e}(),Rl=function(){function e(t,r,n){Ue(this,e),this._flake=t,this._dem=r,this._dpows=Array.from(n),this._aframe=-1,this._base_mesh=new ol(t._globe.glenv,t,n,r),this._entity_meshes=new Map,t._globe._num_cache_meshes+=1}return Ge(e,[{key:"getRenderObject",value:function(){var e=this._flake,t=new ll(e,e._globe.glenv,this._base_mesh),r=!0,n=!1,i=void 0;try{for(var a,o=e.getEntityProducers()[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value,u=this._getEntityMesh(s);u!==Ol&&(null===u&&(u=s.createMesh(e,this._dpows,this._dem),this._setEntityMesh(s,u),null===u)||t.addEntityData(u,s))}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return t}},{key:"match",value:function(e,t){return this._dem===e&&this._dpows[0]===t[0]&&this._dpows[1]===t[1]}},{key:"touch",value:function(){var e=this._flake._globe;this._aframe!==e._frame_counter&&(this._aframe=e._frame_counter,e._num_touch_meshes+=1)}},{key:"dispose",value:function(){if(null!==this._base_mesh){for(var e=this._flake,t=e._meshes,r=t.length,n=0;n<r;++n)if(t[n]===this){t.splice(n,1);break}this._base_mesh.dispose(),this._base_mesh=null;var i=!0,a=!1,o=void 0;try{for(var s,u=this._entity_meshes.values()[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value;l instanceof yl&&l.dispose()}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}e._globe._num_cache_meshes-=1}}},{key:"compareForReduce",value:function(e){return e._aframe-this._aframe}},{key:"removeEntityMesh",value:function(e){this._entity_meshes.delete(e)}},{key:"_getEntityMesh",value:function(e){var t=this._entity_meshes.get(e);return void 0!==t?t:null}},{key:"_setEntityMesh",value:function(e,t){var r=null!==t?t:Ol;this._entity_meshes.set(e,r)}}]),e}(),Cl={NONE:{id:"NONE"},LOADED:{id:"LOADED"},REQUESTED:{id:"REQUESTED"},FAILED:{id:"FAILED"}},Ol={id:"CACHED_EMPTY_MESH"},Fl=function(){function e(t){Ue(this,e),this.flake=t}return Ge(e,[{key:"getRenderObject",value:function(){return this.flake.getRenderObject(this.lod)}}]),e}(),Nl=function(){function e(t){Ue(this,e),this._setupViewVectors(t),this._setupClipPlanes(t);var r=t._viewer,n=r.dem_provider,i=r.tile_texture_cache;this._min_image_z=i.getImageZMin();var a=us.LOG2PI-n.getResolutionPower()+1;this._max_zbias=Math.max(i.getImageZBias(),a),this._globe=r.globe,this._rflake_list=[],this._debug_stats=r.debug_stats,this._debug_stats&&(this._num_procA_flakes=0,this._num_procB_flakes=0),this._view_dir_N=us.createVector3(),this._view_dir_V=us.createVector3()}return Ge(e,[{key:"_setupViewVectors",value:function(e){var t=e._view_to_gocs,r=e._pixel_step,n=us.createVector3(),i=us.createVector3();n[0]=t[12],n[1]=t[13],n[2]=t[14],i[0]=-t[8]*r,i[1]=-t[9]*r,i[2]=-t[10]*r,this._view_pos_Q=n,this._view_dir_wU=i}},{key:"_setupClipPlanes",value:function(e){var t=e._view_to_gocs,r=e._gocs_to_view,n=e._volume_planes,i=[],a=e._viewer._globe.root_flake,o=us.EARTH_RADIUS+a.height_min,s=us.EARTH_RADIUS+a.height_max,u=t[12],l=t[13],_=t[14],c=u*u+l*l+_*_,h=o*o,f=s*s,v=Math.sqrt((c-h)*(f-h))-h,d=us.createVector4(),y=1/Math.sqrt(c);d[0]=u*y,d[1]=l*y,d[2]=_*y,d[3]=v*y,i.push(d);for(var p=Math.sqrt(c+f+2*v),m=0;m<6;++m){var g=n[m],k=us.createVector4();1==m&&g[3]>p&&((g=us.createVector4(g))[3]=p),us.transformPlane_A(r,g,k),i.push(k)}this._clip_planes=i}},{key:"traverse",value:function(){return this._collectFlakes(this._globe.root_flake),this._debug_stats&&(this._debug_stats.num_procA_flakes=this._num_procA_flakes,this._debug_stats.num_procB_flakes=this._num_procB_flakes),this._rflake_list}},{key:"_collectFlakes",value:function(t){if(null!==this._debug_stats&&(this._num_procA_flakes+=1),!t.isInvisible(this._clip_planes))if(t.z<this._min_image_z)this._collectNextLevelFlakes(t);else{null!==this._debug_stats&&(this._num_procB_flakes+=1);var r=this._getLevelOfDetailRange(t),n=r.mid+this._max_zbias;r.max-r.min>e.MAX_LOD_INTERVAL||n>t.z?this._collectNextLevelFlakes(t):this._addRenderFlake(t,r)}}},{key:"_collectNextLevelFlakes",value:function(e){for(var t=0;t<2;++t)for(var r=0;r<2;++r)this._collectFlakes(e.newChild(r,t))}},{key:"_getLevelOfDetailRange",value:function(e){for(var t=Math.PI,r=e.z,n=e.x,i=e.y,a=Math.pow(2,1-r)*t,o=n*a-t,s=t-(i+1)*a,u=t/32,l=Math.ceil(a/u),_=a/l,c=us.EARTH_RADIUS+e.base_height,h=this._view_pos_Q,f=this._view_dir_wU,v=this._view_dir_N,d=this._view_dir_V,y=Number.MAX_VALUE,p=-Number.MAX_VALUE,m=0,g=s;m<l+1;++m,g+=_)for(var k=Math.exp(g),E=k*k,w=(E-1)/(E+1),b=2*k/(E+1),x=1/(c*b),A=0,T=o;A<l+1;++A,T+=_){var I=Math.sin(T),M=Math.cos(T);v[0]=b*M,v[1]=b*I,v[2]=w,d[0]=c*v[0]-h[0],d[1]=c*v[1]-h[1],d[2]=c*v[2]-h[2];var S=us.dot3(f,d);if(S<=0)return{min:-1e3,max:1e3,mid:0};var L=S*x;y=Math.min(y,L),p=Math.max(p,L)}var P=-Math.maprayLog2(p),R=-Math.maprayLog2(y);return{min:P,max:R,mid:(P+R)/2}}},{key:"_calcLOD",value:function(e,t,r){var n=Math.sin(e),i=Math.cos(e),a=Math.exp(t),o=a*a,s=(o-1)/(o+1),u=2*a/(o+1),l=this._view_dir_N;l[0]=u*i,l[1]=u*n,l[2]=s;var _=this._view_dir_V,c=this._view_pos_Q;_[0]=r*l[0]-c[0],_[1]=r*l[1]-c[1],_[2]=r*l[2]-c[2];var h=this._view_dir_wU,f=r*u/us.dot3(h,_);return Math.maprayLog2(f)}},{key:"_setCornerLODs",value:function(e){var t=Math.PI,r=e.flake,n=r.z,i=r.x,a=r.y,o=Math.pow(2,1-n)*t,s=i*o-t,u=(i+1)*o-t,l=t-(a+1)*o,_=t-a*o,c=us.EARTH_RADIUS+r.base_height;e.lod_00=this._calcLOD(s,l,c),e.lod_10=this._calcLOD(u,l,c),e.lod_01=this._calcLOD(s,_,c),e.lod_11=this._calcLOD(u,_,c)}},{key:"_addRenderFlake",value:function(e,t){var r=new Fl(e);r.lod=t.mid,this._setCornerLODs(r),this._rflake_list.push(r)}}]),e}();Nl.MAX_LOD_INTERVAL=.5;var Dl=function(){function e(t,r,n){Ue(this,e),this._glenv=t;try{this.vs_object=this._compile_shader("VERTEX_SHADER",r),this.fs_object=this._compile_shader("FRAGMENT_SHADER",n)}catch(e){var i=t.context;throw this.vs_object&&i.deleteShader(this.vs_object),this.fs_object&&i.deleteShader(this.fs_object),e}}return Ge(e,[{key:"dispose",value:function(){var e=this._glenv.context;this.vs_object&&(e.deleteShader(this.vs_object),this.vs_object=null),this.fs_object&&(e.deleteShader(this.fs_object),this.fs_object=null)}},{key:"_compile_shader",value:function(e,t){var r=this._glenv.context,n=r.createShader(r[e]);if(!n)throw new Error(e+" オブジェクトの生成に失敗しました");try{if(r.shaderSource(n,t),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS)){var i=r.getShaderInfoLog(n);throw new Error(e+" のコンパイルに失敗: "+i)}}catch(e){throw r.deleteShader(n),e}return n}}]),e}(),Vl=function(){function e(t,r,n){Ue(this,e);var i=new Dl(t,r,n);this._gl=t.context,this._program=this._link_shaders(i.vs_object,i.fs_object),this._vertex_attribs=this._create_vertex_attribs(),this._uniform_location=this._create_uniform_location(),i.dispose()}return Ge(e,[{key:"_link_shaders",value:function(e,t){var r=this._gl,n=r.createProgram();if(!n)throw new Error("プログラムオブジェクトの生成に失敗しました");try{if(r.attachShader(n,e),r.attachShader(n,t),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS)){var i=r.getProgramInfoLog(n);throw r.detachShader(n,t),r.detachShader(n,e),new Error("シェーダのリンクに失敗: "+i)}}catch(e){throw r.deleteProgram(n),e}return n}},{key:"_create_vertex_attribs",value:function(){for(var e=this._gl,t=this._program,r=[],n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),i=0;i<n;++i){var a=e.getActiveAttrib(t,i),o={name:a.name,location:e.getAttribLocation(t,a.name)};r.push(o)}return r}},{key:"_create_uniform_location",value:function(){for(var e=this._gl,t=this._program,r={},n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),i=0;i<n;++i){var a=e.getActiveUniform(t,i);r[a.name]=e.getUniformLocation(t,a.name)}return r}},{key:"dispose",value:function(){this._gl.deleteProgram(this._program),this._program=null}},{key:"bindProgram",value:function(){this._gl.useProgram(this._program)}},{key:"setBoolean",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform1i(r,t?1:0)}},{key:"setInteger",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform1i(r,t)}},{key:"setFloat",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform1f(r,t)}},{key:"setVector2",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform2fv(r,t)}},{key:"setVector3",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform3fv(r,t)}},{key:"setVector4",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform4fv(r,t)}},{key:"setMatrix",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniformMatrix4fv(r,!1,t)}},{key:"bindVertexAttribs",value:function(e){for(var t=this._gl,r=this._vertex_attribs,n=r.length,i=0;i<n;++i){var a=r[i],o=e[a.name],s=a.location;void 0!==o?(t.bindBuffer(t.ARRAY_BUFFER,o.buffer),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,o.num_components,o.component_type,o.normalized,o.byte_stride,o.byte_offset)):t.disableVertexAttribArray(s)}}},{key:"bindTexture2D",value:function(e,t){var r=this._gl;r.activeTexture(r.TEXTURE0+e),r.bindTexture(r.TEXTURE_2D,t)}}]),e}(),Ul=function(e){function t(e,r,n){var i;return Ue(this,t),(i=Ze(this,je(t).call(this,e.glenv,r,n)))._flake_to_clip=us.createMatrixf(),i}return ze(t,e),Ge(t,[{key:"numDrawings",value:function(){return 1}},{key:"isWireframe",value:function(){return!1}},{key:"setFlakeParameter",value:function(e,t,r,n){return!1}},{key:"setCommonParameter",value:function(e,t){t.mul_flake_to_gocs(e._gocs_to_clip,this._flake_to_clip),this.setMatrix("u_obj_to_clip",this._flake_to_clip)}}]),t}(Vl),Bl=function(){function e(){Ue(this,e)}return Ge(e,[{key:"status",value:function(e){return zl.READY}},{key:"requestTile",value:function(e,t,r,n){throw new Error("mapray.ImageProvider#requestTile() method has not been overridden.")}},{key:"cancelRequest",value:function(e){throw new Error("mapray.ImageProvider#cancelRequest() method has not been overridden.")}},{key:"getImageSize",value:function(){throw new Error("mapray.ImageProvider#getImageSize() method has not been overridden.")}},{key:"getZoomLevelRange",value:function(){throw new Error("mapray.ImageProvider#getZoomLevelRange() method has not been overridden.")}}]),e}(),Gl=function(){function e(t,r){Ue(this,e),this._min=t,this._max=r}return Ge(e,[{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}}]),e}();Bl.Range=Gl;var zl={NOT_READY:{id:"NOT_READY"},READY:{id:"READY"},FAILED:{id:"FAILED"}};Bl.Status=zl;var jl=function(e){function t(){return Ue(this,t),Ze(this,je(t).call(this))}return ze(t,e),Ge(t,[{key:"requestTile",value:function(e,t,r,n){return this}},{key:"cancelRequest",value:function(e){}},{key:"getImageSize",value:function(){return 4096}},{key:"getZoomLevelRange",value:function(){return new Bl.Range(0,0)}}]),t}(Bl),ql=function(){function e(t,r,n,i){Ue(this,e),this.z=t,this.x=r,this.y=n,this.texture=i}return Ge(e,[{key:"dispose",value:function(e){e.deleteTexture(this.texture),this.texture=null}}]),e}(),Yl=function(){function e(t,r){var n=this;Ue(this,e),this._glenv=t,this._provider=null,this._min_image_z=0,this._max_image_z=0,this._image_zbias=0;this._resetImageProvider(r.status((function(e){e===Bl.Status.READY?(n._flush(),n._resetImageProvider(r)):e===Bl.Status.FAILED&&console.error("ImageProvider.Status.FAILED in TileTextureCache")}))===Bl.Status.READY?r:new jl),this._croot=new Xl,this._max_accesses=0,this._frame_counter=0,this._lower_bound=1,this._upper_bound=1.2,this._num_requesteds=0,this._max_requesteds=75,this._new_requesteds=[];var i=t.context,a=t.EXT_texture_filter_anisotropic;a&&(this._aniso_ext=a,this._max_aniso=i.getParameter(a.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this._use_mipmap=!1}return Ge(e,[{key:"_resetImageProvider",value:function(e){this._provider=e;var t=e.getZoomLevelRange();this._min_image_z=t.min,this._max_image_z=t.max,this._image_zbias=Math.maprayLog2(2*Math.PI/e.getImageSize())}},{key:"cancel",value:function(){this._flush()}},{key:"_flush",value:function(){new Zl(this,this._croot),this._croot=new Xl,this._max_accesses=0}},{key:"getImageZBias",value:function(){return this._image_zbias}},{key:"getImageZMin",value:function(){return this._min_image_z}},{key:"getNumWaitingRequests",value:function(){return this._num_requesteds}},{key:"findNearestAncestors",value:function(t,r,n,i){for(var a,o,s,u=0,l=this._min_image_z,_=Math.pow(2,1-t),c=(r+.5)*_,h=(n+.5)*_,f=this._croot;u<l;++u)a=Math.floor(c)%2+2*(Math.floor(h)%2),null===(s=(o=f.children)[a])&&(s=new Xl,o[a]=s),c*=2,h*=2,f=s;var v=this._max_image_z,d=us.clamp(i-1,l,v),y=null,p=null;if(d<us.clamp(i,l,v)){for(;u<=d;++u)f.state===Ql.LOADED?y=f:f.state===Ql.NONE?(f.state=Ql.REQUESTED,f.req_power=i-u,this._new_requesteds.push([f,u,Math.floor(.5*c),Math.floor(.5*h)])):f.state===Ql.REQUESTED&&f.updateRequestPower(i-u),a=Math.floor(c)%2+2*(Math.floor(h)%2),null===(s=(o=f.children)[a])&&(s=new Xl,o[a]=s),c*=2,h*=2,f=s;p=y,f.state===Ql.LOADED?p=f:f.state===Ql.NONE?(f.state=Ql.REQUESTED,f.req_power=i-u,this._new_requesteds.push([f,u,Math.floor(.5*c),Math.floor(.5*h)])):f.state===Ql.REQUESTED&&f.updateRequestPower(i-u)}else for(;;++u){if(f.state===Ql.LOADED?y=f:f.state===Ql.NONE?(f.state=Ql.REQUESTED,f.req_power=i-u,this._new_requesteds.push([f,u,Math.floor(.5*c),Math.floor(.5*h)])):f.state===Ql.REQUESTED&&f.updateRequestPower(i-u),u==d){p=y;break}a=Math.floor(c)%2+2*(Math.floor(h)%2),null===(s=(o=f.children)[a])&&(s=new Xl,o[a]=s),c*=2,h*=2,f=s}f.touch();var m=e._findNearestAncestors_result;return m[0]=null!==p?p.data:null,m[1]=null!==y?y.data:null,m}},{key:"endFrame",value:function(){this._performNewRequests();var e=new Hl(this._croot,this._frame_counter);if(this._max_accesses=Math.max(e.num_accesses,this._max_accesses),e.num_loadeds>this._upper_bound*this._max_accesses){var t=Math.floor(this._lower_bound*this._max_accesses);this._reduceCache(t)}++this._frame_counter}},{key:"_performNewRequests",value:function(){var e=Math.min(this._max_requesteds-this._num_requesteds,this._new_requesteds.length);this._new_requesteds.sort((function(e,t){var r=e[0];return t[0].req_power-r.req_power}));var t=this;this._new_requesteds.slice(0,e).forEach((function(e){var r=e[0],n=e[1],i=e[2],a=e[3];t._requestTileTexture(n,i,a,r)})),this._new_requesteds.slice(e).forEach((function(e){e[0].state=Ql.NONE})),this._new_requesteds.length=0}},{key:"_requestTileTexture",value:function(e,t,r,n){var i=this;n.data=this._provider.requestTile(e,t,r,(function(a){n.state===Ql.REQUESTED&&(a?(n.data=new ql(e,t,r,i._createTexture(a)),n.state=Ql.LOADED):(n.data=null,n.state=Ql.FAILED),--i._num_requesteds)})),++this._num_requesteds}},{key:"_createTexture",value:function(e){var t=this._glenv.context,r=this._aniso_ext,n=t.TEXTURE_2D,i=t.createTexture();return t.bindTexture(n,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texImage2D(n,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this._use_mipmap&&t.generateMipmap(n),t.texParameteri(n,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(n,t.TEXTURE_MIN_FILTER,this._use_mipmap?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),t.texParameteri(n,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(n,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r&&t.texParameterf(t.TEXTURE_2D,r.TEXTURE_MAX_ANISOTROPY_EXT,this._max_aniso),t.bindTexture(n,null),i}},{key:"_reduceCache",value:function(e){var t=new Wl(this._croot);t.nodes.sort((function(e,t){var r=t.aframe-e.aframe;return 0==r&&e.state===Ql.LOADED&&t.state===Ql.LOADED?e.data.z-t.data.z:r}));var r=this._glenv.context;t.nodes.slice(e).forEach((function(e){e.state===Ql.LOADED&&e.data.dispose(r),e.state=Ql.NONE,e.data=null})),t.clean()}}]),e}();Yl._findNearestAncestors_result=new Array(2);var Xl=function(){function e(){Ue(this,e),this.children=[null,null,null,null],this.state=Ql.NONE,this.data=null,this.req_power=-1,this.aframe=-1}return Ge(e,[{key:"updateRequestPower",value:function(e){e>this.req_power&&(this.req_power=e)}},{key:"touch",value:function(){this.aframe=!0}}]),e}(),Hl=function(){function e(t,r){Ue(this,e),this.num_loadeds=0,this.num_accesses=0,this._frame=r,this._traverse(t)}return Ge(e,[{key:"_traverse",value:function(e){for(var t=e.children,r=!0===e.aframe,n=0;n<4;++n){var i=t[n];null!==i&&(r=this._traverse(i)||r)}return e.state===Ql.LOADED&&(++this.num_loadeds,r&&++this.num_accesses),r&&(e.aframe=this._frame),r}}]),e}(),Wl=function(){function e(t){Ue(this,e),this._root=t,this.nodes=[],this._traverse(t)}return Ge(e,[{key:"_traverse",value:function(e){var t=e.state;t!==Ql.LOADED&&t!==Ql.FAILED||this.nodes.push(e);for(var r=e.children,n=0;n<4;++n){var i=r[n];null!==i&&this._traverse(i)}}},{key:"clean",value:function(){this._clean_recur(this._root)}},{key:"_clean_recur",value:function(e){for(var t=e.state===Ql.NONE,r=e.children,n=0;n<4;++n){var i=r[n];if(null!==i){var a=this._clean_recur(i);!0===a&&(r[n]=null),t=a&&t}}return t}}]),e}(),Zl=function(){function e(t,r){Ue(this,e),this._owner=t,this._traverse(r)}return Ge(e,[{key:"_traverse",value:function(e){for(var t=e.children,r=0;r<4;++r){var n=t[r];null!==n&&this._traverse(n)}if(e.state===Ql.REQUESTED){var i=this._owner;e.state=Ql.NONE,i._provider.cancelRequest(e.data),--i._num_requesteds}}}]),e}(),Ql={NONE:{id:"NONE"},LOADED:{id:"LOADED"},REQUESTED:{id:"REQUESTED"},FAILED:{id:"FAILED"}},Kl=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e,"attribute vec4 a_position;         // 位置 (地表断片座標系)\nattribute vec2 a_uv;               // uv 座標\n\nuniform mat4  u_obj_to_clip;       // 地表断片座標系からクリップ座標系への変換\n\nuniform vec4  u_texcoord_rect_hi;  // 高レベル画像 左下座標: (x, y), 座標サイズ: (z, w)\nuniform vec4  u_texcoord_rect_lo;  // 低レベル画像 左下座標: (x, y), 座標サイズ: (z, w)\nuniform vec4  u_corner_lod;        // uv = (0,0), (1,0), (0,1), (1,1) の LOD\n\nvarying vec2  v_texcoord_hi;       // 高レベル画像のテクスチャ座標\nvarying vec2  v_texcoord_lo;       // 低レベル画像のテクスチャ座標\nvarying float v_lod;               // 補間された LOD\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n    // uv 座標をテクスチャ座標に変換\n    v_texcoord_hi = u_texcoord_rect_hi.xy + u_texcoord_rect_hi.zw * a_uv;\n    v_texcoord_lo = u_texcoord_rect_lo.xy + u_texcoord_rect_lo.zw * a_uv;\n\n    // LOD の補間\n    float u = a_uv.x;\n    float v = a_uv.y;\n\n    float lod_00 = u_corner_lod.x;  // uv = (0,0) の LOD\n    float lod_10 = u_corner_lod.y;  // uv = (1,0) の LOD\n    float lod_01 = u_corner_lod.z;  // uv = (0,1) の LOD\n    float lod_11 = u_corner_lod.w;  // uv = (1,1) の LOD\n\n    float lod_u0 = mix( lod_00, lod_10, u );  // uv = (u, 0) の LOD\n    float lod_u1 = mix( lod_01, lod_11, u );  // uv = (u, 1) の LOD\n    float lod_uv = mix( lod_u0, lod_u1, v );  // uv = (u, v) の LOD\n\n    v_lod = lod_uv;\n}\n","precision mediump float;\n\nvarying vec2  v_texcoord_hi;    // 高レベル画像のテクスチャ座標\nvarying vec2  v_texcoord_lo;    // 低レベル画像のテクスチャ座標\nvarying float v_lod;            // 補間された LOD\n\nuniform sampler2D u_image_hi;   // 高レベル画像\nuniform sampler2D u_image_lo;   // 低レベル画像\nuniform float     u_opacity;    // 不透明度\n\n/** 画像パラメータ\n *\n *  x = u_image_lo の LOD\n *  y = 1 / (u_image_hi の LOD - x)\n *\n *  ただし u_image_hi と u_image_lo が同じ画像のときは y = 0\n */\nuniform vec2 u_image_param;\n\n\nvoid main()\n{\n    vec4 color_hi = texture2D( u_image_hi, v_texcoord_hi );\n    vec4 color_lo = texture2D( u_image_lo, v_texcoord_lo );\n\n    // 画像の混合率\n    float lo_lod = u_image_param.x;\n    float  delta = u_image_param.y;\n    float  ratio = clamp( (v_lod - lo_lod) * delta, 0.0, 1.0 );\n\n    gl_FragColor = mix( color_lo, color_hi, ratio );\n    gl_FragColor.a *= u_opacity;  // 不透明度を適用\n}\n"))).bindProgram(),r.setInteger("u_image_hi",t.TEXUNIT_IMAGE_HI),r.setInteger("u_image_lo",t.TEXUNIT_IMAGE_LO),r._tile_texture_cache=e.tile_texture_cache,r._layers=e.layers,r._dummy_tile_texture=r._createDummyTileTexture(e.glenv),r._image_zbias=0,r}return ze(t,e),Ge(t,[{key:"numDrawings",value:function(){return 1+this._layers.numDrawingLayers()}},{key:"setFlakeParameter",value:function(e,r,n,i){this.setCommonParameter(e,n);var a=this._getMaterialParamater(r,i);return null!==a&&(this.setVector4("u_corner_lod",a.corner_lod),this.setVector4("u_texcoord_rect_hi",a.image_hi.texcoord_rect),this.setVector4("u_texcoord_rect_lo",a.image_lo.texcoord_rect),this.setVector2("u_image_param",[a.image_lo.lod,a.image_hi.lod==a.image_lo.lod?0:1/(a.image_hi.lod-a.image_lo.lod)]),this.setFloat("u_opacity",0==i?1:this._layers.getDrawingLayer(i-1).opacity),this.bindTexture2D(t.TEXUNIT_IMAGE_HI,a.image_hi.texture),this.bindTexture2D(t.TEXUNIT_IMAGE_LO,a.image_lo.texture),!0)}},{key:"_getMaterialParamater",value:function(e,t){var r=0==t?this._tile_texture_cache:this._layers.getDrawingLayer(t-1).tile_cache;this._image_zbias=r.getImageZBias();var n=e.flake,i=n.z;if(i<r.getImageZMin())return null;var a=n.x,o=n.y,s=Math.ceil(e.lod+this._image_zbias);if(i<s)return null;var u=r.findNearestAncestors(i,a,o,s);return t>=1&&null===u[0]?null:{corner_lod:[e.lod_00,e.lod_10,e.lod_01,e.lod_11],image_hi:this._getImageParamater(u[0],i,a,o,s),image_lo:this._getImageParamater(u[1],i,a,o,s-1)}}},{key:"_getImageParamater",value:function(e,t,r,n,i){var a;return null!==e?(a=Math.pow(2,e.z-t),{lod:e.z-this._image_zbias,texture:e.texture,texcoord_rect:[r*a-e.x,1-(n+1)*a+e.y,a,a]}):(a=Math.pow(2,-t),{lod:-this._image_zbias,texture:this._dummy_tile_texture,texcoord_rect:[r*a-Math.floor(a*(r+.5)),1-(n+1)*a+Math.floor(a*(n+.5)),a,a]})}},{key:"_createDummyTileTexture",value:function(e){var t=e.context,r=t.TEXTURE_2D,n=t.createTexture();return t.bindTexture(r,n),t.texImage2D(r,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([128,128,128,255])),t.bindTexture(r,null),n}}]),t}(Ul);Kl.TEXUNIT_IMAGE_HI=0,Kl.TEXUNIT_IMAGE_LO=1;var $l=function(e){function t(e){return Ue(this,t),Ze(this,je(t).call(this,e,"attribute vec4 a_position;\nattribute vec2 a_uv;\n\nuniform mat4 u_obj_to_clip;\n\nvarying vec2 v_uv;\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    v_uv  = a_uv;\n}\n","precision mediump float;\n\nvarying vec2 v_uv;\n\nvoid main()\n{\n    vec4 color = (v_uv.x < 0.005 || v_uv.y < 0.005 || v_uv.x > 0.995 || v_uv.y > 0.995) ?\n                 vec4( 1, 1, 0, 1 ) : vec4( 0.5, 0.5, 0.5, 1 );\n    gl_FragColor = color;\n}\n"))}return ze(t,e),Ge(t,[{key:"isWireframe",value:function(){return!0}},{key:"setFlakeParameter",value:function(e,t,r,n){return this.setCommonParameter(e,r),!0}}]),t}(Ul),Jl=function(){function e(t){Ue(this,e),this._viewer=t,this._glenv=t.glenv;var r=t.canvas_element;if(this._width=r.width,this._height=r.height,0!==this._width&&0!==this._height){var n=t.camera,i=n.createRenderInfo();this._setupBasicMatrices(i,n),this._volume_planes=i.volume_planes,this._pixel_step=i.pixel_step,this._scene=t.scene,this._globe=t.globe,this._tile_texture_cache=t.tile_texture_cache,t._render_cache||(t._render_cache={surface_material:new Kl(t),wireframe_material:new $l(t)}),this._flake_material=t.render_mode===ey.RenderMode.WIREFRAME?t._render_cache.wireframe_material:t._render_cache.surface_material,this._debug_stats=t.debug_stats}else this._rendering_cancel=!0}return Ge(e,[{key:"_setupBasicMatrices",value:function(e,t){this._view_to_gocs=t.view_to_gocs,this._gocs_to_view=us.createMatrix(),us.inverse_A(this._view_to_gocs,this._gocs_to_view),this._view_to_clip=e.view_to_clip,this._gocs_to_clip=us.createMatrix(),us.mul_PzA(this._view_to_clip,this._gocs_to_view,this._gocs_to_clip)}},{key:"render",value:function(){if(!this._rendering_cancel){var e=this._glenv.context;if(e.viewport(0,0,this._width,this._height),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ZERO,e.ONE),e.depthFunc(e.LEQUAL),this._globe.status===Ml.Status.READY){var t=new Nl(this).traverse(),r=this._viewer.getVisibility(ey.Category.GROUND),n=this._viewer.getVisibility(ey.Category.ENTITY);this._prepare_draw_flake();var i=!0,a=!1,o=void 0;try{for(var s,u=t[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value,_=l.getRenderObject();r&&this._draw_flake_base(l,_.getBaseMesh()),n&&this._draw_entities_on_flake(_)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}n&&this._scene.draw(this);var c=this._debug_stats;null!==c&&(c.num_drawing_flakes=t.length),this._globe.endFrame(),this._tile_texture_cache.endFrame(),this._viewer.layers.endFrame()}}}},{key:"_prepare_draw_flake",value:function(){var e=this._scene.getFlakePrimitiveProducers();this._globe.putNextEntityProducers(e)}},{key:"_draw_flake_base",value:function(e,t){var r=this._glenv.context,n=this._flake_material;n.bindProgram();var i=n.numDrawings();n.setFlakeParameter(this,e,t,0)&&(r.disable(r.BLEND),r.depthMask(!0),t.draw(n));for(var a=1;a<i;++a)n.setFlakeParameter(this,e,t,a)&&(r.enable(r.BLEND),r.depthMask(!1),t.draw(n));var o=this._debug_stats;null!==o&&(o.num_drawing_flake_vertices+=t.num_vertices)}},{key:"_draw_entities_on_flake",value:function(e){var t=e.num_entities;if(0!=t){var r=this._glenv.context;r.enable(r.POLYGON_OFFSET_FILL),r.depthMask(!1),r.polygonOffset(-8,-8);for(var n=0;n<t;++n){var i=e.getEntityPrimitive(n,this);i.isTranslucent(this)?r.enable(r.BLEND):r.disable(r.BLEND),i.draw(this)}r.disable(r.POLYGON_OFFSET_FILL)}}}]),e}(),e_={OMIT:{id:"OMIT",credentials:"omit"},SAME_ORIGIN:{id:"SAME_ORIGIN",credentials:"same-origin"},INCLUDE:{id:"INCLUDE",credentials:"include"}},t_=function(e){function t(e,r,n,i,a,o){var s,u,l;return Ue(this,t),(s=Ze(this,je(t).call(this)))._prefix=e,s._suffix=r,s._size=n,s._min_level=i,s._max_level=a,o&&o.coord_order&&(o.coord_order===r_.ZYX?u=function(e,t,r){return e+"/"+r+"/"+t}:o.coord_order===r_.XYZ&&(u=function(e,t,r){return t+"/"+r+"/"+e})),u||(u=function(e,t,r){return e+"/"+t+"/"+r}),o&&o.coord_system&&o.coord_system===n_.LOWER_LEFT&&(l=function(e,t,r){var n=Math.round(Math.pow(2,e));return u(e,t,n-r-1)}),l||(l=u),s._coords_part=l,s._crossOrigin="anonymous",o&&o.credentials&&(o.credentials===e_.OMIT?s._crossOrigin=null:o.credentials===e_.INCLUDE&&(s._crossOrigin="use-credentials")),s}return ze(t,e),Ge(t,[{key:"requestTile",value:function(e,t,r,n){var i=new Image;return i.onload=function(){n(i)},i.onerror=function(){n(null)},null!==this._crossOrigin&&(i.crossOrigin=this._crossOrigin),i.src=this._makeURL(e,t,r),i}},{key:"cancelRequest",value:function(e){}},{key:"getImageSize",value:function(){return this._size}},{key:"getZoomLevelRange",value:function(){return new Bl.Range(this._min_level,this._max_level)}},{key:"_makeURL",value:function(e,t,r){return this._prefix+this._coords_part(e,t,r)+this._suffix}}]),t}(Bl),r_={ZXY:{id:"ZXY"},ZYX:{id:"ZYX"},XYZ:{id:"XYZ"}},n_={UPPER_LEFT:{id:"UPPER_LEFT"},LOWER_LEFT:{id:"LOWER_LEFT"}};t_.CoordOrder=r_,t_.CoordSystem=n_;var i_=Object.assign,a_=Object.defineProperty,o_=!i_||i((function(){if(a&&1!==i_({b:1},i_(a_({},"a",{enumerable:!0,get:function(){a_(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var e={},t={},r=Symbol();return e[r]=7,"abcdefghijklmnopqrst".split("").forEach((function(e){t[e]=e})),7!=i_({},e)[r]||"abcdefghijklmnopqrst"!=rt(i_({},t)).join("")}))?function(e,t){for(var r=Vt(e),n=arguments.length,i=1,o=Ee.f,s=W.f;n>i;)for(var u,l=$(arguments[i++]),_=o?rt(l).concat(o(l)):rt(l),c=_.length,h=0;c>h;)u=_[h++],a&&!s.call(l,u)||(r[u]=l[u]);return r}:i_;Re({target:"Object",stat:!0,forced:Object.assign!==o_},{assign:o_});var s_,u_,l_,__=n.Promise,c_=/(iphone|ipod|ipad).*applewebkit/i.test(Cs),h_=n.location,f_=n.setImmediate,v_=n.clearImmediate,d_=n.process,y_=n.MessageChannel,p_=n.Dispatch,m_=0,g_={},k_=function(e){if(g_.hasOwnProperty(e)){var t=g_[e];delete g_[e],t()}},E_=function(e){return function(){k_(e)}},w_=function(e){k_(e.data)},b_=function(e){n.postMessage(e+"",h_.protocol+"//"+h_.host)};f_&&v_||(f_=function(e){for(var t=[],r=1;arguments.length>r;)t.push(arguments[r++]);return g_[++m_]=function(){("function"==typeof e?e:Function(e)).apply(void 0,t)},s_(m_),m_},v_=function(e){delete g_[e]},"process"==Q(d_)?s_=function(e){d_.nextTick(E_(e))}:p_&&p_.now?s_=function(e){p_.now(E_(e))}:y_&&!c_?(l_=(u_=new y_).port2,u_.port1.onmessage=w_,s_=er(l_.postMessage,l_,1)):!n.addEventListener||"function"!=typeof postMessage||n.importScripts||i(b_)?s_="onreadystatechange"in l("script")?function(e){it.appendChild(l("script")).onreadystatechange=function(){it.removeChild(this),k_(e)}}:function(e){setTimeout(E_(e),0)}:(s_=b_,n.addEventListener("message",w_,!1)));var x_,A_,T_,I_,M_,S_,L_,P_,R_={set:f_,clear:v_},C_=re.f,O_=R_.set,F_=n.MutationObserver||n.WebKitMutationObserver,N_=n.process,D_=n.Promise,V_="process"==Q(N_),U_=C_(n,"queueMicrotask"),B_=U_&&U_.value;B_||(x_=function(){var e,t;for(V_&&(e=N_.domain)&&e.exit();A_;){t=A_.fn,A_=A_.next;try{t()}catch(e){throw A_?I_():T_=void 0,e}}T_=void 0,e&&e.enter()},V_?I_=function(){N_.nextTick(x_)}:F_&&!c_?(M_=!0,S_=document.createTextNode(""),new F_(x_).observe(S_,{characterData:!0}),I_=function(){S_.data=M_=!M_}):D_&&D_.resolve?(L_=D_.resolve(void 0),P_=L_.then,I_=function(){P_.call(L_,x_)}):I_=function(){O_.call(n,x_)});var G_,z_,j_,q_,Y_=B_||function(e){var t={fn:e,next:void 0};T_&&(T_.next=t),A_||(A_=t,I_()),T_=t},X_=function(e){var t,r;this.promise=new e((function(e,n){if(void 0!==t||void 0!==r)throw TypeError("Bad Promise constructor");t=e,r=n})),this.resolve=Jt(t),this.reject=Jt(r)},H_={f:function(e){return new X_(e)}},W_=function(e,t){if(c(e),o(t)&&t.constructor===e)return t;var r=H_.f(e);return(0,r.resolve)(t),r.promise},Z_=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},Q_=R_.set,K_=Xt("species"),$_="Promise",J_=G.get,ec=G.set,tc=G.getterFor($_),rc=__,nc=n.TypeError,ic=n.document,ac=n.process,oc=ae("fetch"),sc=H_.f,uc=sc,lc="process"==Q(ac),_c=!!(ic&&ic.createEvent&&n.dispatchEvent),cc=Le($_,(function(){if(!(A(rc)!==String(rc))){if(66===Ds)return!0;if(!lc&&"function"!=typeof PromiseRejectionEvent)return!0}if(Ds>=51&&/native code/.test(rc))return!1;var e=rc.resolve(1),t=function(e){e((function(){}),(function(){}))};return(e.constructor={})[K_]=t,!(e.then((function(){}))instanceof t)})),hc=cc||!ci((function(e){rc.all(e).catch((function(){}))})),fc=function(e){var t;return!(!o(e)||"function"!=typeof(t=e.then))&&t},vc=function(e,t,r){if(!t.notified){t.notified=!0;var n=t.reactions;Y_((function(){for(var i=t.value,a=1==t.state,o=0;n.length>o;){var s,u,l,_=n[o++],c=a?_.ok:_.fail,h=_.resolve,f=_.reject,v=_.domain;try{c?(a||(2===t.rejection&&mc(e,t),t.rejection=1),!0===c?s=i:(v&&v.enter(),s=c(i),v&&(v.exit(),l=!0)),s===_.promise?f(nc("Promise-chain cycle")):(u=fc(s))?u.call(s,h,f):h(s)):f(i)}catch(e){v&&!l&&v.exit(),f(e)}}t.reactions=[],t.notified=!1,r&&!t.rejection&&yc(e,t)}))}},dc=function(e,t,r){var i,a;_c?((i=ic.createEvent("Event")).promise=t,i.reason=r,i.initEvent(e,!1,!0),n.dispatchEvent(i)):i={promise:t,reason:r},(a=n["on"+e])?a(i):"unhandledrejection"===e&&function(e,t){var r=n.console;r&&r.error&&(1===arguments.length?r.error(e):r.error(e,t))}("Unhandled promise rejection",r)},yc=function(e,t){Q_.call(n,(function(){var r,n=t.value;if(pc(t)&&(r=Z_((function(){lc?ac.emit("unhandledRejection",n,e):dc("unhandledrejection",e,n)})),t.rejection=lc||pc(t)?2:1,r.error))throw r.value}))},pc=function(e){return 1!==e.rejection&&!e.parent},mc=function(e,t){Q_.call(n,(function(){lc?ac.emit("rejectionHandled",e):dc("rejectionhandled",e,t.value)}))},gc=function(e,t,r,n){return function(i){e(t,r,i,n)}},kc=function(e,t,r,n){t.done||(t.done=!0,n&&(t=n),t.value=r,t.state=2,vc(e,t,!0))},Ec=function(e,t,r,n){if(!t.done){t.done=!0,n&&(t=n);try{if(e===r)throw nc("Promise can't be resolved itself");var i=fc(r);i?Y_((function(){var n={done:!1};try{i.call(r,gc(Ec,e,n,t),gc(kc,e,n,t))}catch(r){kc(e,n,r,t)}})):(t.value=r,t.state=1,vc(e,t,!1))}catch(r){kc(e,{done:!1},r,t)}}};cc&&(rc=function(e){oi(this,rc,$_),Jt(e),G_.call(this);var t=J_(this);try{e(gc(Ec,this,t),gc(kc,this,t))}catch(e){kc(this,t,e)}},(G_=function(e){ec(this,{type:$_,done:!1,notified:!1,parent:!1,reactions:[],rejection:!1,state:0,value:void 0})}).prototype=fi(rc.prototype,{then:function(e,t){var r=tc(this),n=sc(fa(this,rc));return n.ok="function"!=typeof e||e,n.fail="function"==typeof t&&t,n.domain=lc?ac.domain:void 0,r.parent=!0,r.reactions.push(n),0!=r.state&&vc(this,r,!1),n.promise},catch:function(e){return this.then(void 0,e)}}),z_=function(){var e=new G_,t=J_(e);this.promise=e,this.resolve=gc(Ec,e,t),this.reject=gc(kc,e,t)},H_.f=sc=function(e){return e===rc||e===j_?new z_(e):uc(e)},"function"==typeof __&&(q_=__.prototype.then,z(__.prototype,"then",(function(e,t){var r=this;return new rc((function(e,t){q_.call(r,e,t)})).then(e,t)}),{unsafe:!0}),"function"==typeof oc&&Re({global:!0,enumerable:!0,forced:!0},{fetch:function(e){return W_(rc,oc.apply(n,arguments))}}))),Re({global:!0,wrap:!0,forced:cc},{Promise:rc}),$t(rc,$_,!1),di($_),j_=ae($_),Re({target:$_,stat:!0,forced:cc},{reject:function(e){var t=sc(this);return t.reject.call(void 0,e),t.promise}}),Re({target:$_,stat:!0,forced:cc},{resolve:function(e){return W_(this,e)}}),Re({target:$_,stat:!0,forced:hc},{all:function(e){var t=this,r=sc(t),n=r.resolve,i=r.reject,a=Z_((function(){var r=Jt(t.resolve),a=[],o=0,s=1;ai(e,(function(e){var u=o++,l=!1;a.push(void 0),s++,r.call(t,e).then((function(e){l||(l=!0,a[u]=e,--s||n(a))}),i)})),--s||n(a)}));return a.error&&i(a.value),r.promise},race:function(e){var t=this,r=sc(t),n=r.reject,i=Z_((function(){var i=Jt(t.resolve);ai(e,(function(e){i.call(t,e).then(r.resolve,n)}))}));return i.error&&n(i.value),r.promise}});var wc=function(){function e(){Ue(this,e)}return Ge(e,[{key:"requestTile",value:function(e,t,r,n){throw new Error("mapray.DemProvider#requestTile() method has not been overridden.")}},{key:"cancelRequest",value:function(e){throw new Error("mapray.DemProvider#cancelRequest() method has not been overridden.")}},{key:"getResolutionPower",value:function(){return 8}}]),e}(),bc=function(e){function t(e,r,n){var i;Ue(this,t);var a=n||{};return(i=Ze(this,je(t).call(this)))._prefix=e,i._suffix=r,i._credentials=(a.credentials||e_.OMIT).credentials,i._headers=Object.assign({},a.headers),i}return ze(t,e),Ge(t,[{key:"requestTile",value:function(e,t,r,n){var i=new AbortController;return fetch(this._makeURL(e,t,r),{credentials:this._credentials,headers:this._headers,signal:i.signal}).then((function(e){return e.ok?e.arrayBuffer():Promise.reject(Error(e.statusText))})).then((function(e){n(e)})).catch((function(){n(null)})),i}},{key:"cancelRequest",value:function(e){e.abort()}},{key:"_makeURL",value:function(e,t,r){return this._prefix+e+"/"+t+"/"+r+this._suffix}}]),t}(wc),xc=function(){function e(t,r){Ue(this,e),this._owner=t,this._glenv=t.glenv;var n=r instanceof Bl?{image_provider:r}:r;this._image_provider=n.image_provider,this._visibility=n.visibility||!0,this._opacity=n.opacity||1,this._tile_cache=new Yl(this._glenv,this._image_provider),this._image_provider.status((function(e){t.dirtyDrawingLayers()}))}return Ge(e,[{key:"setImageProvider",value:function(e){var t=this;this._image_provider!==e&&(this._owner.dirtyDrawingLayers(),e.status((function(e){t._owner.dirtyDrawingLayers()}))),this._image_provider=e,this._tile_cache.cancel(),this._tile_cache=new Yl(this._glenv,e)}},{key:"setVisibility",value:function(e){this._visibility!=e&&this._owner.dirtyDrawingLayers(),this._visibility=e}},{key:"setOpacity",value:function(e){this._opacity=e}},{key:"image_provider",get:function(){return this._image_provider}},{key:"visibility",get:function(){return this._visibility}},{key:"opacity",get:function(){return this._opacity}},{key:"tile_cache",get:function(){return this._tile_cache}}]),e}(),Ac=function(){function e(t,r){Ue(this,e),this._glenv=t,this._layers=[],this._draw_layers=null;for(var n=0;n<r.length;++n)this.add(r[n])}return Ge(e,[{key:"getLayer",value:function(e){return this._layers[e]}},{key:"clear",value:function(){for(;this.num_layers()>0;)this.remove(0)}},{key:"add",value:function(e){this.insert(this.num_layers,e)}},{key:"insert",value:function(e,t){this._layers.splice(e,0,new xc(this,t)),this.dirtyDrawingLayers()}},{key:"remove",value:function(e){this._layers.splice(e,1),this.dirtyDrawingLayers()}},{key:"numDrawingLayers",value:function(){return null===this._draw_layers&&this._updataDrawingLayers(),this._draw_layers.length}},{key:"getDrawingLayer",value:function(e){return null===this._draw_layers&&this._updataDrawingLayers(),this._draw_layers[e]}},{key:"endFrame",value:function(){for(var e=this._layers,t=0;t<e.length;++t)e[t].tile_cache.endFrame()}},{key:"cancel",value:function(){for(var e=this._layers,t=0;t<e.length;++t)e[t].tile_cache.cancel()}},{key:"dirtyDrawingLayers",value:function(){this._draw_layers=null}},{key:"_updataDrawingLayers",value:function(){for(var e=this.num_layers,t=[],r=0;r<e;++r){var n=this._layers[r];n.image_provider.status()===Bl.Status.READY&&!0===n.visibility&&t.push(n)}this._draw_layers=t}},{key:"glenv",get:function(){return this._glenv}},{key:"num_layers",get:function(){return this._layers.length}}]),e}(),Tc=function(){function e(){Ue(this,e),this._viewer=null,this._is_started_=!1}return Ge(e,[{key:"attach",value:function(e){if(this._viewer)throw new Error("RenderCallback instance is already attached");this._viewer=e,this._is_started_=!1}},{key:"detach",value:function(){this._is_started_&&(this.onStop(),this._is_started_=!1),this._viewer=null}},{key:"onUpdateFrameInner",value:function(e){this._is_started_||(this.onStart(),this._is_started_=!0),this.onUpdateFrame(e)}},{key:"onStart",value:function(){}},{key:"onUpdateFrame",value:function(e){}},{key:"onStop",value:function(){}},{key:"viewer",get:function(){return this._viewer}}]),e}(),Ic=function(e){function t(){return Ue(this,t),Ze(this,je(t).call(this))}return ze(t,e),t}(Tc),Mc=de.indexOf,Sc=[].indexOf,Lc=!!Sc&&1/[1].indexOf(1,-0)<0,Pc=Eo("indexOf"),Rc=Zr("indexOf",{ACCESSORS:!0,1:0});Re({target:"Array",proto:!0,forced:Lc||!Pc||!Rc},{indexOf:function(e){return Lc?Sc.apply(this,arguments)||0:Mc(this,e,arguments.length>1?arguments[1]:void 0)}});var Cc=function(){function e(t,r){var n=this;Ue(this,e),this._viewer=t,this._glenv=r,this._enode_list=[],this._loaders=[],this._animation=new Xs,this._animation.addDescendantUnbinder((function(){n._unbindDescendantAnimations()}))}return Ge(e,[{key:"clearEntities",value:function(){this._enode_list=[]}},{key:"addEntity",value:function(e){if(e.scene!==this)throw new Error("invalid entity");this._enode_list.push(new Oc(e))}},{key:"removeEntity",value:function(e){for(var t=this._enode_list,r=0;r<t.length;++r)if(t[r].entity===e){t.splice(r,1);break}}},{key:"getEntity",value:function(e){return this._enode_list[e].entity}},{key:"draw",value:function(e){this._prepare_entities();var t=[],r=[],n=!0,i=!1,a=void 0;try{for(var o,s=this._enode_list[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value.entity;this._add_primitives(e,u,t,r)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}this._draw_opaque_primitives(e,t),this._draw_translucent_primitives(e,r)}},{key:"_prepare_entities",value:function(){var e=this._viewer.globe.dem_area_updated,t=!0,r=!1,n=void 0;try{for(var i,a=this._enode_list[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value,s=o.entity.getPrimitiveProducer();if(null!==s&&s.needsElevation())if(s.checkToCreateRegions()||null===o.regions)o.regions=s.createRegions(),o.regions.length>0&&(o.regions.forEach((function(e){e.compile()})),s.onChangeElevation(o.regions));else{if(e.isEmpty())continue;var u=[];o.regions.forEach((function(t){t.intersectsWith(e)&&u.push(t)})),u.length>0&&s.onChangeElevation(u)}}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"_add_primitives",value:function(e,t,r,n){var i=t.getPrimitiveProducer();if(null!==i){var a=!0,o=!1,s=void 0;try{for(var u,l=i.getPrimitives(e)[Symbol.iterator]();!(a=(u=l.next()).done);a=!0){var _=u.value;if(_.isVisible(e))(_.isTranslucent(e)?n:r).push(_)}}catch(e){o=!0,s=e}finally{try{a||null==l.return||l.return()}finally{if(o)throw s}}}}},{key:"_draw_opaque_primitives",value:function(e,t){t.sort((function(e,t){return t.sort_z-e.sort_z}));var r=this._glenv.context;r.disable(r.BLEND),r.depthMask(!0);for(var n=0;n<t.length;++n)t[n].draw(e)}},{key:"_draw_translucent_primitives",value:function(e,t){t.sort((function(e,t){return e.sort_z-t.sort_z}));var r=this._glenv.context;r.enable(r.BLEND),r.depthMask(!1);for(var n=0;n<t.length;++n)t[n].draw(e)}},{key:"cancelLoaders",value:function(){for(var e=this._loaders.concat(),t=0;t<e.length;++t)e[t].cancel()}},{key:"addLoader",value:function(e){this._loaders.push(e)}},{key:"removeLoader",value:function(e){var t=this._loaders.indexOf(e);t>=0&&this._loaders.splice(t,1)}},{key:"getFlakePrimitiveProducers",value:function(){var e=[],t=!0,r=!1,n=void 0;try{for(var i,a=this._enode_list[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value.entity.getFlakePrimitiveProducer();null!==o&&e.push(o)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return e}},{key:"_unbindDescendantAnimations",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._enode_list[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){n.value.entity.animation.unbindAllRecursively()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"glenv",get:function(){return this._glenv}},{key:"viewer",get:function(){return this._viewer}},{key:"animation",get:function(){return this._animation}},{key:"num_entities",get:function(){return this._enode_list.length}}]),e}(),Oc=function e(t){Ue(this,e),this.entity=t,this.regions=null},Fc=i((function(){rt(1)}));Re({target:"Object",stat:!0,forced:Fc},{keys:function(e){return rt(Vt(e))}});var Nc=/"/g;Re({target:"String",proto:!0,forced:function(e){return i((function(){var t=""[e]('"');return t!==t.toLowerCase()||t.split('"').length>3}))}("link")},{link:function(e){return t="a",r="href",n=e,i=String(J(this)),a="<"+t,""!==r&&(a+=" "+r+'="'+String(n).replace(Nc,"&quot;")+'"'),a+">"+i+"</"+t+">";var t,r,n,i,a}}),Re({target:"Array",proto:!0,forced:Io!==[].lastIndexOf},{lastIndexOf:Io});var Dc=[].join,Vc=$!=Object,Uc=Eo("join",",");Re({target:"Array",proto:!0,forced:Vc||!Uc},{join:function(e){return Dc.call(ee(this),void 0===e?",":e)}});var Bc=RegExp.prototype,Gc=Bc.toString,zc=i((function(){return"/a/b"!=Gc.call({source:"a",flags:"b"})})),jc="toString"!=Gc.name;(zc||jc)&&z(RegExp.prototype,"toString",(function(){var e=c(this),t=String(e.source),r=e.flags;return"/"+t+"/"+String(void 0===r&&e instanceof RegExp&&!("flags"in Bc)?Ru.call(e):r)}),{unsafe:!0});var qc,Yc=re.f,Xc="".startsWith,Hc=Math.min,Wc=Pn("startsWith"),Zc=!(Wc||(qc=Yc(String.prototype,"startsWith"),!qc||qc.writable));Re({target:"String",proto:!0,forced:!Zc&&!Wc},{startsWith:function(e){var t=String(J(this));Sn(e);var r=_e(Hc(arguments.length>1?arguments[1]:void 0,t.length)),n=String(e);return Xc?Xc.call(t,n,r):t.slice(r,r+n.length)===n}});var Qc=function(){function e(){Ue(this,e)}return Ge(e,null,[{key:"get",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.fetch(e.METHOD.GET,t,r,null,n)}},{key:"post",value:function(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.fetch(e.METHOD.POST,t,r,n,i)}},{key:"patch",value:function(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.fetch(e.METHOD.PATCH,t,r,n,i)}},{key:"put",value:function(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.fetch(e.METHOD.PUT,t,r,n,i)}},{key:"delete",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.fetch(e.METHOD.DELETE,t,r,null,n)}},{key:"fetch",value:function(e){function t(t,r,n,i){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},a=r?"?"+Object.keys(r).map((function(e){return e+"="+r[e]})).join("&"):"";return i.method=e,n&&(i.body=n),fetch(t+a,i).catch((function(e){throw new Kc("Failed to fetch",t,null,e)})).then((function(e){if(!e.ok)throw new Kc("Failed to fetch: "+e.statusText,t,e);return e}))}))},{key:"isJson",value:function(e){return e.startsWith("application/json")||"model/gltf+json"===e}}]),e}();Qc.METHOD={GET:"GET",POST:"POST",PATCH:"PATCH",PUT:"PUT",DELETE:"DELETE"},Qc.CONTENT_TYPE="Content-Type",Qc.RESPONSE_STATUS={NO_CONTENT:204},Qc.CREDENTIAL_MODE={OMIT:{id:"OMIT",credentials:"omit"},SAME_ORIGIN:{id:"SAME_ORIGIN",credentials:"same-origin"},INCLUDE:{id:"INCLUDE",credentials:"include"}};var Kc=function(e){function t(e,r,n,i){var a;return Ue(this,t),a=Ze(this,je(t).call(this,e+" "+r)),Error.captureStackTrace&&Error.captureStackTrace(We(a),t),a.name="FetchError",a.url=r,a.response=n,a.cause=i,i&&(a.stack+="\nCaused-By: "+i.stack),a}return ze(t,e),t}(He(Error)),$c=v.f,Jc=ke.f,eh=G.set,th=Xt("match"),rh=n.RegExp,nh=rh.prototype,ih=/a/g,ah=/a/g,oh=new rh(ih)!==ih,sh=Ou.UNSUPPORTED_Y;if(a&&Le("RegExp",!oh||sh||i((function(){return ah[th]=!1,rh(ih)!=ih||rh(ah)==ah||"/a/i"!=rh(ih,"i")})))){for(var uh=function(e,t){var r,n=this instanceof uh,i=Mn(e),a=void 0===t;if(!n&&i&&e.constructor===uh&&a)return e;oh?i&&!a&&(e=e.source):e instanceof uh&&(a&&(t=Ru.call(e)),e=e.source),sh&&(r=!!t&&t.indexOf("y")>-1)&&(t=t.replace(/y/g,""));var o=tt(oh?new rh(e,t):rh(e,t),n?this:nh,uh);return sh&&r&&eh(o,{sticky:r}),o},lh=function(e){e in uh||$c(uh,e,{configurable:!0,get:function(){return rh[e]},set:function(t){rh[e]=t}})},_h=Jc(rh),ch=0;_h.length>ch;)lh(_h[ch++]);nh.constructor=uh,uh.prototype=nh,z(n,"RegExp",uh)}di("RegExp");var hh=Xt("iterator"),fh=!i((function(){var e=new URL("b?a=1&b=2&c=3","http://a"),t=e.searchParams,r="";return e.pathname="c%20d",t.forEach((function(e,n){t.delete("b"),r+=n+e})),!t.sort||"http://a/c%20d?a=1&c=3"!==e.href||"3"!==t.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!t[hh]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("http://тест").host||"#%D0%B1"!==new URL("http://a#б").hash||"a1c3"!==r||"x"!==new URL("http://x",void 0).host})),vh=/[^\0-\u007E]/,dh=/[.\u3002\uFF0E\uFF61]/g,yh="Overflow: input needs wider integers to process",ph=Math.floor,mh=String.fromCharCode,gh=function(e){return e+22+75*(e<26)},kh=function(e,t,r){var n=0;for(e=r?ph(e/700):e>>1,e+=ph(e/t);e>455;n+=36)e=ph(e/35);return ph(n+36*e/(e+38))},Eh=function(e){var t,r,n=[],i=(e=function(e){for(var t=[],r=0,n=e.length;r<n;){var i=e.charCodeAt(r++);if(i>=55296&&i<=56319&&r<n){var a=e.charCodeAt(r++);56320==(64512&a)?t.push(((1023&i)<<10)+(1023&a)+65536):(t.push(i),r--)}else t.push(i)}return t}(e)).length,a=128,o=0,s=72;for(t=0;t<e.length;t++)(r=e[t])<128&&n.push(mh(r));var u=n.length,l=u;for(u&&n.push("-");l<i;){var _=2147483647;for(t=0;t<e.length;t++)(r=e[t])>=a&&r<_&&(_=r);var c=l+1;if(_-a>ph((2147483647-o)/c))throw RangeError(yh);for(o+=(_-a)*c,a=_,t=0;t<e.length;t++){if((r=e[t])<a&&++o>2147483647)throw RangeError(yh);if(r==a){for(var h=o,f=36;;f+=36){var v=f<=s?1:f>=s+26?26:f-s;if(h<v)break;var d=h-v,y=36-v;n.push(mh(gh(v+d%y))),h=ph(d/y)}n.push(mh(gh(h))),s=kh(o,c,l==u),o=0,++l}}++o,++a}return n.join("")},wh=function(e){var t=ni(e);if("function"!=typeof t)throw TypeError(String(e)+" is not iterable");return c(t.call(e))},bh=ae("fetch"),xh=ae("Headers"),Ah=Xt("iterator"),Th=G.set,Ih=G.getterFor("URLSearchParams"),Mh=G.getterFor("URLSearchParamsIterator"),Sh=/\+/g,Lh=Array(4),Ph=function(e){return Lh[e-1]||(Lh[e-1]=RegExp("((?:%[\\da-f]{2}){"+e+"})","gi"))},Rh=function(e){try{return decodeURIComponent(e)}catch(t){return e}},Ch=function(e){var t=e.replace(Sh," "),r=4;try{return decodeURIComponent(t)}catch(e){for(;r;)t=t.replace(Ph(r--),Rh);return t}},Oh=/[!'()~]|%20/g,Fh={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},Nh=function(e){return Fh[e]},Dh=function(e){return encodeURIComponent(e).replace(Oh,Nh)},Vh=function(e,t){if(t)for(var r,n,i=t.split("&"),a=0;a<i.length;)(r=i[a++]).length&&(n=r.split("="),e.push({key:Ch(n.shift()),value:Ch(n.join("="))}))},Uh=function(e){this.entries.length=0,Vh(this.entries,e)},Bh=function(e,t){if(e<t)throw TypeError("Not enough arguments")},Gh=hn((function(e,t){Th(this,{type:"URLSearchParamsIterator",iterator:wh(Ih(e).entries),kind:t})}),"Iterator",(function(){var e=Mh(this),t=e.kind,r=e.iterator.next(),n=r.value;return r.done||(r.value="keys"===t?n.key:"values"===t?n.value:[n.key,n.value]),r})),zh=function(){oi(this,zh,"URLSearchParams");var e,t,r,n,i,a,s,u,l,_=arguments.length>0?arguments[0]:void 0,h=this,f=[];if(Th(h,{type:"URLSearchParams",entries:f,updateURL:function(){},updateSearchParams:Uh}),void 0!==_)if(o(_))if("function"==typeof(e=ni(_)))for(r=(t=e.call(_)).next;!(n=r.call(t)).done;){if((s=(a=(i=wh(c(n.value))).next).call(i)).done||(u=a.call(i)).done||!a.call(i).done)throw TypeError("Expected sequence with length 2");f.push({key:s.value+"",value:u.value+""})}else for(l in _)m(_,l)&&f.push({key:l,value:_[l]+""});else Vh(f,"string"==typeof _?"?"===_.charAt(0)?_.slice(1):_:_+"")},jh=zh.prototype;fi(jh,{append:function(e,t){Bh(arguments.length,2);var r=Ih(this);r.entries.push({key:e+"",value:t+""}),r.updateURL()},delete:function(e){Bh(arguments.length,1);for(var t=Ih(this),r=t.entries,n=e+"",i=0;i<r.length;)r[i].key===n?r.splice(i,1):i++;t.updateURL()},get:function(e){Bh(arguments.length,1);for(var t=Ih(this).entries,r=e+"",n=0;n<t.length;n++)if(t[n].key===r)return t[n].value;return null},getAll:function(e){Bh(arguments.length,1);for(var t=Ih(this).entries,r=e+"",n=[],i=0;i<t.length;i++)t[i].key===r&&n.push(t[i].value);return n},has:function(e){Bh(arguments.length,1);for(var t=Ih(this).entries,r=e+"",n=0;n<t.length;)if(t[n++].key===r)return!0;return!1},set:function(e,t){Bh(arguments.length,1);for(var r,n=Ih(this),i=n.entries,a=!1,o=e+"",s=t+"",u=0;u<i.length;u++)(r=i[u]).key===o&&(a?i.splice(u--,1):(a=!0,r.value=s));a||i.push({key:o,value:s}),n.updateURL()},sort:function(){var e,t,r,n=Ih(this),i=n.entries,a=i.slice();for(i.length=0,r=0;r<a.length;r++){for(e=a[r],t=0;t<r;t++)if(i[t].key>e.key){i.splice(t,0,e);break}t===r&&i.push(e)}n.updateURL()},forEach:function(e){for(var t,r=Ih(this).entries,n=er(e,arguments.length>1?arguments[1]:void 0,3),i=0;i<r.length;)n((t=r[i++]).value,t.key,this)},keys:function(){return new Gh(this,"keys")},values:function(){return new Gh(this,"values")},entries:function(){return new Gh(this,"entries")}},{enumerable:!0}),z(jh,Ah,jh.entries),z(jh,"toString",(function(){for(var e,t=Ih(this).entries,r=[],n=0;n<t.length;)e=t[n++],r.push(Dh(e.key)+"="+Dh(e.value));return r.join("&")}),{enumerable:!0}),$t(zh,"URLSearchParams"),Re({global:!0,forced:!fh},{URLSearchParams:zh}),fh||"function"!=typeof bh||"function"!=typeof xh||Re({global:!0,enumerable:!0,forced:!0},{fetch:function(e){var t,r,n,i=[e];return arguments.length>1&&(t=arguments[1],o(t)&&(r=t.body,"URLSearchParams"===An(r)&&((n=t.headers?new xh(t.headers):new xh).has("content-type")||n.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"),t=lt(t,{body:d(0,String(r)),headers:d(0,n)}))),i.push(t)),bh.apply(this,i)}});var qh,Yh={URLSearchParams:zh,getState:Ih},Xh=Cn.codeAt,Hh=n.URL,Wh=Yh.URLSearchParams,Zh=Yh.getState,Qh=G.set,Kh=G.getterFor("URL"),$h=Math.floor,Jh=Math.pow,ef=/[A-Za-z]/,tf=/[\d+\-.A-Za-z]/,rf=/\d/,nf=/^(0x|0X)/,af=/^[0-7]+$/,of=/^\d+$/,sf=/^[\dA-Fa-f]+$/,uf=/[\u0000\u0009\u000A\u000D #%/:?@[\\]]/,lf=/[\u0000\u0009\u000A\u000D #/:?@[\\]]/,_f=/^[\u0000-\u001F ]+|[\u0000-\u001F ]+$/g,cf=/[\u0009\u000A\u000D]/g,hf=function(e,t){var r,n,i;if("["==t.charAt(0)){if("]"!=t.charAt(t.length-1))return"Invalid host";if(!(r=vf(t.slice(1,-1))))return"Invalid host";e.host=r}else if(wf(e)){if(t=function(e){var t,r,n=[],i=e.toLowerCase().replace(dh,".").split(".");for(t=0;t<i.length;t++)r=i[t],n.push(vh.test(r)?"xn--"+Eh(r):r);return n.join(".")}(t),uf.test(t))return"Invalid host";if(null===(r=ff(t)))return"Invalid host";e.host=r}else{if(lf.test(t))return"Invalid host";for(r="",n=ks(t),i=0;i<n.length;i++)r+=kf(n[i],yf);e.host=r}},ff=function(e){var t,r,n,i,a,o,s,u=e.split(".");if(u.length&&""==u[u.length-1]&&u.pop(),(t=u.length)>4)return e;for(r=[],n=0;n<t;n++){if(""==(i=u[n]))return e;if(a=10,i.length>1&&"0"==i.charAt(0)&&(a=nf.test(i)?16:8,i=i.slice(8==a?1:2)),""===i)o=0;else{if(!(10==a?of:8==a?af:sf).test(i))return e;o=parseInt(i,a)}r.push(o)}for(n=0;n<t;n++)if(o=r[n],n==t-1){if(o>=Jh(256,5-t))return null}else if(o>255)return null;for(s=r.pop(),n=0;n<r.length;n++)s+=r[n]*Jh(256,3-n);return s},vf=function(e){var t,r,n,i,a,o,s,u=[0,0,0,0,0,0,0,0],l=0,_=null,c=0,h=function(){return e.charAt(c)};if(":"==h()){if(":"!=e.charAt(1))return;c+=2,_=++l}for(;h();){if(8==l)return;if(":"!=h()){for(t=r=0;r<4&&sf.test(h());)t=16*t+parseInt(h(),16),c++,r++;if("."==h()){if(0==r)return;if(c-=r,l>6)return;for(n=0;h();){if(i=null,n>0){if(!("."==h()&&n<4))return;c++}if(!rf.test(h()))return;for(;rf.test(h());){if(a=parseInt(h(),10),null===i)i=a;else{if(0==i)return;i=10*i+a}if(i>255)return;c++}u[l]=256*u[l]+i,2!=++n&&4!=n||l++}if(4!=n)return;break}if(":"==h()){if(c++,!h())return}else if(h())return;u[l++]=t}else{if(null!==_)return;c++,_=++l}}if(null!==_)for(o=l-_,l=7;0!=l&&o>0;)s=u[l],u[l--]=u[_+o-1],u[_+--o]=s;else if(8!=l)return;return u},df=function(e){var t,r,n,i;if("number"==typeof e){for(t=[],r=0;r<4;r++)t.unshift(e%256),e=$h(e/256);return t.join(".")}if("object"==typeof e){for(t="",n=function(e){for(var t=null,r=1,n=null,i=0,a=0;a<8;a++)0!==e[a]?(i>r&&(t=n,r=i),n=null,i=0):(null===n&&(n=a),++i);return i>r&&(t=n,r=i),t}(e),r=0;r<8;r++)i&&0===e[r]||(i&&(i=!1),n===r?(t+=r?":":"::",i=!0):(t+=e[r].toString(16),r<7&&(t+=":")));return"["+t+"]"}return e},yf={},pf=o_({},yf,{" ":1,'"':1,"<":1,">":1,"`":1}),mf=o_({},pf,{"#":1,"?":1,"{":1,"}":1}),gf=o_({},mf,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),kf=function(e,t){var r=Xh(e,0);return r>32&&r<127&&!m(t,e)?e:encodeURIComponent(e)},Ef={ftp:21,file:null,http:80,https:443,ws:80,wss:443},wf=function(e){return m(Ef,e.scheme)},bf=function(e){return""!=e.username||""!=e.password},xf=function(e){return!e.host||e.cannotBeABaseURL||"file"==e.scheme},Af=function(e,t){var r;return 2==e.length&&ef.test(e.charAt(0))&&(":"==(r=e.charAt(1))||!t&&"|"==r)},Tf=function(e){var t;return e.length>1&&Af(e.slice(0,2))&&(2==e.length||"/"===(t=e.charAt(2))||"\\"===t||"?"===t||"#"===t)},If=function(e){var t=e.path,r=t.length;!r||"file"==e.scheme&&1==r&&Af(t[0],!0)||t.pop()},Mf=function(e){return"."===e||"%2e"===e.toLowerCase()},Sf={},Lf={},Pf={},Rf={},Cf={},Of={},Ff={},Nf={},Df={},Vf={},Uf={},Bf={},Gf={},zf={},jf={},qf={},Yf={},Xf={},Hf={},Wf={},Zf={},Qf=function(e,t,r,n){var i,a,o,s,u,l=r||Sf,_=0,c="",h=!1,f=!1,v=!1;for(r||(e.scheme="",e.username="",e.password="",e.host=null,e.port=null,e.path=[],e.query=null,e.fragment=null,e.cannotBeABaseURL=!1,t=t.replace(_f,"")),t=t.replace(cf,""),i=ks(t);_<=i.length;){switch(a=i[_],l){case Sf:if(!a||!ef.test(a)){if(r)return"Invalid scheme";l=Pf;continue}c+=a.toLowerCase(),l=Lf;break;case Lf:if(a&&(tf.test(a)||"+"==a||"-"==a||"."==a))c+=a.toLowerCase();else{if(":"!=a){if(r)return"Invalid scheme";c="",l=Pf,_=0;continue}if(r&&(wf(e)!=m(Ef,c)||"file"==c&&(bf(e)||null!==e.port)||"file"==e.scheme&&!e.host))return;if(e.scheme=c,r)return void(wf(e)&&Ef[e.scheme]==e.port&&(e.port=null));c="","file"==e.scheme?l=zf:wf(e)&&n&&n.scheme==e.scheme?l=Rf:wf(e)?l=Nf:"/"==i[_+1]?(l=Cf,_++):(e.cannotBeABaseURL=!0,e.path.push(""),l=Hf)}break;case Pf:if(!n||n.cannotBeABaseURL&&"#"!=a)return"Invalid scheme";if(n.cannotBeABaseURL&&"#"==a){e.scheme=n.scheme,e.path=n.path.slice(),e.query=n.query,e.fragment="",e.cannotBeABaseURL=!0,l=Zf;break}l="file"==n.scheme?zf:Of;continue;case Rf:if("/"!=a||"/"!=i[_+1]){l=Of;continue}l=Df,_++;break;case Cf:if("/"==a){l=Vf;break}l=Xf;continue;case Of:if(e.scheme=n.scheme,a==qh)e.username=n.username,e.password=n.password,e.host=n.host,e.port=n.port,e.path=n.path.slice(),e.query=n.query;else if("/"==a||"\\"==a&&wf(e))l=Ff;else if("?"==a)e.username=n.username,e.password=n.password,e.host=n.host,e.port=n.port,e.path=n.path.slice(),e.query="",l=Wf;else{if("#"!=a){e.username=n.username,e.password=n.password,e.host=n.host,e.port=n.port,e.path=n.path.slice(),e.path.pop(),l=Xf;continue}e.username=n.username,e.password=n.password,e.host=n.host,e.port=n.port,e.path=n.path.slice(),e.query=n.query,e.fragment="",l=Zf}break;case Ff:if(!wf(e)||"/"!=a&&"\\"!=a){if("/"!=a){e.username=n.username,e.password=n.password,e.host=n.host,e.port=n.port,l=Xf;continue}l=Vf}else l=Df;break;case Nf:if(l=Df,"/"!=a||"/"!=c.charAt(_+1))continue;_++;break;case Df:if("/"!=a&&"\\"!=a){l=Vf;continue}break;case Vf:if("@"==a){h&&(c="%40"+c),h=!0,o=ks(c);for(var d=0;d<o.length;d++){var y=o[d];if(":"!=y||v){var p=kf(y,gf);v?e.password+=p:e.username+=p}else v=!0}c=""}else if(a==qh||"/"==a||"?"==a||"#"==a||"\\"==a&&wf(e)){if(h&&""==c)return"Invalid authority";_-=ks(c).length+1,c="",l=Uf}else c+=a;break;case Uf:case Bf:if(r&&"file"==e.scheme){l=qf;continue}if(":"!=a||f){if(a==qh||"/"==a||"?"==a||"#"==a||"\\"==a&&wf(e)){if(wf(e)&&""==c)return"Invalid host";if(r&&""==c&&(bf(e)||null!==e.port))return;if(s=hf(e,c))return s;if(c="",l=Yf,r)return;continue}"["==a?f=!0:"]"==a&&(f=!1),c+=a}else{if(""==c)return"Invalid host";if(s=hf(e,c))return s;if(c="",l=Gf,r==Bf)return}break;case Gf:if(!rf.test(a)){if(a==qh||"/"==a||"?"==a||"#"==a||"\\"==a&&wf(e)||r){if(""!=c){var g=parseInt(c,10);if(g>65535)return"Invalid port";e.port=wf(e)&&g===Ef[e.scheme]?null:g,c=""}if(r)return;l=Yf;continue}return"Invalid port"}c+=a;break;case zf:if(e.scheme="file","/"==a||"\\"==a)l=jf;else{if(!n||"file"!=n.scheme){l=Xf;continue}if(a==qh)e.host=n.host,e.path=n.path.slice(),e.query=n.query;else if("?"==a)e.host=n.host,e.path=n.path.slice(),e.query="",l=Wf;else{if("#"!=a){Tf(i.slice(_).join(""))||(e.host=n.host,e.path=n.path.slice(),If(e)),l=Xf;continue}e.host=n.host,e.path=n.path.slice(),e.query=n.query,e.fragment="",l=Zf}}break;case jf:if("/"==a||"\\"==a){l=qf;break}n&&"file"==n.scheme&&!Tf(i.slice(_).join(""))&&(Af(n.path[0],!0)?e.path.push(n.path[0]):e.host=n.host),l=Xf;continue;case qf:if(a==qh||"/"==a||"\\"==a||"?"==a||"#"==a){if(!r&&Af(c))l=Xf;else if(""==c){if(e.host="",r)return;l=Yf}else{if(s=hf(e,c))return s;if("localhost"==e.host&&(e.host=""),r)return;c="",l=Yf}continue}c+=a;break;case Yf:if(wf(e)){if(l=Xf,"/"!=a&&"\\"!=a)continue}else if(r||"?"!=a)if(r||"#"!=a){if(a!=qh&&(l=Xf,"/"!=a))continue}else e.fragment="",l=Zf;else e.query="",l=Wf;break;case Xf:if(a==qh||"/"==a||"\\"==a&&wf(e)||!r&&("?"==a||"#"==a)){if(".."===(u=(u=c).toLowerCase())||"%2e."===u||".%2e"===u||"%2e%2e"===u?(If(e),"/"==a||"\\"==a&&wf(e)||e.path.push("")):Mf(c)?"/"==a||"\\"==a&&wf(e)||e.path.push(""):("file"==e.scheme&&!e.path.length&&Af(c)&&(e.host&&(e.host=""),c=c.charAt(0)+":"),e.path.push(c)),c="","file"==e.scheme&&(a==qh||"?"==a||"#"==a))for(;e.path.length>1&&""===e.path[0];)e.path.shift();"?"==a?(e.query="",l=Wf):"#"==a&&(e.fragment="",l=Zf)}else c+=kf(a,mf);break;case Hf:"?"==a?(e.query="",l=Wf):"#"==a?(e.fragment="",l=Zf):a!=qh&&(e.path[0]+=kf(a,yf));break;case Wf:r||"#"!=a?a!=qh&&("'"==a&&wf(e)?e.query+="%27":e.query+="#"==a?"%23":kf(a,yf)):(e.fragment="",l=Zf);break;case Zf:a!=qh&&(e.fragment+=kf(a,pf))}_++}},Kf=function(e){var t,r,n=oi(this,Kf,"URL"),i=arguments.length>1?arguments[1]:void 0,o=String(e),s=Qh(n,{type:"URL"});if(void 0!==i)if(i instanceof Kf)t=Kh(i);else if(r=Qf(t={},String(i)))throw TypeError(r);if(r=Qf(s,o,null,t))throw TypeError(r);var u=s.searchParams=new Wh,l=Zh(u);l.updateSearchParams(s.query),l.updateURL=function(){s.query=String(u)||null},a||(n.href=Jf.call(n),n.origin=ev.call(n),n.protocol=tv.call(n),n.username=rv.call(n),n.password=nv.call(n),n.host=iv.call(n),n.hostname=av.call(n),n.port=ov.call(n),n.pathname=sv.call(n),n.search=uv.call(n),n.searchParams=lv.call(n),n.hash=_v.call(n))},$f=Kf.prototype,Jf=function(){var e=Kh(this),t=e.scheme,r=e.username,n=e.password,i=e.host,a=e.port,o=e.path,s=e.query,u=e.fragment,l=t+":";return null!==i?(l+="//",bf(e)&&(l+=r+(n?":"+n:"")+"@"),l+=df(i),null!==a&&(l+=":"+a)):"file"==t&&(l+="//"),l+=e.cannotBeABaseURL?o[0]:o.length?"/"+o.join("/"):"",null!==s&&(l+="?"+s),null!==u&&(l+="#"+u),l},ev=function(){var e=Kh(this),t=e.scheme,r=e.port;if("blob"==t)try{return new URL(t.path[0]).origin}catch(e){return"null"}return"file"!=t&&wf(e)?t+"://"+df(e.host)+(null!==r?":"+r:""):"null"},tv=function(){return Kh(this).scheme+":"},rv=function(){return Kh(this).username},nv=function(){return Kh(this).password},iv=function(){var e=Kh(this),t=e.host,r=e.port;return null===t?"":null===r?df(t):df(t)+":"+r},av=function(){var e=Kh(this).host;return null===e?"":df(e)},ov=function(){var e=Kh(this).port;return null===e?"":String(e)},sv=function(){var e=Kh(this),t=e.path;return e.cannotBeABaseURL?t[0]:t.length?"/"+t.join("/"):""},uv=function(){var e=Kh(this).query;return e?"?"+e:""},lv=function(){return Kh(this).searchParams},_v=function(){var e=Kh(this).fragment;return e?"#"+e:""},cv=function(e,t){return{get:e,set:t,configurable:!0,enumerable:!0}};if(a&&nt($f,{href:cv(Jf,(function(e){var t=Kh(this),r=String(e),n=Qf(t,r);if(n)throw TypeError(n);Zh(t.searchParams).updateSearchParams(t.query)})),origin:cv(ev),protocol:cv(tv,(function(e){var t=Kh(this);Qf(t,String(e)+":",Sf)})),username:cv(rv,(function(e){var t=Kh(this),r=ks(String(e));if(!xf(t)){t.username="";for(var n=0;n<r.length;n++)t.username+=kf(r[n],gf)}})),password:cv(nv,(function(e){var t=Kh(this),r=ks(String(e));if(!xf(t)){t.password="";for(var n=0;n<r.length;n++)t.password+=kf(r[n],gf)}})),host:cv(iv,(function(e){var t=Kh(this);t.cannotBeABaseURL||Qf(t,String(e),Uf)})),hostname:cv(av,(function(e){var t=Kh(this);t.cannotBeABaseURL||Qf(t,String(e),Bf)})),port:cv(ov,(function(e){var t=Kh(this);xf(t)||(""==(e=String(e))?t.port=null:Qf(t,e,Gf))})),pathname:cv(sv,(function(e){var t=Kh(this);t.cannotBeABaseURL||(t.path=[],Qf(t,e+"",Yf))})),search:cv(uv,(function(e){var t=Kh(this);""==(e=String(e))?t.query=null:("?"==e.charAt(0)&&(e=e.slice(1)),t.query="",Qf(t,e,Wf)),Zh(t.searchParams).updateSearchParams(t.query)})),searchParams:cv(lv),hash:cv(_v,(function(e){var t=Kh(this);""!=(e=String(e))?("#"==e.charAt(0)&&(e=e.slice(1)),t.fragment="",Qf(t,e,Zf)):t.fragment=null}))}),z($f,"toJSON",(function(){return Jf.call(this)}),{enumerable:!0}),z($f,"toString",(function(){return Jf.call(this)}),{enumerable:!0}),Hh){var hv=Hh.createObjectURL,fv=Hh.revokeObjectURL;hv&&z(Kf,"createObjectURL",(function(e){return hv.apply(Hh,arguments)})),fv&&z(Kf,"revokeObjectURL",(function(e){return fv.apply(Hh,arguments)}))}$t(Kf,"URL"),Re({global:!0,forced:!fh,sham:!a},{URL:Kf});var vv=new RegExp("^data:"),dv=new RegExp("^https?://"),yv=function(){function e(){Ue(this,e)}return Ge(e,null,[{key:"createCanvasContext",value:function(e,t){var r=document.createElement("canvas");return r.width=e,r.height=t,r.getContext("2d")}},{key:"loadImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((function(r,n){var i=new Image;i.onload=function(e){return r(e.target)},i.onerror=function(e){return n(new Error("Failed to load image"))},void 0!==t.crossOrigin&&(i.crossOrigin=t.crossOrigin),e instanceof Blob?i.src=URL.createObjectURL(e):i.src=e}))}},{key:"waitForLoad",value:function(e){return e.src?e.complete?Promise.resolve(e):new Promise((function(t,r){var n=e.onload,i=e.onerror;e.onload=function(e){n&&n(e),t(e.target)},e.onerror=function(e){i&&i(e),r(new Error("Failed to load image"))}})):Promise.reject(new Error("src was not set"))}},{key:"resolveUrl",value:function(e,t){return vv.test(t)||dv.test(t)?t:e+t}}]),e}();yv.SYSTEM_FONT_FAMILY="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'";var pv=function(){function e(){Ue(this,e)}return Ge(e,[{key:"load",value:function(e){return Promise.reject(new Error("Not Implemented"))}},{key:"cancel",value:function(){}},{key:"loadSubResourceSupported",value:function(e){return!1}},{key:"loadSubResource",value:function(e,t){return Promise.reject(new Error("Not Supported"))}},{key:"resolveResourceSupported",value:function(e){return!1}},{key:"resolveResource",value:function(e,t){return Promise.reject(new Error("Not Supported"))}}]),e}(),mv=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Ue(this,t),(r=Ze(this,je(t).call(this)))._url=e;var i=e.lastIndexOf("/");if(-1===i)throw new Error("invalid url");return r._base_url=r._url.substr(0,i+1),r._type=n.type||"json",r._transform=n.transform||gv,r._abort_ctrl=new AbortController,r}return ze(t,e),Ge(t,[{key:"load",value:function(e){var t=this,r=this._transform(this._url,e);return Qc.get(r.url,null,this._make_fetch_params(r)).then((function(e){if(!e.ok)throw new Error(e.statusText);if("json"!==t._type)throw new Error("unsupported type: "+t._type);return e.json()}))}},{key:"cancel",value:function(){this._abort_ctrl.abort()}},{key:"loadSubResourceSupported",value:function(){return!0}},{key:"loadSubResource",value:function(e,t){var r=yv.resolveUrl(this._base_url,e),n=this._transform(r,t);return t===Hd.ResourceType.BINARY?Qc.get(n.url,null,n.init).then((function(e){if(!e.ok)throw new Error(e.statusText);return e})).then((function(e){return e.arrayBuffer()})):t===Hd.ResourceType.IMAGE?yv.loadImage(n.url,{crossOrigin:n.crossOrigin}):Qc.get(n.url,null,this._make_fetch_params(n)).then((function(e){if(!e.ok)throw new Error(e.statusText);return e.json()}))}},{key:"resolveResourceSupported",value:function(){return!0}},{key:"resolveResource",value:function(e){return new t(yv.resolveUrl(this._base_url,e),{transform:this._transform})}},{key:"_make_fetch_params",value:function(e){var t={signal:this._abort_ctrl.signal,credentials:(e.credentials||Qc.CREDENTIAL_MODE.OMIT).credentials};return e.headers&&(t.headers=e.headers),t}},{key:"makeBinaryFetchParams",value:function(e,t){var r=this._transform(e,t),n={credentials:(r.credentials||e_.OMIT).credentials};return r.headers&&(n.headers=r.headers),{url:r.url,init:n}}},{key:"_makeImageLoadParams",value:function(e,t){var r=this._transform(e,t),n={url:r.url};return r.credentials===e_.SAME_ORIGIN?n.crossOrigin="anonymous":r.credentials===e_.INCLUDE&&(n.crossOrigin="use-credentials"),n}}]),t}(pv);function gv(e,t){return{url:e}}var kv=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(Ue(this,e),this._scene=t,!(r instanceof pv))throw new Error("Unsupported Resource Type: "+r);this._resource=r,this._status=e.Status.NOT_LOADED,this._onLoad=n.onLoad||Ev}return Ge(e,[{key:"_setStatus",value:function(e){this._status=e}},{key:"load",value:function(){var t=this;return this.status!==e.Status.NOT_LOADED?Promise.reject(new Error("Illegal Status: "+this.status)):Promise.resolve().then((function(){return t._setStatus(e.Status.LOADING),t.scene.addLoader(t),t._load()})).catch((function(r){throw console.log(r),t._scene.removeLoader(t),t._onLoad(t,!1),t._status!==e.Status.CANCELED&&t._setStatus(e.Status.ABORTED),r})).then((function(r){if(t._scene.removeLoader(t),t._status===e.Status.CANCELED)throw t._onLoad(t,!1),new Error("canceled");return t._setStatus(e.Status.LOADED),t._onLoad(t,!0),r}))}},{key:"_load",value:function(){throw new Error("_load() is not implemented in "+this.constructor.name)}},{key:"cancel",value:function(){this._status!==e.Status.LOADING&&this._status!==e.Status.LOADED||(this._setStatus(e.Status.CANCELED),this._resource.cancel(),this._cancel())}},{key:"_cancel",value:function(){}},{key:"_check_cancel",value:function(){if(this.status===e.Status.CANCELED)throw new Error("canceled")}},{key:"scene",get:function(){return this._scene}},{key:"resource",get:function(){return this._resource}},{key:"status",get:function(){return this._status}}]),e}();function Ev(e,t){}kv.Status={NOT_LOADED:"Not Loaded",LOADING:"Loading",LOADED:"Loaded",CANCELED:"Canceled",ERROR:"ERROR"};var wv=function(){function e(t,r){Ue(this,e),this._scene=t,this._default_scene_index=r}return Ge(e,[{key:"scenes",get:function(){return this._scene}},{key:"default_scene_index",get:function(){return this._default_scene_index}}]),e}(),bv=function(){function e(t,r,n){Ue(this,e);var i=n||{};this._glenv=t,this._handle=this._createTexture(r,i)}return Ge(e,[{key:"dispose",value:function(){this._glenv.context.deleteTexture(this._handle),this._handle=null}},{key:"_createTexture",value:function(t,r){var n=this._glenv.context,i=n.TEXTURE_2D,a=n.createTexture(),o=e._getParameters(n,r);n.bindTexture(i,a);var s=void 0===r.flip_y||r.flip_y;return n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,s),r.usage===e.Usage.COLOR?n.texImage2D(i,0,o.format,1,1,0,o.format,o.type,e._getColorArray(r)):n.texImage2D(i,0,o.format,o.format,o.type,t),s&&n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1),e._generateMipmapQ(n,o)&&n.generateMipmap(i),n.texParameteri(i,n.TEXTURE_MAG_FILTER,o.mag_filter),n.texParameteri(i,n.TEXTURE_MIN_FILTER,o.min_filter),n.texParameteri(i,n.TEXTURE_WRAP_S,o.wrap_s),n.texParameteri(i,n.TEXTURE_WRAP_T,o.wrap_t),n.bindTexture(i,null),a}},{key:"handle",get:function(){return this._handle}}],[{key:"_getParameters",value:function(t,r){var n={format:t.RGBA,type:t.UNSIGNED_BYTE,mag_filter:t.LINEAR,min_filter:t.LINEAR_MIPMAP_LINEAR,wrap_s:t.REPEAT,wrap_t:t.REPEAT};return r.usage===e.Usage.SIMPLETEXT?(n.format=t.ALPHA,n.min_filter=t.LINEAR,n.wrap_s=t.CLAMP_TO_EDGE,n.wrap_t=t.CLAMP_TO_EDGE):r.usage===e.Usage.TEXT?(n.min_filter=t.LINEAR,n.wrap_s=t.CLAMP_TO_EDGE,n.wrap_t=t.CLAMP_TO_EDGE):r.usage===e.Usage.COLOR?(n.mag_filter=t.NEAREST,n.min_filter=t.NEAREST):r.usage===e.Usage.ICON&&(n.min_filter=t.LINEAR,n.wrap_s=t.CLAMP_TO_EDGE,n.wrap_t=t.CLAMP_TO_EDGE),void 0!==r.mag_filter&&(n.mag_filter=r.mag_filter),void 0!==r.min_filter&&(n.min_filter=r.min_filter),void 0!==r.wrap_s&&(n.wrap_s=r.wrap_s),void 0!==r.wrap_t&&(n.wrap_t=r.wrap_t),n}},{key:"_getColorArray",value:function(e){var t=(e.color||[1,1,1,1]).map((function(e){return Math.round(255*e)}));return new Uint8Array(t)}},{key:"_generateMipmapQ",value:function(e,t){var r=t.min_filter;return r==e.NEAREST_MIPMAP_NEAREST||r==e.LINEAR_MIPMAP_NEAREST||r==e.NEAREST_MIPMAP_LINEAR||r==e.LINEAR_MIPMAP_LINEAR}}]),e}();bv.Usage={GENERAL:{id:"GENERAL"},COLOR:{id:"COLOR"},TEXT:{id:"TEXT"},SIMPLETEXT:{id:"SIMPLETEXT"},ICON:{id:"ICON"}};var xv=function(e){function t(e,r,n){return Ue(this,t),Ze(this,je(t).call(this,e,r,n))}return ze(t,e),Ge(t,[{key:"isTranslucent",value:function(e,t){return!1}},{key:"setParameters",value:function(e,t){}},{key:"setObjToClip",value:function(e,r){var n=r.transform,i=t._obj_to_clip;us.mul_GA(e._gocs_to_clip,n,i),this.setMatrix("u_obj_to_clip",i)}},{key:"setObjToView",value:function(e,r){var n=r.transform,i=t._obj_to_view;us.mul_AA(e._gocs_to_view,n,i),this.setMatrix("u_obj_to_view",i)}}]),t}(Vl);xv._obj_to_clip=us.createMatrixf(),xv._obj_to_view=us.createMatrixf();var Av=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e,"attribute vec4 a_position;    // 位置 (モデル座標系)\nattribute vec3 a_normal;      // 法線 (モデル座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\n\nuniform mat4  u_obj_to_clip;  // モデル座標系からクリップ座標系への変換\nuniform mat4  u_obj_to_view;  // モデル座標系から視点座標系への変換\n\nvarying vec3  v_normal;       // 法線 (視点座標系)\nvarying vec2  v_texcoord;     // テクスチャ座標\n\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n    v_normal   =  normalize( vec3( u_obj_to_view * vec4( a_normal, 0.0 ) ) );  // 法線 (視点座標系)\n    v_texcoord = a_texcoord;\n}\n","precision highp float;\n\nvarying vec3  v_normal;    // 法線 (視点座標系)\nvarying vec2  v_texcoord;  // テクスチャ座標\n\nuniform vec3      u_light_dir;   // ライト逆方向 (視点座標系) と強さ\nuniform vec4      u_base_color;  // 基本色係数\nuniform sampler2D u_base_image;  // 基本色画像\n\n\nvoid\nmain()\n{\n    vec3 normal = normalize( v_normal );  // 法線 (視点座標系)\n\n    vec3 dlit = vec3( dot( normal, u_light_dir ) );  // 拡散光の強さ\n\n    gl_FragColor = u_base_color * texture2D( u_base_image, v_texcoord ) * vec4( dlit, 1.0 );\n}\n")))._white_texture=new bv(e,null,{usage:bv.Usage.COLOR,color:[1,1,1,1]}),r.bindProgram(),r.setInteger("u_base_image",t.TEXUNIT_BASE_IMAGE),r}return ze(t,e),Ge(t,[{key:"setParameters",value:function(e,r){var n=r.properties.pbrMetallicRoughness;this.setObjToClip(e,r),this.setObjToView(e,r),this.setVector4("u_base_color",n.baseColorFactor),this.setVector3("u_light_dir",[0,0,1]);var i=this._selectTexture(n.baseColorTexture,this._white_texture);this.bindTexture2D(t.TEXUNIT_BASE_IMAGE,i.handle)}},{key:"_selectTexture",value:function(e,t){return null!==e?e.texture:t}}]),t}(xv);Av.TEXUNIT_BASE_IMAGE=0;var Tv=function(){function e(t,r){Ue(this,e);var n="number"==typeof r?t.gjson.samplers[r]:{};this._magFilter=n.magFilter,this._minFilter=n.minFilter,this._wrapS=void 0!==n.wrapS?n.wrapS:e.WRAP_DEFAULT,this._wrapT=void 0!==n.wrapT?n.wrapT:e.WRAP_DEFAULT}return Ge(e,[{key:"magFilter",get:function(){return this._magFilter}},{key:"minFilter",get:function(){return this._minFilter}},{key:"wrapS",get:function(){return this._wrapS}},{key:"wrapT",get:function(){return this._wrapT}}]),e}();Tv.WRAP_DEFAULT=10497;var Iv=function(){function e(t,r){Ue(this,e);var n=t.gjson.textures[r];this._sampler=new Tv(t,n.sampler),this._source=t.findImage(n.source)}return Ge(e,[{key:"source",get:function(){return this._source}},{key:"sampler",get:function(){return this._sampler}}]),e}(),Mv=function(){function e(t,r){Ue(this,e),this._texture=new Iv(r,t.index),this._texCoord=void 0!==t.texCoord?t.texCoord:0}return Ge(e,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e}},{key:"texCoord",get:function(){return this._texCoord}}]),e}(),Sv=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this,e,r)))._scale=void 0!==e.scale?e.scale:1,n}return ze(t,e),Ge(t,[{key:"texCoord",get:function(){return this._scale}}]),t}(Mv),Lv=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this,e,r)))._strength=void 0!==e.strength?e.strength:1,n}return ze(t,e),Ge(t,[{key:"strength",get:function(){return this._strength}}]),t}(Mv),Pv=function(){function e(t,r){Ue(this,e),this._entries=[],this._name_map={},this._default=null,this._offset_transform=us.setIdentity(us.createMatrix());var n={},i=!0,a=!1,o=void 0;try{for(var s,u=r.scenes[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value,_=new Rv(t,l,n);this._entries.push(_),null!==l.name&&(this._name_map[l.name]=_)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}if(r.default_scene_index>=0){if(!(r.default_scene_index<this._entries.length))throw new Error("default_scene_index is out of range");this._default=this._entries[r.default_scene_index]}else this._entries.length>=1&&(this._default=this._entries[0])}return Ge(e,[{key:"setOffsetTransform",value:function(e){us.copyMatrix(e,this._offset_transform)}},{key:"createPrimitives",value:function(e){var t=this._getEntry(e);if(null===t)return null;var r=[],n=!0,i=!1,a=void 0;try{for(var o,s=t.primitives[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value.fastClone();us.mul_AA(this._offset_transform,u.transform,u.transform),u.properties=Cv.fastCloneProperties(u.properties),r.push(u)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}return r}},{key:"_getEntry",value:function(e){if("number"==typeof e){if(0<=e&&e<this._entries.length)return this._entries[e]}else if("string"==typeof e){if(this._name_map.hasOwnProperty(e))return this._name_map[e]}else if(this._entries.length>0)return this._entries[0];return null}}]),e}(),Rv=function(){function e(t,r,n){Ue(this,e);var i=new Cv(t,r,n);this._primitives=i.primitives}return Ge(e,[{key:"primitives",get:function(){return this._primitives}}]),e}(),Cv=function(){function e(t,r,n){Ue(this,e),n.buffer_map||(n.buffer_map=new Map,n.texture_map=new Map),this._mr_scene=t,this._glenv=t.glenv,this._primitives=[],this._buffer_map=n.buffer_map,this._texture_map=n.texture_map;var i=us.setIdentity(us.createMatrix()),a=!0,o=!1,s=void 0;try{for(var u,l=r.root_nodes[Symbol.iterator]();!(a=(u=l.next()).done);a=!0){var _=u.value;this._addNode(_,i)}}catch(e){o=!0,s=e}finally{try{a||null==l.return||l.return()}finally{if(o)throw s}}}return Ge(e,[{key:"_addNode",value:function(t,r){var n=e._getNodeToScene(t,r);if(null!==t.mesh){var i=!0,a=!1,o=void 0;try{for(var s,u=t.mesh.primitives[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value;this._primitives.push(this._createPrimitive(l,n))}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}}var _=!0,c=!1,h=void 0;try{for(var f,v=t.children[Symbol.iterator]();!(_=(f=v.next()).done);_=!0){var d=f.value;this._addNode(d,n)}}catch(e){c=!0,h=e}finally{try{_||null==v.return||v.return()}finally{if(c)throw h}}}},{key:"_createPrimitive",value:function(e,t){var r=this._createMesh(e),n=this._createMaterial(e),i=new sl(this._glenv,r,n,us.createMatrix(t));return i.pivot=this._createMeshPivot(e),i.bbox=this._createBoundingBox(e),i.properties=this._createProperties(e),i}},{key:"_createMesh",value:function(t){var r=new yl.Initializer(e._convertPrimitiveMode(t),e._calcNumVertices(t)),n=t.attributes;for(var i in n)this._addAttribToInit(r,i,n[i]);var a=t.indices;return null!==a&&this._addIndexToInit(r,a),new yl(this._glenv,r)}},{key:"_addAttribToInit",value:function(t,r,n){var i=this._findMeshBuffer(n.bufferView.buffer,vl.Target.ATTRIBUTE),a=e._NumComponents[n.type],o=e._ComponentType[n.componentType],s={normalized:n.normalized,byte_stride:n.bufferView.byteStride,byte_offset:n.bufferView.byteOffset+n.byteOffset},u=e._VertexAttribId[r]||r;t.addAttribute(u,i,a,o,s)}},{key:"_addIndexToInit",value:function(t,r){var n=this._findMeshBuffer(r.bufferView.buffer,vl.Target.INDEX),i=r.count,a=e._ComponentType[r.componentType],o={byte_offset:r.bufferView.byteOffset+r.byteOffset};t.addIndex(n,i,a,o)}},{key:"_findMeshBuffer",value:function(e,t){var r=this._buffer_map.get(e);return void 0===r&&(r=new vl(this._glenv,e.binary,{target:t}),this._buffer_map.set(e,r)),r}},{key:"_createMaterial",value:function(e){var t=this._mr_scene;return t._ModelEntity_model_material||(t._ModelEntity_model_material=new Av(t.glenv)),t._ModelEntity_model_material}},{key:"_createMeshPivot",value:function(e){var t=null,r=this._createBoundingBox(e);if(null!==r){t=us.createVector3();for(var n=0;n<3;++n)t[n]=(r[0][n]+r[1][n])/2}return t}},{key:"_createBoundingBox",value:function(e){var t=null,r=e.attributes.POSITION;if(void 0!==r){var n=r.min,i=r.max;null!==n&&null!==i&&(t=[us.createVector3(n),us.createVector3(i)])}return t}},{key:"_createProperties",value:function(e){var t=e.material;if(null===t)return{pbrMetallicRoughness:{baseColorFactor:us.createVector4f([1,1,1,1]),baseColorTexture:null,metallicFactor:1,roughnessFactor:1,metallicRoughnessTexture:null},doubleSided:!1,alphaMode:"OPAQUE",alphaCutoff:.5,emissiveFactor:us.createVector3f([0,0,0]),emissiveTexture:null,normalTexture:null,occlusionTexture:null};var r=t.pbrMetallicRoughness;return{pbrMetallicRoughness:{baseColorFactor:us.createVector4f(r.baseColorFactor),baseColorTexture:this._createTextureParam(r.baseColorTexture),metallicFactor:r.metallicFactor,roughnessFactor:r.roughnessFactor,metallicRoughnessTexture:this._createTextureParam(r.metallicRoughnessTexture)},doubleSided:t.doubleSided,alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,emissiveFactor:us.createVector3f(t.emissiveFactor),emissiveTexture:this._createTextureParam(t.emissiveTexture),normalTexture:this._createTextureParam(t.normalTexture),occlusionTexture:this._createTextureParam(t.occlusionTexture)}}},{key:"_createTextureParam",value:function(e){if(null===e)return null;var t={texture:this._findTexture(e.texture),texCoord:e.texCoord};return e instanceof Sv?t.scale=e.scale:e instanceof Lv&&(t.strength=e.strength),t}},{key:"_findTexture",value:function(e){var t=this._texture_map.get(e);if(void 0===t){var r=e.sampler,n=this._glenv.context,i={mag_filter:void 0!==r.magFilter?r.magFilter:n.LINEAR,min_filter:void 0!==r.minFilter?r.minFilter:n.LINEAR_MIPMAP_LINEAR,wrap_s:r.wrapS,wrap_t:r.wrapT,flip_y:!1};t=new bv(this._glenv,e.source.image,i),this._texture_map.set(e,t)}return t}},{key:"primitives",get:function(){return this._primitives}}],[{key:"_getNodeToScene",value:function(e,t){var r=t,n=e.matrix;return null!==n&&(r=us.createMatrix(),us.mul_AA(t,n,r)),r}},{key:"_convertPrimitiveMode",value:function(t){return e._DrawMode[t.mode]}},{key:"_calcNumVertices",value:function(e){var t=e.attributes,r=[];for(var n in t){var i=t[n];r.push(i.count)}return Math.min.apply(null,r)}},{key:"fastCloneProperties",value:function(t){var r=t.pbrMetallicRoughness;return{pbrMetallicRoughness:{baseColorFactor:us.createVector3f(r.baseColorFactor),baseColorTexture:e._fastCloneTextureParam(r.baseColorTexture),metallicFactor:r.metallicFactor,roughnessFactor:r.roughnessFactor,metallicRoughnessTexture:e._fastCloneTextureParam(r.metallicRoughnessTexture)},doubleSided:t.doubleSided,alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,emissiveFactor:us.createVector3f(t.emissiveFactor),emissiveTexture:e._fastCloneTextureParam(t.emissiveTexture),normalTexture:e._fastCloneTextureParam(t.normalTexture),occlusionTexture:e._fastCloneTextureParam(t.occlusionTexture)}}},{key:"_fastCloneTextureParam",value:function(e){if(null===e)return null;var t={texture:e.texture,texCoord:e.texCoord};return"scale"in e?t.scale=e.scale:"strength"in e&&(t.strength=e.strength),t}}]),e}();Cv._DrawMode={0:yl.DrawMode.POINTS,1:yl.DrawMode.LINES,2:yl.DrawMode.LINE_LOOP,3:yl.DrawMode.LINE_STRIP,4:yl.DrawMode.TRIANGLES,5:yl.DrawMode.TRIANGLE_STRIP,6:yl.DrawMode.TRIANGLE_FAN},Cv._NumComponents={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},Cv._ComponentType={5120:yl.ComponentType.BYTE,5121:yl.ComponentType.UNSIGNED_BYTE,5122:yl.ComponentType.SHORT,5123:yl.ComponentType.UNSIGNED_SHORT,5125:yl.ComponentType.UNSIGNED_INT,5126:yl.ComponentType.FLOAT},Cv._VertexAttribId={POSITION:"a_position",NORMAL:"a_normal",TANGENT:"a_tangent",TEXCOORD_0:"a_texcoord",TEXCOORD_1:"a_texcoord1",COLOR_0:"a_color"};var Ov=function(e){function t(e){return Ue(this,t),Ze(this,je(t).call(this,e,"/**\n * 太さ付き線分の頂点シェーダ\n */\n\nattribute vec4 a_position;    // 頂点位置 (モデル座標系)\nattribute vec3 a_direction;   // 線分方向 (モデル座標系) = 終点位置 - 始点位置\nattribute vec2 a_where;       // 線分の4隅指定: 始点左: {-1, 1}, 始点右: {-1, -1}, 終点左: {1, 1}, 終点右: {1, -1}\n\nuniform mat4 u_obj_to_clip;   // モデル座標系からクリップ座標系への変換\nuniform vec3 u_sparam;        // 画面パラメータ: {2/w, 2/h, h/w}\nuniform vec2 u_thickness;     // 線の太さの半分: {u, v}\n\nvec2\noffset( vec4 cpos )\n{\n    vec4 q0 = cpos;\n    q0.y *= u_sparam.z;  // q0 = A * q0\n    vec4 q1 = cpos + u_obj_to_clip * vec4( a_direction, 0 );\n    q1.y *= u_sparam.z;  // q1 = A * q1\n\n    vec2 ds = normalize( q1.xy / q1.w - q0.xy / q0.w );\n    vec2 wt = a_where * u_thickness;\n    return mat2( ds.x, ds.y, -ds.y, ds.x ) * wt;\n}\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += offset( gl_Position ) * u_sparam.xy * gl_Position.w;\n}\n","/**\n * 太さ付き線分のフラグメントシェーダ\n */\n\nprecision mediump float;\n\nuniform vec4 u_color;  // 線の基本色と不透明度\n\nvoid\nmain()\n{\n    gl_FragColor = vec4( u_color.xyz * u_color.w, u_color.w );\n}\n"))}return ze(t,e),Ge(t,[{key:"isTranslucent",value:function(e,r){var n=r.properties;return(void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY)<1}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,i[2]=e._height/e._width,this.setVector3("u_sparam",i);var a=n.width||t.DEFAULT_WIDTH,o=t._thickness;o[0]=a/2,o[1]=a/2,this.setVector2("u_thickness",o);var s=void 0!==n.color?n.color:t.DEFAULT_COLOR,u=void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY,l=t._color;us.copyVector3(s,l),l[3]=u,this.setVector4("u_color",l)}}]),t}(xv);Ov.DEFAULT_WIDTH=1,Ov.DEFAULT_COLOR=us.createVector3f([1,1,1]),Ov.DEFAULT_OPACITY=1,Ov._sparam=us.createVector3f(),Ov._thickness=us.createVector2f(),Ov._color=us.createVector4f();var Fv=function(){function e(){Ue(this,e),this._is_compiled=!1,this._point_array=new Float64Array(0),this._num_points=0,this._node_array=new Uint32Array(0),this._next_node=0}return Ge(e,[{key:"addPoint",value:function(e){this._checkNotCompiled(),this._ensurePointArrayCapacity(2);var t=2*this._num_points;this._point_array[t]=e.longitude,this._point_array[t+1]=e.latitude,this._num_points+=1}},{key:"addPoints",value:function(e,t,r,n){this._checkNotCompiled(),this._ensurePointArrayCapacity(2*n);for(var i=t,a=2*this._num_points,o=this._point_array,s=0;s<n;++s)o[a]=e[i],o[a+1]=e[i+1],i+=r,a+=2;this._num_points+=n}},{key:"compile",value:function(){this._is_compiled||(this._buildCollisionQuadTree(),this._node_array.length>this._next_node&&(this._node_array=new Uint32Array(this._node_array.slice(0,this._next_node))),this._point_array=null,this._is_compiled=!0)}},{key:"intersectsWith",value:function(e){if(0==this._node_array.length)return!1;for(var t=e.getFlatAreaList(),r=0;r<t.length;++r)if(this._intersectsWith(t[r]))return!0;return!1}},{key:"_intersectsWith",value:function(e){for(var t=0,r=this._node_array,n=0;n<e.length;++n){if((t=r[t+e[n]])==Vv)return!0;if(t==Dv)return!1}return!0}},{key:"_checkNotCompiled",value:function(){if(this._is_compiled)throw new Error("EitityRegion is already compiled.")}},{key:"_ensurePointArrayCapacity",value:function(e){var t=2*this._num_points,r=t+e,n=this._point_array.length;if(r>n){var i=Math.max(r,Math.floor(1.5*n)),a=new Float64Array(i);a.set(this._point_array.slice(0,t)),this._point_array=a}}},{key:"_buildCollisionQuadTree",value:function(){for(var e=2*Math.PI,t=this._point_array,r=2*this._num_points,n=0;n<r;){var i=t[n++],a=t[n++],o=i+180*Math.floor((90-a)/360+Math.floor((90+a)/360)),s=o-360-360*Math.floor((o-180)/360),u=90-Math.abs(90-a+360*Math.floor((90+a)/360)),l=s*us.DEGREE/e+.5,_=.5-us.invGudermannian(u*us.DEGREE)/e;this._addCollisionQuadTreeNode(l,_)}this._next_node>0&&(this._setFullNodeRecur(0),this._reduceNodeRecur(0))}},{key:"_addCollisionQuadTreeNode",value:function(e,t){if(!(t<0||t>1))for(var r=1<<Nv,n=us.clamp(Math.floor(e*r),0,r-1),i=Math.min(Math.floor(t*r),r-1),a=this._findRootNode(),o=r>>1;0!=o;o>>=1){var s=0==(n&o)?0:1,u=0==(i&o)?0:2;a=this._findChildNode(a,s+u)}}},{key:"_findRootNode",value:function(){if(0==this._next_node){this._ensureNodeArrayCapacity();for(var e=0;e<4;++e)this._node_array[e]=Dv;this._next_node=4}return 0}},{key:"_findChildNode",value:function(e,t){var r=this._node_array[e+t];if(0==r){this._ensureNodeArrayCapacity(),r=this._next_node;for(var n=0;n<4;++n)this._node_array[r+n]=Dv;this._next_node+=4,this._node_array[e+t]=r}return r}},{key:"_setFullNodeRecur",value:function(e){for(var t=this._node_array,r=!0,n=0;n<4;++n){var i=t[e+n];i!=Dv&&(this._setFullNodeRecur(i),r=!1)}if(r)for(n=0;n<4;++n)t[e+n]=Vv}},{key:"_reduceNodeRecur",value:function(e){for(var t=this._node_array,r=0,n=0;n<4;++n){var i=t[e+n];i==Vv?++r:i!=Dv&&this._reduceNodeRecur(i)&&(t[e+n]=Vv,++r)}return 4==r}},{key:"_ensureNodeArrayCapacity",value:function(){var e=this._next_node,t=e+4,r=this._node_array.length;if(t>r){var n=Math.max(t,Math.floor(1.5*r)),i=new Uint32Array(n);i.set(this._node_array.slice(0,e)),this._node_array=i}}}]),e}(),Nv=20,Dv=0,Vv=4294967295,Uv=function(){function e(){Ue(this,e),this._tree_root=null}return Ge(e,[{key:"getAreaStatus",value:function(e){var t=this._get_area_node(e);return t===xl.AreaStatus.EMPTY||t===xl.AreaStatus.FULL?t:xl.AreaStatus.PARTIAL}},{key:"getAreaContent",value:function(e){var t=this._get_area_node(e);return t===xl.AreaStatus.EMPTY||t===xl.AreaStatus.FULL?t:t.content}},{key:"getInitialContent",value:function(){return null}},{key:"createAreaContent",value:function(e,t,r,n){return xl.AreaStatus.EMPTY}},{key:"notifyForUpdateContent",value:function(){this._tree_root=null}},{key:"_create_area_node",value:function(e,t,r,n){var i=this.createAreaContent(e,t-r,r,n);return i===xl.AreaStatus.EMPTY||i===xl.AreaStatus.FULL?i:new Bv(i)}},{key:"_get_area_node",value:function(e){var t=2,r=-1,n=1;if(null===this._tree_root){var i=this.getInitialContent();this._tree_root=this._create_area_node(r,n,t,i)}for(var a=this._tree_root,o=Math.round(Math.pow(2,e.z)),s=e.x,u=e.y;1!=o&&a!==xl.AreaStatus.EMPTY&&a!==xl.AreaStatus.FULL;){var l=s>=(o/=2)?1:0,_=u>=o?1:0;r+=l*(t/=2),n-=_*t;var c=l+2*_,h=a.children[c];null===h&&(h=this._create_area_node(r,n,t,a.content),a.children[c]=h),s-=l*o,u-=_*o,a=h}return a}}]),e}(),Bv=function e(t){Ue(this,e),this.children=[null,null,null,null],this.content=t},Gv=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this,e,r)))._point_array=new Float64Array(0),n._num_floats=0,n._width=1,n._color=us.createVector3([1,1,1]),n._opacity=1,n.altitude_mode===bl.CLAMP?(n._producer=new jv(We(n)),n._is_flake_mode=!0):(n._producer=new zv(We(n)),n._is_flake_mode=!1),r&&r.json&&n._setupByJson(r.json),n}return ze(t,e),Ge(t,[{key:"getPrimitiveProducer",value:function(){return this._is_flake_mode?null:this._producer}},{key:"getFlakePrimitiveProducer",value:function(){return this._is_flake_mode?this._producer:null}},{key:"onChangeAltitudeMode",value:function(e){this.altitude_mode===bl.CLAMP?(this._producer=new jv(this),this._is_flake_mode=!0):(this._producer=new zv(this),this._is_flake_mode=!1)}},{key:"setLineWidth",value:function(e){this._width=e,this._producer.onChangeProperty()}},{key:"setColor",value:function(e){us.copyVector3(e,this._color),this._producer.onChangeProperty()}},{key:"setOpacity",value:function(e){this._opacity=e,this._producer.onChangeProperty()}},{key:"addPoints",value:function(e){var t=e.length;if(0!=t){var r=this._num_floats+t,n=this._point_array.length;if(r>n){for(var i=new Float64Array(Math.max(r,2*n)),a=this._point_array,o=this._num_floats,s=0;s<o;++s)i[s]=a[s];this._point_array=i}for(var u=this._point_array,l=this._num_floats,_=0;_<t;++_)u[l+_]=e[_];this._num_floats=r,this._producer.onChangePoints()}}},{key:"_getMarkerLineMaterial",value:function(){var e=this.scene;return e._MarkerLineEntity_markerline_material||(e._MarkerLineEntity_markerline_material=new Ov(e.glenv)),e._MarkerLineEntity_markerline_material}},{key:"_setupByJson",value:function(e){this.addPoints(e.points),void 0!==e.line_width&&this.setLineWidth(e.line_width),void 0!==e.color&&this.setColor(e.color),void 0!==e.opacity&&this.setOpacity(e.opacity)}}]),t}(xl),zv=function(e){function t(e){var r;Ue(this,t),(r=Ze(this,je(t).call(this,e)))._transform=us.setIdentity(us.createMatrix()),r._pivot=us.createVector3(),r._bbox=[us.createVector3(),us.createVector3()],r._properties={width:1,color:us.createVector3f(),opacity:1};var n=new sl(e.scene.glenv,null,e._getMarkerLineMaterial(),r._transform);return n.pivot=r._pivot,n.bbox=r._bbox,n.properties=r._properties,r._primitive=n,r._primitives=[n],r._geom_dirty=!0,r}return ze(t,e),Ge(t,[{key:"createRegions",value:function(){var e=new Fv;return e.addPoints(this.entity._point_array,0,3,this._numPoints()),[e]}},{key:"onChangeElevation",value:function(e){this._geom_dirty=!0}},{key:"getPrimitives",value:function(e){return this._num_floats<6?[]:(this._updatePrimitive(),this._primitives)}},{key:"onChangePoints",value:function(){this.needToCreateRegions(),this._geom_dirty=!0}},{key:"onChangeProperty",value:function(){}},{key:"_updatePrimitive",value:function(){if(this._updateProperties(),this._geom_dirty){var e=this.entity,t=this._numPoints(),r=ls.toGocsArray(this._getFlatGeoPoints_with_Absolute(),t,new Float64Array(e._num_floats));this._updateTransformPivotBBox(r,t);var n={vtype:[{name:"a_position",size:3},{name:"a_direction",size:3},{name:"a_where",size:2}],vertices:this._createVertices(r,t),indices:this._createIndices()},i=new yl(e.scene.glenv,n),a=this._primitive;a.mesh&&a.mesh.dispose(),a.mesh=i,this._geom_dirty=!1}}},{key:"_updateProperties",value:function(){var e=this.entity,t=this._properties;t.width=e._width,us.copyVector3(e._color,t.color),t.opacity=e._opacity}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){var e=this.entity,t=e._point_array,r=e._num_floats,n=null;switch(e.altitude_mode){case bl.RELATIVE:var i=this._numPoints();n=new Float64Array(r),e.scene.viewer.getExistingElevations(i,t,0,3,n,2,3);for(var a=0;a<r;a+=3)n[a]=t[a],n[a+1]=t[a+1],n[a+2]+=t[a+2];break;default:n=t}return n}},{key:"_updateTransformPivotBBox",value:function(e,t){var r=e[0],n=e[1],i=e[2],a=this._transform;a[12]=r,a[13]=n,a[14]=i;for(var o=0,s=0,u=0,l=Number.MAX_VALUE,_=Number.MAX_VALUE,c=Number.MAX_VALUE,h=-Number.MAX_VALUE,f=-Number.MAX_VALUE,v=-Number.MAX_VALUE,d=0;d<t;++d){var y=3*d,p=e[y]-r,m=e[y+1]-n,g=e[y+2]-i;o+=p,s+=m,u+=g,p<l&&(l=p),m<_&&(_=m),g<c&&(c=g),p>h&&(h=p),m>f&&(f=m),g>v&&(v=g)}var k=this._pivot;k[0]=o/t,k[1]=s/t,k[2]=u/t;var E=this._bbox,w=E[0],b=E[1];w[0]=l,w[1]=_,w[2]=c,b[0]=h,b[1]=f,b[2]=v}},{key:"_createVertices",value:function(e,t){for(var r=e[0],n=e[1],i=e[2],a=t-1,o=new Float32Array(8*(4*a)),s=0;s<a;++s){var u=3*s,l=e[u]-r,_=e[u+1]-n,c=e[u+2]-i,h=e[u+3]-r,f=e[u+4]-n,v=e[u+5]-i,d=e[u+3]-e[u],y=e[u+4]-e[u+1],p=e[u+5]-e[u+2],m=32*s;o[m]=l,o[m+1]=_,o[m+2]=c,o[m+3]=d,o[m+4]=y,o[m+5]=p,o[m+6]=-1,o[m+7]=1,o[m+8]=l,o[m+9]=_,o[m+10]=c,o[m+11]=d,o[m+12]=y,o[m+13]=p,o[m+14]=-1,o[m+15]=-1,o[m+16]=h,o[m+17]=f,o[m+18]=v,o[m+19]=d,o[m+20]=y,o[m+21]=p,o[m+22]=1,o[m+23]=1,o[m+24]=h,o[m+25]=f,o[m+26]=v,o[m+27]=d,o[m+28]=y,o[m+29]=p,o[m+30]=1,o[m+31]=-1}return o}},{key:"_createIndices",value:function(){for(var e=this._numPoints()-1,t=new Uint32Array(6*e),r=0;r<e;++r){var n=6*r,i=4*r;t[n]=i,t[n+1]=i+1,t[n+2]=i+2,t[n+3]=i+2,t[n+4]=i+1,t[n+5]=i+3}return t}},{key:"_numPoints",value:function(){return Math.floor(this.entity._num_floats/3)}}]),t}(xl.PrimitiveProducer),jv=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e)))._material=e._getMarkerLineMaterial(),r._properties=null,r._area_manager=new Yv(e),r}return ze(t,e),Ge(t,[{key:"getAreaStatus",value:function(e){return this._area_manager.getAreaStatus(e)}},{key:"createMesh",value:function(e,t,r){var n=this._divideXY(e,t);if(0==n.length)return null;var i={vtype:[{name:"a_position",size:3},{name:"a_direction",size:3},{name:"a_where",size:2}],vertices:this._createVertices(e,r,n),indices:this._createIndices(n.length)};return new yl(this.entity.scene.glenv,i)}},{key:"getMaterialAndProperties",value:function(e){if(null===this._properties){var t=this.entity;this._properties={width:t._width,color:us.createVector3f(t._color),opacity:t._opacity}}return{material:this._material,properties:this._properties}}},{key:"onChangePoints",value:function(){this._area_manager.notifyForUpdateContent(),this.notifyForUpdate()}},{key:"onChangeProperty",value:function(){this._properties=null}},{key:"_divideXOnly",value:function(e,t,r){var n=Math.PI*(e.x*t-1),i=Math.PI*((e.x+1)*t-1),a=1<<r,o=(i-n)/a,s=[],u=!0,l=!1,_=void 0;try{for(var c,h=this._area_manager.getAreaContent(e)[Symbol.iterator]();!(u=(c=h.next()).done);u=!0){var f=Qe(c.value,4),v=f[0],d=f[1],y=f[2],p=f[3],m=Qe(v<=y?[v,d,y,p]:[y,p,v,d],4),g=m[0],k=m[1],E=m[2],w=m[3];if(!(E<n||g>=i))if(g!=E){var b=(w-k)/(E-g),x=g,A=k;g<n&&(x=n,A=k+b*(n-g));var T=E,I=w;E>i&&(T=i,I=k+b*(i-g));for(var M=Math.max(Math.ceil((g-n)/o),1),S=Math.min(Math.floor((E-n)/o),a-1),L=x,P=A,R=M;R<=S;++R){var C=n+o*R,O=k+b*(C-g);L==C&&P==O||s.push([L,P,C,O]),L=C,P=O}L==T&&P==I||s.push([L,P,T,I])}else s.push([g,k,E,w])}}catch(e){l=!0,_=e}finally{try{u||null==h.return||h.return()}finally{if(l)throw _}}return s}},{key:"_divideXY",value:function(e,t){var r=2/Math.round(Math.pow(2,e.z)),n=Math.PI*(1-(e.y+1)*r),i=Math.PI*(1-e.y*r),a=1<<t[1],o=(i-n)/a,s=[],u=!0,l=!1,_=void 0;try{for(var c,h=this._divideXOnly(e,r,t[0])[Symbol.iterator]();!(u=(c=h.next()).done);u=!0){var f=Qe(c.value,4),v=f[0],d=f[1],y=f[2],p=f[3],m=Qe(d<=p?[v,d,y,p]:[y,p,v,d],4),g=m[0],k=m[1],E=m[2],w=m[3];if(!(w<n||k>=i))if(k!=w){var b=(E-g)/(w-k),x=g,A=k;k<n&&(x=g+b*(n-k),A=n);var T=E,I=w;w>i&&(T=g+b*(i-k),I=i);for(var M=Math.max(Math.ceil((k-n)/o),1),S=Math.min(Math.floor((w-n)/o),a-1),L=x,P=A,R=M;R<=S;++R){var C=n+o*R,O=g+b*(C-k);L==O&&P==C||s.push([L,P,O,C]),L=O,P=C}L==T&&P==I||s.push([L,P,T,I])}else s.push([g,k,E,w])}}catch(e){l=!0,_=e}finally{try{u||null==h.return||h.return()}finally{if(l)throw _}}return s}},{key:"_createVertices",value:function(e,t,r){for(var n=t.newLinearSampler(),i=Qe(al.getCenter(e,us.createVector3()),3),a=i[0],o=i[1],s=i[2],u=r.length,l=new Float32Array(8*(4*u)),_=0;_<u;++_){var c=Qe(r[_],4),h=c[0],f=c[1],v=c[2],d=c[3],y=Qe(qv(h,f,n),3),p=y[0],m=y[1],g=y[2],k=Qe(qv(v,d,n),3),E=k[0],w=k[1],b=k[2],x=p-a,A=m-o,T=g-s,I=E-a,M=w-o,S=b-s,L=E-p,P=w-m,R=b-g,C=32*_;l[C]=x,l[C+1]=A,l[C+2]=T,l[C+3]=L,l[C+4]=P,l[C+5]=R,l[C+6]=-1,l[C+7]=1,l[C+8]=x,l[C+9]=A,l[C+10]=T,l[C+11]=L,l[C+12]=P,l[C+13]=R,l[C+14]=-1,l[C+15]=-1,l[C+16]=I,l[C+17]=M,l[C+18]=S,l[C+19]=L,l[C+20]=P,l[C+21]=R,l[C+22]=1,l[C+23]=1,l[C+24]=I,l[C+25]=M,l[C+26]=S,l[C+27]=L,l[C+28]=P,l[C+29]=R,l[C+30]=1,l[C+31]=-1}return l}},{key:"_createIndices",value:function(e){for(var t=new Uint32Array(6*e),r=0;r<e;++r){var n=6*r,i=4*r;t[n]=i,t[n+1]=i+1,t[n+2]=i+2,t[n+3]=i+2,t[n+4]=i+1,t[n+5]=i+3}return t}}]),t}(xl.FlakePrimitiveProducer);function qv(e,t,r){var n=e,i=us.gudermannian(t),a=us.EARTH_RADIUS+r.sample(e,t),o=Math.cos(i);return[a*o*Math.cos(n),a*o*Math.sin(n),a*Math.sin(i)]}var Yv=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this)))._entity=e,r}return ze(t,e),Ge(t,[{key:"getInitialContent",value:function(){var e=us.DEGREE,t=Math.PI/2,r=2*Math.PI,n=[],i=this._entity._point_array,a=this._entity._num_floats;if(a<6)return n;for(var o,s,u=i[0]*e,l=i[1]*e,_=3;_<a;_+=3,u=o,l=s)if(o=i[_]*e,s=i[_+1]*e,!(l<=-t||l>=t||s<=-t||s>=t)){var c=u,h=us.invGudermannian(l),f=o,v=us.invGudermannian(s),d=Qe(c<f?[c,h,f,v]:[f,v,c,h],4),y=d[0],p=d[1],m=d[2],g=d[3];if(y<-Math.PI||y>=Math.PI){var k=m-y;((y-=r*(Math.floor((y-Math.PI)/r)+1))<-Math.PI||y>=Math.PI)&&(y=-Math.PI),m=y+k}y==m&&p==g||(n.push([y,p,m,g]),m>Math.PI&&n.push([y-r,p,m-r,g]))}return n}},{key:"createAreaContent",value:function(e,t,r,n){var i=Math.PI*e,a=Math.PI*(e+r),o=Math.PI*t,s=Math.PI*(t+r),u=[],l=!0,_=!1,c=void 0;try{for(var h,f=n[Symbol.iterator]();!(l=(h=f.next()).done);l=!0){var v=h.value,d=Qe(v,4),y=d[0],p=d[1],m=d[2],g=d[3];this._intersect(i,a,o,s,y,p,m,g)&&u.push(v)}}catch(e){_=!0,c=e}finally{try{l||null==f.return||f.return()}finally{if(_)throw c}}return u.length>0?u:xl.AreaStatus.EMPTY}},{key:"_intersect",value:function(e,t,r,n,i,a,o,s){return Math.abs(i-o)<Math.abs(a-s)?this._nhorz_intersect(e,t,r,n,i,a,o,s):this._nhorz_intersect(r,n,e,t,a,i,s,o)}},{key:"_nhorz_intersect",value:function(e,t,r,n,i,a,o,s){var u=Qe(a<s?[a,s]:[s,a],2),l=u[0],_=u[1];if(l>=n||_<r)return!1;var c=i+(o-i)*((r>=_?r:_)-a)/(s-a),h=i+(o-i)*((n<=l?n:l)-a)/(s-a),f=Qe(c<h?[c,h]:[h,c],2),v=f[0],d=f[1];return v<t&&d>=e}}]),t}(Uv),Xv=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e,"/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;    // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;      // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\n\nuniform mat4 u_obj_to_clip;   // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;        // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;      // テキストのテクスチャ座標\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n}","/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;        // テクスチャ座標\nuniform sampler2D u_image;      // 画像\n\nvoid\nmain()\n{\n    gl_FragColor = texture2D( u_image, v_texcoord );\n}"))).bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return ze(t,e),Ge(t,[{key:"isTranslucent",value:function(e,t){return!t.properties.enable_bg}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i);var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle)}}]),t}(xv);Xv.TEXUNIT_IMAGE=0,Xv._sparam=us.createVector2f();var Hv=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e,"/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;    // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;      // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\nattribute vec4 a_color;       // テキストの色と不透明度\n\nuniform mat4 u_obj_to_clip;   // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;        // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;      // テキストのテクスチャ座標\nvarying vec4 v_color;         // テキストの色と不透明度\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n    v_color    = a_color;\n}\n","/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;     // テキストのテクスチャ座標\nvarying vec4 v_color;        // テキストの色と不透明度\n\nuniform sampler2D u_image;   // テキスト画像\n\nvoid\nmain()\n{\n    float level = texture2D( u_image, v_texcoord ).w;  // 輝度\n    float alpha = v_color.w * level;\n    gl_FragColor = vec4( v_color.xyz * alpha, alpha );\n}\n"))).bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return ze(t,e),Ge(t,[{key:"isTranslucent",value:function(e,t){return!0}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i);var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle)}}]),t}(xv);Hv.TEXUNIT_IMAGE=0,Hv._sparam=us.createVector2f();var Wv=function(){function e(t,r,n,i){Ue(this,e),this._r=t,this._g=r,this._b=n,this._a=i}return Ge(e,[{key:"toArray",value:function(){return 0===this._a?[0,0,0,0]:[this.floatToByte(this._r)/this._a,this.floatToByte(this._g)/this._a,this.floatToByte(this._b)/this._a,this._a]}},{key:"toVector4",value:function(){return 0===this._a?[0,0,0,0]:[this._r/this._a,this._g/this._a,this._b/this._a,this._a]}},{key:"toRGBString",value:function(){var e=this.toArray();return"rgba(".concat(Math.round(e[0]),",").concat(Math.round(e[1]),",").concat(Math.round(e[2]),",").concat(e[3],")")}},{key:"floatToByte",value:function(e){return 1===e?255:256*e|0}},{key:"r",get:function(){return this._r}},{key:"g",get:function(){return this._g}},{key:"b",get:function(){return this._b}},{key:"a",get:function(){return this._a}}],[{key:"generateOpacityColor",value:function(t){return new e(t[0],t[1],t[2],1)}},{key:"copyColor",value:function(e,t){return t._r=e._r,t._g=e._g,t._b=e._b,t._a=e._a,t}},{key:"setOpacityColor",value:function(e,t){t._r=e[0],t._g=e[1],t._b=e[2],t._a=1}}]),e}(),Zv=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this,e,r)))._entries=[],n._text_parent_props={font_style:"normal",font_weight:"normal",font_size:t.DEFAULT_FONT_SIZE,font_family:t.DEFAULT_FONT_FAMILY,color:Wv.generateOpacityColor(t.DEFAULT_COLOR),stroke_color:Wv.generateOpacityColor(t.DEFAULT_STROKE_COLOR),stroke_width:t.DEFAULT_STROKE_WIDTH,bg_color:Wv.generateOpacityColor(t.DEFAULT_BG_COLOR),enable_stroke:!1,enable_bg:!1},r&&r.json&&n._setupByJson(r.json),n}return ze(t,e),Ge(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"onChangeAltitudeMode",value:function(e){this._primitive_producer.onChangeAltitudeMode()}},{key:"setFontStyle",value:function(e){this._setValueProperty("font_style",e)}},{key:"setFontWeight",value:function(e){this._setValueProperty("font_weight",e)}},{key:"setFontSize",value:function(e){this._setValueProperty("font_size",e)}},{key:"setFontFamily",value:function(e){this._setValueProperty("font_family",e)}},{key:"setColor",value:function(e){this._setColorProperty("color",e)}},{key:"setStrokeColor",value:function(e){this._setColorProperty("stroke_color",e)}},{key:"setStrokeLineWidth",value:function(e){this._setValueProperty("stroke_width",e)}},{key:"setEnableStroke",value:function(e){this._setValueProperty("enable_stroke",e),this._primitive_producer=new Qv(this)}},{key:"setBackgroundColor",value:function(e){this._setColorProperty("bg_color",e)}},{key:"setEnableBackground",value:function(e){this._setValueProperty("enable_bg",e),this._primitive_producer=new Qv(this)}},{key:"addText",value:function(e,t,r){this._entries.push(new Kv(this,e,t,r)),this._primitive_producer=new Qv(this),this._primitive_producer.onAddTextEntry()}},{key:"_getTextMaterial",value:function(){var e=this.scene;return e._TextEntity_text_material||(e._TextEntity_text_material=new Xv(e.glenv)),e._TextEntity_text_material}},{key:"_getSimpleTextMaterial",value:function(){var e=this.scene;return e._SimpleTextEntity_text_material||(e._SimpleTextEntity_text_material=new Hv(e.glenv)),e._SimpleTextEntity_text_material}},{key:"_setValueProperty",value:function(e,t){var r=this._text_parent_props;r[e]!=t&&(r[e]=t,this._primitive_producer.onChangeParentProperty())}},{key:"_setColorProperty",value:function(e,t){var r=this._text_parent_props[e];r.r==t[0]&&r.g==t[1]&&r.b==t[2]||(Wv.setOpacityColor(t,r),this._primitive_producer.onChangeParentProperty())}},{key:"_setupByJson",value:function(e){var t=new ls,r=!0,n=!1,i=void 0;try{for(var a,o=e.entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;t.setFromArray(s.position),this.addText(s.text,t,s)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}void 0!==e.font_style&&this.setFontStyle(e.font_style),void 0!==e.font_weight&&this.setFontWeight(e.font_weight),void 0!==e.font_size&&this.setFontSize(e.font_size),void 0!==e.font_family&&this.setFontFamily(e.font_family),void 0!==e.color&&this.setColor(e.color),void 0!==e.stroke_color&&this.setStrokeColor(e.stroke_color),void 0!==e.stroke_width&&this.setStrokeLineWidth(e.stroke_width),void 0!==e.enable_stroke&&this.setEnableStroke(e.enable_stroke),void 0!==e.bg_color&&this.setBackgroundColor(e.bg_color),void 0!==e.enable_bg&&this.setEnableBackground(e.enable_bg)}},{key:"_enableStroke",value:function(){return this._text_parent_props.enable_stroke}}]),t}(xl);Zv.DEFAULT_FONT_SIZE=16,Zv.DEFAULT_FONT_FAMILY="sans-serif",Zv.DEFAULT_COLOR=[1,1,1],Zv.DEFAULT_STROKE_COLOR=[0,0,0],Zv.DEFAULT_STROKE_WIDTH=.48,Zv.DEFAULT_BG_COLOR=[.3,.3,.3],Zv.DEFAULT_TEXT_UPPER=1.1,Zv.DEFAULT_TEXT_LOWER=.38,Zv.SAFETY_PIXEL_MARGIN=1,Zv.MAX_IMAGE_WIDTH=4096;var Qv=function(e){function t(e){var r;Ue(this,t),(r=Ze(this,je(t).call(this,e)))._glenv=e.scene.glenv,r._dirty=!0,r._transform=us.setIdentity(us.createMatrix()),r._properties={enable_bg:!1,image:null};var n=null;n=r._isSimpleText()?e._getSimpleTextMaterial():e._getTextMaterial();var i=new sl(r._glenv,null,n,r._transform);return i.properties=r._properties,r._primitive=i,r._primitives=[],r}return ze(t,e),Ge(t,[{key:"createRegions",value:function(){var e=new Fv,t=!0,r=!1,n=void 0;try{for(var i,a=this.entity._entries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value.position;e.addPoint(o)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return[e]}},{key:"onChangeElevation",value:function(e){this._dirty=!0}},{key:"getPrimitives",value:function(e){return this._updatePrimitive()}},{key:"onChangeParentProperty",value:function(){this._dirty=!0}},{key:"onChangeAltitudeMode",value:function(){this._dirty=!0}},{key:"onAddTextEntry",value:function(){this.needToCreateRegions(),this._dirty=!0}},{key:"_updatePrimitive",value:function(){if(!this._dirty)return this._primitives;if(this._updateProperties(),0==this.entity._entries.length)return this._primitives=[],this._dirty=!1,this._primitives;var e=this._createFlatGocsArray();this._updateTransform(e);var t=new $v(this,e);if(!t.isValid())return this._primitives=[],this._dirty=!1,this._primitives;var r=this._properties;r.image&&r.image.dispose(),r.image=t.texture;var n={vtype:this._isSimpleText()?[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2},{name:"a_color",size:4}]:[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2}],vertices:t.vertices,indices:t.indices},i=new yl(this._glenv,n),a=this._primitive;return a.mesh&&a.mesh.dispose(),a.mesh=i,this._primitives=[a],this._dirty=!1,this._primitives}},{key:"_updateProperties",value:function(){var e=this.entity;this._properties.enable_bg=e._text_parent_props.enable_bg}},{key:"_updateTransform",value:function(e){for(var t=this.entity._entries.length,r=0,n=0,i=0,a=0;a<t;++a){var o=3*a;r+=e[o],n+=e[o+1],i+=e[o+2]}var s=this._transform;s[12]=r/t,s[13]=n/t,s[14]=i/t}},{key:"_createFlatGocsArray",value:function(){var e=this.entity._entries.length;return ls.toGocsArray(this._getFlatGeoPoints_with_Absolute(),e,new Float64Array(3*e))}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){for(var e=this.entity,t=e._entries,r=t.length,n=new Float64Array(3*r),i=0;i<r;++i){var a=t[i].position;n[3*i]=a.longitude,n[3*i+1]=a.latitude}switch(e.altitude_mode){case bl.RELATIVE:case bl.CLAMP:if(e.scene.viewer.getExistingElevations(r,n,0,3,n,2,3),e.altitude_mode===bl.RELATIVE)for(var o=0;o<r;++o)n[3*o+2]+=t[o].position.altitude;break;default:for(var s=0;s<r;++s)n[3*s+2]=t[s].position.altitude}return n}},{key:"_isSimpleText",value:function(){var e=this.entity,t=!0;(e._text_parent_props.enable_bg||e._text_parent_props.enable_stroke)&&(t=!1);for(var r=0;t&&e._entries.length>r;){t=!e._entries[r].enable_stroke,r++}return t}}]),t}(xl.PrimitiveProducer),Kv=function(){function e(t,r,n,i){Ue(this,e),this._owner=t,this._text=r,this._position=n.clone(),this._props=Object.assign({},i),this._copyColorProperty("color"),this._copyColorProperty("stroke_color"),this._copyColorProperty("bg_color")}return Ge(e,[{key:"_copyColorProperty",value:function(e){var t=this._props;t.hasOwnProperty(e)&&(t[e]=Wv.generateOpacityColor(t[e]))}},{key:"text",get:function(){return this._text}},{key:"position",get:function(){return this._position}},{key:"size",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.font_size||t.font_size}},{key:"color",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.color||t.color}},{key:"font",get:function(){var e=this._props,t=this._owner._text_parent_props,r=e.font_style||t.font_style,n=e.font_weight||t.font_weight,i=e.font_family||t.font_family;return r+" normal "+n+" "+this.size+"px "+i}},{key:"stroke_color",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.stroke_color||t.stroke_color}},{key:"stroke_width",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.stroke_width||t.stroke_width}},{key:"enable_stroke",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.enable_stroke||t.enable_stroke}},{key:"bg_color",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.bg_color||t.bg_color}},{key:"enable_background",get:function(){return this._owner._text_parent_props.enable_bg}}]),e}(),$v=function(){function e(t,r){Ue(this,e),this._owner=t,this._items=this._createItemList(),this._is_valid=!0;var n=this._createRowLayouts();if(0!=n.length){var i=this._setupLocation(n);this._isSimpleTextWithAllItems(this._items)?(this._texture=this._createTextureForSimple(i.width,i.height),this._vertices=this._createVerticesForSimple(i.width,i.height,r)):(this._texture=this._createTexture(i.width,i.height),this._vertices=this._createVertices(i.width,i.height,r)),this._indices=this._createIndices()}else this._is_valid=!1}return Ge(e,[{key:"isValid",value:function(){return this._is_valid}},{key:"_createItemList",value:function(){var e=yv.createCanvasContext(1,1),t=[],r=!0,n=!1,i=void 0;try{for(var a,o=this._owner.entity._entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;t.push(new Jv(this,s,e))}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return t}},{key:"_createRowLayouts",value:function(){var e=[].concat(this._items);e.sort((function(e,t){return e.height_pixel-t.height_pixel}));for(var t=[];e.length>0;){var r=new ed(e);r.isValid()&&t.push(r)}return t}},{key:"_createTexture",value:function(e,t){var r=yv.createCanvasContext(e,t);r.textAlign="left",r.textBaseline="alphabetic",r.fillStyle="rgba( 255, 255, 255, 1.0 )";for(var n=this._items,i=0;i<n.length;++i){var a=n[i];a.is_canceled||(a._entry.enable_background&&a.drawRect(r),a.drawText(r),a._entry.enable_stroke&&a.drawStrokeText(r))}var o=this._owner._glenv,s={usage:bv.Usage.TEXT};return new bv(o,r.canvas,s)}},{key:"_createVertices",value:function(e,t,r){for(var n=[],i=this._owner._transform,a=i[12],o=i[13],s=i[14],u=this._items,l=0;l<u.length;++l){var _=u[l];if(!_.is_canceled){var c=3*l,h=r[c]-a,f=r[c+1]-o,v=r[c+2]-s,d=_.pos_x,y=_.pos_y,p=_.upper,m=_.lower,g=_.width,k=1/e,E=1/t;n.push(h,f,v),n.push(-g/2,-m),n.push(d*k,1-(y+m)*E),n.push(h,f,v),n.push(g/2,-m),n.push((d+g)*k,1-(y+m)*E),n.push(h,f,v),n.push(-g/2,p),n.push(d*k,1-(y-p)*E),n.push(h,f,v),n.push(g/2,p),n.push((d+g)*k,1-(y-p)*E)}}return n}},{key:"_createTextureForSimple",value:function(e,t){var r=yv.createCanvasContext(e,t);r.textAlign="left",r.textBaseline="alphabetic",r.fillStyle="rgba( 255, 255, 255, 1.0 )";for(var n=this._items,i=0;i<n.length;++i){var a=n[i];a.is_canceled||a.drawText(r)}var o=this._owner._glenv,s={usage:bv.Usage.SIMPLETEXT};return new bv(o,r.canvas,s)}},{key:"_createVerticesForSimple",value:function(e,t,r){for(var n=[],i=this._owner._transform,a=i[12],o=i[13],s=i[14],u=this._items,l=0;l<u.length;++l){var _=u[l];if(!_.is_canceled){var c=_.entry.color.toVector4(),h=3*l,f=r[h]-a,v=r[h+1]-o,d=r[h+2]-s,y=_.pos_x,p=_.pos_y,m=_.upper,g=_.lower,k=_.width,E=1/e,w=1/t;n.push(f,v,d),n.push(-k/2,-g),n.push(y*E,1-(p+g)*w),n.push(c[0],c[1],c[2],1),n.push(f,v,d),n.push(k/2,-g),n.push((y+k)*E,1-(p+g)*w),n.push(c[0],c[1],c[2],1),n.push(f,v,d),n.push(-k/2,m),n.push(y*E,1-(p-m)*w),n.push(c[0],c[1],c[2],1),n.push(f,v,d),n.push(k/2,m),n.push((y+k)*E,1-(p-m)*w),n.push(c[0],c[1],c[2],1)}}return n}},{key:"_createIndices",value:function(){for(var e=[],t=this._items,r=0;r<t.length;++r){if(!t[r].is_canceled){var n=4*r;e.push(n,n+1,n+2,n+2,n+1,n+3)}}return e}},{key:"_setupLocation",value:function(e){var t=0,r=0;r+=Zv.SAFETY_PIXEL_MARGIN;for(var n=0;n<e.length;++n){var i=e[n];i.locate(r),t=Math.max(i.width_assumed,t),r+=i.height_pixel+Zv.SAFETY_PIXEL_MARGIN}return{width:t,height:r}}},{key:"_isSimpleText",value:function(e){return!e._entry.enable_background&&!e._entry.enable_stroke}},{key:"_isSimpleTextWithAllItems",value:function(e){for(var t=!0,r=0;t&&e.length>r;){var n=e[r];t=this._isSimpleText(n),r++}return t}},{key:"texture",get:function(){return this._texture}},{key:"vertices",get:function(){return this._vertices}},{key:"indices",get:function(){return this._indices}}]),e}(),Jv=function(){function e(t,r,n){Ue(this,e),this._entry=r,this._pos_x=0,this._pos_y=0,n.font=r.font,this._width=n.measureText(r.text).width,this._upper=r.size*Zv.DEFAULT_TEXT_UPPER,this._lower=r.size*Zv.DEFAULT_TEXT_LOWER,this._is_canceled=!1}return Ge(e,[{key:"cancel",value:function(){this._is_canceled=!0}},{key:"locate",value:function(e,t){this._pos_x=e,this._pos_y=t+Math.ceil(this._upper)}},{key:"drawTextOnly",value:function(e){var t=this._entry;e.font=t.font,e.fillText(t.text,this._pos_x,this._pos_y)}},{key:"drawText",value:function(e){var t=this._entry;e.font=t.font,e.fillStyle=t.color.toRGBString(),e.fillText(t.text,this._pos_x,this._pos_y)}},{key:"drawStrokeText",value:function(e){var t=this._entry;e.strokeStyle=t.stroke_color.toRGBString(),e.lineWidth=t.stroke_width,e.lineJoin="round",e.strokeText(t.text,this._pos_x,this._pos_y)}},{key:"drawRect",value:function(e){var t=this._entry;e.fillStyle=t.bg_color.toRGBString(),e.fillRect(this._pos_x-Zv.SAFETY_PIXEL_MARGIN,this._pos_y-this._upper-Zv.SAFETY_PIXEL_MARGIN,this.width_pixel+Zv.SAFETY_PIXEL_MARGIN,this.height_pixel+Zv.SAFETY_PIXEL_MARGIN)}},{key:"entry",get:function(){return this._entry}},{key:"pos_x",get:function(){return this._pos_x}},{key:"pos_y",get:function(){return this._pos_y}},{key:"width",get:function(){return this._width}},{key:"upper",get:function(){return this._upper}},{key:"lower",get:function(){return this._lower}},{key:"width_pixel",get:function(){return Math.ceil(this._width)}},{key:"height_pixel",get:function(){return Math.ceil(this._upper)+Math.ceil(this._lower)}},{key:"is_canceled",get:function(){return this._is_canceled}}]),e}(),ed=function(){function e(t){Ue(this,e);var r=0,n=0,i=[];for(r+=Zv.SAFETY_PIXEL_MARGIN;t.length>0;){var a=t.shift(),o=a.width_pixel+Zv.SAFETY_PIXEL_MARGIN;if(r+o<=Zv.MAX_IMAGE_WIDTH)i.push(a),r+=o,n=Math.max(a.height_pixel,n);else{if(0!=i.length){t.unshift(a);break}a.cancel()}}this._items=i,this._width_assumed=r,this._height_pixel=n}return Ge(e,[{key:"isValid",value:function(){return this._items.length>0}},{key:"locate",value:function(e){var t=this._items,r=0;r+=Zv.SAFETY_PIXEL_MARGIN;for(var n=0;n<t.length;++n){var i=t[n];i.locate(r,e),r+=i.width_pixel+Zv.SAFETY_PIXEL_MARGIN}}},{key:"items",get:function(){return this._items}},{key:"width_assumed",get:function(){return this._width_assumed}},{key:"height_pixel",get:function(){return this._height_pixel}}]),e}(),td=function(e){function t(e,r){var n;if(Ue(this,t),(n=Ze(this,je(t).call(this,e,r)))._position=new ls(0,0,0),n._rotation=us.setIdentity(us.createMatrix()),n._scale=us.createVector3([1,1,1]),n._primitive_producer=new rd(We(n)),n._setupAnimationBindingBlock(),r&&r.json){var i=r.json,a=r.refs||{};n._setupTransform(i),n._setupModelObject(i,a)}return n}return ze(t,e),Ge(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"onChangeAltitudeMode",value:function(e){this._primitive_producer.onChangeAltitudeMode()}},{key:"_setupAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ei.find("number"),n=Ei.find("vector3"),i=Ei.find("matrix"),a=new ls;t.addEntry("position",[n],null,(function(t){a.setFromArray(t),e.setPosition(a)}));var o,s=new _s;t.addEntry("orientation",[i,n],(function(e){return o=Zs.findFirstTypeSupported(e,[i,n])}),(function(t){o===i?e._setRotation(t):(s.heading=t[0],s.tilt=t[1],s.roll=t[2],e.setOrientation(s))}));var u,l=us.createVector3();t.addEntry("scale",[n,r],(function(e){return u=Zs.findFirstTypeSupported(e,[n,r])}),(function(t){u===n?e.setScale(t):(l[0]=t,l[1]=t,l[2]=t,e.setScale(l))}))}},{key:"_setupTransform",value:function(e){var t=e.transform;this.setPosition((new ls).setFromArray(t.position)),this.setOrientation(new _s(t.heading,t.tilt,t.roll));var r=void 0!==t.scale?t.scale:[1,1,1];"number"==typeof r&&(r=[r,r,r]),this.setScale(r)}},{key:"_setupModelObject",value:function(e,t){var r=t[e.ref_model];this._primitive_producer.setModelObject(r,e.index)}},{key:"setPosition",value:function(e){var t=this._position;e.longitude==t.longitude&&e.latitude==t.latitude&&e.altitude==t.altitude||(this._position.assign(e),this._primitive_producer.onChangePosition())}},{key:"setOrientation",value:function(e){e.getTransformMatrix(nd,this._rotation)}},{key:"setScale",value:function(e){us.copyVector3(e,this._scale)}},{key:"_setRotation",value:function(e){us.copyMatrix(e,this._rotation)}},{key:"_getElevation",value:function(){return this.scene.viewer.getExistingElevation(this._position)}}]),t}(xl),rd=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e)))._primitives=[],r._ptoe_array=[],r._abs_position=null,r}return ze(t,e),Ge(t,[{key:"setModelObject",value:function(e,t){var r=e.createPrimitives(t);if(!r)throw new Error("model is not found in ModelContainer");this._primitives=r,this._ptoe_array=r.map((function(e){return us.createMatrix(e.transform)}))}},{key:"createRegions",value:function(){var e=new Fv;return e.addPoint(this.entity._position),[e]}},{key:"onChangeElevation",value:function(e){this._abs_position=null}},{key:"getPrimitives",value:function(e){var t=this.entity;this._updateAbsPosition();for(var r,n,i,a,o,s,u=this._abs_position.getMlocsToGocsMatrix(us.createMatrix()),l=(r=t._rotation,n=t._scale,i=us.createMatrix(),a=n[0],o=n[1],s=n[2],i[0]=r[0]*a,i[1]=r[1]*a,i[2]=r[2]*a,i[3]=0,i[4]=r[4]*o,i[5]=r[5]*o,i[6]=r[6]*o,i[7]=0,i[8]=r[8]*s,i[9]=r[9]*s,i[10]=r[10]*s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i),_=us.mul_AA(u,l,us.createMatrix()),c=this._primitives,h=this._ptoe_array,f=0;f<c.length;++f){var v=c[f],d=h[f];us.mul_AA(_,d,v.transform)}return this._primitives}},{key:"onChangeAltitudeMode",value:function(){this._abs_position=null}},{key:"onChangePosition",value:function(){this.needToCreateRegions(),this._abs_position=null}},{key:"_updateAbsPosition",value:function(){if(null===this._abs_position){var e=this.entity;switch(this._abs_position=e._position.clone(),e.altitude_mode){case bl.RELATIVE:this._abs_position.altitude+=e._getElevation();break;case bl.CLAMP:this._abs_position.altitude=e._getElevation()}}}}]),t}(xl.PrimitiveProducer),nd=us.createVector3([1,1,1]);(0,Oa.exportTypedArrayStaticMethod)("from",Ga,Va);var id=function(e){function t(e){return Ue(this,t),Ze(this,je(t).call(this,e,"/**\n * 多角形の頂点シェーダ\n */\n\nattribute vec4 a_position;   // 位置 (モデル座標系)\nattribute vec3 a_normal;     // 法線 (モデル座標系)\n\nuniform mat4 u_obj_to_clip;  // モデル座標系からクリップ座標系への変換\nuniform mat4 u_obj_to_view;  // モデル座標系から視点座標系への変換\nuniform bool u_lighting;     // 照光の有無\nuniform vec3 u_light_dir;    // ライト逆方向 (視点座標系) と強さ\n\nvarying vec3 v_lit_diffuse;  // 拡散光ライト\n\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n    if ( u_lighting ) {\n        // 法線 (視点座標系)\n        vec3 normal = normalize( vec3( u_obj_to_view * vec4( a_normal, 0.0 ) ) );\n\n        // 拡散光の強さ\n        v_lit_diffuse = vec3( dot( normal, u_light_dir ) );\n    }\n    else {\n        // 照光なしのときは 1 に固定\n        v_lit_diffuse = vec3( 1 );\n    }\n}\n","/**\n * 多角形のフラグメントシェーダ\n */\n\nprecision mediump float;\n\nvarying vec3 v_lit_diffuse;  // 拡散光ライト\n\nuniform vec4 u_color;        // 基本色と不透明度\n\n\nvoid\nmain()\n{\n    vec3  color   = u_color.xyz * v_lit_diffuse;\n    float opacity = u_color.w;\n\n    gl_FragColor = vec4( color * opacity, opacity );\n}\n"))}return ze(t,e),Ge(t,[{key:"isTranslucent",value:function(e,r){var n=r.properties;return(void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY)<1}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r),this.setObjToView(e,r);var i=void 0!==n.color?n.color:t.DEFAULT_COLOR,a=void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY,o=t._color;us.copyVector3(i,o),o[3]=a,this.setVector4("u_color",o),this.setBoolean("u_lighting",n.lighting),this.setVector3("u_light_dir",[0,0,1])}}]),t}(xv);id.DEFAULT_COLOR=us.createVector3f([1,1,1]),id.DEFAULT_OPACITY=1,id._color=us.createVector4f();var ad=function(){function e(t,r,n,i){Ue(this,e),this._points=new Float64Array(2*i),this._polygons=new Set;for(var a=r,o=0,s=0;s<i;++s)this._points[o]=t[a],this._points[o+1]=t[a+1],a+=n,o+=2}return Ge(e,[{key:"addBoundary",value:function(e){this._polygons.add(sd.create(this._points,e))}},{key:"run",value:function(){this._makeYMonotonePolygons();var e=new Uint32Array(3*this._numTriangles()),t=0,r=!0,n=!1,i=void 0;try{for(var a,o=this._polygons[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value,u=this._makeTriangleArray(s);e.set(u,t),t+=u.length}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return e}},{key:"_numTriangles",value:function(){var e=0,t=!0,r=!1,n=void 0;try{for(var i,a=this._polygons[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){e+=i.value.numVertices()-2}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return e}},{key:"_makeYMonotonePolygons",value:function(){for(var e=this._getYOrderedVertices(),t=new ud,r=new _d(this._polygons),n=0;n<e.length;++n){var i=e[n];switch(i.getVertexType()){case"start":var a=i.getFrontEdge();t.addEdge(a,i);break;case"end":var o=i.getBackEdge(),s=t.getHelper(o);"merge"==s.getVertexType()&&r.addDiagonal(i,s),t.removeEdge(o);break;case"split":var u=t.findNearestLeftEdge(i);r.addDiagonal(i,t.getHelper(u)),t.setHelper(u,i);var l=i.getFrontEdge();t.addEdge(l,i);break;case"merge":var _=i.getBackEdge(),c=t.getHelper(_);"merge"==c.getVertexType()&&r.addDiagonal(i,c),t.removeEdge(_);var h=t.findNearestLeftEdge(i),f=t.getHelper(h);"merge"==f.getVertexType()&&r.addDiagonal(i,f),t.setHelper(h,i);break;default:if(i.isRightInner()){var v=i.getBackEdge(),d=t.getHelper(v);"merge"==d.getVertexType()&&r.addDiagonal(i,d),t.removeEdge(v);var y=i.getFrontEdge();t.addEdge(y,i)}else{var p=t.findNearestLeftEdge(i),m=t.getHelper(p);"merge"==m.getVertexType()&&r.addDiagonal(i,m),t.setHelper(p,i)}}}r.splitPolygons()}},{key:"_getYOrderedVertices",value:function(){var e=[],t=!0,r=!1,n=void 0;try{for(var i,a=this._polygons[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;Array.prototype.push.apply(e,o.getVertices())}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return e.sort((function(e,t){return od.comparePositionY(t,e)}))}},{key:"_makeTriangleArray",value:function(e){var t=0,r=new Uint32Array(3*(e.numVertices()-2)),n=new hd,i=0,a=e.getVertices().sort((function(e,t){return od.comparePositionY(t,e)})),o=a[0].prev===a[1];for(n.push(a[i++]),n.push(a[i++]);i<a.length-1;){var s=a[i];if(o?s===n.top.prev:s===n.top.next){for(var u=n.pop();n.size>0;){var l=n.top,_=Qe(o?[u,l]:[l,u],2),c=_[0],h=_[1];if(!od.isCCW(s,c,h))break;r[t++]=s.id,r[t++]=c.id,r[t++]=h.id,u=n.pop()}n.push(u),n.push(s)}else{for(var f=n.pop();n.size>0;){var v=n.pop(),d=Qe(o?[f,v]:[v,f],2),y=d[0],p=d[1];r[t++]=s.id,r[t++]=y.id,r[t++]=p.id,f=v}n.push(a[i-1]),n.push(s),o=!o}++i}for(var m=a[i],g=n.pop();n.size>0;){var k=n.pop(),E=Qe(o?[g,k]:[k,g],2),w=E[0],b=E[1];r[t++]=m.id,r[t++]=w.id,r[t++]=b.id,g=k}return r}}]),e}(),od=function(){function e(t,r,n){Ue(this,e),this.id=t,this.x=r,this.y=n,this.polygon=null,this.next=null,this.prev=null}return Ge(e,[{key:"clone",value:function(){return new e(this.id,this.x,this.y)}},{key:"getVertexType",value:function(){var t=this.prev,r=this.next,n=e.comparePositionY(t,this),i=e.comparePositionY(r,this);if(n>0&&i>0||n<0&&i<0){var a=t.y-this.y,o=this.x-t.x,s=a*(r.x-this.x)+o*(r.y-this.y);return n>0&&i>0?s<0?"merge":"end":s<0?"split":"start"}return"regular"}},{key:"getFrontEdge",value:function(){return this}},{key:"getBackEdge",value:function(){return this.prev}},{key:"isRightInner",value:function(){return e.comparePositionY(this.next,this)<0}}],[{key:"comparePositionY",value:function(e,t){return e.y<t.y||e.y==t.y&&e.x>t.x?-1:e.y>t.y||e.y==t.y&&e.x<t.x?1:0}},{key:"isCCW",value:function(e,t,r){var n=t.x-e.x,i=t.y-e.y,a=r.x-e.x;return n*(r.y-e.y)-i*a>0}}]),e}(),sd=function(){function e(){Ue(this,e),this._first=null}return Ge(e,[{key:"numVertices",value:function(){var e=0,t=this._first;++e;var r=this._first;for(t=t.next;t!==r;t=t.next)++e;return e}},{key:"getVertices",value:function(){var e=[],t=this._first;e.push(t);var r=this._first;for(t=t.next;t!==r;t=t.next)e.push(t);return e}},{key:"_updateVertices",value:function(){var e=this._first;e.polygon=this;var t=this._first;for(e=e.next;e!==t;e=e.next)e.polygon=this}}],[{key:"create",value:function(t,r){var n=new e,i=r[0],a=2*i,o=new od(i,t[a],t[a+1]);n._first=o;for(var s=1;s<r.length;++s){var u=o;i=r[s],o=new od(i,t[a=2*i],t[a+1]),u.next=o,o.prev=u}return n._first.prev=o,o.next=n._first,n._updateVertices(),n}},{key:"createByVertex",value:function(t){var r=new e;return r._first=t,r._updateVertices(),r}}]),e}(),ud=function(){function e(){Ue(this,e),this._edges=new Map}return Ge(e,[{key:"addEdge",value:function(e,t){this._edges.set(e,{helper:t})}},{key:"removeEdge",value:function(e){this._edges.delete(e)}},{key:"setHelper",value:function(e,t){this._edges.get(e).helper=t}},{key:"getHelper",value:function(e){return this._edges.get(e).helper}},{key:"findNearestLeftEdge",value:function(e){var t,r=Number.MAX_VALUE,n=e.x,i=e.y,a=!0,o=!1,s=void 0;try{for(var u,l=this._edges[Symbol.iterator]();!(a=(u=l.next()).done);a=!0){var _=Qe(u.value,1)[0],c=_.x,h=_.y,f=n-(c+(i-h)*((_.next.x-c)/(_.next.y-h)));f>0&&f<r&&(r=f,t=_)}}catch(e){o=!0,s=e}finally{try{a||null==l.return||l.return()}finally{if(o)throw s}}if(void 0===t)throw new Error("Probably a degenerate polygon");return t}}]),e}(),ld=function e(t,r){Ue(this,e),this.v1=t,this.v2=r},_d=function(){function e(t){Ue(this,e),this._polygons=t,this._diagonals=[],this._dmap=new cd}return Ge(e,[{key:"addDiagonal",value:function(e,t){var r=new ld(e,t);this._diagonals.push(r),this._dmap.addDiagonal(r)}},{key:"splitPolygons",value:function(){for(this._shuffleArray(this._diagonals);this._diagonals.length>0;){var e=this._diagonals.pop();this._dmap.removeDiagonal(e);var t=e.v1,r=e.v2,n=Qe(this._splitPolygonHalf(t,r),2),i=n[0],a=n[1],o=Qe(this._splitPolygonHalf(r,t),2),s=o[0],u=o[1],l=t.polygon,_=r.polygon;l===_?(this._polygons.delete(l),this._polygons.add(sd.createByVertex(i)),this._polygons.add(sd.createByVertex(u))):(this._polygons.delete(l),this._polygons.delete(_),this._polygons.add(sd.createByVertex(i))),this._replaceVertexInDiagonals(t,i,u),this._replaceVertexInDiagonals(r,a,s)}}},{key:"_splitPolygonHalf",value:function(e,t){var r=e.clone(),n=t.clone();return r.prev=e.prev,r.next=n,e.prev.next=r,n.prev=r,n.next=t.next,t.next.prev=n,[r,n]}},{key:"_replaceVertexInDiagonals",value:function(e,t,r){var n=!0,i=!1,a=void 0;try{for(var o,s=this._dmap.removeDiagonals(e)[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value,l=u.v1===e?u.v2:u.v1;u.v1=this._testDiagonal(t,l)?t:r,u.v2=l,this._dmap.addDiagonal(u)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}}},{key:"_testDiagonal",value:function(e,t){var r=e.next.x-e.x,n=e.next.y-e.y,i=e.prev.x-e.x,a=e.prev.y-e.y,o=t.x-e.x,s=t.y-e.y,u=r*s-o*n>0,l=i*s-o*a<0;return r*a-i*n>=0?u&&l:u||l}},{key:"_shuffleArray",value:function(e){for(var t=e.length-1;t>0;--t){var r=Math.floor(Math.random()*(t+1)),n=e[t];e[t]=e[r],e[r]=n}}}]),e}(),cd=function(){function e(){Ue(this,e),this._map=new Map}return Ge(e,[{key:"addDiagonal",value:function(e){this._addDiagonalByVertex(e.v1,e),this._addDiagonalByVertex(e.v2,e)}},{key:"removeDiagonal",value:function(e){this._removeDiagonalByVertex(e.v1,e),this._removeDiagonalByVertex(e.v2,e)}},{key:"removeDiagonals",value:function(e){var t=this._map.get(e);if(void 0!==t){var r=t.slice(),n=!0,i=!1,a=void 0;try{for(var o,s=r[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;this.removeDiagonal(u)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}return r}return[]}},{key:"_addDiagonalByVertex",value:function(e,t){var r=this._map.get(e);if(void 0===r)this._map.set(e,[t]);else{if(-1!=r.indexOf(t))throw new Error("Unexpected");if(r.length<1||r.length>2)throw new Error("Unexpected");r.push(t)}}},{key:"_removeDiagonalByVertex",value:function(e,t){var r=this._map.get(e);if(void 0===r)throw new Error("Unexpected");var n=r.indexOf(t);if(-1==n)throw new Error("Unexpected");r.splice(n,1),0==r.length&&this._map.delete(e)}}]),e}(),hd=function(){function e(){Ue(this,e),this._array=new Array}return Ge(e,[{key:"push",value:function(e){this._array.push(e)}},{key:"pop",value:function(){return this._array.pop()}},{key:"size",get:function(){return this._array.length}},{key:"top",get:function(){var e=this._array;return e.length>0?e[e.length-1]:null}}]),e}(),fd=n.isFinite,vd=Number.isFinite||function(e){return"number"==typeof e&&fd(e)};Re({target:"Number",stat:!0},{isFinite:vd});var dd=function(){function e(t){Ue(this,e),this._vertices=Float64Array.from(t),this._num_vertices=this._vertices.length/2}return Ge(e,[{key:"isValid",value:function(){if(this._num_vertices<3)return!1;for(var e=0;e<this._num_vertices;++e){var t=this._vertices[2*e],r=this._vertices[2*e+1];if(!Number.isFinite(t)||!Number.isFinite(r))return!1}for(var n=0;n<this._num_vertices;++n){var i=0!=n?n-1:this._num_vertices-1,a=this._vertices[2*i],o=this._vertices[2*i+1],s=this._vertices[2*n],u=this._vertices[2*n+1];if(a==s&&o==u)return!1}for(var l=0;l<this._num_vertices;++l){var _=this._vertices[2*l],c=this._vertices[2*l+1],h=l==this._num_vertices-1?0:l+1,f=this._vertices[2*h]-_,v=this._vertices[2*h+1]-c,d=0==l?this._num_vertices-1:l-1,y=this._vertices[2*d]-_,p=this._vertices[2*d+1]-c,m=f*p-y*v;if(m<0||0==m&&f*y+v*p>0)return!1}return!0}},{key:"getIntersection",value:function(e){try{return this._clip_by_polygon(e)}catch(e){throw new Error("ConvexPolygon#getIntersection failed")}}},{key:"hasIntersection",value:function(e){try{return null!==this._clip_by_polygon(e)}catch(e){throw new Error("ConvexPolygon#hasIntersection failed")}}},{key:"includes",value:function(e){for(var t=0;t<this._num_vertices;++t)for(var r=0!=t?t-1:this._num_vertices-1,n=this._vertices[2*r],i=this._vertices[2*r+1],a=i-this._vertices[2*t+1],o=this._vertices[2*t]-n,s=n*a+i*o,u=0;u<e._num_vertices;++u){if(e._vertices[2*u]*a+e._vertices[2*u+1]*o<s)return!1}return!0}},{key:"_clip_by_polygon",value:function(e){for(var t=e,r=0;r<this._num_vertices;++r){var n=0!=r?r-1:this._num_vertices-1,i=this._vertices[2*n],a=this._vertices[2*n+1],o=a-this._vertices[2*r+1],s=this._vertices[2*r]-i,u=i*o+a*s;if(null===(t=t._clip_by_halfspace(o,s,u)))break}return t}},{key:"_clip_by_halfspace",value:function(e,t,r){for(var n=Number.MAX_VALUE,i=-Number.MAX_VALUE,a=0;a<this._num_vertices;++a){var o=this._vertices[2*a]*e+this._vertices[2*a+1]*t-r;n=Math.min(n,o),i=Math.max(i,o)}return n>=0?this:i<=0?null:this._clip_by_crossed_halfspace(e,t,r)}},{key:"_clip_by_crossed_halfspace",value:function(t,r,n){var i=Qe(this._get_cross_edges_by_crossed_halfspace_boundary(t,r,n),2),a=i[0],o=i[1],s=[];s.push(a.qx),s.push(a.qy);for(var u=a.ei,l=o.ei,_=u;_!=l;_=(_+1)%this._num_vertices)s.push(this._vertices[2*_]),s.push(this._vertices[2*_+1]);return s.push(o.qx),s.push(o.qy),new e(s)}},{key:"_get_cross_edges_by_crossed_halfspace_boundary",value:function(e,t,r){for(var n=new Array(2),i=0,a=0;a<2;++i){if(i==this._num_vertices)throw new Error("cross edges could not be found");var o=(i+1)%this._num_vertices,s=this._vertices[2*i],u=this._vertices[2*i+1],l=this._vertices[2*o],_=this._vertices[2*o+1],c=s*e+u*t-r,h=l*e+_*t-r;if(c<=0&&0<h||h<=0&&0<c){var f=c/(c-h),v=s+(l-s)*f,d=u+(_-u)*f;n[c<h?0:1]={ei:o,qx:v,qy:d},++a}}return n}},{key:"num_vertices",get:function(){return this._num_vertices}},{key:"vertices",get:function(){return this._vertices}}],[{key:"createByRectangle",value:function(t,r,n,i){return new e([t,r,n,r,n,i,t,i])}}]),e}(),yd=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this,e,r)))._extruded_height=0,n._color=us.createVector3([1,1,1]),n._opacity=1,n._boundaries=[],n._position=null,n.altitude_mode===bl.CLAMP?(n._producer=new md(We(n)),n._is_flake_mode=!0):(n._producer=new pd(We(n)),n._is_flake_mode=!1),r&&r.json&&n._setupByJson(r.json),n}return ze(t,e),Ge(t,[{key:"getPrimitiveProducer",value:function(){return this._is_flake_mode?null:this._producer}},{key:"getFlakePrimitiveProducer",value:function(){return this._is_flake_mode?this._producer:null}},{key:"onChangeAltitudeMode",value:function(e){this.altitude_mode===bl.CLAMP?(this._producer=new md(this),this._is_flake_mode=!0):(this._producer=new pd(this),this._is_flake_mode=!1)}},{key:"setColor",value:function(e){us.copyVector3(e,this._color),this._producer.onChangeProperty()}},{key:"setOpacity",value:function(e){this._opacity=e,this._producer.onChangeProperty()}},{key:"addOuterBoundary",value:function(e){this._addBoundary(e,!1)}},{key:"addInnerBoundary",value:function(e){this._addBoundary(e,!0)}},{key:"_addBoundary",value:function(e,t){this._boundaries.push(new gd(e,t)),this._position=null,this._producer.onChangeBoundary()}},{key:"_getPolygonMaterial",value:function(){var e=this.scene;return e._PolygonEntity_material||(e._PolygonEntity_material=new id(e.glenv)),e._PolygonEntity_material}},{key:"_setupByJson",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=e.boundaries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;"inner"==o.type?this.addInnerBoundary(o.points):this.addOuterBoundary(o.points)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}void 0!==e.extruded_height&&(this.extruded_height=e.extruded_height),void 0!==e.color&&us.copyVector3(e.color,this._color),void 0!==e.opacity&&(this._opacity=e.opacity)}},{key:"_getPosition",value:function(){if(null!==this._position)return this._position;if(0==this._boundaries.length)return null;var e=Number.MAX_VALUE,t=-Number.MAX_VALUE,r=Number.MAX_VALUE,n=-Number.MAX_VALUE,i=!0,a=!1,o=void 0;try{for(var s,u=this._boundaries[Symbol.iterator]();!(i=(s=u.next()).done);i=!0)for(var l=s.value,_=l.num_points,c=l.points,h=0;h<_;++h){var f=c[3*h],v=c[3*h+1];f<e&&(e=f),f>t&&(t=f),v<r&&(r=v),v>n&&(n=v)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}return this._position=new ls((e+t)/2,(r+n)/2),this._position}},{key:"_countNumPointsOnBoundaries",value:function(){var e=0,t=!0,r=!1,n=void 0;try{for(var i,a=this._boundaries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){e+=i.value.num_points}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return e}},{key:"_getCombinedBoundaryPoints",value:function(){var e=new Float64Array(3*this._countNumPointsOnBoundaries()),t=0,r=!0,n=!1,i=void 0;try{for(var a,o=this._boundaries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;e.set(s.points,t),t+=3*s.num_points}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return e}},{key:"_getCombinedBoundary2DPoints",value:function(){var e=new Float64Array(2*this._countNumPointsOnBoundaries()),t=0,r=!0,n=!1,i=void 0;try{for(var a,o=this._boundaries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0)for(var s=a.value,u=3*s.num_points,l=s.points,_=0;_<u;_+=3)e[t++]=l[_],e[t++]=l[_+1]}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return e}},{key:"_createTriangles",value:function(){var e=this._getCombinedBoundary2DPoints(),t=this._countNumPointsOnBoundaries(),r=new ad(e,0,2,t),n=0,i=!0,a=!1,o=void 0;try{for(var s,u=this._boundaries[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){for(var l=s.value.num_points,_=new Uint32Array(l),c=0;c<l;++c)_[c]=n++;r.addBoundary(_)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}try{return r.run()}catch(e){return console.error(e.message),null}}},{key:"extruded_height",set:function(e){this._extruded_height!==e&&(this._extruded_height=e,this._producer.onChangeExtruded())},get:function(){return this._extruded_height}}]),t}(xl),pd=function(e){function t(e){var r;Ue(this,t),(r=Ze(this,je(t).call(this,e)))._status=Ld.INVALID,r._triangles=null,r._transform=us.setIdentity(us.createMatrix()),r._pivot=us.createVector3(),r._bbox=[us.createVector3(),us.createVector3()],r._properties={color:us.createVector3f(),opacity:1,lighting:!1};var n=new sl(e.glenv,null,e._getPolygonMaterial(),r._transform);return n.pivot=r._pivot,n.bbox=r._bbox,n.properties=r._properties,r._primitive=n,r}return ze(t,e),Ge(t,[{key:"needsElevation",value:function(){return this.entity.altitude_mode!==bl.ABSOLUTE}},{key:"createRegions",value:function(){var e=this.entity;if(this._status===Ld.INVALID)return[];var t=new Fv,r=!0,n=!1,i=void 0;try{for(var a,o=e._boundaries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;t.addPoints(s.points,0,3,s.num_points)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return t.addPoint(e._getPosition()),[t]}},{key:"onChangeElevation",value:function(e){this._status===Ld.NORMAL&&(this._status=Ld.MESH_DIRTY)}},{key:"getPrimitives",value:function(e){if(this._status===Ld.INVALID)return[];if(this._status===Ld.TRIANGLE_DIRTY){if(this._triangles=this.entity._createTriangles(),null===this._triangles)return this._primitive.mesh=null,this._status=Ld.INVALID,[];this._updatePrimitiveMesh()}else this._status===Ld.MESH_DIRTY&&this._updatePrimitiveMesh();return this._updatePrimitiveProperties(),this._status=Ld.NORMAL,[this._primitive]}},{key:"onChangeExtruded",value:function(){this._status===Ld.NORMAL&&(this._status=Ld.MESH_DIRTY)}},{key:"onChangeProperty",value:function(){}},{key:"onChangeBoundary",value:function(){this._status=Ld.TRIANGLE_DIRTY,this._triangles=null,this.needToCreateRegions()}},{key:"_updatePrimitiveMesh",value:function(){var e=new kd(this.entity);this._updateTransformPivotBBox(e);var t={vtype:[{name:"a_position",size:3},{name:"a_normal",size:3}],vertices:this._createVertices(e),indices:this._createIndices(e)},r=new yl(this.entity.scene.glenv,t);this._primitive.mesh=r}},{key:"_updateTransformPivotBBox",value:function(e){var t=this._transform;t[12]=e.origin[0],t[13]=e.origin[1],t[14]=e.origin[2];var r=Number.MAX_VALUE,n=Number.MAX_VALUE,i=Number.MAX_VALUE,a=-Number.MAX_VALUE,o=-Number.MAX_VALUE,s=-Number.MAX_VALUE,u=[e.upper];e.lower&&u.push(e.lower);for(var l=0;l<u.length;++l)for(var _=u[l],c=0;c<e.num_points;++c){var h=3*c,f=_[h],v=_[h+1],d=_[h+2];f<r&&(r=f),v<n&&(n=v),d<i&&(i=d),f>a&&(a=f),v>o&&(o=v),d>s&&(s=d)}var y=this._pivot;y[0]=(r+a)/2,y[1]=(n+o)/2,y[2]=(i+s)/2;var p=this._bbox,m=p[0],g=p[1];m[0]=r,m[1]=n,m[2]=i,g[0]=a,g[1]=o,g[2]=s}},{key:"_createVertices",value:function(e){for(var t=6*e.num_points,r=e.lower?4*e.num_points*6:0,n=e.lower?t:0,i=new Float32Array(t+r+n),a=us.normalize3(e.origin,us.createVector3()),o=0;o<e.num_points;++o){var s=3*o,u=e.upper[s],l=e.upper[s+1],_=e.upper[s+2],c=6*o;i[c]=u,i[c+1]=l,i[c+2]=_,Td(a,i,c+3)}if(e.lower){var h=us.createVector3(),f=us.createVector3(),v=us.createVector3(),d=us.createVector3(),y=us.createVector3(),p=0,m=!0,g=!1,k=void 0;try{for(var E,w=this.entity._boundaries[Symbol.iterator]();!(m=(E=w.next()).done);m=!0){for(var b=p+E.value.num_points,x=p;x<b;++x){var A=3*x,T=3*(x+1<b?x+1:p);Ad(e.lower,A,h),Ad(e.lower,T,f),Ad(e.upper,A,v),Ad(e.upper,T,d),Id(h,f,v,y);var I=t+24*x;Td(h,i,I),Td(y,i,I+3),Td(f,i,I+=6),Td(y,i,I+3),Td(v,i,I+=6),Td(y,i,I+3),Td(d,i,I+=6),Td(y,i,I+3)}p=b}}catch(e){g=!0,k=e}finally{try{m||null==w.return||w.return()}finally{if(g)throw k}}}if(e.lower)for(var M=us.scale3(-1,a,us.createVector3()),S=0;S<e.num_points;++S){var L=3*S,P=e.lower[L],R=e.lower[L+1],C=e.lower[L+2],O=t+r+6*S;i[O]=P,i[O+1]=R,i[O+2]=C,Td(M,i,O+3)}return i}},{key:"_createIndices",value:function(e){var t=this._triangles.length/3,r=e.lower?2*e.num_points:0,n=e.lower?t:0,i=new Uint32Array(3*(t+r+n));if(i.set(this._triangles),e.lower)for(var a=e.num_points,o=3*t,s=e.num_points,u=0;u<a;++u,o+=6,s+=4)i[o]=s,i[o+1]=s+1,i[o+2]=s+2,i[o+3]=s+2,i[o+4]=s+1,i[o+5]=s+3;if(e.lower)for(var l=this._triangles.length/3,_=e.num_points+4*e.num_points,c=0;c<l;++c)i[3*(t+r+c)+0]=this._triangles[3*c+0]+_,i[3*(t+r+c)+1]=this._triangles[3*c+2]+_,i[3*(t+r+c)+2]=this._triangles[3*c+1]+_;return i}},{key:"_updatePrimitiveProperties",value:function(){var e=this.entity,t=this._properties;us.copyVector3(e._color,t.color),t.opacity=e._opacity,t.lighting=0!==this.extruded_height}}]),t}(xl.PrimitiveProducer),md=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e)))._material=e._getPolygonMaterial(),r._properties=null,r._area_manager=new Ed(e),r}return ze(t,e),Ge(t,[{key:"getAreaStatus",value:function(e){return this._area_manager.getAreaStatus(e)}},{key:"createMesh",value:function(e,t,r){var n=this._area_manager.getAreaContent(e),i=Math.PI*Math.pow(2,1-e.z),a=e.x*i-Math.PI,o=Math.PI-(e.y+1)*i,s=1<<t[0],u=1<<t[1],l=this._createSubmeshes(a,o,a+i,o+i,s,u,n),_={vtype:[{name:"a_position",size:3},{name:"a_normal",size:3}],vertices:this._createVertices(l,e,r),indices:this._createIndices(l)};return new yl(this.entity.scene.glenv,_)}},{key:"getMaterialAndProperties",value:function(e){if(null===this._properties){var t=this.entity;this._properties={color:us.createVector3f(t._color),opacity:t._opacity,lighting:!1}}return{material:this._material,properties:this._properties}}},{key:"onChangeExtruded",value:function(){}},{key:"onChangeProperty",value:function(){this._properties=null}},{key:"onChangeBoundary",value:function(){this._area_manager.notifyForUpdateContent(),this.notifyForUpdate()}},{key:"_createVertices",value:function(e,t,r){var n=al.getCenter(t,us.createVector3()),i=r.newSampler(t),a=0,o=!0,s=!1,u=void 0;try{for(var l,_=e[Symbol.iterator]();!(o=(l=_.next()).done);o=!0){a+=l.value.getNumVertices()}}catch(e){s=!0,u=e}finally{try{o||null==_.return||_.return()}finally{if(s)throw u}}var c=new Float32Array(6*a),h=0,f=!0,v=!1,d=void 0;try{for(var y,p=e[Symbol.iterator]();!(f=(y=p.next()).done);f=!0){h=y.value.addVertices(n,i,c,h)}}catch(e){v=!0,d=e}finally{try{f||null==p.return||p.return()}finally{if(v)throw d}}return c}},{key:"_createIndices",value:function(e){var t=0,r=!0,n=!1,i=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){t+=a.value.getNumTriangles()}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}var s=new Uint32Array(3*t),u=0,l=0,_=!0,c=!1,h=void 0;try{for(var f,v=e[Symbol.iterator]();!(_=(f=v.next()).done);_=!0){var d=f.value;l=d.addIndices(u,s,l),u+=d.getNumVertices()}}catch(e){c=!0,h=e}finally{try{_||null==v.return||v.return()}finally{if(c)throw h}}return s}},{key:"_createSubmeshes",value:function(e,t,r,n,i,a,o){if(o===xl.AreaStatus.FULL)return[new bd(e,t,r,n,i,a)];if(0==o.length)return[];if(1==i&&1==a){var s=[e,t,r,t,e,n],u=[e,n,r,t,r,n],l=this._create_clipped_polygons_submeshes(s,o),_=this._create_clipped_polygons_submeshes(u,o);return l.concat(_)}if(i>=a){var c=(r-e)/2,h=i/2,f=this._create_submeshes_sp(e,t,e+c,n,h,a,o),v=this._create_submeshes_sp(e+c,t,r,n,h,a,o);return f.concat(v)}var d=(n-t)/2,y=a/2,p=this._create_submeshes_sp(e,t,r,t+d,i,y,o),m=this._create_submeshes_sp(e,t+d,r,n,i,y,o);return p.concat(m)}},{key:"_create_submeshes_sp",value:function(e,t,r,n,i,a,o){var s=dd.createByRectangle(e,t,r,n),u=[],l=!0,_=!1,c=void 0;try{for(var h,f=o[Symbol.iterator]();!(l=(h=f.next()).done);l=!0){var v=h.value;if(v.includes(s)){u=xl.AreaStatus.FULL;break}try{s.hasIntersection(v)&&u.push(v)}catch(e){}}}catch(e){_=!0,c=e}finally{try{l||null==f.return||f.return()}finally{if(_)throw c}}return this._createSubmeshes(e,t,r,n,i,a,u)}},{key:"_create_clipped_polygons_submeshes",value:function(e,t){var r=new dd(e),n=[],i=!0,a=!1,o=void 0;try{for(var s,u=t[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value;try{var _=r.getIntersection(l);null!==_&&n.push(_)}catch(e){}}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}return n.length>0?[new xd(e,n)]:[]}}]),t}(xl.FlakePrimitiveProducer),gd=function(){function e(t,r){Ue(this,e);var n=Math.floor(t.length/3);this._points=new Float64Array(3*n),this._num_points=n;var i,a,o=e.isCCW(t,n);!r&&o||r&&!o?(i=0,a=3):(i=3*(n-1),a=-3);for(var s=0;s<n;++s)this._points[3*s]=t[i],this._points[3*s+1]=t[i+1],this._points[3*s+2]=t[i+2],i+=a}return Ge(e,[{key:"points",get:function(){return this._points}},{key:"num_points",get:function(){return this._num_points}}],[{key:"isCCW",value:function(e,t){for(var r,n=-Number.MAX_VALUE,i=-Number.MAX_VALUE,a=0;a<t;++a){var o=e[3*a],s=e[3*a+1];(s>i||s==i&&o<n)&&(r=a,n=o,i=s)}var u=r==t-1?0:r+1,l=e[3*u],_=e[3*u+1],c=0==r?t-1:r-1,h=e[3*c];return(l-n)*(e[3*c+1]-i)-(h-n)*(_-i)>0}}]),e}(),kd=function e(t){Ue(this,e);var r=t.scene.viewer,n=t.altitude_mode,i=t._getCombinedBoundaryPoints(),a=t._countNumPointsOnBoundaries(),o=Float64Array.from(i);if(n===bl.RELATIVE)for(var s=r.getExistingElevation(t._getPosition()),u=0;u<a;++u){o[3*u+2]+=s}var l=null,_=null;if(0!==t._extruded_height)if(n===bl.CLAMP){l=o,_=Float64Array.from(i);for(var c=0;c<a;++c){_[3*c+2]=0}}else{_=o,l=Float64Array.from(i);for(var h=0;h<a;++h){var f=3*h+2;l[f]=_[f]+t._extruded_height}}else l=o;for(var v=t._getPosition().getAsGocs(us.createVector3()),d=ls.toGocsArray(l,a,new Float64Array(3*a)),y=0;y<a;++y){var p=3*y;d[p]-=v[0],d[p+1]-=v[1],d[p+2]-=v[2]}var m=null;if(_){m=ls.toGocsArray(_,a,new Float64Array(3*a));for(var g=0;g<a;++g){var k=3*g;m[k]-=v[0],m[k+1]-=v[1],m[k+2]-=v[2]}}this.origin=v,this.num_points=a,this.upper=d,this.lower=m},Ed=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this)))._entity=e,r}return ze(t,e),Ge(t,[{key:"getInitialContent",value:function(){for(var e=this._entity._createTriangles()||[],t=e.length,r=this._entity._getCombinedBoundary2DPoints(),n=[],i=0;i<t;i+=3){var a=e[i],o=e[i+1],s=e[i+2];this._add_polygon_to_array(r,a,o,s,n)}return n}},{key:"createAreaContent",value:function(e,t,r,n){var i=Math.PI*e,a=Math.PI*t,o=Math.PI*(e+r),s=Math.PI*(t+r),u=dd.createByRectangle(i,a,o,s),l=[],_=!0,c=!1,h=void 0;try{for(var f,v=n[Symbol.iterator]();!(_=(f=v.next()).done);_=!0){var d=f.value;if(d.includes(u))return xl.AreaStatus.FULL;try{u.hasIntersection(d)&&l.push(d)}catch(e){}}}catch(e){c=!0,h=e}finally{try{_||null==v.return||v.return()}finally{if(c)throw h}}return l.length>0?l:xl.AreaStatus.EMPTY}},{key:"_add_polygon_to_array",value:function(e,t,r,n,i){for(var a=us.DEGREE,o=Math.PI/2,s=2*Math.PI,u=[],l=Number.MAX_VALUE,_=0,c=[t,r,n];_<c.length;_++){var h=c[_],f=e[2*h]*a,v=e[2*h+1]*a;if(Math.abs(v)>=o)return;var d=f,y=us.invGudermannian(v);u.push(d),u.push(y),l=Math.min(d,l)}var p=l-s*(Math.floor((l-Math.PI)/s)+1);(p<-Math.PI||p>=Math.PI)&&(p=-Math.PI);for(var m=-Number.MAX_VALUE,g=0;g<3;++g){var k=2*g,E=p+(u[k]-l);u[k]=E,m=Math.max(E,m)}if(i.push(new dd(u)),m>Math.PI){for(var w=0;w<3;++w){var b=2*w,x=u[b]-s;u[b]=x}i.push(new dd(u))}}}]),t}(Uv),wd=function(){function e(){Ue(this,e)}return Ge(e,[{key:"getNumVertices",value:function(){throw""}},{key:"getNumTriangles",value:function(){throw""}},{key:"addVertices",value:function(e,t,r,n){throw""}},{key:"addIndices",value:function(e,t,r){throw""}}]),e}(),bd=function(e){function t(e,r,n,i,a,o){var s;return Ue(this,t),(s=Ze(this,je(t).call(this)))._x_min=e,s._y_min=r,s._x_max=n,s._y_max=i,s._div_x=a,s._div_y=o,s}return ze(t,e),Ge(t,[{key:"getNumVertices",value:function(){return(this._div_x+1)*(this._div_y+1)}},{key:"getNumTriangles",value:function(){return 2*this._div_x*this._div_y}},{key:"addVertices",value:function(e,t,r,n){for(var i=(this._x_max-this._x_min)/this._div_x,a=(this._y_max-this._y_min)/this._div_y,o=this._div_x+1,s=this._div_y+1,u=n,l=0,_=this._y_min;l<s;++l,_+=a)for(var c=Math.exp(_),h=c*c,f=(h-1)/(h+1),v=2*c/(h+1),d=0,y=this._x_min;d<o;++d,y+=i){var p=Math.sin(y),m=Math.cos(y),g=t.sample(y,_),k=us.EARTH_RADIUS+g,E=v*m,w=v*p,b=f,x=k*E,A=k*w,T=k*b;r[u++]=x-e[0],r[u++]=A-e[1],r[u++]=T-e[2],r[u++]=E,r[u++]=w,r[u++]=b}return u}},{key:"addIndices",value:function(e,t,r){for(var n=this._div_x,i=this._div_y,a=r,o=0;o<i;++o)for(var s=0;s<n;++s){var u=e+(n+1)*o+s,l=u+1,_=u+n+1,c=_+1;t[a++]=u,t[a++]=l,t[a++]=_,t[a++]=_,t[a++]=l,t[a++]=c}return a}}]),t}(wd),xd=function(e){function t(e,r){var n;Ue(this,t),(n=Ze(this,je(t).call(this)))._arit_coords=e,n._polygons=r,n._num_vertices=0,n._num_triangles=0;var i=!0,a=!1,o=void 0;try{for(var s,u=r[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value;n._num_vertices+=l.num_vertices,n._num_triangles+=l.num_vertices-2}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}return n}return ze(t,e),Ge(t,[{key:"getNumVertices",value:function(){return this._num_vertices}},{key:"getNumTriangles",value:function(){return this._num_triangles}},{key:"addVertices",value:function(e,t,r,n){var i=this._get_elevation_plane(t),a=n,o=!0,s=!1,u=void 0;try{for(var l,_=this._polygons[Symbol.iterator]();!(o=(l=_.next()).done);o=!0){var c=l.value;a=this._add_polygon_vertices(c,i,e,r,a)}}catch(e){s=!0,u=e}finally{try{o||null==_.return||_.return()}finally{if(s)throw u}}return a}},{key:"addIndices",value:function(e,t,r){var n=r,i=e,a=!0,o=!1,s=void 0;try{for(var u,l=this._polygons[Symbol.iterator]();!(a=(u=l.next()).done);a=!0){var _=u.value;n=this._add_polygon_indices(_,i,t,n),i+=_.num_vertices}}catch(e){o=!0,s=e}finally{try{a||null==l.return||l.return()}finally{if(o)throw s}}return n}},{key:"_add_polygon_vertices",value:function(e,t,r,n,i){for(var a=i,o=e.num_vertices,s=e.vertices,u=0;u<o;++u){var l=s[2*u],_=s[2*u+1],c=Math.exp(_),h=c*c,f=Math.sin(l),v=Math.cos(l),d=(h-1)/(h+1),y=2*c/(h+1),p=-(l*t[0]+_*t[1]+t[3])/t[2],m=us.EARTH_RADIUS+p,g=y*v,k=y*f,E=d,w=m*g,b=m*k,x=m*E;n[a++]=w-r[0],n[a++]=b-r[1],n[a++]=x-r[2],n[a++]=g,n[a++]=k,n[a++]=E}return a}},{key:"_add_polygon_indices",value:function(e,t,r,n){for(var i=n,a=e.num_vertices-2,o=1;o<=a;++o)r[i++]=t,r[i++]=t+o,r[i++]=t+o+1;return i}},{key:"_get_elevation_plane",value:function(e){for(var t=this._arit_coords,r=new Array(3),n=0;n<3;++n){var i=t[2*n],a=t[2*n+1];r[n]=e.sample(i,a)}var o=t[0],s=t[1],u=r[0],l=t[2]-o,_=t[3]-s,c=r[1]-u,h=t[4]-o,f=t[5]-s,v=r[2]-u,d=_*v-c*f,y=c*h-l*v,p=l*f-_*h;return[d,y,p,-o*d-s*y-u*p]}}]),t}(wd);function Ad(e,t,r){r[0]=e[t],r[1]=e[t+1],r[2]=e[t+2]}function Td(e,t,r){t[r]=e[0],t[r+1]=e[1],t[r+2]=e[2]}function Id(e,t,r,n){for(var i=0;i<3;++i)Md[i]=t[i]-e[i],Sd[i]=r[i]-e[i];return us.cross3(Md,Sd,n),us.normalize3(n,n),n}var Md=us.createVector3(),Sd=us.createVector3(),Ld={INVALID:{id:"INVALID"},NORMAL:{id:"NORMAL"},TRIANGLE_DIRTY:{id:"TRIANGLE_DIRTY"},MESH_DIRTY:{id:"MESH_DIRTY"}};za("Int8",(function(e){return function(t,r,n){return e(this,t,r,n)}}));var Pd=function(){function e(t,r){Ue(this,e);var n=t.gjson.bufferViews[r];this._buffer=t.findBuffer(n.buffer),this._byteLength=n.byteLength,this._target=n.target,this._byteOffset=void 0!==n.byteOffset?n.byteOffset:0,this._byteStride=void 0!==n.byteStride?n.byteStride:0}return Ge(e,[{key:"rebuildBySplitter",value:function(e){this._buffer=e,this._byteLength=e.byteLength,this._byteOffset=0}},{key:"buffer",get:function(){return this._buffer}},{key:"byteOffset",get:function(){return this._byteOffset}},{key:"byteStride",get:function(){return this._byteStride}}]),e}(),Rd=function(){function e(t,r){Ue(this,e);var n=t.gjson.accessors[r];this._type=n.type,this._componentType=n.componentType,this._count=n.count,this._bufferView=new Pd(t,n.bufferView),this._byteOffset=void 0!==n.byteOffset?n.byteOffset:0,this._normalized=n.normalized||!1,this._min=n.min?n.min.slice():null,this._max=n.max?n.max.slice():null,this._index=r}return Ge(e,[{key:"getRangeInBuffer",value:function(){var t=this._bufferView,r=e._ComponentData[this._componentType].bytes*e._NumComponents[this._type],n=0==t.byteStride?r:t.byteStride,i=this._byteOffset+t.byteOffset;return{first:i,last:i+n*(this._count-1)+r}}},{key:"modifyByteOrder",value:function(t){var r=e._ComponentData[this._componentType],n=r.bytes;if(1!=n)for(var i=e._NumComponents[this._type],a=this._byteOffset+this._bufferView.byteOffset,o=0==this._bufferView.byteStride?i:this._bufferView.byteStride/n,s=this._bufferView.buffer.binary,u=new DataView(s,a),l=new r.typedarray(s,a),_=r.getcompo,c=n/2,h=a/2,f=o*c,v=0;v<this._count;++v)for(var d=h+v*f,y=v*o,p=0;p<i;++p){var m=d+p*c;if(!t.getBit(m)){var g=y+p,k=_.call(u,g*n,!0);l[g]=k,t.setBit(m,!0)}}}},{key:"isIncluded",value:function(e,t){var r=this._byteOffset+this._bufferView.byteOffset;return e<=r&&r<t}},{key:"rebuildBySplitter",value:function(e,t){this._index=-1;var r=this._byteOffset+this._bufferView.byteOffset;this._byteOffset=r-t,this._bufferView.rebuildBySplitter(e)}},{key:"index",get:function(){return this._index}},{key:"bufferView",get:function(){return this._bufferView}},{key:"type",get:function(){return this._type}},{key:"componentType",get:function(){return this._componentType}},{key:"count",get:function(){return this._count}},{key:"byteOffset",get:function(){return this._byteOffset}},{key:"normalized",get:function(){return this._normalized}},{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}}]),e}();Rd._NumComponents={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Rd._ComponentData={5120:{bytes:1,getcompo:DataView.prototype.getInt8,typedarray:Int8Array},5121:{bytes:1,getcompo:DataView.prototype.getUint8,typedarray:Uint8Array},5122:{bytes:2,getcompo:DataView.prototype.getInt16,typedarray:Int16Array},5123:{bytes:2,getcompo:DataView.prototype.getUint16,typedarray:Uint16Array},5125:{bytes:4,getcompo:DataView.prototype.getUint32,typedarray:Uint32Array},5126:{bytes:4,getcompo:DataView.prototype.getFloat32,typedarray:Float32Array}};var Cd=function(){function e(t,r){Ue(this,e),this._pbrMetallicRoughness={baseColorFactor:[1,1,1,1],baseColorTexture:null,metallicFactor:1,roughnessFactor:1,metallicRoughnessTexture:null},this._doubleSided=!1,this._alphaMode="OPAQUE",this._alphaCutoff=.5,this._emissiveFactor=[0,0,0],this._emissiveTexture=null,this._normalTexture=null,this._occlusionTexture=null;var n=t.gjson.materials[r];this._setupPbrMetallicRoughness(n,t),this._setupGenericParameters(n,t)}return Ge(e,[{key:"_setupPbrMetallicRoughness",value:function(e,t){if(void 0!==e.pbrMetallicRoughness){var r=e.pbrMetallicRoughness,n=this._pbrMetallicRoughness;void 0!==r.baseColorFactor&&(n.baseColorFactor=r.baseColorFactor.slice()),void 0!==r.baseColorTexture&&(n.baseColorTexture=new Mv(r.baseColorTexture,t),t.addTextureInfo(n.baseColorTexture)),void 0!==r.metallicFactor&&(n.metallicFactor=r.metallicFactor),void 0!==r.roughnessFactor&&(n.roughnessFactor=r.roughnessFactor),void 0!==r.metallicRoughnessTexture&&(n.metallicRoughnessTexture=new Mv(r.metallicRoughnessTexture,t),t.addTextureInfo(n.metallicRoughnessTexture))}}},{key:"_setupGenericParameters",value:function(e,t){void 0!==e.doubleSided&&(this._doubleSided=e.doubleSided),void 0!==e.alphaMode&&(this._alphaMode=e.alphaMode),void 0!==e.alphaCutoff&&(this._alphaCutoff=e.alphaCutoff),void 0!==e.emissiveFactor&&(this._emissiveFactor=e.emissiveFactor.slice()),void 0!==e.emissiveTexture&&(this._emissiveTexture=new Mv(e.emissiveTexture,t),t.addTextureInfo(this._emissiveTexture)),void 0!==e.normalTexture&&(this._normalTexture=new Sv(e.normalTexture,t),t.addTextureInfo(this._normalTexture)),void 0!==e.occlusionTexture&&(this._occlusionTexture=new Lv(e.occlusionTexture,t),t.addTextureInfo(this._occlusionTexture))}},{key:"pbrMetallicRoughness",get:function(){return this._pbrMetallicRoughness}},{key:"doubleSided",get:function(){return this._doubleSided}},{key:"alphaMode",get:function(){return this._alphaMode}},{key:"alphaCutoff",get:function(){return this._alphaCutoff}},{key:"emissiveFactor",get:function(){return this._emissiveFactor}},{key:"emissiveTexture",get:function(){return this._emissiveTexture}},{key:"normalTexture",get:function(){return this._normalTexture}},{key:"occlusionTexture",get:function(){return this._occlusionTexture}}]),e}(),Od=function(){function e(t,r){Ue(this,e),this._mode=void 0!==t.mode?t.mode:4,this._attributes={},this._indices=null,this._material=null,this._setupAttributes(t.attributes,r),this._setupIndices(t,r),this._setupMaterial(t,r)}return Ge(e,[{key:"_setupAttributes",value:function(e,t){for(var r in e){var n=new Rd(t,e[r]);this._attributes[r]=n,t.addAccessor(n,"ATTRIBUTE")}}},{key:"_setupIndices",value:function(e,t){if(void 0!==e.indices){var r=new Rd(t,e.indices);this._indices=r,t.addAccessor(r,"INDEX")}}},{key:"_setupMaterial",value:function(e,t){void 0!==e.material&&(this._material=new Cd(t,e.material))}},{key:"mode",get:function(){return this._mode}},{key:"attributes",get:function(){return this._attributes}},{key:"indices",get:function(){return this._indices}},{key:"material",get:function(){return this._material}}]),e}(),Fd=function(){function e(t,r){Ue(this,e),this._primitives=[];for(var n=t.gjson.meshes[r].primitives,i=0;i<n.length;++i){var a=n[i];this._primitives.push(new Od(a,t))}}return Ge(e,[{key:"primitives",get:function(){return this._primitives}}]),e}(),Nd=function(){function e(t,r){Ue(this,e);var n=t.gjson.nodes[r];this._children=[],this._matrix=null,this._mesh=null,this._setupChildren(n,t),this._setupMatrix(n),this._setupMesh(n,t)}return Ge(e,[{key:"_setupChildren",value:function(t,r){var n=t.children;if(void 0!==n)for(var i=0;i<n.length;++i){var a=n[i];this._children.push(new e(r,a))}}},{key:"_setupMatrix",value:function(e){if(e.matrix)this._matrix=us.createMatrix(e.matrix);else if(e.scale||e.rotation||e.translation){var t=Qe(e.scale||[1,1,1],3),r=t[0],n=t[1],i=t[2],a=Qe(e.rotation||[0,0,0,1],4),o=a[0],s=a[1],u=a[2],l=a[3],_=Qe(e.translation||[0,0,0],3),c=_[0],h=_[1],f=_[2];this._matrix=us.createMatrix([(1-2*(s*s+u*u))*r,2*(o*s+u*l)*r,2*(o*u-s*l)*r,0,2*(o*s-u*l)*n,(1-2*(o*o+u*u))*n,2*(o*l+s*u)*n,0,2*(s*l+o*u)*i,2*(s*u-o*l)*i,(1-2*(o*o+s*s))*i,0,c,h,f,1])}}},{key:"_setupMesh",value:function(e,t){var r=e.mesh;void 0!==r&&(this._mesh=new Fd(t,r))}},{key:"children",get:function(){return this._children}},{key:"matrix",get:function(){return this._matrix}},{key:"mesh",get:function(){return this._mesh}}]),e}(),Dd=function(){function e(t,r){Ue(this,e);var n=t.gjson.scenes[r];this._root_nodes=[],this._name=null;var i=!0,a=!1,o=void 0;try{for(var s,u=(n.nodes||[])[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value;this._root_nodes.push(new Nd(t,l))}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}"string"==typeof n.name&&(this._name=n.name)}return Ge(e,[{key:"root_nodes",get:function(){return this._root_nodes}},{key:"name",get:function(){return this._name}}]),e}(),Vd=function(){function e(){Ue(this,e);var t=new Ud(-2,-1),r=new Ud(Math.pow(2,32)+1,Math.pow(2,32)+2);t.next=r,r.prev=t,this._fragments=t}return Ge(e,[{key:"update",value:function(t){var r=t.getRangeInBuffer();this._updateByRange({first:e._floor4(r.first),last:r.last})}},{key:"close",value:function(e){this._fragments=this._fragments.next;for(var t=this._fragments;;t=t.next){if(null===t.next){t.prev.next=null;break}t.buffer=e.createSubBuffer(t.first,t.last)}}},{key:"rebuildAccessor",value:function(e){for(var t=this._fragments;null!==t;t=t.next)if(e.isIncluded(t.first,t.last)){e.rebuildBySplitter(t.buffer,t.first);break}}},{key:"_updateByRange",value:function(e){for(var t=this._fragments;null!==t.next;){if(t.isInside(e)){var r=t,n=t.next,i=new Ud(e.first,e.last);r.next=i,n.prev=i,i.prev=r,i.next=n;break}if(t.isTouch(e)){var a=t.prev,o=t.next;a.next=o,o.prev=a,e=t.mergeRange(e),t=a}else t=t.next}}}],[{key:"_floor4",value:function(e){return 4*Math.floor(e/4)}}]),e}(),Ud=function(){function e(t,r){Ue(this,e),this.first=t,this.last=r,this.buffer=null,this.prev=null,this.next=null}return Ge(e,[{key:"isInside",value:function(e){return this.last<e.first&&e.last<this.next.first}},{key:"isTouch",value:function(e){return this.last>=e.first&&e.last>=this.first}},{key:"mergeRange",value:function(e){return{first:Math.min(this.first,e.first),last:Math.max(this.last,e.last)}}}]),e}(),Bd=function(){function e(t){Ue(this,e),this._length=t,this._array=new Uint32Array(Math.ceil(t/32))}return Ge(e,[{key:"setBit",value:function(e,t){var r=Math.floor(e/32),n=this._array[r],i=1<<e%32;this._array[r]=t?n|i:n&~i}},{key:"getBit",value:function(e){var t=Math.floor(e/32);return 0!=(this._array[t]&1<<e%32)}},{key:"length",get:function(){return this._length}}]),e}(),Gd=function(){function e(t){Ue(this,e),this._buffer=t,this._attrib_accessors=[],this._index_accessors=[]}return Ge(e,[{key:"addAttributeAccessor",value:function(e){this._attrib_accessors.push(e)}},{key:"addIndexAccessor",value:function(e){this._index_accessors.push(e)}},{key:"rewriteByteOrder",value:function(){var e=new Bd(Math.ceil(this._buffer.byteLength/2)),t=!0,r=!1,n=void 0;try{for(var i,a=this._getUnitedOriginalAccessors()[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){i.value.modifyByteOrder(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"splitBufferAndRebuildAccessors",value:function(){this._splitBufferAndRebuildAccessors(this._attrib_accessors),this._splitBufferAndRebuildAccessors(this._index_accessors)}},{key:"_splitBufferAndRebuildAccessors",value:function(t){var r=new Vd,n=!0,i=!1,a=void 0;try{for(var o,s=e._getOriginalAccessors(t)[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;r.update(u)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}r.close(this._buffer);var l=!0,_=!1,c=void 0;try{for(var h,f=t[Symbol.iterator]();!(l=(h=f.next()).done);l=!0){var v=h.value;r.rebuildAccessor(v)}}catch(e){_=!0,c=e}finally{try{l||null==f.return||f.return()}finally{if(_)throw c}}}},{key:"_getUnitedOriginalAccessors",value:function(){return e._getOriginalAccessors(this._attrib_accessors.concat(this._index_accessors))}},{key:"buffer",get:function(){return this._buffer}}],[{key:"_getOriginalAccessors",value:function(e){var t=new Map,r=!0,n=!1,i=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value,u=s.index;t.has(u)||t.set(u,s)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return t.values()}}]),e}(),zd=function(){function e(t){Ue(this,e),this._image=t,this._texinfo_objects=[]}return Ge(e,[{key:"addTextureInfo",value:function(e){this._texinfo_objects.push(e)}},{key:"rebuildTextureInfo",value:function(){var e=this._texinfo_objects;if(!(e.length<=1))for(var t=e[0].texture,r=1;r<e.length;++r)e[r].texture=t}},{key:"image",get:function(){return this._image}}]),e}(),jd=function(){function e(t,r){var n=this;if(Ue(this,e),void 0===t)this._index=-1,this._byteLength=0,this._uri=null,this._binary=null;else{this._index=r;var i=t.gjson.buffers[r];this._byteLength=i.byteLength,void 0!==i.uri?(t.onStartLoadBuffer(),t.loadBinary(i.uri).then((function(e){n._binary=e,t.onFinishLoadBuffer()})).catch((function(e){console.error(e),t.onFinishLoadBuffer(e)}))):(this._uri=null,this._binary=null)}}return Ge(e,[{key:"createSubBuffer",value:function(t,r){var n=new e;return n._byteLength=r-t,n._binary=this._binary.slice(t,r),n}},{key:"index",get:function(){return this._index}},{key:"binary",get:function(){return this._binary}},{key:"byteLength",get:function(){return this._byteLength}}]),e}(),qd=function(){function e(t,r){var n=this;Ue(this,e),this._index=r;var i=t.gjson.images[r];void 0!==i.uri?(t.onStartLoadImage(),t.loadImage(i.uri).then((function(e){n._image=e,t.onFinishLoadImage()})).catch((function(e){t.onFinishLoadImage(e)}))):void 0!==i.bufferView&&(this._bufferView=new Pd(t,i.bufferView)),this._mimeType=i.mimeType,this._image=null}return Ge(e,[{key:"index",get:function(){return this._index}},{key:"image",get:function(){return this._image}}]),e}(),Yd=function(){function e(t,r){Ue(this,e);var n=r||{};this._gjson=t,this._base_resource=n.base_resource,this._binary_type=n.binary_type,this._image_type=n.image_type,this._resolve=null,this._reject=null,this._scenes=[],this._default_scene_index=-1,this._buffer_entries=[],this._image_entries=[],this._body_finished=!1,this._load_count=0,this._load_error=null,this._settled=!1}return Ge(e,[{key:"load",value:function(){var e=this;return new Promise((function(t,r){e._resolve=t,e._reject=r,e._loadVersion().major<2&&e._reject(new Error("glTF version error")),e._loadScenes(),e._loadDefaultSceneIndex(),e._onFinishLoadBody()}))}},{key:"_loadVersion",value:function(){var e=this._gjson.asset.version,t=/^(\d+)\.(\d+)/.exec(e);return{major:Number(t[1]),minor:Number(t[2])}}},{key:"_loadScenes",value:function(){for(var e=(this._gjson.scenes||[]).length,t=[],r=0;r<e;++r)t.push(new Dd(this,r));this._scenes=t}},{key:"_loadDefaultSceneIndex",value:function(){"number"==typeof this._gjson.scene&&(this._default_scene_index=this._gjson.scene)}},{key:"loadBinary",value:function(e){return this._base_resource.loadSubResource(e,this._binary_type)}},{key:"loadImage",value:function(e){return this._base_resource.loadSubResource(e,this._image_type)}},{key:"findBuffer",value:function(e){return void 0===this._buffer_entries[e]&&(this._buffer_entries[e]=new Gd(new jd(this,e))),this._buffer_entries[e].buffer}},{key:"findImage",value:function(e){return void 0===this._image_entries[e]&&(this._image_entries[e]=new zd(new qd(this,e))),this._image_entries[e].image}},{key:"addAccessor",value:function(e,t){var r=this._buffer_entries[e.bufferView.buffer.index];switch(t){case"ATTRIBUTE":r.addAttributeAccessor(e);break;case"INDEX":r.addIndexAccessor(e)}}},{key:"addTextureInfo",value:function(e){var t=e.texture.source;this._image_entries[t.index].addTextureInfo(e)}},{key:"onStartLoadBuffer",value:function(){this._load_count+=1}},{key:"onFinishLoadBuffer",value:function(e){e&&(this._load_error=e),this._load_count-=1,this._onFinishLoadSomething()}},{key:"onStartLoadImage",value:function(){this._load_count+=1}},{key:"onFinishLoadImage",value:function(e){e&&(this._load_error=e),this._load_count-=1,this._onFinishLoadSomething()}},{key:"_onFinishLoadBody",value:function(){this._body_finished=!0,this._onFinishLoadSomething()}},{key:"_onFinishLoadSomething",value:function(){this._settled||(null!==this._load_error?(this._reject(this._load_error),this._settled=!0):this._body_finished&&0==this._load_count&&(this._rewriteBuffersForByteOrder(),this._splitBuffersAndRebuildAccessors(),this._rebuildTextureInfo(),this._resolve(new wv(this._scenes,this._default_scene_index)),this._settled=!0))}},{key:"_rewriteBuffersForByteOrder",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._buffer_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.rewriteByteOrder()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"_splitBuffersAndRebuildAccessors",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._buffer_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.splitBufferAndRebuildAccessors()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"_rebuildTextureInfo",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._image_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.rebuildTextureInfo()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"gjson",get:function(){return this._gjson}}]),e}(),Xd=function(){function e(){Ue(this,e)}return Ge(e,null,[{key:"load",value:function(e,t){return new Yd(e,t).load()}}]),e}(),Hd=function(e){function t(e,r){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(Ue(this,t),r instanceof pv);else{if("string"!=typeof r)throw new Error("Unsupported Resource: "+r);r=new mv(r,{type:"json",transform:i.transform})}return(n=Ze(this,je(t).call(this,e,r,{onLoad:i.callback})))._transform=i.transform||Zd,n._glenv=e.glenv,n._references={},n._finished=!1,n}return ze(t,e),Ge(t,[{key:"getReference",value:function(e){var t=this._references[e];return void 0!==t?t:null}},{key:"_setReference",value:function(e,t){this._references[e]=t}},{key:"_load",value:function(){var e=this;return this._resource.load(Wd.SCENE).then((function(t){return e._check_cancel(),e._load_object(t)}))}},{key:"_load_object",value:function(e){var t=this;return Promise.resolve().then((function(){return t._load_model_register(e)})).then((function(){return t._postload_object(e)}))}},{key:"_postload_object",value:function(e){this.status===kv.Status.LOADING&&this._load_entity_list(e)}},{key:"_load_model_register",value:function(e){var t=e.model_register;if(t){for(var r=Object.keys(t),n=[],i=0;i<r.length;++i){var a=r[i],o=t[a];n.push(this._load_model_container(e,a,o))}return Promise.all(n)}}},{key:"_load_model_container",value:function(e,r,n){var i=this,a=n.link;if(!this._resource.resolveResourceSupported())return Promise.reject(new Error("Sub Resource is not supported"));var o=this._resource.resolveResource(a,Wd.MODEL);return o.load(a,Wd.MODEL).then((function(e){return i._check_cancel(),Xd.load(e,{base_resource:o,binary_type:Wd.BINARY,image_type:Wd.IMAGE})})).then((function(e){var a=new Pv(i._scene,e);if(n.offset_transform){var o=t.parseOffsetTransform(n.offset_transform);a.setOffsetTransform(o)}i._setReference(r,a)}))}},{key:"_load_entity_list",value:function(e){var t=e.entity_list;if(t)for(var r=this._scene,n=0;n<t.length;++n){var i=t[n],a=i.type,o=null;switch(a){case"markerline":o=new Gv(r,{json:i,refs:this._references});break;case"text":o=new Zv(r,{json:i,refs:this._references});break;case"model":o=new td(r,{json:i,refs:this._references});break;case"polygon":o=new yd(r,{json:i,refs:this._references});break;default:console.error("mapray: unknown entity type: "+a)}if(o){r.addEntity(o);var s=i.id;s&&this._setReference(s,o)}}}}],[{key:"parseOffsetTransform",value:function(e){var t=e,r=t.translate||[0,0,0],n=new _s(t.heading,t.tilt,t.roll),i=void 0!==t.scale?t.scale:[1,1,1];"number"==typeof i&&(i=[i,i,i]);var a=us.createMatrix();return n.getTransformMatrix(i,a),a[12]=r[0],a[13]=r[1],a[14]=r[2],a}}]),t}(kv),Wd={SCENE:{id:"SCENE"},MODEL:{id:"MODEL"},BINARY:{id:"BINARY"},IMAGE:{id:"IMAGE"}};function Zd(e,t){return{url:e}}Hd.ResourceType=Wd,Hd._defaultHeaders={};var Qd=function(){function e(t,r){var n;Ue(this,e),this._visibility=r&&r.visibility||!0,this._position=r&&r.position||Kd.TOP_LEFT,n="string"==typeof t?document.getElementById(t):t,this._viewer_container=n,this._container=null,this._is_compact=!1;var i=this;window.addEventListener("resize",(function(){i._sizeChanged()}),!1)}return Ge(e,[{key:"setVisibility",value:function(e){this._visibility=e,this._setContainerVisibility()}},{key:"setPosition",value:function(e){this._position=e,this._deleteContainer(),this.createContainer()}},{key:"_setContainerVisibility",value:function(){this._container&&(this._visibility?this._container.style.visibility="visible":this._container.style.visibility="collapse")}},{key:"_destroy",value:function(){var e=this;window.removeEventListener("resize",(function(){e._sizeChanged()}),!1),this._deleteContainer()}},{key:"_deleteContainer",value:function(){this._container.parentElement.removeChild(this._container),this._container=null}},{key:"_sizeChanged",value:function(){}},{key:"createContainer",value:function(){}}]),e}(),Kd={TOP_LEFT:{id:"top-left"},TOP_RIGHT:{id:"top-right"},BOTTOM_LEFT:{id:"bottom-left"},BOTTOM_RIGHT:{id:"bottom-right"}};Qd._compact_size=500,Qd.ContainerPosition=Kd;var $d=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this,e,r)))._position=r&&r.position||Qd.ContainerPosition.BOTTOM_LEFT,n}return ze(t,e),Ge(t,[{key:"_sizeChanged",value:function(){if(this._container){var e=this._container.children[0];this._container.parentElement.parentElement.clientWidth<Qd._compact_size?e.classList.add("mapray-logo-compact"):e.classList.remove("mapray-logo-compact")}}},{key:"createContainer",value:function(){var e="control-"+this._position.id,t=this._viewer_container.getElementsByClassName(e)[0],r=document.createElement("div");r.className="control";var n=document.createElement("a");n.className="mapray-logo",n.href="https://mapray.com",n.target="_blank",r.appendChild(n),this._container=r,t.appendChild(this._container),this._sizeChanged()}}]),t}(Qd),Jd=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this,e,r)))._position=r&&r.position||Qd.ContainerPosition.BOTTOM_RIGHT,n._attributions=[],r&&r.attributions?n.copyAttributions(r.attributions):n.copyAttributions(t._default_attribution),n}return ze(t,e),Ge(t,[{key:"addAttribution",value:function(e){this._attributions.push(e),this._deleteContainer(),this.createContainer()}},{key:"clearAttribution",value:function(){this._attributions=[],this._deleteContainer(),this.createContainer()}},{key:"_sizeChanged",value:function(){this._container&&(this._container.parentElement.parentElement.clientWidth<Qd._compact_size?this._container.classList.add("mapray-attribution-compact"):this._container.classList.remove("mapray-attribution-compact"))}},{key:"createContainer",value:function(){var e="control-"+this._position.id,t=this._viewer_container.getElementsByClassName(e)[0],r=document.createElement("div");r.classList.add("control"),r.classList.add("mapray-attribution");var n=document.createElement("div");n.classList.add("mapray-attribution-container");var i=!0,a=!1,o=void 0;try{for(var s,u=this._attributions[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var l=s.value;if(l.display){var _=document.createElement("a");l.link&&(_.href=l.link,_.target="_blank");var c=document.createTextNode(l.display);_.appendChild(c),n.appendChild(_)}}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}r.appendChild(n),this._container=r,t.appendChild(this._container),this._sizeChanged()}},{key:"copyAttributions",value:function(e){this._attributions=e.map((function(e){return e}))}}]),t}(Qd);Jd._default_attribution=[{display:"©Mapray",link:"https://mapray.com"},{display:"©JAXA",link:"http://www.jaxa.jp/"},{display:"測量法に基づく国土地理院長承認（複製）H30JHf626",link:"https://www.gsi.go.jp/kiban/index.html"}];var ey=function(){function e(t,r){var n;Ue(this,e),n="string"==typeof t?document.getElementById(t):t;var i=this._createCanvas(n);this._container_element=n,this._canvas_element=i,this._glenv=new su(i),this._camera=new au(i),this._animation=this._createAnimationBindingBlock(),this._dem_provider=this._createDemProvider(r),this._image_provider=this._createImageProvider(r),this._layers=this._createLayerCollection(r),this._globe=new Ml(this._glenv,this._dem_provider),this._tile_texture_cache=new Yl(this._glenv,this._image_provider),this._scene=new Cc(this,this._glenv),this._ground_visibility=e._getBoolOption(r,"ground_visibility",!0),this._entity_visibility=e._getBoolOption(r,"entity_visibility",!0),this._render_mode=r&&r.render_mode||ry.SURFACE,this._debug_stats=r&&r.debug_stats||null,this._render_callback=this._createRenderCallback(r),this._frame_req_id=0,this._previous_time=void 0,this._is_destroyed=!1,this._logo_controller=r&&r.logo_controller||new $d(this._container_element),this._attribution_controller=r&&r.attribution_controller||new Jd(this._container_element),this._createLogoAttributionContainer(),this._logo_controller.createContainer(),this._attribution_controller.createContainer(),this._requestNextFrame(),this._updateCanvasSize()}return Ge(e,[{key:"destroy",value:function(){this._is_destroyed||(0!=this._frame_req_id&&(window.maprayCancelAnimationFrame(this._frame_req_id),this._frame_req_id=0),this._render_callback.detach(),this._render_callback=this._createRenderCallback(),this._container_element.removeChild(this._canvas_element),this._globe.cancel(),this._tile_texture_cache.cancel(),this._layers.cancel(),this._scene.cancelLoaders(),this._logo_controller._destroy(),this._attribution_controller._destroy(),this._attribution_controller=null,this._deleteLogoAttributionContainer(),this._is_destroyed=!0)}},{key:"_createCanvas",value:function(e){var t=document.createElement("canvas");return t.className="mapray-canvas",t.style.width="100%",t.style.height="100%",e.appendChild(t),t}},{key:"_createDemProvider",value:function(e){return e&&e.dem_provider?e.dem_provider:new bc("/dem/",".bin")}},{key:"_createAnimationBindingBlock",value:function(){var e=this,t=new Xs;return t.addDescendantUnbinder((function(){e._unbindDescendantAnimations()})),t}},{key:"_createImageProvider",value:function(e){return e&&e.image_provider?e.image_provider:new t_("http://cyberjapandata.gsi.go.jp/xyz/std/",".png",256,0,18)}},{key:"_createLayerCollection",value:function(e){var t=e&&e.layers?e.layers:{};return new Ac(this._glenv,t)}},{key:"_createRenderCallback",value:function(e){var t;return(t=e&&e.render_callback?e.render_callback:new Ic).attach(this),t}},{key:"_createLogoAttributionContainer",value:function(){var t=!0,r=!1,n=void 0;try{for(var i,a=e._positions[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value,s=document.createElement("div");s.className=o,this._container_element.appendChild(s)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"_deleteLogoAttributionContainer",value:function(){var t=!0,r=!1,n=void 0;try{for(var i,a=e._positions[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;document.getElementById(o)&&this._container_element.removeChild(o)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"setVisibility",value:function(e,t){switch(e){case ty.GROUND:this._ground_visibility=t;break;case ty.ENTITY:this._entity_visibility=t;break;default:throw new Error("invalid target: "+e)}}},{key:"getVisibility",value:function(e,t){switch(e){case ty.GROUND:return this._ground_visibility;case ty.ENTITY:return this._entity_visibility;default:throw new Error("invalid target: "+e)}}},{key:"getElevation",value:function(e,t){var r=t+180*Math.floor((90-e)/360+Math.floor((90+e)/360)),n=90-Math.abs(90-e+360*Math.floor((90+e)/360)),i=(r-360-360*Math.floor((r-180)/360))*us.DEGREE,a=us.invGudermannian(n*us.DEGREE),o=2*Math.PI,s=i/o+.5,u=.5-a/o;if(u<0||u>1)return 0;var l=this._globe,_=l.findHighestAccuracy(s,u);if(null===_)return 0;var c=1<<l.dem_provider.getResolutionPower(),h=Math.pow(2,_.z),f=c*(h*s-_.x),v=c*(h*u-_.y),d=us.clamp(Math.floor(f),0,c-1),y=us.clamp(Math.floor(v),0,c-1),p=_.getHeights(d,y),m=f-d,g=v-y;return(p[0]*(1-m)+p[1]*m)*(1-g)+(p[2]*(1-m)+p[3]*m)*g}},{key:"getExistingElevation",value:function(e){var t=[e.longitude,e.latitude,0];return this._globe.getExistingElevations(1,t,0,3,t,2,3),t[2]}},{key:"getExistingElevations",value:function(e,t,r,n,i,a,o){return this._globe.getExistingElevations(e,t,r,n,i,a,o)}},{key:"getRayIntersection",value:function(e){var t=this._globe;if(t.status!==Ml.Status.READY)return null;var r=t.root_flake.findRayDistance(e,Number.MAX_VALUE);if(r===Number.MAX_VALUE)return null;var n=us.createVector3(),i=e.position,a=e.direction;return n[0]=i[0]+r*a[0],n[1]=i[1]+r*a[1],n[2]=i[2]+r*a[2],n}},{key:"_requestNextFrame",value:function(){var e=this;this._frame_req_id=window.maprayRequestAnimationFrame((function(){return e._updateFrame()}))}},{key:"_updateFrame",value:function(){var e=this._updateTime();this._requestNextFrame(),this._updateCanvasSize(),this._render_callback.onUpdateFrameInner(e),null!==this._debug_stats&&this._debug_stats.clearStats(),new Jl(this).render(),this._finishDebugStats()}},{key:"_updateTime",value:function(){var e=window.maprayNow(),t=void 0!==this._previous_time?(e-this._previous_time)/1e3:0;return this._previous_time=e,t}},{key:"_updateCanvasSize",value:function(){var e=this._canvas_element;e.width!=e.clientWidth&&(e.width=e.clientWidth),e.height!=e.clientHeight&&(e.height=e.clientHeight)}},{key:"_finishDebugStats",value:function(){var e=this._debug_stats;null!==e&&(e.num_wait_reqs_dem=this._globe.getNumDemWaitingRequests(),e.num_wait_reqs_img=this._tile_texture_cache.getNumWaitingRequests(),e.onUpdate())}},{key:"_unbindDescendantAnimations",value:function(){this._scene.animation.unbindAllRecursively()}},{key:"container_element",get:function(){return this._container_element}},{key:"canvas_element",get:function(){return this._canvas_element}},{key:"animation",get:function(){return this._animation}},{key:"dem_provider",get:function(){return this._dem_provider}},{key:"image_provider",get:function(){return this._image_provider}},{key:"layers",get:function(){return this._layers}},{key:"render_callback",get:function(){return this._render_callback}},{key:"render_mode",get:function(){return this._render_mode},set:function(e){this._render_mode=e}},{key:"debug_stats",get:function(){return this._debug_stats}},{key:"camera",get:function(){return this._camera}},{key:"scene",get:function(){return this._scene}},{key:"glenv",get:function(){return this._glenv}},{key:"globe",get:function(){return this._globe}},{key:"tile_texture_cache",get:function(){return this._tile_texture_cache}},{key:"logo_controller",get:function(){return this._logo_controller}},{key:"attribution_controller",get:function(){return this._attribution_controller}}],[{key:"_getBoolOption",value:function(e,t,r){return e&&void 0!==e[t]?e[t]:r}}]),e}(),ty={GROUND:{id:"GROUND"},ENTITY:{id:"ENTITY"}},ry={SURFACE:{id:"SURFACE"},WIREFRAME:{id:"WIREFRAME"}};ey.Category=ty,ey.RenderMode=ry,ey.ContainerPosition=Qd.ContainerPosition,ey._positions=["control-top-left","control-top-right","control-bottom-left","control-bottom-right"];var ny=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this)))._headers={"X-Api-Key":e},r}return ze(t,e),Ge(t,[{key:"requestTile",value:function(e,t,r,n){var i=new AbortController;return fetch(this._makeURL(e,t,r),{headers:this._headers,signal:i.signal}).then((function(e){return e.ok?e.arrayBuffer():Promise.reject(Error(e.statusText))})).then((function(e){n(e)})).catch((function(){n(null)})),i}},{key:"cancelRequest",value:function(e){e.abort()}},{key:"_makeURL",value:function(e,t,r){return"https://tiles.mapray.com/dem/"+e+"/"+t+"/"+r+".bin"}}]),t}(wc),iy=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e,"/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;     // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;       // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;     // テクスチャ座標\nattribute vec2 a_texmaskcoord; // テクスチャマスク座標\nattribute vec3 a_fg_color;     // 前景色\nattribute vec3 a_bg_color;     // 背景色\n\nuniform mat4 u_obj_to_clip;    // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;         // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;       // テクスチャ座標\nvarying vec2 v_texmaskcoord;   // テクスチャマスク座標\nvarying vec3 v_fg_color;       // 前景色\nvarying vec3 v_bg_color;       // 背景色\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n    v_texmaskcoord = a_texmaskcoord;\n    v_fg_color = a_fg_color;\n    v_bg_color = a_bg_color;\n}\n","/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;        // アイコンのテクスチャ座標\nvarying vec2 v_texmaskcoord;    // アイコンマスクのテクスチャ座標\nvarying vec3 v_fg_color;        // 前景色\nvarying vec3 v_bg_color;        // 背景色\n\nuniform sampler2D u_image;      // アイコン画像\nuniform sampler2D u_image_mask; // アイコンマスク画像\n\n\nvoid\nmain()\n{\n    float alpha = texture2D( u_image, v_texcoord ).w;          // 輝度\n    float mask = texture2D( u_image_mask, v_texmaskcoord ).w;  // マスク\n    alpha *= mask;\n    gl_FragColor = vec4(v_fg_color * alpha + v_bg_color * (1.0 - alpha), 1.0);\n}\n"))).bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r.setInteger("u_image_mask",t.TEXUNIT_IMAGE_MASK),r}return ze(t,e),Ge(t,[{key:"isTranslucent",value:function(e,t){return!1}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i);var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle);var o=n.image_mask;this.bindTexture2D(t.TEXUNIT_IMAGE_MASK,o.handle)}}]),t}(xv);iy.TEXUNIT_IMAGE=0,iy.TEXUNIT_IMAGE_MASK=1,iy._sparam=us.createVector2f(),iy._bg_color=us.createVector3f(),iy._fg_color=us.createVector3f();var ay=function(){function e(){Ue(this,e),this._cache=new Map}return Ge(e,[{key:"create",value:function(e){var t=this.getKey(e),r=this._cache.get(t);return r||this._cache.set(t,r=this.doCreate(e)),r}},{key:"doCreate",value:function(e){}},{key:"getKey",value:function(e){return e}},{key:"load",value:function(e){var t=this.create(e);return t.load(),t}}]),e}(),oy=function(){function e(){Ue(this,e),this._status=e.Status.NOT_LOADED,this.funcs=[]}return Ge(e,[{key:"isLoaded",value:function(){return this._status===e.Status.LOADED}},{key:"onEnd",value:function(t){this._status===e.Status.LOADED||this._status===e.Status.ABORTED?t(this):this.funcs.push(t)}},{key:"load",value:function(){var t=this;if(this._status===e.Status.NOT_LOADED)return this._status=e.Status.LOADING,this.doLoad().then((function(r){t._icon=r,t._status=e.Status.LOADED;for(var n=0;n<t.funcs.length;n++)t.funcs[n](t);t.funcs.length=0})).catch((function(r){t._status=e.Status.ABORTED;for(var n=0;n<t.funcs.length;n++)t.funcs[n](t);t.funcs.length=0}))}},{key:"doLoad",value:function(e,t){return Promise.reject(new Error("doLoad() is not implemented in: "+this.constructor.name))}},{key:"draw",value:function(e,t,r,n,i){e.drawImage(this.icon,t,r,n,i)}},{key:"status",get:function(){return this._status}},{key:"icon",get:function(){return this._icon}},{key:"width",get:function(){return this.icon?this.icon.width:-1}},{key:"height",get:function(){return this.icon?this.icon.height:-1}}]),e}();oy.Status={NOT_LOADED:"not loaded",LOADING:"loading",LOADED:"loaded",ABORTED:"aborted"};var sy=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this))).urlPrefix=e,n.urlSuffix=r,n}return ze(t,e),Ge(t,[{key:"doCreate",value:function(e){return new uy(this.urlPrefix+e+this.urlSuffix)}}]),t}(ay),uy=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this))).url=e,r}return ze(t,e),Ge(t,[{key:"doLoad",value:function(e,t){return yv.loadImage(this.url,{crossOrigin:"Anonymous"})}}]),t}(oy),ly=function(e){function t(){return Ue(this,t),Ze(this,je(t).apply(this,arguments))}return ze(t,e),Ge(t,[{key:"doCreate",value:function(e){return new _y(e.text,e.props)}},{key:"getKey",value:function(e){return e.text}}]),t}(ay),_y=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Ue(this,t),(r=Ze(this,je(t).call(this))).text=e,r.props=n,r}return ze(t,e),Ge(t,[{key:"doLoad",value:function(e,t){var r=this.props,n=r.size?r.size[0]:20,i=r.font_family?"'"+r.font_family+"'":yv.SYSTEM_FONT_FAMILY,a=yv.createCanvasContext(n,n);return a.textAlign="center",a.textBaseline="alphabetic",a.font=.6756756757*n+"px "+i,a.fillText(this.text,.5*n,.7432432432*n),Promise.resolve(a.canvas)}},{key:"draw",value:function(e,t,r,n,i){e.drawImage(this.icon,t,r,n,i)}}]),t}(oy),cy=function(e){function t(){return Ue(this,t),Ze(this,je(t).apply(this,arguments))}return ze(t,e),Ge(t,[{key:"doCreate",value:function(e){return new hy(e)}}]),t}(ay),hy=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this)))._image_src=e,r}return ze(t,e),Ge(t,[{key:"doLoad",value:function(e,t){var r=this._image_src;return"string"==typeof r?yv.loadImage(r):r instanceof HTMLImageElement?yv.waitForLoad(r):r instanceof HTMLCanvasElement?Promise.resolve(r):Promise.reject(new Error("not supported: "+r))}}]),t}(oy),fy=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this,e,r)))._entries=[],n._parent_props={fg_color:null,bg_color:null,size:null,font_family:null},n._primitive_producer=new vy(We(n)),r&&r.json&&n._setupByJson(r.json),n}return ze(t,e),Ge(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"onChangeAltitudeMode",value:function(e){this._primitive_producer.onChangeAltitudeMode()}},{key:"setSize",value:function(e){this._setVector2Property("size",e)}},{key:"setFGColor",value:function(e){this._setVector3Property("fg_color",e)}},{key:"setBGColor",value:function(e){this._setVector3Property("bg_color",e)}},{key:"setFontFamily",value:function(e){this._setValueProperty("font_family",e)}},{key:"addPin",value:function(e,t){this.addTextPin("",e,t)}},{key:"addMakiIconPin",value:function(e,t,r){this._entries.push(new yy(this,e,t,r)),this._primitive_producer.onAddEntry()}},{key:"addTextPin",value:function(e,t,r){this._entries.push(new py(this,e,t,r)),this._primitive_producer.onAddEntry()}},{key:"_getMaterial",value:function(){var e=this.scene;return e._PinEntity_pin_material||(e._PinEntity_pin_material=new iy(e.glenv)),e._PinEntity_pin_material}},{key:"_setValueProperty",value:function(e,t){var r=this._parent_props;r[e]!=t&&(r[e]=t,this._primitive_producer.onChangeParentProperty())}},{key:"_setVector3Property",value:function(e,t){var r=this._parent_props[e];r?r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]||(us.copyVector3(t,r),this._primitive_producer.onChangeParentProperty()):r=this._parent_props[e]=us.createVector2f(t)}},{key:"_setVector2Property",value:function(e,t){var r=this._parent_props[e];r?r[0]===t[0]&&r[1]===t[1]||(us.copyVector2(t,r),this._primitive_producer.onChangeParentProperty()):(this._parent_props[e]=us.createVector2f(t),this._primitive_producer.onChangeParentProperty())}},{key:"_setupByJson",value:function(e){var t=new ls,r=!0,n=!1,i=void 0;try{for(var a,o=e.entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;t.setFromArray(s.position),this.addPin(t,s)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}e.size&&this.setSize(e.size),e.fg_color&&this.setFGColor(e.fg_color),e.bg_color&&this.setBGColor(e.bg_color),e.font_family&&this.setBGColor(e.font_family)}}]),t}(xl);fy.SAFETY_PIXEL_MARGIN=1,fy.MAX_IMAGE_WIDTH=4096,fy.CIRCLE_SEP_LENGTH=32,fy.DEFAULT_SIZE=us.createVector2f([30,30]),fy.DEFAULT_FONT_FAMILY="sans-serif",fy.DEFAULT_FG_COLOR=us.createVector3f([1,1,1]),fy.DEFAULT_BG_COLOR=us.createVector3f([.35,.61,.81]),fy.SAFETY_PIXEL_MARGIN=1,fy.MAX_IMAGE_WIDTH=4096;var vy=function(e){function t(e){var r;Ue(this,t),(r=Ze(this,je(t).call(this,e)))._glenv=e.scene.glenv,r._dirty=!0,r._transform=us.setIdentity(us.createMatrix()),r._properties={image:null,image_mask:null};var n=new sl(r._glenv,null,e._getMaterial(),r._transform);return n.properties=r._properties,r._primitive=n,r._primitives=[],r}return ze(t,e),Ge(t,[{key:"createRegions",value:function(){var e=new Fv,t=!0,r=!1,n=void 0;try{for(var i,a=this.entity._entries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value.position;e.addPoint(o)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return[e]}},{key:"onChangeElevation",value:function(e){this._dirty=!0}},{key:"getPrimitives",value:function(e){return this._updatePrimitive()}},{key:"onChangeParentProperty",value:function(){this._dirty=!0}},{key:"onChangeAltitudeMode",value:function(){this._dirty=!0}},{key:"onAddEntry",value:function(){this.needToCreateRegions(),this._dirty=!0}},{key:"_updatePrimitive",value:function(){if(!this._dirty)return this._primitives;if(0==this.entity._entries.length)return this._primitives=[],this._dirty=!1,this._primitives;var e=this._createFlatGocsArray();this._updateTransform(e);var t=new my(this,e);if(!t.isValid())return this._primitives=[],this._dirty=!1,this._primitives;var r=this._properties;r.image&&r.image.dispose(),r.image=t.texture,r.image_mask&&r.image_mask.dispose(),r.image_mask=t.texture_mask;var n={vtype:[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2},{name:"a_texmaskcoord",size:2},{name:"a_fg_color",size:3},{name:"a_bg_color",size:3}],vertices:t.vertices,indices:t.indices},i=new yl(this._glenv,n),a=this._primitive;return a.mesh&&a.mesh.dispose(),a.mesh=i,this._primitives=[a],this._dirty=!1,this._primitives}},{key:"_updateTransform",value:function(e){for(var t=this.entity._entries.length,r=0,n=0,i=0,a=0;a<t;++a){var o=3*a;r+=e[o],n+=e[o+1],i+=e[o+2]}var s=this._transform;s[12]=r/t,s[13]=n/t,s[14]=i/t}},{key:"_createFlatGocsArray",value:function(){var e=this.entity._entries.length;return ls.toGocsArray(this._getFlatGeoPoints_with_Absolute(),e,new Float64Array(3*e))}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){for(var e=this.entity,t=e._entries,r=t.length,n=new Float64Array(3*r),i=0;i<r;++i){var a=t[i].position;n[3*i]=a.longitude,n[3*i+1]=a.latitude}switch(e.altitude_mode){case bl.RELATIVE:case bl.CLAMP:if(e.scene.viewer.getExistingElevations(r,n,0,3,n,2,3),e.altitude_mode===bl.RELATIVE)for(var o=0;o<r;++o)n[3*o+2]+=t[o].position.altitude;break;default:for(var s=0;s<r;++s)n[3*s+2]=t[s].position.altitude}return n}}]),t}(xl.PrimitiveProducer),dy=function(){function e(t,r,n){Ue(this,e),this._owner=t,this._position=r.clone(),this._props=Object.assign({},n),this._copyPropertyVector3f("fg_color"),this._copyPropertyVector3f("bg_color"),this._copyPropertyVector2f("size")}return Ge(e,[{key:"_loadIcon",value:function(){throw new Error("loadIcon() is not implemented: "+this.constructor.name)}},{key:"_copyPropertyVector3f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&(t[e]=us.createVector3f(t[e]))}},{key:"_copyPropertyVector2f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&("number"==typeof t[e]?t[e]=us.createVector2f([t[e],t[e]]):t[e]=us.createVector2f(t[e]))}},{key:"isLoaded",value:function(){return this._icon.isLoaded()}},{key:"draw",value:function(e,t,r,n,i){this._icon.draw(e,t,r,n,i)}},{key:"position",get:function(){return this._position}},{key:"size",get:function(){var e=this._props,t=this._owner._parent_props;return e.size||t.size||(this.icon?us.createVector2f([this.icon.width,this.icon.height]):fy.DEFAULT_SIZE)}},{key:"fg_color",get:function(){var e=this._props,t=this._owner._parent_props;return e.fg_color||t.fg_color||fy.DEFAULT_FG_COLOR}},{key:"bg_color",get:function(){var e=this._props,t=this._owner._parent_props;return e.bg_color||t.bg_color||fy.DEFAULT_BG_COLOR}},{key:"icon",get:function(){return this._icon}}]),e}(),yy=function(e){function t(e,r,n,i){var a;return Ue(this,t),(a=Ze(this,je(t).call(this,e,n,i)))._id=r,a._icon=t.makiIconLoader.load(r),a._icon.onEnd((function(e){a._owner.getPrimitiveProducer()._dirty=!0})),a}return ze(t,e),t}(dy);yy.makiIconLoader=new sy("https://resource.mapray.com/styles/v1/icons/maki/",".svg");var py=function(e){function t(e,r,n,i){var a;return Ue(this,t),(a=Ze(this,je(t).call(this,e,n,i)))._text=r,a._icon=t.textIconLoader.load({text:a._text,props:{size:a.size,font_family:a.font_family}}),a._icon.onEnd((function(e){a._owner.getPrimitiveProducer()._dirty=!0})),a}return ze(t,e),Ge(t,[{key:"font_family",get:function(){var e=this._props,t=this._owner._parent_props;return e.font_family||t.font_family||fy.DEFAULT_FONT_FAMILY}}]),t}(dy);py.textIconLoader=new ly;var my=function(){function e(t,r){Ue(this,e),this._owner=t,this._items=this._createItemList(),this._is_valid=!0;var n=this._createRowLayouts();if(0!=n.length){var i=this._setupLocation(n);this._texture=this._createTexture(i.width,i.height),this._texture_mask=this._createTextureMask(),this._vertices=this._createVertices(i.width,i.height,r),this._indices=this._createIndices()}else this._is_valid=!1}return Ge(e,[{key:"isValid",value:function(){return this._is_valid}},{key:"_createItemList",value:function(){var e=new Map,t=[],r=0,n=!0,i=!1,a=void 0;try{for(var o,s=this._owner.entity._entries[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;if(u.isLoaded()){var l=e.get(u.icon);l||(e.set(u.icon,l=new gy(this)),t.push(l)),l.add(r++,u)}}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}return t}},{key:"_createRowLayouts",value:function(){var e=[].concat(this._items);e.sort((function(e,t){return e.height_pixel-t.height_pixel}));for(var t=[];e.length>0;){var r=new ky(e);r.isValid()&&t.push(r)}return t}},{key:"_createTexture",value:function(e,t){for(var r=yv.createCanvasContext(e,t),n=this._items,i=0;i<n.length;++i){var a=n[i];a.is_canceled||a.draw(r)}var o=this._owner._glenv,s={usage:bv.Usage.ICON};return new bv(o,r.canvas,s)}},{key:"_createTextureMask",value:function(){var e=yv.createCanvasContext(3,3);e.fillRect(1,1,1,1);var t=this._owner._glenv,r={usage:bv.Usage.ICON,mag_filter:t.context.NEAREST};return new bv(t,e.canvas,r)}},{key:"_createVertices",value:function(e,t,r){for(var n=[],i=this._owner._transform,a=i[12],o=i[13],s=i[14],u=1/e,l=1/t,_=this._items,c=0;c<_.length;++c){var h=_[c];if(!h.is_canceled)for(var f=0;f<h.entries.length;f++){var v=h.entries[f],d=v.entry,y=d.size,p=1.5*y[0]/2,m=1.5*y[1]/2,g=2*m,k=Math.max(2,p/10),E=3*v.index,w=r[E]-a,b=r[E+1]-o,x=r[E+2]-s,A=d.fg_color,T=d.bg_color,I=h.pos_x,M=h.pos_y,S=h.width,L=h.height,P=function(e,t){n.push((I+S*e)*u,1-(M+L*t)*l)};n.push(w,b,x),n.push(-k/2,g-m),P(.5-k/2/p,1.25),n.push(.25,.25),n.push.apply(n,Ke(A)),n.push.apply(n,Ke(T)),n.push(w,b,x),n.push(-k/2,0),P(.5-k/2/p,1.25),n.push(.25,.25),n.push.apply(n,Ke(A)),n.push.apply(n,Ke(T)),n.push(w,b,x),n.push(k/2,0),P(.5+k/2/p,1.25),n.push(.25,.25),n.push.apply(n,Ke(A)),n.push.apply(n,Ke(T)),n.push(w,b,x),n.push(k/2,g-m),P(.5+k/2/p,1.25),n.push(.25,.25),n.push.apply(n,Ke(A)),n.push.apply(n,Ke(T)),n.push(w,b,x),n.push(0,g),P(.5,.5),n.push(.5,.5),n.push.apply(n,Ke(A)),n.push.apply(n,Ke(T));for(var R=1;R<fy.CIRCLE_SEP_LENGTH;R++){var C=(R/fy.CIRCLE_SEP_LENGTH*2-.5)*Math.PI,O=Math.cos(C),F=Math.sin(C);n.push(w,b,x),n.push(p*O,m*F+g),P(1.5*O/2+.5,-1.5*F/2+.5),n.push(.25*O+.5,.25*F+.5),n.push.apply(n,Ke(A)),n.push.apply(n,Ke(T))}}}return n}},{key:"_createIndices",value:function(){for(var e=[],t=this._items,r=0;r<t.length;++r){var n=t[r];if(!n.is_canceled)for(var i=0;i<n.entries.length;i++){var a=n.entries[i],o=(5+fy.CIRCLE_SEP_LENGTH-1)*a.index,s=o,u=o+3;e.push(o,o+1,o+2),e.push(o,o+2,o+3),o+=4;var l=o++;e.push(l,s,u),e.push(l,u,o);for(var _=1;_<fy.CIRCLE_SEP_LENGTH-1;_++)e.push(l,o++,o);e.push(l,o++,s)}}return e}},{key:"_setupLocation",value:function(e){var t=0,r=0;r+=fy.SAFETY_PIXEL_MARGIN;for(var n=0;n<e.length;++n){var i=e[n];i.locate(r),t=Math.max(i.width_assumed,t),r+=i.height_pixel+fy.SAFETY_PIXEL_MARGIN}return{width:t,height:r}}},{key:"texture",get:function(){return this._texture}},{key:"texture_mask",get:function(){return this._texture_mask}},{key:"vertices",get:function(){return this._vertices}},{key:"indices",get:function(){return this._indices}}]),e}(),gy=function(){function e(t){Ue(this,e),this.entries=[],this._pos_x=0,this._pos_y=0,this._height=this._width=null,this._is_canceled=!1}return Ge(e,[{key:"add",value:function(e,t){var r=t.size;(null===this._width||this._width<r[0])&&(this._width=r[0]),(null===this._height||this._height<r[1])&&(this._height=r[1]),this.entries.push({index:e,entry:t})}},{key:"cancel",value:function(){this._is_canceled=!0}},{key:"locate",value:function(e,t){this._pos_x=e,this._pos_y=t}},{key:"draw",value:function(e){this.entries[0].entry.draw(e,this._pos_x,this.pos_y,this.width,this.height)}},{key:"pos_x",get:function(){return this._pos_x}},{key:"pos_y",get:function(){return this._pos_y}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"width_pixel",get:function(){return Math.ceil(this._width)}},{key:"height_pixel",get:function(){return Math.ceil(this._height)}},{key:"is_canceled",get:function(){return this._is_canceled}}]),e}(),ky=function(){function e(t){Ue(this,e);var r=0,n=0,i=[];for(r+=fy.SAFETY_PIXEL_MARGIN;t.length>0;){var a=t.shift(),o=a.width_pixel+fy.SAFETY_PIXEL_MARGIN;if(r+o<=fy.MAX_IMAGE_WIDTH)i.push(a),r+=o,n=Math.max(a.height_pixel,n);else{if(0!=i.length){t.unshift(a);break}a.cancel()}}this._items=i,this._width_assumed=r,this._height_pixel=n}return Ge(e,[{key:"isValid",value:function(){return this._items.length>0}},{key:"locate",value:function(e){var t=this._items,r=0;r+=fy.SAFETY_PIXEL_MARGIN;for(var n=0;n<t.length;++n){var i=t[n];i.locate(r,e),r+=i.width_pixel+fy.SAFETY_PIXEL_MARGIN}}},{key:"items",get:function(){return this._items}},{key:"width_assumed",get:function(){return this._width_assumed}},{key:"height_pixel",get:function(){return this._height_pixel}}]),e}(),Ey=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this,e,"/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;     // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;       // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;     // テクスチャ座標\n\nuniform mat4 u_obj_to_clip;    // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;         // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;       // テクスチャ座標\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n}\n","/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;        // テクスチャ座標\nuniform sampler2D u_image;      // 画像\n\n\nvoid\nmain()\n{\n    gl_FragColor = texture2D( u_image, v_texcoord );\n}\n"))).bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return ze(t,e),Ge(t,[{key:"isTranslucent",value:function(e,t){return!1}},{key:"setParameters",value:function(e,r){var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i);var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle)}}]),t}(xv);Ey.TEXUNIT_IMAGE=0,Ey._sparam=us.createVector2f(),Ey._bg_color=us.createVector3f(),Ey._fg_color=us.createVector3f();var wy=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this,e,r)))._entries=[],n._parent_props={size:null,origin:null},n._primitive_producer=new by(We(n)),r&&r.json&&n._setupByJson(r.json),n}return ze(t,e),Ge(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"setSize",value:function(e){this._setVector2Property("size",e)}},{key:"setOrigin",value:function(e){this._setVector2Property("origin",e)}},{key:"addImageIcon",value:function(e,t,r){this._entries.push(new xy(this,e,t,r)),this._primitive_producer.onAddEntry()}},{key:"_getMaterial",value:function(){var e=this.scene;return e._ImageEntity_image_material||(e._ImageEntity_image_material=new Ey(e.glenv)),e._ImageEntity_image_material}},{key:"_setValueProperty",value:function(e,t){var r=this._text_parent_props;r[e]!=t&&(r[e]=t,this._primitive_producer.onChangeParentProperty())}},{key:"_setVector2Property",value:function(e,t){var r=this._parent_props[e];r?r[0]===t[0]&&r[1]===t[1]||(us.copyVector2(t,r),this._primitive_producer.onChangeParentProperty()):(this._parent_props[e]=us.createVector2f(t),this._primitive_producer.onChangeParentProperty())}},{key:"_setupByJson",value:function(e){var t=new ls,r=!0,n=!1,i=void 0;try{for(var a,o=e.entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;t.setFromArray(s.position),this.addImageIcon(t,s)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}e.size&&this.setSize(e.size),e.origin&&this.setOrigin(e.origin)}}]),t}(xl);wy.DEFAULT_COLOR=us.createVector3f([1,1,1]),wy.SAFETY_PIXEL_MARGIN=1,wy.MAX_IMAGE_WIDTH=4096,wy.CIRCLE_SEP_LENGTH=32,wy.DEFAULT_ICON_SIZE=us.createVector2f([30,30]),wy.DEFAULT_ORIGIN=us.createVector2f([.5,.5]),wy.SAFETY_PIXEL_MARGIN=1,wy.MAX_IMAGE_WIDTH=4096;var by=function(e){function t(e){var r;Ue(this,t),(r=Ze(this,je(t).call(this,e)))._glenv=e.scene.glenv,r._dirty=!0,r._transform=us.setIdentity(us.createMatrix()),r._properties={image:null};var n=new sl(r._glenv,null,e._getMaterial(),r._transform);return n.properties=r._properties,r._primitive=n,r._primitives=[],r}return ze(t,e),Ge(t,[{key:"createRegions",value:function(){var e=new Fv,t=!0,r=!1,n=void 0;try{for(var i,a=this.entity._entries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value.position;e.addPoint(o)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return[e]}},{key:"onChangeElevation",value:function(e){this._dirty=!0}},{key:"getPrimitives",value:function(e){return this._updatePrimitive()}},{key:"onChangeParentProperty",value:function(){this._dirty=!0}},{key:"onChangeAltitudeMode",value:function(){this._dirty=!0}},{key:"onAddEntry",value:function(){this.needToCreateRegions(),this._dirty=!0}},{key:"_updatePrimitive",value:function(){if(!this._dirty)return this._primitives;if(0==this.entity._entries.length)return this._primitives=[],this._dirty=!1,this._primitives;var e=this._createFlatGocsArray();this._updateTransform(e);var t=new Ay(this,e);if(!t.isValid())return this._primitives=[],this._dirty=!1,this._primitives;var r=this._properties;r.image&&r.image.dispose(),r.image=t.texture;var n={vtype:[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2}],vertices:t.vertices,indices:t.indices},i=new yl(this._glenv,n),a=this._primitive;return a.mesh&&a.mesh.dispose(),a.mesh=i,this._primitives=[a],this._dirty=!1,this._primitives}},{key:"_updateTransform",value:function(e){for(var t=this.entity._entries.length,r=0,n=0,i=0,a=0;a<t;++a){var o=3*a;r+=e[o],n+=e[o+1],i+=e[o+2]}var s=this._transform;s[12]=r/t,s[13]=n/t,s[14]=i/t}},{key:"_createFlatGocsArray",value:function(){var e=this.entity._entries.length;return ls.toGocsArray(this._getFlatGeoPoints_with_Absolute(),e,new Float64Array(3*e))}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){for(var e=this.entity,t=e._entries,r=t.length,n=new Float64Array(3*r),i=0;i<r;++i){var a=t[i].position;n[3*i]=a.longitude,n[3*i+1]=a.latitude}switch(e.altitude_mode){case bl.RELATIVE:case bl.CLAMP:if(e.scene.viewer.getExistingElevations(r,n,0,3,n,2,3),e.altitude_mode===bl.RELATIVE)for(var o=0;o<r;++o)n[3*o+2]+=t[o].position.altitude;break;default:for(var s=0;s<r;++s)n[3*s+2]=t[s].position.altitude}return n}}]),t}(xl.PrimitiveProducer),xy=function(){function e(t,r,n,i){var a=this;Ue(this,e),this._owner=t,this._image_src=r,this._position=n.clone(),this._props=Object.assign({},i),this._copyPropertyVector2f("size"),this._copyPropertyVector2f("origin"),this._icon=e.iconLoader.load(r),this._icon.onEnd((function(e){a._owner.getPrimitiveProducer()._dirty=!0}))}return Ge(e,[{key:"_copyPropertyVector3f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&(t[e]=us.createVector3f(t[e]))}},{key:"_copyPropertyVector2f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&("number"==typeof t[e]?t[e]=us.createVector2f([t[e],t[e]]):t[e]=us.createVector2f(t[e]))}},{key:"isLoaded",value:function(){return this._icon.isLoaded()}},{key:"draw",value:function(e,t,r,n,i){this._icon.draw(e,t,r,n,i)}},{key:"position",get:function(){return this._position}},{key:"size",get:function(){var e=this._props,t=this._owner._parent_props;return e.size||t.size||us.createVector2f([this._icon.width,this._icon.height])}},{key:"origin",get:function(){var e=this._props,t=this._owner._parent_props;return e.origin||t.origin||wy.DEFAULT_ORIGIN}},{key:"icon",get:function(){return this._icon}}]),e}();xy.iconLoader=new cy;var Ay=function(){function e(t,r){Ue(this,e),this._owner=t,this._items=this._createItemList(),this._is_valid=!0;var n=this._createRowLayouts();if(0!=n.length){var i=this._setupLocation(n);this._texture=this._createTexture(i.width,i.height),this._vertices=this._createVertices(i.width,i.height,r),this._indices=this._createIndices()}else this._is_valid=!1}return Ge(e,[{key:"isValid",value:function(){return this._is_valid}},{key:"_createItemList",value:function(){var e=new Map,t=[],r=0,n=!0,i=!1,a=void 0;try{for(var o,s=this._owner.entity._entries[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;if(u.isLoaded()){var l=e.get(u.icon);l||(e.set(u.icon,l=new Ty(this)),t.push(l)),l.add(r++,u)}}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}return t}},{key:"_createRowLayouts",value:function(){var e=[].concat(this._items);e.sort((function(e,t){return e.height_pixel-t.height_pixel}));for(var t=[];e.length>0;){var r=new Iy(e);r.isValid()&&t.push(r)}return t}},{key:"_createTexture",value:function(e,t){for(var r=yv.createCanvasContext(e,t),n=this._items,i=0;i<n.length;++i){var a=n[i];a.is_canceled||a.draw(r)}var o=this._owner._glenv,s={usage:bv.Usage.ICON};return new bv(o,r.canvas,s)}},{key:"_createVertices",value:function(e,t,r){for(var n=[],i=this._owner._transform,a=i[12],o=i[13],s=i[14],u=1/e,l=1/t,_=this._items,c=0;c<_.length;++c){var h=_[c];if(!h.is_canceled)for(var f=0;f<h.entries.length;f++){var v=h.entries[f],d=v.entry,y=d.size,p=d.origin,m=3*v.index,g=r[m]-a,k=r[m+1]-o,E=r[m+2]-s,w=h.pos_x,b=h.pos_y,x=h.width,A=h.height;n.push(g,k,E),n.push(-p[0]*y[0],p[1]*y[1]),n.push(w*u,1-b*l),n.push(g,k,E),n.push(-p[0]*y[0],-(1-p[1])*y[1]),n.push(w*u,1-(b+A)*l),n.push(g,k,E),n.push((1-p[0])*y[0],-(1-p[1])*y[1]),n.push((w+x)*u,1-(b+A)*l),n.push(g,k,E),n.push((1-p[0])*y[0],p[1]*y[1]),n.push((w+x)*u,1-b*l)}}return n}},{key:"_createIndices",value:function(){for(var e=[],t=this._items,r=0;r<t.length;++r){var n=t[r];if(!n.is_canceled)for(var i=0;i<n.entries.length;i++){var a=4*n.entries[i].index;e.push(a,a+1,a+2),e.push(a,a+2,a+3)}}return e}},{key:"_setupLocation",value:function(e){var t=0,r=0;r+=wy.SAFETY_PIXEL_MARGIN;for(var n=0;n<e.length;++n){var i=e[n];i.locate(r),t=Math.max(i.width_assumed,t),r+=i.height_pixel+wy.SAFETY_PIXEL_MARGIN}return{width:t,height:r}}},{key:"texture",get:function(){return this._texture}},{key:"vertices",get:function(){return this._vertices}},{key:"indices",get:function(){return this._indices}}]),e}(),Ty=function(){function e(t){Ue(this,e),this.entries=[],this._pos_x=0,this._pos_y=0,this._height=this._width=null,this._is_canceled=!1}return Ge(e,[{key:"add",value:function(e,t){var r=t.size;(null===this._width||this._width<r[0])&&(this._width=r[0]),(null===this._height||this._height<r[1])&&(this._height=r[1]),this.entries.push({index:e,entry:t})}},{key:"cancel",value:function(){this._is_canceled=!0}},{key:"locate",value:function(e,t){this._pos_x=e,this._pos_y=t}},{key:"draw",value:function(e){this.entries[0].entry.draw(e,this._pos_x,this.pos_y,this.width,this.height)}},{key:"pos_x",get:function(){return this._pos_x}},{key:"pos_y",get:function(){return this._pos_y}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"width_pixel",get:function(){return Math.ceil(this._width)}},{key:"height_pixel",get:function(){return Math.ceil(this._height)}},{key:"is_canceled",get:function(){return this._is_canceled}}]),e}(),Iy=function(){function e(t){Ue(this,e);var r=0,n=0,i=[];for(r+=wy.SAFETY_PIXEL_MARGIN;t.length>0;){var a=t.shift(),o=a.width_pixel+wy.SAFETY_PIXEL_MARGIN;if(r+o<=wy.MAX_IMAGE_WIDTH)i.push(a),r+=o,n=Math.max(a.height_pixel,n);else{if(0!=i.length){t.unshift(a);break}a.cancel()}}this._items=i,this._width_assumed=r,this._height_pixel=n}return Ge(e,[{key:"isValid",value:function(){return this._items.length>0}},{key:"locate",value:function(e){var t=this._items,r=0;r+=wy.SAFETY_PIXEL_MARGIN;for(var n=0;n<t.length;++n){var i=t[n];i.locate(r,e),r+=i.width_pixel+wy.SAFETY_PIXEL_MARGIN}}},{key:"items",get:function(){return this._items}},{key:"width_assumed",get:function(){return this._width_assumed}},{key:"height_pixel",get:function(){return this._height_pixel}}]),e}(),My=Co.left,Sy=Eo("reduce"),Ly=Zr("reduce",{1:0});Re({target:"Array",proto:!0,forced:!Sy||!Ly},{reduce:function(e){return My(this,e,arguments.length,arguments.length>1?arguments[1]:void 0)}});var Py=W.f,Ry=function(e){return function(t){for(var r,n=ee(t),i=rt(n),o=i.length,s=0,u=[];o>s;)r=i[s++],a&&!Py.call(n,r)||u.push(e?[r,n[r]]:n[r]);return u}},Cy={entries:Ry(!0),values:Ry(!1)}.values;Re({target:"Object",stat:!0},{values:function(e){return Cy(e)}});var Oy=function(e){function t(e,r){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(Ue(this,t),r instanceof pv);else{if("string"!=typeof r)throw new Error("Unsupported Resource: "+r);r=new mv(r,{type:"json",transform:i.transform})}return(n=Ze(this,je(t).call(this,e,r,{onLoad:i.onLoad})))._getPointFGColor=i.getPointFGColor||Vy,n._getPointBGColor=i.getPointBGColor||Uy,n._getPointSize=i.getPointSize||By,n._getPointIconId=i.getPointIconId||Gy,n._getLineColor=i.getLineColor||Fy,n._getLineWidth=i.getLineWidth||Ny,n._getFillColor=i.getFillColor||Dy,n._getExtrudedHeight=i.getExtrudedHeight||qy,n._getAltitudeMode=i.getAltitudeMode||zy,n._getAltitude=i.getAltitude||jy,n._transform=i.transform||Yy,n._glenv=e.glenv,n._references={},n._cancelled=!1,n._finished=!1,n}return ze(t,e),Ge(t,[{key:"_load",value:function(){var e=this;return this._resource.load().then((function(t){e._check_cancel(),e._load_geojson_object(t)}))}},{key:"_load_geojson_object",value:function(e){var t;if(e.type===Xy.FEATURE_COLLECTION){var r=e.features;t=!1;for(var n=0,i=r.length;n<i;n++){var a=r[n],o=this._load_geojson_object(a.featureId?a.feature:a);o&&!t&&(t=o)}}else if(e.type===Xy.FEATURE){var s=e.geometry;t=this._load_geometry_object(s,e)}else{if(-1===Wy.indexOf(e.type))throw new Error("Unnsupported Type: "+e.type);t=this._load_geometry_object(e,null)}return!this._cancelled&&t}},{key:"_load_geometry_object",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.coordinates;if(!r&&!e)return!1;switch(e.type){case Hy.POINT:case Hy.MULTI_POINT:return this._loadPoint(e,t);case Hy.LINE_STRING:case Hy.MULTI_LINE_STRING:return this._loadLines(e,t);case Hy.POLYGON:case Hy.MULTI_POLYGON:return this._loadPolygons(e,t);case Hy.GEOMETRY_COLLECTION:return!0;default:throw new Error("Invalid GeoJSON type: "+e.type)}}},{key:"_make_fetch_params",value:function(e){var r={signal:this._abort_ctrl.signal,credentials:(e.credentials||e_.OMIT).credentials};return e.headers&&(r.headers=e.headers||t._defaultHeaders),r}},{key:"_loadLines",value:function(e,t){var r=this,n=this._getLineColor(t),i=this._getLineWidth(t),a=this._getAltitude(t),o=this._getAltitudeMode(t);if(!e||4!==n.length)return!1;var s=e.type,u=e.coordinates,l=n.slice(0,3),_=n[3];return s===Hy.MULTI_LINE_STRING?(u.forEach((function(e){if(!r._generateLine(e,i,l,_,o,a))return!1})),!0):this._generateLine(u,i,l,_,o,a)}},{key:"_generateLine",value:function(e,t,r,n,i,a){if(!e)return!1;var o=new Gv(this._scene);o.altitude_mode=i;var s=this._flatten(e,a);return o.addPoints(s),o.setLineWidth(t),o.setColor(r),o.setOpacity(n),this._scene.addEntity(o),!0}},{key:"_loadPoint",value:function(e,r){var n=this._getPointFGColor(r),i=this._getPointBGColor(r),a=this._getPointIconId(r),o=this._getPointSize(r),s=this._getAltitudeMode(r),u=this._getAltitude(r);if(!e)return!1;var l=e.type,_={fg_color:n.slice(0,3),bg_color:i.slice(0,3),size:o};if(l===Hy.POINT){(f=new fy(this._scene)).altitude_mode=s;var c=this._getActualValue(u,e.coordinates[2],t.defaultAltitude),h=new ls(e.coordinates[0],e.coordinates[1],c);null!==a?f.addMakiIconPin(a,h,_):f.addPin(h,_),this._scene.addEntity(f)}else{var f;(f=new fy(this._scene)).altitude_mode=s;for(var v=0;v<e.coordinates.length;v++){var d=e.coordinates[v];c=this._getActualValue(u,e.coordinates[2],t.defaultAltitude),h=new ls(d[0],d[1],c);null!==a?f.addMakiIconPin(a,h,_):f.addPin(h,_)}this._scene.addEntity(f)}return!0}},{key:"_loadPolygons",value:function(e,t){var r=this,n=this._getFillColor(t),i=this._getAltitudeMode(t),a=this._getAltitude(t),o=this._getExtrudedHeight(t);if(!e||4!==n.length)return!1;var s=e.type,u=e.coordinates,l=n.slice(0,3),_=n[3];return s===Hy.MULTI_POLYGON?(u.forEach((function(e){if(!r._generatePolygon(e,l,_,i,a,o))return!1})),!0):this._generatePolygon(u,l,_,i,a,o)}},{key:"_generatePolygon",value:function(e,t,r,n,i,a){if(!e)return!1;var o=new yd(this._scene);o.altitude_mode=n,o.extruded_height=a,o.setColor(t),o.setOpacity(r);for(var s=0;s<e.length;s++){var u=this._flatten(e[s],i,e[s].length-1);if(!u)return!1;0===s?o.addOuterBoundary(u):o.addInnerBoundary(u)}return this._scene.addEntity(o),!0}},{key:"_getActualValue",value:function(e,t,r){return null!=e?e:null!=t?t:r}},{key:"_flatten",value:function(e,r){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length;return e.reduce((function(e,a,o){return o>=i?e:e.concat(a.slice(0,2),n._getActualValue(r,a[2],t.defaultAltitude))}),[])}}]),t}(kv);function Fy(e){return Oy.defaultLineColor}function Ny(e){return Oy.defaultLineWidth}function Dy(e){return Oy.defaultFillColor}function Vy(e){return Oy.defaultPointFGColor}function Uy(e){return Oy.defaultPointBGColor}function By(e){return Oy.defaultPointSize}function Gy(e){return Oy.defaultPointIconId}function zy(e){return bl.ABSOLUTE}function jy(e){return null}function qy(e){return Oy.defaultExtrudedHeight}function Yy(e){return{url:e}}Oy._defaultHeaders={},Oy.defaultLineColor=[0,0,0,1],Oy.defaultFillColor=[0,0,0,1],Oy.defaultLineWidth=1,Oy.defaultPointFGColor=[1,1,1],Oy.defaultPointBGColor=[.35,.61,.81],Oy.defaultPointSize=30,Oy.defaultPointIconId=null,Oy.defaultAltitude=0,Oy.defaultExtrudedHeight=0;var Xy={FEATURE:"Feature",FEATURE_COLLECTION:"FeatureCollection"},Hy={POINT:"Point",MULTI_POINT:"MultiPoint",LINE_STRING:"LineString",MULTI_LINE_STRING:"MultiLineString",POLYGON:"Polygon",MULTI_POLYGON:"MultiPolygon",GEOMETRY_COLLECTION:"GeometryCollection",FEATURE:"Feature"},Wy=Object.values(Hy),Zy=function(){function e(){Ue(this,e),this.clearStats()}return Ge(e,[{key:"clearStats",value:function(){this.num_wait_reqs_dem=0,this.num_wait_reqs_img=0,this.num_drawing_flakes=0,this.num_drawing_flake_vertices=0,this.num_procA_flakes=0,this.num_procB_flakes=0}},{key:"onUpdate",value:function(){}}]),e}(),Qy=dt.trim,Ky=n.parseInt,$y=/^[+-]?0[Xx]/,Jy=8!==Ky(_t+"08")||22!==Ky(_t+"0x16")?function(e,t){var r=Qy(String(e));return Ky(r,t>>>0||($y.test(r)?16:10))}:Ky;Re({global:!0,forced:parseInt!=Jy},{parseInt:Jy});var ep=re.f,tp="".endsWith,rp=Math.min,np=Pn("endsWith"),ip=!np&&!!function(){var e=ep(String.prototype,"endsWith");return e&&!e.writable}();Re({target:"String",proto:!0,forced:!ip&&!np},{endsWith:function(e){var t=String(J(this));Sn(e);var r=arguments.length>1?arguments[1]:void 0,n=_e(t.length),i=void 0===r?n:rp(_e(r),n),a=String(e);return tp?tp.call(t,a,i):t.slice(i-a.length,i)===a}});var ap=function(e){function t(e,r,n,i,a){var o;return Ue(this,t),o=Ze(this,je(t).call(this,r+" ["+e+"]",n)),Error.captureStackTrace&&Error.captureStackTrace(We(o),t),o.name="MaprayApiError",o.code=e,o.resonse=i,o.cause=a,a&&(o.stack+="\nCaused-By: "+a.stack),o}return ze(t,e),t}(Kc),op=function(e){function t(e){var r;return Ue(this,t),(r=Ze(this,je(t).call(this)))._api=e,r}return ze(t,e),Ge(t,[{key:"type",get:function(){throw new Error("Not Implemented")}}]),t}(pv),sp=function(e){function t(e,r){var n;return Ue(this,t),(n=Ze(this,je(t).call(this,e)))._datasetId=r,n}return ze(t,e),Ge(t,[{key:"load",value:function(){return this._api.listFeatures(this._datasetId)}},{key:"type",get:function(){return"Dataset"}}]),t}(op),up=function(e){function t(e,r){var n;return Ue(this,t),n=Ze(this,je(t).call(this,e)),Array.isArray(r)||(r=[r]),n._datasetIds=r,n}return ze(t,e),Ge(t,[{key:"load",value:function(){return this._api.get3DDatasetScene(this._datasetIds).then((function(e){return e}))}},{key:"loadSubResourceSupported",value:function(){return!0}},{key:"loadSubResource",value:function(e,t){var r=yv.resolveUrl(this._base_url,e);return this._api.fetch(Qc.METHOD.GET,r)}},{key:"resolveResourceSupported",value:function(){return!0}},{key:"resolveResource",value:function(e){return new lp(this._api,e,{transform:this._transform})}},{key:"type",get:function(){return"3DDatasetScene"}}]),t}(op),lp=function(e){function t(e,r){var n;Ue(this,t),(n=Ze(this,je(t).call(this,e)))._url=r;var i=r.lastIndexOf("/");if(-1===i)throw new Error("invalid url");return n._base_url=n._url.substr(0,i+1),n}return ze(t,e),Ge(t,[{key:"load",value:function(){return this._api.fetch(Qc.METHOD.GET,this._url)}},{key:"loadSubResourceSupported",value:function(){return!0}},{key:"loadSubResource",value:function(e,t){var r=yv.resolveUrl(this._base_url,e);return t===Hd.ResourceType.BINARY?this._api.fetch(Qc.METHOD.GET,r).then((function(e){if(!e.ok)throw new Error(e.statusText);return e.arrayBuffer()})):t===Hd.ResourceType.IMAGE?this._api.fetch(Qc.METHOD.GET,r).then((function(e){if(!e.ok)throw new Error(e.statusText);return e.blob()})).then(yv.loadImage):this._api.fetch(Qc.METHOD.GET,e)}},{key:"type",get:function(){return"3DDatasetSceneBlob"}}]),t}(op),_p=function(e){function t(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Ue(this,t),e=Ze(this,je(t).call(this));var n=r.basePath.endsWith("/")?r.basePath.slice(0,-1):r.basePath;return e._option={token:r.token,version:r.version,basePath:n,userId:r.userId},e}return ze(t,e),Ge(t,[{key:"getDatasetAsResource",value:function(e){return new sp(this,e)}},{key:"get3DDatasetAsResource",value:function(e){return new up(this,e)}},{key:"getDatasets",value:function(){var e=this._option;return this.get("datasets",[e.userId],null)}},{key:"getDataset",value:function(e){var t=this._option;return this.get("datasets",[t.userId,e],null)}},{key:"createDataset",value:function(e,t){var r=this._option,n={name:e,description:t};return this.post("datasets",[r.userId],null,n)}},{key:"deleteDataset",value:function(e){var t=this._option;return this.delete("datasets",[t.userId,e])}},{key:"listFeatures",value:function(e){var t=this._option;return this.get("datasets",[t.userId,e,"features"])}},{key:"insertFeature",value:function(e,t){var r=this._option;return this.post("datasets",[r.userId,e,"features"],null,t)}},{key:"updateFeature",value:function(e,t,r){var n=this._option;return this.put("datasets",[n.userId,"features",t],null,r)}},{key:"list3DDatasets",value:function(){var e=this._option;return this.get("3ddatasets",[e.userId])}},{key:"create3DDataset",value:function(e,t,r){var n=this._option,i={name:e,description:t,path:r.path,format:r.format,srid:r.srid,x:r.x,y:r.y,z:r.z};return this.post("3ddatasets",[n.userId],null,i)}},{key:"update3DDataset",value:function(e,t,r,n){var i=this._option,a={name:t,description:r,path:n.path,format:n.format,srid:n.srid,x:n.x,y:n.y,z:n.z};return this.patch("3ddatasets",[i.userId,e],null,a)}},{key:"create3DDatasetUploadUrl",value:function(e){var t=this._option;return this.post("3ddatasets",["uploads",t.userId,e],null,{})}},{key:"get3DDataset",value:function(e){var t=this._option;return this.get("3ddatasets",[t.userId,e],null)}},{key:"delete3DDataset",value:function(e){var t=this._option;return this.delete("3ddatasets",[t.userId,e])}},{key:"get3DDatasetScene",value:function(e){var t=this._option;return this.get("3ddatasets",["scene",t.userId],{"3ddatasets_ids":Array.isArray(e)?e.join(","):e}).then((function(e){return e.entity_list.forEach((function(e){var t=e.index,r=parseInt(t);if(r.toString()!==t)throw new Error("Internal Error: ID couldn't be convert to 'number'");e.index=r})),e}))}},{key:"get",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.fetchAPI(Qc.METHOD.GET,e,t,r,null,n)}},{key:"post",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return"string"!=typeof n&&(n=JSON.stringify(n)),this.fetchAPI(Qc.METHOD.POST,e,t,r,n,i)}},{key:"patch",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return"string"!=typeof n&&(n=JSON.stringify(n)),this.fetchAPI(Qc.METHOD.PATCH,e,t,r,n,i)}},{key:"put",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return"string"!=typeof n&&(n=JSON.stringify(n)),this.fetchAPI(Qc.METHOD.PUT,e,t,r,n,i)}},{key:"delete",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.fetchAPI(Qc.METHOD.DELETE,e,t,r,null,n)}},{key:"fetchAPI",value:function(e,t,r,n,i){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},o=this._option,s=o.basePath+"/"+t+"/"+o.version+(r.length>0?"/"+r.join("/"):"");return console.log("MaprayAPI: "+e+" "+s+(n?"?"+JSON.stringify(n):"")),this.fetch(e,s,n,i,a)}},{key:"fetch",value:function(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},a=this._option,o=i.headers||(i.headers={});return o["x-api-key"]=a.token,Qc.fetch(e,t,r,n,i).then((function(e){if(e.status!==Qc.RESPONSE_STATUS.NO_CONTENT){var t=e.headers.get(Qc.CONTENT_TYPE);return Qc.isJson(t)?e.json():(console.log("Unsupported Mime Type: "+t),e)}})).catch((function(e){if("FetchError"===e.name&&e.response)return e.response.json().catch((function(r){throw new ap(-1,"Failed to fetch",t,null,e)})).then((function(r){throw new ap(r.code,r.error,t,e.response,e)}));throw new ap(-1,"Failed to fetch",t,null,e)}))}}]),t}(Qc);_p.CLOUD_BASE_PATH="http://localhost:8080";var cp={animation:nu,Viewer:ey,Camera:au,GeoMath:us,GeoPoint:ls,Orientation:_s,Ray:iu,AltitudeMode:bl,CredentialMode:e_,Layer:xc,LayerCollection:Ac,DemProvider:wc,StandardDemProvider:bc,CloudDemProvider:ny,ImageProvider:Bl,RenderCallback:Tc,StandardImageProvider:t_,Scene:Cc,Entity:xl,MarkerLineEntity:Gv,TextEntity:Zv,ModelEntity:td,PolygonEntity:yd,PinEntity:fy,ImageIconEntity:wy,SceneLoader:Hd,GeoJSONLoader:Oy,URLResource:mv,MaprayApi:_p,DebugStats:Zy,LogoController:$d,AttributionController:Jd};window.maprayRequestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame,window.maprayCancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame;var hp=window.performance,fp=hp&&(hp.now||hp.mozNow||hp.msNow||hp.oNow||hp.webkitNow),vp=new Date;return window.maprayNow=fp?function(){return fp.call(hp)}:function(){return vp.getTime()},Math.maprayLog2=Math.log2||function(e){return 1.4426950408889634*Math.log(e)},cp}));
