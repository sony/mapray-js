!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).mapray=t()}(this,(function(){"use strict";var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function t(e,t){return e(t={exports:{}},t.exports),t.exports}var r=function(e){return e&&e.Math==Math&&e},n=r("object"==typeof globalThis&&globalThis)||r("object"==typeof window&&window)||r("object"==typeof self&&self)||r("object"==typeof e&&e)||Function("return this")(),i=function(e){try{return!!e()}catch(e){return!0}},a=!i((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),o=function(e){return"object"==typeof e?null!==e:"function"==typeof e},s=n.document,u=o(s)&&o(s.createElement),_=function(e){return u?s.createElement(e):{}},l=!a&&!i((function(){return 7!=Object.defineProperty(_("div"),"a",{get:function(){return 7}}).a})),c=function(e){if(!o(e))throw TypeError(String(e)+" is not an object");return e},h=function(e,t){if(!o(e))return e;var r,n;if(t&&"function"==typeof(r=e.toString)&&!o(n=r.call(e)))return n;if("function"==typeof(r=e.valueOf)&&!o(n=r.call(e)))return n;if(!t&&"function"==typeof(r=e.toString)&&!o(n=r.call(e)))return n;throw TypeError("Can't convert object to primitive value")},f=Object.defineProperty,d={f:a?f:function(e,t,r){if(c(e),t=h(t,!0),c(r),l)try{return f(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported");return"value"in r&&(e[t]=r.value),e}},v=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},p=a?function(e,t,r){return d.f(e,t,v(1,r))}:function(e,t,r){return e[t]=r,e},y={}.hasOwnProperty,g=function(e,t){return y.call(e,t)},m=function(e,t){try{p(n,e,t)}catch(r){n[e]=t}return t},k=n["__core-js_shared__"]||m("__core-js_shared__",{}),E=Function.toString;"function"!=typeof k.inspectSource&&(k.inspectSource=function(e){return E.call(e)});var w,b,x,T=k.inspectSource,A=n.WeakMap,R="function"==typeof A&&/native code/.test(T(A)),I=t((function(e){(e.exports=function(e,t){return k[e]||(k[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.6.4",mode:"global",copyright:"© 2020 Denis Pushkarev (zloirock.ru)"})})),P=0,S=Math.random(),M=function(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++P+S).toString(36)},L=I("keys"),D=function(e){return L[e]||(L[e]=M(e))},C={},F=n.WeakMap;if(R){var N=new F,O=N.get,U=N.has,V=N.set;w=function(e,t){return V.call(N,e,t),t},b=function(e){return O.call(N,e)||{}},x=function(e){return U.call(N,e)}}else{var B=D("state");C[B]=!0,w=function(e,t){return p(e,B,t),t},b=function(e){return g(e,B)?e[B]:{}},x=function(e){return g(e,B)}}var z={set:w,get:b,has:x,enforce:function(e){return x(e)?b(e):w(e,{})},getterFor:function(e){return function(t){var r;if(!o(t)||(r=b(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return r}}},G=t((function(e){var t=z.get,r=z.enforce,i=String(String).split("String");(e.exports=function(e,t,a,o){var s=!!o&&!!o.unsafe,u=!!o&&!!o.enumerable,_=!!o&&!!o.noTargetGet;"function"==typeof a&&("string"!=typeof t||g(a,"name")||p(a,"name",t),r(a).source=i.join("string"==typeof t?t:"")),e!==n?(s?!_&&e[t]&&(u=!0):delete e[t],u?e[t]=a:p(e,t,a)):u?e[t]=a:m(t,a)})(Function.prototype,"toString",(function(){return"function"==typeof this&&t(this).source||T(this)}))})),j=Date.prototype,q=j.toString,Y=j.getTime;new Date(NaN)+""!="Invalid Date"&&G(j,"toString",(function(){var e=Y.call(this);return e==e?q.call(this):"Invalid Date"}));var H={}.propertyIsEnumerable,X=Object.getOwnPropertyDescriptor,W={f:X&&!H.call({1:2},1)?function(e){var t=X(this,e);return!!t&&t.enumerable}:H},Q={}.toString,Z=function(e){return Q.call(e).slice(8,-1)},J="".split,K=i((function(){return!Object("z").propertyIsEnumerable(0)}))?function(e){return"String"==Z(e)?J.call(e,""):Object(e)}:Object,$=function(e){if(null==e)throw TypeError("Can't call method on "+e);return e},ee=function(e){return K($(e))},te=Object.getOwnPropertyDescriptor,re={f:a?te:function(e,t){if(e=ee(e),t=h(t,!0),l)try{return te(e,t)}catch(e){}if(g(e,t))return v(!W.f.call(e,t),e[t])}},ne=n,ie=function(e){return"function"==typeof e?e:void 0},ae=function(e,t){return arguments.length<2?ie(ne[e])||ie(n[e]):ne[e]&&ne[e][t]||n[e]&&n[e][t]},oe=Math.ceil,se=Math.floor,ue=function(e){return isNaN(e=+e)?0:(e>0?se:oe)(e)},_e=Math.min,le=function(e){return e>0?_e(ue(e),9007199254740991):0},ce=Math.max,he=Math.min,fe=function(e,t){var r=ue(e);return r<0?ce(r+t,0):he(r,t)},de=function(e){return function(t,r,n){var i,a=ee(t),o=le(a.length),s=fe(n,o);if(e&&r!=r){for(;o>s;)if((i=a[s++])!=i)return!0}else for(;o>s;s++)if((e||s in a)&&a[s]===r)return e||s||0;return!e&&-1}},ve={includes:de(!0),indexOf:de(!1)},pe=ve.indexOf,ye=function(e,t){var r,n=ee(e),i=0,a=[];for(r in n)!g(C,r)&&g(n,r)&&a.push(r);for(;t.length>i;)g(n,r=t[i++])&&(~pe(a,r)||a.push(r));return a},ge=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],me=ge.concat("length","prototype"),ke={f:Object.getOwnPropertyNames||function(e){return ye(e,me)}},Ee={f:Object.getOwnPropertySymbols},we=ae("Reflect","ownKeys")||function(e){var t=ke.f(c(e)),r=Ee.f;return r?t.concat(r(e)):t},be=function(e,t){for(var r=we(t),n=d.f,i=re.f,a=0;a<r.length;a++){var o=r[a];g(e,o)||n(e,o,i(t,o))}},xe=/#|\.prototype\./,Te=function(e,t){var r=Re[Ae(e)];return r==Pe||r!=Ie&&("function"==typeof t?i(t):!!t)},Ae=Te.normalize=function(e){return String(e).replace(xe,".").toLowerCase()},Re=Te.data={},Ie=Te.NATIVE="N",Pe=Te.POLYFILL="P",Se=Te,Me=re.f,Le=function(e,t){var r,i,a,o,s,u=e.target,_=e.global,l=e.stat;if(r=_?n:l?n[u]||m(u,{}):(n[u]||{}).prototype)for(i in t){if(o=t[i],a=e.noTargetGet?(s=Me(r,i))&&s.value:r[i],!Se(_?i:u+(l?".":"#")+i,e.forced)&&void 0!==a){if(typeof o==typeof a)continue;be(o,a)}(e.sham||a&&a.sham)&&p(o,"sham",!0),G(r,i,o,e)}},De=Math.log,Ce=Math.LN2;Le({target:"Math",stat:!0},{log2:function(e){return De(e)/Ce}});var Fe=d.f,Ne=Function.prototype,Oe=Ne.toString,Ue=/^\s*function ([^ (]*)/;function Ve(e){return(Ve="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Be(e,t,r,n,i,a,o){try{var s=e[a](o),u=s.value}catch(e){return void r(e)}s.done?t(u):Promise.resolve(u).then(n,i)}function ze(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var a=e.apply(t,r);function o(e){Be(a,n,i,o,s,"next",e)}function s(e){Be(a,n,i,o,s,"throw",e)}o(void 0)}))}}function Ge(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function je(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function qe(e,t,r){return t&&je(e.prototype,t),r&&je(e,r),e}function Ye(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Xe(e,t)}function He(e){return(He=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Xe(e,t){return(Xe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function We(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function Qe(e,t,r){return(Qe=We()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&Xe(i,r.prototype),i}).apply(null,arguments)}function Ze(e){var t="function"==typeof Map?new Map:void 0;return(Ze=function(e){if(null===e||(r=e,-1===Function.toString.call(r).indexOf("[native code]")))return e;var r;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return Qe(e,arguments,He(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),Xe(n,e)})(e)}function Je(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ke(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?Je(e):t}function $e(e,t,r){return($e="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=He(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(r):i.value}})(e,t,r||e)}function et(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var r=[],n=!0,i=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function tt(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}!a||"name"in Ne||Fe(Ne,"name",{configurable:!0,get:function(){try{return Oe.call(this).match(Ue)[1]}catch(e){return""}}});var rt,nt=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this,e))).name="mapray.animation.AnimationError",r}return Ye(t,e),t}(Ze(Error)),it=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,r={};try{(e=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(r,[]),t=r instanceof Array}catch(e){}return function(r,n){return c(r),function(e){if(!o(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype")}(n),t?e.call(r,n):r.__proto__=n,r}}():void 0),at=function(e,t,r){var n,i;return it&&"function"==typeof(n=t.constructor)&&n!==r&&o(i=n.prototype)&&i!==r.prototype&&it(e,i),e},ot=Object.keys||function(e){return ye(e,ge)},st=a?Object.defineProperties:function(e,t){c(e);for(var r,n=ot(t),i=n.length,a=0;i>a;)d.f(e,r=n[a++],t[r]);return e},ut=ae("document","documentElement"),_t=D("IE_PROTO"),lt=function(){},ct=function(e){return"<script>"+e+"<\/script>"},ht=function(){try{rt=document.domain&&new ActiveXObject("htmlfile")}catch(e){}var e,t;ht=rt?function(e){e.write(ct("")),e.close();var t=e.parentWindow.Object;return e=null,t}(rt):((t=_("iframe")).style.display="none",ut.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write(ct("document.F=Object")),e.close(),e.F);for(var r=ge.length;r--;)delete ht.prototype[ge[r]];return ht()};C[_t]=!0;var ft=Object.create||function(e,t){var r;return null!==e?(lt.prototype=c(e),r=new lt,lt.prototype=null,r[_t]=e):r=ht(),void 0===t?r:st(r,t)},dt="\t\n\v\f\r                　\u2028\u2029\ufeff",vt="["+dt+"]",pt=RegExp("^"+vt+vt+"*"),yt=RegExp(vt+vt+"*$"),gt=function(e){return function(t){var r=String($(t));return 1&e&&(r=r.replace(pt,"")),2&e&&(r=r.replace(yt,"")),r}},mt={start:gt(1),end:gt(2),trim:gt(3)},kt=ke.f,Et=re.f,wt=d.f,bt=mt.trim,xt=n.Number,Tt=xt.prototype,At="Number"==Z(ft(Tt)),Rt=function(e){var t,r,n,i,a,o,s,u,_=h(e,!1);if("string"==typeof _&&_.length>2)if(43===(t=(_=bt(_)).charCodeAt(0))||45===t){if(88===(r=_.charCodeAt(2))||120===r)return NaN}else if(48===t){switch(_.charCodeAt(1)){case 66:case 98:n=2,i=49;break;case 79:case 111:n=8,i=55;break;default:return+_}for(o=(a=_.slice(2)).length,s=0;s<o;s++)if((u=a.charCodeAt(s))<48||u>i)return NaN;return parseInt(a,n)}return+_};if(Se("Number",!xt(" 0o1")||!xt("0b1")||xt("+0x1"))){for(var It,Pt=function(e){var t=arguments.length<1?0:e,r=this;return r instanceof Pt&&(At?i((function(){Tt.valueOf.call(r)})):"Number"!=Z(r))?at(new xt(Rt(t)),r,Pt):Rt(t)},St=a?kt(xt):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),Mt=0;St.length>Mt;Mt++)g(xt,It=St[Mt])&&!g(Pt,It)&&wt(Pt,It,Et(xt,It));Pt.prototype=Tt,Tt.constructor=Pt,G(n,"Number",Pt)}var Lt=function(){function e(t){Ge(this,e),this._ntime=t}return qe(e,[{key:"toNumber",value:function(){return this._ntime}},{key:"equals",value:function(e){return this._ntime==e._ntime}},{key:"lessThan",value:function(e){return this._ntime<e._ntime}},{key:"lessEqual",value:function(e){return this._ntime<=e._ntime}}],[{key:"fromNumber",value:function(t){return new e(t)}},{key:"MIN_TIME",get:function(){return Ft}},{key:"MAX_TIME",get:function(){return Nt}},{key:"MIN_NTIME",get:function(){return Dt}},{key:"MAX_NTIME",get:function(){return Ct}}]),e}(),Dt=-Number.MAX_VALUE,Ct=+Number.MAX_VALUE,Ft=Lt.fromNumber(Dt),Nt=Lt.fromNumber(Ct),Ot=function(){function e(t,r,n,i){Ge(this,e),this._lower=t,this._upper=r,this._l_open=void 0!==n&&n,this._u_open=void 0!==i&&i}return qe(e,[{key:"isEmpty",value:function(){var e=this._lower,t=this._upper;return t.lessThan(e)||t.equals(e)&&(this._l_open||this._u_open)}},{key:"isSingle",value:function(){return this._lower.equals(this._upper)&&!(this._l_open||this._u_open)}},{key:"isProper",value:function(){return this._lower.lessThan(this._upper)}},{key:"precedes",value:function(e){if(this.isEmpty()||e.isEmpty())return!0;var t=this._upper,r=this._u_open,n=e._lower,i=e._l_open;return t.lessThan(n)||t.equals(n)&&(r||i)}},{key:"includes",value:function(e){if(e.isEmpty())return!0;var t=this._lower,r=e._lower,n=this._l_open,i=e._l_open,a=t.lessThan(r)||t.equals(r)&&(!n||i),o=this._upper,s=e._upper,u=this._u_open,_=e._u_open,l=s.lessThan(o)||s.equals(o)&&(_||!u);return a&&l}},{key:"includesTime",value:function(e){var t=this._lower,r=t.lessThan(e)||t.equals(e)&&!this._l_open,n=this._upper,i=e.lessThan(n)||e.equals(n)&&!this._u_open;return r&&i}},{key:"hasIntersection",value:function(e){return!this.getIntersection(e).isEmpty()}},{key:"getPrecedings",value:function(){return this.isEmpty()?Ut:new e(Lt.MIN_TIME,this._lower,!1,!this._l_open)}},{key:"getFollowings",value:function(){return this.isEmpty()?Ut:new e(this._upper,Lt.MAX_TIME,!this._u_open,!1)}},{key:"getIntersection",value:function(e){return this._getIntersectionByLower(e._lower,e._l_open)._getIntersectionByUpper(e._upper,e._u_open)}},{key:"getUnion",value:function(t){if(this.isEmpty())return t.isEmpty()?[]:[t];if(t.isEmpty())return[this];var r=this._lower,n=this._upper,i=this._l_open,a=this._u_open,o=t._lower,s=t._upper,u=t._l_open,_=t._u_open;if(n.lessThan(o)||n.equals(o)&&a&&u)return[this,t];if(s.lessThan(r)||r.equals(s)&&i&&_)return[t,this];var l=et(r.lessThan(o)||r.equals(o)&&u?[r,i]:[o,u],2),c=l[0],h=l[1],f=et(s.lessThan(n)||s.equals(n)&&_?[n,a]:[s,_],2);return[new e(c,f[0],h,f[1])]}},{key:"getDifference",value:function(e){var t=this._getIntersectionByUpper(e._lower,!e._l_open),r=this._getIntersectionByLower(e._upper,!e._u_open);return t.getUnion(r)}},{key:"getComplement",value:function(){return Ut.getDifference(this)}},{key:"_getIntersectionByLower",value:function(t,r){return t.lessThan(this._lower)||t.equals(this._lower)&&this._l_open?this:new e(t,this._upper,r,this._u_open)}},{key:"_getIntersectionByUpper",value:function(t,r){return this._upper.lessThan(t)||this._upper.equals(t)&&this._u_open?this:new e(this._lower,t,this._l_open,r)}},{key:"lower",get:function(){return this._lower}},{key:"upper",get:function(){return this._upper}},{key:"l_open",get:function(){return this._l_open}},{key:"u_open",get:function(){return this._u_open}}],[{key:"UNIVERSAL",get:function(){return Ut}}]),e}(),Ut=new Ot(Lt.MIN_TIME,Lt.MAX_TIME),Vt=!!Object.getOwnPropertySymbols&&!i((function(){return!String(Symbol())})),Bt=Vt&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,zt=Array.isArray||function(e){return"Array"==Z(e)},Gt=function(e){return Object($(e))},jt=ke.f,qt={}.toString,Yt="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],Ht={f:function(e){return Yt&&"[object Window]"==qt.call(e)?function(e){try{return jt(e)}catch(e){return Yt.slice()}}(e):jt(ee(e))}},Xt=I("wks"),Wt=n.Symbol,Qt=Bt?Wt:Wt&&Wt.withoutSetter||M,Zt=function(e){return g(Xt,e)||(Vt&&g(Wt,e)?Xt[e]=Wt[e]:Xt[e]=Qt("Symbol."+e)),Xt[e]},Jt={f:Zt},Kt=d.f,$t=function(e){var t=ne.Symbol||(ne.Symbol={});g(t,e)||Kt(t,e,{value:Jt.f(e)})},er=d.f,tr=Zt("toStringTag"),rr=function(e,t,r){e&&!g(e=r?e:e.prototype,tr)&&er(e,tr,{configurable:!0,value:t})},nr=function(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e},ir=function(e,t,r){if(nr(e),void 0===t)return e;switch(r){case 0:return function(){return e.call(t)};case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,i){return e.call(t,r,n,i)}}return function(){return e.apply(t,arguments)}},ar=Zt("species"),or=function(e,t){var r;return zt(e)&&("function"!=typeof(r=e.constructor)||r!==Array&&!zt(r.prototype)?o(r)&&null===(r=r[ar])&&(r=void 0):r=void 0),new(void 0===r?Array:r)(0===t?0:t)},sr=[].push,ur=function(e){var t=1==e,r=2==e,n=3==e,i=4==e,a=6==e,o=5==e||a;return function(s,u,_,l){for(var c,h,f=Gt(s),d=K(f),v=ir(u,_,3),p=le(d.length),y=0,g=l||or,m=t?g(s,p):r?g(s,0):void 0;p>y;y++)if((o||y in d)&&(h=v(c=d[y],y,f),e))if(t)m[y]=h;else if(h)switch(e){case 3:return!0;case 5:return c;case 6:return y;case 2:sr.call(m,c)}else if(i)return!1;return a?-1:n||i?i:m}},_r={forEach:ur(0),map:ur(1),filter:ur(2),some:ur(3),every:ur(4),find:ur(5),findIndex:ur(6)},lr=_r.forEach,cr=D("hidden"),hr=Zt("toPrimitive"),fr=z.set,dr=z.getterFor("Symbol"),vr=Object.prototype,pr=n.Symbol,yr=ae("JSON","stringify"),gr=re.f,mr=d.f,kr=Ht.f,Er=W.f,wr=I("symbols"),br=I("op-symbols"),xr=I("string-to-symbol-registry"),Tr=I("symbol-to-string-registry"),Ar=I("wks"),Rr=n.QObject,Ir=!Rr||!Rr.prototype||!Rr.prototype.findChild,Pr=a&&i((function(){return 7!=ft(mr({},"a",{get:function(){return mr(this,"a",{value:7}).a}})).a}))?function(e,t,r){var n=gr(vr,t);n&&delete vr[t],mr(e,t,r),n&&e!==vr&&mr(vr,t,n)}:mr,Sr=function(e,t){var r=wr[e]=ft(pr.prototype);return fr(r,{type:"Symbol",tag:e,description:t}),a||(r.description=t),r},Mr=Bt?function(e){return"symbol"==typeof e}:function(e){return Object(e)instanceof pr},Lr=function(e,t,r){e===vr&&Lr(br,t,r),c(e);var n=h(t,!0);return c(r),g(wr,n)?(r.enumerable?(g(e,cr)&&e[cr][n]&&(e[cr][n]=!1),r=ft(r,{enumerable:v(0,!1)})):(g(e,cr)||mr(e,cr,v(1,{})),e[cr][n]=!0),Pr(e,n,r)):mr(e,n,r)},Dr=function(e,t){c(e);var r=ee(t),n=ot(r).concat(Or(r));return lr(n,(function(t){a&&!Cr.call(r,t)||Lr(e,t,r[t])})),e},Cr=function(e){var t=h(e,!0),r=Er.call(this,t);return!(this===vr&&g(wr,t)&&!g(br,t))&&(!(r||!g(this,t)||!g(wr,t)||g(this,cr)&&this[cr][t])||r)},Fr=function(e,t){var r=ee(e),n=h(t,!0);if(r!==vr||!g(wr,n)||g(br,n)){var i=gr(r,n);return!i||!g(wr,n)||g(r,cr)&&r[cr][n]||(i.enumerable=!0),i}},Nr=function(e){var t=kr(ee(e)),r=[];return lr(t,(function(e){g(wr,e)||g(C,e)||r.push(e)})),r},Or=function(e){var t=e===vr,r=kr(t?br:ee(e)),n=[];return lr(r,(function(e){!g(wr,e)||t&&!g(vr,e)||n.push(wr[e])})),n};if(Vt||(G((pr=function(){if(this instanceof pr)throw TypeError("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?String(arguments[0]):void 0,t=M(e),r=function(e){this===vr&&r.call(br,e),g(this,cr)&&g(this[cr],t)&&(this[cr][t]=!1),Pr(this,t,v(1,e))};return a&&Ir&&Pr(vr,t,{configurable:!0,set:r}),Sr(t,e)}).prototype,"toString",(function(){return dr(this).tag})),G(pr,"withoutSetter",(function(e){return Sr(M(e),e)})),W.f=Cr,d.f=Lr,re.f=Fr,ke.f=Ht.f=Nr,Ee.f=Or,Jt.f=function(e){return Sr(Zt(e),e)},a&&(mr(pr.prototype,"description",{configurable:!0,get:function(){return dr(this).description}}),G(vr,"propertyIsEnumerable",Cr,{unsafe:!0}))),Le({global:!0,wrap:!0,forced:!Vt,sham:!Vt},{Symbol:pr}),lr(ot(Ar),(function(e){$t(e)})),Le({target:"Symbol",stat:!0,forced:!Vt},{for:function(e){var t=String(e);if(g(xr,t))return xr[t];var r=pr(t);return xr[t]=r,Tr[r]=t,r},keyFor:function(e){if(!Mr(e))throw TypeError(e+" is not a symbol");if(g(Tr,e))return Tr[e]},useSetter:function(){Ir=!0},useSimple:function(){Ir=!1}}),Le({target:"Object",stat:!0,forced:!Vt,sham:!a},{create:function(e,t){return void 0===t?ft(e):Dr(ft(e),t)},defineProperty:Lr,defineProperties:Dr,getOwnPropertyDescriptor:Fr}),Le({target:"Object",stat:!0,forced:!Vt},{getOwnPropertyNames:Nr,getOwnPropertySymbols:Or}),Le({target:"Object",stat:!0,forced:i((function(){Ee.f(1)}))},{getOwnPropertySymbols:function(e){return Ee.f(Gt(e))}}),yr){var Ur=!Vt||i((function(){var e=pr();return"[null]"!=yr([e])||"{}"!=yr({a:e})||"{}"!=yr(Object(e))}));Le({target:"JSON",stat:!0,forced:Ur},{stringify:function(e,t,r){for(var n,i=[e],a=1;arguments.length>a;)i.push(arguments[a++]);if(n=t,(o(t)||void 0!==e)&&!Mr(e))return zt(t)||(t=function(e,t){if("function"==typeof n&&(t=n.call(this,e,t)),!Mr(t))return t}),i[1]=t,yr.apply(null,i)}})}pr.prototype[hr]||p(pr.prototype,hr,pr.prototype.valueOf),rr(pr,"Symbol"),C[cr]=!0;var Vr=d.f,Br=n.Symbol;if(a&&"function"==typeof Br&&(!("description"in Br.prototype)||void 0!==Br().description)){var zr={},Gr=function(){var e=arguments.length<1||void 0===arguments[0]?void 0:String(arguments[0]),t=this instanceof Gr?new Br(e):void 0===e?Br():Br(e);return""===e&&(zr[t]=!0),t};be(Gr,Br);var jr=Gr.prototype=Br.prototype;jr.constructor=Gr;var qr=jr.toString,Yr="Symbol(test)"==String(Br("test")),Hr=/^Symbol\((.*)\)[^)]+$/;Vr(jr,"description",{configurable:!0,get:function(){var e=o(this)?this.valueOf():this,t=qr.call(e);if(g(zr,e))return"";var r=Yr?t.slice(7,-1):t.replace(Hr,"$1");return""===r?void 0:r}}),Le({global:!0,forced:!0},{Symbol:Gr})}$t("iterator");var Xr=Zt("unscopables"),Wr=Array.prototype;null==Wr[Xr]&&d.f(Wr,Xr,{configurable:!0,value:ft(null)});var Qr=function(e){Wr[Xr][e]=!0},Zr=Object.defineProperty,Jr={},Kr=function(e){throw e},$r=function(e,t){if(g(Jr,e))return Jr[e];t||(t={});var r=[][e],n=!!g(t,"ACCESSORS")&&t.ACCESSORS,o=g(t,0)?t[0]:Kr,s=g(t,1)?t[1]:void 0;return Jr[e]=!!r&&!i((function(){if(n&&!a)return!0;var e={length:-1};n?Zr(e,1,{enumerable:!0,get:Kr}):e[1]=1,r.call(e,o,s)}))},en=ve.includes,tn=$r("indexOf",{ACCESSORS:!0,1:0});Le({target:"Array",proto:!0,forced:!tn},{includes:function(e){return en(this,e,arguments.length>1?arguments[1]:void 0)}}),Qr("includes");var rn,nn,an,on={},sn=!i((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),un=D("IE_PROTO"),_n=Object.prototype,ln=sn?Object.getPrototypeOf:function(e){return e=Gt(e),g(e,un)?e[un]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?_n:null},cn=Zt("iterator"),hn=!1;[].keys&&("next"in(an=[].keys())?(nn=ln(ln(an)))!==Object.prototype&&(rn=nn):hn=!0),null==rn&&(rn={}),g(rn,cn)||p(rn,cn,(function(){return this}));var fn={IteratorPrototype:rn,BUGGY_SAFARI_ITERATORS:hn},dn=fn.IteratorPrototype,vn=function(){return this},pn=function(e,t,r){var n=t+" Iterator";return e.prototype=ft(dn,{next:v(1,r)}),rr(e,n,!1),on[n]=vn,e},yn=fn.IteratorPrototype,gn=fn.BUGGY_SAFARI_ITERATORS,mn=Zt("iterator"),kn=function(){return this},En=function(e,t,r,n,i,a,o){pn(r,t,n);var s,u,_,l=function(e){if(e===i&&v)return v;if(!gn&&e in f)return f[e];switch(e){case"keys":case"values":case"entries":return function(){return new r(this,e)}}return function(){return new r(this)}},c=t+" Iterator",h=!1,f=e.prototype,d=f[mn]||f["@@iterator"]||i&&f[i],v=!gn&&d||l(i),y="Array"==t&&f.entries||d;if(y&&(s=ln(y.call(new e)),yn!==Object.prototype&&s.next&&(ln(s)!==yn&&(it?it(s,yn):"function"!=typeof s[mn]&&p(s,mn,kn)),rr(s,c,!0))),"values"==i&&d&&"values"!==d.name&&(h=!0,v=function(){return d.call(this)}),f[mn]!==v&&p(f,mn,v),on[t]=v,i)if(u={values:l("values"),keys:a?v:l("keys"),entries:l("entries")},o)for(_ in u)!gn&&!h&&_ in f||G(f,_,u[_]);else Le({target:t,proto:!0,forced:gn||h},u);return u},wn=z.set,bn=z.getterFor("Array Iterator"),xn=En(Array,"Array",(function(e,t){wn(this,{type:"Array Iterator",target:ee(e),index:0,kind:t})}),(function(){var e=bn(this),t=e.target,r=e.kind,n=e.index++;return!t||n>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==r?{value:n,done:!1}:"values"==r?{value:t[n],done:!1}:{value:[n,t[n]],done:!1}}),"values");on.Arguments=on.Array,Qr("keys"),Qr("values"),Qr("entries");var Tn={};Tn[Zt("toStringTag")]="z";var An="[object z]"===String(Tn),Rn=Zt("toStringTag"),In="Arguments"==Z(function(){return arguments}()),Pn=An?Z:function(e){var t,r,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),Rn))?r:In?Z(t):"Object"==(n=Z(t))&&"function"==typeof t.callee?"Arguments":n},Sn=An?{}.toString:function(){return"[object "+Pn(this)+"]"};An||G(Object.prototype,"toString",Sn,{unsafe:!0});var Mn=Zt("match"),Ln=function(e){var t;return o(e)&&(void 0!==(t=e[Mn])?!!t:"RegExp"==Z(e))},Dn=function(e){if(Ln(e))throw TypeError("The method doesn't accept regular expressions");return e},Cn=Zt("match"),Fn=function(e){var t=/./;try{"/./"[e](t)}catch(r){try{return t[Cn]=!1,"/./"[e](t)}catch(e){}}return!1};Le({target:"String",proto:!0,forced:!Fn("includes")},{includes:function(e){return!!~String($(this)).indexOf(Dn(e),arguments.length>1?arguments[1]:void 0)}});var Nn=function(e){return function(t,r){var n,i,a=String($(t)),o=ue(r),s=a.length;return o<0||o>=s?e?"":void 0:(n=a.charCodeAt(o))<55296||n>56319||o+1===s||(i=a.charCodeAt(o+1))<56320||i>57343?e?a.charAt(o):n:e?a.slice(o,o+2):i-56320+(n-55296<<10)+65536}},On={codeAt:Nn(!1),charAt:Nn(!0)},Un=On.charAt,Vn=z.set,Bn=z.getterFor("String Iterator");En(String,"String",(function(e){Vn(this,{type:"String Iterator",string:String(e),index:0})}),(function(){var e,t=Bn(this),r=t.string,n=t.index;return n>=r.length?{value:void 0,done:!0}:(e=Un(r,n),t.index+=e.length,{value:e,done:!1})}));var zn,Gn={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},jn=Zt("iterator"),qn=Zt("toStringTag"),Yn=xn.values;for(var Hn in Gn){var Xn=n[Hn],Wn=Xn&&Xn.prototype;if(Wn){if(Wn[jn]!==Yn)try{p(Wn,jn,Yn)}catch(e){Wn[jn]=Yn}if(Wn[qn]||p(Wn,qn,Hn),Gn[Hn])for(var Qn in xn)if(Wn[Qn]!==xn[Qn])try{p(Wn,Qn,xn[Qn])}catch(e){Wn[Qn]=xn[Qn]}}}var Zn=function(){function e(t){Ge(this,e),this._compare=t,this._root=zn,this._size=0}return qe(e,[{key:"clone",value:function(){var t=new e(this._compare);return this._root!==zn&&(t._root=this._root._clone(zn)),t._size=this._size,t}},{key:"isEmpty",value:function(){return this._root===zn}},{key:"findFirst",value:function(){return this._root!==zn?this._root._findMinimum():null}},{key:"findLast",value:function(){return this._root!==zn?this._root._findMaximum():null}},{key:"findLower",value:function(e){return this._root._findLowerBound(e,this._compare)}},{key:"findUpper",value:function(e){return this._root._findUpperBound(e,this._compare)}},{key:"findEqual",value:function(e){return this._root._findEqual(e,this._compare)}},{key:"clear",value:function(){this._root=zn,this._size=0}},{key:"insert",value:function(e,t){for(var r=this._root,n=zn,i=this._compare;r!==zn;)if(n=r,i(e,r.key))r=r._child_L;else{if(!i(r.key,e))return r._value=t,r;r=r._child_R}var a=new Jn(n,e,t);return a._is_red=!0,n===zn?this._root=a:i(e,n.key)?n._child_L=a:n._child_R=a,++this._size,this._insert_fixup(a),a}},{key:"_insert_fixup",value:function(e){for(var t=e;t._parent._is_red;)if(t._parent===t._parent._parent._child_L){var r=t._parent._parent._child_R;r._is_red?(t._parent._is_red=!1,r._is_red=!1,t._parent._parent._is_red=!0,t=t._parent._parent):(t===t._parent._child_R&&(t=t._parent,this._rotate_L(t)),t._parent._is_red=!1,t._parent._parent._is_red=!0,this._rotate_R(t._parent._parent))}else{var n=t._parent._parent._child_L;n._is_red?(t._parent._is_red=!1,n._is_red=!1,t._parent._parent._is_red=!0,t=t._parent._parent):(t===t._parent._child_L&&(t=t._parent,this._rotate_R(t)),t._parent._is_red=!1,t._parent._parent._is_red=!0,this._rotate_L(t._parent._parent))}this._root._is_red=!1}},{key:"remove",value:function(e,t){if(void 0===t)return this._remove(e);for(var r=e;r!=t;)r=this._remove(r);return t}},{key:"_remove",value:function(e){var t,r,n=e.findSuccessor();return e._child_L===zn?(t=e._is_red,r=e._child_R,this._replace(e._child_R,e)):e._child_R===zn?(t=e._is_red,r=e._child_L,this._replace(e._child_L,e)):(t=n._is_red,r=n._child_R,n._parent===e?r._parent=n:(this._replace(n._child_R,n),n._child_R=e._child_R,n._child_R._parent=n),this._replace(n,e),n._child_L=e._child_L,n._child_L._parent=n,n._is_red=e._is_red),--this._size,t||this._remove_fixup(r),n}},{key:"_remove_fixup",value:function(e){for(var t=e;t!==this._root&&!t._is_red;)if(t===t._parent._child_L){var r=t._parent._child_R;r._is_red&&(r._is_red=!1,t._parent._is_red=!0,this._rotate_L(t._parent),r=t._parent._child_R),r._child_L._is_red||r._child_R._is_red?(r._child_R._is_red||(r._child_L._is_red=!1,r._is_red=!0,this._rotate_R(r),r=t._parent._child_R),r._is_red=t._parent._is_red,t._parent._is_red=!1,r._child_R._is_red=!1,this._rotate_L(t._parent),t=this._root):(r._is_red=!0,t=t._parent)}else{var n=t._parent._child_L;n._is_red&&(n._is_red=!1,t._parent._is_red=!0,this._rotate_R(t._parent),n=t._parent._child_L),n._child_R._is_red||n._child_L._is_red?(n._child_L._is_red||(n._child_R._is_red=!1,n._is_red=!0,this._rotate_L(n),n=t._parent._child_L),n._is_red=t._parent._is_red,t._parent._is_red=!1,n._child_L._is_red=!1,this._rotate_R(t._parent),t=this._root):(n._is_red=!0,t=t._parent)}t._is_red=!1}},{key:"_replace",value:function(e,t){var r=t._parent;r!==zn?r._child_L===t?r._child_L=e:r._child_R=e:this._root=e,e._parent=r}},{key:"_rotate_L",value:function(e){var t=e._child_R;e._child_R=t._child_L,t._child_L!==zn&&(t._child_L._parent=e),t._parent=e._parent,e._parent===zn?this._root=t:e===e._parent._child_L?e._parent._child_L=t:e._parent._child_R=t,t._child_L=e,e._parent=t}},{key:"_rotate_R",value:function(e){var t=e._child_L;e._child_L=t._child_R,t._child_R!==zn&&(t._child_R._parent=e),t._parent=e._parent,e._parent===zn?this._root=t:e===e._parent._child_R?e._parent._child_R=t:e._parent._child_L=t,t._child_R=e,e._parent=t}},{key:"size",get:function(){return this._size}}]),e}(),Jn=function(){function e(t,r,n){Ge(this,e),this._parent=t,this._child_L=zn,this._child_R=zn,this._is_red=!1,this._key=r,this._value=n}return qe(e,[{key:"_clone",value:function(t){var r=new e(t,this._key,this._value);return this._child_L!==zn&&(r._child_L=this._child_L._clone(r)),this._child_R!==zn&&(r._child_R=this._child_R._clone(r)),r._is_red=this._is_red,r}},{key:"_findMinimum",value:function(){for(var e=this;e._child_L!==zn;)e=e._child_L;return e}},{key:"_findMaximum",value:function(){for(var e=this;e._child_R!==zn;)e=e._child_R;return e}},{key:"findPredecessor",value:function(){if(this._child_L!==zn)return this._child_L._findMaximum();for(var e=this,t=e._parent;t!==zn&&e===t._child_L;)t=(e=t)._parent;return t!==zn?t:null}},{key:"findSuccessor",value:function(){if(this._child_R!==zn)return this._child_R._findMinimum();for(var e=this,t=e._parent;t!==zn&&e===t._child_R;)t=(e=t)._parent;return t!==zn?t:null}},{key:"_findLowerBound",value:function(e,t){for(var r=this;r!==zn;){if(t(e,r._key)){if(r._child_L!==zn){var n=r._child_L._findLowerBound(e,t);if(null!==n)return n}return r}if(!t(r._key,e))return r;r=r._child_R}return null}},{key:"_findUpperBound",value:function(e,t){for(var r=this;r!==zn;){if(t(e,r._key)){if(r._child_L!==zn){var n=r._child_L._findUpperBound(e,t);if(null!==n)return n}return r}r=r._child_R}return null}},{key:"_findEqual",value:function(e,t){for(var r=this;r!==zn;)if(t(e,r._key))r=r._child_L;else{if(!t(r._key,e))return r;r=r._child_R}return null}},{key:"_findLowerBoundR",value:function(e,t){var r=this;if(r._parent!==zn)return r._findLowerBound(e,t);var n=r._findMinimum(),i=r._findMaximum();do{if(!t(e,n._key)&&!t(i._key,e))break;r._parent._child_L===r?i=r._findMaximum():n=r._findMinimum(),r=r._parent}while(r._parent!==zn);return r._findLowerBound(e,t)}},{key:"key",get:function(){return this._key}},{key:"value",get:function(){return this._value}}]),e}();zn=new Jn;var Kn=function(){function e(){Ge(this,e),this._imap=ei()}return qe(e,[{key:"clone",value:function(){var t=new e;return t._imap=this._imap.clone(),t}},{key:"write",value:function(e){return this.remove(e),this._insert(e),this}},{key:"remove",value:function(e){if(e.isEmpty())return this;var t=e.l_open?this._imap.findUpper(e.lower):this._imap.findLower(e.lower),r=null!==t?t.findPredecessor():this._imap.findLast();if(this._chopItem(r,e),null!==t&&e.includes(t.value)){var n=e.u_open?this._imap.findLower(e.upper):this._imap.findUpper(e.upper),i=null!==n?n.findPredecessor():this._imap.findLast(),a=e.includes(i.value)?n:i;this._imap.remove(t,a),this._chopItem(a,e)}else this._chopItem(t,e);return this}},{key:"getNarrowed",value:function(t){var r=new e;if(t.isEmpty())return r;for(var n=this._imap.findUpper(t.lower),i=null!==n?n.findPredecessor():this._imap.findLast(),a=null!==i&&i.value.hasIntersection(t)?i:n,o=t.u_open?this._imap.findLower(t.upper):this._imap.findUpper(t.upper),s=a;s!==o;s=s.findSuccessor())r._imap.insert(s.key,s.value);return r}},{key:"_$getArray",value:function(){for(var e=[],t=this._imap.findFirst();null!==t;t=t.findSuccessor())e.push(t.value);return e}},{key:"_$modify",value:function(e){var t=e._imap.findFirst();if(null!==t){var r=e._imap.findLast(),n=t.value,i=r.value;this.remove(new Ot(n.lower,i.upper,n.l_open,i.u_open));for(var a=t;null!==a;a=a.findSuccessor())this._insert(a.value)}}},{key:"_$expandIntervalByAlignment",value:function(e){var t,r,n=this._imap,i=n.findLower(e.lower);if(null===i||!i.value.lower.equals(e.lower)||!e.l_open&&i.value.l_open){var a=null!==i?i.findPredecessor():n.findLast();t=null!==a?a.value.hasIntersection(e)?e:a.value.getFollowings():Ot.UNIVERSAL}else t=e;var o=n.findLower(e.upper);if(null===o||!e.upper.equals(o.value.lower)||e.u_open&&o.value.l_open){var s=null!==o?o.findPredecessor():n.findLast();r=null!==s&&s.value.hasIntersection(e)&&(e.upper.lessThan(s.value.upper)||e.upper.equals(s.value.upper)&&(e.u_open||!s.value.u_open))?e:null!==o?o.value.getPrecedings():Ot.UNIVERSAL}else r=e;return new Ot(t.lower,r.upper,t.l_open,r.u_open)}},{key:"_chopItem",value:function(e,t){if(null!==e){var r=e.value.getDifference(t);this._imap.remove(e);var n=!0,i=!1,a=void 0;try{for(var o,s=r[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;u.isProper()&&this._imap.insert(u.lower,u)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}}}},{key:"_insert",value:function(e){e.isProper()&&this._imap.insert(e.lower,e)}},{key:"_merge_from_invariance",value:function(e){for(var t=ei(),r=this._imap.findFirst();null!==r;r=r.findSuccessor())$n(r.value,e,t);this._imap=t}}],[{key:"merge",value:function(t){var r=new e;r.write(Ot.UNIVERSAL);var n=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;r._merge_from_invariance(u)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}return r}}]),e}();function $n(e,t,r){var n=t._imap,i=n.findLower(e.lower),a=null!==i?i.findPredecessor():null;null===a&&(a=n.findFirst());for(var o=n.findUpper(e.upper),s=a;s!==o;s=s.findSuccessor()){var u=s.value,_=e.getIntersection(u);_.isProper()&&r.insert(_.lower,_)}}function ei(){return new Zn((function(e,t){return e.lessThan(t)}))}var ti=!i((function(){return Object.isExtensible(Object.preventExtensions({}))})),ri=t((function(e){var t=d.f,r=M("meta"),n=0,i=Object.isExtensible||function(){return!0},a=function(e){t(e,r,{value:{objectID:"O"+ ++n,weakData:{}}})},s=e.exports={REQUIRED:!1,fastKey:function(e,t){if(!o(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!g(e,r)){if(!i(e))return"F";if(!t)return"E";a(e)}return e[r].objectID},getWeakData:function(e,t){if(!g(e,r)){if(!i(e))return!0;if(!t)return!1;a(e)}return e[r].weakData},onFreeze:function(e){return ti&&s.REQUIRED&&i(e)&&!g(e,r)&&a(e),e}};C[r]=!0})),ni=(ri.REQUIRED,ri.fastKey,ri.getWeakData,ri.onFreeze,Zt("iterator")),ii=Array.prototype,ai=function(e){return void 0!==e&&(on.Array===e||ii[ni]===e)},oi=Zt("iterator"),si=function(e){if(null!=e)return e[oi]||e["@@iterator"]||on[Pn(e)]},ui=function(e,t,r,n){try{return n?t(c(r)[0],r[1]):t(r)}catch(t){var i=e.return;throw void 0!==i&&c(i.call(e)),t}},_i=t((function(e){var t=function(e,t){this.stopped=e,this.result=t};(e.exports=function(e,r,n,i,a){var o,s,u,_,l,h,f,d=ir(r,n,i?2:1);if(a)o=e;else{if("function"!=typeof(s=si(e)))throw TypeError("Target is not iterable");if(ai(s)){for(u=0,_=le(e.length);_>u;u++)if((l=i?d(c(f=e[u])[0],f[1]):d(e[u]))&&l instanceof t)return l;return new t(!1)}o=s.call(e)}for(h=o.next;!(f=h.call(o)).done;)if("object"==typeof(l=ui(o,d,f.value,i))&&l&&l instanceof t)return l;return new t(!1)}).stop=function(e){return new t(!0,e)}})),li=function(e,t,r){if(!(e instanceof t))throw TypeError("Incorrect "+(r?r+" ":"")+"invocation");return e},ci=Zt("iterator"),hi=!1;try{var fi=0,di={next:function(){return{done:!!fi++}},return:function(){hi=!0}};di[ci]=function(){return this},Array.from(di,(function(){throw 2}))}catch(e){}var vi=function(e,t){if(!t&&!hi)return!1;var r=!1;try{var n={};n[ci]=function(){return{next:function(){return{done:r=!0}}}},e(n)}catch(e){}return r},pi=function(e,t,r){var a=-1!==e.indexOf("Map"),s=-1!==e.indexOf("Weak"),u=a?"set":"add",_=n[e],l=_&&_.prototype,c=_,h={},f=function(e){var t=l[e];G(l,e,"add"==e?function(e){return t.call(this,0===e?0:e),this}:"delete"==e?function(e){return!(s&&!o(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return s&&!o(e)?void 0:t.call(this,0===e?0:e)}:"has"==e?function(e){return!(s&&!o(e))&&t.call(this,0===e?0:e)}:function(e,r){return t.call(this,0===e?0:e,r),this})};if(Se(e,"function"!=typeof _||!(s||l.forEach&&!i((function(){(new _).entries().next()})))))c=r.getConstructor(t,e,a,u),ri.REQUIRED=!0;else if(Se(e,!0)){var d=new c,v=d[u](s?{}:-0,1)!=d,p=i((function(){d.has(1)})),y=vi((function(e){new _(e)})),g=!s&&i((function(){for(var e=new _,t=5;t--;)e[u](t,t);return!e.has(-0)}));y||((c=t((function(t,r){li(t,c,e);var n=at(new _,t,c);return null!=r&&_i(r,n[u],n,a),n}))).prototype=l,l.constructor=c),(p||g)&&(f("delete"),f("has"),a&&f("get")),(g||v)&&f(u),s&&l.clear&&delete l.clear}return h[e]=c,Le({global:!0,forced:c!=_},h),rr(c,e),s||r.setStrong(c,e,a),c},yi=function(e,t,r){for(var n in t)G(e,n,t[n],r);return e},gi=Zt("species"),mi=function(e){var t=ae(e),r=d.f;a&&t&&!t[gi]&&r(t,gi,{configurable:!0,get:function(){return this}})},ki=d.f,Ei=ri.fastKey,wi=z.set,bi=z.getterFor,xi={getConstructor:function(e,t,r,n){var i=e((function(e,o){li(e,i,t),wi(e,{type:t,index:ft(null),first:void 0,last:void 0,size:0}),a||(e.size=0),null!=o&&_i(o,e[n],e,r)})),o=bi(t),s=function(e,t,r){var n,i,s=o(e),_=u(e,t);return _?_.value=r:(s.last=_={index:i=Ei(t,!0),key:t,value:r,previous:n=s.last,next:void 0,removed:!1},s.first||(s.first=_),n&&(n.next=_),a?s.size++:e.size++,"F"!==i&&(s.index[i]=_)),e},u=function(e,t){var r,n=o(e),i=Ei(t);if("F"!==i)return n.index[i];for(r=n.first;r;r=r.next)if(r.key==t)return r};return yi(i.prototype,{clear:function(){for(var e=o(this),t=e.index,r=e.first;r;)r.removed=!0,r.previous&&(r.previous=r.previous.next=void 0),delete t[r.index],r=r.next;e.first=e.last=void 0,a?e.size=0:this.size=0},delete:function(e){var t=o(this),r=u(this,e);if(r){var n=r.next,i=r.previous;delete t.index[r.index],r.removed=!0,i&&(i.next=n),n&&(n.previous=i),t.first==r&&(t.first=n),t.last==r&&(t.last=i),a?t.size--:this.size--}return!!r},forEach:function(e){for(var t,r=o(this),n=ir(e,arguments.length>1?arguments[1]:void 0,3);t=t?t.next:r.first;)for(n(t.value,t.key,this);t&&t.removed;)t=t.previous},has:function(e){return!!u(this,e)}}),yi(i.prototype,r?{get:function(e){var t=u(this,e);return t&&t.value},set:function(e,t){return s(this,0===e?0:e,t)}}:{add:function(e){return s(this,e=0===e?0:e,e)}}),a&&ki(i.prototype,"size",{get:function(){return o(this).size}}),i},setStrong:function(e,t,r){var n=t+" Iterator",i=bi(t),a=bi(n);En(e,t,(function(e,t){wi(this,{type:n,target:e,state:i(e),kind:t,last:void 0})}),(function(){for(var e=a(this),t=e.kind,r=e.last;r&&r.removed;)r=r.previous;return e.target&&(e.last=r=r?r.next:e.state.first)?"keys"==t?{value:r.key,done:!1}:"values"==t?{value:r.value,done:!1}:{value:[r.key,r.value],done:!1}:(e.target=void 0,{value:void 0,done:!0})}),r?"entries":"values",!r,!0),mi(t)}},Ti=(pi("Map",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),xi),function(){function e(t){Ge(this,e),this._name=t}return qe(e,[{key:"isConvertible",value:function(e){this._override_error("isConvertible")}},{key:"convertValue",value:function(e,t){this._override_error("convertValue")}},{key:"getDefaultValue",value:function(){this._override_error("getDefaultValue")}},{key:"getCloneValue",value:function(e){this._override_error("getCloneValue")}},{key:"_override_error",value:function(e){throw new Error("Type#"+e+"() method has not been overridden in "+this.constructor.name)}},{key:"name",get:function(){return this._name}}],[{key:"register",value:function(e,t){if(Ii.has(e))throw new Ai("specified name ("+e+") has already been registered");return Ii.set(e,t),t}},{key:"find",value:function(e){var t=Ii.get(e);if(void 0===t)throw new Ri("type with the specified name ("+e+") is not registered");return t}}]),e}()),Ai=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this,e))).name="mapray.animation.Type.AlreadyRegisteredError",r}return Ye(t,e),t}(nt);Ti.AlreadyRegisteredError=Ai;var Ri=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this,e))).name="mapray.animation.Type.NotRegisteredError",r}return Ye(t,e),t}(nt);Ti.NotRegisteredError=Ri;var Ii=new Map,Pi=_r.find,Si=!0,Mi=$r("find");"find"in[]&&Array(1).find((function(){Si=!1})),Le({target:"Array",proto:!0,forced:Si||!Mi},{find:function(e){return Pi(this,e,arguments.length>1?arguments[1]:void 0)}}),Qr("find");pi("Set",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),xi);var Li="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,Di=function(e){if(void 0===e)return 0;var t=ue(e),r=le(t);if(t!==r)throw RangeError("Wrong length or index");return r},Ci=Math.abs,Fi=Math.pow,Ni=Math.floor,Oi=Math.log,Ui=Math.LN2,Vi=function(e,t,r){var n,i,a,o=new Array(r),s=8*r-t-1,u=(1<<s)-1,_=u>>1,l=23===t?Fi(2,-24)-Fi(2,-77):0,c=e<0||0===e&&1/e<0?1:0,h=0;for((e=Ci(e))!=e||e===1/0?(i=e!=e?1:0,n=u):(n=Ni(Oi(e)/Ui),e*(a=Fi(2,-n))<1&&(n--,a*=2),(e+=n+_>=1?l/a:l*Fi(2,1-_))*a>=2&&(n++,a/=2),n+_>=u?(i=0,n=u):n+_>=1?(i=(e*a-1)*Fi(2,t),n+=_):(i=e*Fi(2,_-1)*Fi(2,t),n=0));t>=8;o[h++]=255&i,i/=256,t-=8);for(n=n<<t|i,s+=t;s>0;o[h++]=255&n,n/=256,s-=8);return o[--h]|=128*c,o},Bi=function(e,t){var r,n=e.length,i=8*n-t-1,a=(1<<i)-1,o=a>>1,s=i-7,u=n-1,_=e[u--],l=127&_;for(_>>=7;s>0;l=256*l+e[u],u--,s-=8);for(r=l&(1<<-s)-1,l>>=-s,s+=t;s>0;r=256*r+e[u],u--,s-=8);if(0===l)l=1-o;else{if(l===a)return r?NaN:_?-1/0:1/0;r+=Fi(2,t),l-=o}return(_?-1:1)*r*Fi(2,l-t)},zi=function(e){for(var t=Gt(this),r=le(t.length),n=arguments.length,i=fe(n>1?arguments[1]:void 0,r),a=n>2?arguments[2]:void 0,o=void 0===a?r:fe(a,r);o>i;)t[i++]=e;return t},Gi=ke.f,ji=d.f,qi=z.get,Yi=z.set,Hi=n.ArrayBuffer,Xi=Hi,Wi=n.DataView,Qi=Wi&&Wi.prototype,Zi=Object.prototype,Ji=n.RangeError,Ki=Vi,$i=Bi,ea=function(e){return[255&e]},ta=function(e){return[255&e,e>>8&255]},ra=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},na=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},ia=function(e){return Ki(e,23,4)},aa=function(e){return Ki(e,52,8)},oa=function(e,t){ji(e.prototype,t,{get:function(){return qi(this)[t]}})},sa=function(e,t,r,n){var i=Di(r),a=qi(e);if(i+t>a.byteLength)throw Ji("Wrong index");var o=qi(a.buffer).bytes,s=i+a.byteOffset,u=o.slice(s,s+t);return n?u:u.reverse()},ua=function(e,t,r,n,i,a){var o=Di(r),s=qi(e);if(o+t>s.byteLength)throw Ji("Wrong index");for(var u=qi(s.buffer).bytes,_=o+s.byteOffset,l=n(+i),c=0;c<t;c++)u[_+c]=l[a?c:t-c-1]};if(Li){if(!i((function(){Hi(1)}))||!i((function(){new Hi(-1)}))||i((function(){return new Hi,new Hi(1.5),new Hi(NaN),"ArrayBuffer"!=Hi.name}))){for(var _a,la=(Xi=function(e){return li(this,Xi),new Hi(Di(e))}).prototype=Hi.prototype,ca=Gi(Hi),ha=0;ca.length>ha;)(_a=ca[ha++])in Xi||p(Xi,_a,Hi[_a]);la.constructor=Xi}it&&ln(Qi)!==Zi&&it(Qi,Zi);var fa=new Wi(new Xi(2)),da=Qi.setInt8;fa.setInt8(0,2147483648),fa.setInt8(1,2147483649),!fa.getInt8(0)&&fa.getInt8(1)||yi(Qi,{setInt8:function(e,t){da.call(this,e,t<<24>>24)},setUint8:function(e,t){da.call(this,e,t<<24>>24)}},{unsafe:!0})}else Xi=function(e){li(this,Xi,"ArrayBuffer");var t=Di(e);Yi(this,{bytes:zi.call(new Array(t),0),byteLength:t}),a||(this.byteLength=t)},Wi=function(e,t,r){li(this,Wi,"DataView"),li(e,Xi,"DataView");var n=qi(e).byteLength,i=ue(t);if(i<0||i>n)throw Ji("Wrong offset");if(i+(r=void 0===r?n-i:le(r))>n)throw Ji("Wrong length");Yi(this,{buffer:e,byteLength:r,byteOffset:i}),a||(this.buffer=e,this.byteLength=r,this.byteOffset=i)},a&&(oa(Xi,"byteLength"),oa(Wi,"buffer"),oa(Wi,"byteLength"),oa(Wi,"byteOffset")),yi(Wi.prototype,{getInt8:function(e){return sa(this,1,e)[0]<<24>>24},getUint8:function(e){return sa(this,1,e)[0]},getInt16:function(e){var t=sa(this,2,e,arguments.length>1?arguments[1]:void 0);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=sa(this,2,e,arguments.length>1?arguments[1]:void 0);return t[1]<<8|t[0]},getInt32:function(e){return na(sa(this,4,e,arguments.length>1?arguments[1]:void 0))},getUint32:function(e){return na(sa(this,4,e,arguments.length>1?arguments[1]:void 0))>>>0},getFloat32:function(e){return $i(sa(this,4,e,arguments.length>1?arguments[1]:void 0),23)},getFloat64:function(e){return $i(sa(this,8,e,arguments.length>1?arguments[1]:void 0),52)},setInt8:function(e,t){ua(this,1,e,ea,t)},setUint8:function(e,t){ua(this,1,e,ea,t)},setInt16:function(e,t){ua(this,2,e,ta,t,arguments.length>2?arguments[2]:void 0)},setUint16:function(e,t){ua(this,2,e,ta,t,arguments.length>2?arguments[2]:void 0)},setInt32:function(e,t){ua(this,4,e,ra,t,arguments.length>2?arguments[2]:void 0)},setUint32:function(e,t){ua(this,4,e,ra,t,arguments.length>2?arguments[2]:void 0)},setFloat32:function(e,t){ua(this,4,e,ia,t,arguments.length>2?arguments[2]:void 0)},setFloat64:function(e,t){ua(this,8,e,aa,t,arguments.length>2?arguments[2]:void 0)}});rr(Xi,"ArrayBuffer"),rr(Wi,"DataView");var va={ArrayBuffer:Xi,DataView:Wi},pa=Zt("species"),ya=function(e,t){var r,n=c(e).constructor;return void 0===n||null==(r=c(n)[pa])?t:nr(r)},ga=va.ArrayBuffer,ma=va.DataView,ka=ga.prototype.slice,Ea=i((function(){return!new ga(2).slice(1,void 0).byteLength}));Le({target:"ArrayBuffer",proto:!0,unsafe:!0,forced:Ea},{slice:function(e,t){if(void 0!==ka&&void 0===t)return ka.call(c(this),e);for(var r=c(this).byteLength,n=fe(e,r),i=fe(void 0===t?r:t,r),a=new(ya(this,ga))(le(i-n)),o=new ma(this),s=new ma(a),u=0;n<i;)s.setUint8(u++,o.getUint8(n++));return a}});var wa,ba=d.f,xa=n.Int8Array,Ta=xa&&xa.prototype,Aa=n.Uint8ClampedArray,Ra=Aa&&Aa.prototype,Ia=xa&&ln(xa),Pa=Ta&&ln(Ta),Sa=Object.prototype,Ma=Sa.isPrototypeOf,La=Zt("toStringTag"),Da=M("TYPED_ARRAY_TAG"),Ca=Li&&!!it&&"Opera"!==Pn(n.opera),Fa=!1,Na={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},Oa=function(e){return o(e)&&g(Na,Pn(e))};for(wa in Na)n[wa]||(Ca=!1);if((!Ca||"function"!=typeof Ia||Ia===Function.prototype)&&(Ia=function(){throw TypeError("Incorrect invocation")},Ca))for(wa in Na)n[wa]&&it(n[wa],Ia);if((!Ca||!Pa||Pa===Sa)&&(Pa=Ia.prototype,Ca))for(wa in Na)n[wa]&&it(n[wa].prototype,Pa);if(Ca&&ln(Ra)!==Pa&&it(Ra,Pa),a&&!g(Pa,La))for(wa in Fa=!0,ba(Pa,La,{get:function(){return o(this)?this[Da]:void 0}}),Na)n[wa]&&p(n[wa],Da,wa);var Ua={NATIVE_ARRAY_BUFFER_VIEWS:Ca,TYPED_ARRAY_TAG:Fa&&Da,aTypedArray:function(e){if(Oa(e))return e;throw TypeError("Target is not a typed array")},aTypedArrayConstructor:function(e){if(it){if(Ma.call(Ia,e))return e}else for(var t in Na)if(g(Na,wa)){var r=n[t];if(r&&(e===r||Ma.call(r,e)))return e}throw TypeError("Target is not a typed array constructor")},exportTypedArrayMethod:function(e,t,r){if(a){if(r)for(var i in Na){var o=n[i];o&&g(o.prototype,e)&&delete o.prototype[e]}Pa[e]&&!r||G(Pa,e,r?t:Ca&&Ta[e]||t)}},exportTypedArrayStaticMethod:function(e,t,r){var i,o;if(a){if(it){if(r)for(i in Na)(o=n[i])&&g(o,e)&&delete o[e];if(Ia[e]&&!r)return;try{return G(Ia,e,r?t:Ca&&xa[e]||t)}catch(e){}}for(i in Na)!(o=n[i])||o[e]&&!r||G(o,e,t)}},isView:function(e){var t=Pn(e);return"DataView"===t||g(Na,t)},isTypedArray:Oa,TypedArray:Ia,TypedArrayPrototype:Pa},Va=Ua.NATIVE_ARRAY_BUFFER_VIEWS,Ba=n.ArrayBuffer,za=n.Int8Array,Ga=!Va||!i((function(){za(1)}))||!i((function(){new za(-1)}))||!vi((function(e){new za,new za(null),new za(1.5),new za(e)}),!0)||i((function(){return 1!==new za(new Ba(2),1,void 0).length})),ja=function(e,t){var r=function(e){var t=ue(e);if(t<0)throw RangeError("The argument can't be less than 0");return t}(e);if(r%t)throw RangeError("Wrong offset");return r},qa=Ua.aTypedArrayConstructor,Ya=function(e){var t,r,n,i,a,o,s=Gt(e),u=arguments.length,_=u>1?arguments[1]:void 0,l=void 0!==_,c=si(s);if(null!=c&&!ai(c))for(o=(a=c.call(s)).next,s=[];!(i=o.call(a)).done;)s.push(i.value);for(l&&u>2&&(_=ir(_,arguments[2],2)),r=le(s.length),n=new(qa(this))(r),t=0;r>t;t++)n[t]=l?_(s[t],t):s[t];return n},Ha=t((function(e){var t=ke.f,r=_r.forEach,i=z.get,s=z.set,u=d.f,_=re.f,l=Math.round,c=n.RangeError,f=va.ArrayBuffer,y=va.DataView,m=Ua.NATIVE_ARRAY_BUFFER_VIEWS,k=Ua.TYPED_ARRAY_TAG,E=Ua.TypedArray,w=Ua.TypedArrayPrototype,b=Ua.aTypedArrayConstructor,x=Ua.isTypedArray,T=function(e,t){for(var r=0,n=t.length,i=new(b(e))(n);n>r;)i[r]=t[r++];return i},A=function(e,t){u(e,t,{get:function(){return i(this)[t]}})},R=function(e){var t;return e instanceof f||"ArrayBuffer"==(t=Pn(e))||"SharedArrayBuffer"==t},I=function(e,t){return x(e)&&"symbol"!=typeof t&&t in e&&String(+t)==String(t)},P=function(e,t){return I(e,t=h(t,!0))?v(2,e[t]):_(e,t)},S=function(e,t,r){return!(I(e,t=h(t,!0))&&o(r)&&g(r,"value"))||g(r,"get")||g(r,"set")||r.configurable||g(r,"writable")&&!r.writable||g(r,"enumerable")&&!r.enumerable?u(e,t,r):(e[t]=r.value,e)};a?(m||(re.f=P,d.f=S,A(w,"buffer"),A(w,"byteOffset"),A(w,"byteLength"),A(w,"length")),Le({target:"Object",stat:!0,forced:!m},{getOwnPropertyDescriptor:P,defineProperty:S}),e.exports=function(e,a,_){var h=e.match(/\d+$/)[0]/8,d=e+(_?"Clamped":"")+"Array",v="get"+e,g="set"+e,b=n[d],A=b,I=A&&A.prototype,P={},S=function(e,t){u(e,t,{get:function(){return function(e,t){var r=i(e);return r.view[v](t*h+r.byteOffset,!0)}(this,t)},set:function(e){return function(e,t,r){var n=i(e);_&&(r=(r=l(r))<0?0:r>255?255:255&r),n.view[g](t*h+n.byteOffset,r,!0)}(this,t,e)},enumerable:!0})};m?Ga&&(A=a((function(e,t,r,n){return li(e,A,d),at(o(t)?R(t)?void 0!==n?new b(t,ja(r,h),n):void 0!==r?new b(t,ja(r,h)):new b(t):x(t)?T(A,t):Ya.call(A,t):new b(Di(t)),e,A)})),it&&it(A,E),r(t(b),(function(e){e in A||p(A,e,b[e])})),A.prototype=I):(A=a((function(e,t,r,n){li(e,A,d);var i,a,u,_=0,l=0;if(o(t)){if(!R(t))return x(t)?T(A,t):Ya.call(A,t);i=t,l=ja(r,h);var v=t.byteLength;if(void 0===n){if(v%h)throw c("Wrong length");if((a=v-l)<0)throw c("Wrong length")}else if((a=le(n)*h)+l>v)throw c("Wrong length");u=a/h}else u=Di(t),i=new f(a=u*h);for(s(e,{buffer:i,byteOffset:l,byteLength:a,length:u,view:new y(i)});_<u;)S(e,_++)})),it&&it(A,E),I=A.prototype=ft(w)),I.constructor!==A&&p(I,"constructor",A),k&&p(I,k,d),P[d]=A,Le({global:!0,forced:A!=b,sham:!m},P),"BYTES_PER_ELEMENT"in A||p(A,"BYTES_PER_ELEMENT",h),"BYTES_PER_ELEMENT"in I||p(I,"BYTES_PER_ELEMENT",h),mi(d)}):e.exports=function(){}}));Ha("Float32",(function(e){return function(t,r,n){return e(this,t,r,n)}})),Ha("Float64",(function(e){return function(t,r,n){return e(this,t,r,n)}}));var Xa=Math.min,Wa=[].copyWithin||function(e,t){var r=Gt(this),n=le(r.length),i=fe(e,n),a=fe(t,n),o=arguments.length>2?arguments[2]:void 0,s=Xa((void 0===o?n:fe(o,n))-a,n-i),u=1;for(a<i&&i<a+s&&(u=-1,a+=s-1,i+=s-1);s-- >0;)a in r?r[i]=r[a]:delete r[i],i+=u,a+=u;return r},Qa=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("copyWithin",(function(e,t){return Wa.call(Qa(this),e,t,arguments.length>2?arguments[2]:void 0)}));var Za=_r.every,Ja=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("every",(function(e){return Za(Ja(this),e,arguments.length>1?arguments[1]:void 0)}));var Ka=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("fill",(function(e){return zi.apply(Ka(this),arguments)}));var $a=_r.filter,eo=Ua.aTypedArray,to=Ua.aTypedArrayConstructor;(0,Ua.exportTypedArrayMethod)("filter",(function(e){for(var t=$a(eo(this),e,arguments.length>1?arguments[1]:void 0),r=ya(this,this.constructor),n=0,i=t.length,a=new(to(r))(i);i>n;)a[n]=t[n++];return a}));var ro=_r.find,no=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("find",(function(e){return ro(no(this),e,arguments.length>1?arguments[1]:void 0)}));var io=_r.findIndex,ao=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("findIndex",(function(e){return io(ao(this),e,arguments.length>1?arguments[1]:void 0)}));var oo=_r.forEach,so=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("forEach",(function(e){oo(so(this),e,arguments.length>1?arguments[1]:void 0)}));var uo=ve.includes,_o=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("includes",(function(e){return uo(_o(this),e,arguments.length>1?arguments[1]:void 0)}));var lo=ve.indexOf,co=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("indexOf",(function(e){return lo(co(this),e,arguments.length>1?arguments[1]:void 0)}));var ho=Zt("iterator"),fo=n.Uint8Array,vo=xn.values,po=xn.keys,yo=xn.entries,go=Ua.aTypedArray,mo=Ua.exportTypedArrayMethod,ko=fo&&fo.prototype[ho],Eo=!!ko&&("values"==ko.name||null==ko.name),wo=function(){return vo.call(go(this))};mo("entries",(function(){return yo.call(go(this))})),mo("keys",(function(){return po.call(go(this))})),mo("values",wo,!Eo),mo(ho,wo,!Eo);var bo=Ua.aTypedArray,xo=[].join;(0,Ua.exportTypedArrayMethod)("join",(function(e){return xo.apply(bo(this),arguments)}));var To=function(e,t){var r=[][e];return!!r&&i((function(){r.call(null,t||function(){throw 1},1)}))},Ao=Math.min,Ro=[].lastIndexOf,Io=!!Ro&&1/[1].lastIndexOf(1,-0)<0,Po=To("lastIndexOf"),So=$r("indexOf",{ACCESSORS:!0,1:0}),Mo=Io||!Po||!So?function(e){if(Io)return Ro.apply(this,arguments)||0;var t=ee(this),r=le(t.length),n=r-1;for(arguments.length>1&&(n=Ao(n,ue(arguments[1]))),n<0&&(n=r+n);n>=0;n--)if(n in t&&t[n]===e)return n||0;return-1}:Ro,Lo=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("lastIndexOf",(function(e){return Mo.apply(Lo(this),arguments)}));var Do=_r.map,Co=Ua.aTypedArray,Fo=Ua.aTypedArrayConstructor;(0,Ua.exportTypedArrayMethod)("map",(function(e){return Do(Co(this),e,arguments.length>1?arguments[1]:void 0,(function(e,t){return new(Fo(ya(e,e.constructor)))(t)}))}));var No=function(e){return function(t,r,n,i){nr(r);var a=Gt(t),o=K(a),s=le(a.length),u=e?s-1:0,_=e?-1:1;if(n<2)for(;;){if(u in o){i=o[u],u+=_;break}if(u+=_,e?u<0:s<=u)throw TypeError("Reduce of empty array with no initial value")}for(;e?u>=0:s>u;u+=_)u in o&&(i=r(i,o[u],u,a));return i}},Oo={left:No(!1),right:No(!0)},Uo=Oo.left,Vo=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("reduce",(function(e){return Uo(Vo(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var Bo=Oo.right,zo=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("reduceRight",(function(e){return Bo(zo(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var Go=Ua.aTypedArray,jo=Ua.exportTypedArrayMethod,qo=Math.floor;jo("reverse",(function(){for(var e,t=Go(this).length,r=qo(t/2),n=0;n<r;)e=this[n],this[n++]=this[--t],this[t]=e;return this}));var Yo=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("set",(function(e){Yo(this);var t=ja(arguments.length>1?arguments[1]:void 0,1),r=this.length,n=Gt(e),i=le(n.length),a=0;if(i+t>r)throw RangeError("Wrong length");for(;a<i;)this[t+a]=n[a++]}),i((function(){new Int8Array(1).set({})})));var Ho=Ua.aTypedArray,Xo=Ua.aTypedArrayConstructor,Wo=[].slice;(0,Ua.exportTypedArrayMethod)("slice",(function(e,t){for(var r=Wo.call(Ho(this),e,t),n=ya(this,this.constructor),i=0,a=r.length,o=new(Xo(n))(a);a>i;)o[i]=r[i++];return o}),i((function(){new Int8Array(1).slice()})));var Qo=_r.some,Zo=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("some",(function(e){return Qo(Zo(this),e,arguments.length>1?arguments[1]:void 0)}));var Jo=Ua.aTypedArray,Ko=[].sort;(0,Ua.exportTypedArrayMethod)("sort",(function(e){return Ko.call(Jo(this),e)}));var $o=Ua.aTypedArray;(0,Ua.exportTypedArrayMethod)("subarray",(function(e,t){var r=$o(this),n=r.length,i=fe(e,n);return new(ya(r,r.constructor))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,le((void 0===t?n:fe(t,n))-i))}));var es=n.Int8Array,ts=Ua.aTypedArray,rs=Ua.exportTypedArrayMethod,ns=[].toLocaleString,is=[].slice,as=!!es&&i((function(){ns.call(new es(1))}));rs("toLocaleString",(function(){return ns.apply(as?is.call(ts(this)):ts(this),arguments)}),i((function(){return[1,2].toLocaleString()!=new es([1,2]).toLocaleString()}))||!i((function(){es.prototype.toLocaleString.call([1,2])})));var os=Ua.exportTypedArrayMethod,ss=n.Uint8Array,us=ss&&ss.prototype||{},_s=[].toString,ls=[].join;i((function(){_s.call({})}))&&(_s=function(){return ls.call(this)});var cs=us.toString!=_s;os("toString",_s,cs);var hs=function(){function e(){Ge(this,e)}return qe(e,null,[{key:"createMatrix",value:function(e){return new Float64Array(e||16)}},{key:"createMatrixf",value:function(e){return new Float32Array(e||16)}},{key:"createVector4",value:function(e){return new Float64Array(e||4)}},{key:"createVector4f",value:function(e){return new Float32Array(e||4)}},{key:"createVector3",value:function(e){return new Float64Array(e||3)}},{key:"createVector3f",value:function(e){return new Float32Array(e||3)}},{key:"createVector2",value:function(e){return new Float64Array(e||2)}},{key:"createVector2f",value:function(e){return new Float32Array(e||2)}},{key:"copyMatrix",value:function(e,t){for(var r=0;r<16;++r)t[r]=e[r];return t}},{key:"copyVector4",value:function(e,t){for(var r=0;r<4;++r)t[r]=e[r];return t}},{key:"copyVector3",value:function(e,t){for(var r=0;r<3;++r)t[r]=e[r];return t}},{key:"copyVector2",value:function(e,t){return t[0]=e[0],t[1]=e[1],t}},{key:"setIdentity",value:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}},{key:"dot3",value:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}},{key:"cross3",value:function(e,t,r){var n=e[1]*t[2]-e[2]*t[1],i=e[2]*t[0]-e[0]*t[2],a=e[0]*t[1]-e[1]*t[0];return r[0]=n,r[1]=i,r[2]=a,r}},{key:"normalize3",value:function(e,t){var r=e[0],n=e[1],i=e[2],a=1/Math.sqrt(r*r+n*n+i*i);return t[0]=e[0]*a,t[1]=e[1]*a,t[2]=e[2]*a,t}},{key:"scale3",value:function(e,t,r){return r[0]=e*t[0],r[1]=e*t[1],r[2]=e*t[2],r}},{key:"mul_AA",value:function(e,t,r){var n=e[0],i=e[4],a=e[8],o=e[12],s=e[1],u=e[5],_=e[9],l=e[13],c=e[2],h=e[6],f=e[10],d=e[14],v=t[0],p=t[4],y=t[8],g=t[12],m=t[1],k=t[5],E=t[9],w=t[13],b=t[2],x=t[6],T=t[10],A=t[14];return r[0]=n*v+i*m+a*b,r[1]=s*v+u*m+_*b,r[2]=c*v+h*m+f*b,r[3]=0,r[4]=n*p+i*k+a*x,r[5]=s*p+u*k+_*x,r[6]=c*p+h*k+f*x,r[7]=0,r[8]=n*y+i*E+a*T,r[9]=s*y+u*E+_*T,r[10]=c*y+h*E+f*T,r[11]=0,r[12]=n*g+i*w+a*A+o,r[13]=s*g+u*w+_*A+l,r[14]=c*g+h*w+f*A+d,r[15]=1,r}},{key:"mul_GA",value:function(e,t,r){var n=e[0],i=e[4],a=e[8],o=e[12],s=e[1],u=e[5],_=e[9],l=e[13],c=e[2],h=e[6],f=e[10],d=e[14],v=e[3],p=e[7],y=e[11],g=e[15],m=t[0],k=t[4],E=t[8],w=t[12],b=t[1],x=t[5],T=t[9],A=t[13],R=t[2],I=t[6],P=t[10],S=t[14];return r[0]=n*m+i*b+a*R,r[1]=s*m+u*b+_*R,r[2]=c*m+h*b+f*R,r[3]=v*m+p*b+y*R,r[4]=n*k+i*x+a*I,r[5]=s*k+u*x+_*I,r[6]=c*k+h*x+f*I,r[7]=v*k+p*x+y*I,r[8]=n*E+i*T+a*P,r[9]=s*E+u*T+_*P,r[10]=c*E+h*T+f*P,r[11]=v*E+p*T+y*P,r[12]=n*w+i*A+a*S+o,r[13]=s*w+u*A+_*S+l,r[14]=c*w+h*A+f*S+d,r[15]=v*w+p*A+y*S+g,r}},{key:"mul_PzA",value:function(e,t,r){var n=e[0],i=e[8],a=e[12],o=e[5],s=e[9],u=e[13],_=e[10],l=e[14],c=e[11],h=e[15],f=t[0],d=t[4],v=t[8],p=t[12],y=t[1],g=t[5],m=t[9],k=t[13],E=t[2],w=t[6],b=t[10],x=t[14];return r[0]=n*f+i*E,r[1]=o*y+s*E,r[2]=_*E,r[3]=c*E,r[4]=n*d+i*w,r[5]=o*g+s*w,r[6]=_*w,r[7]=c*w,r[8]=n*v+i*b,r[9]=o*m+s*b,r[10]=_*b,r[11]=c*b,r[12]=n*p+i*x+a,r[13]=o*k+s*x+u,r[14]=_*x+l,r[15]=c*x+h,r}},{key:"inverse_A",value:function(e,t){var r=e[0],n=e[4],i=e[8],a=e[12],o=e[1],s=e[5],u=e[9],_=e[13],l=e[2],c=e[6],h=e[10],f=e[14],d=s*h-c*u,v=l*u-o*h,p=o*c-l*s,y=c*i-n*h,g=r*h-l*i,m=l*n-r*c,k=n*u-s*i,E=o*i-r*u,w=r*s-o*n,b=-(a*d+_*y+f*k),x=-(a*v+_*g+f*E),T=-(a*p+_*m+f*w),A=1/(r*d+n*v+i*p);return t[0]=d*A,t[1]=v*A,t[2]=p*A,t[3]=0,t[4]=y*A,t[5]=g*A,t[6]=m*A,t[7]=0,t[8]=k*A,t[9]=E*A,t[10]=w*A,t[11]=0,t[12]=b*A,t[13]=x*A,t[14]=T*A,t[15]=1,t}},{key:"transformPlane_A",value:function(e,t,r){var n=e,i=t[0],a=t[1],o=t[2],s=t[3];return r[0]=i*n[0]+a*n[1]+o*n[2],r[1]=i*n[4]+a*n[5]+o*n[6],r[2]=i*n[8]+a*n[9]+o*n[10],r[3]=i*n[12]+a*n[13]+o*n[14]+s,r}},{key:"iscs_to_gocs_matrix",value:function(t,r){var n=t.longitude*e.DEGREE,i=t.latitude*e.DEGREE,a=Math.sin(n),o=Math.cos(n),s=Math.sin(i),u=Math.cos(i),_=e.EARTH_RADIUS+t.height;return r[0]=-a,r[1]=o,r[2]=0,r[3]=0,r[4]=-o*s,r[5]=-a*s,r[6]=u,r[7]=0,r[8]=u*o,r[9]=u*a,r[10]=s,r[11]=0,r[12]=_*u*o,r[13]=_*u*a,r[14]=_*s,r[15]=1,r}},{key:"gocs_to_iscs",value:function(t,r){var n=t[0],i=t[1],a=t[2],o=n*n,s=i*i,u=a*a;return 0!=n||0!=i?(r.latitude=Math.atan(a/Math.sqrt(o+s))/e.DEGREE,r.longitude=Math.atan2(i,n)/e.DEGREE):(r.latitude=a>0?90:a<0?-90:0,r.longitude=0),r.height=Math.sqrt(o+s+u)-e.EARTH_RADIUS,r}},{key:"frustum_matrix",value:function(e,t,r,n,i,a,o){return o[0]=2*i/(t-e),o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=2*i/(n-r),o[6]=0,o[7]=0,o[8]=(t+e)/(t-e),o[9]=(n+r)/(n-r),o[10]=(a+i)/(i-a),o[11]=-1,o[12]=0,o[13]=0,o[14]=2*a*i/(i-a),o[15]=0,o}},{key:"lookat_matrix",value:function(t,r,n,i){var a=e._xaxis,o=e._yaxis,s=e._zaxis;return s[0]=t[0]-r[0],s[1]=t[1]-r[1],s[2]=t[2]-r[2],e.normalize3(s,s),e.cross3(n,s,a),e.normalize3(a,a),e.cross3(s,a,o),i[0]=a[0],i[1]=a[1],i[2]=a[2],i[3]=0,i[4]=o[0],i[5]=o[1],i[6]=o[2],i[7]=0,i[8]=s[0],i[9]=s[1],i[10]=s[2],i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i}},{key:"rotation_matrix",value:function(t,r,n){var i=r*e.DEGREE,a=Math.sin(i),o=Math.cos(i),s=t[0],u=t[1],_=t[2];return n[0]=s*s*(1-o)+o,n[1]=s*u*(1-o)+_*a,n[2]=s*_*(1-o)-u*a,n[3]=0,n[4]=s*u*(1-o)-_*a,n[5]=u*u*(1-o)+o,n[6]=u*_*(1-o)+s*a,n[7]=0,n[8]=s*_*(1-o)+u*a,n[9]=u*_*(1-o)-s*a,n[10]=_*_*(1-o)+o,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}},{key:"kml_model_matrix",value:function(t,r,n,i,a){var o=t*e.DEGREE,s=r*e.DEGREE,u=n*e.DEGREE,_=Math.sin(o),l=Math.cos(o),c=Math.sin(s),h=Math.cos(s),f=Math.sin(u),d=Math.cos(u),v=i[0],p=i[1],y=i[2];return a[0]=v*(_*f*c+l*d),a[1]=v*(l*f*c-_*d),a[2]=v*f*h,a[3]=0,a[4]=p*_*h,a[5]=p*l*h,a[6]=-p*c,a[7]=0,a[8]=y*(_*d*c-l*f),a[9]=y*(l*d*c+_*f),a[10]=y*d*h,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a}},{key:"gudermannian",value:function(e){return 2*Math.atan(Math.exp(e))-Math.PI/2}},{key:"invGudermannian",value:function(e){return Math.log(Math.tan(e/2+Math.PI/4))}},{key:"clamp",value:function(e,t,r){return Math.min(Math.max(e,t),r)}}]),e}();hs.EARTH_RADIUS=6378137,hs.DEGREE=.017453292519943295,hs.LOG2PI=1.6514961294723187,hs._xaxis=hs.createVector3(),hs._yaxis=hs.createVector3(),hs._zaxis=hs.createVector3();var fs=function(){function e(t,r,n){Ge(this,e),this.longitude=void 0!==t?t:0,this.latitude=void 0!==r?r:0,this.altitude=void 0!==n?n:0}return qe(e,[{key:"clone",value:function(){return new e(this.longitude,this.latitude,this.altitude)}},{key:"assign",value:function(e){return this.longitude=e.longitude,this.latitude=e.latitude,this.altitude=e.altitude,this}},{key:"setFromArray",value:function(e){return this.longitude=e[0],this.latitude=e[1],this.altitude=e.length>2?e[2]:0,this}},{key:"setFromGocs",value:function(e){var t=e[0],r=e[1],n=e[2],i=t*t,a=r*r,o=n*n;return 0!=t||0!=r?(this.latitude=Math.atan(n/Math.sqrt(i+a))/hs.DEGREE,this.longitude=Math.atan2(r,t)/hs.DEGREE):(this.latitude=n>0?90:n<0?-90:0,this.longitude=0),this.altitude=Math.sqrt(i+a+o)-hs.EARTH_RADIUS,this}},{key:"getAsGocs",value:function(e){var t=this.longitude*hs.DEGREE,r=this.latitude*hs.DEGREE,n=hs.EARTH_RADIUS+this.altitude,i=Math.cos(r);return e[0]=n*i*Math.cos(t),e[1]=n*i*Math.sin(t),e[2]=n*Math.sin(r),e}},{key:"getMlocsToGocsMatrix",value:function(e){var t=this.longitude*hs.DEGREE,r=this.latitude*hs.DEGREE,n=Math.sin(t),i=Math.cos(t),a=Math.sin(r),o=Math.cos(r),s=hs.EARTH_RADIUS+this.altitude;return e[0]=-n,e[1]=i,e[2]=0,e[3]=0,e[4]=-i*a,e[5]=-n*a,e[6]=o,e[7]=0,e[8]=o*i,e[9]=o*n,e[10]=a,e[11]=0,e[12]=s*o*i,e[13]=s*o*n,e[14]=s*a,e[15]=1,e}},{key:"getUpwardVector",value:function(e){var t=this.longitude*hs.DEGREE,r=this.latitude*hs.DEGREE,n=Math.cos(r);return e[0]=n*Math.cos(t),e[1]=n*Math.sin(t),e[2]=Math.sin(r),e}},{key:"getGeographicalDistance",value:function(e){var t=this.getAsGocs(hs.createVector3()),r=e.getAsGocs(hs.createVector3()),n=hs.cross3(t,r,hs.createVector3());return hs.EARTH_RADIUS*Math.atan2(Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]),hs.dot3(t,r))}}],[{key:"toGocsArray",value:function(e,t,r){for(var n=hs.DEGREE,i=hs.EARTH_RADIUS,a=0;a<t;++a){var o=3*a,s=e[o]*n,u=e[o+1]*n,_=i+e[o+2],l=Math.cos(u);r[o]=_*l*Math.cos(s),r[o+1]=_*l*Math.sin(s),r[o+2]=_*Math.sin(u)}return r}}]),e}(),ds=function(){function e(t,r,n){Ge(this,e),this.heading=void 0!==t?t:0,this.tilt=void 0!==r?r:0,this.roll=void 0!==n?n:0}return qe(e,[{key:"clone",value:function(){return new e(this.heading,this.tilt,this.roll)}},{key:"assign",value:function(e){return this.heading=e.heading,this.tilt=e.tilt,this.roll=e.roll,this}},{key:"getTransformMatrix",value:function(e,t){var r=this.heading*hs.DEGREE,n=this.tilt*hs.DEGREE,i=this.roll*hs.DEGREE,a=Math.sin(r),o=Math.cos(r),s=Math.sin(n),u=Math.cos(n),_=Math.sin(i),l=Math.cos(i),c=e[0],h=e[1],f=e[2];return t[0]=c*(a*_*s+o*l),t[1]=c*(o*_*s-a*l),t[2]=c*_*u,t[3]=0,t[4]=h*a*u,t[5]=h*o*u,t[6]=-h*s,t[7]=0,t[8]=f*(a*l*s-o*_),t[9]=f*(o*l*s+a*_),t[10]=f*l*u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}}]),e}(),vs=function(e){function t(){var e;return Ge(this,t),(e=Ke(this,He(t).call(this,"boolean")))._number_type=null,e._convertibles=new Set([Je(e)]),e}return Ye(t,e),qe(t,[{key:"_postinit",value:function(){this._number_type=Ti.find("number"),this._convertibles.add(this._number_type)}},{key:"isConvertible",value:function(e){return this._convertibles.has(e)}},{key:"convertValue",value:function(e,t){return e===this?t:t>=.5}},{key:"getDefaultValue",value:function(){return!1}},{key:"getCloneValue",value:function(e){return e}}]),t}(Ti),ps=function(e){function t(){var e;return Ge(this,t),(e=Ke(this,He(t).call(this,"number")))._boolean_type=null,e._convertibles=new Set([Je(e)]),e}return Ye(t,e),qe(t,[{key:"_postinit",value:function(){this._boolean_type=Ti.find("boolean"),this._convertibles.add(this._boolean_type)}},{key:"isConvertible",value:function(e){return this._convertibles.has(e)}},{key:"convertValue",value:function(e,t){return e===this?t:t?1:0}},{key:"getDefaultValue",value:function(){return 0}},{key:"getCloneValue",value:function(e){return e}}]),t}(Ti),ys=function(e){function t(){return Ge(this,t),Ke(this,He(t).call(this,"string"))}return Ye(t,e),qe(t,[{key:"_postinit",value:function(){}},{key:"isConvertible",value:function(e){return e===this}},{key:"convertValue",value:function(e,t){return t}},{key:"getDefaultValue",value:function(){return""}},{key:"getCloneValue",value:function(e){return e}}]),t}(Ti),gs=function(e){function t(){return Ge(this,t),Ke(this,He(t).call(this,"vector2"))}return Ye(t,e),qe(t,[{key:"_postinit",value:function(){}},{key:"isConvertible",value:function(e){return e===this}},{key:"convertValue",value:function(e,t){return t}},{key:"getDefaultValue",value:function(){return hs.createVector2()}},{key:"getCloneValue",value:function(e){return hs.createVector2(e)}}]),t}(Ti),ms=function(e){function t(){return Ge(this,t),Ke(this,He(t).call(this,"vector3"))}return Ye(t,e),qe(t,[{key:"_postinit",value:function(){}},{key:"isConvertible",value:function(e){return e===this}},{key:"convertValue",value:function(e,t){return t}},{key:"getDefaultValue",value:function(){return hs.createVector3()}},{key:"getCloneValue",value:function(e){return hs.createVector3(e)}}]),t}(Ti),ks=function(e){function t(){return Ge(this,t),Ke(this,He(t).call(this,"vector4"))}return Ye(t,e),qe(t,[{key:"_postinit",value:function(){}},{key:"isConvertible",value:function(e){return e===this}},{key:"convertValue",value:function(e,t){return t}},{key:"getDefaultValue",value:function(){return hs.createVector4()}},{key:"getCloneValue",value:function(e){return hs.createVector4(e)}}]),t}(Ti),Es=function(e){function t(){return Ge(this,t),Ke(this,He(t).call(this,"matrix"))}return Ye(t,e),qe(t,[{key:"_postinit",value:function(){}},{key:"isConvertible",value:function(e){return e===this}},{key:"convertValue",value:function(e,t){return t}},{key:"getDefaultValue",value:function(){return hs.setIdentity(hs.createMatrix())}},{key:"getCloneValue",value:function(e){return hs.createMatrix(e)}}]),t}(Ti);!function(){for(var e=[],t=0,r=[vs,ps,ys,ms,gs,ks,Es];t<r.length;t++){var n=new(0,r[t]);Ti.register(n.name,n),e.push(n)}for(var i=0,a=e;i<a.length;i++){a[i]._postinit()}}();var ws=function(){function e(){Ge(this,e),this._value_change_listeners=new Set}return qe(e,[{key:"isTypeSupported",value:function(e){this._override_error("isTypeSupported")}},{key:"getValue",value:function(e,t){this._override_error("getValue")}},{key:"getInvariance",value:function(e){this._override_error("getInvariance")}},{key:"notifyValueChange",value:function(e){if(!e.isEmpty()){var t=!0,r=!1,n=void 0;try{for(var i,a=this._value_change_listeners[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){(0,i.value)(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}}},{key:"addValueChangeListener",value:function(e){this._value_change_listeners.add(e)}},{key:"removeValueChangeListener",value:function(e){this._value_change_listeners.delete(e)}},{key:"_override_error",value:function(e){throw new Error("Curve#"+e+"() method has not been overridden in "+this.constructor.name)}}]),e}(),bs=function(e,t,r){var n=h(t);n in e?d.f(e,n,v(0,r)):e[n]=r},xs=function(e){var t,r,n,i,a,o,s=Gt(e),u="function"==typeof this?this:Array,_=arguments.length,l=_>1?arguments[1]:void 0,c=void 0!==l,h=si(s),f=0;if(c&&(l=ir(l,_>2?arguments[2]:void 0,2)),null==h||u==Array&&ai(h))for(r=new u(t=le(s.length));t>f;f++)o=c?l(s[f],f):s[f],bs(r,f,o);else for(a=(i=h.call(s)).next,r=new u;!(n=a.call(i)).done;f++)o=c?ui(i,l,[n.value,f],!0):n.value,bs(r,f,o);return r.length=f,r},Ts=!vi((function(e){Array.from(e)}));Le({target:"Array",stat:!0,forced:Ts},{from:xs});var As=function(){function e(){Ge(this,e),this._prev_time=null,this._track_binders=new Map,this._dirty_binders=new Set,this._vary_curves=new Is}return qe(e,[{key:"update",value:function(e){if(this._update_dirty_binders(e),null!==this._prev_time){var t=this._vary_curves.getVaryCurves(this._prev_time,e),r=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;this._track_binders.get(s).updateBinders(e)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}}this._flush_dirty_binders(),this._prev_time=e}},{key:"_$register",value:function(e){this._dirty_binders.add(e)}},{key:"_$unregister",value:function(e){this._dirty_binders.delete(e)||this._track_binders.get(e._$curve).unregister(e)}},{key:"_update_dirty_binders",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=this._dirty_binders[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){i.value._$update(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"_flush_dirty_binders",value:function(){for(var e=0,t=Array.from(this._dirty_binders);e<t.length;e++){var r=t[e];this._dirty_binders.delete(r);var n=r._$curve,i=this._track_binders.get(n);void 0===i?(i=new Rs(this,n,r),this._track_binders.set(n,i)):i.register(r)}}}]),e}(),Rs=function(){function e(t,r,n){var i=this;Ge(this,e),this._updater=t,this._curve=r,this._binders=new Set([n]),this._invariance=r.getInvariance(Ot.UNIVERSAL),this._listener=function(e){i._onValueChange(e)},r.addValueChangeListener(this._listener),t._vary_curves.addCurve(r,this._invariance)}return qe(e,[{key:"register",value:function(e){this._binders.add(e)}},{key:"unregister",value:function(e){this._binders.delete(e),this._binders.size>0||(this._updater._vary_curves.removeCurve(this._curve,this._invariance),this._curve.removeValueChangeListener(this._listener),this._updater._track_binders.delete(this._curve))}},{key:"updateBinders",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=this._binders[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){i.value._$update(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"_onValueChange",value:function(e){if(e.includesTime(this._updater._prev_time))this._move_to_dirty_binders();else{var t=this._curve.getInvariance(e);this._updater._vary_curves.modifyCurve(this._curve,e,t,this._invariance),this._invariance._$modify(t)}}},{key:"_move_to_dirty_binders",value:function(){for(var e=0,t=Array.from(this._binders);e<t.length;e++){var r=t[e];this.unregister(r),this._updater._dirty_binders.add(r)}}}]),e}(),Is=function(){function e(){Ge(this,e),this._continuous=Ss(),this._oneshot=Ss(),this._oneshot_L=Ss(),this._oneshot_R=Ss()}return qe(e,[{key:"addCurve",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ot.UNIVERSAL,n=t.getNarrowed(r)._$getArray();if(0==n.length)this._addToGeneric(e,r);else{var i=n.length-1,a=n[0],o=r.getIntersection(a.getPrecedings());o.isEmpty()?Ms(r,a)&&!this._hasContiguous_L(a,e)&&(a.l_open?this._addToOneshotGroup(e,a,"_oneshot_R"):a.getPrecedings().isEmpty()||this._addToOneshotGroup(e,a,"_oneshot_L")):this._addToGeneric(e,o);for(var s=0;s<i;++s){var u=n[s].getFollowings(),_=n[s+1].getPrecedings(),l=u.getIntersection(_);l.isEmpty()?this._addToOneshotGroup(e,u,u.l_open?"_oneshot_R":"_oneshot_L"):this._addToGeneric(e,l)}var c=n[i],h=r.getIntersection(c.getFollowings());h.isEmpty()?Ls(r,c)&&!this._hasContiguous_R(c,e)&&(c.u_open?this._addToOneshotGroup(e,c,"_oneshot_L"):c.getFollowings().isEmpty()||this._addToOneshotGroup(e,c,"_oneshot_R")):this._addToGeneric(e,h)}}},{key:"_hasContiguous_L",value:function(e,t){var r=this._continuous,n=r.findLower(e.lower),i=null!==n?n.findPredecessor():r.findLast();if(null!==i){var a=i.value,o=a.interval;if(o.upper.equals(e.lower)&&(e.l_open&&!o.u_open||!e.l_open&&o.u_open)&&a.curves.has(t))return!0}return!1}},{key:"_hasContiguous_R",value:function(e,t){var r=this._continuous.findLower(e.upper);if(null===r)return!1;var n=r.value,i=n.interval;return!!i.lower.equals(e.upper)&&(!(i.l_open&&e.u_open||!i.l_open&&!e.u_open)&&n.curves.has(t))}},{key:"removeCurve",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ot.UNIVERSAL,n=t.getNarrowed(r)._$getArray();if(0==n.length)this._removeForGeneric(e,r);else{var i=n.length-1,a=n[0],o=r.getIntersection(a.getPrecedings());o.isEmpty()?Ms(r,a)&&this._removeForOneshotGroup(e,r):this._removeForGeneric(e,o);for(var s=0;s<i;++s){var u=n[s].getFollowings(),_=n[s+1].getPrecedings(),l=u.getIntersection(_);l.isEmpty()?this._removeForOneshotGroup(e,u):this._removeForGeneric(e,l)}var c=n[i],h=r.getIntersection(c.getFollowings());if(h.isEmpty()){if(Ls(r,c)){var f=r.upper;this._removeForOneshotGroup(e,new Ot(f,f))}}else this._removeForGeneric(e,h)}}},{key:"modifyCurve",value:function(e,t,r,n){var i=n._$expandIntervalByAlignment(t);this.removeCurve(e,n,i),this.addCurve(e,r,i)}},{key:"getVaryCurves",value:function(e,t){return e.lessThan(t)?this._collectCurves(e,t):t.lessThan(e)?this._collectCurves(t,e):[]}},{key:"_addToGeneric",value:function(e,t){t.isProper()?this._addToContinuous(e,t):t.isSingle()&&this._addToOneshotGroup(e,t,"_oneshot")}},{key:"_addToOneshotGroup",value:function(e,t,r){var n=this[r],i=t.lower,a=n.findEqual(i);null===a&&(a=n.insert(i,new Set)),a.value.add(e)}},{key:"_addToContinuous",value:function(e,t){for(var r=t,n=e;;){var i=this._removeFirstCrossInContinuous(r);if(null!==i){var a=i.cc.interval,o=i.cc.curves,s=i.cross,u=r.getPrecedings().getIntersection(a);if(u.isEmpty()){var _=r.getIntersection(a.getPrecedings());_.isEmpty()||this._addForContinuous(_,n)}else this._addForContinuous(u,new Set(o));var l=r.getFollowings().getIntersection(a);if(l.isEmpty()){this._addForContinuous(s,o.add(n));var c=r.getIntersection(a.getFollowings());if(!c.isEmpty()){r=c;continue}}else this._addForContinuous(l,new Set(o)),this._addForContinuous(s,o.add(n))}else this._addForContinuous(r,n);break}}},{key:"_removeFirstCrossInContinuous",value:function(e){var t=this._continuous,r=t.findUpper(e.lower),n=null!==r?r.findPredecessor():t.findLast();if(null!==n){var i=e.getIntersection(n.value.interval);if(!i.isEmpty()){var a=n.value;return t.remove(n),{cc:a,cross:i}}}if(null!==r){var o=e.getIntersection(r.value.interval);if(!o.isEmpty()){var s=r.value;return t.remove(r),{cc:s,cross:o}}}return null}},{key:"_addForContinuous",value:function(e,t){var r=e.lower;if(e.isSingle()){var n=this._oneshot.findEqual(r);null===n&&(n=this._oneshot.insert(r,new Set));var i=n.value;if(t instanceof Set){var a=!0,o=!1,s=void 0;try{for(var u,_=t[Symbol.iterator]();!(a=(u=_.next()).done);a=!0){var l=u.value;i.add(l)}}catch(e){o=!0,s=e}finally{try{a||null==_.return||_.return()}finally{if(o)throw s}}}else i.add(t)}else this._continuous.insert(r,new Ps(e,t))}},{key:"_removeForGeneric",value:function(e,t){t.isProper()?this._removeForContinuous(e,t):t.isSingle()&&this._removeForOneshotGroup(e,t)}},{key:"_removeForOneshotGroup",value:function(e,t){for(var r=t.lower,n=0,i=["_oneshot","_oneshot_L","_oneshot_R"];n<i.length;n++){var a=this[i[n]],o=a.findEqual(r);if(null!==o){var s=o.value;s.has(e)&&(s.delete(e),0==s.size&&a.remove(o));break}}}},{key:"_removeForContinuous",value:function(e,t){for(var r=this._continuous,n=r.findUpper(t.lower),i=null!==n?n.findPredecessor():r.findLast(),a=r.findUpper(t.upper),o=i||n;o!==a;){var s=o.value.curves;s.delete(e),o=0==s.size?r.remove(o):o.findSuccessor()}for(var u=this._oneshot,_=u.findLower(t.lower),l=u.findUpper(t.upper),c=_;c!==l;){var h=c.value;h.delete(e),c=0==h.size?u.remove(c):c.findSuccessor()}}},{key:"_collectCurves",value:function(e,t){var r=new Set;return this._collectContinuousCurves(e,t,r),this._collectOneshotCurves(e,t,"_oneshot",!0,!0,r),this._collectOneshotCurves(e,t,"_oneshot_L",!1,!0,r),this._collectOneshotCurves(e,t,"_oneshot_R",!0,!1,r),r}},{key:"_collectContinuousCurves",value:function(e,t,r){var n=this._continuous.findLower(e);if(null!==n){var i=n.findPredecessor();null!==i&&i.value.interval.includesTime(e)&&(n=i)}else{var a=this._continuous.findLast();null!==a&&a.value.interval.includesTime(e)&&(n=a)}var o=this._continuous.findLower(t);if(null!==o){var s=o.value.interval;s.lower.equals(t)&&!s.l_open&&(o=o.findSuccessor())}for(var u=n;u!==o;u=u.findSuccessor()){var _=!0,l=!1,c=void 0;try{for(var h,f=u.value.curves[Symbol.iterator]();!(_=(h=f.next()).done);_=!0){var d=h.value;r.add(d)}}catch(e){l=!0,c=e}finally{try{_||null==f.return||f.return()}finally{if(l)throw c}}}}},{key:"_collectOneshotCurves",value:function(e,t,r,n,i,a){for(var o=this[r],s=n?o.findLower(e):o.findUpper(e),u=n?o.findUpper(t):o.findLower(t),_=s;_!==u;_=_.findSuccessor()){var l=!0,c=!1,h=void 0;try{for(var f,d=_.value[Symbol.iterator]();!(l=(f=d.next()).done);l=!0){var v=f.value;a.add(v)}}catch(e){c=!0,h=e}finally{try{l||null==d.return||d.return()}finally{if(c)throw h}}}}}]),e}(),Ps=function e(t,r){Ge(this,e),this.interval=t,this.curves=new Set(r instanceof Set?r:[r])};function Ss(){return new Zn((function(e,t){return e.lessThan(t)}))}function Ms(e,t){return e.lower.equals(t.lower)&&(e.l_open&&t.l_open||!e.l_open&&!t.l_open)}function Ls(e,t){return e.upper.equals(t.upper)&&(e.u_open&&t.u_open||!e.u_open&&!t.u_open)}var Ds,Cs,Fs=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this,e))).name="mapray.animation.TypeMismatchError",r}return Ye(t,e),t}(nt),Ns=function(){function e(t,r,n,i){if(Ge(this,e),!r.isTypeSupported(n))throw new Fs("type mismatch error");this._updater=t,this._curve=r,this._type=n,this._setter=i,t._$register(this)}return qe(e,[{key:"unbind",value:function(){this._updater._$unregister(this)}},{key:"_$update",value:function(e){var t=this._curve.getValue(e,this._type);(0,this._setter)(t)}},{key:"updater",get:function(){return this._updater}},{key:"curve",get:function(){return this._curve}},{key:"type",get:function(){return this._type}},{key:"setter",get:function(){return this._setter}},{key:"_$curve",get:function(){return this._curve}}]),e}(),Os=ae("navigator","userAgent")||"",Us=n.process,Vs=Us&&Us.versions,Bs=Vs&&Vs.v8;Bs?Cs=(Ds=Bs.split("."))[0]+Ds[1]:Os&&(!(Ds=Os.match(/Edge\/(\d+)/))||Ds[1]>=74)&&(Ds=Os.match(/Chrome\/(\d+)/))&&(Cs=Ds[1]);var zs=Cs&&+Cs,Gs=Zt("species"),js=function(e){return zs>=51||!i((function(){var t=[];return(t.constructor={})[Gs]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},qs=Zt("isConcatSpreadable"),Ys=zs>=51||!i((function(){var e=[];return e[qs]=!1,e.concat()[0]!==e})),Hs=js("concat"),Xs=function(e){if(!o(e))return!1;var t=e[qs];return void 0!==t?!!t:zt(e)};Le({target:"Array",proto:!0,forced:!Ys||!Hs},{concat:function(e){var t,r,n,i,a,o=Gt(this),s=or(o,0),u=0;for(t=-1,n=arguments.length;t<n;t++)if(a=-1===t?o:arguments[t],Xs(a)){if(u+(i=le(a.length))>9007199254740991)throw TypeError("Maximum allowed index exceeded");for(r=0;r<i;r++,u++)r in a&&bs(s,u,a[r])}else{if(u>=9007199254740991)throw TypeError("Maximum allowed index exceeded");bs(s,u++,a)}return s.length=u,s}});var Ws=function(){function e(){Ge(this,e)}return qe(e,[{key:"enumSupportedParameters",value:function(){this._override_error("enumSupportedParameters")}},{key:"isBound",value:function(e){this._override_error("isBound")}},{key:"getBoundUpdater",value:function(e){this._override_error("getBoundUpdater")}},{key:"getBoundCurve",value:function(e){this._override_error("getBoundCurve")}},{key:"bind",value:function(e,t,r){this._override_error("bind")}},{key:"unbind",value:function(e){this._override_error("unbind")}},{key:"unbindAll",value:function(){this._override_error("unbindAll")}},{key:"unbindAllRecursively",value:function(){this._override_error("unbindAllRecursively")}},{key:"_override_error",value:function(e){throw new Error("BindingBlock#"+e+"() method has not been overridden in "+this.constructor.name)}}]),e}(),Qs=function(){function e(t,r){Ge(this,e),this._id=t,this._types=r.concat()}return qe(e,[{key:"id",get:function(){return this._id}},{key:"types",get:function(){return this._types}}]),e}();Ws.Parameter=Qs;var Zs=function(e){function t(){var e;return Ge(this,t),(e=Ke(this,He(t).call(this)))._entries=new Map,e._bounds=new Map,e._descendant_unbinders=[],e}return Ye(t,e),qe(t,[{key:"addEntry",value:function(e,t,r,n){this._entries.set(e,new Js(t,r,n));var i=this._bounds.get(e);void 0!==i&&(i.unbind(),this._bounds.delete(e))}},{key:"addDescendantUnbinder",value:function(e){this._descendant_unbinders.push(e)}},{key:"enumSupportedParameters",value:function(){var e=[],t=!0,r=!1,n=void 0;try{for(var i,a=this._entries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=et(i.value,2),s=o[0],u=o[1];e.push(new Ws.Parameter(s,u.types))}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return e}},{key:"isBound",value:function(e){return this._bounds.has(e)}},{key:"getBoundUpdater",value:function(e){var t=this._bounds.get(e);return void 0!==t?t.updater:null}},{key:"getBoundCurve",value:function(e){var t=this._bounds.get(e);return void 0!==t?t.curve:null}},{key:"bind",value:function(e,t,r){var n=this._entries.get(e);if(void 0===n)throw new nt("unsupported parameter");this.unbind(e);var i=n.types,a=1==i.length?i[0]:n.type_solver(r);if(null==a||!r.isTypeSupported(a))throw new Fs("type mismatch error");this._bounds.set(e,new Ns(t,r,a,n.setter))}},{key:"unbind",value:function(e){var t=this._bounds.get(e);void 0!==t&&(t.unbind(),this._bounds.delete(e))}},{key:"unbindAll",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._bounds[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){et(n.value,2)[1].unbind()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}this._bounds.clear()}},{key:"unbindAllRecursively",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._descendant_unbinders[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){(0,n.value)()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}this.unbindAll()}}]),t}(Ws),Js=function e(t,r,n){if(Ge(this,e),t.length<1||t.length>=2&&!r)throw new nt("bad parameter entry");this.types=t.concat(),this.type_solver=r,this.setter=n},Ks=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this)))._constant_type=e,n._constant_value=e.getDefaultValue(),void 0!==r&&n.setConstantValue(r),n}return Ye(t,e),qe(t,[{key:"setConstantValue",value:function(e){e!=this._constant_value&&(this._constant_value=this._constant_type.getCloneValue(e),this.notifyValueChange(Ot.UNIVERSAL))}},{key:"isTypeSupported",value:function(e){var t=this._constant_type;return e.isConvertible(t)}},{key:"getValue",value:function(e,t){var r=this._constant_type,n=r.getCloneValue(this._constant_value);return t.convertValue(r,n)}},{key:"getInvariance",value:function(e){return(new Kn).write(Ot.UNIVERSAL)}}]),t}(ws),$s=function(){function e(){Ge(this,e)}return qe(e,null,[{key:"getDimension",value:function(e){return Ti.find("number")===e?1:Ti.find("vector2")===e?2:Ti.find("vector3")===e?3:Ti.find("vector4")===e?4:0}},{key:"findKeyFrameIndex",value:function(e,t,r,n){for(var i=r,a=n;;){if(!(a-i>=2)){var o=t[i];return e.lessThan(o)?i:a}var s=Math.floor((i+a)/2),u=t[s];if(u.lessThan(e))i=s;else{if(!e.lessThan(u))return s+1;a=s}}return 0}},{key:"findFirstTypeSupported",value:function(e,t){var r=!0,n=!1,i=void 0;try{for(var a,o=t[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;if(e.isTypeSupported(s))return s}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return null}}]),e}(),eu=function(e){function t(e,r){var n;Ge(this,t),n=Ke(this,He(t).call(this));var i=$s.getDimension(e);if(0==i)throw nt("unsupported type");if(n._value_type=e,n._dimension=i,n._num_keyframes=void 0,n._key_times=void 0,n._key_values=void 0,void 0!==r)n.setKeyFrames(r);else{var a=Lt.fromNumber(0),o=Lt.fromNumber(1),s=e.getDefaultValue();n.setKeyFrames([a,s,o,s])}return n}return Ye(t,e),qe(t,[{key:"setKeyFrames",value:function(e){var t=this._dimension;this._num_keyframes=e.length/2,this._key_times=new Array(this._num_keyframes),this._key_values=new Float64Array(this._num_keyframes*t);for(var r=0,n=0;r<this._num_keyframes;++r,n+=t){var i=e[2*r],a=e[2*r+1];if(this._key_times[r]=i,1==t)this._key_values[n]=a;else for(var o=0;o<t;++o)this._key_values[n+o]=a[o]}this.notifyValueChange(Ot.UNIVERSAL)}},{key:"isTypeSupported",value:function(e){var t=this._value_type;return e.isConvertible(t)}},{key:"getValue",value:function(e,t){var r=this._value_type,n=this._getInterpolatedValue(e);return t.convertValue(r,n)}},{key:"getInvariance",value:function(e){var t=this._key_times[0],r=this._key_times[this._num_keyframes-1],n=new Ot(t,r,!0,!0),i=new Kn;return i.write(n.getPrecedings()),i.write(n.getFollowings()),i.getNarrowed(e)}},{key:"_getInterpolatedValue",value:function(e){var t=$s.findKeyFrameIndex(e,this._key_times,0,this._num_keyframes);return 0==t?this._createKeyFrameValue(0):t==this._num_keyframes?this._createKeyFrameValue(t-1):this._createValueBy2Keys(t-1,t,e)}},{key:"_createKeyFrameValue",value:function(e){var t=this._dimension,r=this._key_values;if(1==t)return r[e];for(var n=t*e,i=new Float64Array(t),a=0;a<t;++a)i[a]=r[n+a];return i}},{key:"_createValueBy2Keys",value:function(e,t,r){var n=this._key_times[e].toNumber(),i=this._key_times[t].toNumber(),a=(r.toNumber()-n)/(i-n),o=1-a,s=this._dimension,u=this._key_values;if(1==s)return o*u[e]+a*u[t];for(var _=s*e,l=s*t,c=new Float64Array(s),h=0;h<s;++h)c[h]=o*u[_+h]+a*u[l+h];return c}}]),t}(ws),tu=function(e){function t(e,r){var n;if(Ge(this,t),(n=Ke(this,He(t).call(this)))._value_type=e,n._num_keyframes=void 0,n._key_times=void 0,n._key_values=void 0,void 0!==r)n.setKeyFrames(r);else{var i=Lt.fromNumber(0),a=e.getDefaultValue();n.setKeyFrames([i,a])}return n}return Ye(t,e),qe(t,[{key:"setKeyFrames",value:function(e){this._num_keyframes=e.length/2,this._key_times=new Array(this._num_keyframes),this._key_values=new Array(this._num_keyframes);for(var t=0;t<this._num_keyframes;++t){var r=e[2*t],n=e[2*t+1];this._key_times[t]=r,this._key_values[t]=this._value_type.getCloneValue(n)}this.notifyValueChange(Ot.UNIVERSAL)}},{key:"isTypeSupported",value:function(e){var t=this._value_type;return e.isConvertible(t)}},{key:"getValue",value:function(e,t){var r=this._value_type,n=this._getInterpolatedValue(e);return t.convertValue(r,n)}},{key:"getInvariance",value:function(e){if(1==this._num_keyframes)return(new Kn).write(Ot.UNIVERSAL);var t=new Kn,r=this._key_times[1];t.write(new Ot(r,r).getPrecedings());var n=this._key_times[this._num_keyframes-2],i=this._key_times[this._num_keyframes-1];return t.write(new Ot(n,i,!1,!0).getFollowings()),t.getNarrowed(e)}},{key:"_getInterpolatedValue",value:function(e){var t=$s.findKeyFrameIndex(e,this._key_times,0,this._num_keyframes),r=t>0?t-1:0;return this._value_type.getCloneValue(this._key_values[r])}}]),t}(ws),ru=_r.map,nu=js("map"),iu=$r("map");Le({target:"Array",proto:!0,forced:!nu||!iu},{map:function(e){return ru(this,e,arguments.length>1?arguments[1]:void 0)}});var au=function(e){function t(e,r){var n;Ge(this,t),n=Ke(this,He(t).call(this));var i=$s.getDimension(e);if(i<2&&i>4)throw new Fs("unexpected type");return n._vector_type=e,n._dimension=i,n._children=new Array(i),n._listeners=new Array(i),n._setupInitialChildren(),void 0!==r&&n.setChildren(r),n}return Ye(t,e),qe(t,[{key:"setChild",value:function(e,t){this._setChildCommon(e,t),this.notifyValueChange(Ot.UNIVERSAL)}},{key:"setChildren",value:function(e){for(var t=0;t<this._dimension;++t)this._setChildCommon(t,e[t]);this.notifyValueChange(Ot.UNIVERSAL)}},{key:"isTypeSupported",value:function(e){var t=this._vector_type;return e.isConvertible(t)}},{key:"getValue",value:function(e,t){var r=this._vector_type,n=this._getCompoundValue(e);return t.convertValue(r,n)}},{key:"getInvariance",value:function(e){var t=this._children.map((function(t){return t.getInvariance(e)}));return Kn.merge(t)}},{key:"_setupInitialChildren",value:function(){for(var e=this,t=new Ks(ou),r=0;r<this._dimension;++r){var n=function(t){e.notifyValueChange(t)};t.addValueChangeListener(n),this._children[r]=t,this._listeners[r]=n}}},{key:"_setChildCommon",value:function(e,t){var r=this;if(!t.isTypeSupported(ou))throw new Fs("type mismatch error");var n=this._children[e],i=this._listeners[e];n.removeValueChangeListener(i);var a=function(e){r.notifyValueChange(e)};t.addValueChangeListener(a),this._children[e]=t,this._listeners[e]=a}},{key:"_getCompoundValue",value:function(e){for(var t=this._dimension,r=new Float64Array(t),n=0;n<t;++n)r[n]=this._children[n].getValue(e,ou);return r}}]),t}(ws),ou=Ti.find("number"),su={AnimationError:nt,Time:Lt,Interval:Ot,Invariance:Kn,Type:Ti,Curve:ws,Updater:As,Binder:Ns,TypeMismatchError:Fs,BindingBlock:Ws,EasyBindingBlock:Zs,ConstantCurve:Ks,KFLinearCurve:eu,KFStepCurve:tu,ComboVectorCurve:au},uu=function e(t,r){Ge(this,e),this.position=t||hs.createVector3(),this.direction=r||hs.createVector3([0,0,-1])},_u=function(){function e(t){Ge(this,e),this._canvas_size=t,this.fov=46,this.near=1,this.far=1e3,this.view_to_gocs=hs.createMatrix(),hs.setIdentity(this.view_to_gocs)}return qe(e,[{key:"copyViewParameters",value:function(e){this.fov=e.fov,this.near=e.near,this.far=e.far,hs.copyMatrix(e.view_to_gocs,this.view_to_gocs)}},{key:"getCanvasToView",value:function(e){var t=e||hs.createMatrix(),r=this._canvas_size.width,n=this._canvas_size.height,i=this.near,a=this.far,o=this.fov*hs.DEGREE/2,s=n/r,u=i*Math.tan(o)/Math.sqrt(1+s*s),_=u*s;return t[0]=2*u/(i*r),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*_/(i*n),t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=0,t[11]=(i-a)/(i*a),t[12]=-u/i,t[13]=_/i,t[14]=-1,t[15]=1/i,t}},{key:"getCanvasToGocs",value:function(e){var t=this.getCanvasToView(e),r=t[0],n=t[5],i=t[11],a=t[12],o=t[13],s=t[15],u=this.view_to_gocs,_=u[0],l=u[1],c=u[2],h=u[4],f=u[5],d=u[6],v=u[8],p=u[9],y=u[10],g=u[12],m=u[13],k=u[14],E=t;return E[0]=_*r,E[1]=l*r,E[2]=c*r,E[4]=h*n,E[5]=f*n,E[6]=d*n,E[8]=g*i,E[9]=m*i,E[10]=k*i,E[12]=_*a+h*o-v+g*s,E[13]=l*a+f*o-p+m*s,E[14]=c*a+d*o-y+k*s,E}},{key:"getViewToCanvas",value:function(e){var t=e||hs.createMatrix(),r=this._canvas_size.width,n=this._canvas_size.height,i=this.near,a=this.far,o=this.fov*hs.DEGREE/2,s=n/r,u=i*Math.tan(o)/Math.sqrt(1+s*s),_=u*s;return t[0]=i*r/(2*u),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-i*n/(2*_),t[6]=0,t[7]=0,t[8]=-r/2,t[9]=-n/2,t[10]=a/(i-a),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*a/(i-a),t[15]=0,t}},{key:"getCanvasRay",value:function(t,r){var n=t[0],i=t[1],a=r||new uu,o=this.getCanvasToGocs(e._temp_mat),s=n*o[0]+i*o[4]+o[12],u=n*o[1]+i*o[5]+o[13],_=n*o[2]+i*o[6]+o[14],l=n*o[3]+i*o[7]+o[15],c=a.position;c[0]=s/l,c[1]=u/l,c[2]=_/l;var h=this.view_to_gocs,f=a.direction;return f[0]=c[0]-h[12],f[1]=c[1]-h[13],f[2]=c[2]-h[14],hs.normalize3(f,f),a}},{key:"createRenderInfo",value:function(e,t,r,n){var i=this._canvas_size;return new lu(this,i.width,i.height,e,t,r,n)}},{key:"canvas_size",get:function(){return this._canvas_size}}]),e}();_u._temp_mat=hs.createMatrix();var lu=function(){function e(t,r,n,i,a,o,s){Ge(this,e),this._view_to_clip=hs.createMatrix(),this._volume_planes=[];for(var u=0;u<6;++u)this._volume_planes.push(hs.createVector4());this._pixel_step=0,this._setup_view_to_clip(t,r,n,i,a,o,s),this._setup_volume_planes(),this._setup_pixel_step(r,n)}return qe(e,[{key:"_setup_view_to_clip",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:t,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:r,s=2*n/t,u=2*i/r,_=a/t,l=o/r,c=r/t,h=e.fov*hs.DEGREE/2,f=e.near*Math.tan(h)/Math.sqrt(1+c*c),d=(s-_)*f,v=(s+_)*f,p=(u-l)*f*c,y=(u+l)*f*c;hs.frustum_matrix(d,v,p,y,e.near,e.far,this._view_to_clip)}},{key:"_setup_volume_planes",value:function(){var e=this._view_to_clip,t=this._volume_planes;this._add_matrix_rows(e,3,2,t[0]),this._sub_matrix_rows(e,3,2,t[1]),this._add_matrix_rows(e,3,0,t[2]),this._sub_matrix_rows(e,3,0,t[3]),this._add_matrix_rows(e,3,1,t[4]),this._sub_matrix_rows(e,3,1,t[5]);for(var r=0;r<6;++r){var n=t[r],i=n[0],a=n[1],o=n[2],s=1/Math.sqrt(i*i+a*a+o*o);n[0]*=s,n[1]*=s,n[2]*=s,n[3]*=s}}},{key:"_setup_pixel_step",value:function(e,t){var r=this._view_to_clip,n=r[0],i=r[5],a=r[11],o=2*(r[15]-a),s=o/(n*e),u=o/(i*t);this._pixel_step=Math.sqrt(s*s+u*u)*Math.SQRT1_2}},{key:"_add_matrix_rows",value:function(e,t,r,n){return n[0]=e[t]+e[r],n[1]=e[t+4]+e[r+4],n[2]=e[t+8]+e[r+8],n[3]=e[t+12]+e[r+12],n}},{key:"_sub_matrix_rows",value:function(e,t,r,n){return n[0]=e[t]-e[r],n[1]=e[t+4]-e[r+4],n[2]=e[t+8]-e[r+8],n[3]=e[t+12]-e[r+12],n}},{key:"view_to_clip",get:function(){return this._view_to_clip}},{key:"volume_planes",get:function(){return this._volume_planes}},{key:"pixel_step",get:function(){return this._pixel_step}}]),e}(),cu=function(){function e(t){Ge(this,e);var r=this._getContextWebGL(t,{depth:!0,antialias:!0});if(!r)throw new Error("It doesn't appear your computer can support WebGL.");this._canvas=t,this._context=r,this._setupExtensions(r)}return qe(e,[{key:"_getContextWebGL",value:function(e,t){for(var r=["webgl","experimental-webgl"],n=0;n<r.length;++n){var i=e.getContext(r[n],t);if(i)return i}return null}},{key:"_setupExtensions",value:function(e){this.OES_element_index_uint=e.getExtension("OES_element_index_uint"),this.EXT_texture_filter_anisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic"),this.WEBGL_depth_texture=e.getExtension("WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")}},{key:"canvas",get:function(){return this._canvas}},{key:"context",get:function(){return this._context}}]),e}(),hu=_r.forEach,fu=To("forEach"),du=$r("forEach"),vu=fu&&du?[].forEach:function(e){return hu(this,e,arguments.length>1?arguments[1]:void 0)};Le({target:"Array",proto:!0,forced:[].forEach!=vu},{forEach:vu});var pu=js("slice"),yu=$r("slice",{ACCESSORS:!0,0:0,1:2}),gu=Zt("species"),mu=[].slice,ku=Math.max;Le({target:"Array",proto:!0,forced:!pu||!yu},{slice:function(e,t){var r,n,i,a=ee(this),s=le(a.length),u=fe(e,s),_=fe(void 0===t?s:t,s);if(zt(a)&&("function"!=typeof(r=a.constructor)||r!==Array&&!zt(r.prototype)?o(r)&&null===(r=r[gu])&&(r=void 0):r=void 0,r===Array||void 0===r))return mu.call(a,u,_);for(n=new(void 0===r?Array:r)(ku(_-u,0)),i=0;u<_;u++,i++)u in a&&bs(n,i,a[u]);return n.length=i,n}});var Eu=[],wu=Eu.sort,bu=i((function(){Eu.sort(void 0)})),xu=i((function(){Eu.sort(null)})),Tu=To("sort");Le({target:"Array",proto:!0,forced:bu||!xu||!Tu},{sort:function(e){return void 0===e?wu.call(Gt(this)):wu.call(Gt(this),nr(e))}});var Au=js("splice"),Ru=$r("splice",{ACCESSORS:!0,0:0,1:2}),Iu=Math.max,Pu=Math.min;Le({target:"Array",proto:!0,forced:!Au||!Ru},{splice:function(e,t){var r,n,i,a,o,s,u=Gt(this),_=le(u.length),l=fe(e,_),c=arguments.length;if(0===c?r=n=0:1===c?(r=0,n=_-l):(r=c-2,n=Pu(Iu(ue(t),0),_-l)),_+r-n>9007199254740991)throw TypeError("Maximum allowed length exceeded");for(i=or(u,n),a=0;a<n;a++)(o=l+a)in u&&bs(i,a,u[o]);if(i.length=n,r<n){for(a=l;a<_-n;a++)s=a+r,(o=a+n)in u?u[s]=u[o]:delete u[s];for(a=_;a>_-n+r;a--)delete u[a-1]}else if(r>n)for(a=_-n;a>l;a--)s=a+r-1,(o=a+n-1)in u?u[s]=u[o]:delete u[s];for(a=0;a<r;a++)u[a+l]=arguments[a+2];return u.length=_-n+r,i}});var Su=Math.expm1,Mu=Math.exp,Lu=!Su||Su(10)>22025.465794806718||Su(10)<22025.465794806718||-2e-17!=Su(-2e-17)?function(e){return 0==(e=+e)?e:e>-1e-6&&e<1e-6?e+e*e/2:Mu(e)-1}:Su,Du=Math.cosh,Cu=Math.abs,Fu=Math.E;Le({target:"Math",stat:!0,forced:!Du||Du(710)===1/0},{cosh:function(e){var t=Lu(Cu(e)-1)+1;return(t+1/(t*Fu*Fu))*(Fu/2)}});var Nu=function(){var e=c(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t};function Ou(e,t){return RegExp(e,t)}var Uu={UNSUPPORTED_Y:i((function(){var e=Ou("a","y");return e.lastIndex=2,null!=e.exec("abcd")})),BROKEN_CARET:i((function(){var e=Ou("^r","gy");return e.lastIndex=2,null!=e.exec("str")}))},Vu=RegExp.prototype.exec,Bu=String.prototype.replace,zu=Vu,Gu=function(){var e=/a/,t=/b*/g;return Vu.call(e,"a"),Vu.call(t,"a"),0!==e.lastIndex||0!==t.lastIndex}(),ju=Uu.UNSUPPORTED_Y||Uu.BROKEN_CARET,qu=void 0!==/()??/.exec("")[1];(Gu||qu||ju)&&(zu=function(e){var t,r,n,i,a=this,o=ju&&a.sticky,s=Nu.call(a),u=a.source,_=0,l=e;return o&&(-1===(s=s.replace("y","")).indexOf("g")&&(s+="g"),l=String(e).slice(a.lastIndex),a.lastIndex>0&&(!a.multiline||a.multiline&&"\n"!==e[a.lastIndex-1])&&(u="(?: "+u+")",l=" "+l,_++),r=new RegExp("^(?:"+u+")",s)),qu&&(r=new RegExp("^"+u+"$(?!\\s)",s)),Gu&&(t=a.lastIndex),n=Vu.call(o?r:a,l),o?n?(n.input=n.input.slice(_),n[0]=n[0].slice(_),n.index=a.lastIndex,a.lastIndex+=n[0].length):a.lastIndex=0:Gu&&n&&(a.lastIndex=a.global?n.index+n[0].length:t),qu&&n&&n.length>1&&Bu.call(n[0],r,(function(){for(i=1;i<arguments.length-2;i++)void 0===arguments[i]&&(n[i]=void 0)})),n});var Yu=zu;Le({target:"RegExp",proto:!0,forced:/./.exec!==Yu},{exec:Yu});var Hu=Zt("species"),Xu=!i((function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")})),Wu="$0"==="a".replace(/./,"$0"),Qu=Zt("replace"),Zu=!!/./[Qu]&&""===/./[Qu]("a","$0"),Ju=!i((function(){var e=/(?:)/,t=e.exec;e.exec=function(){return t.apply(this,arguments)};var r="ab".split(e);return 2!==r.length||"a"!==r[0]||"b"!==r[1]})),Ku=On.charAt,$u=function(e,t,r){return t+(r?Ku(e,t).length:1)},e_=function(e,t){var r=e.exec;if("function"==typeof r){var n=r.call(e,t);if("object"!=typeof n)throw TypeError("RegExp exec method returned something other than an Object or null");return n}if("RegExp"!==Z(e))throw TypeError("RegExp#exec called on incompatible receiver");return Yu.call(e,t)};for(var t_ in function(e,t,r,n){var a=Zt(e),o=!i((function(){var t={};return t[a]=function(){return 7},7!=""[e](t)})),s=o&&!i((function(){var t=!1,r=/a/;return"split"===e&&((r={}).constructor={},r.constructor[Hu]=function(){return r},r.flags="",r[a]=/./[a]),r.exec=function(){return t=!0,null},r[a](""),!t}));if(!o||!s||"replace"===e&&(!Xu||!Wu||Zu)||"split"===e&&!Ju){var u=/./[a],_=r(a,""[e],(function(e,t,r,n,i){return t.exec===Yu?o&&!i?{done:!0,value:u.call(t,r,n)}:{done:!0,value:e.call(r,t,n)}:{done:!1}}),{REPLACE_KEEPS_$0:Wu,REGEXP_REPLACE_SUBSTITUTES_UNDEFINED_CAPTURE:Zu}),l=_[0],c=_[1];G(String.prototype,e,l),G(RegExp.prototype,a,2==t?function(e,t){return c.call(e,this,t)}:function(e){return c.call(e,this)})}n&&p(RegExp.prototype[a],"sham",!0)}("match",1,(function(e,t,r){return[function(t){var r=$(this),n=null==t?void 0:t[e];return void 0!==n?n.call(t,r):new RegExp(t)[e](String(r))},function(e){var n=r(t,e,this);if(n.done)return n.value;var i=c(e),a=String(this);if(!i.global)return e_(i,a);var o=i.unicode;i.lastIndex=0;for(var s,u=[],_=0;null!==(s=e_(i,a));){var l=String(s[0]);u[_]=l,""===l&&(i.lastIndex=$u(a,le(i.lastIndex),o)),_++}return 0===_?null:u}]})),Gn){var r_=n[t_],n_=r_&&r_.prototype;if(n_&&n_.forEach!==vu)try{p(n_,"forEach",vu)}catch(e){n_.forEach=vu}}Le({global:!0,forced:!Li},{DataView:va.DataView});var i_=function(){function e(t,r,n){Ge(this,e);var i=Math.pow(2,t.z-1),a=1<<r;this._sx=i/Math.PI*a,this._sy=-this._sx,this._ox=(i-t.x)*a,this._oy=(i-t.y)*a,this._body=n,this._pitch=4*(a+1),this._max=a}return qe(e,[{key:"sample",value:function(e,t){return 0}}]),e}(),a_=function(e){function t(e,r,n){return Ge(this,t),Ke(this,He(t).call(this,e,r,n))}return Ye(t,e),qe(t,[{key:"sample",value:function(e,t){var r=this._sx*e+this._ox,n=Math.floor(r),i=n+1,a=this._sy*t+this._oy,o=Math.floor(a),s=o+1,u=r-n,_=a-o;return(this._sampleInt(n,o)*(1-u)+this._sampleInt(i,o)*u)*(1-_)+(this._sampleInt(n,s)*(1-u)+this._sampleInt(i,s)*u)*_}},{key:"_sampleInt",value:function(e,t){var r=hs.clamp(e,0,this._max),n=hs.clamp(t,0,this._max),i=this._pitch*n+4*r;return this._body.getFloat32(i,!0)}}]),t}(i_),o_=function(e){function t(e,r,n){return Ge(this,t),Ke(this,He(t).call(this,e,r,n))}return Ye(t,e),qe(t,[{key:"sample",value:function(e,t){var r=Math.round(this._sx*e+this._ox),n=Math.round(this._sy*t+this._oy),i=this._pitch*n+4*r;return this._body.getFloat32(i,!0)}}]),t}(i_),s_=function(){function e(t,r){if(Ge(this,e),this._ρ=t,this._maps=[],t>=1){var n=this._create_first_map(r);this._maps.push(n);for(var i=n,a=-2;a>=-t;--a){var o=this._create_next_map(a,i);this._maps.push(o),i=o}}}return qe(e,[{key:"_create_first_map",value:function(e){for(var t=1<<this._ρ-1,r=new Float32Array(t*t),n=4*(2*t+1),i=t,a=0;a<t;++a)for(var o=2*a*n,s=a*i,u=0;u<t;++u){var _=e.getFloat32(o,!0),l=e.getFloat32(o+4,!0),c=e.getFloat32(o+8,!0),h=e.getFloat32(o+n,!0),f=e.getFloat32(o+n+4,!0),d=e.getFloat32(o+n+8,!0),v=e.getFloat32(o+2*n,!0),p=e.getFloat32(o+2*n+4,!0),y=e.getFloat32(o+2*(n+4),!0);r[s]=(_+2*l+c+2*h+4*f+2*d+v+2*p+y)/16,o+=8,s+=1}return r}},{key:"_create_next_map",value:function(e,t){for(var r=1<<this._ρ+e,n=new Float32Array(r*r),i=2*r,a=r,o=0;o<r;++o)for(var s=2*o*i,u=o*a,_=0;_<r;++_){var l=t[s],c=t[s+1],h=t[s+i],f=t[s+i+1];n[u]=(l+c+h+f)/4,s+=2,u+=1}return n}},{key:"sample",value:function(e,t,r){return this._maps[this._ρ-e-1][r*(1<<e)+t]}}]),e}(),u_=function(){function e(t,r,n,i,a){Ge(this,e),this._z=t,this._x=r,this._y=n,this._ρ=i;var o=new DataView(a);this._qlevels=[o.getUint8(e.OFFSET_QLEVEL_00),o.getUint8(e.OFFSET_QLEVEL_10),o.getUint8(e.OFFSET_QLEVEL_01),o.getUint8(e.OFFSET_QLEVEL_11)],this._hmin=o.getFloat32(e.OFFSET_HMIN,!0),this._hmax=o.getFloat32(e.OFFSET_HMAX,!0),this._ω=this._createωArray(o),this._body=new DataView(a,e.HEADER_BYTES),this._size=1+(1<<i)}return qe(e,[{key:"isLeaf",value:function(e,t,r){if(e>this._z)return 0==this.getQuadLevel(e,t,r);var n=this._qlevels;return 0==n[0]||0==n[1]||0==n[2]||0==n[3]}},{key:"getQuadLevel",value:function(e,t,r){var n=Math.pow(2,this._z-e),i=Math.floor(2*((t+.5)*n-this._x)),a=Math.floor(2*((r+.5)*n-this._y));return this._qlevels[2*a+i]}},{key:"getQuadLevelDirect",value:function(e,t){var r=Math.round(Math.pow(2,this._z+1)),n=hs.clamp(Math.floor(e*r),0,r-1)%2,i=hs.clamp(Math.floor(t*r),0,r-1)%2;return this._qlevels[2*i+n]}},{key:"getHeights",value:function(t,r){var n=4*(r*this._size+t),i=4*this._size,a=e._getHeights_result;return a[0]=this._body.getFloat32(n,!0),a[1]=this._body.getFloat32(n+4,!0),a[2]=this._body.getFloat32(n+i,!0),a[3]=this._body.getFloat32(n+i+4,!0),a}},{key:"getDivisionPowers",value:function(t,r,n,i){var a=t.z,o=this._z,s=hs.LOG2PI-this._ρ+1,u=this._getComplexity(a,t.x,t.y),_=Math.min(o+this._ρ,Math.round(r+s+u))-a,l=e._getDivisionPowers_result;return l[0]=Math.max(n,_),l[1]=Math.max(i,_),l}},{key:"newSampler",value:function(e){return new(e.z-this._z>this._ρ?a_:o_)(this,this._ρ,this._body)}},{key:"newLinearSampler",value:function(){return new a_(this,this._ρ,this._body)}},{key:"newAvgHeightMaps",value:function(){return new s_(this._ρ,this._body)}},{key:"_createωArray",value:function(t){for(var r=[],n=0,i=0;i<3;++i){for(var a=1<<2*i,o=new Float32Array(a),s=0;s<a;++s)o[s]=t.getFloat32(e.OFFSET_ω+n,!0),n+=4;r.push(o)}return r}},{key:"_getComplexity",value:function(t,r,n){var i,a,o=t-this._z,s=Math.round(Math.pow(2,o));o<=2?(i=r-s*this._x,a=n-s*this._y):(i=Math.floor(4*((r+.5)/s-this._x)),a=Math.floor(4*((n+.5)/s-this._y)));var u=Math.min(o,2),_=this._ω[u];return Math.min(_[a*(1<<u)+i],e.ω_limit)}},{key:"z",get:function(){return this._z}},{key:"x",get:function(){return this._x}},{key:"y",get:function(){return this._y}},{key:"height_min",get:function(){return this._hmin}},{key:"height_max",get:function(){return this._hmax}}]),e}();u_.OFFSET_QLEVEL_00=0,u_.OFFSET_QLEVEL_10=1,u_.OFFSET_QLEVEL_01=2,u_.OFFSET_QLEVEL_11=3,u_.OFFSET_HMIN=4,u_.OFFSET_HMAX=8,u_.OFFSET_ω=12,u_.HEADER_BYTES=96,u_.ω_limit=6,u_._getHeights_result=new Array(4),u_._getDivisionPowers_result=new Array(2),Ha("Int16",(function(e){return function(t,r,n){return e(this,t,r,n)}})),Ha("Int32",(function(e){return function(t,r,n){return e(this,t,r,n)}}));var __=function(){function e(){Ge(this,e)}return qe(e,null,[{key:"getCenter",value:function(e,t){switch(e.z){case 0:return function(e){return e[0]=0,e[1]=0,e[2]=0,e}(t);case 1:return function(e,t,r){var n=hs.EARTH_RADIUS;return r[0]=0,r[1]=n*(e-.5),r[2]=n*(.5-t),r}(e.x,e.y,t);default:return function(e,t,r,n){var i=Math.PI,a=Math.pow(2,1-e)*i,o=i-(r+1)*a,s=i-r*a,u=t*a-i,_=(t+1)*a-i,l=Math.exp(o),c=Math.exp(s),h=l*l,f=c*c,d=hs.EARTH_RADIUS/2,v=2*l/(h+1),p=2*c/(f+1);o+s<0?u+_<-i?(n[0]=d*(p*Math.cos(u)+v*Math.cos(_)),n[1]=d*(p*Math.sin(_)+v*Math.sin(u))):u+_<0?(n[0]=d*(v*Math.cos(u)+p*Math.cos(_)),n[1]=d*(p*Math.sin(u)+v*Math.sin(_))):u+_<i?(n[0]=d*(v*Math.cos(_)+p*Math.cos(u)),n[1]=d*(v*Math.sin(u)+p*Math.sin(_))):(n[0]=d*(p*Math.cos(_)+v*Math.cos(u)),n[1]=d*(v*Math.sin(_)+p*Math.sin(u))):u+_<-i?(n[0]=d*(v*Math.cos(u)+p*Math.cos(_)),n[1]=d*(v*Math.sin(_)+p*Math.sin(u))):u+_<0?(n[0]=d*(p*Math.cos(u)+v*Math.cos(_)),n[1]=d*(v*Math.sin(u)+p*Math.sin(_))):u+_<i?(n[0]=d*(p*Math.cos(_)+v*Math.cos(u)),n[1]=d*(p*Math.sin(u)+v*Math.sin(_))):(n[0]=d*(v*Math.cos(_)+p*Math.cos(u)),n[1]=d*(p*Math.sin(_)+v*Math.sin(u)));return n[2]=2*d*(f/(f+1)-1/(h+1)),n}(e.z,e.x,e.y,t)}}}]),e}();var l_=function(){function e(t,r,n,i){Ge(this,e);var a=t.context;this._center=this._createCenter(r),this._vertices=null,this._num_vertices=0,this._vertex_attribs={},this._num_quads_x=0,this._num_quads_y=0,this._createVertices(a,r,n,i),this._setupVertexAttribs(a),this._index_type=this._num_vertices<65536?a.UNSIGNED_SHORT:a.UNSIGNED_INT,this._indices=null,this._num_indices=0,this._wire_indices=null,this._num_wire_indices=0,this._gl=a}return qe(e,[{key:"_createCenter",value:function(e){return __.getCenter(e,hs.createVector3())}},{key:"_createVertices",value:function(e,t,r,n){var i=e.ARRAY_BUFFER,a=e.createBuffer(),o=this._createVerticesData(t,r,n);e.bindBuffer(i,a),e.bufferData(i,o.array,e.STATIC_DRAW),e.bindBuffer(i,null),this._vertices=a,this._num_vertices=o.num_vertices,this._num_quads_x=o.num_quads_x,this._num_quads_y=o.num_quads_y}},{key:"_createVerticesData",value:function(t,r,n){for(var i=Math.pow(2,1-t.z)*Math.PI,a=t.x*i-Math.PI,o=Math.PI-(t.y+1)*i,s=1<<r[0],u=1<<r[1],_=1/s,l=1/u,c=i/s,h=i/u,f=this._center,d=n.newSampler(t),v=(s+1)*(u+1),p=new Float32Array(e.VERTEX_SIZE*v),y=0,g=0,m=o;g<u+1;++g,m+=h)for(var k=Math.exp(m),E=k*k,w=(E-1)/(E+1),b=2*k/(E+1),x=0,T=a;x<s+1;++x,T+=c){var A=Math.sin(T),R=Math.cos(T),I=d.sample(T,m),P=hs.EARTH_RADIUS+I,S=b*R,M=b*A,L=w,D=P*S,C=P*M,F=P*L;p[y++]=D-f[0],p[y++]=C-f[1],p[y++]=F-f[2],p[y++]=S,p[y++]=M,p[y++]=L,p[y++]=x*_,p[y++]=g*l}return{array:p,num_vertices:v,num_quads_x:s,num_quads_y:u}}},{key:"_setupVertexAttribs",value:function(t){var r=t.FLOAT,n=e.VERTEX_BYTES;this._vertex_attribs={a_position:{buffer:this._vertices,num_components:3,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_P},a_normal:{buffer:this._vertices,num_components:3,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_N},a_uv:{buffer:this._vertices,num_components:2,component_type:r,normalized:!1,byte_stride:n,byte_offset:e.OFFSET_UV}}}},{key:"_createIndices",value:function(){for(var e=this._gl,t=6*(this._num_quads_x*this._num_quads_y),r=new(this._index_type===e.UNSIGNED_INT?Int32Array:Int16Array)(t),n=0,i=0;i<this._num_quads_y;++i)for(var a=0;a<this._num_quads_x;++a){var o=(this._num_quads_x+1)*i+a,s=o+1,u=o+this._num_quads_x+1,_=u+1;r[n++]=o,r[n++]=s,r[n++]=u,r[n++]=u,r[n++]=s,r[n++]=_}var l=e.ELEMENT_ARRAY_BUFFER,c=e.createBuffer();e.bindBuffer(l,c),e.bufferData(l,r,e.STATIC_DRAW),e.bindBuffer(l,null),this._indices=c,this._num_indices=t}},{key:"_createWireIndices",value:function(){for(var e=this._gl,t=this._index_type===e.UNSIGNED_INT?Int32Array:Int16Array,r=2*(2*this._num_quads_x*this._num_quads_y+this._num_quads_x+this._num_quads_y),n=new t(r),i=0,a=0;a<this._num_quads_y+1;++a)for(var o=0;o<this._num_quads_x;++o){var s=(this._num_quads_x+1)*a+o,u=s+1;n[i++]=s,n[i++]=u}for(o=0;o<this._num_quads_x+1;++o)for(a=0;a<this._num_quads_y;++a){var _=(this._num_quads_x+1)*a+o,l=_+this._num_quads_x+1;n[i++]=_,n[i++]=l}var c=e.ELEMENT_ARRAY_BUFFER,h=e.createBuffer();e.bindBuffer(c,h),e.bufferData(c,n,e.STATIC_DRAW),e.bindBuffer(c,null),this._wire_indices=h,this._num_wire_indices=r}},{key:"dispose",value:function(){var e=this._gl;this._vertex_attribs={},e.deleteBuffer(this._vertices),this._vertices=null,this._indices&&(e.deleteBuffer(this._indices),this._indices=null),this._wire_indices&&(e.deleteBuffer(this._wire_indices),this._wire_indices=null)}},{key:"mul_flake_to_gocs",value:function(e,t){var r=e[0],n=e[4],i=e[8],a=e[12],o=e[1],s=e[5],u=e[9],_=e[13],l=e[2],c=e[6],h=e[10],f=e[14],d=e[3],v=e[7],p=e[11],y=e[15],g=this._center[0],m=this._center[1],k=this._center[2];return t[0]=r,t[1]=o,t[2]=l,t[3]=d,t[4]=n,t[5]=s,t[6]=c,t[7]=v,t[8]=i,t[9]=u,t[10]=h,t[11]=p,t[12]=r*g+n*m+i*k+a,t[13]=o*g+s*m+u*k+_,t[14]=l*g+c*m+h*k+f,t[15]=d*g+v*m+p*k+y,t}},{key:"draw",value:function(e){var t=this._gl,r=e.isWireframe();e.bindVertexAttribs(this._vertex_attribs);var n=r?this.wire_indices:this.indices;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n);var i=r?t.LINES:t.TRIANGLES,a=r?this.num_wire_indices:this.num_indices;t.drawElements(i,a,this._index_type,0)}},{key:"num_vertices",get:function(){return this._num_vertices}},{key:"indices",get:function(){return null===this._indices&&this._createIndices(),this._indices}},{key:"num_indices",get:function(){return null===this._indices&&this._createIndices(),this._num_indices}},{key:"wire_indices",get:function(){return null===this._wire_indices&&this._createWireIndices(),this._wire_indices}},{key:"num_wire_indices",get:function(){return null===this._wire_indices&&this._createWireIndices(),this._num_wire_indices}}]),e}();l_.VERTEX_SIZE=8,l_.VERTEX_BYTES=4*l_.VERTEX_SIZE,l_.OFFSET_P=0,l_.OFFSET_N=12,l_.OFFSET_UV=24;var c_=function(){function e(t,r,n,i){Ge(this,e),this._glenv=t,this.mesh=r,this.material=n,this.transform=i,this.pivot=null,this.bbox=null,this.properties=null,this.sort_z=void 0}return qe(e,[{key:"fastClone",value:function(){var t=new e(this._glenv,this.mesh,this.material,hs.createMatrix(this.transform));return this.pivot&&(t.pivot=hs.createVector3(this.pivot)),this.bbox&&(t.bbox=this.bbox.map((function(e){return hs.createVector3(e)}))),t.properties=this.properties,t}},{key:"isVisible",value:function(t){var r=e._obj_to_view;hs.mul_AA(t._gocs_to_view,this.transform,r);var n=this.bbox;if(n){e._transformBBox(n,r);for(var i=t._volume_planes,a=0;a<i.length;++a)if(e._isBBoxBackSide(i[a]))return!1}var o=this.pivot;return this.sort_z=o?r[2]*o[0]+r[6]*o[1]+r[10]*o[2]+r[14]:r[14],!0}},{key:"isTranslucent",value:function(e){return this.material.isTranslucent(e,this)}},{key:"draw",value:function(e){var t=this.material;t.bindProgram(),t.setParameters(e,this),this.mesh.draw(t)}}],[{key:"_transformBBox",value:function(t,r){for(var n=0;n<2;++n)for(var i=t[n][2],a=0;a<2;++a)for(var o=t[a][1],s=0;s<2;++s){var u=t[s][0],_=e._bbox_points[s+2*a+4*n];_[0]=r[0]*u+r[4]*o+r[8]*i+r[12],_[1]=r[1]*u+r[5]*o+r[9]*i+r[13],_[2]=r[2]*u+r[6]*o+r[10]*i+r[14]}}},{key:"_isBBoxBackSide",value:function(t){for(var r=e._bbox_points,n=0;n<r.length;++n){var i=r[n];if(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+t[3]>=0)return!1}return!0}}]),e}();c_._obj_to_view=hs.createMatrix(),c_._bbox_points=[];for(var h_=0;h_<8;++h_)c_._bbox_points.push(hs.createVector3());var f_=function(){function e(t,r,n){Ge(this,e),this.z=t.z,this.x=t.x,this.y=t.y,this._glenv=r,this._base_mesh=n,this._edata_list=[],this._transform=null}return qe(e,[{key:"addEntityData",value:function(e,t){var r={mesh:e,producer:t};this._edata_list.push(r)}},{key:"getBaseMesh",value:function(){return this._base_mesh}},{key:"getEntityPrimitive",value:function(e,t){var r=this._edata_list[e],n=r.producer.getMaterialAndProperties(t),i=n.material,a=n.properties;if(null===this._transform){this._transform=hs.setIdentity(hs.createMatrix());var o=__.getCenter(this,hs.createVector3());this._transform[12]=o[0],this._transform[13]=o[1],this._transform[14]=o[2]}var s=new c_(this._glenv,r.mesh,i,this._transform);return s.properties=a,{entity:r.producer.entity,primitive:s}}},{key:"num_entities",get:function(){return this._edata_list.length}}]),e}();Le({target:"Array",proto:!0},{fill:zi}),Qr("fill"),Ha("Uint8",(function(e){return function(t,r,n){return e(this,t,r,n)}}));var d_=function(){function e(){Ge(this,e),this._area_list=[],this._flat_area_list=null}return qe(e,[{key:"isEmpty",value:function(){return 0==this._area_list.length}},{key:"clear",value:function(){this._area_list.length=0,this._flat_area_list=null}},{key:"addTileArea",value:function(e){this._area_list.push({z:e.z,x:e.x,y:e.y}),this._flat_area_list=null}},{key:"getFlatAreaList",value:function(){return null===this._flat_area_list&&(this._flat_area_list=this._createFlatAreaList()),this._flat_area_list}},{key:"_createFlatAreaList",value:function(){for(var e=new v_,t=0;t<this._area_list.length;++t){var r=this._area_list[t];e.addDescendant(r.z,r.x,r.y)}return e.reduceTree(),e.collectFlatAreas(0,new Uint8Array(64),[])}}]),e}(),v_=function(){function e(){Ge(this,e),this.present=!1,this.children=new Array(4).fill(null)}return qe(e,[{key:"addDescendant",value:function(t,r,n){if(!0!==this.present)if(0==t)this.present=!0,this.children.fill(null);else{var i=Math.round(Math.pow(2,t-1)),a=Math.floor(r/i)+2*Math.floor(n/i);null===this.children[a]&&(this.children[a]=new e),this.children[a].addDescendant(t-1,r%i,n%i)}}},{key:"reduceTree",value:function(){if(!0===this.present)return 1;for(var e=0,t=0;t<4;++t){var r=this.children[t];null!==r&&(e+=r.reduceTree())}return 4==e?(this.present=!0,this.children.fill(null),1):0}},{key:"collectFlatAreas",value:function(e,t,r){if(!0===this.present)r.push(new Uint8Array(t.slice(0,e)));else for(var n=0;n<4;++n){var i=this.children[n];null!==i&&(t[e]=n,i.collectFlatAreas(e+1,t,r))}return r}}]),e}();Le({target:"Array",stat:!0},{isArray:zt});var p_=va.ArrayBuffer,y_=n.ArrayBuffer;Le({global:!0,forced:y_!==p_},{ArrayBuffer:p_}),mi("ArrayBuffer"),Ha("Uint16",(function(e){return function(t,r,n){return e(this,t,r,n)}})),Ha("Uint32",(function(e){return function(t,r,n){return e(this,t,r,n)}}));var g_=function(){function e(t,r,n){Ge(this,e),this._glenv=t;var i=n||{},a=t.context,o=e._getBindingPoint(a,i.target),s=a.createBuffer();a.bindBuffer(o,s),a.bufferData(o,r,a.STATIC_DRAW),a.bindBuffer(o,null),this._handle=s}return qe(e,[{key:"dispose",value:function(){this._glenv.context.deleteBuffer(this._handle),this._handle=null}},{key:"handle",get:function(){return this._handle}}],[{key:"_getBindingPoint",value:function(e,t){switch(t){default:case m_.ATTRIBUTE:return e.ARRAY_BUFFER;case m_.INDEX:return e.ELEMENT_ARRAY_BUFFER}}}]),e}(),m_={ATTRIBUTE:{id:"ATTRIBUTE"},INDEX:{id:"INDEX"}};g_.Target=m_;var k_=function(){function e(t,r){Ge(this,e),this._glenv=t,this._draw_mode=void 0,this._num_vertices=0,this._attrib_data={},this._index_data=null,r instanceof E_?this._initByInitializer(r):r instanceof ArrayBuffer?this._initByInitializer(new T_(t,r).initializer):this._initByInitializer(new x_(t,r).initializer)}return qe(e,[{key:"_initByInitializer",value:function(e){this._draw_mode=this._convertDrawMode(e.draw_mode),this._num_vertices=e.num_vertices;for(var t=e.attribute_data,r=0;r<t.length;++r){var n=t[r];this._attrib_data[n.id]={mesh_buffer:n.buffer,buffer:n.buffer.handle,num_components:n.num_components,component_type:this._convertComponentType(n.component_type),normalized:n.normalized,byte_stride:n.byte_stride,byte_offset:n.byte_offset}}if(e.index_data){var i=e.index_data;this._index_data={mesh_buffer:i.buffer,buffer:i.buffer.handle,num_indices:i.num_indices,type:this._convertComponentType(i.type),byte_offset:i.byte_offset}}}},{key:"_convertDrawMode",value:function(e){var t=this._glenv.context;switch(e){case w_.POINTS:return t.POINTS;case w_.LINES:return t.LINES;case w_.TRIANGLES:return t.TRIANGLES;case w_.LINE_LOOP:return t.LINE_LOOP;case w_.LINE_STRIP:return t.LINE_STRIP;case w_.TRIANGLE_STRIP:return t.TRIANGLE_STRIP;case w_.TRIANGLE_FAN:return t.TRIANGLE_FAN;default:throw new Error("mapray: invalid Mesh.DrawMode: "+e)}}},{key:"_convertComponentType",value:function(e){var t=this._glenv.context;switch(e){case b_.BYTE:return t.BYTE;case b_.UNSIGNED_BYTE:return t.UNSIGNED_BYTE;case b_.SHORT:return t.SHORT;case b_.UNSIGNED_SHORT:return t.UNSIGNED_SHORT;case b_.UNSIGNED_INT:return t.UNSIGNED_INT;case b_.FLOAT:return t.FLOAT;default:throw new Error("mapray: invalid Mesh.ComponentType: "+e)}}},{key:"dispose",value:function(){this._attrib_data={},this._index_data=null}},{key:"draw",value:function(e){var t=this._glenv.context;e.bindVertexAttribs(this._attrib_data);var r=this._index_data;null!==r?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,r.buffer),t.drawElements(this._draw_mode,r.num_indices,r.type,r.byte_offset)):t.drawArrays(this._draw_mode,0,this._num_vertices)}}]),e}(),E_=function(){function e(t,r){Ge(this,e),this.draw_mode=t,this.num_vertices=r,this.index_data=null,this.attribute_data=[]}return qe(e,[{key:"addIndex",value:function(e,t,r,n){var i=n||{};this.index_data={buffer:e,num_indices:t,type:r,byte_offset:void 0!==i.byte_offset?i.byte_offset:0}}},{key:"addAttribute",value:function(e,t,r,n,i){var a=i||{},o={id:e,buffer:t,num_components:r,component_type:n,normalized:void 0!==a.normalized&&a.normalized,byte_stride:void 0!==a.byte_stride?a.byte_stride:0,byte_offset:void 0!==a.byte_offset?a.byte_offset:0};this.attribute_data.push(o)}}]),e}(),w_={POINTS:{id:"POINTS"},LINES:{id:"LINES"},TRIANGLES:{id:"TRIANGLES"},LINE_LOOP:{id:"LINE_LOOP"},LINE_STRIP:{id:"LINE_STRIP"},TRIANGLE_STRIP:{id:"TRIANGLE_STRIP"},TRIANGLE_FAN:{id:"TRIANGLE_FAN"}},b_={BYTE:{id:"BYTE"},UNSIGNED_BYTE:{id:"UNSIGNED_BYTE"},SHORT:{id:"SHORT"},UNSIGNED_SHORT:{id:"UNSIGNED_SHORT"},UNSIGNED_INT:{id:"UNSIGNED_INT"},FLOAT:{id:"FLOAT"}},x_=function(){function e(t,r){Ge(this,e);var n=A_.createVertexInfo(r.vtype),i=A_.numVertexComponents(n),a=r.vertices.length/i;this._initializer=new E_(e._toDrawMode(r),a),this._addIndex(t,r.indices,a);for(var o=new g_(t,A_.toTypedArray(r.vertices,b_.FLOAT)),s=4*i,u=0,_=0;_<n.length;++_){var l=n[_].size;this._initializer.addAttribute(n[_].name,o,l,b_.FLOAT,{byte_stride:s,byte_offset:u}),u+=4*l}}return qe(e,[{key:"_addIndex",value:function(e,t,r){var n=r<65536?b_.UNSIGNED_SHORT:b_.UNSIGNED_INT,i=new g_(e,A_.toTypedArray(t,n),{target:g_.Target.INDEX});this._initializer.addIndex(i,t.length,n)}},{key:"initializer",get:function(){return this._initializer}}],[{key:"_toDrawMode",value:function(e){switch(e.ptype){case"triangles":return w_.TRIANGLES;case"lines":return w_.LINES;default:return w_.TRIANGLES}}}]),e}(),T_=function(){function e(t,r){Ge(this,e);var n=new DataView(r,0),i=n.getUint8(e.OFFSET_VTYPE),a=n.getUint8(e.OFFSET_ITYPE),o=n.getUint8(e.OFFSET_PTYPE),s=n.getUint32(e.OFFSET_NUM_VERTICES,!0),u=n.getUint32(e.OFFSET_NUM_INDICES,!0);this._initializer=new E_(e._toDrawMode(o),s);var _=A_.createVertexInfo(i),l=this._createIndexArray(t,r,a,u,_,s);this._addIndex(t,a,l);for(var c=new g_(t,this._createVertexArray(r,_,s)),h=4*A_.numVertexComponents(_),f=0,d=0;d<_.length;++d){var v=_[d].size;this._initializer.addAttribute(_[d].name,c,v,b_.FLOAT,{byte_stride:h,byte_offset:f}),f+=4*v}}return qe(e,[{key:"_createIndexArray",value:function(t,r,n,i,a,o){var s,u,_,l=A_.numVertexComponents(a)*o*4,c=new DataView(r,e.OFFSET_BODY+l);switch(n){case e.ENUM_ITYPE_UINT16:for(u=new Uint16Array(i),_=2,s=0;s<i;++s)u[s]=c.getUint16(_*s,!0);break;case e.ENUM_ITYPE_UINT32:for(u=new Uint32Array(i),_=4,s=0;s<i;++s)u[s]=c.getUint32(_*s,!0);break;default:throw new Error("mapray: unknown itype: "+n)}return u}},{key:"_createVertexArray",value:function(t,r,n){for(var i=A_.numVertexComponents(r)*n,a=new DataView(t,e.OFFSET_BODY),o=new Float32Array(i),s=0;s<i;++s)o[s]=a.getFloat32(4*s,!0);return o}},{key:"_addIndex",value:function(t,r,n){var i=new g_(t,n,{target:g_.Target.INDEX}),a=e._indexTypeToComponentType(r);this._initializer.addIndex(i,n.length,a)}},{key:"initializer",get:function(){return this._initializer}}],[{key:"_toDrawMode",value:function(t){switch(t){case e.ENUM_PTYPE_TRIANGLES:return w_.TRIANGLES;case e.ENUM_PTYPE_LINES:return w_.LINES;default:throw new Error("mapray: invalid ptype: "+t)}}},{key:"_indexTypeToComponentType",value:function(t){switch(t){case e.ENUM_ITYPE_UINT16:return b_.UNSIGNED_SHORT;case e.ENUM_ITYPE_UINT32:default:return b_.UNSIGNED_INT}}}]),e}();T_.OFFSET_VTYPE=0,T_.OFFSET_ITYPE=1,T_.OFFSET_PTYPE=2,T_.OFFSET_NUM_VERTICES=4,T_.OFFSET_NUM_INDICES=8,T_.OFFSET_BODY=12,T_.ENUM_ITYPE_UINT16=0,T_.ENUM_ITYPE_UINT32=1,T_.ENUM_PTYPE_TRIANGLES=0,T_.ENUM_PTYPE_LINES=1;var A_=function(){function e(){Ge(this,e)}return qe(e,null,[{key:"createVertexInfo",value:function(t){if(Array.isArray(t))return t;var r=null;switch(t){case"P":case e.ENUM_VTYPE_P:r=[{name:e.ANAME_P,size:e.FSIZE_P}];break;case"PN":case e.ENUM_VTYPE_PN:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_N,size:e.FSIZE_N}];break;case"PT":case e.ENUM_VTYPE_PT:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_T,size:e.FSIZE_T}];break;case"PNT":case e.ENUM_VTYPE_PNT:r=[{name:e.ANAME_P,size:e.FSIZE_P},{name:e.ANAME_N,size:e.FSIZE_N},{name:e.ANAME_T,size:e.FSIZE_T}];break;default:throw new Error("mapray: unknown vtype: "+t)}return r}},{key:"numVertexComponents",value:function(e){for(var t=e.length,r=0,n=0;n<t;++n)r+=e[n].size;return r}},{key:"toTypedArray",value:function(e,t){switch(t){case b_.UNSIGNED_SHORT:return e instanceof Uint16Array?e:new Uint16Array(e);case b_.UNSIGNED_INT:return e instanceof Uint32Array?e:new Uint32Array(e);case b_.FLOAT:return e instanceof Float32Array?e:new Float32Array(e);default:throw new Error("mapray: invalid component type: "+t)}}}]),e}();A_.ENUM_VTYPE_P=0,A_.ENUM_VTYPE_PN=1,A_.ENUM_VTYPE_PT=2,A_.ENUM_VTYPE_PNT=3,A_.ANAME_P="a_position",A_.ANAME_N="a_normal",A_.ANAME_T="a_texcoord",A_.FSIZE_P=3,A_.FSIZE_N=3,A_.FSIZE_T=2,k_.Initializer=E_,k_.DrawMode=w_,k_.ComponentType=b_;var R_={ABSOLUTE:{id:"ABSOLUTE"},RELATIVE:{id:"RELATIVE"},CLAMP:{id:"CLAMP"}},I_=function(){function e(t,r){Ge(this,e),this.scene=t,this._altitude_mode=R_.ABSOLUTE,this._need_to_create_regions=!1,this._animation=new Zs,this._visibility=!0,r&&r.json&&this._setupEntityByJson(r.json)}return qe(e,[{key:"setVisibility",value:function(e){this._visibility=e}},{key:"onChangeAltitudeMode",value:function(e){}},{key:"getPrimitiveProducer",value:function(){return null}},{key:"getFlakePrimitiveProducer",value:function(){return null}},{key:"_setupEntityByJson",value:function(e){if(e.altitude_mode)switch(e.altitude_mode){case"absolute":this._altitude_mode=R_.ABSOLUTE;break;case"relative":this._altitude_mode=R_.RELATIVE;break;case"clamp":this._altitude_mode=R_.CLAMP;break;default:console.error("unrecognized altitude_mode: "+e.altitude_mode)}void 0!==e.visibility&&this.setVisibility(e.visibility)}},{key:"visibility",get:function(){return this._visibility}},{key:"anchor_mode",get:function(){return!1}},{key:"animation",get:function(){return this._animation}},{key:"altitude_mode",set:function(e){if(this._altitude_mode!==e){var t=this._altitude_mode;this._altitude_mode=e,this.onChangeAltitudeMode(t)}},get:function(){return this._altitude_mode}}]),e}(),P_=function(){function e(t){Ge(this,e),this._entity=t,this._need_to_create_regions=!1}return qe(e,[{key:"needToCreateRegions",value:function(){this._need_to_create_regions=!0}},{key:"checkToCreateRegions",value:function(){var e=this._need_to_create_regions;return this._need_to_create_regions=!1,e}},{key:"needsElevation",value:function(){return this._entity._altitude_mode!==R_.ABSOLUTE}},{key:"createRegions",value:function(){return[]}},{key:"onChangeElevation",value:function(e){}},{key:"getPrimitives",value:function(e){throw new Error("mapray.Entity.PrimitiveProducer#getPrimitives() method has not been overridden.")}},{key:"entity",get:function(){return this._entity}}]),e}(),S_=function(){function e(t){Ge(this,e),this._entity=t,this._updated=!1}return qe(e,[{key:"notifyForUpdate",value:function(){this._updated=!0}},{key:"getAreaStatus",value:function(e){return M_.EMPTY}},{key:"createMesh",value:function(e,t,r){return null}},{key:"getMaterialAndProperties",value:function(e){throw new Error("mapray.Entity.FlakePrimitiveProducer#getMaterialAndProperties() method has not been overridden.")}},{key:"checkForUpdate",value:function(){var e=this._updated;return this._updated=!1,e}},{key:"entity",get:function(){return this._entity}}]),e}(),M_={EMPTY:{id:"EMPTY"},FULL:{id:"FULL"},PARTIAL:{id:"PARTIAL"}};I_.PrimitiveProducer=P_,I_.FlakePrimitiveProducer=S_,I_.AreaStatus=M_;var L_=function(){function e(t,r){Ge(this,e),this._glenv=t,this._dem_provider=r,this._status=D_.NOT_READY,this._dem_area_updated=new d_,this._prev_producers=new Set,this._ρ=r.getResolutionPower(),this._dem_zbias=hs.LOG2PI-this._ρ+1,this._hist_stats=new F_,this._flake_reduce_thresh=1.5,this._flake_reduce_factor=1.2,this._num_cache_flakes=0,this._num_touch_flakes=0,this._mesh_reduce_lower=300,this._mesh_reduce_thresh=1.5,this._mesh_reduce_factor=1.2,this._num_cache_meshes=0,this._num_touch_meshes=0,this._max_dem_requesteds=10,this._num_dem_requesteds=0,this._frame_counter=0,this._root_flake=null,this._avg_height=null,this._root_cancel_id=null,this._requestRoot()}return qe(e,[{key:"cancel",value:function(){if(this._status===D_.READY)for(var e=this._root_flake._children,t=0;t<4;++t)e[t].dispose();else this._status===D_.NOT_READY&&(this._dem_provider.cancelRequest(this._root_cancel_id),this._root_cancel_id=null)}},{key:"putNextEntityProducers",value:function(e){var t=new Set,r=[],n=[],i=!0,a=!1,o=void 0;try{for(var s,u=e[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value,l=_.checkForUpdate();this._prev_producers.has(_)?(l&&n.push(_),this._prev_producers.delete(_)):r.push(_),t.add(_)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}var c=this._prev_producers,h=!0,f=!1,d=void 0;try{for(var v,p=c[Symbol.iterator]();!(h=(v=p.next()).done);h=!0){var y=v.value;this._root_flake.removeEntityProducer(y)}}catch(e){f=!0,d=e}finally{try{h||null==p.return||p.return()}finally{if(f)throw d}}for(var g=0,m=r;g<m.length;g++){var k=m[g];this._root_flake.addEntityProducer(k)}for(var E=0,w=n;E<w.length;E++){var b=w[E];this._root_flake.updateEntityProducer(b)}this._prev_producers=t}},{key:"getNumDemWaitingRequests",value:function(){return this._num_dem_requesteds}},{key:"findHighestAccuracy",value:function(e,t){var r=this._root_flake;if(null===r)return null;for(var n=2,i=n*e,a=n*t,o=r;;){var s=hs.clamp(Math.floor(i),0,n-1)%2,u=hs.clamp(Math.floor(a),0,n-1)%2,_=r._children[s+2*u];if(r.touch(),null===_)break;r._dem_state===O_.LOADED&&(o=r),r=_,n*=2,i*=2,a*=2}return o._requestHighestAccuracy(e,t),o._dem_data}},{key:"getExistingElevations",value:function(e,t,r,n,i,a,o){for(var s=2*Math.PI,u=1<<this._ρ,_=r,l=a,c=0;c<e;++c){var h=t[_],f=t[_+1],d=h+180*Math.floor((90-f)/360+Math.floor((90+f)/360)),v=d-360-360*Math.floor((d-180)/360),p=90-Math.abs(90-f+360*Math.floor((90+f)/360)),y=v*hs.DEGREE/s+.5,g=.5-hs.invGudermannian(p*hs.DEGREE)/s;if(g>=0&&g<=1){var m=this._findHighestAccuracy2(y,g);if(null!==m){var k=Math.pow(2,m.z),E=u*(k*y-m.x),w=u*(k*g-m.y),b=hs.clamp(Math.floor(E),0,u-1),x=hs.clamp(Math.floor(w),0,u-1),T=m.getHeights(b,x),A=T[0],R=T[1],I=T[2],P=T[3],S=E-b,M=w-x;i[l]=(A*(1-S)+R*S)*(1-M)+(I*(1-S)+P*S)*M}else i[l]=0}else i[l]=0;_+=n,l+=o}return i}},{key:"_findHighestAccuracy2",value:function(e,t){var r=this._root_flake;if(null===r)return null;for(var n=2,i=n*e,a=n*t,o=r;;){var s=hs.clamp(Math.floor(i),0,n-1)%2,u=hs.clamp(Math.floor(a),0,n-1)%2,_=r._children[s+2*u];if(null===_)break;r._dem_state===O_.LOADED&&(o=r),r=_,n*=2,i*=2,a*=2}return o._dem_data}},{key:"endFrame",value:function(){var e=this._hist_stats.getMaxValue(this._num_touch_flakes);this._num_cache_flakes>this._flake_reduce_thresh*e&&this._reduceFlakes(e),this._num_cache_meshes>this._mesh_reduce_lower&&this._num_cache_meshes>this._mesh_reduce_thresh*this._num_touch_meshes&&this._reduceMeshes(),this._dem_area_updated.clear(),this._num_touch_flakes=0,this._num_touch_meshes=0,++this._frame_counter}},{key:"_requestRoot",value:function(){var e=this;this._root_cancel_id=this._dem_provider.requestTile(0,0,0,(function(t){if(t){var r=new u_(0,0,0,e._ρ,t);e._avg_height=r.newAvgHeightMaps(),e._root_flake=new C_(null,0,0,0),e._root_flake.setupRoot(e,r),e._status=D_.READY,e._dem_area_updated.addTileArea(r)}else e._status=D_.FAILED;e._root_cancel_id=null,--e._num_dem_requesteds})),++this._num_dem_requesteds}},{key:"_reduceFlakes",value:function(e){var t=this._root_flake.flattenFlakes();t.sort((function(e,t){return e.compareForReduce(t)}));var r=Math.floor(this._flake_reduce_factor*e);t.slice(r).forEach((function(e){return e.dispose()}))}},{key:"_reduceMeshes",value:function(){var e=this._root_flake.flattenMeshes();e.sort((function(e,t){return e.compareForReduce(t)}));var t=Math.floor(this._mesh_reduce_factor*this._num_touch_meshes);e.slice(t).forEach((function(e){return e.dispose()}))}},{key:"glenv",get:function(){return this._glenv}},{key:"dem_provider",get:function(){return this._dem_provider}},{key:"status",get:function(){return this._status}},{key:"dem_area_updated",get:function(){return this._dem_area_updated}},{key:"root_flake",get:function(){var e=this._root_flake;return e.touch(),e}}]),e}(),D_={NOT_READY:{id:"NOT_READY"},READY:{id:"READY"},FAILED:{id:"FAILED"}};L_.Status=D_;var C_=function(){function e(t,r,n,i){Ge(this,e),this.z=r,this.x=n,this.y=i,this._parent=t,this._children=[null,null,null,null],this._globe=null!==t?t._globe:null,this._dem_data=null,this._dem_state=O_.NONE,this._entity_map=null,this._meshes=[],this._prev_Za_dem=null,this._prev_Zr_dem=null,this._base_height=0,this._height_min=0,this._height_max=0,this._dem_zlimit=0,this._gocs_x_min=0,this._gocs_x_max=0,this._gocs_y_min=0,this._gocs_y_max=0,this._gocs_z_min=0,this._gocs_z_max=0,this._aframe=-1,null!==this._globe&&(this._globe._num_cache_flakes+=1)}return qe(e,[{key:"setupRoot",value:function(e,t){this._globe=e,this._dem_data=t,this._dem_state=O_.LOADED,this._entity_map=new Map,this._estimate(),e._num_cache_flakes+=1}},{key:"newChild",value:function(t,r){var n=t+2*r,i=this._children[n];return null===i&&(i=new e(this,this.z+1,2*this.x+t,2*this.y+r),this._children[n]=i),i._estimate(),i.touch(),i}},{key:"isInvisible",value:function(e){switch(this.z){case 0:return this._isInvisible_0(e);default:return this._isInvisible_N(e)}}},{key:"getRenderObject",value:function(t){var r,n=Math.pow(2,-t)*e.ε;r=n<=2?Math.max(Math.ceil(hs.LOG2PI-this.z-Math.maprayLog2(Math.acos(1-n))),0):0;var i,a=this._getCosφ();i=n*a<=2?Math.max(Math.ceil(hs.LOG2PI-this.z+Math.maprayLog2(a/Math.acos(1-n*a))),0):0;var o=this._getMeshNode(t,r,i);return o.touch(),o.getRenderObject()}},{key:"getEntityProducers",value:function(){return this._getEntityMap().keys()}},{key:"addEntityProducer",value:function(e){switch(e.getAreaStatus(this)){case I_.AreaStatus.PARTIAL:this._entity_map.set(e,!1);var t=!0,r=!1,n=void 0;try{for(var i,a=this._children[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;null!==o&&null!==o._entity_map&&o.addEntityProducer(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}break;case I_.AreaStatus.FULL:this._addEntityFullProducer(e)}}},{key:"_addEntityFullProducer",value:function(e){this._entity_map.set(e,!0);var t=!0,r=!1,n=void 0;try{for(var i,a=this._children[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;null!==o&&null!==o._entity_map&&o._addEntityFullProducer(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"removeEntityProducer",value:function(e){if(this._entity_map.has(e)){this._entity_map.delete(e),this._removeEntityMeshes(e);var t=!0,r=!1,n=void 0;try{for(var i,a=this._children[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;null!==o&&null!==o._entity_map&&o.removeEntityProducer(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}}},{key:"updateEntityProducer",value:function(e){this.removeEntityProducer(e),this.addEntityProducer(e)}},{key:"findRayDistance",value:function(e,t){var r;for(r=this;r._dem_state!==O_.LOADED;r=r._parent);if(this.z-r.z===this._globe._ρ)return this._findQuadRayDistance(e,t,r);if(this._cullForRayDistance(e,t))return t;for(var n=t,i=0;i<2;++i)for(var a=0;a<2;++a)n=this.newChild(a,i).findRayDistance(e,n);return n}},{key:"dispose",value:function(){var e,t=this._parent;if(null!==t){for(var r=this._globe,n=this._meshes;n.length>0;)n[0].dispose();var i=this._children;for(e=0;e<4;++e){var a=i[e];null!==a&&a.dispose()}var o=t._children;for(e=0;e<4;++e)if(o[e]===this){o[e]=null;break}this._parent=null,this._dem_state===O_.REQUESTED&&(r._dem_provider.cancelRequest(this._dem_data),--r._num_dem_requesteds),r._num_cache_flakes-=1}}},{key:"flattenFlakes",value:function(){var e=[];return this._flattenFlakes(e),e}},{key:"flattenMeshes",value:function(){var e=[];return this._flattenMeshes(e),e}},{key:"compareForReduce",value:function(e){var t=e,r=t._aframe-this._aframe;return 0!==r?r:this.z-t.z}},{key:"_flattenFlakes",value:function(e){e.push(this);for(var t=this._children,r=0;r<4;++r){var n=t[r];null!==n&&n._flattenFlakes(e)}}},{key:"_flattenMeshes",value:function(e){Array.prototype.push.apply(e,this._meshes);for(var t=this._children,r=0;r<4;++r){var n=t[r];null!==n&&n._flattenMeshes(e)}}},{key:"touch",value:function(){var e=this._globe;this._aframe!==e._frame_counter&&(this._aframe=e._frame_counter,e._num_touch_flakes+=1)}},{key:"_getMeshNode",value:function(e,t,r){for(var n=this._getMeshDemBinary(e),i=n.getDivisionPowers(this,e,t,r),a=this._meshes,o=a.length,s=0;s<o;++s){var u=a[s];if(u.match(n,i))return u}var _=new N_(this,n,i);return a.unshift(_),_}},{key:"_getMeshDemBinary",value:function(e){var t=hs.clamp(Math.round(e+this._globe._dem_zbias),0,this._dem_zlimit),r=this._findNearestDemTile(t);if(r.z<t){var n=r.getQuadLevel(this.z,this.x,this.y);n>0&&this._requestAncestorDemTile(Math.min(r.z+n,t))}return r}},{key:"_findNearestDemTile",value:function(e){for(var t=this,r=this.z-e,n=0;n<r;++n)t=t._parent;for(;t._dem_state!==O_.LOADED;)t=t._parent;return t._dem_data}},{key:"_requestAncestorDemTile",value:function(e){var t=this._globe;if(!(t._num_dem_requesteds>=t._max_dem_requesteds)){for(var r=this,n=this.z-e,i=0;i<n;++i)r=r._parent;for(;;){var a=r._dem_state;if(a===O_.LOADED||a===O_.REQUESTED)break;if(a!==O_.FAILED){var o=t._dem_provider;r._dem_data=o.requestTile(r.z,r.x,r.y,(function(e){null!==r._parent&&(e?(r._dem_data=new u_(r.z,r.x,r.y,t._ρ,e),r._dem_state=O_.LOADED,t._dem_area_updated.addTileArea(r)):(r._dem_data=null,r._dem_state=O_.FAILED),--t._num_dem_requesteds)})),r._dem_state=O_.REQUESTED,++t._num_dem_requesteds;break}r=r._parent}}}},{key:"_isInvisible_0",value:function(e){for(var t=hs.EARTH_RADIUS+this._height_max,r=0;r<e.length;++r){if(e[r][3]<-t)return!0}return!1}},{key:"_isInvisible_N",value:function(e){for(var t=this._gocs_x_min,r=this._gocs_x_max,n=this._gocs_y_min,i=this._gocs_y_max,a=this._gocs_z_min,o=this._gocs_z_max,s=0;s<e.length;++s){var u=e[s],_=u[0],l=u[1],c=u[2],h=u[3],f=_*t+l*n,d=_*r+l*n,v=_*t+l*i,p=_*r+l*i,y=-c*a-h,g=-c*o-h;if(f<y&&d<y&&v<y&&p<y&&f<g&&d<g&&v<g&&p<g)return!0}return!1}},{key:"_getCosφ",value:function(){var e=this.z;if(e>0){var t=this.y,r=Math.pow(2,1-e),n=Math.abs(1-r*t),i=Math.abs(1-r*(t+1)),a=Math.exp(Math.PI*Math.min(n,i));return 2*a/(a*a+1)}return 1}},{key:"_estimate",value:function(){if(this._prev_Za_dem!==this){var e,t=this.z,r=this._globe._ρ;if(t<r){if((e=this._findNearestDemTile(t))===this._prev_Zr_dem)return;this._prev_Zr_dem=e,this._estimate_low(e),this._dem_zlimit=t}else{var n=this._findNearestDemTile(t-r);if(n.isLeaf(t,this.x,this.y))this._estimate_leaf(n);else{if(e=this._findNearestDemTile(n.z+r),n===this._prev_Za_dem&&e===this._prev_Zr_dem)return;this._prev_Za_dem=n,this._prev_Zr_dem=e,this._estimate_high(n,e)}this._dem_zlimit=n.z+r}switch(t){case 0:this._updataBoundingBox_0();break;case 1:this._updataBoundingBox_1();break;default:this._updataBoundingBox_N()}}}},{key:"_estimate_low",value:function(t){var r=this.z,n=this.x,i=this.y,a=this._calcAlpha();this._base_height=this._globe._avg_height.sample(r,n,i),this._height_min=Math.max(this._base_height+a*e.Fm,t.height_min),this._height_max=Math.min(this._base_height+a*e.Fp,t.height_max),(t.z==r||t.isLeaf(r,n,i))&&(this._prev_Za_dem=this)}},{key:"_estimate_high",value:function(t,r){var n=this._globe,i=this.z,a=this.x,o=this.y,s=t.z,u=t.x,_=t.y,l=n._ρ,c=Math.pow(2,s-i),h=1<<l,f=Math.floor(h*((a+.5)*c-u)),d=Math.floor(h*((o+.5)*c-_)),v=h*(a*c-u)-f,p=h*((a+1)*c-u)-f,y=h*(o*c-_)-d,g=h*((o+1)*c-_)-d,m=t.getHeights(f,d),k=m[0],E=m[1],w=m[2],b=m[3],x=(k*(1-v)+E*v)*(1-y)+(w*(1-v)+b*v)*y,T=(k*(1-p)+E*p)*(1-y)+(w*(1-p)+b*p)*y,A=(k*(1-v)+E*v)*(1-g)+(w*(1-v)+b*v)*g,R=(k*(1-p)+E*p)*(1-g)+(w*(1-p)+b*p)*g,I=this._calcAlpha();if(this._base_height=.25*(x+T+A+R),this._height_min=Math.max(this._base_height+I*e.Fm,r.height_min),this._height_max=Math.min(this._base_height+I*e.Fp,r.height_max),s<i-l){var P=t.getQuadLevel(i,a,o);this._requestAncestorDemTile(Math.min(s+P,i-l))}else(r.z==i||r.isLeaf(i,a,o))&&(this._prev_Za_dem=this)}},{key:"_estimate_leaf",value:function(e){var t=this.z,r=this.x,n=this.y,i=e.z,a=e.x,o=e.y,s=Math.pow(2,i-t),u=1<<this._globe._ρ,_=Math.floor(u*((r+.5)*s-a)),l=Math.floor(u*((n+.5)*s-o)),c=u*(r*s-a)-_,h=u*((r+1)*s-a)-_,f=u*(n*s-o)-l,d=u*((n+1)*s-o)-l,v=e.getHeights(_,l),p=v[0],y=v[1],g=v[2],m=v[3],k=(p*(1-c)+y*c)*(1-f)+(g*(1-c)+m*c)*f,E=(p*(1-h)+y*h)*(1-f)+(g*(1-h)+m*h)*f,w=(p*(1-c)+y*c)*(1-d)+(g*(1-c)+m*c)*d,b=(p*(1-h)+y*h)*(1-d)+(g*(1-h)+m*h)*d;this._base_height=.25*(k+E+w+b),this._height_min=Math.min(k,E,w,b),this._height_max=Math.max(k,E,w,b),this._prev_Za_dem=this}},{key:"_calcAlpha",value:function(){var t=Math.pow(2,1-this.z);return t*e.πr/Math.cosh((1-t*(this.y+.5))*Math.PI)}},{key:"_updataBoundingBox_0",value:function(){var e=hs.EARTH_RADIUS+this._height_max;this._gocs_x_min=-e,this._gocs_x_max=e,this._gocs_y_min=-e,this._gocs_y_max=e,this._gocs_z_min=-e,this._gocs_z_max=e}},{key:"_updataBoundingBox_1",value:function(){var e=hs.EARTH_RADIUS+this._height_max,t=this.x,r=this.y;this._gocs_x_min=-e,this._gocs_x_max=e,this._gocs_y_min=e*(t-1),this._gocs_y_max=e*t,this._gocs_z_min=-e*r,this._gocs_z_max=e*(1-r)}},{key:"_updataBoundingBox_N",value:function(){var e=Math.PI,t=this.z,r=this.x,n=this.y,i=Math.pow(2,1-t)*e,a=e-(n+1)*i,o=e-n*i,s=r*i-e,u=(r+1)*i-e,_=Math.exp(a),l=Math.exp(o),c=_*_,h=l*l,f=hs.EARTH_RADIUS+this._height_min,d=hs.EARTH_RADIUS+this._height_max,v=2*_/(c+1),p=2*l/(h+1);a+o<0?(s+u<-e?(this._gocs_x_min=d*p*Math.cos(s),this._gocs_x_max=f*v*Math.cos(u),this._gocs_y_min=d*p*Math.sin(u),this._gocs_y_max=f*v*Math.sin(s)):s+u<0?(this._gocs_x_min=f*v*Math.cos(s),this._gocs_x_max=d*p*Math.cos(u),this._gocs_y_min=d*p*Math.sin(s),this._gocs_y_max=f*v*Math.sin(u)):s+u<e?(this._gocs_x_min=f*v*Math.cos(u),this._gocs_x_max=d*p*Math.cos(s),this._gocs_y_min=f*v*Math.sin(s),this._gocs_y_max=d*p*Math.sin(u)):(this._gocs_x_min=d*p*Math.cos(u),this._gocs_x_max=f*v*Math.cos(s),this._gocs_y_min=f*v*Math.sin(u),this._gocs_y_max=d*p*Math.sin(s)),this._gocs_z_min=d*(c-1)/(c+1),this._gocs_z_max=f*(h-1)/(h+1)):(s+u<-e?(this._gocs_x_min=d*v*Math.cos(s),this._gocs_x_max=f*p*Math.cos(u),this._gocs_y_min=d*v*Math.sin(u),this._gocs_y_max=f*p*Math.sin(s)):s+u<0?(this._gocs_x_min=f*p*Math.cos(s),this._gocs_x_max=d*v*Math.cos(u),this._gocs_y_min=d*v*Math.sin(s),this._gocs_y_max=f*p*Math.sin(u)):s+u<e?(this._gocs_x_min=f*p*Math.cos(u),this._gocs_x_max=d*v*Math.cos(s),this._gocs_y_min=f*p*Math.sin(s),this._gocs_y_max=d*v*Math.sin(u)):(this._gocs_x_min=d*v*Math.cos(u),this._gocs_x_max=f*p*Math.cos(s),this._gocs_y_min=f*p*Math.sin(u),this._gocs_y_max=d*v*Math.sin(s)),this._gocs_z_min=f*(c-1)/(c+1),this._gocs_z_max=d*(h-1)/(h+1))}},{key:"_requestHighestAccuracy",value:function(e,t){var r=this._dem_data.getQuadLevelDirect(e,t);if(0!=r){for(var n=this,i=Math.round(Math.pow(2,this.z+1)),a=i*e,o=i*t,s=0;s<r;++s){var u=hs.clamp(Math.floor(a),0,i-1)%2,_=hs.clamp(Math.floor(o),0,i-1)%2;n=n.newChild(u,_),i*=2,a*=2,o*=2}n._requestAncestorDemTile(n.z)}}},{key:"_findQuadRayDistance",value:function(t,r,n){var i=this._getQuadPositions(n,e._temp_positions),a=e._findTriRayDistance(t,r,i[0],i[2],i[1]);return a===r?e._findTriRayDistance(t,r,i[1],i[2],i[3]):a}},{key:"_getQuadPositions",value:function(e,t){for(var r=this.x,n=this.y,i=e.x,a=e.y,o=1<<this._globe._ρ,s=e._dem_data.getHeights(r-o*i,n-o*a),u=Math.pow(2,1-this.z)*Math.PI,_=r*u-Math.PI,l=0,c=Math.PI-n*u;l<2;++l,c-=u)for(var h=Math.exp(c),f=h*h,d=(f-1)/(f+1),v=2*h/(f+1),p=0,y=_;p<2;++p,y+=u){var g=p+2*l,m=hs.EARTH_RADIUS+s[g],k=Math.sin(y),E=Math.cos(y),w=t[g];w[0]=m*v*E,w[1]=m*v*k,w[2]=m*d}return t}},{key:"_cullForRayDistance",value:function(e,t){var r=e.position,n=r[0],i=r[1],a=r[2],o=this._gocs_x_min,s=this._gocs_x_max,u=this._gocs_y_min,_=this._gocs_y_max,l=this._gocs_z_min,c=this._gocs_z_max;if(o<=n&&n<=s&&u<=i&&i<=_&&l<=a&&a<=c)return!1;var h,f,d,v,p=e.direction,y=p[0],g=p[1],m=p[2];if(n<o&&y>0){if((h=(o-n)/y)<t&&(v=a+h*m,u<=(d=i+h*g)&&d<=_&&l<=v&&v<=c))return!1}else if(n>s&&y<0&&(h=(s-n)/y)<t&&(v=a+h*m,u<=(d=i+h*g)&&d<=_&&l<=v&&v<=c))return!1;if(i<u&&g>0){if((h=(u-i)/g)<t&&(v=a+h*m,o<=(f=n+h*y)&&f<=s&&l<=v&&v<=c))return!1}else if(i>_&&g<0&&(h=(_-i)/g)<t&&(v=a+h*m,o<=(f=n+h*y)&&f<=s&&l<=v&&v<=c))return!1;if(a<l&&m>0){if((h=(l-a)/m)<t&&(d=i+h*g,o<=(f=n+h*y)&&f<=s&&u<=d&&d<=_))return!1}else if(a>c&&m<0&&(h=(c-a)/m)<t&&(d=i+h*g,o<=(f=n+h*y)&&f<=s&&u<=d&&d<=_))return!1;return!0}},{key:"_removeEntityMeshes",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=this._meshes[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){i.value.removeEntityMesh(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"_getEntityMap",value:function(){if(null===this._entity_map){var e=this._parent._getEntityMap(),t=new Map,r=!0,n=!1,i=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=et(a.value,2),u=s[0];if(s[1])t.set(u,!0);else switch(u.getAreaStatus(this)){case I_.AreaStatus.PARTIAL:t.set(u,!1);break;case I_.AreaStatus.FULL:t.set(u,!0)}}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}this._entity_map=t}return this._entity_map}},{key:"base_height",get:function(){return this._base_height}},{key:"height_min",get:function(){return this._height_min}},{key:"height_max",get:function(){return this._height_max}}],[{key:"_findTriRayDistance",value:function(t,r,n,i,a){var o=t.direction,s=e._temp_ray_1;s[0]=i[0]-n[0],s[1]=i[1]-n[1],s[2]=i[2]-n[2];var u=e._temp_ray_2;u[0]=a[0]-n[0],u[1]=a[1]-n[1],u[2]=a[2]-n[2];var _=hs.cross3(s,u,e._temp_ray_3),l=hs.dot3(_,o);if(l<0){var c=t.position,h=e._temp_ray_4;h[0]=n[0]-c[0],h[1]=n[1]-c[1],h[2]=n[2]-c[2];var f=hs.dot3(_,h)/l;if(f>=0&&f<r){var d=e._temp_ray_5;d[0]=c[0]+f*o[0],d[1]=c[1]+f*o[1],d[2]=c[2]+f*o[2];var v=e._temp_ray_6;v[0]=n[0]-d[0],v[1]=n[1]-d[1],v[2]=n[2]-d[2];var p=e._temp_ray_7;p[0]=i[0]-d[0],p[1]=i[1]-d[1],p[2]=i[2]-d[2];var y=e._temp_ray_8;if(y[0]=a[0]-d[0],y[1]=a[1]-d[1],y[2]=a[2]-d[2],hs.dot3(hs.cross3(v,p,e._temp_ray_9),_)>=0&&hs.dot3(hs.cross3(p,y,e._temp_ray_10),_)>=0&&hs.dot3(hs.cross3(y,v,e._temp_ray_11),_)>=0)return f}}return r}}]),e}();C_.ε=.0625,C_.Fm=-2,C_.Fp=2,C_.πr=Math.PI*hs.EARTH_RADIUS,C_._temp_positions=function(){for(var e=[],t=0;t<4;++t)e.push(hs.createVector3());return e}(),C_._temp_ray_1=hs.createVector3(),C_._temp_ray_2=hs.createVector3(),C_._temp_ray_3=hs.createVector3(),C_._temp_ray_4=hs.createVector3(),C_._temp_ray_5=hs.createVector3(),C_._temp_ray_6=hs.createVector3(),C_._temp_ray_7=hs.createVector3(),C_._temp_ray_8=hs.createVector3(),C_._temp_ray_9=hs.createVector3(),C_._temp_ray_10=hs.createVector3(),C_._temp_ray_11=hs.createVector3();var F_=function(){function e(){Ge(this,e),this._history=[],this._max_value=0,this._hsize=200}return qe(e,[{key:"getMaxValue",value:function(t){var r=this._history,n=this._max_value;return r.length<this._hsize?t>n&&(this._max_value=t):t>=n?(this._max_value=t,r.shift()):r[0]<n?r.shift():(r.shift(),this._max_value=e._find_max(r)),r.push(t),this._max_value}}],[{key:"_find_max",value:function(e){for(var t=e[0],r=e.length,n=1;n<r;++n){var i=e[n];i>t&&(t=i)}return t}}]),e}(),N_=function(){function e(t,r,n){Ge(this,e),this._flake=t,this._dem=r,this._dpows=Array.from(n),this._aframe=-1,this._base_mesh=new l_(t._globe.glenv,t,n,r),this._entity_meshes=new Map,t._globe._num_cache_meshes+=1}return qe(e,[{key:"getRenderObject",value:function(){var e=this._flake,t=new f_(e,e._globe.glenv,this._base_mesh),r=!0,n=!1,i=void 0;try{for(var a,o=e.getEntityProducers()[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value,u=this._getEntityMesh(s);u!==U_&&(null===u&&(u=s.createMesh(e,this._dpows,this._dem),this._setEntityMesh(s,u),null===u)||t.addEntityData(u,s))}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return t}},{key:"match",value:function(e,t){return this._dem===e&&this._dpows[0]===t[0]&&this._dpows[1]===t[1]}},{key:"touch",value:function(){var e=this._flake._globe;this._aframe!==e._frame_counter&&(this._aframe=e._frame_counter,e._num_touch_meshes+=1)}},{key:"dispose",value:function(){if(null!==this._base_mesh){for(var e=this._flake,t=e._meshes,r=t.length,n=0;n<r;++n)if(t[n]===this){t.splice(n,1);break}this._base_mesh.dispose(),this._base_mesh=null;var i=!0,a=!1,o=void 0;try{for(var s,u=this._entity_meshes.values()[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value;_ instanceof k_&&_.dispose()}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}e._globe._num_cache_meshes-=1}}},{key:"compareForReduce",value:function(e){return e._aframe-this._aframe}},{key:"removeEntityMesh",value:function(e){this._entity_meshes.delete(e)}},{key:"_getEntityMesh",value:function(e){var t=this._entity_meshes.get(e);return void 0!==t?t:null}},{key:"_setEntityMesh",value:function(e,t){var r=null!==t?t:U_;this._entity_meshes.set(e,r)}}]),e}(),O_={NONE:{id:"NONE"},LOADED:{id:"LOADED"},REQUESTED:{id:"REQUESTED"},FAILED:{id:"FAILED"}},U_={id:"CACHED_EMPTY_MESH"},V_=function(){function e(t){Ge(this,e),this.flake=t}return qe(e,[{key:"getRenderObject",value:function(){return this.flake.getRenderObject(this.lod)}}]),e}(),B_=function(){function e(t){Ge(this,e),this._setupViewVectors(t),this._setupClipPlanes(t);var r=t._viewer,n=r.dem_provider,i=r.tile_texture_cache;this._min_image_z=i.getImageZMin();var a=hs.LOG2PI-n.getResolutionPower()+1;this._max_zbias=Math.max(i.getImageZBias(),a),this._globe=r.globe,this._rflake_list=[],this._debug_stats=r.debug_stats,this._debug_stats&&(this._num_procA_flakes=0,this._num_procB_flakes=0),this._view_dir_N=hs.createVector3(),this._view_dir_V=hs.createVector3()}return qe(e,[{key:"_setupViewVectors",value:function(e){var t=e._view_to_gocs,r=e._pixel_step,n=hs.createVector3(),i=hs.createVector3();n[0]=t[12],n[1]=t[13],n[2]=t[14],i[0]=-t[8]*r,i[1]=-t[9]*r,i[2]=-t[10]*r,this._view_pos_Q=n,this._view_dir_wU=i}},{key:"_setupClipPlanes",value:function(e){var t=e._view_to_gocs,r=e._gocs_to_view,n=e._volume_planes,i=[],a=e._viewer._globe.root_flake,o=hs.EARTH_RADIUS+a.height_min,s=hs.EARTH_RADIUS+a.height_max,u=t[12],_=t[13],l=t[14],c=u*u+_*_+l*l,h=o*o,f=s*s,d=Math.sqrt((c-h)*(f-h))-h,v=hs.createVector4(),p=1/Math.sqrt(c);v[0]=u*p,v[1]=_*p,v[2]=l*p,v[3]=d*p,i.push(v);for(var y=Math.sqrt(c+f+2*d),g=0;g<6;++g){var m=n[g],k=hs.createVector4();1==g&&m[3]>y&&((m=hs.createVector4(m))[3]=y),hs.transformPlane_A(r,m,k),i.push(k)}this._clip_planes=i}},{key:"traverse",value:function(){return this._collectFlakes(this._globe.root_flake),this._debug_stats&&(this._debug_stats.num_procA_flakes=this._num_procA_flakes,this._debug_stats.num_procB_flakes=this._num_procB_flakes),this._rflake_list}},{key:"_collectFlakes",value:function(t){if(null!==this._debug_stats&&(this._num_procA_flakes+=1),!t.isInvisible(this._clip_planes))if(t.z<this._min_image_z)this._collectNextLevelFlakes(t);else{null!==this._debug_stats&&(this._num_procB_flakes+=1);var r=this._getLevelOfDetailRange(t),n=r.mid+this._max_zbias;r.max-r.min>e.MAX_LOD_INTERVAL||n>t.z?this._collectNextLevelFlakes(t):this._addRenderFlake(t,r)}}},{key:"_collectNextLevelFlakes",value:function(e){for(var t=0;t<2;++t)for(var r=0;r<2;++r)this._collectFlakes(e.newChild(r,t))}},{key:"_getLevelOfDetailRange",value:function(e){for(var t=Math.PI,r=e.z,n=e.x,i=e.y,a=Math.pow(2,1-r)*t,o=n*a-t,s=t-(i+1)*a,u=t/32,_=Math.ceil(a/u),l=a/_,c=hs.EARTH_RADIUS+e.base_height,h=this._view_pos_Q,f=this._view_dir_wU,d=this._view_dir_N,v=this._view_dir_V,p=Number.MAX_VALUE,y=-Number.MAX_VALUE,g=0,m=s;g<_+1;++g,m+=l)for(var k=Math.exp(m),E=k*k,w=(E-1)/(E+1),b=2*k/(E+1),x=1/(c*b),T=0,A=o;T<_+1;++T,A+=l){var R=Math.sin(A),I=Math.cos(A);d[0]=b*I,d[1]=b*R,d[2]=w,v[0]=c*d[0]-h[0],v[1]=c*d[1]-h[1],v[2]=c*d[2]-h[2];var P=hs.dot3(f,v);if(P<=0)return{min:-1e3,max:1e3,mid:0};var S=P*x;p=Math.min(p,S),y=Math.max(y,S)}var M=-Math.maprayLog2(y),L=-Math.maprayLog2(p);return{min:M,max:L,mid:(M+L)/2}}},{key:"_calcLOD",value:function(e,t,r){var n=Math.sin(e),i=Math.cos(e),a=Math.exp(t),o=a*a,s=(o-1)/(o+1),u=2*a/(o+1),_=this._view_dir_N;_[0]=u*i,_[1]=u*n,_[2]=s;var l=this._view_dir_V,c=this._view_pos_Q;l[0]=r*_[0]-c[0],l[1]=r*_[1]-c[1],l[2]=r*_[2]-c[2];var h=this._view_dir_wU,f=r*u/hs.dot3(h,l);return Math.maprayLog2(f)}},{key:"_setCornerLODs",value:function(e){var t=Math.PI,r=e.flake,n=r.z,i=r.x,a=r.y,o=Math.pow(2,1-n)*t,s=i*o-t,u=(i+1)*o-t,_=t-(a+1)*o,l=t-a*o,c=hs.EARTH_RADIUS+r.base_height;e.lod_00=this._calcLOD(s,_,c),e.lod_10=this._calcLOD(u,_,c),e.lod_01=this._calcLOD(s,l,c),e.lod_11=this._calcLOD(u,l,c)}},{key:"_addRenderFlake",value:function(e,t){var r=new V_(e);r.lod=t.mid,this._setCornerLODs(r),this._rflake_list.push(r)}}]),e}();B_.MAX_LOD_INTERVAL=.5;var z_=function(){function e(t,r,n){Ge(this,e),this._glenv=t;try{this.vs_object=this._compile_shader("VERTEX_SHADER",r),this.fs_object=this._compile_shader("FRAGMENT_SHADER",n)}catch(e){var i=t.context;throw this.vs_object&&i.deleteShader(this.vs_object),this.fs_object&&i.deleteShader(this.fs_object),e}}return qe(e,[{key:"dispose",value:function(){var e=this._glenv.context;this.vs_object&&(e.deleteShader(this.vs_object),this.vs_object=null),this.fs_object&&(e.deleteShader(this.fs_object),this.fs_object=null)}},{key:"_compile_shader",value:function(e,t){var r=this._glenv.context,n=r.createShader(r[e]);if(!n)throw new Error(e+" オブジェクトの生成に失敗しました");try{if(r.shaderSource(n,t),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS)){var i=r.getShaderInfoLog(n);throw new Error(e+" のコンパイルに失敗: "+i)}}catch(e){throw r.deleteShader(n),e}return n}}]),e}(),G_=function(){function e(t,r,n){Ge(this,e);var i=new z_(t,r,n);this._gl=t.context,this._program=this._link_shaders(i.vs_object,i.fs_object),this._vertex_attribs=this._create_vertex_attribs(),this._uniform_location=this._create_uniform_location(),i.dispose()}return qe(e,[{key:"_link_shaders",value:function(e,t){var r=this._gl,n=r.createProgram();if(!n)throw new Error("プログラムオブジェクトの生成に失敗しました");try{if(r.attachShader(n,e),r.attachShader(n,t),r.linkProgram(n),!r.getProgramParameter(n,r.LINK_STATUS)){var i=r.getProgramInfoLog(n);throw r.detachShader(n,t),r.detachShader(n,e),new Error("シェーダのリンクに失敗: "+i)}}catch(e){throw r.deleteProgram(n),e}return n}},{key:"_create_vertex_attribs",value:function(){for(var e=this._gl,t=this._program,r=[],n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),i=0;i<n;++i){var a=e.getActiveAttrib(t,i),o={name:a.name,location:e.getAttribLocation(t,a.name)};r.push(o)}return r}},{key:"_create_uniform_location",value:function(){for(var e=this._gl,t=this._program,r={},n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),i=0;i<n;++i){var a=e.getActiveUniform(t,i);r[a.name]=e.getUniformLocation(t,a.name)}return r}},{key:"dispose",value:function(){this._gl.deleteProgram(this._program),this._program=null}},{key:"bindProgram",value:function(){this._gl.useProgram(this._program)}},{key:"setBoolean",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform1i(r,t?1:0)}},{key:"setInteger",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform1i(r,t)}},{key:"setFloat",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform1f(r,t)}},{key:"setVector2",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform2fv(r,t)}},{key:"setVector3",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform3fv(r,t)}},{key:"setVector4",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniform4fv(r,t)}},{key:"setMatrix",value:function(e,t){var r=this._uniform_location[e];r&&this._gl.uniformMatrix4fv(r,!1,t)}},{key:"bindVertexAttribs",value:function(e){for(var t=this._gl,r=this._vertex_attribs,n=r.length,i=0;i<n;++i){var a=r[i],o=e[a.name],s=a.location;void 0!==o?(t.bindBuffer(t.ARRAY_BUFFER,o.buffer),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,o.num_components,o.component_type,o.normalized,o.byte_stride,o.byte_offset)):t.disableVertexAttribArray(s)}}},{key:"bindTexture2D",value:function(e,t){var r=this._gl;r.activeTexture(r.TEXTURE0+e),r.bindTexture(r.TEXTURE_2D,t)}}]),e}(),j_=function(e){function t(e,r,n){var i;return Ge(this,t),(i=Ke(this,He(t).call(this,e.glenv,r,n)))._flake_to_clip=hs.createMatrixf(),i}return Ye(t,e),qe(t,[{key:"numDrawings",value:function(){return 1}},{key:"isWireframe",value:function(){return!1}},{key:"setFlakeParameter",value:function(e,t,r,n){return!1}},{key:"setCommonParameter",value:function(e,t){t.mul_flake_to_gocs(e._gocs_to_clip,this._flake_to_clip),this.setMatrix("u_obj_to_clip",this._flake_to_clip)}}]),t}(G_),q_=function(){function e(){Ge(this,e)}return qe(e,[{key:"status",value:function(e){return H_.READY}},{key:"requestTile",value:function(e,t,r,n){throw new Error("mapray.ImageProvider#requestTile() method has not been overridden.")}},{key:"cancelRequest",value:function(e){throw new Error("mapray.ImageProvider#cancelRequest() method has not been overridden.")}},{key:"getImageSize",value:function(){throw new Error("mapray.ImageProvider#getImageSize() method has not been overridden.")}},{key:"getZoomLevelRange",value:function(){throw new Error("mapray.ImageProvider#getZoomLevelRange() method has not been overridden.")}}]),e}(),Y_=function(){function e(t,r){Ge(this,e),this._min=t,this._max=r}return qe(e,[{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}}]),e}();q_.Range=Y_;var H_={NOT_READY:{id:"NOT_READY"},READY:{id:"READY"},FAILED:{id:"FAILED"}};q_.Status=H_;var X_=function(e){function t(){return Ge(this,t),Ke(this,He(t).call(this))}return Ye(t,e),qe(t,[{key:"requestTile",value:function(e,t,r,n){return this}},{key:"cancelRequest",value:function(e){}},{key:"getImageSize",value:function(){return 4096}},{key:"getZoomLevelRange",value:function(){return new q_.Range(0,0)}}]),t}(q_),W_=function(){function e(t,r,n,i){Ge(this,e),this.z=t,this.x=r,this.y=n,this.texture=i}return qe(e,[{key:"dispose",value:function(e){e.deleteTexture(this.texture),this.texture=null}}]),e}(),Q_=function(){function e(t,r){var n=this;Ge(this,e),this._glenv=t,this._provider=null,this._min_image_z=0,this._max_image_z=0,this._image_zbias=0;this._resetImageProvider(r.status((function(e){e===q_.Status.READY?(n._flush(),n._resetImageProvider(r)):e===q_.Status.FAILED&&console.error("ImageProvider.Status.FAILED in TileTextureCache")}))===q_.Status.READY?r:new X_),this._croot=new Z_,this._max_accesses=0,this._frame_counter=0,this._lower_bound=1,this._upper_bound=1.2,this._num_requesteds=0,this._max_requesteds=75,this._new_requesteds=[];var i=t.context,a=t.EXT_texture_filter_anisotropic;a&&(this._aniso_ext=a,this._max_aniso=i.getParameter(a.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this._use_mipmap=!1}return qe(e,[{key:"_resetImageProvider",value:function(e){this._provider=e;var t=e.getZoomLevelRange();this._min_image_z=t.min,this._max_image_z=t.max,this._image_zbias=Math.maprayLog2(2*Math.PI/e.getImageSize())}},{key:"cancel",value:function(){this._flush()}},{key:"_flush",value:function(){new $_(this,this._croot),this._croot=new Z_,this._max_accesses=0}},{key:"getImageZBias",value:function(){return this._image_zbias}},{key:"getImageZMin",value:function(){return this._min_image_z}},{key:"getNumWaitingRequests",value:function(){return this._num_requesteds}},{key:"findNearestAncestors",value:function(t,r,n,i){for(var a,o,s,u=0,_=this._min_image_z,l=Math.pow(2,1-t),c=(r+.5)*l,h=(n+.5)*l,f=this._croot;u<_;++u)a=Math.floor(c)%2+2*(Math.floor(h)%2),null===(s=(o=f.children)[a])&&(s=new Z_,o[a]=s),c*=2,h*=2,f=s;var d=this._max_image_z,v=hs.clamp(i-1,_,d),p=null,y=null;if(v<hs.clamp(i,_,d)){for(;u<=v;++u)f.state===el.LOADED?p=f:f.state===el.NONE?(f.state=el.REQUESTED,f.req_power=i-u,this._new_requesteds.push([f,u,Math.floor(.5*c),Math.floor(.5*h)])):f.state===el.REQUESTED&&f.updateRequestPower(i-u),a=Math.floor(c)%2+2*(Math.floor(h)%2),null===(s=(o=f.children)[a])&&(s=new Z_,o[a]=s),c*=2,h*=2,f=s;y=p,f.state===el.LOADED?y=f:f.state===el.NONE?(f.state=el.REQUESTED,f.req_power=i-u,this._new_requesteds.push([f,u,Math.floor(.5*c),Math.floor(.5*h)])):f.state===el.REQUESTED&&f.updateRequestPower(i-u)}else for(;;++u){if(f.state===el.LOADED?p=f:f.state===el.NONE?(f.state=el.REQUESTED,f.req_power=i-u,this._new_requesteds.push([f,u,Math.floor(.5*c),Math.floor(.5*h)])):f.state===el.REQUESTED&&f.updateRequestPower(i-u),u==v){y=p;break}a=Math.floor(c)%2+2*(Math.floor(h)%2),null===(s=(o=f.children)[a])&&(s=new Z_,o[a]=s),c*=2,h*=2,f=s}f.touch();var g=e._findNearestAncestors_result;return g[0]=null!==y?y.data:null,g[1]=null!==p?p.data:null,g}},{key:"endFrame",value:function(){this._performNewRequests();var e=new J_(this._croot,this._frame_counter);if(this._max_accesses=Math.max(e.num_accesses,this._max_accesses),e.num_loadeds>this._upper_bound*this._max_accesses){var t=Math.floor(this._lower_bound*this._max_accesses);this._reduceCache(t)}++this._frame_counter}},{key:"_performNewRequests",value:function(){var e=Math.min(this._max_requesteds-this._num_requesteds,this._new_requesteds.length);this._new_requesteds.sort((function(e,t){var r=e[0];return t[0].req_power-r.req_power}));var t=this;this._new_requesteds.slice(0,e).forEach((function(e){var r=e[0],n=e[1],i=e[2],a=e[3];t._requestTileTexture(n,i,a,r)})),this._new_requesteds.slice(e).forEach((function(e){e[0].state=el.NONE})),this._new_requesteds.length=0}},{key:"_requestTileTexture",value:function(e,t,r,n){var i=this;n.data=this._provider.requestTile(e,t,r,(function(a){n.state===el.REQUESTED&&(a?(n.data=new W_(e,t,r,i._createTexture(a)),n.state=el.LOADED):(n.data=null,n.state=el.FAILED),--i._num_requesteds)})),++this._num_requesteds}},{key:"_createTexture",value:function(e){var t=this._glenv.context,r=this._aniso_ext,n=t.TEXTURE_2D,i=t.createTexture();return t.bindTexture(n,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texImage2D(n,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this._use_mipmap&&t.generateMipmap(n),t.texParameteri(n,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(n,t.TEXTURE_MIN_FILTER,this._use_mipmap?t.LINEAR_MIPMAP_LINEAR:t.LINEAR),t.texParameteri(n,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(n,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r&&t.texParameterf(t.TEXTURE_2D,r.TEXTURE_MAX_ANISOTROPY_EXT,this._max_aniso),t.bindTexture(n,null),i}},{key:"_reduceCache",value:function(e){var t=new K_(this._croot);t.nodes.sort((function(e,t){var r=t.aframe-e.aframe;return 0==r&&e.state===el.LOADED&&t.state===el.LOADED?e.data.z-t.data.z:r}));var r=this._glenv.context;t.nodes.slice(e).forEach((function(e){e.state===el.LOADED&&e.data.dispose(r),e.state=el.NONE,e.data=null})),t.clean()}}]),e}();Q_._findNearestAncestors_result=new Array(2);var Z_=function(){function e(){Ge(this,e),this.children=[null,null,null,null],this.state=el.NONE,this.data=null,this.req_power=-1,this.aframe=-1}return qe(e,[{key:"updateRequestPower",value:function(e){e>this.req_power&&(this.req_power=e)}},{key:"touch",value:function(){this.aframe=!0}}]),e}(),J_=function(){function e(t,r){Ge(this,e),this.num_loadeds=0,this.num_accesses=0,this._frame=r,this._traverse(t)}return qe(e,[{key:"_traverse",value:function(e){for(var t=e.children,r=!0===e.aframe,n=0;n<4;++n){var i=t[n];null!==i&&(r=this._traverse(i)||r)}return e.state===el.LOADED&&(++this.num_loadeds,r&&++this.num_accesses),r&&(e.aframe=this._frame),r}}]),e}(),K_=function(){function e(t){Ge(this,e),this._root=t,this.nodes=[],this._traverse(t)}return qe(e,[{key:"_traverse",value:function(e){var t=e.state;t!==el.LOADED&&t!==el.FAILED||this.nodes.push(e);for(var r=e.children,n=0;n<4;++n){var i=r[n];null!==i&&this._traverse(i)}}},{key:"clean",value:function(){this._clean_recur(this._root)}},{key:"_clean_recur",value:function(e){for(var t=e.state===el.NONE,r=e.children,n=0;n<4;++n){var i=r[n];if(null!==i){var a=this._clean_recur(i);!0===a&&(r[n]=null),t=a&&t}}return t}}]),e}(),$_=function(){function e(t,r){Ge(this,e),this._owner=t,this._traverse(r)}return qe(e,[{key:"_traverse",value:function(e){for(var t=e.children,r=0;r<4;++r){var n=t[r];null!==n&&this._traverse(n)}if(e.state===el.REQUESTED){var i=this._owner;e.state=el.NONE,i._provider.cancelRequest(e.data),--i._num_requesteds}}}]),e}(),el={NONE:{id:"NONE"},LOADED:{id:"LOADED"},REQUESTED:{id:"REQUESTED"},FAILED:{id:"FAILED"}},tl="attribute vec4 a_position;         // 位置 (地表断片座標系)\nattribute vec2 a_uv;               // uv 座標\n\nuniform mat4  u_obj_to_clip;       // 地表断片座標系からクリップ座標系への変換\n\nuniform vec4  u_texcoord_rect_hi;  // 高レベル画像 左下座標: (x, y), 座標サイズ: (z, w)\nuniform vec4  u_texcoord_rect_lo;  // 低レベル画像 左下座標: (x, y), 座標サイズ: (z, w)\nuniform vec4  u_corner_lod;        // uv = (0,0), (1,0), (0,1), (1,1) の LOD\n\nvarying vec2  v_texcoord_hi;       // 高レベル画像のテクスチャ座標\nvarying vec2  v_texcoord_lo;       // 低レベル画像のテクスチャ座標\nvarying float v_lod;               // 補間された LOD\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n    // uv 座標をテクスチャ座標に変換\n    v_texcoord_hi = u_texcoord_rect_hi.xy + u_texcoord_rect_hi.zw * a_uv;\n    v_texcoord_lo = u_texcoord_rect_lo.xy + u_texcoord_rect_lo.zw * a_uv;\n\n    // LOD の補間\n    float u = a_uv.x;\n    float v = a_uv.y;\n\n    float lod_00 = u_corner_lod.x;  // uv = (0,0) の LOD\n    float lod_10 = u_corner_lod.y;  // uv = (1,0) の LOD\n    float lod_01 = u_corner_lod.z;  // uv = (0,1) の LOD\n    float lod_11 = u_corner_lod.w;  // uv = (1,1) の LOD\n\n    float lod_u0 = mix( lod_00, lod_10, u );  // uv = (u, 0) の LOD\n    float lod_u1 = mix( lod_01, lod_11, u );  // uv = (u, 1) の LOD\n    float lod_uv = mix( lod_u0, lod_u1, v );  // uv = (u, v) の LOD\n\n    v_lod = lod_uv;\n}\n",rl="precision mediump float;\n\nvarying vec2  v_texcoord_hi;    // 高レベル画像のテクスチャ座標\nvarying vec2  v_texcoord_lo;    // 低レベル画像のテクスチャ座標\nvarying float v_lod;            // 補間された LOD\n\nuniform sampler2D u_image_hi;   // 高レベル画像\nuniform sampler2D u_image_lo;   // 低レベル画像\nuniform float     u_opacity;    // 不透明度\n\n/** 画像パラメータ\n *\n *  x = u_image_lo の LOD\n *  y = 1 / (u_image_hi の LOD - x)\n *\n *  ただし u_image_hi と u_image_lo が同じ画像のときは y = 0\n */\nuniform vec2 u_image_param;\n\n\nvoid main()\n{\n    vec4 color_hi = texture2D( u_image_hi, v_texcoord_hi );\n    vec4 color_lo = texture2D( u_image_lo, v_texcoord_lo );\n\n    // 画像の混合率\n    float lo_lod = u_image_param.x;\n    float  delta = u_image_param.y;\n    float  ratio = clamp( (v_lod - lo_lod) * delta, 0.0, 1.0 );\n\n    gl_FragColor = mix( color_lo, color_hi, ratio );\n    gl_FragColor.a *= u_opacity;  // 不透明度を適用\n}\n",nl="/**\n * マウスピック用ID描画シェーダ (フラグメントシェーダ)\n */\n\nprecision highp float;\nuniform vec4 u_rid; // rid\n\nvoid main()\n{\n    gl_FragColor = u_rid;\n}\n",il=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Ge(this,t),(r=Ke(this,He(t).call(this,e,tl,n.ridMaterial?nl:rl))).bindProgram(),r.setInteger("u_image_hi",t.TEXUNIT_IMAGE_HI),r.setInteger("u_image_lo",t.TEXUNIT_IMAGE_LO),r._tile_texture_cache=e.tile_texture_cache,r._layers=e.layers,r._dummy_tile_texture=r._createDummyTileTexture(e.glenv),r._image_zbias=0,r}return Ye(t,e),qe(t,[{key:"numDrawings",value:function(){return 1+this._layers.numDrawingLayers()}},{key:"setFlakeParameter",value:function(e,r,n,i){this.setCommonParameter(e,n);var a=this._getMaterialParamater(r,i);return null!==a&&(this.setVector4("u_corner_lod",a.corner_lod),this.setVector4("u_texcoord_rect_hi",a.image_hi.texcoord_rect),this.setVector4("u_texcoord_rect_lo",a.image_lo.texcoord_rect),this.setVector2("u_image_param",[a.image_lo.lod,a.image_hi.lod==a.image_lo.lod?0:1/(a.image_hi.lod-a.image_lo.lod)]),this.setFloat("u_opacity",0==i?1:this._layers.getDrawingLayer(i-1).opacity),this.bindTexture2D(t.TEXUNIT_IMAGE_HI,a.image_hi.texture),this.bindTexture2D(t.TEXUNIT_IMAGE_LO,a.image_lo.texture),!0)}},{key:"_getMaterialParamater",value:function(e,t){var r=0==t?this._tile_texture_cache:this._layers.getDrawingLayer(t-1).tile_cache;this._image_zbias=r.getImageZBias();var n=e.flake,i=n.z;if(i<r.getImageZMin())return null;var a=n.x,o=n.y,s=Math.ceil(e.lod+this._image_zbias);if(i<s)return null;var u=r.findNearestAncestors(i,a,o,s);return t>=1&&null===u[0]?null:{corner_lod:[e.lod_00,e.lod_10,e.lod_01,e.lod_11],image_hi:this._getImageParamater(u[0],i,a,o,s),image_lo:this._getImageParamater(u[1],i,a,o,s-1)}}},{key:"_getImageParamater",value:function(e,t,r,n,i){var a;return null!==e?(a=Math.pow(2,e.z-t),{lod:e.z-this._image_zbias,texture:e.texture,texcoord_rect:[r*a-e.x,1-(n+1)*a+e.y,a,a]}):(a=Math.pow(2,-t),{lod:-this._image_zbias,texture:this._dummy_tile_texture,texcoord_rect:[r*a-Math.floor(a*(r+.5)),1-(n+1)*a+Math.floor(a*(n+.5)),a,a]})}},{key:"_createDummyTileTexture",value:function(e){var t=e.context,r=t.TEXTURE_2D,n=t.createTexture();return t.bindTexture(r,n),t.texImage2D(r,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,new Uint8Array([128,128,128,255])),t.bindTexture(r,null),n}}]),t}(j_);il.TEXUNIT_IMAGE_HI=0,il.TEXUNIT_IMAGE_LO=1;var al=function(e){function t(e){return Ge(this,t),Ke(this,He(t).call(this,e,"attribute vec4 a_position;\nattribute vec2 a_uv;\n\nuniform mat4 u_obj_to_clip;\n\nvarying vec2 v_uv;\n\nvoid main()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    v_uv  = a_uv;\n}\n","precision mediump float;\n\nvarying vec2 v_uv;\n\nvoid main()\n{\n    vec4 color = (v_uv.x < 0.005 || v_uv.y < 0.005 || v_uv.x > 0.995 || v_uv.y > 0.995) ?\n                 vec4( 1, 1, 0, 1 ) : vec4( 0.5, 0.5, 0.5, 1 );\n    gl_FragColor = color;\n}\n"))}return Ye(t,e),qe(t,[{key:"isWireframe",value:function(){return!0}},{key:"setFlakeParameter",value:function(e,t,r,n){return this.setCommonParameter(e,r),!0}}]),t}(j_),ol=ve.indexOf,sl=[].indexOf,ul=!!sl&&1/[1].indexOf(1,-0)<0,_l=To("indexOf"),ll=$r("indexOf",{ACCESSORS:!0,1:0});Le({target:"Array",proto:!0,forced:ul||!_l||!ll},{indexOf:function(e){return ul?sl.apply(this,arguments)||0:ol(this,e,arguments.length>1?arguments[1]:void 0)}});var cl=Oo.left,hl=To("reduce"),fl=$r("reduce",{1:0});Le({target:"Array",proto:!0,forced:!hl||!fl},{reduce:function(e){return cl(this,e,arguments.length,arguments.length>1?arguments[1]:void 0)}}),Le({target:"Date",stat:!0},{now:function(){return(new Date).getTime()}});var dl=i((function(){ot(1)}));Le({target:"Object",stat:!0,forced:dl},{keys:function(e){return ot(Gt(e))}});var vl,pl,yl,gl=n.Promise,ml=/(iphone|ipod|ipad).*applewebkit/i.test(Os),kl=n.location,El=n.setImmediate,wl=n.clearImmediate,bl=n.process,xl=n.MessageChannel,Tl=n.Dispatch,Al=0,Rl={},Il=function(e){if(Rl.hasOwnProperty(e)){var t=Rl[e];delete Rl[e],t()}},Pl=function(e){return function(){Il(e)}},Sl=function(e){Il(e.data)},Ml=function(e){n.postMessage(e+"",kl.protocol+"//"+kl.host)};El&&wl||(El=function(e){for(var t=[],r=1;arguments.length>r;)t.push(arguments[r++]);return Rl[++Al]=function(){("function"==typeof e?e:Function(e)).apply(void 0,t)},vl(Al),Al},wl=function(e){delete Rl[e]},"process"==Z(bl)?vl=function(e){bl.nextTick(Pl(e))}:Tl&&Tl.now?vl=function(e){Tl.now(Pl(e))}:xl&&!ml?(yl=(pl=new xl).port2,pl.port1.onmessage=Sl,vl=ir(yl.postMessage,yl,1)):!n.addEventListener||"function"!=typeof postMessage||n.importScripts||i(Ml)?vl="onreadystatechange"in _("script")?function(e){ut.appendChild(_("script")).onreadystatechange=function(){ut.removeChild(this),Il(e)}}:function(e){setTimeout(Pl(e),0)}:(vl=Ml,n.addEventListener("message",Sl,!1)));var Ll,Dl,Cl,Fl,Nl,Ol,Ul,Vl,Bl={set:El,clear:wl},zl=re.f,Gl=Bl.set,jl=n.MutationObserver||n.WebKitMutationObserver,ql=n.process,Yl=n.Promise,Hl="process"==Z(ql),Xl=zl(n,"queueMicrotask"),Wl=Xl&&Xl.value;Wl||(Ll=function(){var e,t;for(Hl&&(e=ql.domain)&&e.exit();Dl;){t=Dl.fn,Dl=Dl.next;try{t()}catch(e){throw Dl?Fl():Cl=void 0,e}}Cl=void 0,e&&e.enter()},Hl?Fl=function(){ql.nextTick(Ll)}:jl&&!ml?(Nl=!0,Ol=document.createTextNode(""),new jl(Ll).observe(Ol,{characterData:!0}),Fl=function(){Ol.data=Nl=!Nl}):Yl&&Yl.resolve?(Ul=Yl.resolve(void 0),Vl=Ul.then,Fl=function(){Vl.call(Ul,Ll)}):Fl=function(){Gl.call(n,Ll)});var Ql,Zl,Jl,Kl,$l=Wl||function(e){var t={fn:e,next:void 0};Cl&&(Cl.next=t),Dl||(Dl=t,Fl()),Cl=t},ec=function(e){var t,r;this.promise=new e((function(e,n){if(void 0!==t||void 0!==r)throw TypeError("Bad Promise constructor");t=e,r=n})),this.resolve=nr(t),this.reject=nr(r)},tc={f:function(e){return new ec(e)}},rc=function(e,t){if(c(e),o(t)&&t.constructor===e)return t;var r=tc.f(e);return(0,r.resolve)(t),r.promise},nc=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},ic=Bl.set,ac=Zt("species"),oc="Promise",sc=z.get,uc=z.set,_c=z.getterFor(oc),lc=gl,cc=n.TypeError,hc=n.document,fc=n.process,dc=ae("fetch"),vc=tc.f,pc=vc,yc="process"==Z(fc),gc=!!(hc&&hc.createEvent&&n.dispatchEvent),mc=Se(oc,(function(){if(!(T(lc)!==String(lc))){if(66===zs)return!0;if(!yc&&"function"!=typeof PromiseRejectionEvent)return!0}if(zs>=51&&/native code/.test(lc))return!1;var e=lc.resolve(1),t=function(e){e((function(){}),(function(){}))};return(e.constructor={})[ac]=t,!(e.then((function(){}))instanceof t)})),kc=mc||!vi((function(e){lc.all(e).catch((function(){}))})),Ec=function(e){var t;return!(!o(e)||"function"!=typeof(t=e.then))&&t},wc=function(e,t,r){if(!t.notified){t.notified=!0;var n=t.reactions;$l((function(){for(var i=t.value,a=1==t.state,o=0;n.length>o;){var s,u,_,l=n[o++],c=a?l.ok:l.fail,h=l.resolve,f=l.reject,d=l.domain;try{c?(a||(2===t.rejection&&Ac(e,t),t.rejection=1),!0===c?s=i:(d&&d.enter(),s=c(i),d&&(d.exit(),_=!0)),s===l.promise?f(cc("Promise-chain cycle")):(u=Ec(s))?u.call(s,h,f):h(s)):f(i)}catch(e){d&&!_&&d.exit(),f(e)}}t.reactions=[],t.notified=!1,r&&!t.rejection&&xc(e,t)}))}},bc=function(e,t,r){var i,a;gc?((i=hc.createEvent("Event")).promise=t,i.reason=r,i.initEvent(e,!1,!0),n.dispatchEvent(i)):i={promise:t,reason:r},(a=n["on"+e])?a(i):"unhandledrejection"===e&&function(e,t){var r=n.console;r&&r.error&&(1===arguments.length?r.error(e):r.error(e,t))}("Unhandled promise rejection",r)},xc=function(e,t){ic.call(n,(function(){var r,n=t.value;if(Tc(t)&&(r=nc((function(){yc?fc.emit("unhandledRejection",n,e):bc("unhandledrejection",e,n)})),t.rejection=yc||Tc(t)?2:1,r.error))throw r.value}))},Tc=function(e){return 1!==e.rejection&&!e.parent},Ac=function(e,t){ic.call(n,(function(){yc?fc.emit("rejectionHandled",e):bc("rejectionhandled",e,t.value)}))},Rc=function(e,t,r,n){return function(i){e(t,r,i,n)}},Ic=function(e,t,r,n){t.done||(t.done=!0,n&&(t=n),t.value=r,t.state=2,wc(e,t,!0))},Pc=function(e,t,r,n){if(!t.done){t.done=!0,n&&(t=n);try{if(e===r)throw cc("Promise can't be resolved itself");var i=Ec(r);i?$l((function(){var n={done:!1};try{i.call(r,Rc(Pc,e,n,t),Rc(Ic,e,n,t))}catch(r){Ic(e,n,r,t)}})):(t.value=r,t.state=1,wc(e,t,!1))}catch(r){Ic(e,{done:!1},r,t)}}};mc&&(lc=function(e){li(this,lc,oc),nr(e),Ql.call(this);var t=sc(this);try{e(Rc(Pc,this,t),Rc(Ic,this,t))}catch(e){Ic(this,t,e)}},(Ql=function(e){uc(this,{type:oc,done:!1,notified:!1,parent:!1,reactions:[],rejection:!1,state:0,value:void 0})}).prototype=yi(lc.prototype,{then:function(e,t){var r=_c(this),n=vc(ya(this,lc));return n.ok="function"!=typeof e||e,n.fail="function"==typeof t&&t,n.domain=yc?fc.domain:void 0,r.parent=!0,r.reactions.push(n),0!=r.state&&wc(this,r,!1),n.promise},catch:function(e){return this.then(void 0,e)}}),Zl=function(){var e=new Ql,t=sc(e);this.promise=e,this.resolve=Rc(Pc,e,t),this.reject=Rc(Ic,e,t)},tc.f=vc=function(e){return e===lc||e===Jl?new Zl(e):pc(e)},"function"==typeof gl&&(Kl=gl.prototype.then,G(gl.prototype,"then",(function(e,t){var r=this;return new lc((function(e,t){Kl.call(r,e,t)})).then(e,t)}),{unsafe:!0}),"function"==typeof dc&&Le({global:!0,enumerable:!0,forced:!0},{fetch:function(e){return rc(lc,dc.apply(n,arguments))}}))),Le({global:!0,wrap:!0,forced:mc},{Promise:lc}),rr(lc,oc,!1),mi(oc),Jl=ae(oc),Le({target:oc,stat:!0,forced:mc},{reject:function(e){var t=vc(this);return t.reject.call(void 0,e),t.promise}}),Le({target:oc,stat:!0,forced:mc},{resolve:function(e){return rc(this,e)}}),Le({target:oc,stat:!0,forced:kc},{all:function(e){var t=this,r=vc(t),n=r.resolve,i=r.reject,a=nc((function(){var r=nr(t.resolve),a=[],o=0,s=1;_i(e,(function(e){var u=o++,_=!1;a.push(void 0),s++,r.call(t,e).then((function(e){_||(_=!0,a[u]=e,--s||n(a))}),i)})),--s||n(a)}));return a.error&&i(a.value),r.promise},race:function(e){var t=this,r=vc(t),n=r.reject,i=nc((function(){var i=nr(t.resolve);_i(e,(function(e){i.call(t,e).then(r.resolve,n)}))}));return i.error&&n(i.value),r.promise}});var Sc=RegExp.prototype,Mc=Sc.toString,Lc=i((function(){return"/a/b"!=Mc.call({source:"a",flags:"b"})})),Dc="toString"!=Mc.name;(Lc||Dc)&&G(RegExp.prototype,"toString",(function(){var e=c(this),t=String(e.source),r=e.flags;return"/"+t+"/"+String(void 0===r&&e instanceof RegExp&&!("flags"in Sc)?Nu.call(e):r)}),{unsafe:!0});t((function(e){var t=function(e){var t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.asyncIterator||"@@asyncIterator",o=n.toStringTag||"@@toStringTag";function s(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{s({},"")}catch(e){s=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var i=t&&t.prototype instanceof c?t:c,a=Object.create(i.prototype),o=new b(n||[]);return a._invoke=function(e,t,r){var n="suspendedStart";return function(i,a){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw a;return T()}for(r.method=i,r.arg=a;;){var o=r.delegate;if(o){var s=k(o,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var u=_(e,t,r);if("normal"===u.type){if(n=r.done?"completed":"suspendedYield",u.arg===l)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n="completed",r.method="throw",r.arg=u.arg)}}}(e,r,o),a}function _(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var l={};function c(){}function h(){}function f(){}var d={};d[i]=function(){return this};var v=Object.getPrototypeOf,p=v&&v(v(x([])));p&&p!==t&&r.call(p,i)&&(d=p);var y=f.prototype=c.prototype=Object.create(d);function g(e){["next","throw","return"].forEach((function(t){s(e,t,(function(e){return this._invoke(t,e)}))}))}function m(e,t){var n;this._invoke=function(i,a){function o(){return new t((function(n,o){!function n(i,a,o,s){var u=_(e[i],e,a);if("throw"!==u.type){var l=u.arg,c=l.value;return c&&"object"==typeof c&&r.call(c,"__await")?t.resolve(c.__await).then((function(e){n("next",e,o,s)}),(function(e){n("throw",e,o,s)})):t.resolve(c).then((function(e){l.value=e,o(l)}),(function(e){return n("throw",e,o,s)}))}s(u.arg)}(i,a,n,o)}))}return n=n?n.then(o,o):o()}}function k(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,k(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=_(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var i=n.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function E(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function w(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function b(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function x(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:T}}function T(){return{value:void 0,done:!0}}return h.prototype=y.constructor=f,f.constructor=h,h.displayName=s(f,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===h||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,s(e,o,"GeneratorFunction")),e.prototype=Object.create(y),e},e.awrap=function(e){return{__await:e}},g(m.prototype),m.prototype[a]=function(){return this},e.AsyncIterator=m,e.async=function(t,r,n,i,a){void 0===a&&(a=Promise);var o=new m(u(t,r,n,i),a);return e.isGeneratorFunction(r)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},g(y),s(y,o,"Generator"),y[i]=function(){return this},y.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=x,b.prototype={constructor:b,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(w),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return o.type="throw",o.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],o=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var s=r.call(a,"catchLoc"),u=r.call(a,"finallyLoc");if(s&&u){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(s){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,l):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),w(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;w(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:x(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}));var Cc=[].join,Fc=K!=Object,Nc=To("join",",");Le({target:"Array",proto:!0,forced:Fc||!Nc},{join:function(e){return Cc.call(ee(this),void 0===e?",":e)}});var Oc="attribute vec4 a_position;\nattribute vec3 a_color;\n\nuniform mat4 u_obj_to_clip; // モデル座標系からクリップ座標系への変換\nuniform float u_point_size; // 点描画サイズ(負の場合は[m]、正の場合は[px])\n\nuniform float u_debug;      // デバッグ用パラメータ(正の場合のみ有効)\n\nvarying vec3 v_color;       // 色\n\n\nvoid main(void) {\n    gl_Position = u_obj_to_clip * a_position;\n\n    if ( u_point_size < 0.0 ) {\n        gl_PointSize = -u_point_size / gl_Position.w;\n    }\n    else {\n        gl_PointSize = u_point_size;\n    }\n\n    if ( u_debug < 0.0 ) {\n        v_color = a_color;\n    }\n    else {\n        float alpha = min( 1.0, u_debug );\n        v_color = vec3( alpha, 0.0, 1.0 - alpha );\n    }\n}\n",Uc="precision highp float;\n\n\nvarying vec3 v_color;       // 色\n\n\nvoid main(void) {\n#if POINT_SHAPE_TYPE == 0 // RECTANGLE\n    gl_FragColor = vec4( v_color,  1.0 );\n\n#elif POINT_SHAPE_TYPE == 1 // CIRCLE\n    if ( length( gl_PointCoord - 0.5 ) > 0.5 ) {\n        discard;\n    }\n    else {\n        gl_FragColor = vec4( v_color,  1.0 );\n    }\n\n#elif POINT_SHAPE_TYPE == 2 // CIRCLE_WITH_BORDER\n    float distance = length( gl_PointCoord - 0.5 );\n    if ( distance > 0.5 ) {\n        discard;\n    }\n    else if ( distance > 0.45 ) {\n        gl_FragColor = vec4( 0, 0, 0, 1.0 );\n    }\n    else {\n        gl_FragColor = vec4( v_color,  1.0 );\n    }\n\n#elif POINT_SHAPE_TYPE == 3 // GRADIENT_CIRCLE\n    vec2 p = 2.0 * gl_PointCoord - 1.0;\n    if ( length(p) > 1.0 ) {\n        discard;\n    }\n    else {\n        gl_FragColor = vec4( v_color * (1.0 - 0.3 * tan((p.x + p.y)*0.7853981633)),  1.0 );\n    }\n\n#endif\n}\n",Vc=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Ge(this,t);var i=t._getPreamble(n);return(r=Ke(this,He(t).call(this,e.glenv,i+Oc,i+Uc))).bindProgram(),r.setFloat("u_point_size",10),r.setFloat("u_debug",-1),r._local_to_clip=hs.createMatrixf(),r}return Ye(t,e),qe(t,[{key:"setPointSize",value:function(e){this.setFloat("u_point_size",e)}},{key:"setDebug",value:function(e){this.setFloat("u_debug",e)}},{key:"setDebugBoundsParameter",value:function(e,t){return Bc(e._gocs_to_clip,t,this._local_to_clip),this.setMatrix("u_obj_to_clip",this._local_to_clip),!0}}],[{key:"_getPreamble",value:function(e){var t=[],r=e.point_shape_type||jc.PointShapeType.CIRCLE;return t.push("#define POINT_SHAPE_TYPE "+r.shader_code),t.join("\n")+"\n\n"}}]),t}(G_),Bc=function(e,t,r){var n=e[0],i=e[4],a=e[8],o=e[12],s=e[1],u=e[5],_=e[9],l=e[13],c=e[2],h=e[6],f=e[10],d=e[14],v=e[3],p=e[7],y=e[11],g=e[15],m=t[0],k=t[1],E=t[2];return r[0]=n,r[1]=s,r[2]=c,r[3]=v,r[4]=i,r[5]=u,r[6]=h,r[7]=p,r[8]=a,r[9]=_,r[10]=f,r[11]=y,r[12]=n*m+i*k+a*E+o,r[13]=s*m+u*k+_*E+l,r[14]=c*m+h*k+f*E+d,r[15]=v*m+p*k+y*E+g,r},zc=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this,e.glenv,"attribute vec4 a_position;\n\nuniform mat4 u_obj_to_clip;\n\nvoid main(void) {\n    gl_Position = u_obj_to_clip * a_position;\n}\n","precision highp float;\n\nuniform vec3 u_color;\n\nvoid main(void) {\n    gl_FragColor = vec4(u_color, 1.0);\n}\n"))).bindProgram(),r._color=hs.createVector3([0,.2,.4]),r.setVector3("u_color",r._color),r._local_to_clip=hs.createMatrixf(),r}return Ye(t,e),qe(t,[{key:"setDebugBoundsParameter",value:function(e,t,r){return Bc(e._gocs_to_clip,t,this._local_to_clip),this.setMatrix("u_obj_to_clip",this._local_to_clip),r&&(this._color[0]=r[0],this._color[1]=r[1],this._color[2]=r[2]),this.setVector3("u_color",this._color),!0}}]),t}(G_),Gc=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this,e.glenv,"attribute vec4 a_position;\n\nuniform mat4 u_obj_to_clip;\nvarying vec4 pos;\n\nvoid main(void) {\n    pos = gl_Position;\n    gl_Position = u_obj_to_clip * a_position;\n}\n","precision highp float;\n\nuniform vec4 u_color;\nvarying vec4 pos;\n\nvoid main(void) {\n    // gl_FragCoord.x, gl_FragCoord.y\n    if (mod(gl_FragCoord.x, 3.0) < 1.0 && mod(gl_FragCoord.y, 3.0) < 1.0) {\n        gl_FragColor = vec4(u_color.x, u_color.y, u_color.z, 1.0);\n    }\n    else {\n        discard;\n    }\n}\n"))).bindProgram(),r._color=hs.createVector4([.3,.9,1,.5]),r.setVector4("u_color",r._color),r._local_to_clip=hs.createMatrixf(),r}return Ye(t,e),qe(t,[{key:"setDebugBoundsParameter",value:function(e,t,r){return Bc(e._gocs_to_clip,t,this._local_to_clip),this.setMatrix("u_obj_to_clip",this._local_to_clip),r&&(this._color[0]=r[0],this._color[1]=r[1],this._color[2]=r[2],this._color[3]=r[3]||0),this.setVector4("u_color",this._color),!0}}]),t}(G_),jc=function(){function e(t,r){Ge(this,e),this._glenv=t.glenv,this._scene=t,this._provider=r,this._root=Xc.createRoot(this),this._points_per_pixel=.7,this._point_shape=e.PointShapeType.CIRCLE,this._point_size_type=e.PointSizeType.FLEXIBLE,this._point_size=1,this._point_size_limit=10,this._dispersion=!0,this._debug_shader=!1,this._debug_render_box=!1,this._debug_render_ellipsoid=!1,this._debug_render_axis=!1,this._debug_render_section=!1,this._checkMaterials(),e._instances.push(this)}var t,r,n;return qe(e,[{key:"init",value:(n=ze(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._provider.init();case 2:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"destroy",value:(r=ze(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this._provider){t.next=3;break}return t.next=3,this._provider.destroy();case 3:if(!this._root){t.next=7;break}return t.next=6,this._root.dispose(null);case 6:this._root=null;case 7:-1!==(r=e._instances.indexOf(this))&&e._instances.splice(r,1),this._provider=null;case 10:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"getPointsPerPixel",value:function(){return this._points_per_pixel}},{key:"setPointsPerPixel",value:function(e){console.assert(e<=1),this._points_per_pixel=e}},{key:"getPointShape",value:function(){return this._point_shape}},{key:"setPointShape",value:function(e){this._point_shape=e}},{key:"getPointSizeType",value:function(){return this._point_size_type}},{key:"setPointSizeType",value:function(e){this._point_size_type=e}},{key:"getPointSize",value:function(){return this._point_size}},{key:"setPointSize",value:function(e){console.assert(e>0),this._point_size=e}},{key:"getPointSizeLimit",value:function(){return this._point_size_limit}},{key:"setPointSizeLimit",value:function(e){console.assert(e>0),this._point_size_limit=e}},{key:"getDispersion",value:function(){return this._dispersion}},{key:"setDispersion",value:function(e){this._dispersion=e}},{key:"getDebugShader",value:function(){return this._debug_shader}},{key:"setDebugShader",value:function(e){this._debug_shader=e}},{key:"setDebugRenderBox",value:function(e){this._debug_render_box=e,this._updateDebugMesh()}},{key:"setDebugRenderEllipsoid",value:function(e){this._debug_render_ellipsoid=e,this._updateDebugMesh()}},{key:"setDebugRenderAxis",value:function(e){this._debug_render_axis=e,this._updateDebugMesh()}},{key:"setDebugRenderSection",value:function(e){this._debug_render_section=e,this._updateDebugMesh()}},{key:"_updateDebugMesh",value:function(){this._root&&this._root._updateDebugMeshes()}},{key:"getURL",value:function(e,t,r,n){return this._urlGenerator(e,t,r,n)}},{key:"_checkMaterials",value:function(){var e=this._scene.viewer,t=e._render_cache||(e._render_cache={});t.point_cloud_materials||(t.point_cloud_materials=Object.keys(Yc).reduce((function(t,r){var n=Yc[r];return t[n.id]=new Vc(e,{point_shape_type:n}),t}),{})),t.point_cloud_debug_wire_material||(t.point_cloud_debug_wire_material=new zc(e)),t.point_cloud_debug_face_material||(t.point_cloud_debug_face_material=new Gc(e))}},{key:"_getMaterial",value:function(e){return this._scene.viewer._render_cache.point_cloud_materials[e.id]}},{key:"provider",get:function(){return this._provider}},{key:"root",get:function(){return this._root}}],[{key:"requestTraverseSummary",value:(t=ze(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t){e.getTraverseDataRequestQueue().push((function r(n){t(n);var i=e.getTraverseDataRequestQueue().indexOf(r);-1!==i&&e.getTraverseDataRequestQueue().splice(i,1)}))})));case 1:case"end":return t.stop()}}),t)}))),function(){return t.apply(this,arguments)})},{key:"getTraverseDataRequestQueue",value:function(){return e._traverseDataRequestQueue||(e._traverseDataRequestQueue=[])}},{key:"setStatisticsHandler",value:function(t){t&&(e._statistics={statistics_obj:new qc,statistics_handler:t})}},{key:"getStatistics",value:function(){return e._statistics}},{key:"getStatisticsHandler",value:function(){return e._statistics_handler}},{key:"PointShapeType",get:function(){return Yc}},{key:"PointSizeType",get:function(){return Hc}}]),e}();jc._instances=[];var qc=function(){function e(){Ge(this,e),this._now=performance?function(){return performance.now()}:function(){return Date.now()},this.clear()}return qe(e,[{key:"start",value:function(){this._start_time=this._now()}},{key:"doneTraverse",value:function(){this._done_traverse_time=this._now(),this.traverse_time+=this._done_traverse_time-this._start_time}},{key:"done",value:function(){this._done_time=this._now(),this.render_time+=this._done_time-this._done_traverse_time,this.total_time+=this._done_time-this._start_time}},{key:"clear",value:function(){this.render_point_count=0,this.total_point_count=0,this.render_boxes=0,this.total_boxes=0,this.loading_boxes=0,this.created_boxes=0,this.disposed_boxes=0,this.total_time=0,this.traverse_time=0,this.render_time=0}}]),e}(),Yc={RECTANGLE:{id:"RECTANGLE",shader_code:0},CIRCLE:{id:"CIRCLE",shader_code:1},CIRCLE_WITH_BORDER:{id:"CIRCLE_WITH_BORDER",shader_code:2},GRADIENT_CIRCLE:{id:"GRADIENT_CIRCLE",shader_code:3}},Hc={PIXEL:{id:"PIXEL"},MILLIMETERS:{id:"MILLIMETERS"},FLEXIBLE:{id:"FLEXIBLE"}},Xc=function(){function e(t,r,n,i,a){Ge(this,e),this._parent=t,this._owner=t?t._owner:null,this.level=r,this.x=n,this.y=i,this.z=a;var o=this.size=0===r?2147483648:r<31?1<<31-r:Math.pow(.5,r-31);this.proj_area=4*this.size*this.size,this.gocs_center=hs.createVector3([Qc+(2*n+1)*o,Qc+(2*i+1)*o,Qc+(2*a+1)*o]),this.gocs_min=hs.createVector3([this.gocs_center[0]-o,this.gocs_center[1]-o,this.gocs_center[2]-o]),this.gocs_max=hs.createVector3([this.gocs_center[0]+o,this.gocs_center[1]+o,this.gocs_center[2]+o]),this._status=e.Status.NOT_LOADED,this._metaInfo=null,this._children=[null,null,null,null,null,null,null,null],this.average=null,this.eigenVector=null,this.eigenVectorLength=null,this._vertex_buffer=null,this._vertex_length=null,this._vertex_attribs=null,this.debug1=null,this._owner&&this._updateDebugMesh()}return qe(e,[{key:"_updateDebugMeshes",value:function(){this._updateDebugMesh();for(var e=0;e<this._children.length;e++)this._children[e]&&this._children[e]._updateDebugMeshes()}},{key:"_updateDebugMesh",value:function(){var t=[],r=[],n=[];if(this._owner._debug_render_box){for(var i=0;i<e.CHILDREN_INDICES.length;i++)t.push(this.size*(2*e.CHILDREN_INDICES[i][2]-1),this.size*(2*e.CHILDREN_INDICES[i][1]-1),this.size*(2*e.CHILDREN_INDICES[i][0]-1));r.push(0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,3,7,2,6),n.push(0,2,1,1,2,3,4,5,6,7,6,5,0,1,4,1,5,4,1,3,5,3,7,5,3,6,7,3,2,6,6,2,4,2,0,4)}if(this.average&&!isNaN(this.eigenVector[0][0])){if(this._owner._debug_render_axis)for(var a=t.length/3,o=0;o<3;o++){for(var s=Math.max(.2,this.eigenVectorLength[o]),u=this.eigenVector[o],_=0;_<3;_++)t.push(this.average[_]-s*u[_]);for(var l=0;l<3;l++)t.push(this.average[l]+s*u[l]);r.push(a++,a++)}this._owner._debug_render_section&&this.level>20&&this.getPointsLength()>5e3&&this.eigenVectorLength[0]<.2*this.size&&this._putSectionShapePoints(t,r,n),this._owner._debug_render_ellipsoid&&this._putVariancePoints(t,r,n)}var c=[];if(r.length>0){var h={vtype:[{name:"a_position",size:3}],ptype:"lines",vertices:t,indices:r};c.push(new k_(this._owner._glenv,h))}if(n.length>0){var f={vtype:[{name:"a_position",size:3}],ptype:"triangles",vertices:t,indices:n};c.push(new k_(this._owner._glenv,f))}this.debugMesh=c}},{key:"_putVariancePoints",value:function(e,t,r){for(var n,i,a,o,s,u,_,l=this,c=e.length/3,h=et(this.eigenVector,3),f=h[0],d=h[1],v=h[2],p=et(this.eigenVectorLength,3),y=p[0],g=p[1],m=p[2],k=12,E=jc._variance_points_cache||function(){for(var e={cos_ro:[],sin_ro:[],cos_th:[],sin_th:[]},t=0;t<=6;++t){var r=Math.PI*t/6;e.cos_ro[t]=Math.cos(r),e.sin_ro[t]=Math.sin(r)}for(var n=0;n<=k;++n){var i=2*Math.PI*n/k;e.cos_th[n]=Math.cos(i),e.sin_th[n]=Math.sin(i)}return jc._variance_points_cache=e}(),w=0;w<=6;++w)for(var b=0;b<=k;++b)n=w,i=b,a=e,o=void 0,s=void 0,u=void 0,_=void 0,o=E.cos_ro[n],s=E.sin_ro[n],u=E.cos_th[i],_=E.sin_th[i],a.push(l.average[0]+s*(g*u*d[0]+m*_*v[0])+y*o*f[0],l.average[1]+s*(g*u*d[1]+m*_*v[1])+y*o*f[1],l.average[2]+s*(g*u*d[2]+m*_*v[2])+y*o*f[2]);for(var x=0;x<6;++x)for(var T=0;T<k;++T){var A=c+13*x+T;t.push(A,A+1,A,A+k+1),r.push(A,A+1,A+k+1,A+k+1,A+1,A+k+2)}}},{key:"_putSectionShapePoints",value:function(e,t,r){for(var n,i,a=e.length/3,o=this.average,s=this.eigenVector[0],u=this.size,_=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),l=[s[0]/_,s[1]/_,s[2]/_],c=[],h=[],f=0;f<2;++f)for(var d=0;d<2;++d)h.push({p:[f>0?u:-u,d>0?u:-u,0],v:[0,0,u]},{p:[d>0?u:-u,0,f>0?u:-u],v:[0,u,0]},{p:[0,f>0?u:-u,d>0?u:-u],v:[u,0,0]});for(var v=0;v<h.length;v++){var p=h[v].p,y=h[v].v,g=((o[0]-p[0])*l[0]+(o[1]-p[1])*l[1]+(o[2]-p[2])*l[2])/(y[0]*l[0]+y[1]*l[1]+y[2]*l[2]);if(Math.abs(g)<=1){var m=[p[0]+g*y[0],p[1]+g*y[1],p[2]+g*y[2]],k=[m[0]-o[0],m[1]-o[1],m[2]-o[2]],E=void 0;n?E=Math.atan2(i[0]*k[0]+i[1]*k[1]+i[2]*k[2],n[0]*k[0]+n[1]*k[1]+n[2]*k[2]):(E=0,n=[(i=[l[1]*k[2]-l[2]*k[1],l[2]*k[0]-l[0]*k[2],l[0]*k[1]-l[1]*k[0]])[1]*l[2]-i[2]*l[1],i[2]*l[0]-i[0]*l[2],i[0]*l[1]-i[1]*l[0]]),c.push([].concat(m,[E,k[0],k[1],k[2],n[0]*k[0]+n[1]*k[1]+n[2]*k[2],i[0]*k[0]+i[1]*k[1]+i[2]*k[2]]))}}c.sort((function(e,t){return e[3]-t[3]}));for(var w=0;w<c.length;++w)e.push(c[w][0],c[w][1],c[w][2]),t.push(a+w),w==c.length-1?t.push(a):t.push(a+w+1),r&&(r.push(a,a+w),w==c.length-1?r.push(a):r.push(a+w+1))}},{key:"getChildInfo",value:function(e){return this._metaInfo?this._metaInfo.children[e]:null}},{key:"cellPointsAvailable",value:function(e){return this._metaInfo&&(0===e?this._metaInfo.indices[e]>0:this._metaInfo.indices[e]>this._metaInfo.indices[e-1])}},{key:"getPointsLength",value:function(){return this._metaInfo?this._metaInfo.indices[7]:0}},{key:"indexOf",value:function(e){return this._children.indexOf(e)}},{key:"isInvisible",value:function(e){if(0===this.level)return!1;for(var t=this.gocs_min[0],r=this.gocs_max[0],n=this.gocs_min[1],i=this.gocs_max[1],a=this.gocs_min[2],o=this.gocs_max[2],s=0;s<e.length;++s){var u=e[s],_=u[0],l=u[1],c=u[2],h=u[3],f=_*t+l*n,d=_*r+l*n,v=_*t+l*i,p=_*r+l*i,y=-c*a-h,g=-c*o-h;if(f<y&&d<y&&v<y&&p<y&&f<g&&d<g&&v<g&&p<g)return!0}return!1}},{key:"load",value:function(){var t=this;if(this._status!==e.Status.NOT_LOADED)throw new Error("illegal status: "+this._status.id);if(this._owner._provider.isReady()){this._status=e.Status.LOADING;var r=this._owner._provider.load(this.level,this.x,this.y,this.z,!0);return this._loadId=r.id,r.done.then((function(r){t._metaInfo={children:[],indices:r.header.indices};for(var n=r.header.childFlags,i=7;i>=0;--i)t._metaInfo.children[i]=1&n?{}:null,n>>=1;t.average=r.header.average,t.eigenVector=r.header.eigenVector,t.eigenVectorLength=r.header.eigenVectorLength,t.debug1=r.header.debug1;var a=r.body;console.assert(a.length>0),console.assert(a.length/6===t._metaInfo.indices[7]);for(var o=a.length/6,s=0;s<8;++s)t._metaInfo.indices[s]>o&&(console.log("warning fix indices"),t._metaInfo.indices[s]=o);var u=t._owner._glenv.context;t._vertex_buffer=u.createBuffer(),t._vertex_length=a.length/6,u.bindBuffer(u.ARRAY_BUFFER,t._vertex_buffer),u.bufferData(u.ARRAY_BUFFER,a,u.STATIC_DRAW),u.bindBuffer(u.ARRAY_BUFFER,null),t._vertex_attribs={a_position:{buffer:t._vertex_buffer,num_components:3,component_type:u.FLOAT,normalized:!1,byte_stride:24,byte_offset:0},a_color:{buffer:t._vertex_buffer,num_components:3,component_type:u.FLOAT,normalized:!1,byte_stride:24,byte_offset:12}},t._status=e.Status.LOADED,t._updateDebugMesh()})).catch((function(r){"cancel"===r.message||"not loading"===r.message||"The user aborted a request."===r.message||r.is_aborted||(console.log(r),t._status=e.Status.DESTROYED)}))}}},{key:"newChild",value:function(t,r){var n=et(e.CHILDREN_INDICES[t],3),i=n[0],a=n[1],o=n[2];return this.newChildAt(i,a,o,r)}},{key:"newChildAt",value:function(t,r,n,i){console.assert(this._status===e.Status.LOADED);var a=t|r<<1|n<<2,o=this._children[a];return o||(this.getChildInfo(a)?(i&&i.created_boxes++,this._children[a]=new e(this,this.level+1,this.x<<1|t,this.y<<1|r,this.z<<1|n)):null)}},{key:"getChild",value:function(e){return this._children[e]}},{key:"_drawDebugMesh",value:function(t){if(this.debugMesh){var r=t._glenv.context,n=e.STATUS_COLOR_TABLE[this._status.id];r.disable(r.CULL_FACE);var i=!0,a=!1,o=void 0;try{for(var s,u=this.debugMesh[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value,l=1===_._draw_mode?this._owner._scene.viewer._render_cache.point_cloud_debug_wire_material:this._owner._scene.viewer._render_cache.point_cloud_debug_face_material;l.bindProgram(),l.setDebugBoundsParameter(t,this.gocs_center,n),_.draw(l)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}r.enable(r.CULL_FACE)}}},{key:"draw",value:function(t,r,n,i){if(this.debugMesh&&this._drawDebugMesh(t),this._status===e.Status.LOADED){var a=t._glenv.context,o=this._owner._point_shape,s=this._owner._point_size_type,u=this._owner._point_size,_=this._owner._point_size_limit,l=this._owner._debug_shader;if(this._status===e.Status.LOADED){var c=this._owner._getMaterial(o);c.bindProgram(),c.setDebugBoundsParameter(t,this.gocs_center),c.bindVertexAttribs(this._vertex_attribs);if(null===r){var h=n[0];c.setPointSize(s===jc.PointSizeType.PIXEL?u:s===jc.PointSizeType.MILLIMETERS?-.001*u/t._pixel_step:Math.min(_,Math.max(1,3/h))),c.setDebug(l?.5/h:-1),a.drawArrays(a.POINTS,0,this._vertex_length)}else for(var f=0;f<r.length;f++){var d=n[f];c.setPointSize(s===jc.PointSizeType.PIXEL?u:s===jc.PointSizeType.MILLIMETERS?-.001*u/t._pixel_step:Math.min(_,Math.max(1,3/d))),c.setDebug(l?.5/d:-1);var v=r[f],p=v>0?this._metaInfo.indices[v-1]:0,y=this._metaInfo.indices[v]-p;y>0&&a.drawArrays(a.POINTS,p,y)}if(a.bindBuffer(a.ARRAY_BUFFER,null),i)if(i.render_boxes++,r&&this._metaInfo.indices){var g=!0,m=!1,k=void 0;try{for(var E,w=r[Symbol.iterator]();!(g=(E=w.next()).done);g=!0){var b=E.value,x=b>0?this._metaInfo.indices[b-1]:0,T=this._metaInfo.indices[b]-x;i.render_point_count+=T}}catch(e){m=!0,k=e}finally{try{g||null==w.return||w.return()}finally{if(m)throw k}}}else i.render_point_count+=this._vertex_length}}}},{key:"disposeChildren",value:function(e){for(var t=0;t<this._children.length;t++)this._children[t]&&(this._children[t].dispose(e),this._children[t]=null)}},{key:"dispose",value:function(t){(this._status===e.Status.LOADING&&(this._abort_controller&&this._abort_controller.abort(),this._owner._provider.cancel(this._loadId)),this.disposeChildren(t),this._vertex_buffer)&&(this._owner._glenv.context.deleteBuffer(this._vertex_buffer),this._vertex_buffer=null);this.debugMesh,t&&t.disposed_boxes++,this._status=e.Status.DESTROYED}},{key:"toString",value:function(){return"Box-".concat(this.level,"-").concat(this.x,"-").concat(this.y,"-").concat(this.z)}},{key:"toTreeString",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return this._children.reduce((function(t,r){return t+(r?"\n"+r.toTreeString(e+"  "):"")}),e+this.toString())}},{key:"status",get:function(){return this._status}},{key:"is_loaded",get:function(){return this._status===e.Status.LOADED}},{key:"parent",get:function(){return this._parent}}],[{key:"createRoot",value:function(t){var r=new e(null,0,0,0,0);return r._owner=t,r}},{key:"Status",get:function(){return Wc}}]),e}();Xc.CHILDREN_INDICES=[[0,0,0],[1,0,0],[0,1,0],[1,1,0],[0,0,1],[1,0,1],[0,1,1],[1,1,1]];var Wc={NOT_LOADED:{id:"NOT_LOADED"},LOADING:{id:"LOADING"},LOADED:{id:"LOADED"},DESTROYED:{id:"DESTROYED"}};Xc.STATUS_COLOR_TABLE={},Xc.STATUS_COLOR_TABLE[Xc.Status.LOADED.id]=[0,.8,1,.5],Xc.STATUS_COLOR_TABLE[Xc.Status.DESTROYED.id]=[1,0,0],Xc.STATUS_COLOR_TABLE[Xc.Status.LOADING.id]=[1,1,0],Xc.STATUS_COLOR_TABLE[Xc.Status.NOT_LOADED.id]=[0,1,0];var Qc=1<<31,Zc=function(){function e(t,r,n){Ge(this,e),this._box=t,this._distance=r,this._target_children=[],this._points_per_pixel=[],this._parent_points_per_pixel=n}return qe(e,[{key:"pushRegion",value:function(e,t){if(null!==this._target_children){var r=this._target_children.indexOf(e);-1===r?(this._target_children.push(e),this._points_per_pixel.push(t)):(this._target_children[r]=e,this._points_per_pixel[r]=t)}}},{key:"setWholeRegion",value:function(e){this._target_children=null,this._points_per_pixel=[e]}},{key:"draw",value:function(e,t){this._box.draw(e,this._target_children,this._points_per_pixel,t)}},{key:"box",get:function(){return this._box}},{key:"distance",get:function(){return this._distance}},{key:"parent_points_per_pixel",get:function(){return this._parent_points_per_pixel}}]),e}(),Jc=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;Ge(this,e),this._setupViewVectors(t),this._setupClipPlanes(t),this._point_cloud_collection=t._point_cloud_collection,this._render_boxes=[],this._render_boxes_map=new Map,this._load_boxes=[],this._load_limit=r}return qe(e,[{key:"_setupViewVectors",value:function(e){var t=e._view_to_gocs,r=e._pixel_step,n=hs.createVector3(),i=hs.createVector3();n[0]=t[12],n[1]=t[13],n[2]=t[14],i[0]=-t[8]*r,i[1]=-t[9]*r,i[2]=-t[10]*r,this._view_pos_Q=n,this._view_dir_wU=i}},{key:"_setupClipPlanes",value:function(e){var t=e._view_to_gocs,r=e._gocs_to_view;this.volume_planes=e._volume_planes;var n=[],i=e._viewer._globe.root_flake,a=hs.EARTH_RADIUS+i.height_min,o=hs.EARTH_RADIUS+i.height_max,s=t[12],u=t[13],_=t[14],l=s*s+u*u+_*_,c=a*a,h=o*o,f=Math.sqrt((l-c)*(h-c))-c,d=hs.createVector4(),v=1/Math.sqrt(l);d[0]=s*v,d[1]=u*v,d[2]=_*v,d[3]=f*v;for(var p=Math.sqrt(l+h+2*f),y=0;y<6;++y){var g=this.volume_planes[y],m=hs.createVector4();1==y&&g[3]>p&&((g=hs.createVector4(g))[3]=p),hs.transformPlane_A(r,g,m),n.push(m)}this._clip_planes=n}},{key:"traverse",value:function(e,t){return this._points_per_pixel=e.getPointsPerPixel(),this._dispersion=e.getDispersion(),this._statistics=t,this._updateBox(e.root,0),{visible_boxes:this._render_boxes,load_boxes:this._load_boxes}}},{key:"_updateBox",value:function(e,t){var r,n;if(this._statistics&&(this._statistics.total_boxes++,e.status===Xc.Status.LOADING&&this._statistics.loading_boxes++,e.getPointsLength()&&(this._statistics.total_point_count+=e.getPointsLength())),e.isInvisible(this._clip_planes))e.disposeChildren(this._statistics);else if((n=e.is_loaded?(r=this._calcPointsPerPixel(e))<this._points_per_pixel?Kc.LOAD_NEXT_LEVEL:Kc.UNLOAD_NEXT_LEVEL:Kc.KEEP_STATUS)!==Kc.LOAD_NEXT_LEVEL)n===Kc.UNLOAD_NEXT_LEVEL&&e.disposeChildren(this._statistics),e.status!==Xc.Status.DESTROYED&&(this._pushBox(e,null,r,t),e.status!==Xc.Status.LOADING&&e.status!==Xc.Status.NOT_LOADED||e.level>1&&this._pushBox(e.parent,e.parent.indexOf(e),t,t));else{this._collectNextLevel(e,r);for(var i=0;i<8;i++)e.cellPointsAvailable(i)&&!e.getChild(i)&&this._pushBox(e,i,r,t)}}},{key:"_calcPointsPerPixel",value:function(e){var t;if(e.eigenVectorLength[0]<.8*e.size&&this._dispersion&&e.eigenVectorLength[0]>0){var r=hs.normalize3(this._view_dir_wU,hs.createVector3f()),n=et(e.eigenVector,3),i=n[0],a=n[1],o=n[2],s=et(e.eigenVectorLength,3),u=s[0],_=s[1],l=s[2],c=[hs.dot3(a,r),hs.dot3(i,r),hs.dot3(o,r)],h=c[0]*c[0]/(_*_)+c[2]*c[2]/(l*l),f=[h*l*u/_*c[0],h*_*l/u*c[1],h*u*_/l*c[2]];hs.normalize3(f,f);var d=(f[0]*c[0]+f[1]*c[1]+f[2]*c[2])*(Math.PI*u*_*l/Math.sqrt(f[0]*f[0]*_*_+f[1]*f[1]*u*u+f[2]*f[2]*l*l)),v=Math.min(Math.max(d,.05*e.proj_area),e.proj_area);t=Math.sqrt(e.getPointsLength()/v)}else t=64/e.size;var p=[e.gocs_center[0]+e.average[0]-this._view_pos_Q[0],e.gocs_center[1]+e.average[1]-this._view_pos_Q[1],e.gocs_center[2]+e.average[2]-this._view_pos_Q[2]];return hs.dot3(this._view_dir_wU,p)*t}},{key:"_pushBox",value:function(e,t,r,n){var i=this._render_boxes_map.get(e);if(i)null===t?i.setWholeRegion(r):i.pushRegion(t,r);else{var a=e.is_loaded?[e.gocs_center[0]+e.average[0]-this._view_pos_Q[0],e.gocs_center[1]+e.average[1]-this._view_pos_Q[1],e.gocs_center[2]+e.average[2]-this._view_pos_Q[2]]:[e.gocs_center[0]-this._view_pos_Q[0],e.gocs_center[1]-this._view_pos_Q[1],e.gocs_center[2]-this._view_pos_Q[2]],o=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);i=new Zc(e,o,n),null===t?i.setWholeRegion(r):i.pushRegion(t,r),this._render_boxes.push(i),this._render_boxes_map.set(e,i),e.status===Xc.Status.NOT_LOADED&&this._pushLoadBox(i)}}},{key:"_pushLoadBox",value:function(e){var t=this._binarySearch(this._load_boxes,e,(function(e,t){return e.parent_points_per_pixel<t.parent_points_per_pixel}));-1===t?this._load_boxes.push(e):this._insert_with_limit(this._load_boxes,t,e,this._load_limit)}},{key:"_insert_with_limit",value:function(e,t,r,n){if(void 0===n||n-e.length>0)e.splice(t,0,r);else{if(t===e.length)return;for(var i=e.length-1;i>t;i--)e[i]=e[i-1];e[t]=r}}},{key:"_binarySearch",value:function(e,t,r){return 0===e.length?-1:r(t,e[0])?0:r(e[e.length-1],t)?e.length:1===e.length?e.length:this._binarySearchInner(e,t,r,0,e.length-1)}},{key:"_binarySearchInner",value:function(e,t,r,n,i){if(i-n==1)return i;var a=.5*(n+i)|0;return r(e[a],t)?n=a:i=a,this._binarySearchInner(e,t,r,n,i)}},{key:"_collectNextLevel",value:function(e,t){for(var r,n=0;n<8;n++)(r=e.newChild(n,this._statistics))&&this._updateBox(r,t)}}]),e}(),Kc={LOAD_NEXT_LEVEL:1,KEEP_STATUS:0,UNLOAD_NEXT_LEVEL:-1},$c=[].slice,eh={},th=function(e,t,r){if(!(t in eh)){for(var n=[],i=0;i<t;i++)n[i]="a["+i+"]";eh[t]=Function("C,a","return new C("+n.join(",")+")")}return eh[t](e,r)},rh=Function.bind||function(e){var t=nr(this),r=$c.call(arguments,1),n=function(){var i=r.concat($c.call(arguments));return this instanceof n?th(t,i.length,i):t.apply(e,i)};return o(t.prototype)&&(n.prototype=t.prototype),n};Le({target:"Function",proto:!0},{bind:rh});var nh=function(){function e(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};Ge(this,e),this._glenv=t,this._width=r,this._height=n,this._options=i;var a=this._buildBuffers(i),o=a.frame_buffer,s=a.color_containers,u=a.depth_container;this._frame_buffer=o,this._color_containers=s,this._depth_container=u}return qe(e,[{key:"_buildBuffers",value:function(t){var r={},n=this._width,i=this._height,a=this._glenv.context,o=r.frame_buffer=a.createFramebuffer();if(a.bindFramebuffer(a.FRAMEBUFFER,o),r.color_containers=t.color_containers.map((function(t,r){var o=t.type||e.ContainerType.RENDER_BUFFER,s=t.options||{};if(o===e.ContainerType.RENDER_BUFFER){var u=a.createRenderbuffer();return a.bindRenderbuffer(a.RENDERBUFFER,u),a.renderbufferStorage(a.RENDERBUFFER,s.internal_format,n,i),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0+r,a.RENDERBUFFER,u),u}var _=a.createTexture();return a.bindTexture(a.TEXTURE_2D,_),a.texImage2D(a.TEXTURE_2D,0,s.internal_format,n,i,0,s.format,s.type,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0+r,a.TEXTURE_2D,_,0),_})),t.depth_container){var s=t.depth_container.type||e.ContainerType.RENDER_BUFFER,u=t.depth_container.options||{};if(s===e.ContainerType.RENDER_BUFFER){var _=r.depth_container=a.createRenderbuffer();a.bindRenderbuffer(a.RENDERBUFFER,_),a.renderbufferStorage(a.RENDERBUFFER,u.internal_format,n,i),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,_)}else{var l=r.depth_container=a.createTexture();a.bindTexture(a.TEXTURE_2D,l),a.texImage2D(a.TEXTURE_2D,0,u.internal_format,n,i,0,u.format,u.type,null),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.framebufferTexture2D(a.FRAMEBUFFER,t.depth_container.attach_type,a.TEXTURE_2D,l,0)}}if(a.checkFramebufferStatus(a.FRAMEBUFFER)!==a.FRAMEBUFFER_COMPLETE)throw new Error("ERROR: "+a.checkFramebufferStatus(a.FRAMEBUFFER));return a.bindTexture(a.TEXTURE_2D,null),a.bindFramebuffer(a.FRAMEBUFFER,null),r}},{key:"dispose",value:function(){var e=this;this._glenv.context.deleteFramebuffer(this._frame_buffer),this._frame_buffer=null,this._color_containers.forEach((function(t){e._delete_container(t)})),this._color_containers=[],this._delete_container(container,this._depth_container),this._depth_container=null}},{key:"_delete_container",value:function(e){var t=this._glenv.context;e instanceof WebGLTexture?t.deleteTexture(e):e instanceof WebGLRenderbuffer&&t.deleteRenderbuffer(e)}},{key:"getColorContainer",value:function(e){return this._color_containers[e]}},{key:"bind",value:function(){if(e.active_frame_buffer)throw new Error("Invalid status: already bound");var t=this._glenv.context;t.bindFramebuffer(t.FRAMEBUFFER,this._frame_buffer),e.active_frame_buffer=this}},{key:"unbind",value:function(){if(e.active_frame_buffer!==this)throw new Error("Invalid status");var t=this._glenv.context;t.bindFramebuffer(t.FRAMEBUFFER,null),e.active_frame_buffer=null}},{key:"frame_buffer",get:function(){return this._frame_buffer}},{key:"color_container",get:function(){return this._color_containers[0]}},{key:"color_container_length",get:function(){return this._color_containers.length}},{key:"depth_container",get:function(){return this._depth_container}}]),e}();nh.active_frame_buffer=null;nh.ContainerType={RENDER_BUFFER:{id:"RENDER_BUFFER"},TEXTURE:{id:"TEXTURE"}};for(var ih="/**\n * 深度描画用シェーダ (頂点シェーダ)\n */\n\nattribute vec3 a_position;\n\n\nvoid\nmain( void ) {\n    gl_Position = vec4( a_position, 1.0 );\n}\n",ah="// define PASS_BASE 0 or 1 JS側で指定される\n\n/**\n * 深度描画用シェーダ (フラグメントシェーダ)\n */\n\nuniform highp sampler2D u_sampler;\n\nvoid\nmain( void ) {\n    highp float fdepth = texture2D( u_sampler, vec2( 0.5, 0.5 ) ).r; // r:[0.0-1.0](24bit), g:0.0, b:0.0, a:1.0\n\n    /* 疑似コード PASS_BASEは0か4を想定\n    int n[8];  // 各 n[i] の値は範囲 [0, 7], ただし n[0] は [0, 8]\n    for ( int i = 0; i < 8; ++i ) {\n        n[i] = 0;\n        for ( int w = (i == 0 ? 3 : 2); w >= 0; --w ) {\n            if ( fdepth >= 1.0 ) {\n                n[i] += (1 << w);\n                fdepth = fract( fdepth );\n            }\n            fdepth *= 2.0;\n        }\n    }\n\n    gl_FragColor = vec4( n[PASS_BASE + 0],\n        n[PASS_BASE + 1],\n        n[PASS_BASE + 2],\n        n[PASS_BASE + 3]\n    ) / NMAX;\n    */\n\n#if PASS_BASE == 1\n    for ( int i=0; i<12; i++ ) {\n        fdepth = fract( fdepth * 2.0 );\n    }\n#endif // PASS_BASE\n\n    highp vec4 v;\n\n    int n = 0;\n    if ( fdepth >= 1.0 ) { n += 0x8; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    if ( fdepth >= 1.0 ) { n += 0x4; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    if ( fdepth >= 1.0 ) { n += 0x2; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    if ( fdepth >= 1.0 ) { n += 0x1; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    v[0] = float(n) / 15.0;\n\n    n = 0;\n    if ( fdepth >= 1.0 ) { n += 0x4; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    if ( fdepth >= 1.0 ) { n += 0x2; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    if ( fdepth >= 1.0 ) { n += 0x1; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    v[1] = float(n) / 15.0;\n\n    n = 0;\n    if ( fdepth >= 1.0 ) { n += 0x4; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    if ( fdepth >= 1.0 ) { n += 0x2; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    if ( fdepth >= 1.0 ) { n += 0x1; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    v[2] = float(n) / 15.0;\n\n    n = 0;\n    if ( fdepth >= 1.0 ) { n += 0x4; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    if ( fdepth >= 1.0 ) { n += 0x2; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    if ( fdepth >= 1.0 ) { n += 0x1; fdepth = fract( fdepth ); } fdepth *= 2.0;\n    v[3] = float(n) / 15.0;\n\n    gl_FragColor = v;\n}\n",oh=function(){function e(t){Ge(this,e),this._glenv=t;var r=this._glenv.context;this._camera=new _u({width:1,height:1}),this._frame_buffer=new nh(this._glenv,1,1,{color_containers:[{type:nh.ContainerType.RENDER_BUFFER,options:{internal_format:r.RGBA4}}],depth_container:{type:nh.ContainerType.TEXTURE,attach_type:r.DEPTH_STENCIL_ATTACHMENT,options:{internal_format:r.DEPTH_STENCIL,format:r.DEPTH_STENCIL,type:t.WEBGL_depth_texture.UNSIGNED_INT_24_8_WEBGL}}}),this._depth_to_color_frame_buffer=new nh(this._glenv,1,1,{color_containers:[{type:nh.ContainerType.RENDER_BUFFER,options:{internal_format:r.RGBA4}}]}),this._depth_to_color_materials=[new G_(this._glenv,ih,ch+"\n\n"+ah),new G_(this._glenv,ih,hh+"\n\n"+ah)];var n=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,n),r.bufferData(r.ARRAY_BUFFER,new Float32Array([-1,1,-1,-1,1,-1,1,1]),r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null);var i=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,i),r.bufferData(r.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,0,1,1]),r.STATIC_DRAW),r.bindBuffer(r.ARRAY_BUFFER,null);var a=[0,1,2,0,2,3];this._indices_length=a.length,this._index_buf=r.createBuffer(),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this._index_buf),r.bufferData(r.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),r.STATIC_DRAW),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null),this._vertex_attribs={a_position:{buffer:n,num_components:2,component_type:r.FLOAT,normalized:!1,byte_stride:0,byte_offset:0},a_texcoord:{buffer:i,num_components:2,component_type:r.FLOAT,normalized:!1,byte_stride:0,byte_offset:0}},this._rid_value=new Uint8Array(4),this._depth_value=new Uint8Array(4)}return qe(e,[{key:"pickCamera",value:function(e){var t=e.canvas_size.width,r=e.canvas_size.height;this._camera.copyViewParameters(e);var n=e.fov*hs.DEGREE/2,i=Math.atan(Math.sqrt(2)*Math.tan(n)/Math.sqrt(t*t+r*r));return this._camera.fov=2*i/hs.DEGREE,this._camera}},{key:"beforeRender",value:function(){this._frame_buffer.bind()}},{key:"afterRender",value:function(){this._frame_buffer.unbind()}},{key:"renderCanceled",value:function(){this._frame_buffer.unbind()}},{key:"readRid",value:function(){var e,t,r=this._glenv.context,n=Date.now();this._frame_buffer.bind(),e=Date.now(),r.readPixels(0,0,1,1,r.RGBA,r.UNSIGNED_BYTE,this._rid_value),t=Date.now();var i=Math.round(sh[0]*Math.round(this._rid_value[0]/17)+sh[1]*Math.round(this._rid_value[1]/17)+sh[2]*Math.round(this._rid_value[2]/17)+sh[3]*Math.round(this._rid_value[3]/17));this._frame_buffer.unbind();var a=Date.now();return a-n>7&&console.log("Render and Read Index: "+(a-n)+"ms gl.readPixels:"+(t-e)+"ms"),i}},{key:"readDepth",value:function(e,t){var r,n,i=this._glenv.context,a=Date.now();this._depth_to_color_frame_buffer.bind();var o=0;i.viewport(0,0,1,1);for(var s=0;s<2;s++){var u=this._depth_to_color_materials[s];u.bindProgram(),u.bindVertexAttribs(this._vertex_attribs),u.setInteger("u_sampler",0),u.bindTexture2D(0,this._frame_buffer.depth_container),i.depthFunc(i.ALWAYS),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this._index_buf),i.drawElements(i.TRIANGLES,this._indices_length,i.UNSIGNED_SHORT,0),i.bindTexture(i.TEXTURE_2D,null),r=Date.now(),i.readPixels(0,0,1,1,i.RGBA,i.UNSIGNED_BYTE,this._depth_value),n=Date.now();for(var _=_h[s],l=0;l<4;l++)o+=_[l]*this._depth_value[l]}this._depth_to_color_frame_buffer.unbind(),o=2*o-1;var c=e,h=[c[8]/c[0],c[9]/c[5],-1,(o+c[10])/c[14]],f=t,d=f[3]*h[0]+f[7]*h[1]+f[11]*h[2]+f[15]*h[3],v=hs.createVector3([(f[0]*h[0]+f[4]*h[1]+f[8]*h[2]+f[12]*h[3])/d,(f[1]*h[0]+f[5]*h[1]+f[9]*h[2]+f[13]*h[3])/d,(f[2]*h[0]+f[6]*h[1]+f[10]*h[2]+f[14]*h[3])/d]),p=Date.now();return p-a>7&&console.log("Render and Read Depth: "+(p-a)+"ms gl.readPixels:"+(n-r)+"ms"),v}}]),e}(),sh=[],uh=0;uh<4;uh++)sh[uh]=Math.pow(16,3-uh);for(var _h=[[],[]],lh=0;lh<4;lh++)_h[0][lh]=Math.pow(2,-3*(lh+1))/17,_h[1][lh]=Math.pow(2,-3*(lh+5))/17;var ch="#define PASS_BASE 0",hh="#define PASS_BASE 1",fh={SCENE:{id:"SCENE"},RID:{id:"RID"}},dh=function(){function e(t,r,n){if(Ge(this,e),this._viewer=t,this._glenv=t.glenv,this._width=r.canvas_size.width,this._height=r.canvas_size.height,0!==this._width&&0!==this._height){this._setupBasicMatrices(n,r),this._volume_planes=n.volume_planes,this._pixel_step=n.pixel_step,this._scene=t.scene,this._globe=t.globe,this._tile_texture_cache=t.tile_texture_cache,this._point_cloud_collection=t.point_cloud_collection,this._flake_material=null,this._flake_list=null,this._translucent_mode=!1;var i=t._render_cache||(t._render_cache={});i.surface_material||(i.surface_material=new il(t),i.surface_pick_material=new il(t,{ridMaterial:!0}),i.wireframe_material=new al(t)),this._debug_stats=t.debug_stats}else this._rendering_cancel=!0}return qe(e,[{key:"getTranslucentMode",value:function(){return this._translucent_mode}},{key:"setTranslucentMode",value:function(e){this._translucent_mode=e}},{key:"_setupBasicMatrices",value:function(e,t){this._view_to_gocs=t.view_to_gocs,this._gocs_to_view=hs.createMatrix(),hs.inverse_A(this._view_to_gocs,this._gocs_to_view),this._view_to_clip=e.view_to_clip,this._gocs_to_clip=hs.createMatrix(),hs.mul_PzA(this._view_to_clip,this._gocs_to_view,this._gocs_to_clip)}},{key:"getRenderTarget",value:function(){throw new Error("not implemented")}},{key:"onPushPrimitive",value:function(e,t){}},{key:"render",value:function(){throw new Error("not implemented")}},{key:"_render",value:function(){var e=this._glenv.context;if(e.viewport(0,0,this._width,this._height),e.clearColor(0,0,0,1),e.depthMask(!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),!this._rendering_cancel)if(this._globe.status===L_.Status.READY){e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ZERO,e.ONE),e.depthFunc(e.LEQUAL);var t=new B_(this);this._flake_list=t.traverse();var r=this._viewer.getVisibility(iy.Category.GROUND),n=this._viewer.getVisibility(iy.Category.ENTITY);this._prepare_draw_flake();var i=!0,a=!1,o=void 0;try{for(var s,u=this._flake_list[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value,l=_.getRenderObject();r&&this._draw_flake_base(_,l.getBaseMesh()),n&&this._draw_entities_on_flake(l)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}this._draw_point_cloud(),n&&this._scene.draw(this)}else this._rendering_cancel=!0}},{key:"_prepare_draw_flake",value:function(){var e=this._scene.getFlakePrimitiveProducers();this._globe.putNextEntityProducers(e)}},{key:"_draw_flake_base",value:function(e,t){var r=this._glenv.context,n=this._flake_material;n.bindProgram();var i=n.numDrawings();n.setFlakeParameter(this,e,t,0)&&(r.disable(r.BLEND),r.depthMask(!0),t.draw(n));for(var a=1;a<i;++a)n.setFlakeParameter(this,e,t,a)&&(this.getRenderTarget()===fh.SCENE&&r.enable(r.BLEND),r.depthMask(!1),t.draw(n));var o=this._debug_stats;null!==o&&(o.num_drawing_flake_vertices+=t.num_vertices)}},{key:"_draw_entities_on_flake",value:function(e){var t=e.num_entities;if(0!=t){var r,n=this._glenv.context;n.enable(n.POLYGON_OFFSET_FILL),n.depthMask(!1),n.polygonOffset(-8,-8),this.getRenderTarget()===fh.SCENE?r=function(e){e?n.enable(n.BLEND):n.disable(n.BLEND)}:(n.disable(n.BLEND),r=function(){});for(var i=0;i<t;++i){var a=e.getEntityPrimitive(i,this),o=a.primitive,s=a.entity;r(o.isTranslucent(this)),this.onPushPrimitive(o,s),o.draw(this)}n.depthMask(!0),n.disable(n.POLYGON_OFFSET_FILL)}}},{key:"_draw_point_cloud",value:function(){}}]),e}(),vh=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this,e,e.camera,e.camera.createRenderInfo())))._flake_material=e.render_mode===iy.RenderMode.WIREFRAME?e._render_cache.wireframe_material:e._render_cache.surface_material,r}return Ye(t,e),qe(t,[{key:"getRenderTarget",value:function(){return fh.SCENE}},{key:"render",value:function(){if(this._render(),!this._rendering_cancel){var e=this._debug_stats;null!==e&&(e.num_drawing_flakes=this._flake_list.length),this._globe.endFrame(),this._tile_texture_cache.endFrame(),this._viewer.layers.endFrame()}}},{key:"_draw_point_cloud",value:function(){var e=jc.getTraverseDataRequestQueue(),t=0===e.length?null:[],r=jc.getStatistics()||{};r.statistics_obj&&r.statistics_obj.clear();for(var n=0;n<this._point_cloud_collection.length;++n){r.statistics_obj&&r.statistics_obj.start();var i=this._point_cloud_collection.get(n),a=Math.max(0,10-i.provider.getNumberOfRequests()),o=new Jc(this,a).traverse(i,r.statistics_obj);if(r.statistics_obj&&r.statistics_obj.doneTraverse(),i.provider.isReady()){var s=!0,u=!1,_=void 0;try{for(var l,c=o.load_boxes[Symbol.iterator]();!(s=(l=c.next()).done);s=!0){l.value.box.load()}}catch(e){u=!0,_=e}finally{try{s||null==c.return||c.return()}finally{if(u)throw _}}}var h=!0,f=!1,d=void 0;try{for(var v,p=o.visible_boxes[Symbol.iterator]();!(h=(v=p.next()).done);h=!0){v.value.draw(this,r.statistics_obj)}}catch(e){f=!0,d=e}finally{try{h||null==p.return||p.return()}finally{if(f)throw d}}i.provider.flushQueue(),t&&t.push({point_cloud:i,pcb_collection:o.visible_boxes}),r.statistics_obj&&r.statistics_obj.done()}if(t)for(var y=0;y<e.length;y++)e[y](t);r.statistics_handler&&r.statistics_handler(r.statistics_obj)}}]),t}(dh),ph=function(e){function t(e,r){var n;Ge(this,t);var i=e.pick_tool_cache||(e.pick_tool_cache=new oh(e.glenv)),a=i.pickCamera(e.camera,r),o=a.createRenderInfo(+r[0]-e.camera.canvas_size.width/2,-r[1]+e.camera.canvas_size.height/2);return(n=Ke(this,He(t).call(this,e,a,o)))._flake_material=e._render_cache.surface_pick_material,n._pick_tool=i,n._rid_map=[null],n._pick_result={},n}return Ye(t,e),qe(t,[{key:"onPushPrimitive",value:function(e,t){e.rid=this._rid_map.length,this._rid_map.push(t)}},{key:"getRenderTarget",value:function(){return fh.RID}},{key:"render",value:function(){var e=this._pick_tool;e.beforeRender();var t=this._glenv.context;if(t.disable(t.DITHER),this._render(),t.enable(t.DITHER),this._rendering_cancel)e.renderCanceled();else{e.afterRender();var r=e.readRid();if(r>0){var n=this._rid_map[r];n instanceof I_&&(this._pick_result.entity=n)}this._pick_result.point=e.readDepth(this._view_to_clip,this._view_to_gocs)}}},{key:"pick_result",get:function(){return this._pick_result}}]),t}(dh),yh={OMIT:{id:"OMIT",credentials:"omit"},SAME_ORIGIN:{id:"SAME_ORIGIN",credentials:"same-origin"},INCLUDE:{id:"INCLUDE",credentials:"include"}},gh=function(e){function t(e,r,n,i,a,o){var s,u,_;return Ge(this,t),(s=Ke(this,He(t).call(this)))._prefix=e,s._suffix=r,s._size=n,s._min_level=i,s._max_level=a,o&&o.coord_order&&(o.coord_order===mh.ZYX?u=function(e,t,r){return e+"/"+r+"/"+t}:o.coord_order===mh.XYZ&&(u=function(e,t,r){return t+"/"+r+"/"+e})),u||(u=function(e,t,r){return e+"/"+t+"/"+r}),o&&o.coord_system&&o.coord_system===kh.LOWER_LEFT&&(_=function(e,t,r){var n=Math.round(Math.pow(2,e));return u(e,t,n-r-1)}),_||(_=u),s._coords_part=_,s._crossOrigin="anonymous",o&&o.credentials&&(o.credentials===yh.OMIT?s._crossOrigin=null:o.credentials===yh.INCLUDE&&(s._crossOrigin="use-credentials")),s}return Ye(t,e),qe(t,[{key:"requestTile",value:function(e,t,r,n){var i=new Image;return i.onload=function(){n(i)},i.onerror=function(){n(null)},null!==this._crossOrigin&&(i.crossOrigin=this._crossOrigin),i.src=this._makeURL(e,t,r),i}},{key:"cancelRequest",value:function(e){}},{key:"getImageSize",value:function(){return this._size}},{key:"getZoomLevelRange",value:function(){return new q_.Range(this._min_level,this._max_level)}},{key:"_makeURL",value:function(e,t,r){return this._prefix+this._coords_part(e,t,r)+this._suffix}}]),t}(q_),mh={ZXY:{id:"ZXY"},ZYX:{id:"ZYX"},XYZ:{id:"XYZ"}},kh={UPPER_LEFT:{id:"UPPER_LEFT"},LOWER_LEFT:{id:"LOWER_LEFT"}};gh.CoordOrder=mh,gh.CoordSystem=kh;var Eh=Object.assign,wh=Object.defineProperty,bh=!Eh||i((function(){if(a&&1!==Eh({b:1},Eh(wh({},"a",{enumerable:!0,get:function(){wh(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var e={},t={},r=Symbol();return e[r]=7,"abcdefghijklmnopqrst".split("").forEach((function(e){t[e]=e})),7!=Eh({},e)[r]||"abcdefghijklmnopqrst"!=ot(Eh({},t)).join("")}))?function(e,t){for(var r=Gt(e),n=arguments.length,i=1,o=Ee.f,s=W.f;n>i;)for(var u,_=K(arguments[i++]),l=o?ot(_).concat(o(_)):ot(_),c=l.length,h=0;c>h;)u=l[h++],a&&!s.call(_,u)||(r[u]=_[u]);return r}:Eh;Le({target:"Object",stat:!0,forced:Object.assign!==bh},{assign:bh});var xh=function(){function e(){Ge(this,e)}return qe(e,[{key:"requestTile",value:function(e,t,r,n){throw new Error("mapray.DemProvider#requestTile() method has not been overridden.")}},{key:"cancelRequest",value:function(e){throw new Error("mapray.DemProvider#cancelRequest() method has not been overridden.")}},{key:"getResolutionPower",value:function(){return 8}}]),e}(),Th=function(e){function t(e,r,n){var i;Ge(this,t);var a=n||{};return(i=Ke(this,He(t).call(this)))._prefix=e,i._suffix=r,i._credentials=(a.credentials||yh.OMIT).credentials,i._headers=Object.assign({},a.headers),i}return Ye(t,e),qe(t,[{key:"requestTile",value:function(e,t,r,n){var i=new AbortController;return fetch(this._makeURL(e,t,r),{credentials:this._credentials,headers:this._headers,signal:i.signal}).then((function(e){return e.ok?e.arrayBuffer():Promise.reject(Error(e.statusText))})).then((function(e){n(e)})).catch((function(){n(null)})),i}},{key:"cancelRequest",value:function(e){e.abort()}},{key:"_makeURL",value:function(e,t,r){return this._prefix+e+"/"+t+"/"+r+this._suffix}}]),t}(xh),Ah=function(){function e(t,r){Ge(this,e),this._owner=t,this._glenv=t.glenv;var n=r instanceof q_?{image_provider:r}:r;this._image_provider=n.image_provider,this._visibility=n.visibility||!0,this._opacity=n.opacity||1,this._tile_cache=new Q_(this._glenv,this._image_provider),this._image_provider.status((function(e){t.dirtyDrawingLayers()}))}return qe(e,[{key:"setImageProvider",value:function(e){var t=this;this._image_provider!==e&&(this._owner.dirtyDrawingLayers(),e.status((function(e){t._owner.dirtyDrawingLayers()}))),this._image_provider=e,this._tile_cache.cancel(),this._tile_cache=new Q_(this._glenv,e)}},{key:"setVisibility",value:function(e){this._visibility!=e&&this._owner.dirtyDrawingLayers(),this._visibility=e}},{key:"setOpacity",value:function(e){this._opacity=e}},{key:"image_provider",get:function(){return this._image_provider}},{key:"visibility",get:function(){return this._visibility}},{key:"opacity",get:function(){return this._opacity}},{key:"tile_cache",get:function(){return this._tile_cache}}]),e}(),Rh=function(){function e(t,r){Ge(this,e),this._glenv=t,this._layers=[],this._draw_layers=null;for(var n=0;n<r.length;++n)this.add(r[n])}return qe(e,[{key:"getLayer",value:function(e){return this._layers[e]}},{key:"clear",value:function(){for(;this.num_layers()>0;)this.remove(0)}},{key:"add",value:function(e){this.insert(this.num_layers,e)}},{key:"insert",value:function(e,t){this._layers.splice(e,0,new Ah(this,t)),this.dirtyDrawingLayers()}},{key:"remove",value:function(e){this._layers.splice(e,1),this.dirtyDrawingLayers()}},{key:"numDrawingLayers",value:function(){return null===this._draw_layers&&this._updataDrawingLayers(),this._draw_layers.length}},{key:"getDrawingLayer",value:function(e){return null===this._draw_layers&&this._updataDrawingLayers(),this._draw_layers[e]}},{key:"endFrame",value:function(){for(var e=this._layers,t=0;t<e.length;++t)e[t].tile_cache.endFrame()}},{key:"cancel",value:function(){for(var e=this._layers,t=0;t<e.length;++t)e[t].tile_cache.cancel()}},{key:"dirtyDrawingLayers",value:function(){this._draw_layers=null}},{key:"_updataDrawingLayers",value:function(){for(var e=this.num_layers,t=[],r=0;r<e;++r){var n=this._layers[r];n.image_provider.status()===q_.Status.READY&&!0===n.visibility&&t.push(n)}this._draw_layers=t}},{key:"glenv",get:function(){return this._glenv}},{key:"num_layers",get:function(){return this._layers.length}}]),e}(),Ih=function(){function e(t){Ge(this,e),this._scene=t,this._items=[]}return qe(e,[{key:"get",value:function(e){return this._items[e]}},{key:"add",value:function(e){return this.insert(this.length,e)}},{key:"insert",value:function(e,t){var r=new jc(this._scene,t);return this._items.splice(e,0,r),r.init(),r}},{key:"removeByIndex",value:function(e){var t=this._items.splice(e,1)[0];return t.destroy(),t}},{key:"remove",value:function(e){var t=this._items.indexOf(e);if(-1===t)throw new Error("Couldn't find item: "+e);this.removeByIndex(t)}},{key:"length",get:function(){return this._items.length}}]),e}(),Ph=function(){function e(){Ge(this,e),this._viewer=null,this._is_started_=!1}return qe(e,[{key:"attach",value:function(e){if(this._viewer)throw new Error("RenderCallback instance is already attached");this._viewer=e,this._is_started_=!1}},{key:"detach",value:function(){this._is_started_&&(this.onStop(),this._is_started_=!1),this._viewer=null}},{key:"onUpdateFrameInner",value:function(e){this._is_started_||(this.onStart(),this._is_started_=!0),this.onUpdateFrame(e)}},{key:"onStart",value:function(){}},{key:"onUpdateFrame",value:function(e){}},{key:"onStop",value:function(){}},{key:"viewer",get:function(){return this._viewer}}]),e}(),Sh=function(e){function t(){return Ge(this,t),Ke(this,He(t).call(this))}return Ye(t,e),t}(Ph),Mh=function(){function e(t,r){var n=this;Ge(this,e),this._viewer=t,this._glenv=r,this._enode_list=[],this._loaders=[],this._animation=new Zs,this._animation.addDescendantUnbinder((function(){n._unbindDescendantAnimations()}))}return qe(e,[{key:"clearEntities",value:function(){this._enode_list=[]}},{key:"addEntity",value:function(e){if(e.scene!==this)throw new Error("invalid entity");this._enode_list.push(new Lh(e))}},{key:"removeEntity",value:function(e){for(var t=this._enode_list,r=0;r<t.length;++r)if(t[r].entity===e){t.splice(r,1);break}}},{key:"getEntity",value:function(e){return this._enode_list[e].entity}},{key:"draw",value:function(e){this._prepare_entities();var t=[],r=[],n=[],i=!0,a=!1,o=void 0;try{for(var s,u=this._enode_list[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value.entity;_.visibility&&this._add_primitives(e,_,t,r,n)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}this._draw_opaque_primitives(e,t),this._draw_translucent_primitives(e,r),this._draw_anchor_primitives(e,n)}},{key:"_prepare_entities",value:function(){var e=this._viewer.globe.dem_area_updated,t=!0,r=!1,n=void 0;try{for(var i,a=this._enode_list[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value,s=o.entity.getPrimitiveProducer();if(null!==s&&s.needsElevation())if(s.checkToCreateRegions()||null===o.regions)o.regions=s.createRegions(),o.regions.length>0&&(o.regions.forEach((function(e){e.compile()})),s.onChangeElevation(o.regions));else{if(e.isEmpty())continue;var u=[];o.regions.forEach((function(t){t.intersectsWith(e)&&u.push(t)})),u.length>0&&s.onChangeElevation(u)}}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"_add_primitives",value:function(e,t,r,n,i){var a=t.getPrimitiveProducer();if(null!==a){var o=!0,s=!1,u=void 0;try{for(var _,l=a.getPrimitives(e)[Symbol.iterator]();!(o=(_=l.next()).done);o=!0){var c=_.value;if(c.isVisible(e)){var h=t.anchor_mode?i:c.isTranslucent(e)?n:r;e.onPushPrimitive(c,t),h.push(c)}}}catch(e){s=!0,u=e}finally{try{o||null==l.return||l.return()}finally{if(s)throw u}}}}},{key:"_draw_opaque_primitives",value:function(e,t){t.sort((function(e,t){return t.sort_z-e.sort_z}));var r=this._glenv.context;r.disable(r.BLEND),r.depthMask(!0);for(var n=0;n<t.length;++n)t[n].draw(e)}},{key:"_draw_translucent_primitives",value:function(e,t){t.sort((function(e,t){return e.sort_z-t.sort_z}));var r=this._glenv.context;e.getRenderTarget()===fh.SCENE?r.enable(r.BLEND):r.disable(r.BLEND),r.depthMask(!1);for(var n=0;n<t.length;++n)t[n].draw(e);r.disable(r.BLEND),r.depthMask(!0)}},{key:"_draw_anchor_primitives",value:function(e,t){t.sort((function(e,t){return t.sort_z-e.sort_z}));var r=this._glenv.context;r.disable(r.DEPTH_TEST),r.depthMask(!1),e.getRenderTarget()===fh.SCENE?(e.setTranslucentMode(!0),r.enable(r.BLEND)):r.disable(r.BLEND);for(var n=t.length-1;n>=0;--n)t[n].draw(e);r.depthMask(!0),r.enable(r.DEPTH_TEST),e.setTranslucentMode(!1);for(n=0;n<t.length;++n)t[n].draw(e);r.disable(r.BLEND)}},{key:"cancelLoaders",value:function(){for(var e=this._loaders.concat(),t=0;t<e.length;++t)e[t].cancel()}},{key:"addLoader",value:function(e){this._loaders.push(e)}},{key:"removeLoader",value:function(e){var t=this._loaders.indexOf(e);t>=0&&this._loaders.splice(t,1)}},{key:"getFlakePrimitiveProducers",value:function(){var e=[],t=!0,r=!1,n=void 0;try{for(var i,a=this._enode_list[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value.entity;if(o.visibility){var s=o.getFlakePrimitiveProducer();null!==s&&e.push(s)}}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return e}},{key:"_unbindDescendantAnimations",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._enode_list[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){n.value.entity.animation.unbindAllRecursively()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"glenv",get:function(){return this._glenv}},{key:"viewer",get:function(){return this._viewer}},{key:"animation",get:function(){return this._animation}},{key:"num_entities",get:function(){return this._enode_list.length}}]),e}(),Lh=function e(t){Ge(this,e),this.entity=t,this.regions=null},Dh=/"/g;Le({target:"String",proto:!0,forced:function(e){return i((function(){var t=""[e]('"');return t!==t.toLowerCase()||t.split('"').length>3}))}("link")},{link:function(e){return t="a",r="href",n=e,i=String($(this)),a="<"+t,""!==r&&(a+=" "+r+'="'+String(n).replace(Dh,"&quot;")+'"'),a+">"+i+"</"+t+">";var t,r,n,i,a}}),Le({target:"Array",proto:!0,forced:Mo!==[].lastIndexOf},{lastIndexOf:Mo});var Ch,Fh=re.f,Nh="".startsWith,Oh=Math.min,Uh=Fn("startsWith"),Vh=!(Uh||(Ch=Fh(String.prototype,"startsWith"),!Ch||Ch.writable));Le({target:"String",proto:!0,forced:!Vh&&!Uh},{startsWith:function(e){var t=String($(this));Dn(e);var r=le(Oh(arguments.length>1?arguments[1]:void 0,t.length)),n=String(e);return Nh?Nh.call(t,n,r):t.slice(r,r+n.length)===n}});var Bh=function(){function e(){Ge(this,e)}var t,r,n,i;return qe(e,null,[{key:"get",value:function(){var t=ze(regeneratorRuntime.mark((function t(r,n){var i,a=arguments;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=a.length>2&&void 0!==a[2]?a[2]:{},t.next=3,this.fetch(e.METHOD.GET,r,n,null,i);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t,this)})));return function(e,r){return t.apply(this,arguments)}}()},{key:"post",value:(i=ze(regeneratorRuntime.mark((function t(r,n,i){var a,o=arguments;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=o.length>3&&void 0!==o[3]?o[3]:{},t.next=3,this.fetch(e.METHOD.POST,r,n,i,a);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t,this)}))),function(e,t,r){return i.apply(this,arguments)})},{key:"patch",value:(n=ze(regeneratorRuntime.mark((function t(r,n,i){var a,o=arguments;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=o.length>3&&void 0!==o[3]?o[3]:{},t.next=3,this.fetch(e.METHOD.PATCH,r,n,i,a);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t,this)}))),function(e,t,r){return n.apply(this,arguments)})},{key:"put",value:(r=ze(regeneratorRuntime.mark((function t(r,n,i){var a,o=arguments;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=o.length>3&&void 0!==o[3]?o[3]:{},t.next=3,this.fetch(e.METHOD.PUT,r,n,i,a);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"delete",value:(t=ze(regeneratorRuntime.mark((function t(r,n){var i,a=arguments;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return i=a.length>2&&void 0!==a[2]?a[2]:{},t.next=3,this.fetch(e.METHOD.DELETE,r,n,null,i);case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}}),t,this)}))),function(e,r){return t.apply(this,arguments)})},{key:"fetch",value:function(e){function t(t,r,n,i){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){var e=ze(regeneratorRuntime.mark((function e(t,r,n,i){var a,o,s,u=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=u.length>4&&void 0!==u[4]?u[4]:{},o=n?"?"+Object.keys(n).map((function(e){return e+"="+n[e]})).join("&"):"",a.method=t,i&&(a.body="object"===Ve(i)?JSON.stringify(i):i),e.prev=4,e.next=7,fetch(r+o,a);case 7:s=e.sent,e.next=13;break;case 10:throw e.prev=10,e.t0=e.catch(4),new zh("Failed to fetch",r,null,e.t0);case 13:if(s.ok){e.next=15;break}throw new zh("Failed to fetch: "+s.statusText,r,s);case 15:return e.abrupt("return",s);case 16:case"end":return e.stop()}}),e,null,[[4,10]])})));return function(t,r,n,i){return e.apply(this,arguments)}}())},{key:"isJson",value:function(e){return e.startsWith("application/json")||"model/gltf+json"===e}}]),e}();Bh.METHOD={GET:"GET",POST:"POST",PATCH:"PATCH",PUT:"PUT",DELETE:"DELETE"},Bh.CONTENT_TYPE="Content-Type",Bh.RESPONSE_STATUS={NO_CONTENT:204};var zh=function(e){function t(e,r,n,i){var a;Ge(this,t),a=Ke(this,He(t).call(this,e+" "+r)),Error.captureStackTrace&&Error.captureStackTrace(Je(a),t),a.name="FetchError",a.url=r,a.response=n,a.cause=i;var o=!1;return i&&(o="The user aborted a request."===i.message,a.stack+="\nCaused-By: "+(i.stack||i)),a.is_aborted=o,a}return Ye(t,e),t}(Ze(Error)),Gh=d.f,jh=ke.f,qh=z.set,Yh=Zt("match"),Hh=n.RegExp,Xh=Hh.prototype,Wh=/a/g,Qh=/a/g,Zh=new Hh(Wh)!==Wh,Jh=Uu.UNSUPPORTED_Y;if(a&&Se("RegExp",!Zh||Jh||i((function(){return Qh[Yh]=!1,Hh(Wh)!=Wh||Hh(Qh)==Qh||"/a/i"!=Hh(Wh,"i")})))){for(var Kh=function(e,t){var r,n=this instanceof Kh,i=Ln(e),a=void 0===t;if(!n&&i&&e.constructor===Kh&&a)return e;Zh?i&&!a&&(e=e.source):e instanceof Kh&&(a&&(t=Nu.call(e)),e=e.source),Jh&&(r=!!t&&t.indexOf("y")>-1)&&(t=t.replace(/y/g,""));var o=at(Zh?new Hh(e,t):Hh(e,t),n?this:Xh,Kh);return Jh&&r&&qh(o,{sticky:r}),o},$h=function(e){e in Kh||Gh(Kh,e,{configurable:!0,get:function(){return Hh[e]},set:function(t){Hh[e]=t}})},ef=jh(Hh),tf=0;ef.length>tf;)$h(ef[tf++]);Xh.constructor=Kh,Kh.prototype=Xh,G(n,"RegExp",Kh)}mi("RegExp");var rf=Zt("iterator"),nf=!i((function(){var e=new URL("b?a=1&b=2&c=3","http://a"),t=e.searchParams,r="";return e.pathname="c%20d",t.forEach((function(e,n){t.delete("b"),r+=n+e})),!t.sort||"http://a/c%20d?a=1&c=3"!==e.href||"3"!==t.get("c")||"a=1"!==String(new URLSearchParams("?a=1"))||!t[rf]||"a"!==new URL("https://a@b").username||"b"!==new URLSearchParams(new URLSearchParams("a=b")).get("a")||"xn--e1aybc"!==new URL("http://тест").host||"#%D0%B1"!==new URL("http://a#б").hash||"a1c3"!==r||"x"!==new URL("http://x",void 0).host})),af=/[^\0-\u007E]/,of=/[.\u3002\uFF0E\uFF61]/g,sf="Overflow: input needs wider integers to process",uf=Math.floor,_f=String.fromCharCode,lf=function(e){return e+22+75*(e<26)},cf=function(e,t,r){var n=0;for(e=r?uf(e/700):e>>1,e+=uf(e/t);e>455;n+=36)e=uf(e/35);return uf(n+36*e/(e+38))},hf=function(e){var t,r,n=[],i=(e=function(e){for(var t=[],r=0,n=e.length;r<n;){var i=e.charCodeAt(r++);if(i>=55296&&i<=56319&&r<n){var a=e.charCodeAt(r++);56320==(64512&a)?t.push(((1023&i)<<10)+(1023&a)+65536):(t.push(i),r--)}else t.push(i)}return t}(e)).length,a=128,o=0,s=72;for(t=0;t<e.length;t++)(r=e[t])<128&&n.push(_f(r));var u=n.length,_=u;for(u&&n.push("-");_<i;){var l=2147483647;for(t=0;t<e.length;t++)(r=e[t])>=a&&r<l&&(l=r);var c=_+1;if(l-a>uf((2147483647-o)/c))throw RangeError(sf);for(o+=(l-a)*c,a=l,t=0;t<e.length;t++){if((r=e[t])<a&&++o>2147483647)throw RangeError(sf);if(r==a){for(var h=o,f=36;;f+=36){var d=f<=s?1:f>=s+26?26:f-s;if(h<d)break;var v=h-d,p=36-d;n.push(_f(lf(d+v%p))),h=uf(v/p)}n.push(_f(lf(h))),s=cf(o,c,_==u),o=0,++_}}++o,++a}return n.join("")},ff=function(e){var t=si(e);if("function"!=typeof t)throw TypeError(String(e)+" is not iterable");return c(t.call(e))},df=ae("fetch"),vf=ae("Headers"),pf=Zt("iterator"),yf=z.set,gf=z.getterFor("URLSearchParams"),mf=z.getterFor("URLSearchParamsIterator"),kf=/\+/g,Ef=Array(4),wf=function(e){return Ef[e-1]||(Ef[e-1]=RegExp("((?:%[\\da-f]{2}){"+e+"})","gi"))},bf=function(e){try{return decodeURIComponent(e)}catch(t){return e}},xf=function(e){var t=e.replace(kf," "),r=4;try{return decodeURIComponent(t)}catch(e){for(;r;)t=t.replace(wf(r--),bf);return t}},Tf=/[!'()~]|%20/g,Af={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},Rf=function(e){return Af[e]},If=function(e){return encodeURIComponent(e).replace(Tf,Rf)},Pf=function(e,t){if(t)for(var r,n,i=t.split("&"),a=0;a<i.length;)(r=i[a++]).length&&(n=r.split("="),e.push({key:xf(n.shift()),value:xf(n.join("="))}))},Sf=function(e){this.entries.length=0,Pf(this.entries,e)},Mf=function(e,t){if(e<t)throw TypeError("Not enough arguments")},Lf=pn((function(e,t){yf(this,{type:"URLSearchParamsIterator",iterator:ff(gf(e).entries),kind:t})}),"Iterator",(function(){var e=mf(this),t=e.kind,r=e.iterator.next(),n=r.value;return r.done||(r.value="keys"===t?n.key:"values"===t?n.value:[n.key,n.value]),r})),Df=function(){li(this,Df,"URLSearchParams");var e,t,r,n,i,a,s,u,_,l=arguments.length>0?arguments[0]:void 0,h=this,f=[];if(yf(h,{type:"URLSearchParams",entries:f,updateURL:function(){},updateSearchParams:Sf}),void 0!==l)if(o(l))if("function"==typeof(e=si(l)))for(r=(t=e.call(l)).next;!(n=r.call(t)).done;){if((s=(a=(i=ff(c(n.value))).next).call(i)).done||(u=a.call(i)).done||!a.call(i).done)throw TypeError("Expected sequence with length 2");f.push({key:s.value+"",value:u.value+""})}else for(_ in l)g(l,_)&&f.push({key:_,value:l[_]+""});else Pf(f,"string"==typeof l?"?"===l.charAt(0)?l.slice(1):l:l+"")},Cf=Df.prototype;yi(Cf,{append:function(e,t){Mf(arguments.length,2);var r=gf(this);r.entries.push({key:e+"",value:t+""}),r.updateURL()},delete:function(e){Mf(arguments.length,1);for(var t=gf(this),r=t.entries,n=e+"",i=0;i<r.length;)r[i].key===n?r.splice(i,1):i++;t.updateURL()},get:function(e){Mf(arguments.length,1);for(var t=gf(this).entries,r=e+"",n=0;n<t.length;n++)if(t[n].key===r)return t[n].value;return null},getAll:function(e){Mf(arguments.length,1);for(var t=gf(this).entries,r=e+"",n=[],i=0;i<t.length;i++)t[i].key===r&&n.push(t[i].value);return n},has:function(e){Mf(arguments.length,1);for(var t=gf(this).entries,r=e+"",n=0;n<t.length;)if(t[n++].key===r)return!0;return!1},set:function(e,t){Mf(arguments.length,1);for(var r,n=gf(this),i=n.entries,a=!1,o=e+"",s=t+"",u=0;u<i.length;u++)(r=i[u]).key===o&&(a?i.splice(u--,1):(a=!0,r.value=s));a||i.push({key:o,value:s}),n.updateURL()},sort:function(){var e,t,r,n=gf(this),i=n.entries,a=i.slice();for(i.length=0,r=0;r<a.length;r++){for(e=a[r],t=0;t<r;t++)if(i[t].key>e.key){i.splice(t,0,e);break}t===r&&i.push(e)}n.updateURL()},forEach:function(e){for(var t,r=gf(this).entries,n=ir(e,arguments.length>1?arguments[1]:void 0,3),i=0;i<r.length;)n((t=r[i++]).value,t.key,this)},keys:function(){return new Lf(this,"keys")},values:function(){return new Lf(this,"values")},entries:function(){return new Lf(this,"entries")}},{enumerable:!0}),G(Cf,pf,Cf.entries),G(Cf,"toString",(function(){for(var e,t=gf(this).entries,r=[],n=0;n<t.length;)e=t[n++],r.push(If(e.key)+"="+If(e.value));return r.join("&")}),{enumerable:!0}),rr(Df,"URLSearchParams"),Le({global:!0,forced:!nf},{URLSearchParams:Df}),nf||"function"!=typeof df||"function"!=typeof vf||Le({global:!0,enumerable:!0,forced:!0},{fetch:function(e){var t,r,n,i=[e];return arguments.length>1&&(t=arguments[1],o(t)&&(r=t.body,"URLSearchParams"===Pn(r)&&((n=t.headers?new vf(t.headers):new vf).has("content-type")||n.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"),t=ft(t,{body:v(0,String(r)),headers:v(0,n)}))),i.push(t)),df.apply(this,i)}});var Ff,Nf={URLSearchParams:Df,getState:gf},Of=On.codeAt,Uf=n.URL,Vf=Nf.URLSearchParams,Bf=Nf.getState,zf=z.set,Gf=z.getterFor("URL"),jf=Math.floor,qf=Math.pow,Yf=/[A-Za-z]/,Hf=/[\d+\-.A-Za-z]/,Xf=/\d/,Wf=/^(0x|0X)/,Qf=/^[0-7]+$/,Zf=/^\d+$/,Jf=/^[\dA-Fa-f]+$/,Kf=/[\u0000\u0009\u000A\u000D #%/:?@[\\]]/,$f=/[\u0000\u0009\u000A\u000D #/:?@[\\]]/,ed=/^[\u0000-\u001F ]+|[\u0000-\u001F ]+$/g,td=/[\u0009\u000A\u000D]/g,rd=function(e,t){var r,n,i;if("["==t.charAt(0)){if("]"!=t.charAt(t.length-1))return"Invalid host";if(!(r=id(t.slice(1,-1))))return"Invalid host";e.host=r}else if(hd(e)){if(t=function(e){var t,r,n=[],i=e.toLowerCase().replace(of,".").split(".");for(t=0;t<i.length;t++)r=i[t],n.push(af.test(r)?"xn--"+hf(r):r);return n.join(".")}(t),Kf.test(t))return"Invalid host";if(null===(r=nd(t)))return"Invalid host";e.host=r}else{if($f.test(t))return"Invalid host";for(r="",n=xs(t),i=0;i<n.length;i++)r+=ld(n[i],od);e.host=r}},nd=function(e){var t,r,n,i,a,o,s,u=e.split(".");if(u.length&&""==u[u.length-1]&&u.pop(),(t=u.length)>4)return e;for(r=[],n=0;n<t;n++){if(""==(i=u[n]))return e;if(a=10,i.length>1&&"0"==i.charAt(0)&&(a=Wf.test(i)?16:8,i=i.slice(8==a?1:2)),""===i)o=0;else{if(!(10==a?Zf:8==a?Qf:Jf).test(i))return e;o=parseInt(i,a)}r.push(o)}for(n=0;n<t;n++)if(o=r[n],n==t-1){if(o>=qf(256,5-t))return null}else if(o>255)return null;for(s=r.pop(),n=0;n<r.length;n++)s+=r[n]*qf(256,3-n);return s},id=function(e){var t,r,n,i,a,o,s,u=[0,0,0,0,0,0,0,0],_=0,l=null,c=0,h=function(){return e.charAt(c)};if(":"==h()){if(":"!=e.charAt(1))return;c+=2,l=++_}for(;h();){if(8==_)return;if(":"!=h()){for(t=r=0;r<4&&Jf.test(h());)t=16*t+parseInt(h(),16),c++,r++;if("."==h()){if(0==r)return;if(c-=r,_>6)return;for(n=0;h();){if(i=null,n>0){if(!("."==h()&&n<4))return;c++}if(!Xf.test(h()))return;for(;Xf.test(h());){if(a=parseInt(h(),10),null===i)i=a;else{if(0==i)return;i=10*i+a}if(i>255)return;c++}u[_]=256*u[_]+i,2!=++n&&4!=n||_++}if(4!=n)return;break}if(":"==h()){if(c++,!h())return}else if(h())return;u[_++]=t}else{if(null!==l)return;c++,l=++_}}if(null!==l)for(o=_-l,_=7;0!=_&&o>0;)s=u[_],u[_--]=u[l+o-1],u[l+--o]=s;else if(8!=_)return;return u},ad=function(e){var t,r,n,i;if("number"==typeof e){for(t=[],r=0;r<4;r++)t.unshift(e%256),e=jf(e/256);return t.join(".")}if("object"==typeof e){for(t="",n=function(e){for(var t=null,r=1,n=null,i=0,a=0;a<8;a++)0!==e[a]?(i>r&&(t=n,r=i),n=null,i=0):(null===n&&(n=a),++i);return i>r&&(t=n,r=i),t}(e),r=0;r<8;r++)i&&0===e[r]||(i&&(i=!1),n===r?(t+=r?":":"::",i=!0):(t+=e[r].toString(16),r<7&&(t+=":")));return"["+t+"]"}return e},od={},sd=bh({},od,{" ":1,'"':1,"<":1,">":1,"`":1}),ud=bh({},sd,{"#":1,"?":1,"{":1,"}":1}),_d=bh({},ud,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),ld=function(e,t){var r=Of(e,0);return r>32&&r<127&&!g(t,e)?e:encodeURIComponent(e)},cd={ftp:21,file:null,http:80,https:443,ws:80,wss:443},hd=function(e){return g(cd,e.scheme)},fd=function(e){return""!=e.username||""!=e.password},dd=function(e){return!e.host||e.cannotBeABaseURL||"file"==e.scheme},vd=function(e,t){var r;return 2==e.length&&Yf.test(e.charAt(0))&&(":"==(r=e.charAt(1))||!t&&"|"==r)},pd=function(e){var t;return e.length>1&&vd(e.slice(0,2))&&(2==e.length||"/"===(t=e.charAt(2))||"\\"===t||"?"===t||"#"===t)},yd=function(e){var t=e.path,r=t.length;!r||"file"==e.scheme&&1==r&&vd(t[0],!0)||t.pop()},gd=function(e){return"."===e||"%2e"===e.toLowerCase()},md={},kd={},Ed={},wd={},bd={},xd={},Td={},Ad={},Rd={},Id={},Pd={},Sd={},Md={},Ld={},Dd={},Cd={},Fd={},Nd={},Od={},Ud={},Vd={},Bd=function(e,t,r,n){var i,a,o,s,u,_=r||md,l=0,c="",h=!1,f=!1,d=!1;for(r||(e.scheme="",e.username="",e.password="",e.host=null,e.port=null,e.path=[],e.query=null,e.fragment=null,e.cannotBeABaseURL=!1,t=t.replace(ed,"")),t=t.replace(td,""),i=xs(t);l<=i.length;){switch(a=i[l],_){case md:if(!a||!Yf.test(a)){if(r)return"Invalid scheme";_=Ed;continue}c+=a.toLowerCase(),_=kd;break;case kd:if(a&&(Hf.test(a)||"+"==a||"-"==a||"."==a))c+=a.toLowerCase();else{if(":"!=a){if(r)return"Invalid scheme";c="",_=Ed,l=0;continue}if(r&&(hd(e)!=g(cd,c)||"file"==c&&(fd(e)||null!==e.port)||"file"==e.scheme&&!e.host))return;if(e.scheme=c,r)return void(hd(e)&&cd[e.scheme]==e.port&&(e.port=null));c="","file"==e.scheme?_=Ld:hd(e)&&n&&n.scheme==e.scheme?_=wd:hd(e)?_=Ad:"/"==i[l+1]?(_=bd,l++):(e.cannotBeABaseURL=!0,e.path.push(""),_=Od)}break;case Ed:if(!n||n.cannotBeABaseURL&&"#"!=a)return"Invalid scheme";if(n.cannotBeABaseURL&&"#"==a){e.scheme=n.scheme,e.path=n.path.slice(),e.query=n.query,e.fragment="",e.cannotBeABaseURL=!0,_=Vd;break}_="file"==n.scheme?Ld:xd;continue;case wd:if("/"!=a||"/"!=i[l+1]){_=xd;continue}_=Rd,l++;break;case bd:if("/"==a){_=Id;break}_=Nd;continue;case xd:if(e.scheme=n.scheme,a==Ff)e.username=n.username,e.password=n.password,e.host=n.host,e.port=n.port,e.path=n.path.slice(),e.query=n.query;else if("/"==a||"\\"==a&&hd(e))_=Td;else if("?"==a)e.username=n.username,e.password=n.password,e.host=n.host,e.port=n.port,e.path=n.path.slice(),e.query="",_=Ud;else{if("#"!=a){e.username=n.username,e.password=n.password,e.host=n.host,e.port=n.port,e.path=n.path.slice(),e.path.pop(),_=Nd;continue}e.username=n.username,e.password=n.password,e.host=n.host,e.port=n.port,e.path=n.path.slice(),e.query=n.query,e.fragment="",_=Vd}break;case Td:if(!hd(e)||"/"!=a&&"\\"!=a){if("/"!=a){e.username=n.username,e.password=n.password,e.host=n.host,e.port=n.port,_=Nd;continue}_=Id}else _=Rd;break;case Ad:if(_=Rd,"/"!=a||"/"!=c.charAt(l+1))continue;l++;break;case Rd:if("/"!=a&&"\\"!=a){_=Id;continue}break;case Id:if("@"==a){h&&(c="%40"+c),h=!0,o=xs(c);for(var v=0;v<o.length;v++){var p=o[v];if(":"!=p||d){var y=ld(p,_d);d?e.password+=y:e.username+=y}else d=!0}c=""}else if(a==Ff||"/"==a||"?"==a||"#"==a||"\\"==a&&hd(e)){if(h&&""==c)return"Invalid authority";l-=xs(c).length+1,c="",_=Pd}else c+=a;break;case Pd:case Sd:if(r&&"file"==e.scheme){_=Cd;continue}if(":"!=a||f){if(a==Ff||"/"==a||"?"==a||"#"==a||"\\"==a&&hd(e)){if(hd(e)&&""==c)return"Invalid host";if(r&&""==c&&(fd(e)||null!==e.port))return;if(s=rd(e,c))return s;if(c="",_=Fd,r)return;continue}"["==a?f=!0:"]"==a&&(f=!1),c+=a}else{if(""==c)return"Invalid host";if(s=rd(e,c))return s;if(c="",_=Md,r==Sd)return}break;case Md:if(!Xf.test(a)){if(a==Ff||"/"==a||"?"==a||"#"==a||"\\"==a&&hd(e)||r){if(""!=c){var m=parseInt(c,10);if(m>65535)return"Invalid port";e.port=hd(e)&&m===cd[e.scheme]?null:m,c=""}if(r)return;_=Fd;continue}return"Invalid port"}c+=a;break;case Ld:if(e.scheme="file","/"==a||"\\"==a)_=Dd;else{if(!n||"file"!=n.scheme){_=Nd;continue}if(a==Ff)e.host=n.host,e.path=n.path.slice(),e.query=n.query;else if("?"==a)e.host=n.host,e.path=n.path.slice(),e.query="",_=Ud;else{if("#"!=a){pd(i.slice(l).join(""))||(e.host=n.host,e.path=n.path.slice(),yd(e)),_=Nd;continue}e.host=n.host,e.path=n.path.slice(),e.query=n.query,e.fragment="",_=Vd}}break;case Dd:if("/"==a||"\\"==a){_=Cd;break}n&&"file"==n.scheme&&!pd(i.slice(l).join(""))&&(vd(n.path[0],!0)?e.path.push(n.path[0]):e.host=n.host),_=Nd;continue;case Cd:if(a==Ff||"/"==a||"\\"==a||"?"==a||"#"==a){if(!r&&vd(c))_=Nd;else if(""==c){if(e.host="",r)return;_=Fd}else{if(s=rd(e,c))return s;if("localhost"==e.host&&(e.host=""),r)return;c="",_=Fd}continue}c+=a;break;case Fd:if(hd(e)){if(_=Nd,"/"!=a&&"\\"!=a)continue}else if(r||"?"!=a)if(r||"#"!=a){if(a!=Ff&&(_=Nd,"/"!=a))continue}else e.fragment="",_=Vd;else e.query="",_=Ud;break;case Nd:if(a==Ff||"/"==a||"\\"==a&&hd(e)||!r&&("?"==a||"#"==a)){if(".."===(u=(u=c).toLowerCase())||"%2e."===u||".%2e"===u||"%2e%2e"===u?(yd(e),"/"==a||"\\"==a&&hd(e)||e.path.push("")):gd(c)?"/"==a||"\\"==a&&hd(e)||e.path.push(""):("file"==e.scheme&&!e.path.length&&vd(c)&&(e.host&&(e.host=""),c=c.charAt(0)+":"),e.path.push(c)),c="","file"==e.scheme&&(a==Ff||"?"==a||"#"==a))for(;e.path.length>1&&""===e.path[0];)e.path.shift();"?"==a?(e.query="",_=Ud):"#"==a&&(e.fragment="",_=Vd)}else c+=ld(a,ud);break;case Od:"?"==a?(e.query="",_=Ud):"#"==a?(e.fragment="",_=Vd):a!=Ff&&(e.path[0]+=ld(a,od));break;case Ud:r||"#"!=a?a!=Ff&&("'"==a&&hd(e)?e.query+="%27":e.query+="#"==a?"%23":ld(a,od)):(e.fragment="",_=Vd);break;case Vd:a!=Ff&&(e.fragment+=ld(a,sd))}l++}},zd=function(e){var t,r,n=li(this,zd,"URL"),i=arguments.length>1?arguments[1]:void 0,o=String(e),s=zf(n,{type:"URL"});if(void 0!==i)if(i instanceof zd)t=Gf(i);else if(r=Bd(t={},String(i)))throw TypeError(r);if(r=Bd(s,o,null,t))throw TypeError(r);var u=s.searchParams=new Vf,_=Bf(u);_.updateSearchParams(s.query),_.updateURL=function(){s.query=String(u)||null},a||(n.href=jd.call(n),n.origin=qd.call(n),n.protocol=Yd.call(n),n.username=Hd.call(n),n.password=Xd.call(n),n.host=Wd.call(n),n.hostname=Qd.call(n),n.port=Zd.call(n),n.pathname=Jd.call(n),n.search=Kd.call(n),n.searchParams=$d.call(n),n.hash=ev.call(n))},Gd=zd.prototype,jd=function(){var e=Gf(this),t=e.scheme,r=e.username,n=e.password,i=e.host,a=e.port,o=e.path,s=e.query,u=e.fragment,_=t+":";return null!==i?(_+="//",fd(e)&&(_+=r+(n?":"+n:"")+"@"),_+=ad(i),null!==a&&(_+=":"+a)):"file"==t&&(_+="//"),_+=e.cannotBeABaseURL?o[0]:o.length?"/"+o.join("/"):"",null!==s&&(_+="?"+s),null!==u&&(_+="#"+u),_},qd=function(){var e=Gf(this),t=e.scheme,r=e.port;if("blob"==t)try{return new URL(t.path[0]).origin}catch(e){return"null"}return"file"!=t&&hd(e)?t+"://"+ad(e.host)+(null!==r?":"+r:""):"null"},Yd=function(){return Gf(this).scheme+":"},Hd=function(){return Gf(this).username},Xd=function(){return Gf(this).password},Wd=function(){var e=Gf(this),t=e.host,r=e.port;return null===t?"":null===r?ad(t):ad(t)+":"+r},Qd=function(){var e=Gf(this).host;return null===e?"":ad(e)},Zd=function(){var e=Gf(this).port;return null===e?"":String(e)},Jd=function(){var e=Gf(this),t=e.path;return e.cannotBeABaseURL?t[0]:t.length?"/"+t.join("/"):""},Kd=function(){var e=Gf(this).query;return e?"?"+e:""},$d=function(){return Gf(this).searchParams},ev=function(){var e=Gf(this).fragment;return e?"#"+e:""},tv=function(e,t){return{get:e,set:t,configurable:!0,enumerable:!0}};if(a&&st(Gd,{href:tv(jd,(function(e){var t=Gf(this),r=String(e),n=Bd(t,r);if(n)throw TypeError(n);Bf(t.searchParams).updateSearchParams(t.query)})),origin:tv(qd),protocol:tv(Yd,(function(e){var t=Gf(this);Bd(t,String(e)+":",md)})),username:tv(Hd,(function(e){var t=Gf(this),r=xs(String(e));if(!dd(t)){t.username="";for(var n=0;n<r.length;n++)t.username+=ld(r[n],_d)}})),password:tv(Xd,(function(e){var t=Gf(this),r=xs(String(e));if(!dd(t)){t.password="";for(var n=0;n<r.length;n++)t.password+=ld(r[n],_d)}})),host:tv(Wd,(function(e){var t=Gf(this);t.cannotBeABaseURL||Bd(t,String(e),Pd)})),hostname:tv(Qd,(function(e){var t=Gf(this);t.cannotBeABaseURL||Bd(t,String(e),Sd)})),port:tv(Zd,(function(e){var t=Gf(this);dd(t)||(""==(e=String(e))?t.port=null:Bd(t,e,Md))})),pathname:tv(Jd,(function(e){var t=Gf(this);t.cannotBeABaseURL||(t.path=[],Bd(t,e+"",Fd))})),search:tv(Kd,(function(e){var t=Gf(this);""==(e=String(e))?t.query=null:("?"==e.charAt(0)&&(e=e.slice(1)),t.query="",Bd(t,e,Ud)),Bf(t.searchParams).updateSearchParams(t.query)})),searchParams:tv($d),hash:tv(ev,(function(e){var t=Gf(this);""!=(e=String(e))?("#"==e.charAt(0)&&(e=e.slice(1)),t.fragment="",Bd(t,e,Vd)):t.fragment=null}))}),G(Gd,"toJSON",(function(){return jd.call(this)}),{enumerable:!0}),G(Gd,"toString",(function(){return jd.call(this)}),{enumerable:!0}),Uf){var rv=Uf.createObjectURL,nv=Uf.revokeObjectURL;rv&&G(zd,"createObjectURL",(function(e){return rv.apply(Uf,arguments)})),nv&&G(zd,"revokeObjectURL",(function(e){return nv.apply(Uf,arguments)}))}rr(zd,"URL"),Le({global:!0,forced:!nf,sham:!a},{URL:zd});var iv=new RegExp("^data:"),av=new RegExp("^https?://"),ov=function(){function e(){Ge(this,e)}var t,r;return qe(e,null,[{key:"createCanvasContext",value:function(e,t){var r=document.createElement("canvas");return r.width=e,r.height=t,r.getContext("2d")}},{key:"loadImage",value:(r=ze(regeneratorRuntime.mark((function e(t){var r,n=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.length>1&&void 0!==n[1]?n[1]:{},e.next=3,new Promise((function(e,n){var i=new Image;i.onload=function(t){return e(t.target)},i.onerror=function(e){return n(new Error("Failed to load image"))},r.credentials!==yh.OMIT&&(i.crossOrigin=r.credentials===yh.INCLUDE?"use-credentials":"anonymous"),i.src=t instanceof Blob?URL.createObjectURL(t):t}));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e)}))),function(e){return r.apply(this,arguments)})},{key:"waitForLoad",value:(t=ze(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.src){e.next=2;break}throw new Error("src was not set");case 2:if(!t.complete){e.next=4;break}return e.abrupt("return",t);case 4:return e.next=6,new Promise((function(e,r){var n=t.onload,i=t.onerror;t.onload=function(t){n&&n(t),e(t.target)},t.onerror=function(e){i&&i(e),r(new Error("Failed to load image"))}}));case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})},{key:"resolveUrl",value:function(e,t){return iv.test(t)||av.test(t)?t:e+t}}]),e}();ov.SYSTEM_FONT_FAMILY="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'";var sv=function(){function e(){Ge(this,e)}var t,r,n;return qe(e,[{key:"load",value:(n=ze(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Not Implemented");case 2:case"end":return e.stop()}}),e)}))),function(){return n.apply(this,arguments)})},{key:"cancel",value:function(){}},{key:"loadSubResourceSupported",value:function(){return!1}},{key:"loadSubResource",value:(r=ze(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Not Supported");case 2:case"end":return e.stop()}}),e)}))),function(e){return r.apply(this,arguments)})},{key:"resolveResourceSupported",value:function(){return!1}},{key:"resolveResource",value:(t=ze(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Not Supported");case 1:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}],[{key:"ResourceType",get:function(){return uv}}]),e}(),uv={JSON:{id:"JSON"},BINARY:{id:"BINARY"},IMAGE:{id:"IMAGE"}},_v=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Ge(this,t),(r=Ke(this,He(t).call(this)))._url=e;var i=e.lastIndexOf("/");if(-1===i)throw new Error("invalid url");return r._base_url=r._url.substr(0,i+1),r._type=n.type||"json",r._transform=n.transform||lv,r._abort_ctrl=new AbortController,r}var r,n,i;return Ye(t,e),qe(t,[{key:"load",value:(i=ze(regeneratorRuntime.mark((function e(){var t,r=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:{},e.next=3,this._loadURLResource(this._url,t.type||this._type,t);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"cancel",value:function(){this._abort_ctrl.abort()}},{key:"loadSubResourceSupported",value:function(){return!0}},{key:"loadSubResource",value:(n=ze(regeneratorRuntime.mark((function e(t){var r,n=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.length>1&&void 0!==n[1]?n[1]:{},e.next=3,this._loadURLResource(ov.resolveUrl(this._base_url,t),r.type,r);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"resolveResourceSupported",value:function(){return!0}},{key:"resolveResource",value:function(e){return new t(ov.resolveUrl(this._base_url,e),{transform:this._transform})}},{key:"_loadURLResource",value:(r=ze(regeneratorRuntime.mark((function e(t,r){var n,i,a,o,s=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=s.length>2&&void 0!==s[2]?s[2]:{},i=this._transform(t,r),r!==uv.IMAGE){e.next=6;break}return e.next=5,ov.loadImage(i.url,i);case 5:return e.abrupt("return",e.sent);case 6:return a=this._make_fetch_params(i)||{},n.signal&&(a.signal=n.signal),e.next=10,Bh.get(i.url,null,a);case 10:if((o=e.sent).ok){e.next=13;break}throw new Error(o.statusText);case 13:if(r!==uv.JSON){e.next=19;break}return e.next=16,o.json();case 16:e.t0=e.sent,e.next=27;break;case 19:if(r!==uv.BINARY){e.next=25;break}return e.next=22,o.arrayBuffer();case 22:e.t1=e.sent,e.next=26;break;case 25:e.t1=o;case 26:e.t0=e.t1;case 27:return e.abrupt("return",e.t0);case 28:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"_make_fetch_params",value:function(e){var t={signal:this._abort_ctrl.signal,credentials:(e.credentials||yh.OMIT).credentials};return e.headers&&(t.headers=e.headers),t}},{key:"url",get:function(){return this._url}}]),t}(sv);function lv(e,t){return{url:e}}var cv=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(Ge(this,e),this._scene=t,!(r instanceof sv))throw new Error("Unsupported Resource Type: "+r);this._resource=r,this._status=e.Status.NOT_LOADED,this._onLoad=n.onLoad||hv,this._onEntity=n.onEntity||fv}return qe(e,[{key:"_setStatus",value:function(e){this._status=e}},{key:"load",value:function(){var t=this;return this.status!==e.Status.NOT_LOADED?Promise.reject(new Error("Illegal Status: "+this.status)):Promise.resolve().then((function(){return t._setStatus(e.Status.LOADING),t.scene.addLoader(t),t._load()})).catch((function(r){throw console.log(r),t._scene.removeLoader(t),t._onLoad(t,!1),t._status!==e.Status.CANCELED&&t._setStatus(e.Status.ABORTED),r})).then((function(r){if(t._scene.removeLoader(t),t._status===e.Status.CANCELED)throw t._onLoad(t,!1),new Error("canceled");return t._setStatus(e.Status.LOADED),t._onLoad(t,!0),r}))}},{key:"_load",value:function(){throw new Error("_load() is not implemented in "+this.constructor.name)}},{key:"cancel",value:function(){this._status!==e.Status.LOADING&&this._status!==e.Status.LOADED||(this._setStatus(e.Status.CANCELED),this._resource.cancel(),this._cancel())}},{key:"_cancel",value:function(){}},{key:"_check_cancel",value:function(){if(this.status===e.Status.CANCELED)throw new Error("canceled")}},{key:"scene",get:function(){return this._scene}},{key:"resource",get:function(){return this._resource}},{key:"status",get:function(){return this._status}}]),e}();function hv(e,t){}function fv(e,t){e.scene.addEntity(t)}cv.Status={NOT_LOADED:"Not Loaded",LOADING:"Loading",LOADED:"Loaded",CANCELED:"Canceled",ERROR:"ERROR"};var dv=function(){function e(t,r){Ge(this,e),this._name=t.name||null,this._extensions=r.extractUsedExtensions(t.extensions||{}),this._extras=t.extras||{}}return qe(e,[{key:"getName",value:function(){return this._name}},{key:"getExtensions",value:function(e){var t=this._extensions[e];return void 0!==t?t:null}},{key:"getExtras",value:function(e){var t=this._extras[e];return void 0!==t?t:null}}]),e}(),vv=function(){function e(t,r,n){Ge(this,e),this._commonData=new dv(t.gjson,t),this._scenes=r,this._default_scene_index=n}return qe(e,[{key:"commonData",get:function(){return this._commonData}},{key:"scenes",get:function(){return this._scenes}},{key:"default_scene_index",get:function(){return this._default_scene_index}}]),e}(),pv=function(){function e(t,r,n){Ge(this,e);var i=n||{};this._glenv=t,this._handle=this._createTexture(r,i)}return qe(e,[{key:"dispose",value:function(){this._glenv.context.deleteTexture(this._handle),this._handle=null}},{key:"_createTexture",value:function(t,r){var n=this._glenv.context,i=n.TEXTURE_2D,a=n.createTexture(),o=e._getParameters(n,r);n.bindTexture(i,a);var s=void 0===r.flip_y||r.flip_y;return n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,s),r.usage===e.Usage.COLOR?n.texImage2D(i,0,o.format,1,1,0,o.format,o.type,e._getColorArray(r)):n.texImage2D(i,0,o.format,o.format,o.type,t),s&&n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1),e._generateMipmapQ(n,o)&&n.generateMipmap(i),n.texParameteri(i,n.TEXTURE_MAG_FILTER,o.mag_filter),n.texParameteri(i,n.TEXTURE_MIN_FILTER,o.min_filter),n.texParameteri(i,n.TEXTURE_WRAP_S,o.wrap_s),n.texParameteri(i,n.TEXTURE_WRAP_T,o.wrap_t),n.bindTexture(i,null),a}},{key:"handle",get:function(){return this._handle}}],[{key:"_getParameters",value:function(t,r){var n={format:t.RGBA,type:t.UNSIGNED_BYTE,mag_filter:t.LINEAR,min_filter:t.LINEAR_MIPMAP_LINEAR,wrap_s:t.REPEAT,wrap_t:t.REPEAT};return r.usage===e.Usage.SIMPLETEXT?(n.format=t.ALPHA,n.min_filter=t.LINEAR,n.wrap_s=t.CLAMP_TO_EDGE,n.wrap_t=t.CLAMP_TO_EDGE):r.usage===e.Usage.TEXT?(n.min_filter=t.LINEAR,n.wrap_s=t.CLAMP_TO_EDGE,n.wrap_t=t.CLAMP_TO_EDGE):r.usage===e.Usage.COLOR?(n.mag_filter=t.NEAREST,n.min_filter=t.NEAREST):r.usage===e.Usage.ICON&&(n.min_filter=t.LINEAR,n.wrap_s=t.CLAMP_TO_EDGE,n.wrap_t=t.CLAMP_TO_EDGE),void 0!==r.mag_filter&&(n.mag_filter=r.mag_filter),void 0!==r.min_filter&&(n.min_filter=r.min_filter),void 0!==r.wrap_s&&(n.wrap_s=r.wrap_s),void 0!==r.wrap_t&&(n.wrap_t=r.wrap_t),n}},{key:"_getColorArray",value:function(e){var t=(e.color||[1,1,1,1]).map((function(e){return Math.round(255*e)}));return new Uint8Array(t)}},{key:"_generateMipmapQ",value:function(e,t){var r=t.min_filter;return r==e.NEAREST_MIPMAP_NEAREST||r==e.LINEAR_MIPMAP_NEAREST||r==e.NEAREST_MIPMAP_LINEAR||r==e.LINEAR_MIPMAP_LINEAR}}]),e}();pv.Usage={GENERAL:{id:"GENERAL"},COLOR:{id:"COLOR"},TEXT:{id:"TEXT"},SIMPLETEXT:{id:"SIMPLETEXT"},ICON:{id:"ICON"}};var yv=function(e){function t(e,r,n){return Ge(this,t),Ke(this,He(t).call(this,e,r,n))}return Ye(t,e),qe(t,[{key:"isTranslucent",value:function(e,t){return!1}},{key:"setParameters",value:function(e,t){e.getRenderTarget()===fh.RID&&this._setRenderId(t.rid)}},{key:"setObjToClip",value:function(e,r){var n=r.transform,i=t._obj_to_clip;hs.mul_GA(e._gocs_to_clip,n,i),this.setMatrix("u_obj_to_clip",i)}},{key:"setObjToView",value:function(e,r){var n=r.transform,i=t._obj_to_view;hs.mul_AA(e._gocs_to_view,n,i),this.setMatrix("u_obj_to_view",i)}},{key:"_setRenderId",value:function(e){this.setVector4("u_rid",[(e>>12&15)/15,(e>>8&15)/15,(e>>4&15)/15,(15&e)/15])}}]),t}(G_);yv._obj_to_clip=hs.createMatrixf(),yv._obj_to_view=hs.createMatrixf();var gv="attribute vec4 a_position;    // 位置 (モデル座標系)\nattribute vec3 a_normal;      // 法線 (モデル座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\n\nuniform mat4  u_obj_to_clip;  // モデル座標系からクリップ座標系への変換\nuniform mat4  u_obj_to_view;  // モデル座標系から視点座標系への変換\n\nvarying vec3  v_normal;       // 法線 (視点座標系)\nvarying vec2  v_texcoord;     // テクスチャ座標\n\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n#ifndef UNLIT\n    v_normal = normalize( vec3( u_obj_to_view * vec4( a_normal, 0.0 ) ) );  // 法線 (視点座標系)\n#endif\n\n    v_texcoord = a_texcoord;\n}\n",mv="precision highp float;\n\nvarying vec3  v_normal;    // 法線 (視点座標系)\nvarying vec2  v_texcoord;  // テクスチャ座標\n\nuniform vec3      u_light_dir;   // ライト逆方向 (視点座標系) と強さ\nuniform vec4      u_base_color;  // 基本色係数\nuniform sampler2D u_base_image;  // 基本色画像\n\n\nvoid\nmain()\n{\n#ifndef UNLIT\n    vec3 normal = normalize( v_normal );  // 法線 (視点座標系)\n\n    vec3 dlit = vec3( dot( normal, u_light_dir ) );  // 拡散光の強さ\n#else\n    vec3 dlit = vec3( 1.0 );\n#endif\n\n    gl_FragColor = u_base_color * texture2D( u_base_image, v_texcoord ) * vec4( dlit, 1.0 );\n}\n",kv=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Ge(this,t);var i=t._getPreamble(n);return(r=Ke(this,He(t).call(this,e,i+gv,i+(n.ridMaterial?nl:mv))))._white_texture=new pv(e,null,{usage:pv.Usage.COLOR,color:[1,1,1,1]}),r.bindProgram(),r.setInteger("u_base_image",t.TEXUNIT_BASE_IMAGE),r}return Ye(t,e),qe(t,[{key:"setParameters",value:function(e,r){$e(He(t.prototype),"setParameters",this).call(this,e,r);var n=r.properties.pbrMetallicRoughness;if(this.setObjToClip(e,r),this.setObjToView(e,r),e.getRenderTarget()===fh.SCENE){var i=n.baseColorFactor,a=e.getTranslucentMode()?[.5*i[0],.5*i[1],.5*i[2],.5*i[3]]:i;this.setVector4("u_base_color",a),this.setVector3("u_light_dir",[0,0,1]);var o=this._selectTexture(n.baseColorTexture,this._white_texture);this.bindTexture2D(t.TEXUNIT_BASE_IMAGE,o.handle)}}},{key:"_selectTexture",value:function(e,t){return null!==e?e.texture:t}}],[{key:"_getPreamble",value:function(e){var t=[];return void 0!==e.is_unlit&&e.is_unlit&&t.push("#define UNLIT"),t.join("\n")+"\n\n"}}]),t}(yv);kv.TEXUNIT_BASE_IMAGE=0;var Ev=function(){function e(t,r){Ge(this,e);var n="number"==typeof r?t.gjson.samplers[r]:{};this._magFilter=n.magFilter,this._minFilter=n.minFilter,this._wrapS=void 0!==n.wrapS?n.wrapS:e.WRAP_DEFAULT,this._wrapT=void 0!==n.wrapT?n.wrapT:e.WRAP_DEFAULT}return qe(e,[{key:"magFilter",get:function(){return this._magFilter}},{key:"minFilter",get:function(){return this._minFilter}},{key:"wrapS",get:function(){return this._wrapS}},{key:"wrapT",get:function(){return this._wrapT}}]),e}();Ev.WRAP_DEFAULT=10497;var wv=function(){function e(t,r){Ge(this,e);var n=t.gjson.textures[r];this._sampler=new Ev(t,n.sampler),this._source=t.findImage(n.source)}return qe(e,[{key:"source",get:function(){return this._source}},{key:"sampler",get:function(){return this._sampler}}]),e}(),bv=function(){function e(t,r){Ge(this,e),this._texture=new wv(r,t.index),this._texCoord=void 0!==t.texCoord?t.texCoord:0}return qe(e,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e}},{key:"texCoord",get:function(){return this._texCoord}}]),e}(),xv=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this,e,r)))._scale=void 0!==e.scale?e.scale:1,n}return Ye(t,e),qe(t,[{key:"texCoord",get:function(){return this._scale}}]),t}(bv),Tv=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this,e,r)))._strength=void 0!==e.strength?e.strength:1,n}return Ye(t,e),qe(t,[{key:"strength",get:function(){return this._strength}}]),t}(bv),Av=function(){function e(t,r){Ge(this,e),this._entries=[],this._name_map={},this._default=null,this._offset_transform=hs.setIdentity(hs.createMatrix());var n={},i=!0,a=!1,o=void 0;try{for(var s,u=r.scenes[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value,l=new Rv(t,_,n);this._entries.push(l),null!==_.name&&(this._name_map[_.name]=l)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}if(r.default_scene_index>=0){if(!(r.default_scene_index<this._entries.length))throw new Error("default_scene_index is out of range");this._default=this._entries[r.default_scene_index]}else this._entries.length>=1&&(this._default=this._entries[0])}return qe(e,[{key:"setOffsetTransform",value:function(e){hs.copyMatrix(e,this._offset_transform)}},{key:"createPrimitives",value:function(e,t){var r=this._getEntry(e);if(null===r)return null;var n=[],i=!0,a=!1,o=void 0;try{for(var s,u=r.getPrimitives(t)[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value.fastClone();hs.mul_AA(this._offset_transform,_.transform,_.transform),_.properties=Iv.fastCloneProperties(_.properties),n.push(_)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}return n}},{key:"_getEntry",value:function(e){if("number"==typeof e){if(0<=e&&e<this._entries.length)return this._entries[e]}else if("string"==typeof e){if(this._name_map.hasOwnProperty(e))return this._name_map[e]}else if(this._entries.length>0)return this._entries[0];return null}}],[{key:"getSupportedExtensions_glTF",value:function(){return["KHR_materials_unlit"]}}]),e}(),Rv=function(){function e(t,r,n){Ge(this,e),this._builder=new Iv(t,r,n)}return qe(e,[{key:"getPrimitives",value:function(e){return this._builder.getPrimitives(e)}}]),e}(),Iv=function(){function e(t,r,n){Ge(this,e),n.buffer_map||(n.buffer_map=new Map,n.texture_map=new Map),this._mr_scene=t,this._glenv=t.glenv,this._primitives=[],this._pickPrimitives=[],this._buffer_map=n.buffer_map,this._texture_map=n.texture_map;var i=hs.setIdentity(hs.createMatrix()),a=!0,o=!1,s=void 0;try{for(var u,_=r.root_nodes[Symbol.iterator]();!(a=(u=_.next()).done);a=!0){var l=u.value;this._addNode(l,i)}}catch(e){o=!0,s=e}finally{try{a||null==_.return||_.return()}finally{if(o)throw s}}}return qe(e,[{key:"getPrimitives",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e.ridMaterial?this._pickPrimitives:this._primitives}},{key:"_addNode",value:function(t,r){var n=e._getNodeToScene(t,r);if(null!==t.mesh){var i=!0,a=!1,o=void 0;try{for(var s,u=t.mesh.primitives[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value;this._primitives.push(this._createPrimitive(_,n,{ridMaterial:!1})),this._pickPrimitives.push(this._createPrimitive(_,n,{ridMaterial:!0}))}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}}var l=!0,c=!1,h=void 0;try{for(var f,d=t.children[Symbol.iterator]();!(l=(f=d.next()).done);l=!0){var v=f.value;this._addNode(v,n)}}catch(e){c=!0,h=e}finally{try{l||null==d.return||d.return()}finally{if(c)throw h}}}},{key:"_createPrimitive",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=this._createMesh(e),i=this._createMaterial(e,{ridMaterial:r.ridMaterial}),a=new c_(this._glenv,n,i,hs.createMatrix(t));return a.pivot=this._createMeshPivot(e),a.bbox=this._createBoundingBox(e),a.properties=this._createProperties(e),a}},{key:"_createMesh",value:function(t){var r=new k_.Initializer(e._convertPrimitiveMode(t),e._calcNumVertices(t)),n=t.attributes;for(var i in n)this._addAttribToInit(r,i,n[i]);var a=t.indices;return null!==a&&this._addIndexToInit(r,a),new k_(this._glenv,r)}},{key:"_addAttribToInit",value:function(t,r,n){var i=this._findMeshBuffer(n.bufferView.buffer,g_.Target.ATTRIBUTE),a=e._NumComponents[n.type],o=e._ComponentType[n.componentType],s={normalized:n.normalized,byte_stride:n.bufferView.byteStride,byte_offset:n.bufferView.byteOffset+n.byteOffset},u=e._VertexAttribId[r]||r;t.addAttribute(u,i,a,o,s)}},{key:"_addIndexToInit",value:function(t,r){var n=this._findMeshBuffer(r.bufferView.buffer,g_.Target.INDEX),i=r.count,a=e._ComponentType[r.componentType],o={byte_offset:r.bufferView.byteOffset+r.byteOffset};t.addIndex(n,i,a,o)}},{key:"_findMeshBuffer",value:function(e,t){var r=this._buffer_map.get(e);return void 0===r&&(r=new g_(this._glenv,e.binary,{target:t}),this._buffer_map.set(e,r)),r}},{key:"_createMaterial",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r="basic",n={};e.material&&e.material.commonData.getExtensions("KHR_materials_unlit")&&(r="unlit",n.is_unlit=!0),t.ridMaterial&&(n.ridMaterial=!0);var i=this._mr_scene,a="_ModelEntity_model_material_"+r+(t.ridMaterial?"_pick":"");return i[a]||(i[a]=new kv(i.glenv,n)),i[a]}},{key:"_createMeshPivot",value:function(e){var t=null,r=this._createBoundingBox(e);if(null!==r){t=hs.createVector3();for(var n=0;n<3;++n)t[n]=(r[0][n]+r[1][n])/2}return t}},{key:"_createBoundingBox",value:function(e){var t=null,r=e.attributes.POSITION;if(void 0!==r){var n=r.min,i=r.max;null!==n&&null!==i&&(t=[hs.createVector3(n),hs.createVector3(i)])}return t}},{key:"_createProperties",value:function(e){var t=e.material;if(null===t)return{pbrMetallicRoughness:{baseColorFactor:hs.createVector4f([1,1,1,1]),baseColorTexture:null,metallicFactor:1,roughnessFactor:1,metallicRoughnessTexture:null},doubleSided:!1,alphaMode:"OPAQUE",alphaCutoff:.5,emissiveFactor:hs.createVector3f([0,0,0]),emissiveTexture:null,normalTexture:null,occlusionTexture:null};var r=t.pbrMetallicRoughness;return{pbrMetallicRoughness:{baseColorFactor:hs.createVector4f(r.baseColorFactor),baseColorTexture:this._createTextureParam(r.baseColorTexture),metallicFactor:r.metallicFactor,roughnessFactor:r.roughnessFactor,metallicRoughnessTexture:this._createTextureParam(r.metallicRoughnessTexture)},doubleSided:t.doubleSided,alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,emissiveFactor:hs.createVector3f(t.emissiveFactor),emissiveTexture:this._createTextureParam(t.emissiveTexture),normalTexture:this._createTextureParam(t.normalTexture),occlusionTexture:this._createTextureParam(t.occlusionTexture)}}},{key:"_createTextureParam",value:function(e){if(null===e)return null;var t={texture:this._findTexture(e.texture),texCoord:e.texCoord};return e instanceof xv?t.scale=e.scale:e instanceof Tv&&(t.strength=e.strength),t}},{key:"_findTexture",value:function(e){var t=this._texture_map.get(e);if(void 0===t){var r=e.sampler,n=this._glenv.context,i={mag_filter:void 0!==r.magFilter?r.magFilter:n.LINEAR,min_filter:void 0!==r.minFilter?r.minFilter:n.LINEAR_MIPMAP_LINEAR,wrap_s:r.wrapS,wrap_t:r.wrapT,flip_y:!1};t=new pv(this._glenv,e.source.image,i),this._texture_map.set(e,t)}return t}}],[{key:"_getNodeToScene",value:function(e,t){var r=t,n=e.matrix;return null!==n&&(r=hs.createMatrix(),hs.mul_AA(t,n,r)),r}},{key:"_convertPrimitiveMode",value:function(t){return e._DrawMode[t.mode]}},{key:"_calcNumVertices",value:function(e){var t=e.attributes,r=[];for(var n in t){var i=t[n];r.push(i.count)}return Math.min.apply(null,r)}},{key:"fastCloneProperties",value:function(t){var r=t.pbrMetallicRoughness;return{pbrMetallicRoughness:{baseColorFactor:hs.createVector3f(r.baseColorFactor),baseColorTexture:e._fastCloneTextureParam(r.baseColorTexture),metallicFactor:r.metallicFactor,roughnessFactor:r.roughnessFactor,metallicRoughnessTexture:e._fastCloneTextureParam(r.metallicRoughnessTexture)},doubleSided:t.doubleSided,alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,emissiveFactor:hs.createVector3f(t.emissiveFactor),emissiveTexture:e._fastCloneTextureParam(t.emissiveTexture),normalTexture:e._fastCloneTextureParam(t.normalTexture),occlusionTexture:e._fastCloneTextureParam(t.occlusionTexture)}}},{key:"_fastCloneTextureParam",value:function(e){if(null===e)return null;var t={texture:e.texture,texCoord:e.texCoord};return"scale"in e?t.scale=e.scale:"strength"in e&&(t.strength=e.strength),t}}]),e}();Iv._DrawMode={0:k_.DrawMode.POINTS,1:k_.DrawMode.LINES,2:k_.DrawMode.LINE_LOOP,3:k_.DrawMode.LINE_STRIP,4:k_.DrawMode.TRIANGLES,5:k_.DrawMode.TRIANGLE_STRIP,6:k_.DrawMode.TRIANGLE_FAN},Iv._NumComponents={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},Iv._ComponentType={5120:k_.ComponentType.BYTE,5121:k_.ComponentType.UNSIGNED_BYTE,5122:k_.ComponentType.SHORT,5123:k_.ComponentType.UNSIGNED_SHORT,5125:k_.ComponentType.UNSIGNED_INT,5126:k_.ComponentType.FLOAT},Iv._VertexAttribId={POSITION:"a_position",NORMAL:"a_normal",TANGENT:"a_tangent",TEXCOORD_0:"a_texcoord",TEXCOORD_1:"a_texcoord1",COLOR_0:"a_color"};var Pv="/**\n * 太さ付き線分の頂点シェーダ\n */\n\nattribute vec4 a_position;      // 頂点位置 (モデル座標系)\nattribute vec3 a_direction;     // 線分方向 (モデル座標系) = 終点位置 - 始点位置\nattribute vec2 a_where;         // 線分の4隅指定: 始点左: {-1, 1}, 始点右: {-1, -1}, 終点左: {1, 1}, 終点右: {1, -1}\nattribute float a_length;\n\nuniform mat4 u_obj_to_clip;     // モデル座標系からクリップ座標系への変換\nuniform vec3 u_sparam;          // 画面パラメータ: {2/w, 2/h, h/w}\nuniform vec2 u_thickness;       // 線の太さの半分: {u, v}\n\nvarying highp float  v_length;  // 始点からの距離 (PathEntityのみ利用)\n\nvec2\noffset( vec4 cpos )\n{\n    vec4 q0 = cpos;\n    q0.y *= u_sparam.z;  // q0 = A * q0\n    vec4 q1 = cpos + u_obj_to_clip * vec4( a_direction, 0 );\n    q1.y *= u_sparam.z;  // q1 = A * q1\n\n    vec2 ds = normalize( q1.xy / q1.w - q0.xy / q0.w );\n    vec2 wt = a_where * u_thickness;\n    return mat2( ds.x, ds.y, -ds.y, ds.x ) * wt;\n}\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += offset( gl_Position ) * u_sparam.xy * gl_Position.w;\n    v_length = a_length;\n}\n",Sv="/**\n * 太さ付き線分のフラグメントシェーダ\n * RID描画に対応\n */\n\nprecision mediump float;\n\n\n\n#ifdef PATH\nuniform highp float u_lower_length; // 距離の下限値 (PathEntityのみ利用)\nuniform highp float u_upper_length; // 距離の上限値 (PathEntityのみ利用)\n\nvarying highp float  v_length;      // 始点からの距離 (PathEntityのみ利用)\n#endif // PATH\n\n#ifdef RID\nuniform highp vec4 u_rid;           // rid\n#else // RID\nuniform vec4 u_color;               // 線の基本色と不透明度\n#endif // RID\n\n\nvoid\nmain()\n{\n#ifdef PATH\n    if ( u_lower_length <= v_length && v_length <= u_upper_length ) {\n#endif // PATH\n\n#ifdef RID\n        gl_FragColor = u_rid;\n#else // RID\n        gl_FragColor = vec4( u_color.xyz * u_color.w, u_color.w );\n#endif // RID\n\n#ifdef PATH\n    }\n    else {\n        discard;  // フラグメントを破棄\n    }\n#endif // PATH\n}\n",Mv=function(e){function t(e,r){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};Ge(this,t);var a=t._getPreamble(r,i);return(n=Ke(this,He(t).call(this,e,a+Pv,a+Sv)))._line_type=r,n}return Ye(t,e),qe(t,[{key:"isTranslucent",value:function(e,r){var n=r.properties;return(void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY)<1}},{key:"setParameters",value:function(e,r){$e(He(t.prototype),"setParameters",this).call(this,e,r);var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;i[0]=2/e._width,i[1]=2/e._height,i[2]=e._height/e._width,this.setVector3("u_sparam",i);var a=n.width||t.DEFAULT_WIDTH,o=t._thickness;if(o[0]=a/2,o[1]=a/2,this.setVector2("u_thickness",o),e.getRenderTarget()===fh.SCENE){var s=void 0!==n.color?n.color:t.DEFAULT_COLOR,u=void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY,_=t._color;hs.copyVector3(s,_),_[3]=u,this.setVector4("u_color",_)}if(this._line_type==Uv.LineType.PATH){var l=n.lower_length;this.setFloat("u_lower_length",l);var c=n.upper_length;this.setFloat("u_upper_length",c)}}}],[{key:"_getPreamble",value:function(e,t){var r=[];return e==Uv.LineType.PATH&&r.push("#define PATH"),t.ridMaterial&&r.push("#define RID"),r.join("\n")+"\n\n"}}]),t}(yv);Mv.DEFAULT_WIDTH=1,Mv.DEFAULT_COLOR=hs.createVector3f([1,1,1]),Mv.DEFAULT_OPACITY=1,Mv.DEFAULT_LOWER_LENGTH=0,Mv.DEFAULT_UPPER_LENGTH=0,Mv._sparam=hs.createVector3f(),Mv._thickness=hs.createVector2f(),Mv._color=hs.createVector4f();var Lv=function(){function e(){Ge(this,e),this._is_compiled=!1,this._point_array=new Float64Array(0),this._num_points=0,this._node_array=new Uint32Array(0),this._next_node=0}return qe(e,[{key:"addPoint",value:function(e){this._checkNotCompiled(),this._ensurePointArrayCapacity(2);var t=2*this._num_points;this._point_array[t]=e.longitude,this._point_array[t+1]=e.latitude,this._num_points+=1}},{key:"addPoints",value:function(e,t,r,n){this._checkNotCompiled(),this._ensurePointArrayCapacity(2*n);for(var i=t,a=2*this._num_points,o=this._point_array,s=0;s<n;++s)o[a]=e[i],o[a+1]=e[i+1],i+=r,a+=2;this._num_points+=n}},{key:"compile",value:function(){this._is_compiled||(this._buildCollisionQuadTree(),this._node_array.length>this._next_node&&(this._node_array=new Uint32Array(this._node_array.slice(0,this._next_node))),this._point_array=null,this._is_compiled=!0)}},{key:"intersectsWith",value:function(e){if(0==this._node_array.length)return!1;for(var t=e.getFlatAreaList(),r=0;r<t.length;++r)if(this._intersectsWith(t[r]))return!0;return!1}},{key:"_intersectsWith",value:function(e){for(var t=0,r=this._node_array,n=0;n<e.length;++n){if((t=r[t+e[n]])==Fv)return!0;if(t==Cv)return!1}return!0}},{key:"_checkNotCompiled",value:function(){if(this._is_compiled)throw new Error("EitityRegion is already compiled.")}},{key:"_ensurePointArrayCapacity",value:function(e){var t=2*this._num_points,r=t+e,n=this._point_array.length;if(r>n){var i=Math.max(r,Math.floor(1.5*n)),a=new Float64Array(i);a.set(this._point_array.slice(0,t)),this._point_array=a}}},{key:"_buildCollisionQuadTree",value:function(){for(var e=2*Math.PI,t=this._point_array,r=2*this._num_points,n=0;n<r;){var i=t[n++],a=t[n++],o=i+180*Math.floor((90-a)/360+Math.floor((90+a)/360)),s=o-360-360*Math.floor((o-180)/360),u=90-Math.abs(90-a+360*Math.floor((90+a)/360)),_=s*hs.DEGREE/e+.5,l=.5-hs.invGudermannian(u*hs.DEGREE)/e;this._addCollisionQuadTreeNode(_,l)}this._next_node>0&&(this._setFullNodeRecur(0),this._reduceNodeRecur(0))}},{key:"_addCollisionQuadTreeNode",value:function(e,t){if(!(t<0||t>1))for(var r=1<<Dv,n=hs.clamp(Math.floor(e*r),0,r-1),i=Math.min(Math.floor(t*r),r-1),a=this._findRootNode(),o=r>>1;0!=o;o>>=1){var s=0==(n&o)?0:1,u=0==(i&o)?0:2;a=this._findChildNode(a,s+u)}}},{key:"_findRootNode",value:function(){if(0==this._next_node){this._ensureNodeArrayCapacity();for(var e=0;e<4;++e)this._node_array[e]=Cv;this._next_node=4}return 0}},{key:"_findChildNode",value:function(e,t){var r=this._node_array[e+t];if(0==r){this._ensureNodeArrayCapacity(),r=this._next_node;for(var n=0;n<4;++n)this._node_array[r+n]=Cv;this._next_node+=4,this._node_array[e+t]=r}return r}},{key:"_setFullNodeRecur",value:function(e){for(var t=this._node_array,r=!0,n=0;n<4;++n){var i=t[e+n];i!=Cv&&(this._setFullNodeRecur(i),r=!1)}if(r)for(n=0;n<4;++n)t[e+n]=Fv}},{key:"_reduceNodeRecur",value:function(e){for(var t=this._node_array,r=0,n=0;n<4;++n){var i=t[e+n];i==Fv?++r:i!=Cv&&this._reduceNodeRecur(i)&&(t[e+n]=Fv,++r)}return 4==r}},{key:"_ensureNodeArrayCapacity",value:function(){var e=this._next_node,t=e+4,r=this._node_array.length;if(t>r){var n=Math.max(t,Math.floor(1.5*r)),i=new Uint32Array(n);i.set(this._node_array.slice(0,e)),this._node_array=i}}}]),e}(),Dv=20,Cv=0,Fv=4294967295,Nv=function(){function e(){Ge(this,e),this._tree_root=null}return qe(e,[{key:"getAreaStatus",value:function(e){var t=this._get_area_node(e);return t===I_.AreaStatus.EMPTY||t===I_.AreaStatus.FULL?t:I_.AreaStatus.PARTIAL}},{key:"getAreaContent",value:function(e){var t=this._get_area_node(e);return t===I_.AreaStatus.EMPTY||t===I_.AreaStatus.FULL?t:t.content}},{key:"getInitialContent",value:function(){return null}},{key:"createAreaContent",value:function(e,t,r,n){return I_.AreaStatus.EMPTY}},{key:"notifyForUpdateContent",value:function(){this._tree_root=null}},{key:"_create_area_node",value:function(e,t,r,n){var i=this.createAreaContent(e,t-r,r,n);return i===I_.AreaStatus.EMPTY||i===I_.AreaStatus.FULL?i:new Ov(i)}},{key:"_get_area_node",value:function(e){var t=2,r=-1,n=1;if(null===this._tree_root){var i=this.getInitialContent();this._tree_root=this._create_area_node(r,n,t,i)}for(var a=this._tree_root,o=Math.round(Math.pow(2,e.z)),s=e.x,u=e.y;1!=o&&a!==I_.AreaStatus.EMPTY&&a!==I_.AreaStatus.FULL;){var _=s>=(o/=2)?1:0,l=u>=o?1:0;r+=_*(t/=2),n-=l*t;var c=_+2*l,h=a.children[c];null===h&&(h=this._create_area_node(r,n,t,a.content),a.children[c]=h),s-=_*o,u-=l*o,a=h}return a}}]),e}(),Ov=function e(t){Ge(this,e),this.children=[null,null,null,null],this.content=t},Uv=function(e){function t(e,r,n){var i;return Ge(this,t),(i=Ke(this,He(t).call(this,e,n)))._line_type=r,i.altitude_mode===R_.CLAMP?(i._producer=new Bv(Je(i)),i._is_flake_mode=!0):(i._producer=new Vv(Je(i)),i._is_flake_mode=!1),i}return Ye(t,e),qe(t,[{key:"getPrimitiveProducer",value:function(){return this._is_flake_mode?null:this._producer}},{key:"getFlakePrimitiveProducer",value:function(){return this._is_flake_mode?this._producer:null}},{key:"onChangeAltitudeMode",value:function(e){this.altitude_mode===R_.CLAMP?(this._producer=new Bv(this),this._is_flake_mode=!0):(this._producer=new Vv(this),this._is_flake_mode=!1)}},{key:"setLineWidth",value:function(e){this._width!==e&&(this._width=e,this._producer.onChangeProperty())}},{key:"setColor",value:function(e){this._color[0]===e[0]&&this._color[1]===e[1]&&this._color[2]===e[2]||(hs.copyVector3(e,this._color),this._producer.onChangeProperty())}},{key:"setOpacity",value:function(e){this._opacity!==e&&(this._opacity=e,this._producer.onChangeProperty())}},{key:"_getLineMaterial",value:function(e){var t=this.scene,r="_AbstractLineEntity_material"+(this._line_type===jv.PATH?"_path":"_markerline")+(e===fh.RID?"_pick":"");if(!t[r]){var n={ridMaterial:e===fh.RID};t[r]=new Mv(t.glenv,this._line_type,n)}return t[r]}}]),t}(I_),Vv=function(e){function t(e){var r;Ge(this,t),(r=Ke(this,He(t).call(this,e)))._transform=hs.setIdentity(hs.createMatrix()),r._pivot=hs.createVector3(),r._bbox=[hs.createVector3(),hs.createVector3()],r._properties={width:1,color:hs.createVector3f(),opacity:1},e._line_type==jv.PATH&&(r._properties.lower_length=0,r._properties.upper_length=0);var n=e._getLineMaterial(fh.SCENE),i=new c_(e.scene.glenv,null,n,r._transform);i.pivot=r._pivot,i.bbox=r._bbox,i.properties=r._properties,r._primitive=i;var a=e._getLineMaterial(fh.RID),o=new c_(e.scene.glenv,null,a,r._transform);return o.pivot=r._pivot,o.bbox=r._bbox,o.properties=r._properties,r._pickPrimitive=o,r._primitives=[i],r._pickPrimitives=[o],r._geom_dirty=!0,r}return Ye(t,e),qe(t,[{key:"createRegions",value:function(){var e=new Lv;return e.addPoints(this.entity._point_array,0,3,this._numPoints()),[e]}},{key:"onChangeElevation",value:function(e){this._geom_dirty=!0}},{key:"getPrimitives",value:function(e){return this._num_floats<6?[]:(this._updatePrimitive(),e.getRenderTarget()===fh.SCENE?this._primitives:this._pickPrimitives)}},{key:"onChangePoints",value:function(){this.needToCreateRegions(),this._geom_dirty=!0}},{key:"onChangeProperty",value:function(){}},{key:"_updatePrimitive",value:function(){if(this._updateProperties(),this._geom_dirty){var e=this.entity,t=this._numPoints(),r=fs.toGocsArray(this._getFlatGeoPoints_with_Absolute(),t,new Float64Array(e._num_floats));this._updateTransformPivotBBox(r,t);var n=e._line_type===jv.PATH,i=n?e._length_array:void 0,a={vtype:[{name:"a_position",size:3},{name:"a_direction",size:3},{name:"a_where",size:2}],vertices:this._createVertices(r,t,i),indices:this._createIndices()};n&&a.vtype.push({name:"a_length",size:1});var o=new k_(e.scene.glenv,a),s=this._primitive;s.mesh&&s.mesh.dispose(),s.mesh=o;var u=this._pickPrimitive;u.mesh&&u.mesh.dispose(),u.mesh=o,this._geom_dirty=!1}}},{key:"_updateProperties",value:function(){var e=this.entity,t=this._properties;t.width=e._width,hs.copyVector3(e._color,t.color),t.opacity=e._opacity,t.lower_length=e._lower_length,t.upper_length=e._upper_length}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){var e=this.entity,t=e._point_array,r=e._num_floats,n=null;switch(e.altitude_mode){case R_.RELATIVE:var i=this._numPoints();n=new Float64Array(r),e.scene.viewer.getExistingElevations(i,t,0,3,n,2,3);for(var a=0;a<r;a+=3)n[a]=t[a],n[a+1]=t[a+1],n[a+2]+=t[a+2];break;default:n=t}return n}},{key:"_updateTransformPivotBBox",value:function(e,t){var r=e[0],n=e[1],i=e[2],a=this._transform;a[12]=r,a[13]=n,a[14]=i;for(var o=0,s=0,u=0,_=Number.MAX_VALUE,l=Number.MAX_VALUE,c=Number.MAX_VALUE,h=-Number.MAX_VALUE,f=-Number.MAX_VALUE,d=-Number.MAX_VALUE,v=0;v<t;++v){var p=3*v,y=e[p]-r,g=e[p+1]-n,m=e[p+2]-i;o+=y,s+=g,u+=m,y<_&&(_=y),g<l&&(l=g),m<c&&(c=m),y>h&&(h=y),g>f&&(f=g),m>d&&(d=m)}var k=this._pivot;k[0]=o/t,k[1]=s/t,k[2]=u/t;var E=this._bbox,w=E[0],b=E[1];w[0]=_,w[1]=l,w[2]=c,b[0]=h,b[1]=f,b[2]=d}},{key:"_createVertices",value:function(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,n=void 0!==r,i=e[0],a=e[1],o=e[2],s=t-1,u=4*s,_=new Float32Array((n?9:8)*u),l=0;l<s;++l)for(var c=3*l,h=e[c]-i,f=e[c+1]-a,d=e[c+2]-o,v=e[c+3]-i,p=e[c+4]-a,y=e[c+5]-o,g=e[c+3]-e[c],m=e[c+4]-e[c+1],k=e[c+5]-e[c+2],E=(n?36:32)*l,w=0;w<4;++w){var b=w<2,x=E+w*(n?9:8);switch(_[x]=b?h:v,_[x+1]=b?f:p,_[x+2]=b?d:y,_[x+3]=g,_[x+4]=m,_[x+5]=k,w){case 0:_[x+6]=-1,_[x+7]=1;break;case 1:_[x+6]=-1,_[x+7]=-1;break;case 2:_[x+6]=1,_[x+7]=1;break;case 3:_[x+6]=1,_[x+7]=-1}n&&(_[x+8]=r[b?l:l+1])}return _}},{key:"_createIndices",value:function(){for(var e=this._numPoints()-1,t=new Uint32Array(6*e),r=0;r<e;++r){var n=6*r,i=4*r;t[n]=i,t[n+1]=i+1,t[n+2]=i+2,t[n+3]=i+2,t[n+4]=i+1,t[n+5]=i+3}return t}},{key:"_numPoints",value:function(){return Math.floor(this.entity._num_floats/3)}}]),t}(I_.PrimitiveProducer),Bv=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this,e)))._material_map=Object.keys(fh).reduce((function(t,r){var n=fh[r];return t.set(n,e._getLineMaterial(n)),t}),new Map),r._properties=null,r._area_manager=new Gv(e),r}return Ye(t,e),qe(t,[{key:"getAreaStatus",value:function(e){return this._area_manager.getAreaStatus(e)}},{key:"createMesh",value:function(e,t,r){var n=this._divideXY(e,t);if(0==n.length)return null;var i=this.entity._line_type===jv.PATH,a={vtype:[{name:"a_position",size:3},{name:"a_direction",size:3},{name:"a_where",size:2}],vertices:this._createVertices(e,r,n,i),indices:this._createIndices(n.length)};return i&&a.vtype.push({name:"a_length",size:1}),new k_(this.entity.scene.glenv,a)}},{key:"getMaterialAndProperties",value:function(e){if(null===this._properties){var t=this.entity;this._properties={width:t._width,color:hs.createVector3f(t._color),opacity:t._opacity},t._line_type==jv.PATH&&(this._properties.lower_length=t._lower_length,this._properties.upper_length=t._upper_length)}return{material:this._material_map.get(e.getRenderTarget()),properties:this._properties}}},{key:"onChangePoints",value:function(){this._area_manager.notifyForUpdateContent(),this.notifyForUpdate()}},{key:"onChangeProperty",value:function(){this._properties=null}},{key:"_divideXOnly",value:function(e,t,r){var n=Math.PI*(e.x*t-1),i=Math.PI*((e.x+1)*t-1),a=1<<r,o=(i-n)/a,s=[],u=!0,_=!1,l=void 0;try{for(var c,h=this._area_manager.getAreaContent(e)[Symbol.iterator]();!(u=(c=h.next()).done);u=!0){var f=et(c.value,6),d=f[0],v=f[1],p=f[2],y=f[3],g=f[4],m=f[5],k=et(d<=y?[d,v,p,y,g,m]:[y,g,m,d,v,p],6),E=k[0],w=k[1],b=k[2],x=k[3],T=k[4],A=k[5];if(!(x<n||E>=i))if(E!=x){var R=E,I=w,P=b;if(E<n){var S=(n-E)/(x-E),M=1-S;R=n,I=M*w+S*T,P=M*b+S*A}var L=x,D=T,C=A;if(x>i){var F=(i-E)/(x-E),N=1-F;L=i,D=N*w+F*T,C=N*b+F*A}for(var O=Math.max(Math.ceil((E-n)/o),1),U=Math.min(Math.floor((x-n)/o),a-1),V=R,B=I,z=P,G=O;G<=U;++G){var j=n+o*G,q=(j-E)/(x-E),Y=1-q,H=Y*w+q*T,X=Y*b+q*A;V==j&&B==H||s.push([V,B,z,j,H,X]),V=j,B=H,z=X}V==L&&B==D||s.push([V,B,z,L,D,C])}else s.push([E,w,b,x,T,A])}}catch(e){_=!0,l=e}finally{try{u||null==h.return||h.return()}finally{if(_)throw l}}return s}},{key:"_divideXY",value:function(e,t){var r=2/Math.round(Math.pow(2,e.z)),n=Math.PI*(1-(e.y+1)*r),i=Math.PI*(1-e.y*r),a=1<<t[1],o=(i-n)/a,s=[],u=!0,_=!1,l=void 0;try{for(var c,h=this._divideXOnly(e,r,t[0])[Symbol.iterator]();!(u=(c=h.next()).done);u=!0){var f=et(c.value,6),d=f[0],v=f[1],p=f[2],y=f[3],g=f[4],m=f[5],k=et(v<=g?[d,v,p,y,g,m]:[y,g,m,d,v,p],6),E=k[0],w=k[1],b=k[2],x=k[3],T=k[4],A=k[5];if(!(T<n||w>=i))if(w!=T){var R=E,I=w,P=b;if(w<n){var S=(n-w)/(T-w),M=1-S;R=M*E+S*x,I=n,P=M*b+S*A}var L=x,D=T,C=A;if(T>i){var F=(i-w)/(T-w),N=1-F;L=N*E+F*x,D=i,C=N*b+F*A}for(var O=Math.max(Math.ceil((w-n)/o),1),U=Math.min(Math.floor((T-n)/o),a-1),V=R,B=I,z=P,G=O;G<=U;++G){var j=n+o*G,q=(j-w)/(T-w),Y=1-q,H=Y*E+q*x,X=Y*b+q*A;V==H&&B==j||s.push([V,B,z,H,j,X]),V=H,B=j,z=X}V==L&&B==D||s.push([V,B,z,L,D,C])}else s.push([E,w,b,x,T,A])}}catch(e){_=!0,l=e}finally{try{u||null==h.return||h.return()}finally{if(_)throw l}}return s}},{key:"_createVertices",value:function(e,t,r){for(var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=t.newLinearSampler(),a=__.getCenter(e,hs.createVector3()),o=et(a,3),s=o[0],u=o[1],_=o[2],l=r.length,c=4*l,h=new Float32Array((n?9:8)*c),f=0;f<l;++f)for(var d=et(r[f],6),v=d[0],p=d[1],y=d[2],g=d[3],m=d[4],k=d[5],E=zv(v,p,i),w=et(E,3),b=w[0],x=w[1],T=w[2],A=zv(g,m,i),R=et(A,3),I=R[0],P=R[1],S=R[2],M=b-s,L=x-u,D=T-_,C=I-s,F=P-u,N=S-_,O=I-b,U=P-x,V=S-T,B=(n?36:32)*f,z=0;z<4;++z){var G=z<2,j=B+z*(n?9:8);switch(h[j]=G?M:C,h[j+1]=G?L:F,h[j+2]=G?D:N,h[j+3]=O,h[j+4]=U,h[j+5]=V,z){case 0:h[j+6]=-1,h[j+7]=1;break;case 1:h[j+6]=-1,h[j+7]=-1;break;case 2:h[j+6]=1,h[j+7]=1;break;case 3:h[j+6]=1,h[j+7]=-1}n&&(h[j+8]=G?y:k)}return h}},{key:"_createIndices",value:function(e){for(var t=new Uint32Array(6*e),r=0;r<e;++r){var n=6*r,i=4*r;t[n]=i,t[n+1]=i+1,t[n+2]=i+2,t[n+3]=i+2,t[n+4]=i+1,t[n+5]=i+3}return t}}]),t}(I_.FlakePrimitiveProducer);function zv(e,t,r){var n=e,i=hs.gudermannian(t),a=hs.EARTH_RADIUS+r.sample(e,t),o=Math.cos(i);return[a*o*Math.cos(n),a*o*Math.sin(n),a*Math.sin(i)]}var Gv=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this)))._entity=e,r}return Ye(t,e),qe(t,[{key:"getInitialContent",value:function(){var e=hs.DEGREE,t=Math.PI/2,r=2*Math.PI,n=[],i=this._entity._point_array,a=this._entity._num_floats;if(a<6)return n;for(var o,s,u,_=this._entity._line_type===jv.PATH,l=_?this._entity._length_array:null,c=i[0]*e,h=i[1]*e,f=_?l[0]:0,d=3;d<a;d+=3,c=o,h=s,f=u)if(o=i[d]*e,s=i[d+1]*e,u=_?l[d/3]:0,!(h<=-t||h>=t||s<=-t||s>=t)){var v=c,p=hs.invGudermannian(h),y=f,g=o,m=hs.invGudermannian(s),k=et(v<g?[v,p,y,g,m,u]:[g,m,u,v,p,y],6),E=k[0],w=k[1],b=k[2],x=k[3],T=k[4],A=k[5];if(E<-Math.PI||E>=Math.PI){var R=x-E;((E-=r*(Math.floor((E-Math.PI)/r)+1))<-Math.PI||E>=Math.PI)&&(E=-Math.PI),x=E+R}E==x&&w==T||(n.push([E,w,b,x,T,A]),x>Math.PI&&n.push([E-r,w,b,x-r,T,A]))}return n}},{key:"createAreaContent",value:function(e,t,r,n){var i=Math.PI*e,a=Math.PI*(e+r),o=Math.PI*t,s=Math.PI*(t+r),u=[],_=!0,l=!1,c=void 0;try{for(var h,f=n[Symbol.iterator]();!(_=(h=f.next()).done);_=!0){var d=h.value,v=et(d,5),p=v[0],y=v[1],g=v[3],m=v[4];this._intersect(i,a,o,s,p,y,g,m)&&u.push(d)}}catch(e){l=!0,c=e}finally{try{_||null==f.return||f.return()}finally{if(l)throw c}}return u.length>0?u:I_.AreaStatus.EMPTY}},{key:"_intersect",value:function(e,t,r,n,i,a,o,s){return Math.abs(i-o)<Math.abs(a-s)?this._nhorz_intersect(e,t,r,n,i,a,o,s):this._nhorz_intersect(r,n,e,t,a,i,s,o)}},{key:"_nhorz_intersect",value:function(e,t,r,n,i,a,o,s){var u=et(a<s?[a,s]:[s,a],2),_=u[0],l=u[1];if(_>=n||l<r)return!1;var c=i+(o-i)*((r>=l?r:l)-a)/(s-a),h=i+(o-i)*((n<=_?n:_)-a)/(s-a),f=et(c<h?[c,h]:[h,c],2),d=f[0],v=f[1];return d<t&&v>=e}}]),t}(Nv),jv={MARKERLINE:{id:"MARKERLINE"},PATH:{id:"PATH"}};Uv.LineType=jv;var qv=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this,e,Uv.LineType.MARKERLINE,r)))._point_array=new Float64Array(0),n._num_floats=0,n._width=1,n._color=hs.createVector3([1,1,1]),n._opacity=1,n._setupAnimationBindingBlock(),r&&r.json&&n._setupByJson(r.json),n}return Ye(t,e),qe(t,[{key:"_setupAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ti.find("number"),n=Ti.find("vector3");t.addEntry("width",[r],null,(function(t){e.setLineWidth(t)})),t.addEntry("color",[n],null,(function(t){e.setColor(t)})),t.addEntry("opacity",[r],null,(function(t){e.setOpacity(t)}))}},{key:"addPoints",value:function(e){var t=e.length;if(0!=t){var r=this._num_floats+t,n=this._point_array.length;if(r>n){for(var i=new Float64Array(Math.max(r,2*n)),a=this._point_array,o=this._num_floats,s=0;s<o;++s)i[s]=a[s];this._point_array=i}for(var u=this._point_array,_=this._num_floats,l=0;l<t;++l)u[_+l]=e[l];this._num_floats=r,this._producer.onChangePoints()}}},{key:"_setupByJson",value:function(e){this.addPoints(e.points),void 0!==e.line_width&&this.setLineWidth(e.line_width),void 0!==e.color&&this.setColor(e.color),void 0!==e.opacity&&this.setOpacity(e.opacity)}}]),t}(Uv),Yv=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this,e,Uv.LineType.PATH,r)))._point_array=new Float64Array(0),n._num_floats=0,n._length_array=new Float64Array(0),n._width=1,n._color=hs.createVector3([1,1,1]),n._opacity=1,n._lower_length=0,n._upper_length=0,n._setupAnimationBindingBlock(),r&&r.json&&n._setupByJson(r.json),n}return Ye(t,e),qe(t,[{key:"_setupAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ti.find("number"),n=Ti.find("vector3");t.addEntry("width",[r],null,(function(t){e.setLineWidth(t)})),t.addEntry("color",[n],null,(function(t){e.setColor(t)})),t.addEntry("opacity",[r],null,(function(t){e.setOpacity(t)})),t.addEntry("lower_length",[r],null,(function(t){e.setLowerLength(t)})),t.addEntry("upper_length",[r],null,(function(t){e.setUpperLength(t)}))}},{key:"setLowerLength",value:function(e){this._lower_length!==e&&(this._lower_length=e,this._producer.onChangeProperty())}},{key:"setUpperLength",value:function(e){this._upper_length!==e&&(this._upper_length=e,this._producer.onChangeProperty())}},{key:"addPoints",value:function(e,t){var r=e.length,n=t.length;if(0!=r&&0!=n){var i=this._num_floats/3,a=this._num_floats+r,o=this._point_array.length;if(a>o){for(var s=new Float64Array(Math.max(a,2*o)),u=this._point_array,_=this._num_floats,l=0;l<_;++l)s[l]=u[l];this._point_array=s}var c=i+n,h=this._length_array.length;if(c>h){for(var f=new Float64Array(Math.max(c,2*h)),d=this._length_array,v=i,p=0;p<v;++p)f[p]=d[p];this._length_array=f}for(var y=this._point_array,g=this._num_floats,m=0;m<e.length;++m)y[g+m]=e[m];for(var k=this._length_array,E=i,w=0;w<t.length;++w)k[E+w]=t[w];this._num_floats=a,this._producer.onChangePoints()}}},{key:"_setupByJson",value:function(e){this.addPoints(e.points.positions,e.points.lengths),void 0!==e.line_width&&this.setLineWidth(e.line_width),void 0!==e.color&&this.setColor(e.color),void 0!==e.opacity&&this.setOpacity(e.opacity),void 0!==e.lower_length&&this.setLowerLength(e.lower_length),void 0!==e.upper_length&&this.setUpperLength(e.upper_length)}}]),t}(Uv),Hv="/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;    // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;      // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\n\nuniform mat4 u_obj_to_clip;   // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;        // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;      // テキストのテクスチャ座標\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n}",Xv="/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;        // テクスチャ座標\nuniform sampler2D u_image;      // 画像\n\nvoid\nmain()\n{\n    gl_FragColor = texture2D( u_image, v_texcoord );\n}",Wv=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Ge(this,t),(r=Ke(this,He(t).call(this,e,Hv,n.ridMaterial?nl:Xv))).bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return Ye(t,e),qe(t,[{key:"isTranslucent",value:function(e,t){return!t.properties.enable_bg}},{key:"setParameters",value:function(e,r){$e(He(t.prototype),"setParameters",this).call(this,e,r);var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;if(i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i),e.getRenderTarget()===fh.SCENE){var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle)}}}]),t}(yv);Wv.TEXUNIT_IMAGE=0,Wv._sparam=hs.createVector2f();var Qv="/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;    // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;      // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;    // テクスチャ座標\nattribute vec4 a_color;       // テキストの色と不透明度\n\nuniform mat4 u_obj_to_clip;   // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;        // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;      // テキストのテクスチャ座標\nvarying vec4 v_color;         // テキストの色と不透明度\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n    v_color    = a_color;\n}\n",Zv="/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;     // テキストのテクスチャ座標\nvarying vec4 v_color;        // テキストの色と不透明度\n\nuniform sampler2D u_image;   // テキスト画像\n\nvoid\nmain()\n{\n    float level = texture2D( u_image, v_texcoord ).w;  // 輝度\n    float alpha = v_color.w * level;\n    gl_FragColor = vec4( v_color.xyz * alpha, alpha );\n}\n",Jv=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Ge(this,t),(r=Ke(this,He(t).call(this,e,Qv,n.ridMaterial?nl:Zv))).bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return Ye(t,e),qe(t,[{key:"isTranslucent",value:function(e,t){return!0}},{key:"setParameters",value:function(e,r){$e(He(t.prototype),"setParameters",this).call(this,e,r);var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;if(i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i),e.getRenderTarget()===fh.SCENE){var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle)}}}]),t}(yv);Jv.TEXUNIT_IMAGE=0,Jv._sparam=hs.createVector2f();var Kv=function(){function e(t,r,n,i){Ge(this,e),this._r=t,this._g=r,this._b=n,this._a=i}return qe(e,[{key:"toArray",value:function(){return 0===this._a?[0,0,0,0]:[this.floatToByte(this._r)/this._a,this.floatToByte(this._g)/this._a,this.floatToByte(this._b)/this._a,this._a]}},{key:"toVector4",value:function(){return 0===this._a?[0,0,0,0]:[this._r/this._a,this._g/this._a,this._b/this._a,this._a]}},{key:"toRGBString",value:function(){var e=this.toArray();return"rgba(".concat(Math.round(e[0]),",").concat(Math.round(e[1]),",").concat(Math.round(e[2]),",").concat(e[3],")")}},{key:"floatToByte",value:function(e){return 1===e?255:256*e|0}},{key:"r",get:function(){return this._r}},{key:"g",get:function(){return this._g}},{key:"b",get:function(){return this._b}},{key:"a",get:function(){return this._a}}],[{key:"generateOpacityColor",value:function(t){return new e(t[0],t[1],t[2],1)}},{key:"copyColor",value:function(e,t){return t._r=e._r,t._g=e._g,t._b=e._b,t._a=e._a,t}},{key:"setOpacityColor",value:function(e,t){t._r=e[0],t._g=e[1],t._b=e[2],t._a=1}}]),e}(),$v=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this,e,r)))._entries=[],n._text_parent_props={font_style:"normal",font_weight:"normal",font_size:t.DEFAULT_FONT_SIZE,font_family:t.DEFAULT_FONT_FAMILY,color:Kv.generateOpacityColor(t.DEFAULT_COLOR),stroke_color:Kv.generateOpacityColor(t.DEFAULT_STROKE_COLOR),stroke_width:t.DEFAULT_STROKE_WIDTH,bg_color:Kv.generateOpacityColor(t.DEFAULT_BG_COLOR),enable_stroke:!1,enable_bg:!1},n._animation.addDescendantUnbinder((function(){n._unbindDescendantAnimations()})),n._setupAnimationBindingBlock(),r&&r.json&&n._setupByJson(r.json),n}return Ye(t,e),qe(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"onChangeAltitudeMode",value:function(e){this._primitive_producer&&this._primitive_producer.onChangeAltitudeMode()}},{key:"_unbindDescendantAnimations",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){n.value.animation.unbindAllRecursively()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"_setupAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ti.find("number"),n=Ti.find("string"),i=Ti.find("vector3");t.addEntry("font_style",[n],null,(function(t){e.setFontStyle(t)})),t.addEntry("font_weight",[n],null,(function(t){e.setFontWeight(t)})),t.addEntry("font_size",[r],null,(function(t){e.setFontSize(t)})),t.addEntry("color",[i],null,(function(t){e.setColor(t)})),t.addEntry("stroke_color",[i],null,(function(t){e.setStrokeColor(t)})),t.addEntry("stroke_width",[r],null,(function(t){e.setStrokeLineWidth(t)}))}},{key:"setFontStyle",value:function(e){this._setValueProperty("font_style",e)}},{key:"setFontWeight",value:function(e){this._setValueProperty("font_weight",e)}},{key:"setFontSize",value:function(e){this._setValueProperty("font_size",e)}},{key:"setFontFamily",value:function(e){this._setValueProperty("font_family",e)}},{key:"setColor",value:function(e){this._setColorProperty("color",e)}},{key:"setStrokeColor",value:function(e){this._setColorProperty("stroke_color",e)}},{key:"setStrokeLineWidth",value:function(e){this._setValueProperty("stroke_width",e)}},{key:"setEnableStroke",value:function(e){this._setValueProperty("enable_stroke",e),this._primitive_producer=new ep(this)}},{key:"setBackgroundColor",value:function(e){this._setColorProperty("bg_color",e)}},{key:"setEnableBackground",value:function(e){this._setValueProperty("enable_bg",e),this._primitive_producer=new ep(this)}},{key:"addText",value:function(e,t,r){var n=new tp(this,e,t,r);return this._entries.push(n),this._primitive_producer=new ep(this),this._primitive_producer.onAddTextEntry(),n}},{key:"_getTextMaterial",value:function(e){var t=this.scene;return e===fh.SCENE?(t._TextEntity_text_material||(t._TextEntity_text_material=new Wv(t.glenv)),t._TextEntity_text_material):e===fh.RID?(t._TextEntity_text_material_pick||(t._TextEntity_text_material_pick=new Wv(t.glenv,{ridMaterial:!0})),t._TextEntity_text_material_pick):void 0}},{key:"_getSimpleTextMaterial",value:function(e){var t=this.scene;return e===fh.SCENE?(t._SimpleTextEntity_text_material||(t._SimpleTextEntity_text_material=new Jv(t.glenv)),t._SimpleTextEntity_text_material):e===fh.RID?(t._SimpleTextEntity_text_material_pick||(t._SimpleTextEntity_text_material_pick=new Jv(t.glenv,{ridMaterial:!0})),t._SimpleTextEntity_text_material_pick):void 0}},{key:"_setValueProperty",value:function(e,t){var r=this._text_parent_props;r[e]!=t&&(r[e]=t,this._primitive_producer&&this._primitive_producer.onChangeParentProperty())}},{key:"_setColorProperty",value:function(e,t){var r=this._text_parent_props[e];r.r==t[0]&&r.g==t[1]&&r.b==t[2]||(Kv.setOpacityColor(t,r),this._primitive_producer&&this._primitive_producer.onChangeParentProperty())}},{key:"_setupByJson",value:function(e){var t=new fs,r=!0,n=!1,i=void 0;try{for(var a,o=e.entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;t.setFromArray(s.position),this.addText(s.text,t,s)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}void 0!==e.font_style&&this.setFontStyle(e.font_style),void 0!==e.font_weight&&this.setFontWeight(e.font_weight),void 0!==e.font_size&&this.setFontSize(e.font_size),void 0!==e.font_family&&this.setFontFamily(e.font_family),void 0!==e.color&&this.setColor(e.color),void 0!==e.stroke_color&&this.setStrokeColor(e.stroke_color),void 0!==e.stroke_width&&this.setStrokeLineWidth(e.stroke_width),void 0!==e.enable_stroke&&this.setEnableStroke(e.enable_stroke),void 0!==e.bg_color&&this.setBackgroundColor(e.bg_color),void 0!==e.enable_bg&&this.setEnableBackground(e.enable_bg)}},{key:"_enableStroke",value:function(){return this._text_parent_props.enable_stroke}},{key:"getEntry",value:function(e){return this._entries.find((function(t){return t.id===e}))}}]),t}(I_);$v.DEFAULT_FONT_SIZE=16,$v.DEFAULT_FONT_FAMILY="sans-serif",$v.DEFAULT_COLOR=[1,1,1],$v.DEFAULT_STROKE_COLOR=[0,0,0],$v.DEFAULT_STROKE_WIDTH=.48,$v.DEFAULT_BG_COLOR=[.3,.3,.3],$v.DEFAULT_TEXT_UPPER=1.1,$v.DEFAULT_TEXT_LOWER=.38,$v.SAFETY_PIXEL_MARGIN=1,$v.MAX_IMAGE_WIDTH=4096;var ep=function(e){function t(e){var r;Ge(this,t),(r=Ke(this,He(t).call(this,e)))._glenv=e.scene.glenv,r._dirty=!0,r._transform=hs.setIdentity(hs.createMatrix()),r._properties={enable_bg:!1,image:null};var n=null,i=null;r._isSimpleText()?(n=e._getSimpleTextMaterial(fh.SCENE),i=e._getSimpleTextMaterial(fh.RID)):(n=e._getTextMaterial(fh.SCENE),i=e._getTextMaterial(fh.RID));var a=new c_(r._glenv,null,n,r._transform);a.properties=r._properties,r._primitive=a;var o=new c_(r._glenv,null,i,r._transform);return o.properties=r._properties,r._pickPrimitive=o,r._primitives=[],r._pickPrimitives=[],r}return Ye(t,e),qe(t,[{key:"createRegions",value:function(){var e=new Lv,t=!0,r=!1,n=void 0;try{for(var i,a=this.entity._entries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value.position;e.addPoint(o)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return[e]}},{key:"onChangeElevation",value:function(e){this._dirty=!0}},{key:"getPrimitives",value:function(e){return this._updatePrimitive(),e.getRenderTarget()===fh.SCENE?this._primitives:this._pickPrimitives}},{key:"onChangeParentProperty",value:function(){this._dirty=!0}},{key:"onChangeChildProperty",value:function(){this._dirty=!0}},{key:"onChangeAltitudeMode",value:function(){this._dirty=!0}},{key:"onAddTextEntry",value:function(){this.needToCreateRegions(),this._dirty=!0}},{key:"_updatePrimitive",value:function(){if(this._dirty){if(this._updateProperties(),0==this.entity._entries.length)return this._primitives=[],this._pickPrimitives=[],void(this._dirty=!1);var e=this._createFlatGocsArray();this._updateTransform(e);var t=new rp(this,e);if(!t.isValid())return this._primitives=[],this._dirty=!1,this._primitives;var r=this._properties;r.image&&r.image.dispose(),r.image=t.texture;var n={vtype:this._isSimpleText()?[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2},{name:"a_color",size:4}]:[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2}],vertices:t.vertices,indices:t.indices},i=new k_(this._glenv,n),a=this._primitive;a.mesh&&a.mesh.dispose(),a.mesh=i;var o=this._pickPrimitive;o.mesh&&o.mesh.dispose(),o.mesh=i,this._primitives=[a],this._pickPrimitives=[o],this._dirty=!1}}},{key:"_updateProperties",value:function(){var e=this.entity;this._properties.enable_bg=e._text_parent_props.enable_bg}},{key:"_updateTransform",value:function(e){for(var t=this.entity._entries.length,r=0,n=0,i=0,a=0;a<t;++a){var o=3*a;r+=e[o],n+=e[o+1],i+=e[o+2]}var s=this._transform;s[12]=r/t,s[13]=n/t,s[14]=i/t}},{key:"_createFlatGocsArray",value:function(){var e=this.entity._entries.length;return fs.toGocsArray(this._getFlatGeoPoints_with_Absolute(),e,new Float64Array(3*e))}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){for(var e=this.entity,t=e._entries,r=t.length,n=new Float64Array(3*r),i=0;i<r;++i){var a=t[i].position;n[3*i]=a.longitude,n[3*i+1]=a.latitude}switch(e.altitude_mode){case R_.RELATIVE:case R_.CLAMP:if(e.scene.viewer.getExistingElevations(r,n,0,3,n,2,3),e.altitude_mode===R_.RELATIVE)for(var o=0;o<r;++o)n[3*o+2]+=t[o].position.altitude;break;default:for(var s=0;s<r;++s)n[3*s+2]=t[s].position.altitude}return n}},{key:"_isSimpleText",value:function(){var e=this.entity,t=!0;(e._text_parent_props.enable_bg||e._text_parent_props.enable_stroke)&&(t=!1);for(var r=0;t&&e._entries.length>r;){t=!e._entries[r].enable_stroke,r++}return t}}]),t}(I_.PrimitiveProducer),tp=function(){function e(t,r,n,i){Ge(this,e),this._owner=t,this._text=r,this._position=n.clone(),this._animation=new Zs,this._setupAnimationBindingBlock(),this._props=Object.assign({},i),this._copyColorProperty("color"),this._copyColorProperty("stroke_color"),this._copyColorProperty("bg_color")}return qe(e,[{key:"_setupAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ti.find("number"),n=Ti.find("string"),i=Ti.find("vector3"),a=new fs;t.addEntry("position",[i],null,(function(t){a.setFromArray(t),e.setPosition(a)})),t.addEntry("font_style",[n],null,(function(t){e.setFontStyle(t)})),t.addEntry("font_weight",[n],null,(function(t){e.setFontWeight(t)})),t.addEntry("font_size",[r],null,(function(t){e.setFontSize(t)})),t.addEntry("color",[i],null,(function(t){e.setColor(t)})),t.addEntry("stroke_color",[i],null,(function(t){e.setStrokeColor(t)})),t.addEntry("stroke_width",[r],null,(function(t){e.setStrokeLineWidth(t)})),t.addEntry("text",[n],null,(function(t){e.setText(t)}))}},{key:"setPosition",value:function(e){this._position.longitude===e.longitude&&this._position.latitude===e.latitude&&this._position.altitude===e.altitude||(this._position.assign(e),this._owner.getPrimitiveProducer().onChangeChildProperty())}},{key:"setFontStyle",value:function(e){this._setValueProperty("font_style",e)}},{key:"setFontWeight",value:function(e){this._setValueProperty("font_weight",e)}},{key:"setFontSize",value:function(e){this._setValueProperty("font_size",e)}},{key:"setColor",value:function(e){this._setColorProperty("color",e)}},{key:"setStrokeColor",value:function(e){this._setColorProperty("stroke_color",e)}},{key:"setStrokeLineWidth",value:function(e){this._setValueProperty("stroke_width",e)}},{key:"setEnableStroke",value:function(e){this._setValueProperty("enable_stroke",e),this._owner._primitive_producer=new ep(this._owner)}},{key:"setText",value:function(e){this._text!==e&&(this._text=e,this._owner.getPrimitiveProducer().onChangeChildProperty())}},{key:"_copyColorProperty",value:function(e){var t=this._props;t.hasOwnProperty(e)&&(t[e]=Kv.generateOpacityColor(t[e]))}},{key:"_setValueProperty",value:function(e,t){var r=this._props;r[e]!=t&&(r[e]=t,this._owner.getPrimitiveProducer().onChangeChildProperty())}},{key:"_setColorProperty",value:function(e,t){var r=this._props[e];r?r.r==t[0]&&r.g==t[1]&&r.b==t[2]||(Kv.setOpacityColor(t,r),this._owner.getPrimitiveProducer().onChangeChildProperty()):(this._props[e]=Kv.generateOpacityColor(t),this._owner.getPrimitiveProducer().onChangeChildProperty())}},{key:"text",get:function(){return this._text}},{key:"position",get:function(){return this._position}},{key:"id",get:function(){return this._props.hasOwnProperty("id")?this._props.id:""}},{key:"size",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.font_size||t.font_size}},{key:"color",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.color||t.color}},{key:"font",get:function(){var e=this._props,t=this._owner._text_parent_props,r=e.font_style||t.font_style,n=e.font_weight||t.font_weight,i=e.font_family||t.font_family;return r+" normal "+n+" "+this.size+"px "+i}},{key:"stroke_color",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.stroke_color||t.stroke_color}},{key:"stroke_width",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.stroke_width||t.stroke_width}},{key:"enable_stroke",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.enable_stroke||t.enable_stroke}},{key:"bg_color",get:function(){var e=this._props,t=this._owner._text_parent_props;return e.bg_color||t.bg_color}},{key:"enable_background",get:function(){return this._owner._text_parent_props.enable_bg}},{key:"animation",get:function(){return this._animation}}]),e}();$v.Entry=tp;var rp=function(){function e(t,r){Ge(this,e),this._owner=t,this._items=this._createItemList(),this._is_valid=!0;var n=this._createRowLayouts();if(0!=n.length){var i=this._setupLocation(n);this._isSimpleTextWithAllItems(this._items)?(this._texture=this._createTextureForSimple(i.width,i.height),this._vertices=this._createVerticesForSimple(i.width,i.height,r)):(this._texture=this._createTexture(i.width,i.height),this._vertices=this._createVertices(i.width,i.height,r)),this._indices=this._createIndices()}else this._is_valid=!1}return qe(e,[{key:"isValid",value:function(){return this._is_valid}},{key:"_createItemList",value:function(){var e=ov.createCanvasContext(1,1),t=[],r=!0,n=!1,i=void 0;try{for(var a,o=this._owner.entity._entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;t.push(new np(this,s,e))}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return t}},{key:"_createRowLayouts",value:function(){var e=[].concat(this._items);e.sort((function(e,t){return e.height_pixel-t.height_pixel}));for(var t=[];e.length>0;){var r=new ip(e);r.isValid()&&t.push(r)}return t}},{key:"_createTexture",value:function(e,t){var r=ov.createCanvasContext(e,t);r.textAlign="left",r.textBaseline="alphabetic",r.fillStyle="rgba( 255, 255, 255, 1.0 )";for(var n=this._items,i=0;i<n.length;++i){var a=n[i];a.is_canceled||(a._entry.enable_background&&a.drawRect(r),a._entry.enable_stroke&&a.drawStrokeText(r),a.drawText(r))}var o=this._owner._glenv,s={usage:pv.Usage.TEXT};return new pv(o,r.canvas,s)}},{key:"_createVertices",value:function(e,t,r){for(var n=[],i=this._owner._transform,a=i[12],o=i[13],s=i[14],u=this._items,_=0;_<u.length;++_){var l=u[_];if(!l.is_canceled){var c=3*_,h=r[c]-a,f=r[c+1]-o,d=r[c+2]-s,v=l.pos_x,p=l.pos_y,y=l.upper,g=l.lower,m=l.width,k=1/e,E=1/t;n.push(h,f,d),n.push(-m/2,-g),n.push(v*k,1-(p+g)*E),n.push(h,f,d),n.push(m/2,-g),n.push((v+m)*k,1-(p+g)*E),n.push(h,f,d),n.push(-m/2,y),n.push(v*k,1-(p-y)*E),n.push(h,f,d),n.push(m/2,y),n.push((v+m)*k,1-(p-y)*E)}}return n}},{key:"_createTextureForSimple",value:function(e,t){var r=ov.createCanvasContext(e,t);r.textAlign="left",r.textBaseline="alphabetic",r.fillStyle="rgba( 255, 255, 255, 1.0 )";for(var n=this._items,i=0;i<n.length;++i){var a=n[i];a.is_canceled||a.drawText(r)}var o=this._owner._glenv,s={usage:pv.Usage.SIMPLETEXT};return new pv(o,r.canvas,s)}},{key:"_createVerticesForSimple",value:function(e,t,r){for(var n=[],i=this._owner._transform,a=i[12],o=i[13],s=i[14],u=this._items,_=0;_<u.length;++_){var l=u[_];if(!l.is_canceled){var c=l.entry.color.toVector4(),h=3*_,f=r[h]-a,d=r[h+1]-o,v=r[h+2]-s,p=l.pos_x,y=l.pos_y,g=l.upper,m=l.lower,k=l.width,E=1/e,w=1/t;n.push(f,d,v),n.push(-k/2,-m),n.push(p*E,1-(y+m)*w),n.push(c[0],c[1],c[2],1),n.push(f,d,v),n.push(k/2,-m),n.push((p+k)*E,1-(y+m)*w),n.push(c[0],c[1],c[2],1),n.push(f,d,v),n.push(-k/2,g),n.push(p*E,1-(y-g)*w),n.push(c[0],c[1],c[2],1),n.push(f,d,v),n.push(k/2,g),n.push((p+k)*E,1-(y-g)*w),n.push(c[0],c[1],c[2],1)}}return n}},{key:"_createIndices",value:function(){for(var e=[],t=this._items,r=0;r<t.length;++r){if(!t[r].is_canceled){var n=4*r;e.push(n,n+1,n+2,n+2,n+1,n+3)}}return e}},{key:"_setupLocation",value:function(e){var t=0,r=0;r+=$v.SAFETY_PIXEL_MARGIN;for(var n=0;n<e.length;++n){var i=e[n];i.locate(r),t=Math.max(i.width_assumed,t),r+=i.height_pixel+$v.SAFETY_PIXEL_MARGIN}return{width:t,height:r}}},{key:"_isSimpleText",value:function(e){return!e._entry.enable_background&&!e._entry.enable_stroke}},{key:"_isSimpleTextWithAllItems",value:function(e){for(var t=!0,r=0;t&&e.length>r;){var n=e[r];t=this._isSimpleText(n),r++}return t}},{key:"texture",get:function(){return this._texture}},{key:"vertices",get:function(){return this._vertices}},{key:"indices",get:function(){return this._indices}}]),e}(),np=function(){function e(t,r,n){Ge(this,e),this._entry=r,this._pos_x=0,this._pos_y=0,n.font=r.font,this._width=n.measureText(r.text).width,this._upper=r.size*$v.DEFAULT_TEXT_UPPER,this._lower=r.size*$v.DEFAULT_TEXT_LOWER,this._is_canceled=!1}return qe(e,[{key:"cancel",value:function(){this._is_canceled=!0}},{key:"locate",value:function(e,t){this._pos_x=e,this._pos_y=t+Math.ceil(this._upper)}},{key:"drawTextOnly",value:function(e){var t=this._entry;e.font=t.font,e.fillText(t.text,this._pos_x,this._pos_y)}},{key:"drawText",value:function(e){var t=this._entry;e.font=t.font,e.fillStyle=t.color.toRGBString(),e.fillText(t.text,this._pos_x,this._pos_y)}},{key:"drawStrokeText",value:function(e){var t=this._entry;e.font=t.font,e.strokeStyle=t.stroke_color.toRGBString(),e.lineWidth=2*t.stroke_width,e.lineJoin="round",e.strokeText(t.text,this._pos_x,this._pos_y)}},{key:"drawRect",value:function(e){var t=this._entry;e.fillStyle=t.bg_color.toRGBString(),e.fillRect(this._pos_x-$v.SAFETY_PIXEL_MARGIN,this._pos_y-this._upper-$v.SAFETY_PIXEL_MARGIN,this.width_pixel+$v.SAFETY_PIXEL_MARGIN,this.height_pixel+$v.SAFETY_PIXEL_MARGIN)}},{key:"entry",get:function(){return this._entry}},{key:"pos_x",get:function(){return this._pos_x}},{key:"pos_y",get:function(){return this._pos_y}},{key:"width",get:function(){return this._width}},{key:"upper",get:function(){return this._upper}},{key:"lower",get:function(){return this._lower}},{key:"width_pixel",get:function(){return Math.ceil(this._width)}},{key:"height_pixel",get:function(){return Math.ceil(this._upper)+Math.ceil(this._lower)}},{key:"is_canceled",get:function(){return this._is_canceled}}]),e}(),ip=function(){function e(t){Ge(this,e);var r=0,n=0,i=[];for(r+=$v.SAFETY_PIXEL_MARGIN;t.length>0;){var a=t.shift(),o=a.width_pixel+$v.SAFETY_PIXEL_MARGIN;if(r+o<=$v.MAX_IMAGE_WIDTH)i.push(a),r+=o,n=Math.max(a.height_pixel,n);else{if(0!=i.length){t.unshift(a);break}a.cancel()}}this._items=i,this._width_assumed=r,this._height_pixel=n}return qe(e,[{key:"isValid",value:function(){return this._items.length>0}},{key:"locate",value:function(e){var t=this._items,r=0;r+=$v.SAFETY_PIXEL_MARGIN;for(var n=0;n<t.length;++n){var i=t[n];i.locate(r,e),r+=i.width_pixel+$v.SAFETY_PIXEL_MARGIN}}},{key:"items",get:function(){return this._items}},{key:"width_assumed",get:function(){return this._width_assumed}},{key:"height_pixel",get:function(){return this._height_pixel}}]),e}(),ap=function(e){function t(e,r){var n;if(Ge(this,t),(n=Ke(this,He(t).call(this,e,r)))._position=new fs(0,0,0),n._rotation=hs.setIdentity(hs.createMatrix()),n._scale=hs.createVector3([1,1,1]),n._primitive_producer=new op(Je(n)),n._setupAnimationBindingBlock(),n._anchor_mode=!1,r&&r.json){var i=r.json,a=r.refs||{};n._setupTransform(i),n._setupModelObject(i,a)}return n}return Ye(t,e),qe(t,[{key:"setAnchorMode",value:function(e){this._anchor_mode=e}},{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"onChangeAltitudeMode",value:function(e){this._primitive_producer.onChangeAltitudeMode()}},{key:"_setupAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ti.find("number"),n=Ti.find("vector3"),i=Ti.find("matrix"),a=new fs;t.addEntry("position",[n],null,(function(t){a.setFromArray(t),e.setPosition(a)}));var o,s=new ds;t.addEntry("orientation",[i,n],(function(e){return o=$s.findFirstTypeSupported(e,[i,n])}),(function(t){o===i?e._setRotation(t):(s.heading=t[0],s.tilt=t[1],s.roll=t[2],e.setOrientation(s))}));var u,_=hs.createVector3();t.addEntry("scale",[n,r],(function(e){return u=$s.findFirstTypeSupported(e,[n,r])}),(function(t){u===n?e.setScale(t):(_[0]=t,_[1]=t,_[2]=t,e.setScale(_))}))}},{key:"_setupTransform",value:function(e){var t=e.transform;this.setPosition((new fs).setFromArray(t.position)),this.setOrientation(new ds(t.heading,t.tilt,t.roll));var r=void 0!==t.scale?t.scale:[1,1,1];"number"==typeof r&&(r=[r,r,r]),this.setScale(r)}},{key:"_setupModelObject",value:function(e,t){var r=t[e.ref_model];this._primitive_producer.setModelObject(r,e.index)}},{key:"setPosition",value:function(e){var t=this._position;e.longitude==t.longitude&&e.latitude==t.latitude&&e.altitude==t.altitude||(this._position.assign(e),this._primitive_producer.onChangePosition())}},{key:"setOrientation",value:function(e){e.getTransformMatrix(sp,this._rotation)}},{key:"setScale",value:function(e){hs.copyVector3(e,this._scale)}},{key:"_setRotation",value:function(e){hs.copyMatrix(e,this._rotation)}},{key:"_getElevation",value:function(){return this.scene.viewer.getExistingElevation(this._position)}},{key:"anchor_mode",get:function(){return this._anchor_mode}}]),t}(I_),op=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this,e)))._primitives=[],r._pickPrimitives=[],r._ptoe_array=[],r._abs_position=null,r}return Ye(t,e),qe(t,[{key:"setModelObject",value:function(e,t){var r=e.createPrimitives(t,{ridMaterial:!1}),n=e.createPrimitives(t,{ridMaterial:!0});if(!r)throw new Error("model is not found in ModelContainer");this._primitives=r,this._pickPrimitives=n,this._ptoe_array=r.map((function(e){return hs.createMatrix(e.transform)}))}},{key:"createRegions",value:function(){var e=new Lv;return e.addPoint(this.entity._position),[e]}},{key:"onChangeElevation",value:function(e){this._abs_position=null}},{key:"getPrimitives",value:function(e){var t=this.entity;this._updateAbsPosition();for(var r,n,i,a,o,s,u=this._abs_position.getMlocsToGocsMatrix(hs.createMatrix()),_=(r=t._rotation,n=t._scale,i=hs.createMatrix(),a=n[0],o=n[1],s=n[2],i[0]=r[0]*a,i[1]=r[1]*a,i[2]=r[2]*a,i[3]=0,i[4]=r[4]*o,i[5]=r[5]*o,i[6]=r[6]*o,i[7]=0,i[8]=r[8]*s,i[9]=r[9]*s,i[10]=r[10]*s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i),l=hs.mul_AA(u,_,hs.createMatrix()),c=e.getRenderTarget()===fh.SCENE?this._primitives:this._pickPrimitives,h=this._ptoe_array,f=0;f<c.length;++f){var d=c[f],v=h[f];hs.mul_AA(l,v,d.transform)}return c}},{key:"onChangeAltitudeMode",value:function(){this._abs_position=null}},{key:"onChangePosition",value:function(){this.needToCreateRegions(),this._abs_position=null}},{key:"_updateAbsPosition",value:function(){if(null===this._abs_position){var e=this.entity;switch(this._abs_position=e._position.clone(),e.altitude_mode){case R_.RELATIVE:this._abs_position.altitude+=e._getElevation();break;case R_.CLAMP:this._abs_position.altitude=e._getElevation()}}}}]),t}(I_.PrimitiveProducer),sp=hs.createVector3([1,1,1]);(0,Ua.exportTypedArrayStaticMethod)("from",Ya,Ga);var up="/**\n * 多角形の頂点シェーダ\n */\n\nattribute vec4 a_position;   // 位置 (モデル座標系)\nattribute vec3 a_normal;     // 法線 (モデル座標系)\n\nuniform mat4 u_obj_to_clip;  // モデル座標系からクリップ座標系への変換\nuniform mat4 u_obj_to_view;  // モデル座標系から視点座標系への変換\nuniform bool u_lighting;     // 照光の有無\nuniform vec3 u_light_dir;    // ライト逆方向 (視点座標系) と強さ\n\nvarying vec3 v_lit_diffuse;  // 拡散光ライト\n\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n\n    if ( u_lighting ) {\n        // 法線 (視点座標系)\n        vec3 normal = normalize( vec3( u_obj_to_view * vec4( a_normal, 0.0 ) ) );\n\n        // 拡散光の強さ\n        v_lit_diffuse = vec3( dot( normal, u_light_dir ) );\n    }\n    else {\n        // 照光なしのときは 1 に固定\n        v_lit_diffuse = vec3( 1 );\n    }\n}\n",_p="/**\n * 多角形のフラグメントシェーダ\n */\n\nprecision mediump float;\n\nvarying vec3 v_lit_diffuse;  // 拡散光ライト\n\nuniform vec4 u_color;        // 基本色と不透明度\n\n\nvoid\nmain()\n{\n    vec3  color   = u_color.xyz * v_lit_diffuse;\n    float opacity = u_color.w;\n\n    gl_FragColor = vec4( color * opacity, opacity );\n}\n",lp=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Ge(this,t),Ke(this,He(t).call(this,e,up,r.ridMaterial?nl:_p))}return Ye(t,e),qe(t,[{key:"isTranslucent",value:function(e,r){var n=r.properties;return(void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY)<1}},{key:"setParameters",value:function(e,r){$e(He(t.prototype),"setParameters",this).call(this,e,r);var n=r.properties;if(this.setObjToClip(e,r),this.setObjToView(e,r),e.getRenderTarget()===fh.SCENE){var i=void 0!==n.color?n.color:t.DEFAULT_COLOR,a=void 0!==n.opacity?n.opacity:t.DEFAULT_OPACITY,o=t._color;hs.copyVector3(i,o),o[3]=a,this.setVector4("u_color",o),this.setBoolean("u_lighting",n.lighting),this.setVector3("u_light_dir",[0,0,1])}}}]),t}(yv);lp.DEFAULT_COLOR=hs.createVector3f([1,1,1]),lp.DEFAULT_OPACITY=1,lp._color=hs.createVector4f();var cp=function(){function e(t,r,n,i){Ge(this,e),this._points=new Float64Array(2*i),this._polygons=new Set;for(var a=r,o=0,s=0;s<i;++s)this._points[o]=t[a],this._points[o+1]=t[a+1],a+=n,o+=2}return qe(e,[{key:"addBoundary",value:function(e){this._polygons.add(fp.create(this._points,e))}},{key:"run",value:function(){this._makeYMonotonePolygons();var e=new Uint32Array(3*this._numTriangles()),t=0,r=!0,n=!1,i=void 0;try{for(var a,o=this._polygons[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value,u=this._makeTriangleArray(s);e.set(u,t),t+=u.length}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return e}},{key:"_numTriangles",value:function(){var e=0,t=!0,r=!1,n=void 0;try{for(var i,a=this._polygons[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){e+=i.value.numVertices()-2}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return e}},{key:"_makeYMonotonePolygons",value:function(){for(var e=this._getYOrderedVertices(),t=new dp,r=new pp(this._polygons),n=0;n<e.length;++n){var i=e[n];switch(i.getVertexType()){case"start":var a=i.getFrontEdge();t.addEdge(a,i);break;case"end":var o=i.getBackEdge(),s=t.getHelper(o);"merge"==s.getVertexType()&&r.addDiagonal(i,s),t.removeEdge(o);break;case"split":var u=t.findNearestLeftEdge(i);r.addDiagonal(i,t.getHelper(u)),t.setHelper(u,i);var _=i.getFrontEdge();t.addEdge(_,i);break;case"merge":var l=i.getBackEdge(),c=t.getHelper(l);"merge"==c.getVertexType()&&r.addDiagonal(i,c),t.removeEdge(l);var h=t.findNearestLeftEdge(i),f=t.getHelper(h);"merge"==f.getVertexType()&&r.addDiagonal(i,f),t.setHelper(h,i);break;default:if(i.isRightInner()){var d=i.getBackEdge(),v=t.getHelper(d);"merge"==v.getVertexType()&&r.addDiagonal(i,v),t.removeEdge(d);var p=i.getFrontEdge();t.addEdge(p,i)}else{var y=t.findNearestLeftEdge(i),g=t.getHelper(y);"merge"==g.getVertexType()&&r.addDiagonal(i,g),t.setHelper(y,i)}}}r.splitPolygons()}},{key:"_getYOrderedVertices",value:function(){var e=[],t=!0,r=!1,n=void 0;try{for(var i,a=this._polygons[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;Array.prototype.push.apply(e,o.getVertices())}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return e.sort((function(e,t){return hp.comparePositionY(t,e)}))}},{key:"_makeTriangleArray",value:function(e){var t=0,r=new Uint32Array(3*(e.numVertices()-2)),n=new gp,i=0,a=e.getVertices().sort((function(e,t){return hp.comparePositionY(t,e)})),o=a[0].prev===a[1];for(n.push(a[i++]),n.push(a[i++]);i<a.length-1;){var s=a[i];if(o?s===n.top.prev:s===n.top.next){for(var u=n.pop();n.size>0;){var _=n.top,l=et(o?[u,_]:[_,u],2),c=l[0],h=l[1];if(!hp.isCCW(s,c,h))break;r[t++]=s.id,r[t++]=c.id,r[t++]=h.id,u=n.pop()}n.push(u),n.push(s)}else{for(var f=n.pop();n.size>0;){var d=n.pop(),v=et(o?[f,d]:[d,f],2),p=v[0],y=v[1];r[t++]=s.id,r[t++]=p.id,r[t++]=y.id,f=d}n.push(a[i-1]),n.push(s),o=!o}++i}for(var g=a[i],m=n.pop();n.size>0;){var k=n.pop(),E=et(o?[m,k]:[k,m],2),w=E[0],b=E[1];r[t++]=g.id,r[t++]=w.id,r[t++]=b.id,m=k}return r}}]),e}(),hp=function(){function e(t,r,n){Ge(this,e),this.id=t,this.x=r,this.y=n,this.polygon=null,this.next=null,this.prev=null}return qe(e,[{key:"clone",value:function(){return new e(this.id,this.x,this.y)}},{key:"getVertexType",value:function(){var t=this.prev,r=this.next,n=e.comparePositionY(t,this),i=e.comparePositionY(r,this);if(n>0&&i>0||n<0&&i<0){var a=t.y-this.y,o=this.x-t.x,s=a*(r.x-this.x)+o*(r.y-this.y);return n>0&&i>0?s<0?"merge":"end":s<0?"split":"start"}return"regular"}},{key:"getFrontEdge",value:function(){return this}},{key:"getBackEdge",value:function(){return this.prev}},{key:"isRightInner",value:function(){return e.comparePositionY(this.next,this)<0}}],[{key:"comparePositionY",value:function(e,t){return e.y<t.y||e.y==t.y&&e.x>t.x?-1:e.y>t.y||e.y==t.y&&e.x<t.x?1:0}},{key:"isCCW",value:function(e,t,r){var n=t.x-e.x,i=t.y-e.y,a=r.x-e.x;return n*(r.y-e.y)-i*a>0}}]),e}(),fp=function(){function e(){Ge(this,e),this._first=null}return qe(e,[{key:"numVertices",value:function(){var e=0,t=this._first;++e;var r=this._first;for(t=t.next;t!==r;t=t.next)++e;return e}},{key:"getVertices",value:function(){var e=[],t=this._first;e.push(t);var r=this._first;for(t=t.next;t!==r;t=t.next)e.push(t);return e}},{key:"_updateVertices",value:function(){var e=this._first;e.polygon=this;var t=this._first;for(e=e.next;e!==t;e=e.next)e.polygon=this}}],[{key:"create",value:function(t,r){var n=new e,i=r[0],a=2*i,o=new hp(i,t[a],t[a+1]);n._first=o;for(var s=1;s<r.length;++s){var u=o;i=r[s],o=new hp(i,t[a=2*i],t[a+1]),u.next=o,o.prev=u}return n._first.prev=o,o.next=n._first,n._updateVertices(),n}},{key:"createByVertex",value:function(t){var r=new e;return r._first=t,r._updateVertices(),r}}]),e}(),dp=function(){function e(){Ge(this,e),this._edges=new Map}return qe(e,[{key:"addEdge",value:function(e,t){this._edges.set(e,{helper:t})}},{key:"removeEdge",value:function(e){this._edges.delete(e)}},{key:"setHelper",value:function(e,t){this._edges.get(e).helper=t}},{key:"getHelper",value:function(e){return this._edges.get(e).helper}},{key:"findNearestLeftEdge",value:function(e){var t,r=Number.MAX_VALUE,n=e.x,i=e.y,a=!0,o=!1,s=void 0;try{for(var u,_=this._edges[Symbol.iterator]();!(a=(u=_.next()).done);a=!0){var l=et(u.value,1)[0],c=l.x,h=l.y,f=n-(c+(i-h)*((l.next.x-c)/(l.next.y-h)));f>0&&f<r&&(r=f,t=l)}}catch(e){o=!0,s=e}finally{try{a||null==_.return||_.return()}finally{if(o)throw s}}if(void 0===t)throw new Error("Probably a degenerate polygon");return t}}]),e}(),vp=function e(t,r){Ge(this,e),this.v1=t,this.v2=r},pp=function(){function e(t){Ge(this,e),this._polygons=t,this._diagonals=[],this._dmap=new yp}return qe(e,[{key:"addDiagonal",value:function(e,t){var r=new vp(e,t);this._diagonals.push(r),this._dmap.addDiagonal(r)}},{key:"splitPolygons",value:function(){for(this._shuffleArray(this._diagonals);this._diagonals.length>0;){var e=this._diagonals.pop();this._dmap.removeDiagonal(e);var t=e.v1,r=e.v2,n=et(this._splitPolygonHalf(t,r),2),i=n[0],a=n[1],o=et(this._splitPolygonHalf(r,t),2),s=o[0],u=o[1],_=t.polygon,l=r.polygon;_===l?(this._polygons.delete(_),this._polygons.add(fp.createByVertex(i)),this._polygons.add(fp.createByVertex(u))):(this._polygons.delete(_),this._polygons.delete(l),this._polygons.add(fp.createByVertex(i))),this._replaceVertexInDiagonals(t,i,u),this._replaceVertexInDiagonals(r,a,s)}}},{key:"_splitPolygonHalf",value:function(e,t){var r=e.clone(),n=t.clone();return r.prev=e.prev,r.next=n,e.prev.next=r,n.prev=r,n.next=t.next,t.next.prev=n,[r,n]}},{key:"_replaceVertexInDiagonals",value:function(e,t,r){var n=!0,i=!1,a=void 0;try{for(var o,s=this._dmap.removeDiagonals(e)[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value,_=u.v1===e?u.v2:u.v1;u.v1=this._testDiagonal(t,_)?t:r,u.v2=_,this._dmap.addDiagonal(u)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}}},{key:"_testDiagonal",value:function(e,t){var r=e.next.x-e.x,n=e.next.y-e.y,i=e.prev.x-e.x,a=e.prev.y-e.y,o=t.x-e.x,s=t.y-e.y,u=r*s-o*n>0,_=i*s-o*a<0;return r*a-i*n>=0?u&&_:u||_}},{key:"_shuffleArray",value:function(e){for(var t=e.length-1;t>0;--t){var r=Math.floor(Math.random()*(t+1)),n=e[t];e[t]=e[r],e[r]=n}}}]),e}(),yp=function(){function e(){Ge(this,e),this._map=new Map}return qe(e,[{key:"addDiagonal",value:function(e){this._addDiagonalByVertex(e.v1,e),this._addDiagonalByVertex(e.v2,e)}},{key:"removeDiagonal",value:function(e){this._removeDiagonalByVertex(e.v1,e),this._removeDiagonalByVertex(e.v2,e)}},{key:"removeDiagonals",value:function(e){var t=this._map.get(e);if(void 0!==t){var r=t.slice(),n=!0,i=!1,a=void 0;try{for(var o,s=r[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;this.removeDiagonal(u)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}return r}return[]}},{key:"_addDiagonalByVertex",value:function(e,t){var r=this._map.get(e);if(void 0===r)this._map.set(e,[t]);else{if(-1!=r.indexOf(t))throw new Error("Unexpected");if(r.length<1||r.length>2)throw new Error("Unexpected");r.push(t)}}},{key:"_removeDiagonalByVertex",value:function(e,t){var r=this._map.get(e);if(void 0===r)throw new Error("Unexpected");var n=r.indexOf(t);if(-1==n)throw new Error("Unexpected");r.splice(n,1),0==r.length&&this._map.delete(e)}}]),e}(),gp=function(){function e(){Ge(this,e),this._array=new Array}return qe(e,[{key:"push",value:function(e){this._array.push(e)}},{key:"pop",value:function(){return this._array.pop()}},{key:"size",get:function(){return this._array.length}},{key:"top",get:function(){var e=this._array;return e.length>0?e[e.length-1]:null}}]),e}(),mp=n.isFinite,kp=Number.isFinite||function(e){return"number"==typeof e&&mp(e)};Le({target:"Number",stat:!0},{isFinite:kp});var Ep=function(){function e(t){Ge(this,e),this._vertices=Float64Array.from(t),this._num_vertices=this._vertices.length/2}return qe(e,[{key:"isValid",value:function(){if(this._num_vertices<3)return!1;for(var e=0;e<this._num_vertices;++e){var t=this._vertices[2*e],r=this._vertices[2*e+1];if(!Number.isFinite(t)||!Number.isFinite(r))return!1}for(var n=0;n<this._num_vertices;++n){var i=0!=n?n-1:this._num_vertices-1,a=this._vertices[2*i],o=this._vertices[2*i+1],s=this._vertices[2*n],u=this._vertices[2*n+1];if(a==s&&o==u)return!1}for(var _=0;_<this._num_vertices;++_){var l=this._vertices[2*_],c=this._vertices[2*_+1],h=_==this._num_vertices-1?0:_+1,f=this._vertices[2*h]-l,d=this._vertices[2*h+1]-c,v=0==_?this._num_vertices-1:_-1,p=this._vertices[2*v]-l,y=this._vertices[2*v+1]-c,g=f*y-p*d;if(g<0||0==g&&f*p+d*y>0)return!1}return!0}},{key:"getIntersection",value:function(e){try{return this._clip_by_polygon(e)}catch(e){throw new Error("ConvexPolygon#getIntersection failed")}}},{key:"hasIntersection",value:function(e){try{return null!==this._clip_by_polygon(e)}catch(e){throw new Error("ConvexPolygon#hasIntersection failed")}}},{key:"includes",value:function(e){for(var t=0;t<this._num_vertices;++t)for(var r=0!=t?t-1:this._num_vertices-1,n=this._vertices[2*r],i=this._vertices[2*r+1],a=i-this._vertices[2*t+1],o=this._vertices[2*t]-n,s=n*a+i*o,u=0;u<e._num_vertices;++u){if(e._vertices[2*u]*a+e._vertices[2*u+1]*o<s)return!1}return!0}},{key:"_clip_by_polygon",value:function(e){for(var t=e,r=0;r<this._num_vertices;++r){var n=0!=r?r-1:this._num_vertices-1,i=this._vertices[2*n],a=this._vertices[2*n+1],o=a-this._vertices[2*r+1],s=this._vertices[2*r]-i,u=i*o+a*s;if(null===(t=t._clip_by_halfspace(o,s,u)))break}return t}},{key:"_clip_by_halfspace",value:function(e,t,r){for(var n=Number.MAX_VALUE,i=-Number.MAX_VALUE,a=0;a<this._num_vertices;++a){var o=this._vertices[2*a]*e+this._vertices[2*a+1]*t-r;n=Math.min(n,o),i=Math.max(i,o)}return n>=0?this:i<=0?null:this._clip_by_crossed_halfspace(e,t,r)}},{key:"_clip_by_crossed_halfspace",value:function(t,r,n){var i=et(this._get_cross_edges_by_crossed_halfspace_boundary(t,r,n),2),a=i[0],o=i[1],s=[];s.push(a.qx),s.push(a.qy);for(var u=a.ei,_=o.ei,l=u;l!=_;l=(l+1)%this._num_vertices)s.push(this._vertices[2*l]),s.push(this._vertices[2*l+1]);return s.push(o.qx),s.push(o.qy),new e(s)}},{key:"_get_cross_edges_by_crossed_halfspace_boundary",value:function(e,t,r){for(var n=new Array(2),i=0,a=0;a<2;++i){if(i==this._num_vertices)throw new Error("cross edges could not be found");var o=(i+1)%this._num_vertices,s=this._vertices[2*i],u=this._vertices[2*i+1],_=this._vertices[2*o],l=this._vertices[2*o+1],c=s*e+u*t-r,h=_*e+l*t-r;if(c<=0&&0<h||h<=0&&0<c){var f=c/(c-h),d=s+(_-s)*f,v=u+(l-u)*f;n[c<h?0:1]={ei:o,qx:d,qy:v},++a}}return n}},{key:"num_vertices",get:function(){return this._num_vertices}},{key:"vertices",get:function(){return this._vertices}}],[{key:"createByRectangle",value:function(t,r,n,i){return new e([t,r,n,r,n,i,t,i])}}]),e}(),wp=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this,e,r)))._extruded_height=0,n._color=hs.createVector3([1,1,1]),n._opacity=1,n._boundaries=[],n._position=null,n.altitude_mode===R_.CLAMP?(n._producer=new xp(Je(n)),n._is_flake_mode=!0):(n._producer=new bp(Je(n)),n._is_flake_mode=!1),n._setupAnimationBindingBlock(),r&&r.json&&n._setupByJson(r.json),n}return Ye(t,e),qe(t,[{key:"getPrimitiveProducer",value:function(){return this._is_flake_mode?null:this._producer}},{key:"getFlakePrimitiveProducer",value:function(){return this._is_flake_mode?this._producer:null}},{key:"onChangeAltitudeMode",value:function(e){this.altitude_mode===R_.CLAMP?(this._producer=new xp(this),this._is_flake_mode=!0):(this._producer=new bp(this),this._is_flake_mode=!1)}},{key:"_setupAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ti.find("number"),n=Ti.find("vector3");t.addEntry("color",[n],null,(function(t){e.setColor(t)})),t.addEntry("opacity",[r],null,(function(t){e.setOpacity(t)})),t.addEntry("height",[r],null,(function(t){e.setExtrudedHeight(t)}))}},{key:"setColor",value:function(e){this._color[0]===e[0]&&this._color[1]===e[1]&&this._color[2]===e[2]||(hs.copyVector3(e,this._color),this._producer.onChangeProperty())}},{key:"setOpacity",value:function(e){this._opacity!==e&&(this._opacity=e,this._producer.onChangeProperty())}},{key:"setExtrudedHeight",value:function(e){this.extruded_height=e}},{key:"addOuterBoundary",value:function(e){this._addBoundary(e,!1)}},{key:"addInnerBoundary",value:function(e){this._addBoundary(e,!0)}},{key:"_addBoundary",value:function(e,t){this._boundaries.push(new Tp(e,t)),this._position=null,this._producer.onChangeBoundary()}},{key:"_getMaterial",value:function(e){var t=this.scene;return e===fh.SCENE?(t._PolygonEntity_material||(t._PolygonEntity_material=new lp(t.glenv)),t._PolygonEntity_material):e===fh.RID?(t._PolygonEntity_material_pick||(t._PolygonEntity_material_pick=new lp(t.glenv,{ridMaterial:!0})),t._PolygonEntity_material_pick):void 0}},{key:"_setupByJson",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=e.boundaries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;"inner"==o.type?this.addInnerBoundary(o.points):this.addOuterBoundary(o.points)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}void 0!==e.extruded_height&&(this.extruded_height=e.extruded_height),void 0!==e.color&&hs.copyVector3(e.color,this._color),void 0!==e.opacity&&(this._opacity=e.opacity)}},{key:"_getPosition",value:function(){if(null!==this._position)return this._position;if(0==this._boundaries.length)return null;var e=Number.MAX_VALUE,t=-Number.MAX_VALUE,r=Number.MAX_VALUE,n=-Number.MAX_VALUE,i=!0,a=!1,o=void 0;try{for(var s,u=this._boundaries[Symbol.iterator]();!(i=(s=u.next()).done);i=!0)for(var _=s.value,l=_.num_points,c=_.points,h=0;h<l;++h){var f=c[3*h],d=c[3*h+1];f<e&&(e=f),f>t&&(t=f),d<r&&(r=d),d>n&&(n=d)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}return this._position=new fs((e+t)/2,(r+n)/2),this._position}},{key:"_countNumPointsOnBoundaries",value:function(){var e=0,t=!0,r=!1,n=void 0;try{for(var i,a=this._boundaries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){e+=i.value.num_points}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return e}},{key:"_getCombinedBoundaryPoints",value:function(){var e=new Float64Array(3*this._countNumPointsOnBoundaries()),t=0,r=!0,n=!1,i=void 0;try{for(var a,o=this._boundaries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;e.set(s.points,t),t+=3*s.num_points}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return e}},{key:"_getCombinedBoundary2DPoints",value:function(){var e=new Float64Array(2*this._countNumPointsOnBoundaries()),t=0,r=!0,n=!1,i=void 0;try{for(var a,o=this._boundaries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0)for(var s=a.value,u=3*s.num_points,_=s.points,l=0;l<u;l+=3)e[t++]=_[l],e[t++]=_[l+1]}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return e}},{key:"_createTriangles",value:function(){var e=this._getCombinedBoundary2DPoints(),t=this._countNumPointsOnBoundaries(),r=new cp(e,0,2,t),n=0,i=!0,a=!1,o=void 0;try{for(var s,u=this._boundaries[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){for(var _=s.value.num_points,l=new Uint32Array(_),c=0;c<_;++c)l[c]=n++;r.addBoundary(l)}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}try{return r.run()}catch(e){return console.error(e.message),null}}},{key:"extruded_height",set:function(e){this._extruded_height!==e&&(this._extruded_height=e,this._producer.onChangeExtruded())},get:function(){return this._extruded_height}}]),t}(I_),bp=function(e){function t(e){var r;Ge(this,t),(r=Ke(this,He(t).call(this,e)))._status=Np.INVALID,r._triangles=null,r._transform=hs.setIdentity(hs.createMatrix()),r._pivot=hs.createVector3(),r._bbox=[hs.createVector3(),hs.createVector3()],r._properties={color:hs.createVector3f(),opacity:1,lighting:!1};var n=new c_(e.glenv,null,e._getMaterial(fh.SCENE),r._transform);n.pivot=r._pivot,n.bbox=r._bbox,n.properties=r._properties,r._primitive=n;var i=new c_(e.glenv,null,e._getMaterial(fh.RID),r._transform);return i.pivot=r._pivot,i.bbox=r._bbox,i.properties=r._properties,r._pickPrimitive=i,r}return Ye(t,e),qe(t,[{key:"needsElevation",value:function(){return this.entity.altitude_mode!==R_.ABSOLUTE}},{key:"createRegions",value:function(){var e=this.entity;if(this._status===Np.INVALID)return[];var t=new Lv,r=!0,n=!1,i=void 0;try{for(var a,o=e._boundaries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;t.addPoints(s.points,0,3,s.num_points)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return t.addPoint(e._getPosition()),[t]}},{key:"onChangeElevation",value:function(e){this._status===Np.NORMAL&&(this._status=Np.MESH_DIRTY)}},{key:"getPrimitives",value:function(e){if(this._status===Np.INVALID)return[];if(this._status===Np.TRIANGLE_DIRTY){if(this._triangles=this.entity._createTriangles(),null===this._triangles)return this._primitive.mesh=null,this._pickPrimitive.mesh=null,this._status=Np.INVALID,[];this._updatePrimitiveMesh()}else this._status===Np.MESH_DIRTY&&this._updatePrimitiveMesh();return this._updatePrimitiveProperties(),this._status=Np.NORMAL,e.getRenderTarget()===fh.SCENE?[this._primitive]:[this._pickPrimitive]}},{key:"onChangeExtruded",value:function(){this._status===Np.NORMAL&&(this._status=Np.MESH_DIRTY)}},{key:"onChangeProperty",value:function(){}},{key:"onChangeBoundary",value:function(){this._status=Np.TRIANGLE_DIRTY,this._triangles=null,this.needToCreateRegions()}},{key:"_updatePrimitiveMesh",value:function(){var e=new Ap(this.entity);this._updateTransformPivotBBox(e);var t={vtype:[{name:"a_position",size:3},{name:"a_normal",size:3}],vertices:this._createVertices(e),indices:this._createIndices(e)},r=new k_(this.entity.scene.glenv,t);this._primitive.mesh=r,this._pickPrimitive.mesh=r}},{key:"_updateTransformPivotBBox",value:function(e){var t=this._transform;t[12]=e.origin[0],t[13]=e.origin[1],t[14]=e.origin[2];var r=Number.MAX_VALUE,n=Number.MAX_VALUE,i=Number.MAX_VALUE,a=-Number.MAX_VALUE,o=-Number.MAX_VALUE,s=-Number.MAX_VALUE,u=[e.upper];e.lower&&u.push(e.lower);for(var _=0;_<u.length;++_)for(var l=u[_],c=0;c<e.num_points;++c){var h=3*c,f=l[h],d=l[h+1],v=l[h+2];f<r&&(r=f),d<n&&(n=d),v<i&&(i=v),f>a&&(a=f),d>o&&(o=d),v>s&&(s=v)}var p=this._pivot;p[0]=(r+a)/2,p[1]=(n+o)/2,p[2]=(i+s)/2;var y=this._bbox,g=y[0],m=y[1];g[0]=r,g[1]=n,g[2]=i,m[0]=a,m[1]=o,m[2]=s}},{key:"_createVertices",value:function(e){for(var t=6*e.num_points,r=e.lower?4*e.num_points*6:0,n=e.lower?t:0,i=new Float32Array(t+r+n),a=hs.normalize3(e.origin,hs.createVector3()),o=0;o<e.num_points;++o){var s=3*o,u=e.upper[s],_=e.upper[s+1],l=e.upper[s+2],c=6*o;i[c]=u,i[c+1]=_,i[c+2]=l,Lp(a,i,c+3)}if(e.lower){var h=hs.createVector3(),f=hs.createVector3(),d=hs.createVector3(),v=hs.createVector3(),p=hs.createVector3(),y=0,g=!0,m=!1,k=void 0;try{for(var E,w=this.entity._boundaries[Symbol.iterator]();!(g=(E=w.next()).done);g=!0){for(var b=y+E.value.num_points,x=y;x<b;++x){var T=3*x,A=3*(x+1<b?x+1:y);Mp(e.lower,T,h),Mp(e.lower,A,f),Mp(e.upper,T,d),Mp(e.upper,A,v),Dp(h,f,d,p);var R=t+24*x;Lp(h,i,R),Lp(p,i,R+3),Lp(f,i,R+=6),Lp(p,i,R+3),Lp(d,i,R+=6),Lp(p,i,R+3),Lp(v,i,R+=6),Lp(p,i,R+3)}y=b}}catch(e){m=!0,k=e}finally{try{g||null==w.return||w.return()}finally{if(m)throw k}}}if(e.lower)for(var I=hs.scale3(-1,a,hs.createVector3()),P=0;P<e.num_points;++P){var S=3*P,M=e.lower[S],L=e.lower[S+1],D=e.lower[S+2],C=t+r+6*P;i[C]=M,i[C+1]=L,i[C+2]=D,Lp(I,i,C+3)}return i}},{key:"_createIndices",value:function(e){var t=this._triangles.length/3,r=e.lower?2*e.num_points:0,n=e.lower?t:0,i=new Uint32Array(3*(t+r+n));if(i.set(this._triangles),e.lower)for(var a=e.num_points,o=3*t,s=e.num_points,u=0;u<a;++u,o+=6,s+=4)i[o]=s,i[o+1]=s+1,i[o+2]=s+2,i[o+3]=s+2,i[o+4]=s+1,i[o+5]=s+3;if(e.lower)for(var _=this._triangles.length/3,l=e.num_points+4*e.num_points,c=0;c<_;++c)i[3*(t+r+c)+0]=this._triangles[3*c+0]+l,i[3*(t+r+c)+1]=this._triangles[3*c+2]+l,i[3*(t+r+c)+2]=this._triangles[3*c+1]+l;return i}},{key:"_updatePrimitiveProperties",value:function(){var e=this.entity,t=this._properties;hs.copyVector3(e._color,t.color),t.opacity=e._opacity,t.lighting=0!==this.extruded_height}}]),t}(I_.PrimitiveProducer),xp=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this,e)))._material_map=Object.keys(fh).reduce((function(t,r){var n=fh[r];return t.set(n,e._getMaterial(n)),t}),new Map),r._properties=null,r._area_manager=new Rp(e),r}return Ye(t,e),qe(t,[{key:"getAreaStatus",value:function(e){return this._area_manager.getAreaStatus(e)}},{key:"createMesh",value:function(e,t,r){var n=this._area_manager.getAreaContent(e),i=Math.PI*Math.pow(2,1-e.z),a=e.x*i-Math.PI,o=Math.PI-(e.y+1)*i,s=1<<t[0],u=1<<t[1],_=this._createSubmeshes(a,o,a+i,o+i,s,u,n),l={vtype:[{name:"a_position",size:3},{name:"a_normal",size:3}],vertices:this._createVertices(_,e,r),indices:this._createIndices(_)};return new k_(this.entity.scene.glenv,l)}},{key:"getMaterialAndProperties",value:function(e){if(null===this._properties){var t=this.entity;this._properties={color:hs.createVector3f(t._color),opacity:t._opacity,lighting:!1}}return{material:this._material_map.get(e.getRenderTarget()),properties:this._properties}}},{key:"onChangeExtruded",value:function(){}},{key:"onChangeProperty",value:function(){this._properties=null}},{key:"onChangeBoundary",value:function(){this._area_manager.notifyForUpdateContent(),this.notifyForUpdate()}},{key:"_createVertices",value:function(e,t,r){var n=__.getCenter(t,hs.createVector3()),i=r.newSampler(t),a=0,o=!0,s=!1,u=void 0;try{for(var _,l=e[Symbol.iterator]();!(o=(_=l.next()).done);o=!0){a+=_.value.getNumVertices()}}catch(e){s=!0,u=e}finally{try{o||null==l.return||l.return()}finally{if(s)throw u}}var c=new Float32Array(6*a),h=0,f=!0,d=!1,v=void 0;try{for(var p,y=e[Symbol.iterator]();!(f=(p=y.next()).done);f=!0){h=p.value.addVertices(n,i,c,h)}}catch(e){d=!0,v=e}finally{try{f||null==y.return||y.return()}finally{if(d)throw v}}return c}},{key:"_createIndices",value:function(e){var t=0,r=!0,n=!1,i=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){t+=a.value.getNumTriangles()}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}var s=new Uint32Array(3*t),u=0,_=0,l=!0,c=!1,h=void 0;try{for(var f,d=e[Symbol.iterator]();!(l=(f=d.next()).done);l=!0){var v=f.value;_=v.addIndices(u,s,_),u+=v.getNumVertices()}}catch(e){c=!0,h=e}finally{try{l||null==d.return||d.return()}finally{if(c)throw h}}return s}},{key:"_createSubmeshes",value:function(e,t,r,n,i,a,o){if(o===I_.AreaStatus.FULL)return[new Pp(e,t,r,n,i,a)];if(0==o.length)return[];if(1==i&&1==a){var s=[e,t,r,t,e,n],u=[e,n,r,t,r,n],_=this._create_clipped_polygons_submeshes(s,o),l=this._create_clipped_polygons_submeshes(u,o);return _.concat(l)}if(i>=a){var c=(r-e)/2,h=i/2,f=this._create_submeshes_sp(e,t,e+c,n,h,a,o),d=this._create_submeshes_sp(e+c,t,r,n,h,a,o);return f.concat(d)}var v=(n-t)/2,p=a/2,y=this._create_submeshes_sp(e,t,r,t+v,i,p,o),g=this._create_submeshes_sp(e,t+v,r,n,i,p,o);return y.concat(g)}},{key:"_create_submeshes_sp",value:function(e,t,r,n,i,a,o){var s=Ep.createByRectangle(e,t,r,n),u=[],_=!0,l=!1,c=void 0;try{for(var h,f=o[Symbol.iterator]();!(_=(h=f.next()).done);_=!0){var d=h.value;if(d.includes(s)){u=I_.AreaStatus.FULL;break}try{s.hasIntersection(d)&&u.push(d)}catch(e){}}}catch(e){l=!0,c=e}finally{try{_||null==f.return||f.return()}finally{if(l)throw c}}return this._createSubmeshes(e,t,r,n,i,a,u)}},{key:"_create_clipped_polygons_submeshes",value:function(e,t){var r=new Ep(e),n=[],i=!0,a=!1,o=void 0;try{for(var s,u=t[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value;try{var l=r.getIntersection(_);null!==l&&n.push(l)}catch(e){}}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}return n.length>0?[new Sp(e,n)]:[]}}]),t}(I_.FlakePrimitiveProducer),Tp=function(){function e(t,r){Ge(this,e);var n=Math.floor(t.length/3);this._points=new Float64Array(3*n),this._num_points=n;var i,a,o=e.isCCW(t,n);!r&&o||r&&!o?(i=0,a=3):(i=3*(n-1),a=-3);for(var s=0;s<n;++s)this._points[3*s]=t[i],this._points[3*s+1]=t[i+1],this._points[3*s+2]=t[i+2],i+=a}return qe(e,[{key:"points",get:function(){return this._points}},{key:"num_points",get:function(){return this._num_points}}],[{key:"isCCW",value:function(e,t){for(var r,n=-Number.MAX_VALUE,i=-Number.MAX_VALUE,a=0;a<t;++a){var o=e[3*a],s=e[3*a+1];(s>i||s==i&&o<n)&&(r=a,n=o,i=s)}var u=r==t-1?0:r+1,_=e[3*u],l=e[3*u+1],c=0==r?t-1:r-1,h=e[3*c];return(_-n)*(e[3*c+1]-i)-(h-n)*(l-i)>0}}]),e}(),Ap=function e(t){Ge(this,e);var r=t.scene.viewer,n=t.altitude_mode,i=t._getCombinedBoundaryPoints(),a=t._countNumPointsOnBoundaries(),o=Float64Array.from(i);if(n===R_.RELATIVE)for(var s=r.getExistingElevation(t._getPosition()),u=0;u<a;++u){o[3*u+2]+=s}var _=null,l=null;if(0!==t._extruded_height)if(n===R_.CLAMP){_=o,l=Float64Array.from(i);for(var c=0;c<a;++c){l[3*c+2]=0}}else{l=o,_=Float64Array.from(i);for(var h=0;h<a;++h){var f=3*h+2;_[f]=l[f]+t._extruded_height}}else _=o;for(var d=t._getPosition().getAsGocs(hs.createVector3()),v=fs.toGocsArray(_,a,new Float64Array(3*a)),p=0;p<a;++p){var y=3*p;v[y]-=d[0],v[y+1]-=d[1],v[y+2]-=d[2]}var g=null;if(l){g=fs.toGocsArray(l,a,new Float64Array(3*a));for(var m=0;m<a;++m){var k=3*m;g[k]-=d[0],g[k+1]-=d[1],g[k+2]-=d[2]}}this.origin=d,this.num_points=a,this.upper=v,this.lower=g},Rp=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this)))._entity=e,r}return Ye(t,e),qe(t,[{key:"getInitialContent",value:function(){for(var e=this._entity._createTriangles()||[],t=e.length,r=this._entity._getCombinedBoundary2DPoints(),n=[],i=0;i<t;i+=3){var a=e[i],o=e[i+1],s=e[i+2];this._add_polygon_to_array(r,a,o,s,n)}return n}},{key:"createAreaContent",value:function(e,t,r,n){var i=Math.PI*e,a=Math.PI*t,o=Math.PI*(e+r),s=Math.PI*(t+r),u=Ep.createByRectangle(i,a,o,s),_=[],l=!0,c=!1,h=void 0;try{for(var f,d=n[Symbol.iterator]();!(l=(f=d.next()).done);l=!0){var v=f.value;if(v.includes(u))return I_.AreaStatus.FULL;try{u.hasIntersection(v)&&_.push(v)}catch(e){}}}catch(e){c=!0,h=e}finally{try{l||null==d.return||d.return()}finally{if(c)throw h}}return _.length>0?_:I_.AreaStatus.EMPTY}},{key:"_add_polygon_to_array",value:function(e,t,r,n,i){for(var a=hs.DEGREE,o=Math.PI/2,s=2*Math.PI,u=[],_=Number.MAX_VALUE,l=0,c=[t,r,n];l<c.length;l++){var h=c[l],f=e[2*h]*a,d=e[2*h+1]*a;if(Math.abs(d)>=o)return;var v=f,p=hs.invGudermannian(d);u.push(v),u.push(p),_=Math.min(v,_)}var y=_-s*(Math.floor((_-Math.PI)/s)+1);(y<-Math.PI||y>=Math.PI)&&(y=-Math.PI);for(var g=-Number.MAX_VALUE,m=0;m<3;++m){var k=2*m,E=y+(u[k]-_);u[k]=E,g=Math.max(E,g)}if(i.push(new Ep(u)),g>Math.PI){for(var w=0;w<3;++w){var b=2*w,x=u[b]-s;u[b]=x}i.push(new Ep(u))}}}]),t}(Nv),Ip=function(){function e(){Ge(this,e)}return qe(e,[{key:"getNumVertices",value:function(){throw""}},{key:"getNumTriangles",value:function(){throw""}},{key:"addVertices",value:function(e,t,r,n){throw""}},{key:"addIndices",value:function(e,t,r){throw""}}]),e}(),Pp=function(e){function t(e,r,n,i,a,o){var s;return Ge(this,t),(s=Ke(this,He(t).call(this)))._x_min=e,s._y_min=r,s._x_max=n,s._y_max=i,s._div_x=a,s._div_y=o,s}return Ye(t,e),qe(t,[{key:"getNumVertices",value:function(){return(this._div_x+1)*(this._div_y+1)}},{key:"getNumTriangles",value:function(){return 2*this._div_x*this._div_y}},{key:"addVertices",value:function(e,t,r,n){for(var i=(this._x_max-this._x_min)/this._div_x,a=(this._y_max-this._y_min)/this._div_y,o=this._div_x+1,s=this._div_y+1,u=n,_=0,l=this._y_min;_<s;++_,l+=a)for(var c=Math.exp(l),h=c*c,f=(h-1)/(h+1),d=2*c/(h+1),v=0,p=this._x_min;v<o;++v,p+=i){var y=Math.sin(p),g=Math.cos(p),m=t.sample(p,l),k=hs.EARTH_RADIUS+m,E=d*g,w=d*y,b=f,x=k*E,T=k*w,A=k*b;r[u++]=x-e[0],r[u++]=T-e[1],r[u++]=A-e[2],r[u++]=E,r[u++]=w,r[u++]=b}return u}},{key:"addIndices",value:function(e,t,r){for(var n=this._div_x,i=this._div_y,a=r,o=0;o<i;++o)for(var s=0;s<n;++s){var u=e+(n+1)*o+s,_=u+1,l=u+n+1,c=l+1;t[a++]=u,t[a++]=_,t[a++]=l,t[a++]=l,t[a++]=_,t[a++]=c}return a}}]),t}(Ip),Sp=function(e){function t(e,r){var n;Ge(this,t),(n=Ke(this,He(t).call(this)))._arit_coords=e,n._polygons=r,n._num_vertices=0,n._num_triangles=0;var i=!0,a=!1,o=void 0;try{for(var s,u=r[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value;n._num_vertices+=_.num_vertices,n._num_triangles+=_.num_vertices-2}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}return n}return Ye(t,e),qe(t,[{key:"getNumVertices",value:function(){return this._num_vertices}},{key:"getNumTriangles",value:function(){return this._num_triangles}},{key:"addVertices",value:function(e,t,r,n){var i=this._get_elevation_plane(t),a=n,o=!0,s=!1,u=void 0;try{for(var _,l=this._polygons[Symbol.iterator]();!(o=(_=l.next()).done);o=!0){var c=_.value;a=this._add_polygon_vertices(c,i,e,r,a)}}catch(e){s=!0,u=e}finally{try{o||null==l.return||l.return()}finally{if(s)throw u}}return a}},{key:"addIndices",value:function(e,t,r){var n=r,i=e,a=!0,o=!1,s=void 0;try{for(var u,_=this._polygons[Symbol.iterator]();!(a=(u=_.next()).done);a=!0){var l=u.value;n=this._add_polygon_indices(l,i,t,n),i+=l.num_vertices}}catch(e){o=!0,s=e}finally{try{a||null==_.return||_.return()}finally{if(o)throw s}}return n}},{key:"_add_polygon_vertices",value:function(e,t,r,n,i){for(var a=i,o=e.num_vertices,s=e.vertices,u=0;u<o;++u){var _=s[2*u],l=s[2*u+1],c=Math.exp(l),h=c*c,f=Math.sin(_),d=Math.cos(_),v=(h-1)/(h+1),p=2*c/(h+1),y=-(_*t[0]+l*t[1]+t[3])/t[2],g=hs.EARTH_RADIUS+y,m=p*d,k=p*f,E=v,w=g*m,b=g*k,x=g*E;n[a++]=w-r[0],n[a++]=b-r[1],n[a++]=x-r[2],n[a++]=m,n[a++]=k,n[a++]=E}return a}},{key:"_add_polygon_indices",value:function(e,t,r,n){for(var i=n,a=e.num_vertices-2,o=1;o<=a;++o)r[i++]=t,r[i++]=t+o,r[i++]=t+o+1;return i}},{key:"_get_elevation_plane",value:function(e){for(var t=this._arit_coords,r=new Array(3),n=0;n<3;++n){var i=t[2*n],a=t[2*n+1];r[n]=e.sample(i,a)}var o=t[0],s=t[1],u=r[0],_=t[2]-o,l=t[3]-s,c=r[1]-u,h=t[4]-o,f=t[5]-s,d=r[2]-u,v=l*d-c*f,p=c*h-_*d,y=_*f-l*h;return[v,p,y,-o*v-s*p-u*y]}}]),t}(Ip);function Mp(e,t,r){r[0]=e[t],r[1]=e[t+1],r[2]=e[t+2]}function Lp(e,t,r){t[r]=e[0],t[r+1]=e[1],t[r+2]=e[2]}function Dp(e,t,r,n){for(var i=0;i<3;++i)Cp[i]=t[i]-e[i],Fp[i]=r[i]-e[i];return hs.cross3(Cp,Fp,n),hs.normalize3(n,n),n}var Cp=hs.createVector3(),Fp=hs.createVector3(),Np={INVALID:{id:"INVALID"},NORMAL:{id:"NORMAL"},TRIANGLE_DIRTY:{id:"TRIANGLE_DIRTY"},MESH_DIRTY:{id:"MESH_DIRTY"}};Ha("Int8",(function(e){return function(t,r,n){return e(this,t,r,n)}}));var Op=function(){function e(t,r){Ge(this,e);var n=t.gjson.bufferViews[r];this._buffer=t.findBuffer(n.buffer),this._byteLength=n.byteLength,this._target=n.target,this._byteOffset=void 0!==n.byteOffset?n.byteOffset:0,this._byteStride=void 0!==n.byteStride?n.byteStride:0}return qe(e,[{key:"rebuildBySplitter",value:function(e){this._buffer=e,this._byteLength=e.byteLength,this._byteOffset=0}},{key:"buffer",get:function(){return this._buffer}},{key:"byteOffset",get:function(){return this._byteOffset}},{key:"byteStride",get:function(){return this._byteStride}}]),e}(),Up=function(){function e(t,r){Ge(this,e);var n=t.gjson.accessors[r];this._type=n.type,this._componentType=n.componentType,this._count=n.count,this._bufferView=new Op(t,n.bufferView),this._byteOffset=void 0!==n.byteOffset?n.byteOffset:0,this._normalized=n.normalized||!1,this._min=n.min?n.min.slice():null,this._max=n.max?n.max.slice():null,this._index=r}return qe(e,[{key:"getRangeInBuffer",value:function(){var t=this._bufferView,r=e._ComponentData[this._componentType].bytes*e._NumComponents[this._type],n=0==t.byteStride?r:t.byteStride,i=this._byteOffset+t.byteOffset;return{first:i,last:i+n*(this._count-1)+r}}},{key:"modifyByteOrder",value:function(t){var r=e._ComponentData[this._componentType],n=r.bytes;if(1!=n)for(var i=e._NumComponents[this._type],a=this._byteOffset+this._bufferView.byteOffset,o=0==this._bufferView.byteStride?i:this._bufferView.byteStride/n,s=this._bufferView.buffer.binary,u=new DataView(s,a),_=new r.typedarray(s,a),l=r.getcompo,c=n/2,h=a/2,f=o*c,d=0;d<this._count;++d)for(var v=h+d*f,p=d*o,y=0;y<i;++y){var g=v+y*c;if(!t.getBit(g)){var m=p+y,k=l.call(u,m*n,!0);_[m]=k,t.setBit(g,!0)}}}},{key:"isIncluded",value:function(e,t){var r=this._byteOffset+this._bufferView.byteOffset;return e<=r&&r<t}},{key:"rebuildBySplitter",value:function(e,t){this._index=-1;var r=this._byteOffset+this._bufferView.byteOffset;this._byteOffset=r-t,this._bufferView.rebuildBySplitter(e)}},{key:"index",get:function(){return this._index}},{key:"bufferView",get:function(){return this._bufferView}},{key:"type",get:function(){return this._type}},{key:"componentType",get:function(){return this._componentType}},{key:"count",get:function(){return this._count}},{key:"byteOffset",get:function(){return this._byteOffset}},{key:"normalized",get:function(){return this._normalized}},{key:"min",get:function(){return this._min}},{key:"max",get:function(){return this._max}}]),e}();Up._NumComponents={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Up._ComponentData={5120:{bytes:1,getcompo:DataView.prototype.getInt8,typedarray:Int8Array},5121:{bytes:1,getcompo:DataView.prototype.getUint8,typedarray:Uint8Array},5122:{bytes:2,getcompo:DataView.prototype.getInt16,typedarray:Int16Array},5123:{bytes:2,getcompo:DataView.prototype.getUint16,typedarray:Uint16Array},5125:{bytes:4,getcompo:DataView.prototype.getUint32,typedarray:Uint32Array},5126:{bytes:4,getcompo:DataView.prototype.getFloat32,typedarray:Float32Array}};var Vp=function(){function e(t,r){Ge(this,e);var n=t.gjson.materials[r];this._commonData=new dv(n,t),this._pbrMetallicRoughness={baseColorFactor:[1,1,1,1],baseColorTexture:null,metallicFactor:1,roughnessFactor:1,metallicRoughnessTexture:null},this._doubleSided=!1,this._alphaMode="OPAQUE",this._alphaCutoff=.5,this._emissiveFactor=[0,0,0],this._emissiveTexture=null,this._normalTexture=null,this._occlusionTexture=null,this._setupPbrMetallicRoughness(n,t),this._setupGenericParameters(n,t)}return qe(e,[{key:"_setupPbrMetallicRoughness",value:function(e,t){if(void 0!==e.pbrMetallicRoughness){var r=e.pbrMetallicRoughness,n=this._pbrMetallicRoughness;void 0!==r.baseColorFactor&&(n.baseColorFactor=r.baseColorFactor.slice()),void 0!==r.baseColorTexture&&(n.baseColorTexture=new bv(r.baseColorTexture,t),t.addTextureInfo(n.baseColorTexture)),void 0!==r.metallicFactor&&(n.metallicFactor=r.metallicFactor),void 0!==r.roughnessFactor&&(n.roughnessFactor=r.roughnessFactor),void 0!==r.metallicRoughnessTexture&&(n.metallicRoughnessTexture=new bv(r.metallicRoughnessTexture,t),t.addTextureInfo(n.metallicRoughnessTexture))}}},{key:"_setupGenericParameters",value:function(e,t){void 0!==e.doubleSided&&(this._doubleSided=e.doubleSided),void 0!==e.alphaMode&&(this._alphaMode=e.alphaMode),void 0!==e.alphaCutoff&&(this._alphaCutoff=e.alphaCutoff),void 0!==e.emissiveFactor&&(this._emissiveFactor=e.emissiveFactor.slice()),void 0!==e.emissiveTexture&&(this._emissiveTexture=new bv(e.emissiveTexture,t),t.addTextureInfo(this._emissiveTexture)),void 0!==e.normalTexture&&(this._normalTexture=new xv(e.normalTexture,t),t.addTextureInfo(this._normalTexture)),void 0!==e.occlusionTexture&&(this._occlusionTexture=new Tv(e.occlusionTexture,t),t.addTextureInfo(this._occlusionTexture))}},{key:"commonData",get:function(){return this._commonData}},{key:"pbrMetallicRoughness",get:function(){return this._pbrMetallicRoughness}},{key:"doubleSided",get:function(){return this._doubleSided}},{key:"alphaMode",get:function(){return this._alphaMode}},{key:"alphaCutoff",get:function(){return this._alphaCutoff}},{key:"emissiveFactor",get:function(){return this._emissiveFactor}},{key:"emissiveTexture",get:function(){return this._emissiveTexture}},{key:"normalTexture",get:function(){return this._normalTexture}},{key:"occlusionTexture",get:function(){return this._occlusionTexture}}]),e}(),Bp=function(){function e(t,r){Ge(this,e),this._mode=void 0!==t.mode?t.mode:4,this._attributes={},this._indices=null,this._material=null,this._setupAttributes(t.attributes,r),this._setupIndices(t,r),this._setupMaterial(t,r)}return qe(e,[{key:"_setupAttributes",value:function(e,t){for(var r in e){var n=new Up(t,e[r]);this._attributes[r]=n,t.addAccessor(n,"ATTRIBUTE")}}},{key:"_setupIndices",value:function(e,t){if(void 0!==e.indices){var r=new Up(t,e.indices);this._indices=r,t.addAccessor(r,"INDEX")}}},{key:"_setupMaterial",value:function(e,t){void 0!==e.material&&(this._material=new Vp(t,e.material))}},{key:"mode",get:function(){return this._mode}},{key:"attributes",get:function(){return this._attributes}},{key:"indices",get:function(){return this._indices}},{key:"material",get:function(){return this._material}}]),e}(),zp=function(){function e(t,r){Ge(this,e),this._primitives=[];for(var n=t.gjson.meshes[r].primitives,i=0;i<n.length;++i){var a=n[i];this._primitives.push(new Bp(a,t))}}return qe(e,[{key:"primitives",get:function(){return this._primitives}}]),e}(),Gp=function(){function e(t,r){Ge(this,e);var n=t.gjson.nodes[r];this._commonData=new dv(n,t),this._children=[],this._matrix=null,this._mesh=null,this._setupChildren(n,t),this._setupMatrix(n),this._setupMesh(n,t)}return qe(e,[{key:"_setupChildren",value:function(t,r){var n=t.children;if(void 0!==n)for(var i=0;i<n.length;++i){var a=n[i];this._children.push(new e(r,a))}}},{key:"_setupMatrix",value:function(e){if(e.matrix)this._matrix=hs.createMatrix(e.matrix);else if(e.scale||e.rotation||e.translation){var t=et(e.scale||[1,1,1],3),r=t[0],n=t[1],i=t[2],a=et(e.rotation||[0,0,0,1],4),o=a[0],s=a[1],u=a[2],_=a[3],l=et(e.translation||[0,0,0],3),c=l[0],h=l[1],f=l[2];this._matrix=hs.createMatrix([(1-2*(s*s+u*u))*r,2*(o*s+u*_)*r,2*(o*u-s*_)*r,0,2*(o*s-u*_)*n,(1-2*(o*o+u*u))*n,2*(o*_+s*u)*n,0,2*(s*_+o*u)*i,2*(s*u-o*_)*i,(1-2*(o*o+s*s))*i,0,c,h,f,1])}}},{key:"_setupMesh",value:function(e,t){var r=e.mesh;void 0!==r&&(this._mesh=new zp(t,r))}},{key:"commonData",get:function(){return this._commonData}},{key:"children",get:function(){return this._children}},{key:"matrix",get:function(){return this._matrix}},{key:"mesh",get:function(){return this._mesh}}]),e}(),jp=function(){function e(t,r){Ge(this,e);var n=t.gjson.scenes[r];this._commonData=new dv(n,t),this._root_nodes=[];var i=!0,a=!1,o=void 0;try{for(var s,u=(n.nodes||[])[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value;this._root_nodes.push(new Gp(t,_))}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}}return qe(e,[{key:"commonData",get:function(){return this._commonData}},{key:"root_nodes",get:function(){return this._root_nodes}},{key:"name",get:function(){return this._commonData.getName()}}]),e}(),qp=function(){function e(){Ge(this,e);var t=new Yp(-2,-1),r=new Yp(Math.pow(2,32)+1,Math.pow(2,32)+2);t.next=r,r.prev=t,this._fragments=t}return qe(e,[{key:"update",value:function(t){var r=t.getRangeInBuffer();this._updateByRange({first:e._floor4(r.first),last:r.last})}},{key:"close",value:function(e){this._fragments=this._fragments.next;for(var t=this._fragments;;t=t.next){if(null===t.next){t.prev.next=null;break}t.buffer=e.createSubBuffer(t.first,t.last)}}},{key:"rebuildAccessor",value:function(e){for(var t=this._fragments;null!==t;t=t.next)if(e.isIncluded(t.first,t.last)){e.rebuildBySplitter(t.buffer,t.first);break}}},{key:"_updateByRange",value:function(e){for(var t=this._fragments;null!==t.next;){if(t.isInside(e)){var r=t,n=t.next,i=new Yp(e.first,e.last);r.next=i,n.prev=i,i.prev=r,i.next=n;break}if(t.isTouch(e)){var a=t.prev,o=t.next;a.next=o,o.prev=a,e=t.mergeRange(e),t=a}else t=t.next}}}],[{key:"_floor4",value:function(e){return 4*Math.floor(e/4)}}]),e}(),Yp=function(){function e(t,r){Ge(this,e),this.first=t,this.last=r,this.buffer=null,this.prev=null,this.next=null}return qe(e,[{key:"isInside",value:function(e){return this.last<e.first&&e.last<this.next.first}},{key:"isTouch",value:function(e){return this.last>=e.first&&e.last>=this.first}},{key:"mergeRange",value:function(e){return{first:Math.min(this.first,e.first),last:Math.max(this.last,e.last)}}}]),e}(),Hp=function(){function e(t){Ge(this,e),this._length=t,this._array=new Uint32Array(Math.ceil(t/32))}return qe(e,[{key:"setBit",value:function(e,t){var r=Math.floor(e/32),n=this._array[r],i=1<<e%32;this._array[r]=t?n|i:n&~i}},{key:"getBit",value:function(e){var t=Math.floor(e/32);return 0!=(this._array[t]&1<<e%32)}},{key:"length",get:function(){return this._length}}]),e}(),Xp=function(){function e(t){Ge(this,e),this._buffer=t,this._attrib_accessors=[],this._index_accessors=[]}return qe(e,[{key:"addAttributeAccessor",value:function(e){this._attrib_accessors.push(e)}},{key:"addIndexAccessor",value:function(e){this._index_accessors.push(e)}},{key:"rewriteByteOrder",value:function(){var e=new Hp(Math.ceil(this._buffer.byteLength/2)),t=!0,r=!1,n=void 0;try{for(var i,a=this._getUnitedOriginalAccessors()[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){i.value.modifyByteOrder(e)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"splitBufferAndRebuildAccessors",value:function(){this._splitBufferAndRebuildAccessors(this._attrib_accessors),this._splitBufferAndRebuildAccessors(this._index_accessors)}},{key:"_splitBufferAndRebuildAccessors",value:function(t){var r=new qp,n=!0,i=!1,a=void 0;try{for(var o,s=e._getOriginalAccessors(t)[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;r.update(u)}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}r.close(this._buffer);var _=!0,l=!1,c=void 0;try{for(var h,f=t[Symbol.iterator]();!(_=(h=f.next()).done);_=!0){var d=h.value;r.rebuildAccessor(d)}}catch(e){l=!0,c=e}finally{try{_||null==f.return||f.return()}finally{if(l)throw c}}}},{key:"_getUnitedOriginalAccessors",value:function(){return e._getOriginalAccessors(this._attrib_accessors.concat(this._index_accessors))}},{key:"buffer",get:function(){return this._buffer}}],[{key:"_getOriginalAccessors",value:function(e){var t=new Map,r=!0,n=!1,i=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value,u=s.index;t.has(u)||t.set(u,s)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}return t.values()}}]),e}(),Wp=function(){function e(t){Ge(this,e),this._image=t,this._texinfo_objects=[]}return qe(e,[{key:"addTextureInfo",value:function(e){this._texinfo_objects.push(e)}},{key:"rebuildTextureInfo",value:function(){var e=this._texinfo_objects;if(!(e.length<=1))for(var t=e[0].texture,r=1;r<e.length;++r)e[r].texture=t}},{key:"image",get:function(){return this._image}}]),e}(),Qp=function(){function e(t,r){var n=this;if(Ge(this,e),void 0===t)this._index=-1,this._byteLength=0,this._uri=null,this._binary=null;else{this._index=r;var i=t.gjson.buffers[r];this._byteLength=i.byteLength,void 0!==i.uri?(t.onStartLoadBuffer(),t.loadBinary(i.uri).then((function(e){n._binary=e,t.onFinishLoadBuffer()})).catch((function(e){console.error(e),t.onFinishLoadBuffer(e)}))):(this._uri=null,this._binary=null)}}return qe(e,[{key:"createSubBuffer",value:function(t,r){var n=new e;return n._byteLength=r-t,n._binary=this._binary.slice(t,r),n}},{key:"index",get:function(){return this._index}},{key:"binary",get:function(){return this._binary}},{key:"byteLength",get:function(){return this._byteLength}}]),e}(),Zp=function(){function e(t,r){var n=this;Ge(this,e),this._index=r;var i=t.gjson.images[r];void 0!==i.uri?(t.onStartLoadImage(),t.loadImage(i.uri).then((function(e){n._image=e,t.onFinishLoadImage()})).catch((function(e){t.onFinishLoadImage(e)}))):void 0!==i.bufferView&&(this._bufferView=new Op(t,i.bufferView)),this._mimeType=i.mimeType,this._image=null}return qe(e,[{key:"index",get:function(){return this._index}},{key:"image",get:function(){return this._image}}]),e}(),Jp=function(){function e(t,r){Ge(this,e);var n=r||{};this._gjson=t,this._base_resource=n.base_resource,this._binary_type=n.binary_type,this._image_type=n.image_type,this._supported_extensions=n.supported_extensions||[],this._resolve=null,this._reject=null,this._used_extensions=new Set,this._scenes=[],this._default_scene_index=-1,this._buffer_entries=[],this._image_entries=[],this._body_finished=!1,this._load_count=0,this._load_error=null,this._settled=!1}return qe(e,[{key:"load",value:function(){var e=this;return new Promise((function(t,r){if(e._resolve=t,e._reject=r,e._loadVersion().major<2)r(new Error("glTF version error"));else{var n=e._getSupportedExtensionNames(),i=!0,a=!1,o=void 0;try{for(var s,u=e._enumRequiredExtensionNames()[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value;if(!n.has(_))return void r(new Error("glTF extension error: "+_))}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}e._loadExtensionsUsed(),e._loadScenes(),e._loadDefaultSceneIndex(),e._onFinishLoadBody()}}))}},{key:"_loadVersion",value:function(){var e=this._gjson.asset.version,t=/^(\d+)\.(\d+)/.exec(e);return{major:Number(t[1]),minor:Number(t[2])}}},{key:"_enumRequiredExtensionNames",value:function(){return this._gjson.extensionsRequired||[]}},{key:"_getSupportedExtensionNames",value:function(){var e=this._supported_extensions;return new Set([].concat(e))}},{key:"_loadExtensionsUsed",value:function(){this._used_extensions=new Set(this._gjson.extensionsUsed||[])}},{key:"_loadScenes",value:function(){for(var e=(this._gjson.scenes||[]).length,t=[],r=0;r<e;++r)t.push(new jp(this,r));this._scenes=t}},{key:"_loadDefaultSceneIndex",value:function(){"number"==typeof this._gjson.scene&&(this._default_scene_index=this._gjson.scene)}},{key:"extractUsedExtensions",value:function(e){var t={};for(var r in e)this._used_extensions.has(r)&&(t[r]=e[r]);return t}},{key:"loadBinary",value:function(e){return this._base_resource.loadSubResource(e,{type:this._binary_type})}},{key:"loadImage",value:function(e){return this._base_resource.loadSubResource(e,{type:this._image_type})}},{key:"findBuffer",value:function(e){return void 0===this._buffer_entries[e]&&(this._buffer_entries[e]=new Xp(new Qp(this,e))),this._buffer_entries[e].buffer}},{key:"findImage",value:function(e){return void 0===this._image_entries[e]&&(this._image_entries[e]=new Wp(new Zp(this,e))),this._image_entries[e].image}},{key:"addAccessor",value:function(e,t){var r=this._buffer_entries[e.bufferView.buffer.index];switch(t){case"ATTRIBUTE":r.addAttributeAccessor(e);break;case"INDEX":r.addIndexAccessor(e)}}},{key:"addTextureInfo",value:function(e){var t=e.texture.source;this._image_entries[t.index].addTextureInfo(e)}},{key:"onStartLoadBuffer",value:function(){this._load_count+=1}},{key:"onFinishLoadBuffer",value:function(e){e&&(this._load_error=e),this._load_count-=1,this._onFinishLoadSomething()}},{key:"onStartLoadImage",value:function(){this._load_count+=1}},{key:"onFinishLoadImage",value:function(e){e&&(this._load_error=e),this._load_count-=1,this._onFinishLoadSomething()}},{key:"_onFinishLoadBody",value:function(){this._body_finished=!0,this._onFinishLoadSomething()}},{key:"_onFinishLoadSomething",value:function(){this._settled||(null!==this._load_error?(this._reject(this._load_error),this._settled=!0):this._body_finished&&0==this._load_count&&(this._rewriteBuffersForByteOrder(),this._splitBuffersAndRebuildAccessors(),this._rebuildTextureInfo(),this._resolve(new vv(this,this._scenes,this._default_scene_index)),this._settled=!0))}},{key:"_rewriteBuffersForByteOrder",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._buffer_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.rewriteByteOrder()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"_splitBuffersAndRebuildAccessors",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._buffer_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.splitBufferAndRebuildAccessors()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"_rebuildTextureInfo",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._image_entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){var a=n.value;void 0!==a&&a.rebuildTextureInfo()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"gjson",get:function(){return this._gjson}}]),e}(),Kp=function(){function e(){Ge(this,e)}return qe(e,null,[{key:"load",value:function(e,t){return new Jp(e,t).load()}}]),e}(),$p=function(e){function t(e,r){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(Ge(this,t),r instanceof sv);else{if("string"!=typeof r)throw new Error("Unsupported Resource: "+r);r=new _v(r,{type:"json",transform:i.transform})}return(n=Ke(this,He(t).call(this,e,r,{onEntity:i.onEntity,onLoad:i.callback})))._glenv=e.glenv,n._references={},n._finished=!1,n}return Ye(t,e),qe(t,[{key:"getReference",value:function(e){var t=this._references[e];return void 0!==t?t:null}},{key:"_setReference",value:function(e,t){this._references[e]=t}},{key:"_load",value:function(){var e=this;return this._resource.load({type:uv.JSON}).then((function(t){return e._check_cancel(),e._load_object(t)}))}},{key:"_load_object",value:function(e){var t=this;return Promise.resolve().then((function(){return t._load_model_register(e)})).then((function(){return t._postload_object(e)}))}},{key:"_postload_object",value:function(e){this.status===cv.Status.LOADING&&this._load_entity_list(e)}},{key:"_load_model_register",value:function(e){var t=e.model_register;if(t){for(var r=Object.keys(t),n=[],i=0;i<r.length;++i){var a=r[i],o=t[a];n.push(this._load_model_container(e,a,o))}return Promise.all(n)}}},{key:"_load_model_container",value:function(e,r,n){var i=this,a=n.link;if(!this._resource.resolveResourceSupported())return Promise.reject(new Error("Sub Resource is not supported"));var o=this._resource.resolveResource(a);return o.load({type:uv.JSON}).then((function(e){return i._check_cancel(),Kp.load(e,{base_resource:o,binary_type:uv.BINARY,image_type:uv.IMAGE,supported_extensions:Av.getSupportedExtensions_glTF()})})).then((function(e){var a=new Av(i._scene,e);if(n.offset_transform){var o=t.parseOffsetTransform(n.offset_transform);a.setOffsetTransform(o)}i._setReference(r,a)}))}},{key:"_load_entity_list",value:function(e){var t=e.entity_list;if(t)for(var r=this._scene,n=0;n<t.length;++n){var i=t[n],a=i.type,o=null;switch(a){case"markerline":o=new qv(r,{json:i,refs:this._references});break;case"path":o=new Yv(r,{json:i,refs:this._references});break;case"text":o=new $v(r,{json:i,refs:this._references});break;case"model":o=new ap(r,{json:i,refs:this._references});break;case"polygon":o=new wp(r,{json:i,refs:this._references});break;default:console.error("mapray: unknown entity type: "+a)}if(o){this._onEntity(this,o,i);var s=i.id;s&&this._setReference(s,o)}}}}],[{key:"parseOffsetTransform",value:function(e){var t=e,r=t.translate||[0,0,0],n=new ds(t.heading,t.tilt,t.roll),i=void 0!==t.scale?t.scale:[1,1,1];"number"==typeof i&&(i=[i,i,i]);var a=hs.createMatrix();return n.getTransformMatrix(i,a),a[12]=r[0],a[13]=r[1],a[14]=r[2],a}}]),t}(cv);$p._defaultHeaders={};var ey=function(){function e(t,r){var n;Ge(this,e),this._visibility=r&&r.visibility||!0,this._position=r&&r.position||ty.TOP_LEFT,n="string"==typeof t?document.getElementById(t):t,this._viewer_container=n,this._container=null,this._is_compact=!1;var i=this;window.addEventListener("resize",(function(){i._sizeChanged()}),!1)}return qe(e,[{key:"setVisibility",value:function(e){this._visibility=e,this._setContainerVisibility()}},{key:"setPosition",value:function(e){this._position=e,this._deleteContainer(),this.createContainer()}},{key:"_setContainerVisibility",value:function(){this._container&&(this._visibility?this._container.style.visibility="visible":this._container.style.visibility="collapse")}},{key:"_destroy",value:function(){var e=this;window.removeEventListener("resize",(function(){e._sizeChanged()}),!1),this._deleteContainer()}},{key:"_deleteContainer",value:function(){this._container.parentElement.removeChild(this._container),this._container=null}},{key:"_sizeChanged",value:function(){}},{key:"createContainer",value:function(){}}]),e}(),ty={TOP_LEFT:{id:"top-left"},TOP_RIGHT:{id:"top-right"},BOTTOM_LEFT:{id:"bottom-left"},BOTTOM_RIGHT:{id:"bottom-right"}};ey._compact_size=500,ey.ContainerPosition=ty;var ry=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this,e,r)))._position=r&&r.position||ey.ContainerPosition.BOTTOM_LEFT,n}return Ye(t,e),qe(t,[{key:"_sizeChanged",value:function(){if(this._container){var e=this._container.children[0];this._container.parentElement.parentElement.clientWidth<ey._compact_size?e.classList.add("mapray-logo-compact"):e.classList.remove("mapray-logo-compact")}}},{key:"createContainer",value:function(){var e="control-"+this._position.id,t=this._viewer_container.getElementsByClassName(e)[0],r=document.createElement("div");r.className="control";var n=document.createElement("a");n.className="mapray-logo",n.href="https://mapray.com",n.target="_blank",r.appendChild(n),this._container=r,t.appendChild(this._container),this._sizeChanged()}}]),t}(ey),ny=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this,e,r)))._position=r&&r.position||ey.ContainerPosition.BOTTOM_RIGHT,n._attributions=[],r&&r.attributions?n.copyAttributions(r.attributions):n.copyAttributions(t._default_attribution),n}return Ye(t,e),qe(t,[{key:"addAttribution",value:function(e){this._attributions.push(e),this._deleteContainer(),this.createContainer()}},{key:"clearAttribution",value:function(){this._attributions=[],this._deleteContainer(),this.createContainer()}},{key:"_sizeChanged",value:function(){this._container&&(this._container.parentElement.parentElement.clientWidth<ey._compact_size?this._container.classList.add("mapray-attribution-compact"):this._container.classList.remove("mapray-attribution-compact"))}},{key:"createContainer",value:function(){var e="control-"+this._position.id,t=this._viewer_container.getElementsByClassName(e)[0],r=document.createElement("div");r.classList.add("control"),r.classList.add("mapray-attribution");var n=document.createElement("div");n.classList.add("mapray-attribution-container");var i=!0,a=!1,o=void 0;try{for(var s,u=this._attributions[Symbol.iterator]();!(i=(s=u.next()).done);i=!0){var _=s.value;if(_.display){var l=document.createElement("a");_.link&&(l.href=_.link,l.target="_blank");var c=document.createTextNode(_.display);l.appendChild(c),n.appendChild(l)}}}catch(e){a=!0,o=e}finally{try{i||null==u.return||u.return()}finally{if(a)throw o}}r.appendChild(n),this._container=r,t.appendChild(this._container),this._sizeChanged()}},{key:"copyAttributions",value:function(e){this._attributions=e.map((function(e){return e}))}}]),t}(ey);ny._default_attribution=[{display:"©Mapray",link:"https://mapray.com"},{display:"©JAXA",link:"http://www.jaxa.jp/"},{display:"測量法に基づく国土地理院長承認（複製）H30JHf626",link:"https://www.gsi.go.jp/kiban/index.html"}];var iy=function(){function e(t,r){var n;Ge(this,e),n="string"==typeof t?document.getElementById(t):t;var i=this._createCanvas(n);this._container_element=n,this._canvas_element=i,this._glenv=new cu(i),this._camera=new _u(i),this._animation=this._createAnimationBindingBlock(),this._dem_provider=this._createDemProvider(r),this._image_provider=this._createImageProvider(r),this._layers=this._createLayerCollection(r),this._globe=new L_(this._glenv,this._dem_provider),this._tile_texture_cache=new Q_(this._glenv,this._image_provider),this._scene=new Mh(this,this._glenv),this._ground_visibility=e._getBoolOption(r,"ground_visibility",!0),this._entity_visibility=e._getBoolOption(r,"entity_visibility",!0),this._render_mode=r&&r.render_mode||oy.SURFACE,this._debug_stats=r&&r.debug_stats||null,this._point_cloud_collection=this._createPointCloudCollection(r),this._render_callback=this._createRenderCallback(r),this._frame_req_id=0,this._previous_time=void 0,this._is_destroyed=!1,this._logo_controller=r&&r.logo_controller||new ry(this._container_element),this._attribution_controller=r&&r.attribution_controller||new ny(this._container_element),this._createLogoAttributionContainer(),this._logo_controller.createContainer(),this._attribution_controller.createContainer(),this._requestNextFrame(),this._updateCanvasSize()}return qe(e,[{key:"destroy",value:function(){this._is_destroyed||(0!=this._frame_req_id&&(window.maprayCancelAnimationFrame(this._frame_req_id),this._frame_req_id=0),this._render_callback.detach(),this._render_callback=this._createRenderCallback(),this._container_element.removeChild(this._canvas_element),this._globe.cancel(),this._tile_texture_cache.cancel(),this._layers.cancel(),this._scene.cancelLoaders(),this._logo_controller._destroy(),this._attribution_controller._destroy(),this._attribution_controller=null,this._deleteLogoAttributionContainer(),this._is_destroyed=!0)}},{key:"_createCanvas",value:function(e){var t=document.createElement("canvas");return t.className="mapray-canvas",t.style.width="100%",t.style.height="100%",e.appendChild(t),t}},{key:"_createDemProvider",value:function(e){return e&&e.dem_provider?e.dem_provider:new Th("/dem/",".bin")}},{key:"_createAnimationBindingBlock",value:function(){var e=this,t=new Zs;return t.addDescendantUnbinder((function(){e._unbindDescendantAnimations()})),t}},{key:"_createImageProvider",value:function(e){return e&&e.image_provider?e.image_provider:new gh("http://cyberjapandata.gsi.go.jp/xyz/std/",".png",256,0,18)}},{key:"_createLayerCollection",value:function(e){var t=e&&e.layers?e.layers:{};return new Rh(this._glenv,t)}},{key:"_createPointCloudCollection",value:function(e){var t=e&&e.point_cloud_providers?e.point_cloud_providers:{};return new Ih(this._scene,t)}},{key:"_createRenderCallback",value:function(e){var t;return(t=e&&e.render_callback?e.render_callback:new Sh).attach(this),t}},{key:"_createLogoAttributionContainer",value:function(){var t=!0,r=!1,n=void 0;try{for(var i,a=e._positions[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value,s=document.createElement("div");s.className=o,this._container_element.appendChild(s)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"_deleteLogoAttributionContainer",value:function(){var t=!0,r=!1,n=void 0;try{for(var i,a=e._positions[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value;document.getElementById(o)&&this._container_element.removeChild(o)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}}},{key:"setVisibility",value:function(e,t){switch(e){case ay.GROUND:this._ground_visibility=t;break;case ay.ENTITY:this._entity_visibility=t;break;default:throw new Error("invalid target: "+e)}}},{key:"getVisibility",value:function(e,t){switch(e){case ay.GROUND:return this._ground_visibility;case ay.ENTITY:return this._entity_visibility;default:throw new Error("invalid target: "+e)}}},{key:"getElevation",value:function(e,t){var r=t+180*Math.floor((90-e)/360+Math.floor((90+e)/360)),n=90-Math.abs(90-e+360*Math.floor((90+e)/360)),i=(r-360-360*Math.floor((r-180)/360))*hs.DEGREE,a=hs.invGudermannian(n*hs.DEGREE),o=2*Math.PI,s=i/o+.5,u=.5-a/o;if(u<0||u>1)return 0;var _=this._globe,l=_.findHighestAccuracy(s,u);if(null===l)return 0;var c=1<<_.dem_provider.getResolutionPower(),h=Math.pow(2,l.z),f=c*(h*s-l.x),d=c*(h*u-l.y),v=hs.clamp(Math.floor(f),0,c-1),p=hs.clamp(Math.floor(d),0,c-1),y=l.getHeights(v,p),g=f-v,m=d-p;return(y[0]*(1-g)+y[1]*g)*(1-m)+(y[2]*(1-g)+y[3]*g)*m}},{key:"getExistingElevation",value:function(e){var t=[e.longitude,e.latitude,0];return this._globe.getExistingElevations(1,t,0,3,t,2,3),t[2]}},{key:"getExistingElevations",value:function(e,t,r,n,i,a,o){return this._globe.getExistingElevations(e,t,r,n,i,a,o)}},{key:"getRayIntersection",value:function(e){var t=this._globe;if(t.status!==L_.Status.READY)return null;var r=t.root_flake.findRayDistance(e,Number.MAX_VALUE);if(r===Number.MAX_VALUE)return null;var n=hs.createVector3(),i=e.position,a=e.direction;return n[0]=i[0]+r*a[0],n[1]=i[1]+r*a[1],n[2]=i[2]+r*a[2],n}},{key:"_requestNextFrame",value:function(){var e=this;this._frame_req_id=window.maprayRequestAnimationFrame((function(){return e._updateFrame()}))}},{key:"_updateFrame",value:function(){var e=this._updateTime();this._requestNextFrame(),this._updateCanvasSize(),this._render_callback.onUpdateFrameInner(e),null!==this._debug_stats&&this._debug_stats.clearStats(),new vh(this).render(),this._finishDebugStats()}},{key:"pick",value:function(e){var t=new ph(this,e);return t.render(),t.pick_result}},{key:"_updateTime",value:function(){var e=window.maprayNow(),t=void 0!==this._previous_time?(e-this._previous_time)/1e3:0;return this._previous_time=e,t}},{key:"_updateCanvasSize",value:function(){var e=this._canvas_element;e.width!=e.clientWidth&&(e.width=e.clientWidth),e.height!=e.clientHeight&&(e.height=e.clientHeight)}},{key:"_finishDebugStats",value:function(){var e=this._debug_stats;null!==e&&(e.num_wait_reqs_dem=this._globe.getNumDemWaitingRequests(),e.num_wait_reqs_img=this._tile_texture_cache.getNumWaitingRequests(),e.onUpdate())}},{key:"_unbindDescendantAnimations",value:function(){this._scene.animation.unbindAllRecursively()}},{key:"container_element",get:function(){return this._container_element}},{key:"canvas_element",get:function(){return this._canvas_element}},{key:"animation",get:function(){return this._animation}},{key:"dem_provider",get:function(){return this._dem_provider}},{key:"image_provider",get:function(){return this._image_provider}},{key:"layers",get:function(){return this._layers}},{key:"point_cloud_collection",get:function(){return this._point_cloud_collection}},{key:"render_callback",get:function(){return this._render_callback}},{key:"render_mode",get:function(){return this._render_mode},set:function(e){this._render_mode=e}},{key:"debug_stats",get:function(){return this._debug_stats}},{key:"camera",get:function(){return this._camera}},{key:"scene",get:function(){return this._scene}},{key:"glenv",get:function(){return this._glenv}},{key:"globe",get:function(){return this._globe}},{key:"tile_texture_cache",get:function(){return this._tile_texture_cache}},{key:"logo_controller",get:function(){return this._logo_controller}},{key:"attribution_controller",get:function(){return this._attribution_controller}}],[{key:"_getBoolOption",value:function(e,t,r){return e&&void 0!==e[t]?e[t]:r}}]),e}(),ay={GROUND:{id:"GROUND"},ENTITY:{id:"ENTITY"}},oy={SURFACE:{id:"SURFACE"},WIREFRAME:{id:"WIREFRAME"}};iy.Category=ay,iy.RenderMode=oy,iy.ContainerPosition=ey.ContainerPosition,iy._positions=["control-top-left","control-top-right","control-bottom-left","control-bottom-right"];var sy=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this)))._headers={"X-Api-Key":e},r}return Ye(t,e),qe(t,[{key:"requestTile",value:function(e,t,r,n){var i=new AbortController;return fetch(this._makeURL(e,t,r),{headers:this._headers,signal:i.signal}).then((function(e){return e.ok?e.arrayBuffer():Promise.reject(Error(e.statusText))})).then((function(e){n(e)})).catch((function(){n(null)})),i}},{key:"cancelRequest",value:function(e){e.abort()}},{key:"_makeURL",value:function(e,t,r){return"https://tiles.mapray.com/dem/"+e+"/"+t+"/"+r+".bin"}}]),t}(xh),uy="/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;     // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;       // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;     // テクスチャ座標\nattribute vec2 a_texmaskcoord; // テクスチャマスク座標\nattribute vec3 a_fg_color;     // 前景色\nattribute vec3 a_bg_color;     // 背景色\n\nuniform mat4 u_obj_to_clip;    // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;         // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;       // テクスチャ座標\nvarying vec2 v_texmaskcoord;   // テクスチャマスク座標\nvarying vec3 v_fg_color;       // 前景色\nvarying vec3 v_bg_color;       // 背景色\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n    v_texmaskcoord = a_texmaskcoord;\n    v_fg_color = a_fg_color;\n    v_bg_color = a_bg_color;\n}\n",_y="/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;        // アイコンのテクスチャ座標\nvarying vec2 v_texmaskcoord;    // アイコンマスクのテクスチャ座標\nvarying vec3 v_fg_color;        // 前景色\nvarying vec3 v_bg_color;        // 背景色\n\nuniform sampler2D u_image;      // アイコン画像\nuniform sampler2D u_image_mask; // アイコンマスク画像\n\n\nvoid\nmain()\n{\n    float alpha = texture2D( u_image, v_texcoord ).w;          // 輝度\n    float mask = texture2D( u_image_mask, v_texmaskcoord ).w;  // マスク\n    alpha *= mask;\n    gl_FragColor = vec4(v_fg_color * alpha + v_bg_color * (1.0 - alpha), 1.0);\n}\n",ly=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Ge(this,t),(r=Ke(this,He(t).call(this,e,uy,n.ridMaterial?nl:_y))).bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r.setInteger("u_image_mask",t.TEXUNIT_IMAGE_MASK),r}return Ye(t,e),qe(t,[{key:"isTranslucent",value:function(e,t){return!1}},{key:"setParameters",value:function(e,r){$e(He(t.prototype),"setParameters",this).call(this,e,r);var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;if(i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i),e.getRenderTarget()===fh.SCENE){var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle);var o=n.image_mask;this.bindTexture2D(t.TEXUNIT_IMAGE_MASK,o.handle)}}}]),t}(yv);ly.TEXUNIT_IMAGE=0,ly.TEXUNIT_IMAGE_MASK=1,ly._sparam=hs.createVector2f(),ly._bg_color=hs.createVector3f(),ly._fg_color=hs.createVector3f();var cy=function(){function e(){Ge(this,e),this._cache=new Map}return qe(e,[{key:"create",value:function(e){var t=this.getKey(e),r=this._cache.get(t);return r||this._cache.set(t,r=this.doCreate(e)),r}},{key:"doCreate",value:function(e){}},{key:"getKey",value:function(e){return e}},{key:"load",value:function(e){var t=this.create(e);return t.load(),t}}]),e}(),hy=function(){function e(){Ge(this,e),this._status=e.Status.NOT_LOADED,this._funcs=[],this._icon=null}var t,r;return qe(e,[{key:"isLoaded",value:function(){return this._status===e.Status.LOADED}},{key:"onEnd",value:function(t){this._status===e.Status.LOADED||this._status===e.Status.ABORTED?t(this):this._funcs.push(t)}},{key:"load",value:(r=ze(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._status!==e.Status.NOT_LOADED){t.next=14;break}return this._status=e.Status.LOADING,t.prev=2,t.next=5,this.doLoad();case 5:this._icon=t.sent,this._status=e.Status.LOADED,t.next=12;break;case 9:t.prev=9,t.t0=t.catch(2),this._status=e.Status.ABORTED;case 12:for(r=0;r<this._funcs.length;r++)this._funcs[r](this);this._funcs.length=0;case 14:case"end":return t.stop()}}),t,this,[[2,9]])}))),function(){return r.apply(this,arguments)})},{key:"doLoad",value:(t=ze(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("doLoad() is not implemented in: "+this.constructor.name);case 1:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"draw",value:function(e,t,r,n,i){e.drawImage(this.icon,t,r,n,i)}},{key:"status",get:function(){return this._status}},{key:"icon",get:function(){return this._icon}},{key:"width",get:function(){return this._icon?this.icon.width:-1}},{key:"height",get:function(){return this._icon?this.icon.height:-1}}]),e}();hy.Status={NOT_LOADED:"not loaded",LOADING:"loading",LOADED:"loaded",ABORTED:"aborted"};var fy=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this))).urlPrefix=e,n.urlSuffix=r,n}return Ye(t,e),qe(t,[{key:"doCreate",value:function(e){return new dy(this.urlPrefix+e+this.urlSuffix)}}]),t}(cy),dy=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this))).url=e,r}var r;return Ye(t,e),qe(t,[{key:"doLoad",value:(r=ze(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ov.loadImage(this.url,{crossOrigin:"Anonymous"});case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})}]),t}(hy),vy=function(e){function t(){return Ge(this,t),Ke(this,He(t).apply(this,arguments))}return Ye(t,e),qe(t,[{key:"doCreate",value:function(e){return new py(e.text,e.props)}},{key:"getKey",value:function(e){return e.text}}]),t}(cy),py=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Ge(this,t),(r=Ke(this,He(t).call(this))).text=e,r.props=n,r}var r;return Ye(t,e),qe(t,[{key:"doLoad",value:(r=ze(regeneratorRuntime.mark((function e(){var t,r,n,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.props,r=t.size?t.size[0]:20,n=t.font_family?"'"+t.font_family+"'":ov.SYSTEM_FONT_FAMILY,(i=ov.createCanvasContext(r,r)).textAlign="center",i.textBaseline="alphabetic",i.font=.6756756757*r+"px "+n,i.fillText(this.text,.5*r,.7432432432*r),e.abrupt("return",i.canvas);case 9:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"draw",value:function(e,t,r,n,i){e.drawImage(this.icon,t,r,n,i)}}]),t}(hy),yy=function(e){function t(){return Ge(this,t),Ke(this,He(t).apply(this,arguments))}return Ye(t,e),qe(t,[{key:"doCreate",value:function(e){return new gy(e)}}]),t}(cy),gy=function(e){function t(e){var r;return Ge(this,t),(r=Ke(this,He(t).call(this)))._image_src=e,r}var r;return Ye(t,e),qe(t,[{key:"doLoad",value:(r=ze(regeneratorRuntime.mark((function e(){var t,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((t=this._image_src)instanceof sv)){e.next=7;break}return e.next=4,t.load({type:uv.IMAGE});case 4:e.t0=e.sent,e.next=22;break;case 7:if("string"!=typeof t){e.next=13;break}return e.next=10,ov.loadImage(t);case 10:e.t1=e.sent,e.next=21;break;case 13:if(!(t instanceof HTMLImageElement)){e.next=19;break}return e.next=16,ov.waitForLoad(t);case 16:e.t2=e.sent,e.next=20;break;case 19:e.t2=t instanceof HTMLCanvasElement?t:null;case 20:e.t1=e.t2;case 21:e.t0=e.t1;case 22:if(r=e.t0){e.next=25;break}throw new Error("not supported: "+t);case 25:return e.abrupt("return",r);case 26:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})}]),t}(hy),my=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this,e,r)))._entries=[],n._parent_props={fg_color:null,bg_color:null,size:null,font_family:null},n._primitive_producer=new ky(Je(n)),n._animation.addDescendantUnbinder((function(){n._unbindDescendantAnimations()})),n._setupAnimationBindingBlock(),r&&r.json&&n._setupByJson(r.json),n}return Ye(t,e),qe(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"onChangeAltitudeMode",value:function(e){this._primitive_producer.onChangeAltitudeMode()}},{key:"_unbindDescendantAnimations",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){n.value.animation.unbindAllRecursively()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"_setupAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ti.find("number"),n=Ti.find("vector2"),i=Ti.find("vector3");t.addEntry("fg_color",[i],null,(function(t){e.setFGColor(t)})),t.addEntry("bg_color",[i],null,(function(t){e.setBGColor(t)}));var a,o=hs.createVector2();t.addEntry("size",[n,r],(function(e){return a=$s.findFirstTypeSupported(e,[n,r])}),(function(t){a===n?e.setSize(t):(o[0]=t,o[1]=t,e.setSize(o))}))}},{key:"setSize",value:function(e){this._setVector2Property("size",e)}},{key:"setFGColor",value:function(e){this._setVector3Property("fg_color",e)}},{key:"setBGColor",value:function(e){this._setVector3Property("bg_color",e)}},{key:"setFontFamily",value:function(e){this._setValueProperty("font_family",e)}},{key:"addPin",value:function(e,t){return this.addTextPin("",e,t)}},{key:"addMakiIconPin",value:function(e,t,r){var n=new wy(this,e,t,r);return this._entries.push(n),this._primitive_producer.onAddEntry(),n}},{key:"addTextPin",value:function(e,t,r){var n=new by(this,e,t,r);return this._entries.push(n),this._primitive_producer.onAddEntry(),n}},{key:"_getMaterial",value:function(e){var t=this.scene;return e===fh.SCENE?(t._PinEntity_pin_material||(t._PinEntity_pin_material=new ly(t.glenv)),t._PinEntity_pin_material):e===fh.RID?(t._PinEntity_pin_material_pick||(t._PinEntity_pin_material_pick=new ly(t.glenv,{ridMaterial:!0})),t._PinEntity_pin_material_pick):void 0}},{key:"_setValueProperty",value:function(e,t){var r=this._parent_props;r[e]!=t&&(r[e]=t,this._primitive_producer.onChangeParentProperty())}},{key:"_setVector3Property",value:function(e,t){var r=this._parent_props[e];r?r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]||(hs.copyVector3(t,r),this._primitive_producer.onChangeParentProperty()):(r=this._parent_props[e]=hs.createVector3f(t),this._primitive_producer.onChangeParentProperty())}},{key:"_setVector2Property",value:function(e,t){var r=this._parent_props[e];r?r[0]===t[0]&&r[1]===t[1]||(hs.copyVector2(t,r),this._primitive_producer.onChangeParentProperty()):(this._parent_props[e]=hs.createVector2f(t),this._primitive_producer.onChangeParentProperty())}},{key:"_setupByJson",value:function(e){var t=new fs,r=!0,n=!1,i=void 0;try{for(var a,o=e.entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;t.setFromArray(s.position),this.addPin(t,s)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}e.size&&this.setSize(e.size),e.fg_color&&this.setFGColor(e.fg_color),e.bg_color&&this.setBGColor(e.bg_color),e.font_family&&this.setBGColor(e.font_family)}},{key:"getEntry",value:function(e){return this._entries.find((function(t){return t.id===e}))}}]),t}(I_);my.SAFETY_PIXEL_MARGIN=1,my.MAX_IMAGE_WIDTH=4096,my.CIRCLE_SEP_LENGTH=32,my.DEFAULT_SIZE=hs.createVector2f([30,30]),my.DEFAULT_FONT_FAMILY="sans-serif",my.DEFAULT_FG_COLOR=hs.createVector3f([1,1,1]),my.DEFAULT_BG_COLOR=hs.createVector3f([.35,.61,.81]),my.SAFETY_PIXEL_MARGIN=1,my.MAX_IMAGE_WIDTH=4096;var ky=function(e){function t(e){var r;Ge(this,t),(r=Ke(this,He(t).call(this,e)))._glenv=e.scene.glenv,r._dirty=!0,r._transform=hs.setIdentity(hs.createMatrix()),r._properties={image:null,image_mask:null};var n=new c_(r._glenv,null,e._getMaterial(fh.SCENE),r._transform);n.properties=r._properties,r._primitive=n;var i=new c_(r._glenv,null,e._getMaterial(fh.RID),r._transform);return i.properties=r._properties,r._pickPrimitive=i,r._primitives=[],r._pickPrimitives=[],r}return Ye(t,e),qe(t,[{key:"createRegions",value:function(){var e=new Lv,t=!0,r=!1,n=void 0;try{for(var i,a=this.entity._entries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value.position;e.addPoint(o)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return[e]}},{key:"onChangeElevation",value:function(e){this._dirty=!0}},{key:"getPrimitives",value:function(e){return this._updatePrimitive(e),e.getRenderTarget()===fh.SCENE?this._primitives:this._pickPrimitives}},{key:"onChangeParentProperty",value:function(){this._dirty=!0}},{key:"onChangeChildProperty",value:function(){this._dirty=!0}},{key:"onChangeAltitudeMode",value:function(){this._dirty=!0}},{key:"onAddEntry",value:function(){this.needToCreateRegions(),this._dirty=!0}},{key:"_updatePrimitive",value:function(){if(this._dirty){if(0==this.entity._entries.length)return this._primitives=[],this._pickPrimitives=[],void(this._dirty=!1);var e=this._createFlatGocsArray();this._updateTransform(e);var t=new xy(this,e);if(!t.isValid())return this._primitives=[],this._pickPrimitives=[],void(this._dirty=!1);var r=this._properties;r.image&&r.image.dispose(),r.image=t.texture,r.image_mask&&r.image_mask.dispose(),r.image_mask=t.texture_mask;var n={vtype:[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2},{name:"a_texmaskcoord",size:2},{name:"a_fg_color",size:3},{name:"a_bg_color",size:3}],vertices:t.vertices,indices:t.indices},i=new k_(this._glenv,n),a=this._primitive;a.mesh&&a.mesh.dispose();var o=this._pickPrimitive;o.mesh&&o.mesh.dispose(),a.mesh=i,o.mesh=i,this._primitives=[a],this._pickPrimitives=[o],this._dirty=!1}}},{key:"_updateTransform",value:function(e){for(var t=this.entity._entries.length,r=0,n=0,i=0,a=0;a<t;++a){var o=3*a;r+=e[o],n+=e[o+1],i+=e[o+2]}var s=this._transform;s[12]=r/t,s[13]=n/t,s[14]=i/t}},{key:"_createFlatGocsArray",value:function(){var e=this.entity._entries.length;return fs.toGocsArray(this._getFlatGeoPoints_with_Absolute(),e,new Float64Array(3*e))}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){for(var e=this.entity,t=e._entries,r=t.length,n=new Float64Array(3*r),i=0;i<r;++i){var a=t[i].position;n[3*i]=a.longitude,n[3*i+1]=a.latitude}switch(e.altitude_mode){case R_.RELATIVE:case R_.CLAMP:if(e.scene.viewer.getExistingElevations(r,n,0,3,n,2,3),e.altitude_mode===R_.RELATIVE)for(var o=0;o<r;++o)n[3*o+2]+=t[o].position.altitude;break;default:for(var s=0;s<r;++s)n[3*s+2]=t[s].position.altitude}return n}}]),t}(I_.PrimitiveProducer),Ey=function(){function e(t,r,n){Ge(this,e),this._owner=t,this._position=r.clone(),this._animation=new Zs,this._setupAnimationBindingBlock(),this._props=Object.assign({},n),this._copyPropertyVector3f("fg_color"),this._copyPropertyVector3f("bg_color"),this._copyPropertyVector2f("size")}return qe(e,[{key:"_loadIcon",value:function(){throw new Error("loadIcon() is not implemented: "+this.constructor.name)}},{key:"_setupAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ti.find("number"),n=Ti.find("vector2"),i=Ti.find("vector3"),a=new fs;t.addEntry("position",[i],null,(function(t){a.setFromArray(t),e.setPosition(a)})),t.addEntry("fg_color",[i],null,(function(t){e.setFGColor(t)})),t.addEntry("bg_color",[i],null,(function(t){e.setBGColor(t)}));var o,s=hs.createVector2();t.addEntry("size",[n,r],(function(e){return o=$s.findFirstTypeSupported(e,[n,r])}),(function(t){o===n?e.setSize(t):(s[0]=t,s[1]=t,e.setSize(s))}))}},{key:"setPosition",value:function(e){this._position.longitude===e.longitude&&this._position.latitude===e.latitude&&this._position.altitude===e.altitude||(this._position.assign(e),this._owner.getPrimitiveProducer().onChangeChildProperty())}},{key:"setSize",value:function(e){this._setVector2Property("size",e)}},{key:"setFGColor",value:function(e){this._setVector3Property("fg_color",e)}},{key:"setBGColor",value:function(e){this._setVector3Property("bg_color",e)}},{key:"_copyPropertyVector3f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&(t[e]=hs.createVector3f(t[e]))}},{key:"_copyPropertyVector2f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&("number"==typeof t[e]?t[e]=hs.createVector2f([t[e],t[e]]):t[e]=hs.createVector2f(t[e]))}},{key:"_setVector3Property",value:function(e,t){var r=this._props[e];r?r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]||(hs.copyVector3(t,r),this._owner.getPrimitiveProducer().onChangeChildProperty()):(r=this._props[e]=hs.createVector3f(t),this._owner.getPrimitiveProducer().onChangeChildProperty())}},{key:"_setVector2Property",value:function(e,t){var r=this._props[e];r?r[0]===t[0]&&r[1]===t[1]||(hs.copyVector2(t,r),this._owner.getPrimitiveProducer().onChangeChildProperty()):(this._props[e]=hs.createVector2f(t),this._owner.getPrimitiveProducer().onChangeChildProperty())}},{key:"isLoaded",value:function(){return this._icon.isLoaded()}},{key:"draw",value:function(e,t,r,n,i){this._icon.draw(e,t,r,n,i)}},{key:"position",get:function(){return this._position}},{key:"id",get:function(){return this._props.hasOwnProperty("id")?this._props.id:""}},{key:"size",get:function(){var e=this._props,t=this._owner._parent_props;return e.size||t.size||(this.icon?hs.createVector2f([this.icon.width,this.icon.height]):my.DEFAULT_SIZE)}},{key:"fg_color",get:function(){var e=this._props,t=this._owner._parent_props;return e.fg_color||t.fg_color||my.DEFAULT_FG_COLOR}},{key:"bg_color",get:function(){var e=this._props,t=this._owner._parent_props;return e.bg_color||t.bg_color||my.DEFAULT_BG_COLOR}},{key:"animation",get:function(){return this._animation}},{key:"icon",get:function(){return this._icon}}]),e}();my.AbstractPinEntry=Ey;var wy=function(e){function t(e,r,n,i){var a;return Ge(this,t),(a=Ke(this,He(t).call(this,e,n,i))).setId(r),a._setupMakiIconPinAnimationBindingBlock(),a}return Ye(t,e),qe(t,[{key:"_setupMakiIconPinAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ti.find("string");t.addEntry("id",[r],null,(function(t){e.setId(t)}))}},{key:"setId",value:function(e){var r=this;this._maki_id!==e&&(this._maki_id=e,this._icon=t.makiIconLoader.load(e),this._icon.onEnd((function(e){r._owner.getPrimitiveProducer()._dirty=!0})))}}]),t}(Ey);my.MakiIconPinEntry=wy,wy.makiIconLoader=new fy("https://resource.mapray.com/styles/v1/icons/maki/",".svg");var by=function(e){function t(e,r,n,i){var a;return Ge(this,t),(a=Ke(this,He(t).call(this,e,n,i))).setText(r),a._setupTextPinAnimationBindingBlock(),a}return Ye(t,e),qe(t,[{key:"_setupTextPinAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ti.find("string");t.addEntry("text",[r],null,(function(t){e.setText(t)}))}},{key:"setText",value:function(e){var r=this;this._text!==e&&(this._text=e,this._icon=t.textIconLoader.load({text:this._text,props:{size:this.size,font_family:this.font_family}}),this._icon.onEnd((function(e){r._owner.getPrimitiveProducer()._dirty=!0})))}},{key:"font_family",get:function(){var e=this._props,t=this._owner._parent_props;return e.font_family||t.font_family||my.DEFAULT_FONT_FAMILY}}]),t}(Ey);my.TextPinEntry=by,by.textIconLoader=new vy;var xy=function(){function e(t,r){Ge(this,e),this._owner=t,this._items=this._createItemList(),this._is_valid=!0;var n=this._createRowLayouts();if(0!=n.length){var i=this._setupLocation(n);this._texture=this._createTexture(i.width,i.height),this._texture_mask=this._createTextureMask(),this._vertices=this._createVertices(i.width,i.height,r),this._indices=this._createIndices()}else this._is_valid=!1}return qe(e,[{key:"isValid",value:function(){return this._is_valid}},{key:"_createItemList",value:function(){var e=new Map,t=[],r=0,n=!0,i=!1,a=void 0;try{for(var o,s=this._owner.entity._entries[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;if(u.isLoaded()){var _=e.get(u.icon);_||(e.set(u.icon,_=new Ty(this)),t.push(_)),_.add(r++,u)}}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}return t}},{key:"_createRowLayouts",value:function(){var e=[].concat(this._items);e.sort((function(e,t){return e.height_pixel-t.height_pixel}));for(var t=[];e.length>0;){var r=new Ay(e);r.isValid()&&t.push(r)}return t}},{key:"_createTexture",value:function(e,t){for(var r=ov.createCanvasContext(e,t),n=this._items,i=0;i<n.length;++i){var a=n[i];a.is_canceled||a.draw(r)}var o=this._owner._glenv,s={usage:pv.Usage.ICON};return new pv(o,r.canvas,s)}},{key:"_createTextureMask",value:function(){var e=ov.createCanvasContext(3,3);e.fillRect(1,1,1,1);var t=this._owner._glenv,r={usage:pv.Usage.ICON,mag_filter:t.context.NEAREST};return new pv(t,e.canvas,r)}},{key:"_createVertices",value:function(e,t,r){for(var n=[],i=this._owner._transform,a=i[12],o=i[13],s=i[14],u=1/e,_=1/t,l=this._items,c=0;c<l.length;++c){var h=l[c];if(!h.is_canceled)for(var f=0;f<h.entries.length;f++){var d=h.entries[f],v=d.entry,p=v.size,y=1.5*p[0]/2,g=1.5*p[1]/2,m=2*g,k=Math.max(2,y/10),E=3*d.index,w=r[E]-a,b=r[E+1]-o,x=r[E+2]-s,T=v.fg_color,A=v.bg_color,R=h.pos_x,I=h.pos_y,P=h.width,S=h.height,M=function(e,t){n.push((R+P*e)*u,1-(I+S*t)*_)};n.push(w,b,x),n.push(-k/2,m-g),M(.5-k/2/y,1.25),n.push(.25,.25),n.push.apply(n,tt(T)),n.push.apply(n,tt(A)),n.push(w,b,x),n.push(-k/2,0),M(.5-k/2/y,1.25),n.push(.25,.25),n.push.apply(n,tt(T)),n.push.apply(n,tt(A)),n.push(w,b,x),n.push(k/2,0),M(.5+k/2/y,1.25),n.push(.25,.25),n.push.apply(n,tt(T)),n.push.apply(n,tt(A)),n.push(w,b,x),n.push(k/2,m-g),M(.5+k/2/y,1.25),n.push(.25,.25),n.push.apply(n,tt(T)),n.push.apply(n,tt(A)),n.push(w,b,x),n.push(0,m),M(.5,.5),n.push(.5,.5),n.push.apply(n,tt(T)),n.push.apply(n,tt(A));for(var L=1;L<my.CIRCLE_SEP_LENGTH;L++){var D=(L/my.CIRCLE_SEP_LENGTH*2-.5)*Math.PI,C=Math.cos(D),F=Math.sin(D);n.push(w,b,x),n.push(y*C,g*F+m),M(1.5*C/2+.5,-1.5*F/2+.5),n.push(.25*C+.5,.25*F+.5),n.push.apply(n,tt(T)),n.push.apply(n,tt(A))}}}return n}},{key:"_createIndices",value:function(){for(var e=[],t=this._items,r=0;r<t.length;++r){var n=t[r];if(!n.is_canceled)for(var i=0;i<n.entries.length;i++){var a=n.entries[i],o=(5+my.CIRCLE_SEP_LENGTH-1)*a.index,s=o,u=o+3;e.push(o,o+1,o+2),e.push(o,o+2,o+3),o+=4;var _=o++;e.push(_,s,u),e.push(_,u,o);for(var l=1;l<my.CIRCLE_SEP_LENGTH-1;l++)e.push(_,o++,o);e.push(_,o++,s)}}return e}},{key:"_setupLocation",value:function(e){var t=0,r=0;r+=my.SAFETY_PIXEL_MARGIN;for(var n=0;n<e.length;++n){var i=e[n];i.locate(r),t=Math.max(i.width_assumed,t),r+=i.height_pixel+my.SAFETY_PIXEL_MARGIN}return{width:t,height:r}}},{key:"texture",get:function(){return this._texture}},{key:"texture_mask",get:function(){return this._texture_mask}},{key:"vertices",get:function(){return this._vertices}},{key:"indices",get:function(){return this._indices}}]),e}(),Ty=function(){function e(t){Ge(this,e),this.entries=[],this._pos_x=0,this._pos_y=0,this._height=this._width=null,this._is_canceled=!1}return qe(e,[{key:"add",value:function(e,t){var r=t.size;(null===this._width||this._width<r[0])&&(this._width=r[0]),(null===this._height||this._height<r[1])&&(this._height=r[1]),this.entries.push({index:e,entry:t})}},{key:"cancel",value:function(){this._is_canceled=!0}},{key:"locate",value:function(e,t){this._pos_x=e,this._pos_y=t}},{key:"draw",value:function(e){this.entries[0].entry.draw(e,this._pos_x,this.pos_y,this.width,this.height)}},{key:"pos_x",get:function(){return this._pos_x}},{key:"pos_y",get:function(){return this._pos_y}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"width_pixel",get:function(){return Math.ceil(this._width)}},{key:"height_pixel",get:function(){return Math.ceil(this._height)}},{key:"is_canceled",get:function(){return this._is_canceled}}]),e}(),Ay=function(){function e(t){Ge(this,e);var r=0,n=0,i=[];for(r+=my.SAFETY_PIXEL_MARGIN;t.length>0;){var a=t.shift(),o=a.width_pixel+my.SAFETY_PIXEL_MARGIN;if(r+o<=my.MAX_IMAGE_WIDTH)i.push(a),r+=o,n=Math.max(a.height_pixel,n);else{if(0!=i.length){t.unshift(a);break}a.cancel()}}this._items=i,this._width_assumed=r,this._height_pixel=n}return qe(e,[{key:"isValid",value:function(){return this._items.length>0}},{key:"locate",value:function(e){var t=this._items,r=0;r+=my.SAFETY_PIXEL_MARGIN;for(var n=0;n<t.length;++n){var i=t[n];i.locate(r,e),r+=i.width_pixel+my.SAFETY_PIXEL_MARGIN}}},{key:"items",get:function(){return this._items}},{key:"width_assumed",get:function(){return this._width_assumed}},{key:"height_pixel",get:function(){return this._height_pixel}}]),e}(),Ry="/**\n * テキスト (頂点シェーダ)\n */\n\nattribute vec4 a_position;     // 頂点位置 (モデル座標系)\nattribute vec2 a_offset;       // 頂点変位 (スクリーン座標系)\nattribute vec2 a_texcoord;     // テクスチャ座標\n\nuniform mat4 u_obj_to_clip;    // モデル座標系からクリップ座標系への変換\nuniform vec2 u_sparam;         // 画面パラメータ: {2/w, 2/h}\n\nvarying vec2 v_texcoord;       // テクスチャ座標\n\nvoid\nmain()\n{\n    gl_Position = u_obj_to_clip * a_position;\n    gl_Position.xy += a_offset * u_sparam * gl_Position.w;\n    v_texcoord = a_texcoord;\n}\n",Iy="/**\n * テキスト (フラグメントシェーダ)\n */\n\nprecision mediump float;\n\nvarying vec2 v_texcoord;        // テクスチャ座標\nuniform sampler2D u_image;      // 画像\n\n\nvoid\nmain()\n{\n    gl_FragColor = texture2D( u_image, v_texcoord );\n}\n",Py=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return Ge(this,t),(r=Ke(this,He(t).call(this,e,Ry,n.ridMaterial?nl:Iy))).bindProgram(),r.setInteger("u_image",t.TEXUNIT_IMAGE),r}return Ye(t,e),qe(t,[{key:"isTranslucent",value:function(e,t){return!1}},{key:"setParameters",value:function(e,r){$e(He(t.prototype),"setParameters",this).call(this,e,r);var n=r.properties;this.setObjToClip(e,r);var i=t._sparam;if(i[0]=2/e._width,i[1]=2/e._height,this.setVector2("u_sparam",i),e.getRenderTarget()===fh.SCENE){var a=n.image;this.bindTexture2D(t.TEXUNIT_IMAGE,a.handle)}}}]),t}(yv);Py.TEXUNIT_IMAGE=0,Py._sparam=hs.createVector2f(),Py._bg_color=hs.createVector3f(),Py._fg_color=hs.createVector3f();var Sy=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this,e,r)))._entries=[],n._parent_props={size:null,origin:null},n._primitive_producer=new My(Je(n)),n._animation.addDescendantUnbinder((function(){n._unbindDescendantAnimations()})),n._setupAnimationBindingBlock(),r&&r.json&&n._setupByJson(r.json),n}return Ye(t,e),qe(t,[{key:"getPrimitiveProducer",value:function(){return this._primitive_producer}},{key:"_unbindDescendantAnimations",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,i=this._entries[Symbol.iterator]();!(e=(n=i.next()).done);e=!0){n.value.animation.unbindAllRecursively()}}catch(e){t=!0,r=e}finally{try{e||null==i.return||i.return()}finally{if(t)throw r}}}},{key:"_setupAnimationBindingBlock",value:function(){var e,t=this,r=this.animation,n=Ti.find("number"),i=Ti.find("vector2"),a=hs.createVector2();r.addEntry("size",[i,n],(function(t){return e=$s.findFirstTypeSupported(t,[i,n])}),(function(r){e===i?t.setSize(r):(a[0]=r,a[1]=r,t.setSize(a))}))}},{key:"setSize",value:function(e){this._setVector2Property("size",e)}},{key:"setOrigin",value:function(e){this._setVector2Property("origin",e)}},{key:"addImageIcon",value:function(e,t,r){var n=new Ly(this,e,t,r);return this._entries.push(n),this._primitive_producer.onAddEntry(),n}},{key:"_getMaterial",value:function(e){var t=this.scene;return e===fh.SCENE?(t._ImageEntity_image_material||(t._ImageEntity_image_material=new Py(t.glenv)),t._ImageEntity_image_material):e===fh.RID?(t._ImageEntity_image_material_pick||(t._ImageEntity_image_material_pick=new Py(t.glenv,{ridMaterial:!0})),t._ImageEntity_image_material_pick):void 0}},{key:"_setValueProperty",value:function(e,t){var r=this._parent_props;r[e]!=t&&(r[e]=t,this._primitive_producer.onChangeParentProperty())}},{key:"_setVector2Property",value:function(e,t){var r=this._parent_props[e];r?r[0]===t[0]&&r[1]===t[1]||(hs.copyVector2(t,r),this._primitive_producer.onChangeParentProperty()):(this._parent_props[e]=hs.createVector2f(t),this._primitive_producer.onChangeParentProperty())}},{key:"_setupByJson",value:function(e){var t=new fs,r=!0,n=!1,i=void 0;try{for(var a,o=e.entries[Symbol.iterator]();!(r=(a=o.next()).done);r=!0){var s=a.value;t.setFromArray(s.position),this.addImageIcon(t,s)}}catch(e){n=!0,i=e}finally{try{r||null==o.return||o.return()}finally{if(n)throw i}}e.size&&this.setSize(e.size),e.origin&&this.setOrigin(e.origin)}},{key:"getEntry",value:function(e){return this._entries.find((function(t){return t.id===e}))}}]),t}(I_);Sy.DEFAULT_COLOR=hs.createVector3f([1,1,1]),Sy.SAFETY_PIXEL_MARGIN=1,Sy.MAX_IMAGE_WIDTH=4096,Sy.CIRCLE_SEP_LENGTH=32,Sy.DEFAULT_ICON_SIZE=hs.createVector2f([30,30]),Sy.DEFAULT_ORIGIN=hs.createVector2f([.5,.5]),Sy.SAFETY_PIXEL_MARGIN=1,Sy.MAX_IMAGE_WIDTH=4096;var My=function(e){function t(e){var r;Ge(this,t),(r=Ke(this,He(t).call(this,e)))._glenv=e.scene.glenv,r._dirty=!0,r._transform=hs.setIdentity(hs.createMatrix()),r._properties={image:null};var n=new c_(r._glenv,null,e._getMaterial(fh.SCENE),r._transform);n.properties=r._properties,r._primitive=n;var i=new c_(r._glenv,null,e._getMaterial(fh.RID),r._transform);return i.properties=r._properties,r._pickPrimitive=i,r._primitives=[],r._pickPrimitives=[],r}return Ye(t,e),qe(t,[{key:"createRegions",value:function(){var e=new Lv,t=!0,r=!1,n=void 0;try{for(var i,a=this.entity._entries[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var o=i.value.position;e.addPoint(o)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}return[e]}},{key:"onChangeElevation",value:function(e){this._dirty=!0}},{key:"getPrimitives",value:function(e){return this._updatePrimitive(),e.getRenderTarget()===fh.SCENE?this._primitives:this._pickPrimitives}},{key:"onChangeParentProperty",value:function(){this._dirty=!0}},{key:"onChangeChildProperty",value:function(){this._dirty=!0}},{key:"onChangeAltitudeMode",value:function(){this._dirty=!0}},{key:"onAddEntry",value:function(){this.needToCreateRegions(),this._dirty=!0}},{key:"_updatePrimitive",value:function(){if(this._dirty){if(0==this.entity._entries.length)return this._primitives=[],this._pickPrimitives=[],void(this._dirty=!1);var e=this._createFlatGocsArray();this._updateTransform(e);var t=new Dy(this,e);if(!t.isValid())return this._primitives=[],this._pickPrimitives=[],void(this._dirty=!1);var r=this._properties;r.image&&r.image.dispose(),r.image=t.texture;var n={vtype:[{name:"a_position",size:3},{name:"a_offset",size:2},{name:"a_texcoord",size:2}],vertices:t.vertices,indices:t.indices},i=new k_(this._glenv,n),a=this._primitive;a.mesh&&a.mesh.dispose(),a.mesh=i;var o=this._pickPrimitive;o.mesh&&o.mesh.dispose(),o.mesh=i,this._primitives=[a],this._pickPrimitives=[o],this._dirty=!1}}},{key:"_updateTransform",value:function(e){for(var t=this.entity._entries.length,r=0,n=0,i=0,a=0;a<t;++a){var o=3*a;r+=e[o],n+=e[o+1],i+=e[o+2]}var s=this._transform;s[12]=r/t,s[13]=n/t,s[14]=i/t}},{key:"_createFlatGocsArray",value:function(){var e=this.entity._entries.length;return fs.toGocsArray(this._getFlatGeoPoints_with_Absolute(),e,new Float64Array(3*e))}},{key:"_getFlatGeoPoints_with_Absolute",value:function(){for(var e=this.entity,t=e._entries,r=t.length,n=new Float64Array(3*r),i=0;i<r;++i){var a=t[i].position;n[3*i]=a.longitude,n[3*i+1]=a.latitude}switch(e.altitude_mode){case R_.RELATIVE:case R_.CLAMP:if(e.scene.viewer.getExistingElevations(r,n,0,3,n,2,3),e.altitude_mode===R_.RELATIVE)for(var o=0;o<r;++o)n[3*o+2]+=t[o].position.altitude;break;default:for(var s=0;s<r;++s)n[3*s+2]=t[s].position.altitude}return n}}]),t}(I_.PrimitiveProducer),Ly=function(){function e(t,r,n,i){Ge(this,e),this._owner=t,this._position=n.clone(),this._animation=new Zs,this._setupAnimationBindingBlock(),this._props=Object.assign({},i),this._copyPropertyVector2f("size"),this._copyPropertyVector2f("origin"),this.setImage(r)}return qe(e,[{key:"_setupAnimationBindingBlock",value:function(){var e=this,t=this.animation,r=Ti.find("number"),n=Ti.find("string"),i=Ti.find("vector2"),a=Ti.find("vector3");t.addEntry("image_src",[n],null,(function(t){e.setImage(t)}));var o=new fs;t.addEntry("position",[a],null,(function(t){o.setFromArray(t),e.setPosition(o)}));var s,u=hs.createVector2();t.addEntry("size",[i,r],(function(e){return s=$s.findFirstTypeSupported(e,[i,r])}),(function(t){s===i?e.setSize(t):(u[0]=t,u[1]=t,e.setSize(u))}))}},{key:"setImage",value:function(t){var r=this;if(this._image_src!==t){this._image_src=t;var n=t instanceof sv?t:new _v(t,{transform:this._props.transform});this._icon=e.iconLoader.load(n),this._icon.onEnd((function(e){r._owner.getPrimitiveProducer()._dirty=!0}))}}},{key:"setPosition",value:function(e){this._position.longitude===e.longitude&&this._position.latitude===e.latitude&&this._position.altitude===e.altitude||(this._position.assign(e),this._owner.getPrimitiveProducer().onChangeChildProperty())}},{key:"setSize",value:function(e){this._setVector2Property("size",e)}},{key:"_copyPropertyVector3f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&(t[e]=hs.createVector3f(t[e]))}},{key:"_copyPropertyVector2f",value:function(e){var t=this._props;t.hasOwnProperty(e)&&("number"==typeof t[e]?t[e]=hs.createVector2f([t[e],t[e]]):t[e]=hs.createVector2f(t[e]))}},{key:"_setVector2Property",value:function(e,t){var r=this._props[e];r?r[0]===t[0]&&r[1]===t[1]||(hs.copyVector2(t,r),this._owner.getPrimitiveProducer().onChangeChildProperty()):(this._props[e]=hs.createVector2f(t),this._owner.getPrimitiveProducer().onChangeChildProperty())}},{key:"isLoaded",value:function(){return this._icon.isLoaded()}},{key:"draw",value:function(e,t,r,n,i){this._icon.draw(e,t,r,n,i)}},{key:"position",get:function(){return this._position}},{key:"id",get:function(){return this._props.hasOwnProperty("id")?this._props.id:""}},{key:"size",get:function(){var e=this._props,t=this._owner._parent_props;return e.size||t.size||hs.createVector2f([this._icon.width,this._icon.height])}},{key:"origin",get:function(){var e=this._props,t=this._owner._parent_props;return e.origin||t.origin||Sy.DEFAULT_ORIGIN}},{key:"animation",get:function(){return this._animation}},{key:"icon",get:function(){return this._icon}}]),e}();Sy.ImageEntry=Ly,Ly.iconLoader=new yy;var Dy=function(){function e(t,r){Ge(this,e),this._owner=t,this._items=this._createItemList(),this._is_valid=!0;var n=this._createRowLayouts();if(0!=n.length){var i=this._setupLocation(n);this._texture=this._createTexture(i.width,i.height),this._vertices=this._createVertices(i.width,i.height,r),this._indices=this._createIndices()}else this._is_valid=!1}return qe(e,[{key:"isValid",value:function(){return this._is_valid}},{key:"_createItemList",value:function(){var e=new Map,t=[],r=0,n=!0,i=!1,a=void 0;try{for(var o,s=this._owner.entity._entries[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var u=o.value;if(u.isLoaded()){var _=e.get(u.icon);_||(e.set(u.icon,_=new Cy(this)),t.push(_)),_.add(r++,u)}}}catch(e){i=!0,a=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw a}}return t}},{key:"_createRowLayouts",value:function(){var e=[].concat(this._items);e.sort((function(e,t){return e.height_pixel-t.height_pixel}));for(var t=[];e.length>0;){var r=new Fy(e);r.isValid()&&t.push(r)}return t}},{key:"_createTexture",value:function(e,t){for(var r=ov.createCanvasContext(e,t),n=this._items,i=0;i<n.length;++i){var a=n[i];a.is_canceled||a.draw(r)}var o=this._owner._glenv,s={usage:pv.Usage.ICON};return new pv(o,r.canvas,s)}},{key:"_createVertices",value:function(e,t,r){for(var n=[],i=this._owner._transform,a=i[12],o=i[13],s=i[14],u=1/e,_=1/t,l=this._items,c=0;c<l.length;++c){var h=l[c];if(!h.is_canceled)for(var f=0;f<h.entries.length;f++){var d=h.entries[f],v=d.entry,p=v.size,y=v.origin,g=3*d.index,m=r[g]-a,k=r[g+1]-o,E=r[g+2]-s,w=h.pos_x,b=h.pos_y,x=h.width,T=h.height;n.push(m,k,E),n.push(-y[0]*p[0],y[1]*p[1]),n.push(w*u,1-b*_),n.push(m,k,E),n.push(-y[0]*p[0],-(1-y[1])*p[1]),n.push(w*u,1-(b+T)*_),n.push(m,k,E),n.push((1-y[0])*p[0],-(1-y[1])*p[1]),n.push((w+x)*u,1-(b+T)*_),n.push(m,k,E),n.push((1-y[0])*p[0],y[1]*p[1]),n.push((w+x)*u,1-b*_)}}return n}},{key:"_createIndices",value:function(){for(var e=[],t=this._items,r=0;r<t.length;++r){var n=t[r];if(!n.is_canceled)for(var i=0;i<n.entries.length;i++){var a=4*n.entries[i].index;e.push(a,a+1,a+2),e.push(a,a+2,a+3)}}return e}},{key:"_setupLocation",value:function(e){var t=0,r=0;r+=Sy.SAFETY_PIXEL_MARGIN;for(var n=0;n<e.length;++n){var i=e[n];i.locate(r),t=Math.max(i.width_assumed,t),r+=i.height_pixel+Sy.SAFETY_PIXEL_MARGIN}return{width:t,height:r}}},{key:"texture",get:function(){return this._texture}},{key:"vertices",get:function(){return this._vertices}},{key:"indices",get:function(){return this._indices}}]),e}(),Cy=function(){function e(t){Ge(this,e),this.entries=[],this._pos_x=0,this._pos_y=0,this._height=this._width=null,this._is_canceled=!1}return qe(e,[{key:"add",value:function(e,t){var r=t.size;(null===this._width||this._width<r[0])&&(this._width=r[0]),(null===this._height||this._height<r[1])&&(this._height=r[1]),this.entries.push({index:e,entry:t})}},{key:"cancel",value:function(){this._is_canceled=!0}},{key:"locate",value:function(e,t){this._pos_x=e,this._pos_y=t}},{key:"draw",value:function(e){this.entries[0].entry.draw(e,this._pos_x,this.pos_y,this.width,this.height)}},{key:"pos_x",get:function(){return this._pos_x}},{key:"pos_y",get:function(){return this._pos_y}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"width_pixel",get:function(){return Math.ceil(this._width)}},{key:"height_pixel",get:function(){return Math.ceil(this._height)}},{key:"is_canceled",get:function(){return this._is_canceled}}]),e}(),Fy=function(){function e(t){Ge(this,e);var r=0,n=0,i=[];for(r+=Sy.SAFETY_PIXEL_MARGIN;t.length>0;){var a=t.shift(),o=a.width_pixel+Sy.SAFETY_PIXEL_MARGIN;if(r+o<=Sy.MAX_IMAGE_WIDTH)i.push(a),r+=o,n=Math.max(a.height_pixel,n);else{if(0!=i.length){t.unshift(a);break}a.cancel()}}this._items=i,this._width_assumed=r,this._height_pixel=n}return qe(e,[{key:"isValid",value:function(){return this._items.length>0}},{key:"locate",value:function(e){var t=this._items,r=0;r+=Sy.SAFETY_PIXEL_MARGIN;for(var n=0;n<t.length;++n){var i=t[n];i.locate(r,e),r+=i.width_pixel+Sy.SAFETY_PIXEL_MARGIN}}},{key:"items",get:function(){return this._items}},{key:"width_assumed",get:function(){return this._width_assumed}},{key:"height_pixel",get:function(){return this._height_pixel}}]),e}(),Ny=W.f,Oy=function(e){return function(t){for(var r,n=ee(t),i=ot(n),o=i.length,s=0,u=[];o>s;)r=i[s++],a&&!Ny.call(n,r)||u.push(e?[r,n[r]]:n[r]);return u}},Uy={entries:Oy(!0),values:Oy(!1)}.values;Le({target:"Object",stat:!0},{values:function(e){return Uy(e)}});var Vy=function(e){function t(e,r){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(Ge(this,t),r instanceof sv);else{if("string"!=typeof r)throw new Error("Unsupported Resource: "+r);r=new _v(r,{type:"json",transform:i.transform})}return(n=Ke(this,He(t).call(this,e,r,{onEntity:i.onEntity,onLoad:i.onLoad})))._getPointFGColor=i.getPointFGColor||jy,n._getPointBGColor=i.getPointBGColor||qy,n._getPointSize=i.getPointSize||Yy,n._getPointIconId=i.getPointIconId||Hy,n._getLineColor=i.getLineColor||By,n._getLineWidth=i.getLineWidth||zy,n._getFillColor=i.getFillColor||Gy,n._getExtrudedHeight=i.getExtrudedHeight||Qy,n._getAltitudeMode=i.getAltitudeMode||Xy,n._getAltitude=i.getAltitude||Wy,n._glenv=e.glenv,n._references={},n._cancelled=!1,n._finished=!1,n}return Ye(t,e),qe(t,[{key:"_load",value:function(){var e=this;return this._resource.load({type:uv.JSON}).then((function(t){e._check_cancel(),e._load_geojson_object(t)}))}},{key:"_load_geojson_object",value:function(e){var t;if(e.type===Zy.FEATURE_COLLECTION){var r=e.features;t=!1;for(var n=0,i=r.length;n<i;n++){var a=r[n],o=this._load_geojson_object(a.featureId?a.feature:a);o&&!t&&(t=o)}}else if(e.type===Zy.FEATURE){var s=e.geometry;t=this._load_geometry_object(s,e)}else{if(-1===Ky.indexOf(e.type))throw new Error("Unnsupported Type: "+e.type);t=this._load_geometry_object(e,null)}return!this._cancelled&&t}},{key:"_load_geometry_object",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=e.coordinates;if(!r&&!e)return!1;switch(e.type){case Jy.POINT:case Jy.MULTI_POINT:return this._loadPoint(e,t);case Jy.LINE_STRING:case Jy.MULTI_LINE_STRING:return this._loadLines(e,t);case Jy.POLYGON:case Jy.MULTI_POLYGON:return this._loadPolygons(e,t);case Jy.GEOMETRY_COLLECTION:return!0;default:throw new Error("Invalid GeoJSON type: "+e.type)}}},{key:"_make_fetch_params",value:function(e){var r={signal:this._abort_ctrl.signal,credentials:(e.credentials||yh.OMIT).credentials};return e.headers&&(r.headers=e.headers||t._defaultHeaders),r}},{key:"_loadLines",value:function(e,t){var r=this,n=this._getLineColor(t),i=this._getLineWidth(t),a=this._getAltitude(t),o=this._getAltitudeMode(t);if(!e||4!==n.length)return!1;var s=e.type,u=e.coordinates,_=n.slice(0,3),l=n[3];return s===Jy.MULTI_LINE_STRING?(u.forEach((function(e){if(!r._generateLine(e,i,_,l,o,a,t))return!1})),!0):this._generateLine(u,i,_,l,o,a,t)}},{key:"_generateLine",value:function(e,t,r,n,i,a,o){if(!e)return!1;var s=new qv(this._scene);s.altitude_mode=i;var u=this._flatten(e,a);return s.addPoints(u),s.setLineWidth(t),s.setColor(r),s.setOpacity(n),this._onEntity(this,s,o),!0}},{key:"_loadPoint",value:function(e,r){var n=this._getPointFGColor(r),i=this._getPointBGColor(r),a=this._getPointIconId(r),o=this._getPointSize(r),s=this._getAltitudeMode(r),u=this._getAltitude(r);if(!e)return!1;var _=e.type,l={fg_color:n.slice(0,3),bg_color:i.slice(0,3),size:o};if(_===Jy.POINT){(f=new my(this._scene)).altitude_mode=s;var c=this._getActualValue(u,e.coordinates[2],t.defaultAltitude),h=new fs(e.coordinates[0],e.coordinates[1],c);null!==a?f.addMakiIconPin(a,h,l):f.addPin(h,l),this._onEntity(this,f,r)}else{var f;(f=new my(this._scene)).altitude_mode=s;for(var d=0;d<e.coordinates.length;d++){var v=e.coordinates[d];c=this._getActualValue(u,e.coordinates[2],t.defaultAltitude),h=new fs(v[0],v[1],c);null!==a?f.addMakiIconPin(a,h,l):f.addPin(h,l)}this._onEntity(this,f,r)}return!0}},{key:"_loadPolygons",value:function(e,t){var r=this,n=this._getFillColor(t),i=this._getAltitudeMode(t),a=this._getAltitude(t),o=this._getExtrudedHeight(t);if(!e||4!==n.length)return!1;var s=e.type,u=e.coordinates,_=n.slice(0,3),l=n[3];return s===Jy.MULTI_POLYGON?(u.forEach((function(e){if(!r._generatePolygon(e,_,l,i,a,o,t))return!1})),!0):this._generatePolygon(u,_,l,i,a,o,t)}},{key:"_generatePolygon",value:function(e,t,r,n,i,a,o){if(!e)return!1;var s=new wp(this._scene);s.altitude_mode=n,s.extruded_height=a,s.setColor(t),s.setOpacity(r);for(var u=0;u<e.length;u++){var _=this._flatten(e[u],i,e[u].length-1);if(!_)return!1;0===u?s.addOuterBoundary(_):s.addInnerBoundary(_)}return this._onEntity(this,s,o),!0}},{key:"_getActualValue",value:function(e,t,r){return null!=e?e:null!=t?t:r}},{key:"_flatten",value:function(e,r){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length;return e.reduce((function(e,a,o){return o>=i?e:e.concat(a.slice(0,2),n._getActualValue(r,a[2],t.defaultAltitude))}),[])}}]),t}(cv);function By(e){return Vy.defaultLineColor}function zy(e){return Vy.defaultLineWidth}function Gy(e){return Vy.defaultFillColor}function jy(e){return Vy.defaultPointFGColor}function qy(e){return Vy.defaultPointBGColor}function Yy(e){return Vy.defaultPointSize}function Hy(e){return Vy.defaultPointIconId}function Xy(e){return R_.ABSOLUTE}function Wy(e){return null}function Qy(e){return Vy.defaultExtrudedHeight}Vy._defaultHeaders={},Vy.defaultLineColor=[0,0,0,1],Vy.defaultFillColor=[0,0,0,1],Vy.defaultLineWidth=1,Vy.defaultPointFGColor=[1,1,1],Vy.defaultPointBGColor=[.35,.61,.81],Vy.defaultPointSize=30,Vy.defaultPointIconId=null,Vy.defaultAltitude=0,Vy.defaultExtrudedHeight=0;var Zy={FEATURE:"Feature",FEATURE_COLLECTION:"FeatureCollection"},Jy={POINT:"Point",MULTI_POINT:"MultiPoint",LINE_STRING:"LineString",MULTI_LINE_STRING:"MultiLineString",POLYGON:"Polygon",MULTI_POLYGON:"MultiPolygon",GEOMETRY_COLLECTION:"GeometryCollection",FEATURE:"Feature"},Ky=Object.values(Jy),$y=function(){function e(){Ge(this,e),this.clearStats()}return qe(e,[{key:"clearStats",value:function(){this.num_wait_reqs_dem=0,this.num_wait_reqs_img=0,this.num_drawing_flakes=0,this.num_drawing_flake_vertices=0,this.num_procA_flakes=0,this.num_procB_flakes=0}},{key:"onUpdate",value:function(){}}]),e}(),eg=mt.trim,tg=n.parseInt,rg=/^[+-]?0[Xx]/,ng=8!==tg(dt+"08")||22!==tg(dt+"0x16")?function(e,t){var r=eg(String(e));return tg(r,t>>>0||(rg.test(r)?16:10))}:tg;Le({global:!0,forced:parseInt!=ng},{parseInt:ng});var ig=re.f,ag="".endsWith,og=Math.min,sg=Fn("endsWith"),ug=!sg&&!!function(){var e=ig(String.prototype,"endsWith");return e&&!e.writable}();Le({target:"String",proto:!0,forced:!ug&&!sg},{endsWith:function(e){var t=String($(this));Dn(e);var r=arguments.length>1?arguments[1]:void 0,n=le(t.length),i=void 0===r?n:og(le(r),n),a=String(e);return ag?ag.call(t,a,i):t.slice(i-a.length,i)===a}});var _g=function(){function e(t){Ge(this,e),this._aip=t}return qe(e,[{key:"getId",value:function(){return this._id}},{key:"getOwnerId",value:function(){return this._owner_id}},{key:"getName",value:function(){return this._name}},{key:"getDescription",value:function(){return this._description}},{key:"getCreatedAt",value:function(){return this._created_at}},{key:"getUpdatedAt",value:function(){return this._updated_at}},{key:"_restoreFromJson",value:function(e){this._id=e.id,this._owner_id=e.owner_id,this._name=e.name,this._description=e.description,this._created_at=new Date(e.created_at),this._updated_at=new Date(e.updated_at)}}]),e}(),lg=function(e){function t(e){return Ge(this,t),Ke(this,He(t).call(this,e))}return Ye(t,e),qe(t,[{key:"_restoreFromJson",value:function(e){$e(He(t.prototype),"_restoreFromJson",this).call(this,e)}}],[{key:"createFromJson",value:function(e,r){var n=new t(e);return n._restoreFromJson(r),n}}]),t}(_g),cg=function(e){function t(e){return Ge(this,t),Ke(this,He(t).call(this,e))}return Ye(t,e),qe(t,[{key:"getOrigin",value:function(){return this._origin}},{key:"getUrl",value:function(){return this._url}},{key:"getFormat",value:function(){return this._format}},{key:"getSceneId",value:function(){return this._scene_id}},{key:"getPath",value:function(){return this._path}},{key:"getSRID",value:function(){return this._srid}},{key:"_restoreFromJson",value:function(e){$e(He(t.prototype),"_restoreFromJson",this).call(this,e),this._url=e.url,this._scene_id=e.scene_id,this._path=e.path,this._format=e.format,this._srid=e.srid,this._origin=new fs(e.x,e.y,e.z)}}],[{key:"createFromJson",value:function(e,r){var n=new t(e);return n._restoreFromJson(r),n}}]),t}(_g),hg=function(e){function t(e){return Ge(this,t),Ke(this,He(t).call(this,e))}return Ye(t,e),qe(t,[{key:"getUrl",value:function(){return this._url}},{key:"getBoundingBox",value:function(){return this._bounding_box}},{key:"getContentRoot",value:function(){return this._content_root}},{key:"getFormat",value:function(){return this._format}},{key:"_restoreFromJson",value:function(e){$e(He(t.prototype),"_restoreFromJson",this).call(this,e),this._url=e.url,this._bounding_box=e.bbox,this._content_root=Array.isArray(e.content_root)?e.content_root.join("/"):e.content_root,this._format=e.format}}],[{key:"createFromJson",value:function(e,r){var n=new t(e);return n._restoreFromJson(r),n}}]),t}(_g),fg=function(e){function t(e,r){var n;Ge(this,t);var i=r.lastIndexOf("/");if(-1===i)throw new Error("invalid url");return(n=Ke(this,He(t).call(this)))._api=e,n._url=r,n._base_url=r.substr(0,i+1),n}var r,n;return Ye(t,e),qe(t,[{key:"load",value:(n=ze(regeneratorRuntime.mark((function e(){var t,r,n=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:{},e.next=3,this._api.fetch(Bh.METHOD.GET,this._url);case 3:if(r=e.sent,t.type!==uv.JSON){e.next=10;break}return e.next=7,r.json();case 7:e.t0=e.sent,e.next=11;break;case 10:e.t0=r;case 11:return e.abrupt("return",e.t0);case 12:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"loadSubResourceSupported",value:function(){return!0}},{key:"loadSubResource",value:(r=ze(regeneratorRuntime.mark((function e(t){var r,n,i,a=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>1&&void 0!==a[1]?a[1]:{},n=ov.resolveUrl(this._base_url,t),e.next=4,this._api.fetch(Bh.METHOD.GET,n);case 4:if((i=e.sent).ok){e.next=7;break}throw new Error(i.statusText);case 7:if(r.type!==uv.BINARY){e.next=13;break}return e.next=10,i.arrayBuffer();case 10:e.t0=e.sent,e.next=25;break;case 13:if(r.type!==uv.IMAGE){e.next=23;break}return e.t2=ov,e.next=17,i.blob();case 17:return e.t3=e.sent,e.next=20,e.t2.loadImage.call(e.t2,e.t3);case 20:e.t1=e.sent,e.next=24;break;case 23:e.t1=i;case 24:e.t0=e.t1;case 25:return e.abrupt("return",e.t0);case 26:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]),t}(sv),dg=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this)))._api=e,n._datasetId=r,n}var r;return Ye(t,e),qe(t,[{key:"load",value:(r=ze(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._api.getFeatures(this._datasetId);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})}]),t}(sv),vg=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this)))._api=e,n._datasetIds=Array.isArray(r)?r:[r],n}var r;return Ye(t,e),qe(t,[{key:"load",value:(r=ze(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._api.get3DDatasetScene(this._datasetIds);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"resolveResourceSupported",value:function(){return!0}},{key:"resolveResource",value:function(e){return new fg(this._api,e)}}]),t}(sv),pg=function(e){function t(e,r){var n;return Ge(this,t),(n=Ke(this,He(t).call(this)))._api=e,n._datasetId=r,n}var r;return Ye(t,e),qe(t,[{key:"load",value:(r=ze(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._api.getPointCloudDataset(this._datasetId);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"resolveResourceSupported",value:function(){return!0}},{key:"resolveResource",value:function(e){return new fg(this._api,e)}}]),t}(sv),yg=function(e){function t(e,r,n,i,a){var o;return Ge(this,t),o=Ke(this,He(t).call(this,r+" ["+e+"]",n)),Error.captureStackTrace&&Error.captureStackTrace(Je(o),t),o.name="MaprayApiError",o.code=e,o.resonse=i,o.cause=a,a&&(o.stack+="\nCaused-By: "+a.stack),o}return Ye(t,e),t}(zh),gg=function(e){function t(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Ge(this,t),e=Ke(this,He(t).call(this));var n=r.basePath.endsWith("/")?r.basePath.slice(0,-1):r.basePath;return e._option={basePath:n||DEFAULT_BASE_PATH,version:r.version,token:r.token,userId:r.userId},e}var r,n,i,a,o,s,u,_,l,c,h,f,d,v,p,y,g,m,k,E,w,b,x,T,A,R,I,P;return Ye(t,e),qe(t,[{key:"loadDatasets",value:(P=ze(regeneratorRuntime.mark((function e(){var t,r,n,i=this,a=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:1,r=a.length>1&&void 0!==a[1]?a[1]:5,e.next=4,this.getDatasets(t,r);case 4:return n=e.sent,e.abrupt("return",n.map((function(e){return lg.createFromJson(i,e)})));case 6:case"end":return e.stop()}}),e,this)}))),function(){return P.apply(this,arguments)})},{key:"loadDataset",value:(I=ze(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getDataset(t);case 2:return r=e.sent,e.abrupt("return",lg.createFromJson(this,r));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"load3DDatasets",value:(R=ze(regeneratorRuntime.mark((function e(){var t,r,n,i=this,a=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:1,r=a.length>1&&void 0!==a[1]?a[1]:5,e.next=4,this.get3DDatasets(t,r);case 4:return n=e.sent,e.abrupt("return",n.map((function(e){return cg.createFromJson(i,e)})));case 6:case"end":return e.stop()}}),e,this)}))),function(){return R.apply(this,arguments)})},{key:"load3DDataset",value:(A=ze(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get3DDataset(t);case 2:return r=e.sent,e.abrupt("return",cg.createFromJson(this,r));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return A.apply(this,arguments)})},{key:"loadPointCloudDatasets",value:(T=ze(regeneratorRuntime.mark((function e(){var t,r,n,i=this,a=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:1,r=a.length>1&&void 0!==a[1]?a[1]:5,e.next=4,this.getPointCloudDatasets(t,r);case 4:return n=e.sent,e.abrupt("return",n.map((function(e){return hg.createFromJson(i,e)})));case 6:case"end":return e.stop()}}),e,this)}))),function(){return T.apply(this,arguments)})},{key:"loadPointCloudDataset",value:(x=ze(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getPointCloudDataset(t);case 2:return r=e.sent,e.abrupt("return",hg.createFromJson(this,r));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return x.apply(this,arguments)})},{key:"getDatasetAsResource",value:function(e){return new dg(this,e)}},{key:"get3DDatasetAsResource",value:function(e){return new vg(this,e)}},{key:"getPointCloudDatasetAsResource",value:function(e){return new pg(this,e)}},{key:"getDatasets",value:(b=ze(regeneratorRuntime.mark((function e(){var t,r,n,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=i.length>0&&void 0!==i[0]?i[0]:1,r=i.length>1&&void 0!==i[1]?i[1]:5,n=this._option,e.next=5,this.get("datasets",[n.userId],{page:t,limit:r});case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"getDataset",value:(w=ze(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._option,e.next=3,this.get("datasets",[r.userId,t],null);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"createDataset",value:(E=ze(regeneratorRuntime.mark((function e(t,r){var n,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._option,i={name:t,description:r},e.next=4,this.post("datasets",[n.userId],null,i);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return E.apply(this,arguments)})},{key:"deleteDataset",value:(k=ze(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._option,e.next=3,this.delete("datasets",[r.userId,t]);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"getFeatures",value:(m=ze(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._option,e.next=3,this.get("datasets",[r.userId,t,"features"]);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"insertFeature",value:(g=ze(regeneratorRuntime.mark((function e(t,r){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._option,e.next=3,this.post("datasets",[n.userId,t,"features"],null,r);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return g.apply(this,arguments)})},{key:"updateFeature",value:(y=ze(regeneratorRuntime.mark((function e(t,r,n){var i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._option,e.next=3,this.put("datasets",[i.userId,"features",r],null,n);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return y.apply(this,arguments)})},{key:"get3DDatasets",value:(p=ze(regeneratorRuntime.mark((function e(){var t,r,n,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=i.length>0&&void 0!==i[0]?i[0]:1,r=i.length>1&&void 0!==i[1]?i[1]:5,n=this._option,e.next=5,this.get("3ddatasets",[n.userId],{page:t,limit:r});case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"create3DDataset",value:(v=ze(regeneratorRuntime.mark((function e(t,r,n){var i,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._option,a={name:t,description:r,path:n.path,format:n.format,srid:n.srid,x:n.x,y:n.y,z:n.z},e.next=4,this.post("3ddatasets",[i.userId],null,a);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return v.apply(this,arguments)})},{key:"update3DDataset",value:(d=ze(regeneratorRuntime.mark((function e(t,r,n,i){var a,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=this._option,o={name:r,description:n,path:i.path,format:i.format,srid:i.srid,x:i.x,y:i.y,z:i.z},e.next=4,this.patch("3ddatasets",[a.userId,t],null,o);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return d.apply(this,arguments)})},{key:"create3DDatasetUploadUrl",value:(f=ze(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._option,e.next=3,this.post("3ddatasets",["uploads",r.userId,t],null,{});case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"get3DDataset",value:(h=ze(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._option,e.next=3,this.get("3ddatasets",[r.userId,t],null);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"delete3DDataset",value:(c=ze(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._option,e.next=3,this.delete("3ddatasets",[r.userId,t]);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"get3DDatasetScene",value:(l=ze(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._option,e.next=3,this.get("3ddatasets",["scene",r.userId],{"3ddatasets_ids":Array.isArray(t)?t.join(","):t});case 3:return(n=e.sent).entity_list.forEach((function(e){var t=e.index,r=parseInt(t);if(r.toString()!==t)throw new Error("Internal Error: ID couldn't be convert to 'number'");e.index=r})),e.abrupt("return",n);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"getPointCloudDatasets",value:(_=ze(regeneratorRuntime.mark((function e(){var t,r,n,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=i.length>0&&void 0!==i[0]?i[0]:1,r=i.length>1&&void 0!==i[1]?i[1]:5,n=this._option,e.next=5,this.get("pcdatasets",[n.userId],{page:t,limit:r});case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)}))),function(){return _.apply(this,arguments)})},{key:"getPointCloudDataset",value:(u=ze(regeneratorRuntime.mark((function e(t){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._option,e.next=3,this.get("pcdatasets",[r.userId,t]);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"get",value:function(){var e=ze(regeneratorRuntime.mark((function e(t,r,n){var i,a=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=a.length>3&&void 0!==a[3]?a[3]:{},e.next=3,this.fetchAPI(Bh.METHOD.GET,t,r,n,null,i);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"post",value:(s=ze(regeneratorRuntime.mark((function e(t,r,n,i){var a,o=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=o.length>4&&void 0!==o[4]?o[4]:{},"string"!=typeof i&&(i=JSON.stringify(i)),e.next=4,this.fetchAPI(Bh.METHOD.POST,t,r,n,i,a);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return s.apply(this,arguments)})},{key:"patch",value:(o=ze(regeneratorRuntime.mark((function e(t,r,n,i){var a,o=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=o.length>4&&void 0!==o[4]?o[4]:{},"string"!=typeof i&&(i=JSON.stringify(i)),e.next=4,this.fetchAPI(Bh.METHOD.PATCH,t,r,n,i,a);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return o.apply(this,arguments)})},{key:"put",value:(a=ze(regeneratorRuntime.mark((function e(t,r,n,i){var a,o=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=o.length>4&&void 0!==o[4]?o[4]:{},"string"!=typeof i&&(i=JSON.stringify(i)),e.next=4,this.fetchAPI(Bh.METHOD.PUT,t,r,n,i,a);case 4:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return a.apply(this,arguments)})},{key:"delete",value:(i=ze(regeneratorRuntime.mark((function e(t,r,n){var i,a=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=a.length>3&&void 0!==a[3]?a[3]:{},e.next=3,this.fetchAPI(Bh.METHOD.DELETE,t,r,n,null,i);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return i.apply(this,arguments)})},{key:"fetchAPI",value:(n=ze(regeneratorRuntime.mark((function e(t,r,n,i,a){var o,s,u,_,l=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=l.length>5&&void 0!==l[5]?l[5]:{},s=this._option,u=s.basePath+"/"+r+"/"+s.version+(n.length>0?"/"+n.join("/"):""),e.next=5,this.fetch(t,u,i,a,o);case 5:return _=e.sent,e.next=8,_.json();case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,r,i,a){return n.apply(this,arguments)})},{key:"fetch",value:(r=ze(regeneratorRuntime.mark((function e(t,r,n,i){var a,o,s,u=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=u.length>4&&void 0!==u[4]?u[4]:{},o=this._option,(a.headers||(a.headers={}))["x-api-key"]=o.token,e.prev=4,e.next=7,Bh.fetch(t,r,n,i,a);case 7:s=e.sent,e.next=26;break;case 10:if(e.prev=10,e.t0=e.catch(4),"FetchError"!==e.t0.name||!e.t0.response){e.next=25;break}return e.prev=13,e.next=16,e.t0.response.json();case 16:e.sent,e.next=22;break;case 19:throw e.prev=19,e.t1=e.catch(13),new yg(-1,"Failed to fetch",r,null,e.t0);case 22:throw new yg(errorObject.code,errorObject.error,r,e.t0.response,e.t0);case 25:throw new yg(-1,"Failed to fetch",r,null,e.t0);case 26:return e.abrupt("return",s);case 27:case"end":return e.stop()}}),e,this,[[4,10],[13,19]])}))),function(e,t,n,i){return r.apply(this,arguments)})}]),t}(Bh);gg.DEFAULT_BASE_PATH="https://cloud.mapray.com";var mg=function(){function e(){Ge(this,e),this._status=e.Status.NOT_INITIALIZED}var t,r,n,i,a;return qe(e,[{key:"init",value:(a=ze(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._status===e.Status.NOT_INITIALIZED){t.next=2;break}throw new Error("invalid status");case 2:return t.prev=2,t.next=5,this.doInit();case 5:this._status=e.Status.INITIALIZED,t.next=12;break;case 8:throw t.prev=8,t.t0=t.catch(2),this._status=e.Status.DESTROYED,t.t0;case 12:case"end":return t.stop()}}),t,this,[[2,8]])}))),function(){return a.apply(this,arguments)})},{key:"isReady",value:function(){return this._status==e.Status.INITIALIZED&&this.getNumberOfRequests()<10}},{key:"load",value:function(t,r,n,i){if(this._status!==e.Status.INITIALIZED)return{id:-1,done:Promise.reject(new Error("invalid status"))};var a=e._id_max++;return{id:a,done:this.doLoad(a,t,r,n,i)}}},{key:"flushQueue",value:function(){}},{key:"toString",value:function(){return"PointCloudProvider"}},{key:"cancel",value:function(t){if(this._status!==e.Status.INITIALIZED)throw new Error("invalid status");console.log("cancel not implemented")}},{key:"getNumberOfRequests",value:function(){throw new Error("not implemented")}},{key:"destroy",value:(i=ze(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this._status===e.Status.INITIALIZED){t.next=2;break}throw new Error("invalid status");case 2:return t.prev=2,t.next=5,this.doDestroy();case 5:return t.prev=5,this._status=e.Status.DESTROYED,t.finish(5);case 8:case"end":return t.stop()}}),t,this,[[2,,5,8]])}))),function(){return i.apply(this,arguments)})},{key:"doInit",value:(n=ze(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("not implemented");case 1:case"end":return e.stop()}}),e)}))),function(){return n.apply(this,arguments)})},{key:"doLoad",value:(r=ze(regeneratorRuntime.mark((function e(t,r,n,i,a){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("not implemented");case 1:case"end":return e.stop()}}),e)}))),function(e,t,n,i,a){return r.apply(this,arguments)})},{key:"doDestroy",value:(t=ze(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("not implemented");case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})}],[{key:"Status",get:function(){return kg}}]),e}();mg._id_max=0;var kg={NOT_INITIALIZED:{id:"NOT_INITIALIZED"},INITIALIZED:{id:"INITIALIZED"},DESTROYED:{id:"DESTROYED"}},Eg=function(e){function t(e){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(Ge(this,t),(r=Ke(this,He(t).call(this,n)))._suffix=".xyz",e instanceof sv)r._info_resource=e;else{if(!e.url)throw new Error("unsupported resource");r._info_resource=new _v(e.url,e.option)}return r._taskMap=new Map,r._requests=0,r}var r,n,i;return Ye(t,e),qe(t,[{key:"_createPath",value:function(e,t,r,n){return e+"/"+t+"/"+r+"/"+n+this._suffix}},{key:"doInit",value:(i=ze(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._info_resource.load({type:uv.JSON});case 2:(t=e.sent).url?this._resource=this._info_resource.resolveResource(t.url):this._resource=this._info_resource;case 4:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"doDestroy",value:(n=ze(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return n.apply(this,arguments)})},{key:"getNumberOfRequests",value:function(){return this._requests}},{key:"doLoad",value:(r=ze(regeneratorRuntime.mark((function e(t,r,n,i,a){var o,s,u,_,l,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._requests++,e.prev=1,o=new AbortController,this._taskMap.set(t,{id:t,abortController:o}),s=this._createPath(r,n,i,a),e.next=7,this._resource.loadSubResource(s,{type:uv.BINARY,signal:o.signal});case 7:return u=e.sent,l=0,(_={}).childFlags=new Uint8Array(u,l,1)[0],l+=1,_.debug1=new Int8Array(u,l,1)[0],l+=1,l+=2,_.indices=new Int32Array(u,l,8),l+=32,_.average=new Float32Array(u,l,3),l+=12,_.eigenVector=[],_.eigenVectorLength=[],_.eigenVector[0]=new Float32Array(u,l,3),l+=12,_.eigenVectorLength[0]=new Float32Array(u,l,1)[0],l+=4,_.eigenVector[1]=new Float32Array(u,l,3),l+=12,_.eigenVectorLength[1]=new Float32Array(u,l,1)[0],l+=4,_.eigenVector[2]=new Float32Array(u,l,3),l+=12,_.eigenVectorLength[2]=new Float32Array(u,l,1)[0],l+=4,console.assert(96==l),c=new Float32Array(u,l),this._taskMap.delete(t),e.abrupt("return",{header:_,body:c});case 37:return e.prev=37,this._requests--,e.finish(37);case 40:case"end":return e.stop()}}),e,this,[[1,,37,40]])}))),function(e,t,n,i,a){return r.apply(this,arguments)})},{key:"cancel",value:function(e){var t=this._taskMap.get(e);t&&t.abortController.abort()}}]),t}(mg),wg={animation:su,Viewer:iy,Camera:_u,GeoMath:hs,GeoPoint:fs,Orientation:ds,Ray:uu,AltitudeMode:R_,CredentialMode:yh,Layer:Ah,LayerCollection:Rh,DemProvider:xh,StandardDemProvider:Th,CloudDemProvider:sy,ImageProvider:q_,RenderCallback:Ph,StandardImageProvider:gh,Scene:Mh,Entity:I_,MarkerLineEntity:qv,PathEntity:Yv,TextEntity:$v,ModelEntity:ap,PolygonEntity:wp,PinEntity:my,ImageIconEntity:Sy,SceneLoader:$p,GeoJSONLoader:Vy,Resource:sv,URLResource:_v,MaprayApi:gg,DebugStats:$y,PointCloud:jc,RawPointCloudProvider:Eg,LogoController:ry,AttributionController:ny};window.maprayRequestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame,window.maprayCancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame;var bg=window.performance,xg=bg&&(bg.now||bg.mozNow||bg.msNow||bg.oNow||bg.webkitNow),Tg=new Date;return window.maprayNow=xg?function(){return xg.call(bg)}:function(){return Tg.getTime()},Math.maprayLog2=Math.log2||function(e){return 1.4426950408889634*Math.log(e)},wg}));
